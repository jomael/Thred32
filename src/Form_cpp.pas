unit Form_cpp;
//6th september 2012
interface

uses Thred_Types, Thred_Constants;

//#1    #include <windows.h>
//#2    #include <stdio.h>                                                                       
//#3    #include <math.h>                                                                       
//#4    #include <tchar.h>                                                                       
//#5    #include "lang.h"                                                                       
//#6    #include "resource.h"                                                                       
//#7    #include "thred.h"                                                                       
//#8                                                                           
//#9    void flipv();                                                                       
//#10    void duangs();                                                                       
//#11    void dufxlen();                                                                       
//#12    void duxclp();                                                                       
//#13    void dulast();                                                                       
//#14    void wavfrm();                                                                       
//#15    BOOL cisin(float pntx,float pnty);                                                                       
//#16                                                                           
//#17    extern            void        insadj();                                                   
//#18    extern            void        setfchk();                                                   
//#19    extern            int            txad;                                               
//#20    extern            void        setangf(double tang);                                                   
//#21    extern            TXPNT        txpnts[MAXSEQ];                                                   
//#22    extern            RNGCNT*        txsegs;                                                   
//#23    extern            void        setxt();                                                   
//#24    extern            void        angrct(FLRCT* rct);                                                   
//#25    extern            FLRCT        isrct;                                                   
//#26    extern            void        deltx();
//#27    extern            BOOL        istx(unsigned find);                                                   
//#28    //extern            void        txseq();
//#29    extern            void        fntxvrt();                                                   
//#30    extern            void        txtfrm();                                                   
//#31    extern            void        intlv();                                                   
//#32    extern            INSREC        isinds[10];                                                   
//#33    extern            unsigned    isind2;                                                       
//#34    extern            unsigned    isind;                                                       
//#35    extern            unsigned    smap;                                                       
//#36    extern            FSTRTS        fstrts;                                                   
//#37    extern            FLPNT        iseq[MAXSEQ];                                                   
//#38    extern            void        fdelstch();                                                   
//#39    extern            void        chkcwlk();                                                   
//#40    extern            void        undcon();                                                   
//#41    extern            FLPNT*        insid();                                                   
//#42    extern            void        dasyfrm();                                                   
//#43    extern            FLPNT*        uflt;                                                   
//#44    extern            void        chkwlk();                                                   
//#45    extern            void        chkund();                                                   
//#46    extern            void        dubdel(unsigned cod);                                                   
//#47    extern            void        srtcol();                                                   
//#48    extern            void*        bakdat[16];                                                   
//#49    extern            unsigned    dupnt0;                                                       
//#50    extern            void        fritfil();                                                   
//#51    extern            void        fthrfn();                                                   
//#52    extern            void        setpsel();                                                   
//#53    extern            void        shoMsg(TCHAR* str);                                                   
//#54    extern            unsigned    setMap(unsigned bPnt);                                                       
//#55    extern            unsigned    rstMap(unsigned bPnt);                                                       
//#56    extern            void        centr();                                                   
//#57    extern            unsigned    chkMap(unsigned bPnt);
//#58    extern            void        rstAll();                                                   
//#59    extern            unsigned    px2stch();                                                       
//#60    extern            void        redraw(HWND dWnd);                                                   
//#61    extern            unsigned    toglMap(unsigned bPnt);                                                       
//#62    extern            void        coltab();                                                   
//#63    extern            void        pxCor2stch(POINT pnt);                                                   
//#64    extern            unsigned    chku(unsigned bPnt);                                                       
//#65    extern            void        savdo();                                                   
//#66    extern            void        redclp();                                                   
//#67    extern            void        rotang1(SHRTPNT rpnt,FLPNT* tpnt);                                                   
//#68    extern            void        unmsg();                                                   
//#69    extern            void        unsid();                                                   
//#70    extern            void        ritot(unsigned num);                                                   
//#71    extern            unsigned    duthrsh(double var);                                                       
//#72    extern            void        numWnd();                                                   
//#73    extern            void        stch2px1(unsigned stind);                                                   
//#74    extern            void        rngadj();                                                   
//#75    extern            void        clRmap(unsigned len);                                                   
//#76    extern            unsigned    setRmp(POINT* sPnt);                                                       
//#77    extern            void        chkrng(FLPNT* rsiz);                                                   
//#78    extern            unsigned    setRmap(SHRTPNT sPnt);                                                       
//#79    extern            void        selRct(FLRCT* srct);                                                   
//#80    extern            void        rotfn();                                                   
//#81    extern            void        unsel();                                                   
//#82    extern            void        uncros();                                                   
//#83    extern            void        unlin();                                                   
//#84    extern            void        ritmov();                                                   
//#85    extern            void        frmdel();                                                   
//#86    extern            void        zumhom();
//#87    extern            void        movStch();                                                   
//#88    extern            BOOL        filmsgs(unsigned cod);                                                   
//#89    extern            void        grpAdj();                                                   
//#90    extern            void        nfilmsg(TCHAR* str);                                                   
//#91    extern            FLPNT*        adflt(unsigned cnt);                                                   
//#92    extern            SATCON*        adsatk(unsigned cnt);                                                   
//#93    extern            void        ritnum(unsigned cod,unsigned num);                                                   
//#94    extern            void        shft(FLPNT shPnt);                                                   
//#95    extern            void        ritfcor(FLPNT* pnt);                                                   
//#96    extern            void        nuRct();                                                   
//#97    extern            void        stch2pxr(FLPNT stpnt);                                                   
//#98    extern            void        duzrat();                                                   
//#99    extern            void        rotangf(FLPNT rpnt,FLPNT* tpnt);                                                   
//#100    extern            FLPNT*        adclp(unsigned cnt);                                                   
//#101    extern            TCHAR*        mvflpnt(FLPNT* dst,FLPNT* src,unsigned cnt);                                                   
//#102    extern            void        mvsatk(SATCON* dst,SATCON* src,unsigned cnt);                                                   
//#103    extern            void        mvstchs(unsigned dst,unsigned src,unsigned cnt);                                                   
//#104    extern            void        unbsho();                                                   
//#105    extern            void        mvstch(unsigned dst,unsigned src);                                                   
//#106    extern            void        delstchm();                                                   
//#107    extern            void        undat();                                                   
//#108    extern            BOOL        isclp(unsigned find);                                                   
//#109    extern            BOOL        isclpx(unsigned find);                                                   
//#110    extern            void        delinf();                                                   
//#111    extern            void        pntmsg(unsigned cod);                                                   
//#112    extern            void        sdmsg();                                                   
//#113    extern            void        alrotmsg();                                                   
//#114    extern            void        grpselmsg();                                                   
//#115    extern            void        shortr();
//#116    extern            void        shord();                                                   
//#117    extern            void        spltmsg();                                                   
//#118    extern            void        shocent();                                                   
//#119    extern            void        stchun();                                                   
//#120    extern            void        stchremsg();                                                   
//#121    extern            void        tabmsg(unsigned cod);                                                   
//#122    extern            void        frm1pnt();                                                   
//#123    extern            void        shoseln(unsigned cod0,unsigned cod1);                                                   
//#124    extern            void        durpoli(unsigned nsids);                                                   
//#125    extern            void        ler();                                                   
//#126    extern            void        clpxadj();                                                   
//#127                                                                           
//#128    extern            POINT        pselfin;                                                   
//#129    extern            unsigned    fsizeof;                                                       
//#130    extern            RNGC        pselrng;                                                   
//#131    extern            HWND        hStch;                                                   
//#132    extern            HWND        hMsg;                                                   
//#133    extern            HWND        hsidWnd[11];                                                   
//#134    extern            HWND        hPrf;                                                   
//#135    extern            HWND        hfdat;                                                   
//#136    extern            HWND        hto;                                                   
//#137    extern            RECT        mRct;                                                   
//#138    extern            HED            hed;                                               
//#139    extern            RECT        scRct;                                                   
//#140    extern            RECT        sRct;                                                   
//#141    extern            DUBRCT        zRct;                                                   
//#142                                                                           
//#143    extern            HDC            sdc;                                               
//#144    extern            HDC            rsdc;
//#145                                                                           
//#146    extern            HPEN        fPen;                                                   
//#147    extern            HPEN        fPen3;                                                   
//#148    extern            HPEN        fsPen;                                                   
//#149    extern            HPEN        ypen[5];                                                   
//#150                                                                           
//#151    extern            FLPNT        sPnt;                                                   
//#152    extern            POINT        zum0;                                                   
//#153    extern            POINT        stOrg;                                                   
//#154    extern            POINT*        plin;                                                   
//#155    extern            DUBPNT        rotcntr;                                                   
//#156    extern            POINT        inlin[3];                                                   
//#157                                                                           
//#158    double            hfrat;                                                           
//#159    extern            double        stchAspct;                                                   
//#160                                                                           
//#161    extern            MSG            msg;                                               
//#162                                                                           
//#163    extern            double        usesiz;                                                   
//#164    extern            double        minsiz;                                                   
//#165    extern            double        smalsiz;                                                   
//#166    extern            double        ang;                                                   
//#167    extern            double        shopnts;                                                   
//#168    extern            double        stchboxs;                                                   
//#169    extern            double        zumFct;                                                   
//#170    extern            double        savang;                                                   
//#171    extern            unsigned    buttonWid;                                                       
//#172    extern            unsigned    actcol;                                                       
//#173    extern            unsigned    map[MAPLEN];
//#174    extern            unsigned    cloInd;                                                       
//#175    extern            unsigned    gpnt0;                                                       
//#176    extern            unsigned    gpnt1;                                                       
//#177    extern            unsigned    hClip;                                                       
//#178    extern            unsigned    apcol;                                                       
//#179    extern            unsigned    msgpnt;                                                       
//#180    extern            unsigned    prfind;                                                       
//#181    extern            unsigned    sidtyp;                                                       
//#182    extern            unsigned    slpnt;                                                       
//#183    extern            unsigned    selCnt;                                                       
//#184    extern            unsigned    grpInd;                                                       
//#185    extern            DUBPNT        zrat;                                                   
//#186    extern            HWND        hWnd;                                                   
//#187    extern            HMENU        hMen;                                                   
//#188    extern            HMENU        hfilMen;                                                   
//#189    extern            HWND        hok;                                                   
//#190    extern            HWND        hcan;                                                   
//#191    extern            HWND        hdsc;                                                   
//#192    extern            RECT        msgRct;                                                   
//#193    extern            HGLOBAL        hClpMem;                                                   
//#194    extern            unsigned    buttonWid3;                                                       
//#195    extern            unsigned    buttonHi;                                                       
//#196    extern            HINSTANCE    hInst;                                                       
//#197    extern            void        mvstch(SHRTPNT* dst, SHRTPNT* src);                                                   
//#198    extern            void        delfstchs();                                                   
//#199    extern            BOOL        isfclp();                                                   
//#200    extern            FLRCT        pselrct;                                                   
//#201    extern            RECT        pxselrct;                                                   
//#202
//#203    extern            DUBPNT        mrkpnt;                                                   
//#204    extern            SHRTPNT        stchs[MAXPCS];                                                   
//#205    extern            SHRTPNT        clpnu[MAXFRMLINS];                                                   
//#206    extern            unsigned    clplen;            //number of stitchs extracted from clipboard                                           
//#207    extern            HCURSOR     hCros;                                                       
//#208    extern            HCURSOR     hAr;                                                       
//#209    extern            TCHAR        msgbuf[MSGSIZ];                                                   
//#210    extern            TCHAR        sidbuf[11];                                                   
//#211    extern            TCHAR*        pcdClip;                                                   
//#212    extern            void        sCor2px(DUBPNT stpnt,POINT* pxpnt);                                                   
//#213    extern            void*        clpvoid;                                                   
//#214    extern            CLPSTCH*    clpdat;                                                       
//#215    extern            FLRCT        clprct;                                                   
//#216    extern            FLSIZ        clpsiz;                                                   
//#217    extern            FRMHED*        frmpnt;            //pointer to selected form                                       
//#218    extern            HWND        hSid;                                                   
//#219    extern            unsigned    numpnt;                                                       
//#220    extern            unsigned    rmap[RMAPSIZ];                                                       
//#221    extern            POINT        stchSiz;                                                   
//#222    extern            HPEN        uPen[16];                                                   
//#223    extern            HPEN        fmpen;                                                   
//#224    extern            HPEN        alpen;                                                   
//#225    extern            FLRCT        rotrct;                                                   
//#226    extern            unsigned    actl;                                                       
//#227    extern            unsigned    laycod;                                                       
//#228    extern            FLRCT        rngrct;                                                   
//#229    extern            unsigned    dunmap[MAXFRMLINS/32+1];                                                       
//#230    extern            void        rotflt(FLPNT* pnt);                                                   
//#231    extern            FLPNT        bigsiz;
//#232    extern            unsigned    toglu(unsigned bPnt);                                                       
//#233    extern            TCHAR        thrnam[MAX_PATH];                                                   
//#234    extern            POINT        sizlin[5];                                                   
//#235    extern            INIFIL        ini;                                                   
//#236    extern            POINT        pPnt;                                                   
//#237    extern            POINT        morg;                                                   
//#238    extern            POINT        scend;                                                   
//#239    extern            DUBPNT        zumend;                                                   
//#240    extern            unsigned    bwid;                                                       
//#241    extern            unsigned    bhi;                                                       
//#242    extern            HDC            bitdc;                                               
//#243    extern            TCHAR*        stab[STR_LEN];                                                   
//#244    extern            unsigned    prfsiz;                                                       
//#245
procedure lcon();                                                                           
//#246    void            lcon();                                                           
//#247    void            filvrt();
procedure filvrt(var frmpnt : TFRMHED);
//#248    void            filang();
//#249    void            fnvrt();
procedure fnvrt(var frmpnt : TFRMHED); 
//#250    void            satfil();                                                           
//#251    void            frmsqr(unsigned ind);                                                           
//#252    void            uncon();                                                           
//#253    void            uninsf();                                                           
//#254    void            rotfrm(unsigned nu0);                                                           
//#255    void            brdfil(double siz);                                                           
//#256    void            clpbrd(unsigned short slin);                                                           
//#257    void            fnhor();                                                           
//#258    void            oclp(FLPNT* clp,unsigned nclp);                                                           
//#259    unsigned short    nxt(unsigned short ind);
//#260    void            bdrlin(unsigned strt,unsigned fin,double siz);                                                           
//#261    void            rbrd();                                                           
//#262    void            satout(double satwid);                                                           
//#263    void            slbrd();                                                           
//#264    void            clpout();                                                           
//#265    void            sbrd();                                                           
//#266    void            lapbrd();                                                           
//#267    void            apbrd();                                                           
//#268    void            bold(double siz);                                                           
//#269    void            plbrd(double spac);                                                           
//#270    void            prpbrd(double spac);                                                           
//#271    void            pbrd(double spac);                                                           
//#272    unsigned short    prv(unsigned ind);                                                                   
//#273    void            fmclp();                                                           
//#274    unsigned        setdun(unsigned bpnt);                                                               
//#275    void            bakseq();                                                           
//#276    void            setr(unsigned pbit);                                                           
//#277    BOOL            chkr(unsigned pbit);                                                           
//#278    void            selal();                                                           
//#279    void            blbrd(double spac);                                                           
//#280    void            bhbrd(double spac);                                                           
//#281    void            clpic(unsigned short strtlin);                                                           
//#282    void            contf();                                                           
//#283    void            filinsb(DUBPNT pnt);                                                           
//#284    void            fvars(unsigned ind);                                                           
//#285    unsigned        psg();                                                               
//#286    void            frmpnts(unsigned typ);                                                           
//#287    void            clpcon();                                                           
//#288    void            horsclp();
//#289    void            angsclp();                                                           
//#290    void            dubfn();                                                           
//#291    void            horclpfn();                                                           
//#292    void            angclpfn();                                                           
//#293    void            duhart(unsigned nsids);                                                           
//#294    BOOL            iseclp(unsigned find);                                                           
//#295    BOOL            iseclpx(unsigned find);                                                           
//#296    void            deleclp(unsigned ind);                                                           
//#297    void            delmclp(unsigned ind);                                                           
//#298    void            dufcntr(DUBPNT* cntr);                                                           
//#299    void            chnfn();                                                           
//#300    void            chan();                                                           
//#301    void            sRct2px(FLRCT strct,RECT* pxrct);                                                           
//#302
implementation

uses
  GR32, Math;

const  
//#303    unsigned        refmcnt;                //lines in the form-form                                               
//#304    float            maxs;                    //maximum stitch length                                       
//#305    float            uslen;                    //user stitch length                                       
//#306    double*            sins;                    //a list if sins of form angles                                       
//#307    double*            cosins;                    //a list if cosins of form angles                                       
//#308    double            adjspac;                //adjusted space                                           
//#309    unsigned        nxstrt;                    //index of the endpoint of the line segment being processed                                           
//#310    FLPNT*            chpnts;                    //end points of chain stiches                                       
//#311    unsigned        chseq[]={0,1,2,3,0,1,4,3,0,3};//chain stich sequence
//#312    double            div4;                    //chain space divided by four                                       
//#313    unsigned        chncnt;                    //number of elements of the chain sequence to process                                           
//#314                                                                           
//#315    unsigned        clofind;                //closest form to the cursor                                               
//#316    unsigned        clofinx;                //end point of selected range of forms                                               
//#317    unsigned        clofine;                //point closest to the cursor                                               
//#318    double            vfrat;                    //vertical ratio between the zoom window                                       
//#319                                            // and the entire stitch space                               
//#320    POINT            flin[MAXFRMLINS];        //used in the form drawing routines                                                   
//#321    unsigned        nuflen;                    //points in the new form                                           
//#322    FRMINFO            finfo;                    //form info used in drawing forms                                       
//#323    FRMHED            formlst[MAXFORMS];        //a list of pointers to forms                                                   
//#324    unsigned        formpnt=0;                //index into the list of forms                                               
//#325    double            stspace=DEFSPACE*PFGRAN;//stitch spacing in stitch units
  stspace : double =DEFSPACE*PFGRAN;
    //DEFSPACE   = 0.45;	              // default stitch spacing
    //PFGRAN     = 6;		                // pfaf "pixels" per millimeter

//#326    double            angl=DEFANG;            //fill rotation angle                                               
//#327    unsigned        frmtyp;                    //user is creating a new form of this type                                           
//#328    FLPNT*            lin;                    //pointer to the line of the polygon being filled                                       
//#329    FLPNT*            filclp;                    //data for clipboard fills                                       
//#330    FLPNT*            clprev;                    //data for clipboard fills                                       
//#331    unsigned        spnt;                    //count of stitch lines                                           
//#332    SMALPNTL*        lins;                    //pairs of fill line endpoints
//#333    unsigned        dpnt;                    //pointer to the active line in the sequencing algorithm
//#334    unsigned        xpnt;                    //pointer to the active point in the sequencing algorithm
//#335    unsigned        maxlins;                //maximum angle fill lines for any adjusted y cordinate
//#336    unsigned        grpind;                    //pointer for groups of fill line segments
//#337    SMALPNTL**        seq;                    //sorted pointers to lins
//#338    unsigned short    sids;                    //sides of the selected form to fill
//#339    unsigned        lpnt;                    //for connecting fill lines
//#340    unsigned        seqpnt;                    //sequencing pointer
//#341    BSEQPNT            bseq[BSEQLEN];            //reverse sequence for polygon fills





//#342    FLPNT            oseq[OSEQLEN];            //temporary storage for sequencing
//#343    double            slop;                    //slope of line in angle fills
//#344    unsigned        satpt;                    //pointer to next satin point to enter
//#345    FLPNT            fmovdif;                //offset for moving forms
//#346    unsigned        frmstrt;                //points to the first stitch in a form
//#347    unsigned        frmend;                    //points to one past the last stitch in a form
//#348    POINT            bakpnt;                    //user moved a form point to here
//#349    FLPNT            tpoly[MAXFRMLINS];        //temporary storage when user is entering a polygon;
//#350    unsigned short    lin0,lin1;                //from and to lines in angle fill
//#351    unsigned        opnt;                    //output pointer for sequencing
//#352    double*            lens;                    //array of cumulative lengths used in satin fills
//#353    FLPNT*            flt;                    //points in the currently selected form
//#354    SATCON*            sac;                    //connections in the currently selecteed form
//#355    unsigned short    stpt;                    //number of connections in the currently selected form
//#356    unsigned short    wpar;                    //word paramater from the currently selected form
//#357    unsigned*        chkmap;                    //bitmap used by satin fill to delete illegal lines
//#358    unsigned short    xstrt;                    //starting point for a sating stitch guide-line
//#359    FLPNT*            clp;                    //pointer to the clipboard data for clipboard fills
//#360    unsigned short    nclp;                    //number of clipboard data points
//#361    double            plen;                    //horizontal length of a clipboard fill/2
//#362    double            plen2;                    //horizontal length of a clipboard fill
//#363    FLPNT            lastpnt;                //last point written by lin connect routine
//#364    double            bac;                    //border accumular for filling
//#365    FLPNT            opntlst[MAXFRMLINS];    //list of outside outline points for satin or clipboard fills
//#366    FLPNT            ipntlst[MAXFRMLINS];    //list of inside outline points for satin or clipboard fills
//#367    FLPNT*            opnts;                    //pointer to the list of outside outline points
//#368    FLPNT*            ipnts;                    //pointer to the list of inside outline points
//#369    FLPNT            clpref;                    //clipboard reference point
//#370    double            brdwid=BRDWID;            //border width for satin borders
//#371    unsigned        delpnt;                    //points to deleted stitches for refilling
//#372    unsigned short    lastflt;                //last form point to be filled
//#373    unsigned        cntrl;                    //user selected form control point
//#374    POINT            rctlin[10];                //form control rectangle in pixel coordinates
//#375    unsigned        fixed;                    //part of form rectangle that is fixed during stretching or expanding
//#376    double            xpct;                    //expand form aspect ratio
//#377    HWND            thDat[LASTLIN];            //data handles for the form data sheet
//#378    HWND            thTxt[LASTLIN];            //text handles for the form data sheet
//#379    RECT            loc0;                    //location of left windows in the form data sheet
//#380    RECT            loc1;                    //location of right windoww in the form data sheet
//#381    POINT            siz0;                    //size of the left windows in the form data sheet
//#382    POINT            siz1;                    //size of the right windows in the form data sheet
//#383    FLPNT            lolft;                    //lower left point in a form
//#384    VRCT2*            pvrct;                    //fill points for vertical satin fill
//#385    VRCT2*            uvrct;                    //underlay fill points for vertical satin fill
//#386    POINT            mvlin[3];                    //points to form points to be moved
//#387    unsigned*        xhst;                    //x histogram for snap together
//#388    FLPNT            rsiz;                    //hoop size
//#389    double            snplen=SNPLEN*PFGRAN;        //snap together length
//#390    unsigned*        xpnts;                    //stitch indices sorted according to x values
//#391    unsigned        colmap;                    //bitmap of colors in a design for sort
//#392    unsigned        dunmap[MAXFRMLINS/32+1];    //bitmap of sorted segments
//#393    double            starat=STARAT;            //star point to body ratio
//#394    double            spirwrap=SPIRWRAP;        //number of revolutions in a spiral
//#395    unsigned        srtmsk=(1<<EGSAT)|(1<<EGAP)|(1<<EGPRP);  //mask for switchable fill types
//#396    RCON*            pmap;                    //path map for sequencing
//#397    unsigned        cpnt;                    //number of entries in the path map
//#398    TCHAR*            visit;                    //visited character map for sequencing
//#399    unsigned        vispnt;                    //next unvisited region for sequencing
//#400    unsigned        rgcnt;                    //number of regions to be sequenced
//#401    RGN*            rgns;                    //a list of regions for sequencing
//#402    unsigned        dunrgn;                    //last region sequenced
//#403    double            rgclos;                    //region close enough threshold for sequencing
//#404    unsigned*        minds;                    //pointers to sets of adjacent regions
//#405    RGSEQ*            rgpth;                    //path to a region
//#406    unsigned        pthlen;                    //length of the path to the region
//#407    unsigned        grindpnt;                //number of group indices

//#408    unsigned*        grinds;                    //array of group indices for sequencing


//#409    unsigned        lastgrp;                //group of the last line written in the previous region;
//#410    FSEQ*            mpath;                    //path of sequenced regions
//#411    RGSEQ*            tmpath;                    //temporary path connections
//#412    unsigned        mpathi;                    //index to path of sequenced regions
//#413    unsigned        nxtgrp;                    //group that connects to the next region
//#414    unsigned*        seqmap;                    //a bitmap of sequenced lines
//#415    unsigned*        srgns;                    //an array of subregion starts
//#416    RGN*            durpnt;                    //region currently being sequenced
//#417    FLPNT            dunpnts[4];                //corners of last region sequenced
//#418    FRMHED            angfrm;                    //a temporary rotated form for angle fills
//#419    unsigned short    selist[MAXFORMS];        //a list of selected forms
//#420    unsigned        fselpnt=0;                //number of selected forms
//#421    unsigned        baksel;                    //previously selected form
//#422    RECT            bigrct;                    //for multiple selections;
//#423    POINT            biglin[9];                //line derived from the big rectangle
//#424    POINT            pselin[9];                //line derived from the point select rectangle
//#425    FLRCT            rctal;                    //rectangle enclosing all forms and stitches
//#426    double            angs[MAXFRMLINS];        //angles of a form for satin border fills
//#427    FLPNT            flts[MAXFRMPNTS];        //form points
//#428    unsigned        fltad;                    //next index to append form points
//#429    FLPNT            clps[MAXCLPNTS];        //main clipboard fill points for forms
//#430    unsigned        clpad;                    //next index to append main clipboard points
//#431    SATCON            satks[MAXSAC];            //satin form connects
//#432    unsigned        satkad;                    //next index to append satin connect points
//#433    float            bfclen=IBFCLEN;            //buttonhole corner length
//#434    float            picspac=IPICSPAC;        //space between border picots
//#435    unsigned        psgacc;                    //pseudo-random sequence register
//#436    SECNDS*            preg;                    //segments for sorting colors and forms
//#437    unsigned        prgind;                    //segment sorting index;
//#438    DUBPNT            filbak[8];                //backup stitches in satin fills
//#439    unsigned        pfbak;                    //pointer for backup stitches in satin fills
//#440    double            clpang;                    //for clipboard border fill
//#441    DUBPNT            mvpnt;                    //moving point for clipboard fill
//#442    SHRTPNT            rclpnt;                    //for rotating clipboard fill
//#443    double            cosang;                    //cosine for clipboard fill
//#444    double            sinang;                    //sine for clipboard fill
//#445    FLPNT            rclpref;                //reference for clipboard line border
//#446    unsigned        clpstrt;                //active form point for line clipboard fill
//#447    DUBPNT            vct0;                    //x size of the clipbord fill at the fill angle
//#448    FRMHED*            rfrmlst;                //temporary form header storage for reordering forms
//#449    FLPNT*            rflts;                    //temporary form point storage for reording forms
//#450    SATCON*            rsats;                    //temporary satin guidline storage for reording forms
//#451    FLPNT*            rclps;                    //temporary clipboard point storage for reording forms
//#452    unsigned        frepnt;                    //form relocator pointer
//#453    SHRTPNT*        hifstch;                //pointer to high stitch area for form sort
//#454    unsigned        beancnt;                //number of stitches added by convert to bean
//#455    FRMHED*            finspnt;                //insert form points in this form
//#456    unsigned        fgpnt0;                    //form point storage for form point insert
//#457    unsigned        fgpnt1;                    //form point storage for form point insert
//#458    SMALPNTL*        seqlin;                    //line for vertical/horizontal/angle fills
//#459    unsigned        mpath0;                    //point to the next path element for vertical fill sequencint
//#460    FLPNT*            lconflt;                //form points for angle fills
//#461    FLPNT            angflt[MAXFRMLINS];        //form point data for angle fills
//#462    FLPNT*            clpseq;                    //pointer to vertucal clipboard fill data
//#463    double            minot;                    //minimum distance from a line
//#464    unsigned        minotl;                    //index to the minimum distance line
//#465    CLPSEG*            clpsegs;                //clipboard segments for virtual clipboard fill
//#466    unsigned        pcseg;                    //clipboard segment pointer
//#467    unsigned        pcseg2;                    //clipboard segment pointer * 2
//#468    unsigned short    vclpsid;                //clipboard intersect sid;
//#469    float**            plens;                    //array of sorted side lengths for verticoal clipboard fill
//#470    FLPNT            vpnt0;                    //vertical clipboard line segement start
//#471    FLPNT            vpnt1;                    //vertical clipboard line segement end
//#472    double*            clplens;                //lengths of form sides for vertical clipboard fill
//#473    CLIPSORT*        clpsrt;                    //intersect points for vertical clipboard fill
//#474    CLIPSORT**        pclpsrt;                //pointers to line intersect points
//#475    CLIPNT*            clipnts;                //points for vertical clipboard fills
//#476    VCLPX*            vclpx;                    //region crossing data for vertical clipboard fills
//#477    unsigned*        iclpx;                    //indices into region crossing data for vertical clipboard fills
//#478    unsigned        vlim;                    //wrap limit for vertical clipboard fills
//#479    unsigned        clplim;                    //vertical clipboard search limit
//#480    float            clpcirc;                //circumference of the vertical clipboard fill form
//#481    float            clpcirc2;                //circumference of the vertical clipboard fill form / 2
//#482    float            strtlen;                //distance from zero point of first vertical clipboard segment
//#483    unsigned        vstrt;                    //start of region crossing data for a particular region
//#484    unsigned        vfin;                    //end of region crossing data for a particular region
//#485    float            clpwid;                    //horizontal spacing for vertical clipboard fill
//#486    unsigned        regof;                    //starting region for vertical clipboard fill
//#487    HWND            htim;                    //prograss bar
//#488    HDC                timdc;                    //progress bar device context
//#489    double            timstp;                    //progress bar step
//#490    double            timpos;                    //progress bar postiion
//#491    FLOAT            fltof;                    //form offset for clipbaord fills
//#492    long            prfwid;                    //width of the preference window
//#493    double            egrat;                    //ratio for shrinking eggs
//#494
//#495    TCHAR*        laytxt[]={
//#496
//#497        0                                                                   
//#498        1                                                                   
//#499        2                                                                   
//#500        3                                                                   
//#501        4                                                                   
//#502    };                                                                       
//#503                                                                           
//#504    TCHAR        oftxt[16];                                                               
//#505                                                                           
//#506    MENUITEMINFO meninfo={                                                                       
//#507                                                                           
//#508        sizeof(MENUITEMINFO),                                                                   
//#509        MIIM_TYPE,                                                                   
//#510        MFT_STRING,                                                                   
//#511        0                                                                   
//#512        0                                                                   
//#513        0                                                                   
//#514        0                                                                   
//#515        0                                                                   
//#516        0                                                                   
//#517        oftxt,                                                                   
//#518        16                                                                   
//#519    };                                                                       
//#520                                                                           
//#521    unsigned short egaray[]={                                                                       
//#522                                                                           
//#523        MEGLIN,                                                                   
//#524        MEGBLD,                                                                   
//#525        MEGCLP,                                                                   
//#526        MEGSAT,                                                                   
//#527        MEGAP,                                                                   
//#528        MEGPRP,                                                                   
//#529        MEGHOL,                                                                   
//#530        MEGPIC,                                                                   
//#531        MEGDUB,                                                                   
//#532        MEGCHNH,                                                                   
//#533        MEGCHNL,                                                                   
//#534        MEGCLPX,                                                                   
//#535    };                                                                       
//#536                                                                           
//#537    unsigned char lvl00=0;                                                                       
//#538    unsigned char lvl01=1;                                                                       
//#539    unsigned char lvl02[]={0,1};                                                                       
//#540    unsigned char lvl03[]={1,0,2};                                                                       
//#541    unsigned char lvl04[]={1,3,0,2};                                                                       
//#542    unsigned char lvl05[]={2,0,3,1,4};                                                                       
//#543    unsigned char lvl06[]={3,0,2,4,1,5};                                                                       
//#544    unsigned char lvl07[]={3,0,4,1,6,2,5};                                                                       
//#545    unsigned char lvl08[]={4,0,5,1,3,6,2,7};                                                                       
//#546    unsigned char lvl09[]={4,0,5,1,6,2,7,3,8};                                                                       
//#547    unsigned char lvl10[]={5,0,6,1,7,2,8,3,9,4};                                                                       
//#548    unsigned char lvl11[]={5,0,6,1,7,2,8,3,9,10};                                                                       
//#549    unsigned char lvl12[]={6,0,7,1,8,2,9,3,10,4,11};                                                                       
//#550    unsigned char lvl13[]={6,0,1,7,2,8,3,9,4,10,5,11,6,12};                                                                       
//#551    unsigned char lvl14[]={7,0,8,1,9,2,10,3,11,4,12,5,13,6};                                                                       
//#552    unsigned char lvl15[]={7,0,8,1,9,2,10,3,11,4,12,5,13,6,14,7,15};                                                                       
//#553                                                                           
//#554    unsigned char* lvls[]={                                                                       
//#555                                                                           
//#556    &lvl00,&lvl01,&lvl02[0],&lvl03[0],&lvl04[0],&lvl05[0],&lvl06[0],&lvl07[0],&lvl08[0],                                                                       
//#557    &lvl09[0],&lvl10[0],&lvl11[0],&lvl12[0],&lvl13[0],&lvl14[0],&lvl15[0]                                                                       
//#558    };                                                                       
//#559                                                                           
//#560    #pragma warning(disable:4244)                                                                       
//#561                                                                           
//#562    void frmcpy(FRMHED* dst,FRMHED* src){                                                                       
//#563                                                                           
//#564        unsigned ind=sizeof(FRMHED);                                                                   
//#565                                                                           
//#566        _asm{                                                                   
//#567                                                                           
//#568                mov        edi,dst                                                   
//#569                mov        ecx,ind                                                   
//#570                shr        ecx,2                                                   
//#571                mov        esi,src                                                   
//#572                rep        movsd                                                   
//#573        }                                                                   
//#574    }                                                                       
//#575                                                                           
//#576    void frmclr(FRMHED* dst){                                                                       
//#577                                                                           
//#578        unsigned ind=sizeof(FRMHED);                                                                   
//#579                                                                           
//#580        _asm{                                                                   
//#581                                                                           
//#582                mov        edi,dst                                                   
//#583                mov        ecx,ind                                                   
//#584                shr        ecx,2                                                   
//#585                xor        eax,eax                                                   
//#586                rep        stosd                                                   
//#587        }                                                                   
//#588    }                                                                       
//#589                                                                           
//#590    void duinf(FRMHED* hed){                                                                       
//#591                                                                           
//#592        _asm{                                                                   
//#593                                                                           
//#594                mov        ebx,hed                                                   
//#595                mov        eax,[ebx]                                                   
//#596                mov        ebx,offset finfo                                                   
//#597                xor        ecx,ecx                                                   
//#598                mov        cl,al                                                   
//#599                and        cl,0xf                                                   
//#600                mov        [ebx],ecx                                                   
//#601                add        ebx,4                                                   
//#602                mov        cl,al                                                   
//#603                shr        ecx,4                                                   
//#604                and        cl,0xf                                                   
//#605                mov        [ebx],ecx                                                   
//#606                add        ebx,4                                                   
//#607                shr        eax,8                                                   
//#608                and        eax,0xffff                                                   
//#609                mov        [ebx],eax                                                   
//#610        }                                                                   
//#611    }                                                                       
//#612                                                                           
//#613    int comp(const void *arg1, const void *arg2){                                                                       
//#614                                                                           
//#615        _asm{                                                                   
//#616                mov        ebx,arg2                                                   
//#617                mov        ebx,[ebx]                                                   
//#618                add        ebx,8                                                   
//#619                fld        qword ptr[ebx]                                                   
//#620                mov        ecx,arg1                                                   
//#621                mov        ecx,[ecx]                                                   
//#622                add        ecx,8                                                   
//#623                fld        qword ptr[ecx]                                                   
//#624                fucompp                                                           
//#625                fstsw    ax                                                       
//#626                and        ah,0x43                                                   
//#627                je        short cmpg                                                   
//#628                cmp        ah,1                                                   
//#629                jne        short cmp1                                                   
//#630                xor        eax,eax                                                   
//#631                dec        eax                                                   
//#632                jmp        short cmpx                                                   
//#633    cmp1:        sub        ecx,8                                                       
//#634                sub        ebx,8                                                   
//#635                fld        qword ptr[ebx]                                                   
//#636                fld        qword ptr[ecx]                                                   
//#637                fucompp                                                           
//#638                fstsw    ax                                                       
//#639                je        short cmpg                                                   
//#640                cmp        ah,1                                                   
//#641                jne        short cmp2                                                   
//#642                xor        eax,eax                                                   
//#643                dec        eax                                                   
//#644                jmp        short cmpx                                                   
//#645    cmp2:        xor        eax,eax                                                       
//#646                jmp        short cmpx                                                   
//#647    cmpg:        xor        eax,eax                                                       
//#648                inc        eax                                                   
//#649    cmpx:                                                                       
//#650        }                                                                   
//#651    #pragma warning(disable:4035;once:)                                                                       
//#652    }                                                                       
//#653                                                                           
//#654    void getfinfo(unsigned ind){                                                                       
//#655                                                                           
//#656        duinf(&formlst[ind]);                                                                   
//#657    }                                                                       
//#658                                                                           
//#659    unsigned satind(SATCON* pnt){                                                                       
//#660                                                                           
//#661        _asm{                                                                   
//#662                                                                           
//#663                mov        eax,pnt                                                   
//#664                sub        eax,offset satks                                                   
//#665                shr        eax,2                                                   
//#666        }                                                                   
//#667    }                                                                       

procedure dusqr();
//#669    void dusqr(){
begin
//#671        if(chku(SQRFIL))
//#672            frmpnt->xat|=AT_SQR;
//#673        else
//#674            frmpnt->xat&=(~AT_SQR);
//#675    }
end;

//#677    void sacspac(SATCON* strt,unsigned cnt){
//#678                                                                           
//#679        int            strti,cnti;                                                       
//#680        int            src,dst;                                                       
//#681        unsigned    ind;                                                               
//#682                                                                           
//#683        strti=satind(strt);                                                                   
//#684        cnti=satkad-strti;                                                                   
//#685        src=satkad-1;                                                                   
//#686        dst=satkad+cnt-1;                                                                   
//#687        while(src>=strti){                                                                   
//#688                                                                           
//#689            satks[dst].strt=satks[src].strt;                                                               
//#690            satks[dst--].fin=satks[src--].fin;                                                               
//#691        }                                                                   
//#692        for(ind=clofind+1;ind<formpnt;ind++){                                                                   
//#693                                                                           
//#694            if(formlst[ind].typ==SAT)                                                               
//#695                formlst[ind].sacang.sac+=cnt;                                                           
//#696        }                                                                   
//#697        satkad+=cnt;                                                                   
//#698    }                                                                       
//#699                                                                           
//#700    SATCON* nusac(unsigned pfrm,unsigned cnt){                                                                       
//#701                                                                           
//#702        unsigned ind,ine;                                                                   
//#703                                                                           
//#704        ine=0;                                                                   
//#705        for(ind=0;ind<pfrm;ind++){                                                                   
//#706                                                                           
//#707            if(formlst[ind].typ==SAT)                                                               
//#708                ine+=formlst[ind].stpt;                                                           
//#709        }                                                                   
//#710        formlst[pfrm].sacang.sac=&satks[ine];                                                                   
//#711        sacspac(formlst[pfrm].sacang.sac,cnt);                                                                   
//#712        return formlst[pfrm].sacang.sac;                                                                   
//#713    }                                                                       
//#714                                                                           
//#715    void delclps(unsigned ind){                                                                       
//#716                                                                           
//#717        deleclp(ind);                                                                   
//#718        delmclp(ind);                                                                   
//#719    }                                                                       
//#720                                                                           
//#721    unsigned findclp(unsigned fpnt){                                                                       
//#722                                                                           
//#723        int ind;                                                                   
//#724                                                                           
//#725        for(ind=clofind-1;ind>=0;ind--){                                                                   
//#726                                                                           
//#727            if(iseclp(ind))                                                               
//#728                return formlst[ind].clp-clps+formlst[ind].nclp;                                                           
//#729            if(isclp(ind))                                                               
//#730                return formlst[ind].angclp.clp-clps+formlst[ind].flencnt.nclp;                                                           
//#731        }                                                                   
//#732        return 0;                                                                   
//#733    }                                                                       
//#734                                                                           
//#735    BOOL chkmax(unsigned arg0,unsigned arg1){                                                                       
//#736                                                                           
//#737        if(arg0&MAXMSK)                                                                   
//#738            return 1;                                                               
//#739        if(arg1&MAXMSK)                                                                   
//#740            return 1;                                                               
//#741        if((arg1+arg0)&MAXMSK)                                                                   
//#742            return 1;                                                               
//#743        return 0;                                                                   
//#744    }                                                                       
//#745                                                                           
//#746    void clpsub(unsigned fpnt,unsigned cnt){                                                                       
//#747                                                                           
//#748        unsigned ind;                                                                   
//#749                                                                           
//#750        for(ind=fpnt+1;ind<formpnt;ind++){                                                                   
//#751                                                                           
//#752            if(isclpx(ind))                                                               
//#753                formlst[ind].angclp.clp-=cnt;                                                           
//#754            if(iseclpx(fpnt))                                                               
//#755                formlst[ind].clp-=cnt;                                                           
//#756        }                                                                   
//#757    }                                                                       
//#758                                                                           
//#759    void delmclp(unsigned fpnt){                                                                       
//#760                                                                           
//#761        unsigned    src,dst;                                                               
//#762                                                                           
//#763        if(clpad){                                                                   
//#764                                                                           
//#765            if(isclp(fpnt)){                                                               
//#766                                                                           
//#767                dst=findclp(fpnt);                                                           
//#768                src=dst+formlst[fpnt].flencnt.nclp;                                                           
//#769                MoveMemory(&clps[dst],&clps[src],sizeof(FLPNT)*(clpad-src));                                                           
//#770                if(iseclp(fpnt))                                                           
//#771                    formlst[fpnt].clp-=formlst[fpnt].flencnt.nclp;                                                       
//#772                clpsub(fpnt,formlst[fpnt].flencnt.nclp);                                                           
//#773                if(clpad>formlst[fpnt].flencnt.nclp)                                                           
//#774                    clpad-=formlst[fpnt].flencnt.nclp;                                                       
//#775                else                                                           
//#776                    clpad=0;                                                       
//#777                formlst[fpnt].flencnt.nclp=0;                                                           
//#778            }                                                               
//#779        }                                                                   
//#780    }                                                                       
//#781                                                                           
//#782    void deleclp(unsigned fpnt){                                                                       
//#783                                                                           
//#784        unsigned    src,dst;                                                               
//#785                                                                           
//#786        if(clpad){                                                                   
//#787                                                                           
//#788            if(iseclpx(fpnt)){                                                               
//#789                                                                           
//#790                dst=findclp(fpnt);                                                           
//#791                src=dst+formlst[fpnt].nclp;                                                           
//#792                while(src<clpad){                                                           
//#793                                                                           
//#794                    clps[dst].x=clps[src].x;                                                       
//#795                    clps[dst++].y=clps[src++].y;                                                       
//#796                }                                                           
//#797                clpsub(fpnt,formlst[fpnt].nclp);                                                           
//#798                if(clpad>formlst[fpnt].nclp)                                                           
//#799                    clpad-=formlst[fpnt].nclp;                                                       
//#800                else                                                           
//#801                    clpad=0;                                                       
//#802                formlst[fpnt].nclp=0;                                                           
//#803            }                                                               
//#804        }                                                                   
//#805    }                                                                       
//#806                                                                           
//#807    FLPNT* nueclp(unsigned pfrm,unsigned cnt){                                                                       
//#808                                                                           
//#809        int            find;                                                       
//#810        int            src,dst;                                                       
//#811        unsigned    ind;                                                               
//#812                                                                           
//#813        find=findclp(clofind);                                                                   
//#814        if(isclp(clofind))                                                                   
//#815            find+=formlst[clofind].flencnt.nclp;                                                               
//#816        src=clpad-1;                                                                   
//#817        dst=clpad+cnt-1;                                                                   
//#818        while(src>=find){                                                                   
//#819                                                                           
//#820            clps[dst].x=clps[src].x;                                                               
//#821            clps[dst--].y=clps[src--].y;                                                               
//#822        }                                                                   
//#823        formlst[find].clp=&clps[find];                                                                   
//#824        for(ind=pfrm;ind<formpnt;ind++){                                                                   
//#825                                                                           
//#826            if(iseclpx(ind))                                                               
//#827                formlst[ind].clp+=cnt;                                                           
//#828        }                                                                   
//#829        for(ind=pfrm+1;ind<formpnt;ind++){                                                                   
//#830                                                                           
//#831            if(isclp(ind))                                                               
//#832                formlst[ind].angclp.clp+=cnt;                                                           
//#833        }                                                                   
//#834        clpad+=cnt;                                                                   
//#835        return &clps[find];                                                                   
//#836    }                                                                       
//#837                                                                           
//#838    FLPNT* numclp(){                                                                       
//#839                                                                           
//#840        int            find;                                                       
//#841        int            src,dst;                                                       
//#842        unsigned    ind;                                                               
//#843                                                                           
//#844        find=findclp(clofind);                                                                   
//#845        src=clpad-1;                                                                   
//#846        dst=clpad+clplen-1;                                                                   
//#847        while(src>=find){                                                                   
//#848                                                                           
//#849            clps[dst].x=clps[src].x;                                                               
//#850            clps[dst--].y=clps[src--].y;                                                               
//#851        }                                                                   
//#852        formlst[clofind].angclp.clp=&clps[find];                                                                   
//#853        if(iseclpx(clofind))                                                                   
//#854            formlst[clofind].clp+=clplen;                                                               
//#855        for(ind=clofind+1;ind<formpnt;ind++){                                                                   
//#856                                                                           
//#857            if(isclpx(ind))                                                               
//#858                formlst[ind].angclp.clp+=clplen;                                                           
//#859            if(iseclpx(ind))                                                               
//#860                formlst[ind].clp+=clplen;                                                           
//#861        }                                                                   
//#862        clpad+=clplen;                                                                   
//#863        return &clps[find];                                                                   
//#864    }                                                                       
//#865                                                                           
//#866    unsigned fltind(FLPNT* pnt){                                                                       
//#867                                                                           
//#868        _asm{                                                                   
//#869                                                                           
//#870                mov        eax,pnt                                                   
//#871                sub        eax,offset flts                                                   
//#872                shr        eax,3                                                   
//#873        }                                                                   
//#874    }                                                                       
//#875                                                                           
//#876    unsigned sacind(SATCON* pnt){                                                                       
//#877                                                                           
//#878        _asm{                                                                   
//#879                                                                           
//#880                mov        eax,pnt                                                   
//#881                sub        eax,offset satks                                                   
//#882                shr        eax,2                                                   
//#883        }                                                                   
//#884    }                                                                       
//#885                                                                           
//#886    unsigned clpind(FLPNT* pnt){                                                                       
//#887                                                                           
//#888        _asm{                                                                   
//#889                                                                           
//#890                mov        eax,pnt                                                   
//#891                sub        eax,offset clps                                                   
//#892                shr        eax,3                                                   
//#893        }                                                                   
//#894    }                                                                       
//#895                                                                           
//#896    void fltspac(FLPNT* strt,unsigned cnt){                                                                       
//#897                                                                           
//#898        int            strti;                                                       
//#899        int            src,dst;                                                       
//#900        unsigned    ind;                                                               
//#901                                                                           
//#902        strti=fltind(strt);                                                                   
//#903        src=fltad-1;                                                                   
//#904        dst=fltad+cnt-1;                                                                   
//#905        while(src>=strti){                                                                   
//#906                                                                           
//#907            flts[dst].x=flts[src].x;                                                               
//#908            flts[dst--].y=flts[src--].y;                                                               
//#909        }                                                                   
//#910        for(ind=clofind+1;ind<formpnt;ind++)                                                                   
//#911            formlst[ind].flt+=cnt;                                                               
//#912        fltad+=cnt;                                                                   
//#913    }                                                                       
//#914                                                                           
//#915    void delsac(unsigned fpnt){                                                                       
//#916                                                                           
//#917        unsigned    ind;                                                               
//#918        unsigned    src,dst;                                                               
//#919                                                                           
//#920        if(satkad){                                                                   
//#921                                                                           
//#922            if(formlst[clofind].typ==SAT&&formlst[clofind].stpt){                                                               
//#923                                                                           
//#924                dst=satind(formlst[clofind].sacang.sac);                                                           
//#925                src=dst+formlst[clofind].stpt;                                                           
//#926                while(src<satkad){                                                           
//#927                                                                           
//#928                    satks[dst].strt=satks[src].strt;                                                       
//#929                    satks[dst++].fin=satks[src++].fin;                                                       
//#930                }                                                           
//#931                for(ind=clofind+1;ind<formpnt;ind++){                                                           
//#932                                                                           
//#933                    if(formlst[ind].typ==SAT&&formlst[ind].stpt)                                                       
//#934                        formlst[ind].sacang.sac-=formlst[clofind].stpt;                                                   
//#935                }                                                           
//#936                satkad-=formlst[clofind].stpt;                                                           
//#937            }                                                               
//#938        }                                                                   
//#939        formlst[clofind].stpt=0;                                                                   
//#940    }                                                                       
//#941                                                                           
//#942    void delflt(unsigned fpnt){                                                                       
//#943                                                                           
//#944        unsigned    ind;                                                               
//#945        unsigned    src,dst;                                                               
//#946                                                                           
//#947        if(formlst[clofind].sids){                                                                   
//#948                                                                           
//#949            dst=fltind(formlst[clofind].flt);                                                               
//#950            src=dst+formlst[clofind].sids;                                                               
//#951            while(src<fltad){                                                               
//#952                                                                           
//#953                flts[dst].x=flts[src].x;                                                           
//#954                flts[dst++].y=flts[src++].y;                                                           
//#955            }                                                               
//#956            for(ind=clofind+1;ind<formpnt;ind++)                                                               
//#957                formlst[ind].flt-=formlst[clofind].sids;                                                           
//#958            fltad-=formlst[clofind].sids;                                                               
//#959            if(fltad&0x8000000)                                                               
//#960                fltad=0;                                                           
//#961        }                                                                   
//#962    }                                                                       
//#963                                                                           
//#964    BOOL chk2of(){                                                                       
//#965                                                                           
//#966        if(!chkMap(SELBOX))                                                                   
//#967            return 0;                                                               
//#968        if(chku(FIL2OF))                                                                   
//#969            return 0;                                                               
//#970        return 1;                                                                   
//#971    }                                                                       
//#972                                                                           
//#973    void rotbak(){                                                                       
//#974                                                                           
//#975        unsigned ind;                                                                   
//#976                                                                           
//#977        for(ind=0;ind<seqpnt;ind++)                                                                   
//#978            rotflt(&oseq[ind]);                                                               
//#979    }                                                                       
//#980                                                                           
//#981    void delfil(unsigned at){                                                                       
//#982                                                                           
//#983        unsigned ind,ine;                                                                   
//#984                                                                           
//#985        at&=TYPMSK|FRMSK;                                                                   
//#986        ine=ind=0;                                                                   
//#987        rstMap(WASDEL);                                                                   
//#988        while((stchs[ind].at&(TYPMSK|FRMSK))!=at&&ind<hed.stchs)                                                                   
//#989            ind++;                                                               
//#990        ine=ind;                                                                   
//#991        if(ind<hed.stchs){                                                                   
//#992                                                                           
//#993            delpnt=ind;                                                               
//#994            setMap(WASDEL);                                                               
//#995        }                                                                   
//#996        while(ind<hed.stchs){                                                                   
//#997                                                                           
//#998            if((stchs[ind].at&(TYPMSK|FRMSK))!=at){                                                               
//#999                                                                           
//#1000                stchs[ine].at=stchs[ind].at;                                                           
//#1001                stchs[ine].x=stchs[ind].x;                                                           
//#1002                stchs[ine++].y=stchs[ind].y;                                                           
//#1003            }                                                               
//#1004            ind++;                                                               
//#1005        }                                                                   
//#1006        hed.stchs=ine;                                                                   
//#1007    }                                                                       
//#1008                                                                           
//#1009    void delmfil(unsigned col){                                                                       
//#1010                                                                           
//#1011        unsigned at,sat;                                                                   
//#1012        unsigned ind,ine;                                                                   
//#1013                                                                           
//#1014        if(istx(clofind))                                                                   
//#1015            deltx();                                                               
//#1016        delmclp(clofind);                                                                   
//#1017        col&=0xf;                                                                   
//#1018        at=clofind<<FRMSHFT;                                                                   
//#1019        ine=0;                                                                   
//#1020        for(ind=0;ind<hed.stchs;ind++)                                                                   
//#1021        {                                                                   
//#1022            sat=stchs[ind].at;                                                               
//#1023            if(!(sat&NOTFRM))                                                               
//#1024            {                                                               
//#1025                if(!((sat&FRMSK)==at&&(sat&(TYPFRM|FTHMSK))))                                                           
//#1026                    mvstch(ine++,ind);                                                       
//#1027            }                                                               
//#1028            else                                                               
//#1029                mvstch(ine++,ind);                                                           
//#1030        }                                                                   
//#1031        hed.stchs=ine;                                                                   
//#1032    }                                                                       
//#1033                                                                           
//#1034    void fsizpar(){                                                                       
//#1035                                                                           
//#1036        frmpnt->fmax=ini.maxsiz;                                                                   
//#1037        frmpnt->flencnt.flen=usesiz;                                                                   
//#1038        frmpnt->fmin=minsiz;                                                                   
//#1039    }                                                                       
//#1040                                                                           
//#1041    void chkcont(){                                                                       
//#1042                                                                           
//#1043        unsigned ind,ine,len,minlen=10000;                                                                   
//#1044                                                                           
//#1045        delmclp(clofind);                                                                   
//#1046        deleclp(clofind);                                                                   
//#1047        fsizpar();                                                                   
//#1048        if(frmpnt->ftyp!=CONTF){                                                                   
//#1049                                                                           
//#1050            if(stpt){                                                               
//#1051                                                                           
//#1052                for(ind=0;ind<frmpnt->stpt;ind++){                                                           
//#1053                                                                           
//#1054                    len=frmpnt->sacang.sac[ind].fin-frmpnt->sacang.sac[ind].strt;                                                       
//#1055                    if(len<minlen){                                                       
//#1056                                                                           
//#1057                        minlen=len;                                                   
//#1058                        ine=ind;                                                   
//#1059                    }                                                       
//#1060                }                                                           
//#1061                frmpnt->angclp.sat.strt=frmpnt->sacang.sac[ine].strt;                                                           
//#1062                frmpnt->angclp.sat.fin=frmpnt->sacang.sac[ine].fin;                                                           
//#1063                delsac(clofind);                                                           
//#1064            }                                                               
//#1065            else{                                                               
//#1066                                                                           
//#1067                frmpnt->angclp.sat.strt=1;                                                           
//#1068                frmpnt->angclp.sat.fin=frmpnt->sids-2;                                                           
//#1069            }                                                               
//#1070        }                                                                   
//#1071        frmpnt->typ=LIN;                                                                   
//#1072        frmpnt->ftyp=CONTF;                                                                   
//#1073        frmpnt->at|=FRECONT;                                                                   
//#1074    }                                                                       
//#1075                                                                           
//#1076    unsigned find1st(){                                                                       
//#1077                                                                           
//#1078        unsigned ind=0,at;                                                                   
//#1079                                                                           
//#1080        if(chk2of())                                                                   
//#1081            return cloInd;                                                               
//#1082        else{                                                                   
//#1083                                                                           
//#1084            at=clofind<<4;                                                               
//#1085            while(ind<hed.stchs){                                                               
//#1086                                                                           
//#1087                if((stchs[ind].at&FRMSK)==at){                                                           
//#1088                                                                           
//#1089                    if(!(stchs[ind].at&NOTFRM))                                                       
//#1090                        return ind;                                                   
//#1091                }                                                           
//#1092                ind++;                                                           
//#1093            }                                                               
//#1094            return ind;                                                               
//#1095        }                                                                   
//#1096    }                                                                       
//#1097                                                                           
//#1098    void ispcdclp(){                                                                       
//#1099                                                                           
//#1100        rstMap(WASPCDCLP);                                                                   
//#1101        if(OpenClipboard(hWnd)){                                                                   
//#1102                                                                           
//#1103            hClip=RegisterClipboardFormat(pcdClip);                                                               
//#1104            hClpMem=GetClipboardData(hClip);                                                               
//#1105            if(hClpMem)                                                               
//#1106                setMap(WASPCDCLP);                                                           
//#1107        }                                                                   
//#1108        CloseClipboard();                                                                   
//#1109    }                                                                       
//#1110                                                                           
//#1111    void frmout(unsigned ind){                                                                       
//#1112                                                                           
//#1113        FLRCT*        trct;                                                           
//#1114        unsigned    ine;                                                               
//#1115        float        off;                                                           
//#1116                                                                           
//#1117        if(formlst[ind].sids){                                                                   
//#1118                                                                           
//#1119            trct=&formlst[ind].rct;                                                               
//#1120            flt=formlst[ind].flt;                                                               
//#1121            trct->left=trct->right=flt[0].x;                                                               
//#1122            trct->bottom=trct->top=flt[0].y;                                                               
//#1123            for(ine=1;ine<formlst[ind].sids;ine++){                                                               
//#1124                                                                           
//#1125                if(flt[ine].x>trct->right)                                                           
//#1126                    trct->right=flt[ine].x;                                                       
//#1127                if(flt[ine].x<trct->left)                                                           
//#1128                    trct->left=flt[ine].x;                                                       
//#1129                if(flt[ine].y<trct->bottom)                                                           
//#1130                    trct->bottom=flt[ine].y;                                                       
//#1131                if(flt[ine].y>trct->top)                                                           
//#1132                    trct->top=flt[ine].y;                                                       
//#1133            }                                                               
//#1134            if(trct->top-trct->bottom<MINRCT){                                                               
//#1135                                                                           
//#1136                off=(MINRCT-(trct->top-trct->bottom))/2;                                                           
//#1137                trct->top+=off;                                                           
//#1138                trct->bottom-=off;                                                           
//#1139            }                                                               
//#1140            if(trct->right-trct->left<MINRCT){                                                               
//#1141                                                                           
//#1142                off=(MINRCT-(trct->right-trct->left))/2;                                                           
//#1143                trct->left-=off;                                                           
//#1144                trct->right+=off;                                                           
//#1145            }                                                               
//#1146        }                                                                   
//#1147    }                                                                       
//#1148                                                                           
//#1149    void sfCor2px(FLPNT stpnt,POINT* pxpnt){                                                                       
//#1150                                                                           
//#1151        pxpnt->x=(stpnt.x-zRct.left)*zrat.x+0.5;                                                                   
//#1152        pxpnt->y=scRct.bottom-(stpnt.y-zRct.bottom)*zrat.y+0.5;                                                                   
//#1153    }                                                                       
//#1154                                                                           
//#1155    void stCor2px(SHRTPNT stpnt,POINT* pxpnt){                                                                       
//#1156                                                                           
//#1157        pxpnt->x=(stpnt.x-zRct.left)*zrat.x+0.5;                                                                   
//#1158        pxpnt->y=scRct.bottom-(stpnt.y-zRct.bottom)*zrat.y+0.5;                                                                   
//#1159    }                                                                       
//#1160                                                                           
//#1161    void px2stchf(POINT pxpnt,FLPNT* stpnt){                                                                       
//#1162                                                                           
//#1163        double    tdub;                                                               
//#1164                                                                           
//#1165        tdub=(double)(pxpnt.x-scRct.left)/scRct.right;                                                                   
//#1166        stpnt->x=tdub*(zRct.right-zRct.left)+zRct.left;                                                                   
//#1167        tdub=(double)(scRct.bottom-pxpnt.y)/scRct.bottom;                                                                   
//#1168        stpnt->y=tdub*(zRct.top-zRct.bottom)+zRct.bottom;                                                                   
//#1169    }                                                                       
//#1170                                                                           
//#1171    void frmlin(FLPNT* scr,unsigned sidz){                                                                       
//#1172                                                                           
//#1173        unsigned ind;                                                                   
//#1174                                                                           
//#1175        if(sids){                                                                   
//#1176                                                                           
//#1177            for(ind=0;ind<sidz;ind++){                                                               
//#1178                                                                           
//#1179                flin[ind].x=(scr[ind].x-zRct.left)*zrat.x;                                                           
//#1180                flin[ind].y=scRct.bottom-(scr[ind].y-zRct.bottom)*zrat.y;                                                           
//#1181            }                                                               
//#1182            flin[ind].x=(scr[0].x-zRct.left)*zrat.x;                                                               
//#1183            flin[ind].y=scRct.bottom-(scr[0].y-zRct.bottom)*zrat.y;                                                               
//#1184        }                                                                   
//#1185    }                                                                       
//#1186                                                                           
//#1187    void dufrm(){                                                                       
//#1188                                                                           
//#1189        SetROP2(rsdc,R2_XORPEN);                                                                   
//#1190        SelectObject(rsdc,fPen);                                                                   
//#1191        Polyline(rsdc,flin,nuflen);                                                                   
//#1192        SetROP2(rsdc,R2_COPYPEN);                                                                   
//#1193    }                                                                       
//#1194                                                                           
//#1195    void unfrm(){                                                                       
//#1196                                                                           
//#1197        if(rstMap(SHOFRM))                                                                   
//#1198            dufrm();                                                               
//#1199    }                                                                       
//#1200                                                                           
//#1201    void mdufrm(){                                                                       
//#1202                                                                           
//#1203        SetROP2(rsdc, R2_XORPEN);                                                                   
//#1204        SelectObject(rsdc,fPen);                                                                   
//#1205        if(formlst[clofind].typ==LIN)                                                                   
//#1206            Polyline(rsdc,flin,nuflen-1);                                                               
//#1207        else                                                                   
//#1208            Polyline(rsdc,flin,nuflen);                                                               
//#1209        SetROP2(sdc,R2_COPYPEN);                                                                   
//#1210    }                                                                       
//#1211                                                                           
//#1212    void munfrm(){                                                                       
//#1213                                                                           
//#1214        if(rstMap(SHOFRM))                                                                   
//#1215            mdufrm();                                                               
//#1216    }                                                                       
//#1217                                                                           
//#1218    void rats(){                                                                       
//#1219                                                                           
//#1220        if(chkMap(ZUMED)){                                                                   
//#1221                                                                           
//#1222            hfrat=(double)(zRct.right-zRct.left)/scRct.right;                                                               
//#1223            vfrat=(double)(zRct.top-zRct.bottom)/scRct.bottom;                                                               
//#1224        }                                                                   
//#1225        else{                                                                   
//#1226                                                                           
//#1227            hfrat=(double)zum0.x/scRct.right;                                                               
//#1228            vfrat=(double)zum0.y/scRct.bottom;                                                               
//#1229        }                                                                   
//#1230    }                                                                       
//#1231                                                                           
//#1232    void setfrm(){                                                                       
//#1233                                                                           
//#1234        unsigned    ind;                                                               
//#1235        FLPNT        tpnt;                                                           
//#1236        FLPNT        dif;                                                           
//#1237                                                                           
//#1238        rats();                                                                   
//#1239        clofind=formpnt;                                                                   
//#1240        fvars(clofind);                                                                   
//#1241        px2stchf(flin[0],&tpnt);                                                                   
//#1242        dif.x=tpnt.x-flt[0].x;                                                                   
//#1243        dif.y=tpnt.y-flt[0].y;                                                                   
//#1244        frmpnt->rct.left=frmpnt->rct.bottom=(float)1e30;                                                                   
//#1245        frmpnt->rct.right=frmpnt->rct.top=0;                                                                   
//#1246        for(ind=0;ind<nuflen-1;ind++){                                                                   
//#1247                                                                           
//#1248            flt[ind].x+=dif.x;                                                               
//#1249            flt[ind].y+=dif.y;                                                               
//#1250            if(flt[ind].x<frmpnt->rct.left)                                                               
//#1251                frmpnt->rct.left=flt[ind].x;                                                           
//#1252            if(flt[ind].x>frmpnt->rct.right)                                                               
//#1253                frmpnt->rct.right=flt[ind].x;                                                           
//#1254            if(flt[ind].y>frmpnt->rct.top)                                                               
//#1255                frmpnt->rct.top=flt[ind].y;                                                           
//#1256            if(flt[ind].y<frmpnt->rct.bottom)                                                               
//#1257                frmpnt->rct.bottom=flt[ind].y;                                                           
//#1258        }                                                                   
//#1259        formpnt++;                                                                   
//#1260        rstMap(FORMIN);                                                                   
//#1261        setMap(INIT);                                                                   
//#1262        setMap(RESTCH);                                                                   
//#1263    }                                                                       
//#1264                                                                           
//#1265    void form(){                                                                       
//#1266                                                                           
//#1267        shoMsg(stab[STR_FMEN]);                                                                   
//#1268        setMap(FORMIN);                                                                   
//#1269        rstMap(INSRT);                                                                   
//#1270        duzrat();                                                                   
//#1271    }                                                                       
//#1272                                                                           
//#1273    void frmsqr(unsigned ind){                                                                       
//#1274                                                                           
//#1275        double    lang;                                                               
//#1276        double    rat;                                                               
//#1277        float    len;                                                               
//#1278        FLPNT    off;                                                               
//#1279        FLPNT    fpnt;                                                               
//#1280        FLPNT    dpnt;                                                               
//#1281        DUBPNT    dif;                                                               
//#1282        POINT    sqlin[4];                                                               
//#1283                                                                           
//#1284        stch2pxr(flt[ind]);                                                                   
//#1285        sqlin[1].x=pPnt.x;                                                                   
//#1286        sqlin[1].y=pPnt.y;                                                                   
//#1287        rat=(double)ini.frmpix/scRct.right;                                                                   
//#1288        len=(zRct.right-zRct.left)*rat*2;                                                                   
//#1289        dif.x=flt[ind-1].x-flt[ind].x;                                                                   
//#1290        dif.y=flt[ind-1].y-flt[ind].y;                                                                   
//#1291        lang=atan2(dif.y,dif.x);                                                                   
//#1292        off.x=len*cos(lang);                                                                   
//#1293        off.y=len*sin(lang);                                                                   
//#1294        fpnt.x=flt[ind].x+off.x;                                                                   
//#1295        fpnt.y=flt[ind].y+off.y;                                                                   
//#1296        lang=atan2(-dif.x,dif.y);                                                                   
//#1297        len/=2;                                                                   
//#1298        off.x=len*cos(lang);                                                                   
//#1299        off.y=len*sin(lang);                                                                   
//#1300        dpnt.x=fpnt.x+off.x;                                                                   
//#1301        dpnt.y=fpnt.y+off.y;                                                                   
//#1302        stch2pxr(dpnt);                                                                   
//#1303        sqlin[0].x=sqlin[3].x=pPnt.x;                                                                   
//#1304        sqlin[0].y=sqlin[3].y=pPnt.y;                                                                   
//#1305        dpnt.x=fpnt.x-off.x;                                                                   
//#1306        dpnt.y=fpnt.y-off.y;                                                                   
//#1307        stch2pxr(dpnt);                                                                   
//#1308        sqlin[2].x=pPnt.x;                                                                   
//#1309        sqlin[2].y=pPnt.y;                                                                   
//#1310        Polyline(sdc,sqlin,4);                                                                   
//#1311    }                                                                       
//#1312                                                                           
//#1313    void selsqr(POINT cpnt,HDC dc){                                                                       
//#1314                                                                           
//#1315        POINT    sqlin[5];                                                               
//#1316                                                                           
//#1317        sqlin[0].x=sqlin[3].x=sqlin[4].x=cpnt.x-ini.frmpix;                                                                   
//#1318        sqlin[0].y=sqlin[1].y=cpnt.y-ini.frmpix;                                                                   
//#1319        sqlin[1].x=sqlin[2].x=cpnt.x+ini.frmpix;                                                                   
//#1320        sqlin[2].y=sqlin[3].y=cpnt.y+ini.frmpix;                                                                   
//#1321        sqlin[4].y=cpnt.y-ini.frmpix;                                                                   
//#1322        Polyline(dc,sqlin,5);                                                                   
//#1323    }                                                                       
//#1324                                                                           
//#1325    void frmsqr0(POINT cpnt){                                                                       
//#1326                                                                           
//#1327        POINT        sqlin[5];                                                           
//#1328        unsigned    pix;                                                               
//#1329                                                                           
//#1330        pix=ini.frmbpix;                                                                   
//#1331        if(pix)                                                                   
//#1332        {                                                                   
//#1333            sqlin[0].x=sqlin[3].x=sqlin[4].x=cpnt.x-pix;                                                               
//#1334            sqlin[0].y=sqlin[1].y=cpnt.y-pix;                                                               
//#1335            sqlin[1].x=sqlin[2].x=cpnt.x+pix+1;                                                               
//#1336            sqlin[2].y=sqlin[3].y=cpnt.y+pix+1;                                                               
//#1337            sqlin[4].y=cpnt.y-1;                                                               
//#1338            Polyline(sdc,sqlin,5);                                                               
//#1339        }                                                                   
//#1340    }                                                                       
//#1341                                                                           
//#1342    void frmx(POINT cpnt,HDC dc){                                                                       
//#1343                                                                           
//#1344        POINT    xlin[2];                                                               
//#1345                                                                           
//#1346        SelectObject(dc,fsPen);                                                                   
//#1347        xlin[0].x=xlin[1].x=cpnt.x;                                                                   
//#1348        xlin[0].y=cpnt.y+8;                                                                   
//#1349        xlin[1].y=cpnt.y-8;                                                                   
//#1350        Polyline(dc,xlin,2);                                                                   
//#1351        xlin[0].y=xlin[1].y=cpnt.y;                                                                   
//#1352        xlin[0].x=cpnt.x-8;                                                                   
//#1353        xlin[1].x=cpnt.x+8;                                                                   
//#1354        Polyline(dc,xlin,2);                                                                   
//#1355        SelectObject(dc,fPen);                                                                   
//#1356    }                                                                       
//#1357                                                                           
//#1358    void ratsr(){                                                                       
//#1359                                                                           
//#1360        if(chkMap(ZUMED)){                                                                   
//#1361                                                                           
//#1362            hfrat=(double)scRct.right/(zRct.right-zRct.left);                                                               
//#1363            vfrat=(double)scRct.bottom/(zRct.top-zRct.bottom);                                                               
//#1364        }                                                                   
//#1365        else{                                                                   
//#1366                                                                           
//#1367            hfrat=(double)scRct.right/zum0.x;                                                               
//#1368            vfrat=(double)scRct.bottom/zum0.y;                                                               
//#1369        }                                                                   
//#1370    }                                                                       
//#1371                                                                           
//#1372    float midl(float hi,float lo){                                                                       
//#1373                                                                           
//#1374        return (hi-lo)/2+lo;                                                                   
//#1375    }                                                                       
//#1376                                                                           
//#1377    void fvars(unsigned ind){
//#1378                                                                           
//#1379        frmpnt=&formlst[ind];                                                                   
//#1380        flt=formlst[ind].flt;                                                                   
//#1381        sids=formlst[ind].sids;                                                                   
//#1382        sac=formlst[ind].sacang.sac;                                                                   
//#1383        stpt=formlst[ind].stpt;                                                                   
//#1384        wpar=formlst[ind].wpar;                                                                   
//#1385        clp=formlst[ind].clp;                                                                   
//#1386        nclp=formlst[ind].nclp;                                                                   
//#1387    }                                                                       
//#1388                                                                           
//#1389    void ritfrct(unsigned ind,HDC dc){                                                                       
//#1390                                                                           
//#1391        unsigned    ine;                                                               
//#1392        POINT        sqrlin[10];                                                           
//#1393        FLRCT*        trct;                                                           
//#1394        FLPNT        rlin[10];                                                           
//#1395                                                                           
//#1396        ratsr();                                                                   
//#1397        SelectObject(rsdc,fPen);                                                                   
//#1398        SetROP2(rsdc,R2_XORPEN);                                                                   
//#1399        getfinfo(ind);                                                                   
//#1400        trct=&formlst[ind].rct;                                                                   
//#1401        SelectObject(dc,fsPen);                                                                   
//#1402        rlin[0].x=rlin[6].x=rlin[7].x=rlin[8].x=trct->left;                                                                   
//#1403        rlin[1].x=rlin[5].x=midl(trct->right,trct->left);                                                                   
//#1404        rlin[0].y=rlin[1].y=rlin[2].y=rlin[8].y=trct->top;                                                                   
//#1405        rlin[3].y=rlin[7].y=midl(trct->top,trct->bottom);                                                                   
//#1406        rlin[4].y=rlin[5].y=rlin[6].y=trct->bottom;                                                                   
//#1407        rlin[2].x=rlin[3].x=rlin[4].x=trct->right;                                                                   
//#1408        for(ind=0;ind<8;ind++)                                                                   
//#1409            sfCor2px(rlin[ind],&sqrlin[ind]);                                                               
//#1410        sfCor2px(rlin[0],&sqrlin[ind]);                                                                   
//#1411        Polyline(dc,sqrlin,9);                                                                   
//#1412        for(ine=0;ine<8;ine++)                                                                   
//#1413            selsqr(sqrlin[ine],dc);                                                               
//#1414        SetROP2(rsdc,R2_COPYPEN);                                                                   
//#1415        if(rstMap(GRPSEL)){                                                                   
//#1416                                                                           
//#1417            rstMap(SELSHO);                                                               
//#1418            slpnt=0;                                                               
//#1419            setMap(RESTCH);                                                               
//#1420        }                                                                   
//#1421    }                                                                       
//#1422                                                                           
//#1423    void delfrms(){                                                                       
//#1424                                                                           
//#1425        unsigned ind;                                                                   
//#1426                                                                           
//#1427        savdo();                                                                   
//#1428        formpnt=fltad=satkad=clpad=0;                                                                   
//#1429        for(ind=0;ind<hed.stchs;ind++)                                                                   
//#1430        {                                                                   
//#1431            stchs[ind].at&=NFRM_NTYP;                                                               
//#1432            stchs[ind].at|=NOTFRM;                                                               
//#1433        }                                                                   
//#1434    }                                                                       
//#1435                                                                           
//#1436    void fselrct(unsigned fpnt){                                                                       
//#1437                                                                           
//#1438        FRMHED*        tpnt=&formlst[fpnt];                                                           
//#1439        FLPNT        tlin[5];                                                           
//#1440        POINT        sqrlin[5];                                                           
//#1441        unsigned    ind;                                                               
//#1442                                                                           
//#1443        tlin[0].x=tlin[3].x=tlin[4].x=tpnt->rct.left;                                                                   
//#1444        tlin[1].x=tlin[2].x=tpnt->rct.right;                                                                   
//#1445        tlin[0].y=tlin[1].y=tlin[4].y=tpnt->rct.top;                                                                   
//#1446        tlin[2].y=tlin[3].y=tpnt->rct.bottom;                                                                   
//#1447        for(ind=0;ind<5;ind++){                                                                   
//#1448                                                                           
//#1449            sqrlin[ind].x=(tlin[ind].x-zRct.left)*hfrat;                                                               
//#1450            sqrlin[ind].y=(zRct.top-tlin[ind].y)*vfrat;                                                               
//#1451            if(sqrlin[ind].x<bigrct.left)                                                               
//#1452                bigrct.left=sqrlin[ind].x;                                                           
//#1453            if(sqrlin[ind].x>bigrct.right)                                                               
//#1454                bigrct.right=sqrlin[ind].x;                                                           
//#1455            if(sqrlin[ind].y<bigrct.top)                                                               
//#1456                bigrct.top=sqrlin[ind].y;                                                           
//#1457            if(sqrlin[ind].y>bigrct.bottom)                                                               
//#1458                bigrct.bottom=sqrlin[ind].y;                                                           
//#1459        }                                                                   
//#1460        sqrlin[5].x=(tlin[0].x-zRct.left)*hfrat;                                                                   
//#1461        sqrlin[5].y=(zRct.top-tlin[0].y)*vfrat;                                                                   
//#1462        if(sqrlin[5].x<bigrct.left)                                                                   
//#1463            bigrct.left=sqrlin[5].x;                                                               
//#1464        if(sqrlin[5].x>bigrct.right)                                                                   
//#1465            bigrct.right=sqrlin[5].x;                                                               
//#1466        if(sqrlin[5].y<bigrct.top)                                                                   
//#1467            bigrct.top=sqrlin[5].y;                                                               
//#1468        if(sqrlin[5].y>bigrct.bottom)                                                                   
//#1469            bigrct.bottom=sqrlin[5].y;                                                               
//#1470        Polyline(sdc,sqrlin,5);                                                                   
//#1471    }                                                                       
//#1472                                                                           
//#1473    void rct2sel(RECT rct,POINT* lin){                                                                       
//#1474                                                                           
//#1475        lin[0].x=lin[6].x=lin[7].x=lin[8].x=rct.left;                                                                   
//#1476        lin[1].x=lin[5].x=((rct.right-rct.left)>>1)+rct.left;                                                                   
//#1477        lin[2].x=lin[3].x=lin[4].x=rct.right;                                                                   
//#1478        lin[0].y=lin[1].y=lin[2].y=lin[8].y=rct.top;                                                                   
//#1479        lin[3].y=lin[7].y=((rct.bottom-rct.top)>>1)+rct.top;                                                                   
//#1480        lin[4].y=lin[5].y=lin[6].y=rct.bottom;                                                                   
//#1481    }                                                                       
//#1482                                                                           
//#1483    void dubig(){                                                                       
//#1484                                                                           
//#1485        unsigned ind;                                                                   
//#1486                                                                           
//#1487        rct2sel(bigrct,biglin);                                                                   
//#1488        SelectObject(sdc,alpen);                                                                   
//#1489        Polyline(sdc,biglin,9);                                                                   
//#1490        for(ind=0;ind<8;ind++)                                                                   
//#1491            selsqr(biglin[ind],sdc);                                                               
//#1492    }                                                                       
//#1493                                                                           
//#1494    void frmpoly(POINT* lin,unsigned cnt){                                                                       
//#1495                                                                           
//#1496        unsigned ind;                                                                   
//#1497                                                                           
//#1498        if(cnt){                                                                   
//#1499                                                                           
//#1500            for(ind=0;ind<cnt-1;ind++)                                                               
//#1501                Polyline(sdc,&lin[ind],2);                                                           
//#1502        }                                                                   
//#1503    }                                                                       
//#1504                                                                           
//#1505    void dupsel(HDC dc){                                                                       
//#1506                                                                           
//#1507        unsigned ind;                                                                   
//#1508                                                                           
//#1509        SelectObject(dc,fPen);                                                                   
//#1510        SetROP2(dc,R2_XORPEN);                                                                    
//#1511        Polyline(dc,pselin,9);                                                                   
//#1512        ind=pselrng.strt;                                                                   
//#1513        for(ind=0;ind<8;ind++)                                                                   
//#1514            selsqr(pselin[ind],dc);                                                               
//#1515        frmx(pselfin,dc);                                                                   
//#1516    }                                                                       
//#1517                                                                           
//#1518    void unpsel(){                                                                       
//#1519                                                                           
//#1520        if(rstMap(SHOPSEL))                                                                   
//#1521            dupsel(rsdc);                                                               
//#1522    }                                                                       
//#1523                                                                           
//#1524    void drwfrm(){                                                                       
//#1525                                                                           
//#1526        unsigned    ind,ine,inf,layr;                                                               
//#1527        POINT        lin[2];                                                           
//#1528        DUBPNT        tpnt;                                                           
//#1529                                                                           
//#1530        rstMap(SHOMOV);                                                                   
//#1531        rstMap(SHOPSEL);                                                                   
//#1532        lin[0].x=lin[0].y=lin[1].x=lin[1].y=0;                                                                   
//#1533        Polyline(sdc,lin,2);                                                                   
//#1534        SetROP2(sdc,R2_XORPEN);                                                                   
//#1535        ratsr();                                                                   
//#1536        duzrat();                                                                   
//#1537        for(ind=0;ind<formpnt;ind++){                                                                   
//#1538                                                                           
//#1539            fvars(ind);                                                               
//#1540            frmlin(frmpnt->flt,sids);                                                               
//#1541            inf=0;                                                               
//#1542            layr=((frmpnt->at&FRMLMSK)>>1);                                                               
//#1543            if(!actl||!layr||layr==actl){                                                               
//#1544                                                                           
//#1545                if(frmpnt->typ==SAT){                                                           
//#1546                                                                           
//#1547                    if(frmpnt->at&FRMEND){                                                       
//#1548                                                                           
//#1549                        SelectObject(sdc,fPen3);                                                   
//#1550                        Polyline(sdc,flin,2);                                                   
//#1551                        inf=1;                                                   
//#1552                    }                                                       
//#1553                    if(frmpnt->wpar){                                                       
//#1554                                                                           
//#1555                        SelectObject(sdc,fPen);                                                   
//#1556                        frmpoly(&flin[1],frmpnt->wpar);                                                   
//#1557                        SelectObject(sdc,fPen3);                                                   
//#1558                        Polyline(sdc,&flin[frmpnt->wpar],2);                                                   
//#1559                        SelectObject(sdc,ypen[layr]);                                                   
//#1560                        inf=frmpnt->wpar+1;                                                   
//#1561                    }                                                       
//#1562                    for(ine=0;ine<formlst[ind].stpt;ine++){                                                       
//#1563                                                                           
//#1564                        sfCor2px(flt[sac[ine].strt],&lin[0]);                                                   
//#1565                        sfCor2px(flt[sac[ine].fin],&lin[1]);                                                   
//#1566                        SelectObject(sdc,fPen);                                                   
//#1567                        Polyline(sdc,lin,2);                                                   
//#1568                    }                                                       
//#1569                }                                                           
//#1570                SelectObject(sdc,ypen[layr]);                                                           
//#1571                if(frmpnt->typ==LIN){                                                           
//#1572                                                                           
//#1573                    frmpoly(flin,sids);                                                       
//#1574                    if(frmpnt->ftyp==CONTF){                                                       
//#1575                                                                           
//#1576                        tpnt.x=flt[frmpnt->angclp.sat.strt].x;                                                   
//#1577                        tpnt.y=flt[frmpnt->angclp.sat.strt].y;                                                   
//#1578                        sCor2px(tpnt,&lin[0]);                                                   
//#1579                        tpnt.x=flt[frmpnt->angclp.sat.fin].x;                                                   
//#1580                        tpnt.y=flt[frmpnt->angclp.sat.fin].y;                                                   
//#1581                        sCor2px(tpnt,&lin[1]);                                                   
//#1582                        Polyline(sdc,lin,2);                                                   
//#1583                    }                                                       
//#1584                }                                                           
//#1585                else                                                           
//#1586                    frmpoly(&flin[inf],sids+1-inf);                                                       
//#1587                if(clofind==ind&&chkMap(FRMPSEL)){                                                           
//#1588                                                                           
//#1589                    for(ine=1;ine<sids;ine++){                                                       
//#1590                                                                           
//#1591                        if(ine==clofine)                                                   
//#1592                            frmx(flin[ine],sdc);                                               
//#1593                        else                                                   
//#1594                            frmsqr(ine);                                               
//#1595                    }                                                       
//#1596                    if(clofine)                                                       
//#1597                        frmsqr0(flin[0]);                                                   
//#1598                    else                                                       
//#1599                        frmx(flin[0],sdc);                                                   
//#1600                    ritnum(STR_NUMPNT,clofine);                                                       
//#1601                }                                                           
//#1602                else{                                                           
//#1603                                                                           
//#1604                    for(ine=1;ine<sids;ine++)                                                       
//#1605                        frmsqr(ine);                                                   
//#1606                    SelectObject(sdc,fsPen);                                                       
//#1607                    frmsqr0(flin[0]);                                                       
//#1608                }                                                           
//#1609                if(chkMap(FPSEL)&&clofind==ind){                                                           
//#1610                                                                           
//#1611                    sRct2px(pselrct,&pxselrct);                                                       
//#1612                    rct2sel(pxselrct,pselin);                                                       
//#1613                    setMap(SHOPSEL);                                                       
//#1614                    dupsel(sdc);                                                       
//#1615                }                                                           
//#1616            }                                                               
//#1617        }                                                                   
//#1618        if(fselpnt){                                                                   
//#1619                                                                           
//#1620            SelectObject(sdc,fmpen);                                                               
//#1621            ratsr();                                                               
//#1622            bigrct.top=bigrct.left=0x7fffffff;                                                               
//#1623            bigrct.bottom=bigrct.right=0;                                                               
//#1624            for(ind=0;ind<fselpnt;ind++)                                                               
//#1625                fselrct(selist[ind]);                                                           
//#1626            bigsiz.x=bigrct.right-bigrct.left;                                                               
//#1627            bigsiz.y=bigrct.bottom-bigrct.top;                                                               
//#1628            dubig();                                                               
//#1629        }                                                                   
//#1630        else{                                                                   
//#1631                                                                           
//#1632            if(chkMap(FORMSEL))                                                               
//#1633                ritfrct(clofind,sdc);                                                           
//#1634            if(chkMap(FRMPMOV)){                                                               
//#1635                                                                           
//#1636                ritmov();                                                           
//#1637                mvlin[1].x=msg.pt.x-stOrg.x;                                                           
//#1638                mvlin[1].y=msg.pt.y-stOrg.y;                                                           
//#1639                setMap(SHOMOV);                                                           
//#1640                ritmov();                                                           
//#1641            }                                                               
//#1642        }                                                                   
//#1643        SetROP2(sdc,R2_COPYPEN);                                                                   
//#1644    }                                                                       
//#1645                                                                           
//#1646    void setpoli(){                                                                       
//#1647                                                                           
//#1648        frmclr(&formlst[formpnt]);                                                                   
//#1649        formlst[formpnt].typ=POLI;                                                                   
//#1650        frmtyp=POLI;                                                                   
//#1651        formlst[formpnt].at=actl<<1;                                                                   
//#1652        formlst[formpnt].wind=ini.wind;                                                                   
//#1653        setMap(SATIN);                                                                   
//#1654        setMap(INIT);                                                                   
//#1655    }                                                                       
//#1656                                                                           
//#1657    void setlin(){                                                                       
//#1658                                                                           
//#1659        frmclr(&formlst[formpnt]);                                                                   
//#1660        formlst[formpnt].typ=LIN;                                                                   
//#1661        frmtyp=LIN;                                                                   
//#1662        formlst[formpnt].at=actl<<1;                                                                   
//#1663        setMap(SATIN);                                                                   
//#1664        setMap(INIT);                                                                   
//#1665    }                                                                       
//#1666                                                                           
//#1667    void setrpoli(){                                                                       
//#1668                                                                           
//#1669        unmsg();                                                                   
//#1670        pntmsg(IDS_REGP);                                                                   
//#1671        setMap(NUMIN);                                                                   
//#1672        setMap(ENTRPOL);                                                                   
//#1673        numWnd();                                                                   
//#1674    }                                                                       
//#1675                                                                           
//#1676    void setstar(){                                                                       
//#1677                                                                           
//#1678        unmsg();                                                                   
//#1679        pntmsg(IDS_STAR);                                                                   
//#1680        setMap(NUMIN);                                                                   
//#1681        setMap(ENTRSTAR);                                                                   
//#1682        numWnd();                                                                   
//#1683    }                                                                       
//#1684                                                                           
//#1685    void setspir(){                                                                       
//#1686                                                                           
//#1687        unmsg();                                                                   
//#1688        pntmsg(IDS_SPIR);                                                                   
//#1689        setMap(NUMIN);                                                                   
//#1690        setMap(ENTRSPIR);                                                                   
//#1691        numWnd();                                                                   
//#1692    }                                                                       
//#1693                                                                           
//#1694    void sethart(){                                                                       
//#1695                                                                           
//#1696        unmsg();                                                                   
//#1697        pntmsg(IDS_HEART);                                                                   
//#1698        setMap(NUMIN);                                                                   
//#1699        setMap(ENTRHART);                                                                   
//#1700        numWnd();                                                                   
//#1701    }                                                                       
//#1702                                                                           
//#1703    void setlens(){                                                                       
//#1704                                                                           
//#1705        unmsg();                                                                   
//#1706        pntmsg(IDS_LENS);                                                                   
//#1707        setMap(NUMIN);                                                                   
//#1708        setMap(ENTRLENS);                                                                   
//#1709        numWnd();                                                                   
//#1710    }                                                                       
//#1711                                                                           
//#1712    void seteg(){                                                                       
//#1713                                                                           
//#1714        unmsg();                                                                   
//#1715        pntmsg(IDS_EGG);                                                                   
//#1716        setMap(NUMIN);                                                                   
//#1717        setMap(ENTREG);                                                                   
//#1718        numWnd();                                                                   
//#1719    }                                                                       
//#1720                                                                           
//#1721    void setzig(){                                                                       
//#1722                                                                           
//#1723        unmsg();                                                                   
//#1724        pntmsg(IDS_ZIG);                                                                   
//#1725        setMap(NUMIN);                                                                   
//#1726        setMap(ENTRZIG);                                                                   
//#1727        numWnd();                                                                   
//#1728    }                                                                       
//#1729                                                                           
//#1730    BOOL CALLBACK tearprc(HWND hwndlg,UINT umsg,WPARAM wparam,LPARAM lparam){                                                                       
//#1731                                                                           
//#1732        TCHAR        buf[HBUFSIZ];                                                           
//#1733                                                                           
//#1734        switch(umsg){                                                                   
//#1735                                                                           
//#1736        case WM_INITDIALOG:                                                                   
//#1737                                                                           
//#1738            SendMessage(hwndlg,WM_SETFOCUS,0,0);                                                               
//#1739    reinit:;                                                                       
//#1740            sprintf(buf,"%d",ini.nsids);                                                               
//#1741            SetWindowText(GetDlgItem(hwndlg,IDC_TEARSIDS),buf);                                                               
//#1742            sprintf(buf,"%.3f",ini.tearat);                                                               
//#1743            SetWindowText(GetDlgItem(hwndlg,IDC_TEARAT),buf);                                                               
//#1744            sprintf(buf,"%.3f",ini.twststp/PFGRAN);                                                               
//#1745            SetWindowText(GetDlgItem(hwndlg,IDC_TWSTSTP),buf);                                                               
//#1746            sprintf(buf,"%.3f",ini.twstrat);                                                               
//#1747            SetWindowText(GetDlgItem(hwndlg,IDC_TWSTRAT),buf);                                                               
//#1748            break;                                                               
//#1749                                                                           
//#1750        case WM_COMMAND:                                                                   
//#1751                                                                           
//#1752            switch(LOWORD(wparam)){                                                               
//#1753                                                                           
//#1754            case IDCANCEL:                                                               
//#1755                                                                           
//#1756                EndDialog(hwndlg,0);                                                            
//#1757                return TRUE;                                                           
//#1758                                                                           
//#1759            case IDOK:                                                               
//#1760                                                                           
//#1761                GetWindowText(GetDlgItem(hwndlg,IDC_TEARSIDS),buf,HBUFSIZ);                                                           
//#1762                ini.nsids=atoi(buf);                                                           
//#1763                GetWindowText(GetDlgItem(hwndlg,IDC_TEARAT),buf,HBUFSIZ);                                                           
//#1764                ini.tearat=atof(buf);                                                           
//#1765                GetWindowText(GetDlgItem(hwndlg,IDC_TWSTSTP),buf,HBUFSIZ);                                                           
//#1766                ini.twststp=atof(buf)*PFGRAN;                                                           
//#1767                GetWindowText(GetDlgItem(hwndlg,IDC_TWSTRAT),buf,HBUFSIZ);                                                           
//#1768                ini.twstrat=atof(buf);                                                           
//#1769                EndDialog(hwndlg,1);                                                           
//#1770                break;                                                           
//#1771                                                                           
//#1772            case IDC_DEFTEAR:                                                               
//#1773                                                                           
//#1774                ini.nsids=20;                                                           
//#1775                ini.tearat=(float)1.1;                                                           
//#1776                ini.twststp=(float)0.0;                                                           
//#1777                ini.twstrat=(float)1.6;                                                           
//#1778                goto reinit;                                                           
//#1779                                                                           
//#1780            case IDC_DEFPAIS:                                                               
//#1781                                                                           
//#1782                ini.nsids=24;                                                           
//#1783                ini.tearat=(float)1.15;                                                           
//#1784                ini.twststp=(float)0.3*PFGRAN;                                                           
//#1785                ini.twstrat=(float)1.8;                                                           
//#1786                goto reinit;                                                           
//#1787            }                                                               
//#1788        }                                                                   
//#1789        return 0;                                                                   
//#1790    }                                                                       
//#1791                                                                           
//#1792    void setear(){                                                                       
//#1793                                                                           
//#1794        unsigned    ind,cnt,rind,lind;                                                               
//#1795        double        mid;                                                           
//#1796        double        vpos;                                                           
//#1797        double        len;                                                           
//#1798        double        stp;                                                           
//#1799        double        hrat;                                                           
//#1800        double        vrat;                                                           
//#1801        float        xstp;                                                           
//#1802        FLPNT        siz;                                                           
//#1803                                                                           
//#1804        unmsg();                                                                   
//#1805        ind=DialogBox(hInst,MAKEINTRESOURCE(IDD_TEAR),hWnd,(DLGPROC)tearprc);                                                                   
//#1806        if(ind>0){                                                                   
//#1807                                                                           
//#1808            xstp=ini.twststp;                                                               
//#1809            durpoli(ini.nsids);                                                               
//#1810            fvars(formpnt);                                                               
//#1811            cnt=sids/4;                                                               
//#1812            mid=(flt[1].x-flt[0].x)/2+flt[0].x;                                                               
//#1813            len=flt[cnt].y-flt[0].y;                                                               
//#1814            stp=flt[cnt+1].y-flt[cnt].y;                                                               
//#1815            vpos=flt[cnt+1].y;                                                               
//#1816            lind=sids-cnt;                                                               
//#1817            rind=cnt+1;                                                               
//#1818            for(ind=0;ind<(unsigned)cnt;ind++){                                                               
//#1819                                                                           
//#1820                flt[rind].y=flt[lind].y=vpos;                                                           
//#1821                flt[rind].x+=xstp;                                                           
//#1822                flt[lind].x+=xstp;                                                           
//#1823                xstp*=ini.twstrat;                                                           
//#1824                vpos-=stp;                                                           
//#1825                stp*=ini.tearat;                                                           
//#1826                rind--;                                                           
//#1827                lind++;                                                           
//#1828            }                                                               
//#1829            flt[0].y=flt[1].y=vpos;                                                               
//#1830            flt[0].x+=xstp;                                                               
//#1831            flt[1].x+=xstp;                                                               
//#1832            vpos-=stp/2;                                                               
//#1833            flt[sids].x=flt[0].x;                                                               
//#1834            flt[sids].y=flt[0].y;                                                               
//#1835            if(xstp)                                                               
//#1836                flt[0].x=flt[1].x+xstp/4;                                                           
//#1837            else                                                               
//#1838                flt[0].x=mid;                                                           
//#1839            flt[0].y=vpos;                                                               
//#1840            frmpnt->sids++;                                                               
//#1841            nuflen++;                                                               
//#1842            fltad++;                                                               
//#1843            setMap(FORMSEL);                                                               
//#1844            fvars(formpnt);                                                               
//#1845            frmout(formpnt);                                                               
//#1846            flipv();                                                               
//#1847            rstMap(FORMSEL);                                                               
//#1848            siz.x=frmpnt->rct.right-frmpnt->rct.left;                                                               
//#1849            siz.y=frmpnt->rct.top-frmpnt->rct.bottom;                                                               
//#1850            hrat=zum0.x/4/siz.x;                                                               
//#1851            if(hrat>1)                                                               
//#1852                hrat=1;                                                           
//#1853            vrat=zum0.y/4/siz.y;                                                               
//#1854            if(vrat<hrat)                                                               
//#1855                hrat=vrat;                                                           
//#1856            if(hrat<1){                                                               
//#1857                                                                           
//#1858                for(ind=0;ind<sids;ind++){                                                           
//#1859                                                                           
//#1860                    flt[ind].x=(flt[ind].x-flt[0].x)*hrat+flt[0].x;                                                       
//#1861                    flt[ind].y=(flt[ind].y-flt[0].y)*hrat+flt[0].y;                                                       
//#1862                }                                                           
//#1863            }                                                               
//#1864            frmout(formpnt);                                                               
//#1865            for(ind=0;ind<sids;ind++){                                                               
//#1866                                                                           
//#1867                flt[ind].x-=frmpnt->rct.left;                                                           
//#1868                flt[ind].y-=frmpnt->rct.bottom;                                                           
//#1869            }                                                               
//#1870        }                                                                   
//#1871    }                                                                       
//#1872                                                                           
//#1873    void duform(unsigned ind){                                                                       
//#1874                                                                           
//#1875        frmclr(&formlst[formpnt]);                                                                   
//#1876        switch(ind+1){                                                                   
//#1877                                                                           
//#1878        case LIN:                                                                   
//#1879                                                                           
//#1880            setlin();                                                               
//#1881            break;                                                               
//#1882                                                                           
//#1883        case POLI:                                                                   
//#1884                                                                           
//#1885            setpoli();                                                               
//#1886            break;                                                               
//#1887                                                                           
//#1888        case RPOLI:                                                                   
//#1889                                                                           
//#1890            setrpoli();                                                               
//#1891            break;                                                               
//#1892                                                                           
//#1893        case STAR:                                                                   
//#1894                                                                           
//#1895            setstar();                                                               
//#1896            break;                                                               
//#1897                                                                           
//#1898        case SPIR:                                                                   
//#1899                                                                           
//#1900            setspir();                                                               
//#1901            break;                                                               
//#1902                                                                           
//#1903        case HART-1:                                                                   
//#1904                                                                           
//#1905            sethart();                                                               
//#1906            break;                                                               
//#1907                                                                           
//#1908        case LENS-1:                                                                   
//#1909                                                                           
//#1910            setlens();                                                               
//#1911            break;                                                               
//#1912                                                                           
//#1913        case EGG-1:                                                                   
//#1914                                                                           
//#1915            seteg();                                                               
//#1916            break;                                                               
//#1917                                                                           
//#1918        case TEAR-1:                                                                   
//#1919                                                                           
//#1920            setear();                                                               
//#1921            break;                                                               
//#1922                                                                           
//#1923        case ZIG-1:                                                                   
//#1924                                                                           
//#1925            setzig();                                                               
//#1926            break;                                                               
//#1927                                                                           
//#1928        case WAV-1:                                                                   
//#1929                                                                           
//#1930            wavfrm();                                                               
//#1931            break;                                                               
//#1932                                                                           
//#1933        case DASY-1:                                                                   
//#1934                                                                           
//#1935            dasyfrm();                                                               
//#1936            break;                                                               
//#1937        }                                                                   
//#1938    }                                                                       
//#1939                                                                           
//#1940    unsigned closfrm(){                                                                       
//#1941                                                                           
//#1942        unsigned    ind,ine,tind,tine,playcod,frmcod;                                                               
//#1943        FLPNT*        pdat;                                                           
//#1944        FLPNT        tpnt;                                                           
//#1945        POINT        stchpx;                                                           
//#1946        double        len,minlen=1e99;                                                           
//#1947                                                                           
//#1948        if(formpnt){                                                                   
//#1949                                                                           
//#1950            stchpx.x=msg.pt.x-stOrg.x;                                                               
//#1951            stchpx.y=msg.pt.y-stOrg.y;                                                               
//#1952            rats();                                                               
//#1953            tind=tine=0;                                                               
//#1954            px2stchf(stchpx,&tpnt);                                                               
//#1955            playcod=actl<<1;                                                               
//#1956            for(ind=0;ind<formpnt;ind++){                                                               
//#1957                                                                           
//#1958                if(chkMap(FRMSAM)&&ind==clofind)                                                           
//#1959                    continue;                                                       
//#1960                                                                           
//#1961                frmcod=formlst[ind].at&FRMLMSK;                                                           
//#1962                if(!actl||!frmcod||frmcod==playcod){                                                           
//#1963                                                                           
//#1964                    getfinfo(ind);                                                       
//#1965                    pdat=formlst[ind].flt;                                                       
//#1966                    for(ine=0;ine<finfo.sids;ine++){                                                       
//#1967                                                                           
//#1968                        len=hypot(tpnt.x-pdat[ine].x,tpnt.y-pdat[ine].y);                                                   
//#1969                        if(len<minlen&&len>=0){                                                   
//#1970                                                                           
//#1971                            minlen=len;                                               
//#1972                            tind=ind;                                               
//#1973                            tine=ine;                                               
//#1974                        }                                                   
//#1975                    }                                                       
//#1976                }                                                           
//#1977            }                                                               
//#1978            stch2pxr(formlst[tind].flt[tine]);                                                               
//#1979            minlen=hypot(pPnt.x-stchpx.x,pPnt.y-stchpx.y);                                                               
//#1980            if(minlen<CLOSENUF){                                                               
//#1981                                                                           
//#1982                clofind=tind;                                                           
//#1983                clofine=tine;                                                           
//#1984                fvars(clofind);                                                           
//#1985                setMap(RELAYR);                                                           
//#1986                return 1;                                                           
//#1987            }                                                               
//#1988            else                                                               
//#1989                return 0;                                                           
//#1990        }                                                                   
//#1991        else                                                                   
//#1992            return 0;                                                               
//#1993    }                                                                       
//#1994                                                                           
//#1995    void frmovlin(){                                                                       
//#1996                                                                           
//#1997        unsigned ind,ine;                                                                   
//#1998                                                                           
//#1999        fvars(clofind);                                                                   
//#2000        ratsr();                                                                   
//#2001        if(frmpnt->typ==LIN)                                                                   
//#2002            nuflen=frmpnt->sids;                                                               
//#2003        else                                                                   
//#2004            nuflen=frmpnt->sids+1;                                                               
//#2005        frmlin(frmpnt->flt,frmpnt->sids);                                                                   
//#2006        ine=prv(clofine);                                                                   
//#2007        for(ind=0;ind<3;ind++)                                                                   
//#2008        {                                                                   
//#2009            mvlin[ind].x=flin[ine].x;                                                               
//#2010            mvlin[ind].y=flin[ine].y;                                                               
//#2011            ine++;                                                               
//#2012        }                                                                   
//#2013        ritmov();                                                                   
//#2014    }                                                                       
//#2015                                                                           
//#2016    /*                                                                       
//#2017    void makspac(unsigned strt,unsigned cnt){                                                                       
//#2018                                                                           
//#2019        unsigned src,dst,tcnt;                                                                   
//#2020                                                                           
//#2021        if(!chkmax(hed.stchs,cnt)){                                                                   
//#2022                                                                           
//#2023            src=hed.stchs-1;                                                               
//#2024            dst=src+cnt;                                                               
//#2025            tcnt=hed.stchs-strt;                                                               
//#2026            while(tcnt&&dst<MAXFLT){                                                               
//#2027                                                                           
//#2028                stchs[dst].at=stchs[src].at;                                                           
//#2029                stchs[dst].x=stchs[src].x;                                                           
//#2030                stchs[dst--].y=stchs[src--].y;                                                           
//#2031                tcnt--;                                                           
//#2032            }                                                               
//#2033            hed.stchs+=cnt;                                                               
//#2034        }                                                                   
//#2035    }*/                                                                       
//#2036                                                                           
//#2037    void makspac(unsigned strt,unsigned cnt){                                                                       
//#2038                                                                           
//#2039        if(!chkmax(hed.stchs,cnt))                                                                   
//#2040        {                                                                   
//#2041            MoveMemory(&stchs[strt+cnt],&stchs[strt],sizeof(SHRTPNT)*(hed.stchs-strt));                                                               
//#2042            hed.stchs+=cnt;                                                               
//#2043        }                                                                   
//#2044    }                                                                       
//#2045                                                                           
//#2046    void rseq(unsigned strt,unsigned fin,unsigned ostrt,unsigned at){                                                                       
//#2047                                                                           
//#2048        while(strt<fin){                                                                   
//#2049                                                                           
//#2050            stchs[strt].at=at;                                                               
//#2051            stchs[strt].x=iseq[ostrt].x;                                                               
//#2052            stchs[strt++].y=iseq[ostrt++].y;                                                               
//#2053        }                                                                   
//#2054        ostrt--;                                                                   
//#2055        lastpnt.x=iseq[ostrt].x;                                                                   
//#2056        lastpnt.y=iseq[ostrt].y;                                                                   
//#2057    }                                                                       
//#2058                                                                           
//#2059    BOOL ritlin(FLPNT strt,FLPNT fin)                                                                       
//#2060    {                                                                       
//#2061        DUBPNT        dif,stp,pnt;                                                           
//#2062        double        len;                                                           
//#2063        unsigned    ine,cnt;                                                               
//#2064                                                                           
//#2065        dif.x=fin.x-strt.x;                                                                   
//#2066        dif.y=fin.y-strt.y;                                                                   
//#2067        len=hypot(dif.x,dif.y);                                                                   
//#2068        iseq[isind].x=strt.x;                                                                   
//#2069        iseq[isind++].y=strt.y;                                                                   
//#2070        if(len>maxs){                                                                   
//#2071                                                                           
//#2072            cnt=ceil(len/uslen);                                                               
//#2073            if(!cnt)                                                               
//#2074                cnt=1;                                                           
//#2075            while(len/cnt>maxs)                                                               
//#2076                cnt++;                                                           
//#2077            if(!chkmax(isind,cnt)){                                                               
//#2078                                                                           
//#2079                stp.x=dif.x/cnt;                                                           
//#2080                stp.y=dif.y/cnt;                                                           
//#2081                pnt.x=strt.x+stp.x;                                                           
//#2082                pnt.y=strt.y+stp.y;                                                           
//#2083                for(ine=0;ine<cnt-1;ine++){                                                           
//#2084                                                                           
//#2085                    if(isind&MAXMSK){                                                       
//#2086                                                                           
//#2087                        isind=MAXSEQ-2;                                                   
//#2088                        return 0;                                                   
//#2089                    }                                                       
//#2090                    iseq[isind].x=pnt.x;                                                       
//#2091                    iseq[isind++].y=pnt.y;                                                       
//#2092                    pnt.x+=stp.x;                                                       
//#2093                    pnt.y+=stp.y;                                                       
//#2094                }                                                           
//#2095            }                                                               
//#2096            else{                                                               
//#2097                                                                           
//#2098                seqpnt=MAXSEQ-2;                                                           
//#2099                return 0;                                                           
//#2100            }                                                               
//#2101        }                                                                   
//#2102        return 1;                                                                   
//#2103    }                                                                       
//#2104                                                                           
//#2105    BOOL minrng(unsigned strt,unsigned fin)                                                                       
//#2106    {                                                                       
//#2107    //    if(abs(fin-strt)<sids>>1||frmpnt->typ==LIN)                                                                   
//#2108        if ( abs( (int)(fin - strt) ) < (sids >> 1) || (frmpnt->typ == LIN ) ) // xiaoguang                                                                   
//#2109            return 0;                                                               
//#2110        else                                                                   
//#2111            return 1;                                                               
//#2112    }                                                                       
//#2113                                                                           
//#2114    unsigned closflt(float px,float py)                                                                       
//#2115    {                                                                       
//#2116        double        len,minlen;                                                           
//#2117        unsigned    ind,ine;                                                               
//#2118                                                                           
//#2119        minlen=1e99;                                                                   
//#2120        for(ind=0;ind<sids;ind++)                                                                   
//#2121        {                                                                   
//#2122            len=hypot(px-flt[ind].x,py-flt[ind].y);                                                               
//#2123            if(len<minlen)                                                               
//#2124            {                                                               
//#2125                ine=ind;                                                           
//#2126                minlen=len;                                                           
//#2127            }                                                               
//#2128        }                                                                   
//#2129        return ine;                                                                   
//#2130    }                                                                       
//#2131                                                                           
//#2132    void chkseq(BOOL brd){                                                                       
//#2133                                                                           
//#2134    #if BUGBAK                                                                       
//#2135                                                                           
//#2136        unsigned ind;                                                                   
//#2137                                                                           
//#2138        for(ind=0;ind<seqpnt;ind++)                                                                   
//#2139        {                                                                   
//#2140            iseq[ind].x=oseq[ind].x;                                                               
//#2141            iseq[ind].y=oseq[ind].y;                                                               
//#2142        }                                                                   
//#2143        isind=seqpnt;                                                                   
//#2144    #else                                                                       
//#2145                                                                           
//#2146        double        len;                                                           
//#2147        unsigned    ind,ine,bakind;                                                               
//#2148        float        mins;                                                           
//#2149                                                                           
//#2150        bakind=isind;                                                                   
//#2151        if(brd){                                                                   
//#2152                                                                           
//#2153            if(!frmpnt->emax)                                                               
//#2154                frmpnt->emax=ini.maxsiz;                                                           
//#2155            maxs=frmpnt->emax;                                                               
//#2156            if(frmpnt->etyp==EGCHNL||frmpnt->etyp==EGCHNH)                                                               
//#2157                uslen=9*PFGRAN;                                                           
//#2158            else                                                               
//#2159                uslen=frmpnt->elen;                                                           
//#2160            mins=frmpnt->emin;                                                               
//#2161        }                                                                   
//#2162        else{                                                                   
//#2163                                                                           
//#2164            if(!frmpnt->fmax)                                                               
//#2165                frmpnt->fmax=ini.maxsiz;                                                           
//#2166            maxs=frmpnt->fmax;                                                               
//#2167            if(isclp(clofind))                                                               
//#2168                uslen=maxs;                                                           
//#2169            else                                                               
//#2170                uslen=frmpnt->flencnt.flen;                                                           
//#2171            mins=frmpnt->fmin;                                                               
//#2172        }                                                                   
//#2173        if(uslen>maxs)                                                                   
//#2174            uslen=maxs;                                                               
//#2175        ine=0;                                                                   
//#2176        for(ind=0;ind<seqpnt-1;ind++)                                                                   
//#2177        {                                                                   
//#2178            if(!ritlin(oseq[ind],oseq[ind+1]))                                                               
//#2179                goto seqskp;                                                           
//#2180        }                                                                   
//#2181        iseq[isind].x=oseq[ind].x;                                                                   
//#2182        iseq[isind++].y=oseq[ind].y;                                                                   
//#2183    seqskp:;                                                                       
//#2184        if(!mins)                                                                   
//#2185            return;                                                               
//#2186        ine=bakind+1;                                                                   
//#2187        for(ind=bakind+1;ind<isind;ind++){                                                                   
//#2188                                                                           
//#2189            len=hypot(iseq[ind].x-iseq[ind-1].x,iseq[ind].y-iseq[ind-1].y);                                                               
//#2190            if(len>mins){                                                               
//#2191                                                                           
//#2192                iseq[ine].x=iseq[ind].x;                                                           
//#2193                iseq[ine].y=iseq[ind].y;                                                           
//#2194                ine++;                                                           
//#2195            }                                                               
//#2196        }                                                                   
//#2197        isind=ine;                                                                   
//#2198    #endif                                                                       
//#2199    }                                                                       
//#2200                                                                           
//#2201    void ritbrd(){                                                                       
//#2202                                                                           
//#2203        if(seqpnt)                                                                   
//#2204        {                                                                   
//#2205            isinds[isind2].ind=isind;                                                               
//#2206            isinds[isind2].seq=I_BRD;                                                               
//#2207            isinds[isind2].cod=TYPBRD;                                                               
//#2208            isinds[isind2].col=frmpnt->bcol&COLMSK;                                                               
//#2209            chkseq(1);                                                               
//#2210            isind2++;                                                               
//#2211        }                                                                   
//#2212    }                                                                       
//#2213                                                                           
//#2214    void ritapbrd(){                                                                       
//#2215                                                                           
//#2216        if(seqpnt)                                                                   
//#2217        {                                                                   
//#2218            isinds[isind2].ind=isind;                                                               
//#2219            isinds[isind2].seq=I_AP;                                                               
//#2220            isinds[isind2].cod=TYPMSK;                                                               
//#2221            isinds[isind2].col=frmpnt->bcol>>4;                                                               
//#2222            chkseq(1);                                                               
//#2223            isind2++;                                                               
//#2224        }                                                                   
//#2225    }                                                                       
//#2226                                                                           
//#2227    void ritfil(){                                                                       
//#2228                                                                           
//#2229        if(seqpnt)                                                                   
//#2230        {                                                                   
//#2231            isinds[isind2].ind=isind;                                                               
//#2232            isinds[isind2].seq=I_FIL;                                                               
//#2233            isinds[isind2].cod=TYPFRM;                                                               
//#2234            isinds[isind2].col=frmpnt->fcol;                                                               
//#2235            chkseq(0);                                                               
//#2236            isind2++;                                                               
//#2237        }                                                                   
//#2238    }                                                                       
//#2239                                                                           
//#2240    void okcan(){                                                                       
//#2241                                                                           
//#2242        GetClientRect(hMsg,&msgRct);                                                                   
//#2243                                                                           
//#2244        hok=CreateWindow(                                                                   
//#2245            STATIC,                                                               
//#2246            stab[STR_OKENT],                                                               
//#2247            SS_CENTER|WS_CHILD|WS_VISIBLE|WS_BORDER,                                                               
//#2248            5                                                               
//#2249            msgRct.bottom+15,                                                               
//#2250            buttonWid<<2,                                                               
//#2251            buttonHi,                                                               
//#2252            hStch,                                                               
//#2253            NULL,                                                               
//#2254            hInst,                                                               
//#2255            NULL);                                                               
//#2256                                                                           
//#2257        hcan=CreateWindow(                                                                   
//#2258            STATIC,                                                               
//#2259            stab[STR_CANCEL],                                                               
//#2260            SS_CENTER|WS_CHILD|WS_VISIBLE|WS_BORDER,                                                               
//#2261            buttonWid*5,                                                               
//#2262            msgRct.bottom+15,                                                               
//#2263            buttonWid3,                                                               
//#2264            buttonHi,                                                               
//#2265            hStch,                                                               
//#2266            NULL,                                                               
//#2267            hInst,                                                               
//#2268            NULL);                                                               
//#2269    }                                                                       
//#2270                                                                           
//#2271    void savdisc(){                                                                       
//#2272                                                                           
//#2273        TCHAR    buf[HBUFSIZ];                                                               
//#2274                                                                           
//#2275        sdmsg();                                                                   
//#2276        rstMap(BIGBOX);                                                                   
//#2277                                                                           
//#2278        GetClientRect(hMsg,&msgRct);                                                                   
//#2279                                                                           
//#2280        LoadString(hInst,IDS_SAV,buf,HBUFSIZ);                                                                   
//#2281        hok=CreateWindow(                                                                   
//#2282            STATIC,                                                               
//#2283            buf,                                                               
//#2284            SS_CENTER|WS_CHILD|WS_VISIBLE|WS_BORDER,                                                               
//#2285            5                                                               
//#2286            msgRct.bottom+15,                                                               
//#2287            buttonWid3,                                                               
//#2288            buttonHi,                                                               
//#2289            hStch,                                                               
//#2290            NULL,                                                               
//#2291            hInst,                                                               
//#2292            NULL);                                                               
//#2293                                                                           
//#2294        LoadString(hInst,IDS_DISC,buf,HBUFSIZ);                                                                   
//#2295        hdsc=CreateWindow(                                                                   
//#2296            STATIC,                                                               
//#2297            buf,                                                               
//#2298            SS_CENTER|WS_CHILD|WS_VISIBLE|WS_BORDER,                                                               
//#2299            buttonWid3+15,                                                               
//#2300            msgRct.bottom+15,                                                               
//#2301            buttonWid3,                                                               
//#2302            buttonHi,                                                               
//#2303            hStch,                                                               
//#2304            NULL,                                                               
//#2305            hInst,                                                               
//#2306            NULL);                                                               
//#2307                                                                           
//#2308        hcan=CreateWindow(                                                                   
//#2309            STATIC,                                                               
//#2310            stab[STR_CANCEL],                                                               
//#2311            SS_CENTER|WS_CHILD|WS_VISIBLE|WS_BORDER,                                                               
//#2312            2*buttonWid3+25,                                                               
//#2313            msgRct.bottom+15,                                                               
//#2314            buttonWid3,                                                               
//#2315            buttonHi,                                                               
//#2316            hStch,                                                               
//#2317            NULL,                                                               
//#2318            hInst,                                                               
//#2319            NULL);                                                               
//#2320    }                                                                       
//#2321                                                                           
//#2322    BOOL lastch(){                                                                       
//#2323                                                                           
//#2324        if(isind)                                                                   
//#2325        {                                                                   
//#2326            lastpnt.x=iseq[isind-1].x;                                                               
//#2327            lastpnt.y=iseq[isind-1].y;                                                               
//#2328            return 1;                                                               
//#2329        }                                                                   
//#2330        else                                                                   
//#2331            return 0;                                                               
//#2332                                                                           
//#2333    /*    unsigned    ind,at;                                                               
//#2334                                                                           
//#2335        ind=0xffffffff;                                                                   
//#2336        if(frmpnt->typ!=LIN&&frmpnt->ftyp){                                                                   
//#2337                                                                           
//#2338            at=TYPATMSK|(clofind<<FRMSHFT);                                                               
//#2339            for(ind=hed.stchs-1;ind<hed.stchs;ind--){                                                               
//#2340                                                                           
//#2341                if((stchs[ind].at&LASTMSK)==at){                                                           
//#2342                                                                           
//#2343                    lastpnt.x=stchs[ind].x;                                                       
//#2344                    lastpnt.y=stchs[ind].y;                                                       
//#2345                    return 1;                                                       
//#2346                }                                                           
//#2347            }                                                               
//#2348        }                                                                   
//#2349        lastpnt.x=flt[0].x;                                                                   
//#2350        lastpnt.y=flt[0].y;                                                                   
//#2351        return 0;*/                                                                   
//#2352    }                                                                       
//#2353                                                                           
//#2354    unsigned getlast(){                                                                       
//#2355                                                                           
//#2356        unsigned        ind;                                                           
//#2357        unsigned        tclos=0;                                                           
//#2358        double            len,dx,dy,min=1e99;                                                       
//#2359                                                                           
//#2360        if(frmpnt->ftyp){                                                                   
//#2361                                                                           
//#2362            lastch();                                                               
//#2363            for(ind=0;ind<sids;ind++){                                                               
//#2364                                                                           
//#2365                dx=lastpnt.x-flt[ind].x;                                                           
//#2366                dy=lastpnt.y-flt[ind].y;                                                           
//#2367                len=hypot(dx,dy);                                                           
//#2368                if(len<min){                                                           
//#2369                                                                           
//#2370                    min=len;                                                       
//#2371                    tclos=ind;                                                       
//#2372                }                                                           
//#2373            }                                                               
//#2374            return tclos;                                                               
//#2375        }                                                                   
//#2376        else                                                                   
//#2377            return 0;                                                               
//#2378    }                                                                       
//#2379                                                                           
//#2380    void flt2dub(FLPNT ipnt,DUBPNT* opnt){                                                                       
//#2381                                                                           
//#2382        opnt->x=ipnt.x;                                                                   
//#2383        opnt->y=ipnt.y;                                                                   
//#2384    }                                                                       
//#2385                                                                           
//#2386    void linrutf(unsigned strt){                                                                       
//#2387                                                                           
//#2388        double        tspac;                                                           
//#2389        unsigned    ind;                                                               
//#2390        DUBPNT        tpnt;                                                           
//#2391                                                                           
//#2392        tspac=stspace;                                                                   
//#2393        sPnt.x=flt[strt].x;                                                                   
//#2394        sPnt.y=flt[strt].y;                                                                   
//#2395        for(ind=strt-1;ind<sids;ind--){                                                                   
//#2396                                                                           
//#2397            flt2dub(flt[ind],&tpnt);                                                               
//#2398            filinsb(tpnt);                                                               
//#2399        }                                                                   
//#2400        stspace=tspac;                                                                   
//#2401    }                                                                       
//#2402                                                                           
//#2403    void linrutb(unsigned strt){                                                                       
//#2404                                                                           
//#2405        double        tspac;                                                           
//#2406        unsigned    ind;                                                               
//#2407        DUBPNT        tpnt;                                                           
//#2408                                                                           
//#2409        tspac=stspace;                                                                   
//#2410        sPnt.x=flt[strt].x;                                                                   
//#2411        sPnt.y=flt[strt].y;                                                                   
//#2412        for(ind=strt+1;ind<sids;ind++){                                                                   
//#2413                                                                           
//#2414            flt2dub(flt[ind],&tpnt);                                                               
//#2415            filinsb(tpnt);                                                               
//#2416        }                                                                   
//#2417        flt2dub(flt[0],&tpnt);                                                                   
//#2418        filinsb(tpnt);                                                                   
//#2419        stspace=tspac;                                                                   
//#2420    }                                                                       
//#2421                                                                           
//#2422    void oclp(FLPNT* clp,unsigned nclp){
//#2423                                                                           
//#2424        unsigned    ind;                                                               
//#2425                                                                           
//#2426        if(!chkMap(NOCLP))                                                                   
//#2427        {                                                                   
//#2428            for(ind=0;ind<nclp;ind++){                                                               
//#2429                                                                           
//#2430                clpnu[ind].x=clp[ind].x;                                                           
//#2431                clpnu[ind].y=clp[ind].y;                                                           
//#2432            }                                                               
//#2433            clprct.left=clprct.right=clpnu[0].x;                                                               
//#2434            clprct.bottom=clprct.top=clpnu[0].y;                                                               
//#2435            for(ind=1;ind<(unsigned)nclp;ind++){                                                               
//#2436                                                                           
//#2437                if(clpnu[ind].x<clprct.left)                                                           
//#2438                    clprct.left=clpnu[ind].x;                                                       
//#2439                if(clpnu[ind].x>clprct.right)                                                           
//#2440                    clprct.right=clpnu[ind].x;                                                       
//#2441                if(clpnu[ind].y<clprct.bottom)                                                           
//#2442                    clprct.bottom=clpnu[ind].y;                                                       
//#2443                if(clpnu[ind].y>clprct.top)                                                           
//#2444                    clprct.top=clpnu[ind].y;                                                       
//#2445            }                                                               
//#2446            clpsiz.cx=clprct.right-clprct.left;                                                               
//#2447            clpsiz.cy=clprct.top-clprct.bottom;                                                               
//#2448            clplen=nclp;                                                               
//#2449        }                                                                   
//#2450    }                                                                       
//#2451                                                                           
//#2452    float getblen(){                                                                       
//#2453                                                                           
//#2454        float        len;                                                           
//#2455        unsigned    tlen;                                                               
//#2456                                                                           
//#2457        tlen=(formlst[clofind].nclp<<16)|formlst[clofind].res;                                                                   
//#2458                                                                           
//#2459        _asm{                                                                   
//#2460                                                                           
//#2461                mov        eax,tlen                                                   
//#2462                mov        len,eax                                                   
//#2463        }                                                                   
//#2464        return len;                                                                   
//#2465    }                                                                       
//#2466                                                                           
//#2467    void savblen(float len){                                                                       
//#2468                                                                           
//#2469        unsigned short nclp;                                                                   
//#2470        unsigned short res;                                                                   
//#2471                                                                           
//#2472        _asm{                                                                   
//#2473                                                                           
//#2474                mov        eax,len                                                   
//#2475                mov        res,ax                                                   
//#2476                shr        eax,16                                                   
//#2477                mov        nclp,ax                                                   
//#2478        }                                                                   
//#2479        formlst[clofind].nclp=nclp;                                                                   
//#2480        formlst[clofind].res=res;                                                                   
//#2481    }                                                                       
//#2482                                                                           
//#2483    float getplen(){                                                                       
//#2484                                                                           
//#2485        unsigned num=frmpnt->res;                                                                   
//#2486                                                                           
//#2487        return((float)(num>>8)+(num&0xff)/256);                                                                   
//#2488    }                                                                       
//#2489                                                                           
//#2490    void savplen(float len){                                                                       
//#2491                                                                           
//#2492        unsigned    num,fr;                                                               
//#2493        double        fnum,frf;                                                           
//#2494                                                                           
//#2495        if(len>255)                                                                   
//#2496            len=255;                                                               
//#2497        frf=modf(len,&fnum);                                                                   
//#2498        fr=(unsigned)floor(frf*256);                                                                   
//#2499        num=fnum;                                                                   
//#2500        formlst[clofind].res=(unsigned short)(num<<8)|fr;                                                                   
//#2501    }                                                                       
//#2502                                                                           
//#2503    void chkbrd(){                                                                       
//#2504                                                                           
//#2505        float    tlen;                                                               
//#2506                                                                           
//#2507        fvars(clofind);                                                                   
//#2508        if(frmpnt->etyp){                                                                   
//#2509                                                                           
//#2510            lastflt=getlast();                                                               
//#2511            switch(frmpnt->etyp&NEGUND){                                                               
//#2512                                                                           
//#2513            case EGLIN:                                                               
//#2514                                                                           
//#2515                brdfil(frmpnt->elen);                                                           
//#2516                break;                                                           
//#2517                                                                           
//#2518            case EGBLD:                                                               
//#2519                                                                           
//#2520                bold(frmpnt->elen);                                                           
//#2521                break;                                                           
//#2522                                                                           
//#2523            case EGCLP:                                                               
//#2524                                                                           
//#2525                oclp(frmpnt->clp,frmpnt->nclp);                                                           
//#2526                clpbrd(getlast());                                                           
//#2527                break;                                                           
//#2528                                                                           
//#2529            case EGCLPX:                                                               
//#2530                                                                           
//#2531                oclp(frmpnt->clp,frmpnt->nclp);                                                           
//#2532                duxclp();                                                           
//#2533                break;                                                           
//#2534                                                                           
//#2535            case EGSAT:                                                               
//#2536                                                                           
//#2537                plen=frmpnt->esiz;                                                           
//#2538                sbrd();                                                           
//#2539                break;                                                           
//#2540                                                                           
//#2541            case EGPRP:                                                               
//#2542                                                                           
//#2543                plen=frmpnt->esiz;                                                           
//#2544                pbrd(frmpnt->espac);                                                           
//#2545                break;                                                           
//#2546                                                                           
//#2547            case EGAP:                                                               
//#2548                                                                           
//#2549                seqpnt=0;                                                           
//#2550                apbrd();                                                           
//#2551                ritapbrd();                                                           
//#2552                plen=frmpnt->esiz;                                                           
//#2553                sbrd();                                                           
//#2554                break;                                                           
//#2555                                                                           
//#2556            case EGHOL:                                                               
//#2557                                                                           
//#2558                plen=frmpnt->esiz*2;                                                           
//#2559                tlen=bfclen;                                                           
//#2560                bfclen=getblen();                                                           
//#2561                satout(20);                                                           
//#2562                bhbrd(frmpnt->espac);                                                           
//#2563                bfclen=tlen;                                                           
//#2564                break;                                                           
//#2565                                                                           
//#2566            case EGPIC:                                                               
//#2567                                                                           
//#2568                oclp(frmpnt->clp,frmpnt->nclp);                                                           
//#2569                clpic(0);                                                           
//#2570                break;                                                           
//#2571                                                                           
//#2572            case EGDUB:                                                               
//#2573                                                                           
//#2574                dubfn();                                                           
//#2575                break;                                                           
//#2576                                                                           
//#2577            case EGCHNL:                                                               
//#2578                                                                           
//#2579                setMap(LINCHN);                                                           
//#2580                chnfn();                                                           
//#2581                break;                                                           
//#2582                                                                           
//#2583            case EGCHNH:                                                               
//#2584                                                                           
//#2585                rstMap(LINCHN);                                                           
//#2586                chnfn();                                                           
//#2587                break;                                                           
//#2588            }                                                               
//#2589            ritbrd();                                                               
//#2590        }                                                                   
//#2591    }                                                                       
//#2592                                                                           
//#2593    void boldlin(unsigned strt,unsigned fin,double siz){                                                                       
//#2594                                                                           
//#2595        DUBPNT        dif,stp,pnt0,pnt1;                                                           
//#2596        double        len;                                                           
//#2597        unsigned    cnt;                                                               
//#2598                                                                           
//#2599        dif.x=flt[fin].x-flt[strt].x;                                                                   
//#2600        dif.y=flt[fin].y-flt[strt].y;                                                                   
//#2601        len=hypot(dif.x,dif.y);                                                                   
//#2602        cnt=len/siz;                                                                   
//#2603        if(cnt){                                                                   
//#2604                                                                           
//#2605            stp.x=dif.x/cnt;                                                               
//#2606            stp.y=dif.y/cnt;                                                               
//#2607            pnt0.x=flt[strt].x;                                                               
//#2608            pnt0.y=flt[strt].y;                                                               
//#2609            pnt1.x=pnt0.x+stp.x;                                                               
//#2610            pnt1.y=pnt0.y+stp.y;                                                               
//#2611            while(cnt){                                                               
//#2612                                                                           
//#2613                oseq[seqpnt].x=pnt1.x;                                                           
//#2614                oseq[seqpnt++].y=pnt1.y;                                                           
//#2615                oseq[seqpnt].x=pnt0.x;                                                           
//#2616                oseq[seqpnt++].y=pnt0.y;                                                           
//#2617                oseq[seqpnt].x=pnt1.x;                                                           
//#2618                oseq[seqpnt++].y=pnt1.y;                                                           
//#2619                pnt0.x+=stp.x;                                                           
//#2620                pnt0.y+=stp.y;                                                           
//#2621                pnt1.x+=stp.x;                                                           
//#2622                pnt1.y+=stp.y;                                                           
//#2623                cnt--;                                                           
//#2624            }                                                               
//#2625            oseq[seqpnt].x=flt[fin].x;                                                               
//#2626            oseq[seqpnt++].y=flt[fin].y;                                                               
//#2627        }                                                                   
//#2628        else{                                                                   
//#2629                                                                           
//#2630            oseq[seqpnt].x=flt[fin].x;                                                               
//#2631            oseq[seqpnt++].y=flt[fin].y;                                                               
//#2632            oseq[seqpnt].x=flt[strt].x;                                                               
//#2633            oseq[seqpnt++].y=flt[strt].y;                                                               
//#2634            oseq[seqpnt].x=flt[fin].x;                                                               
//#2635            oseq[seqpnt++].y=flt[fin].y;                                                               
//#2636        }                                                                   
//#2637    }                                                                       
//#2638                                                                           
//#2639    void bold(double siz){                                                                       
//#2640                                                                           
//#2641        unsigned        ind,ine=0;                                                           
//#2642        unsigned short    nlin,tlin;                                                               
//#2643        double            len;                                                       
//#2644                                                                           
//#2645        tlin=getlast();                                                                   
//#2646        seqpnt=0;                                                                   
//#2647        oseq[seqpnt].x=flt[tlin].x;                                                                   
//#2648        oseq[seqpnt++].y=flt[tlin].y;                                                                   
//#2649        for(ind=0;ind<(unsigned)sids-1;ind++){                                                                   
//#2650                                                                           
//#2651            nlin=nxt(tlin);                                                               
//#2652            boldlin(tlin,nlin,siz);                                                               
//#2653            tlin=nlin;                                                               
//#2654        }                                                                   
//#2655        if(frmpnt->typ!=LIN){                                                                   
//#2656                                                                           
//#2657            nlin=nxt(tlin);                                                               
//#2658            boldlin(tlin,nlin,siz);                                                               
//#2659        }                                                                   
//#2660        for(ind=0;ind<seqpnt-1;ind++){                                                                   
//#2661                                                                           
//#2662            len=hypot(oseq[ind+1].x-oseq[ind].x,oseq[ind+1].y-oseq[ind].y);                                                               
//#2663            if(len>TINY){                                                               
//#2664                                                                           
//#2665                oseq[ine].x=oseq[ind].x;                                                           
//#2666                oseq[ine++].y=oseq[ind].y;                                                           
//#2667            }                                                               
//#2668        }                                                                   
//#2669        oseq[ine].x=flt[nlin].x;                                                                   
//#2670        oseq[ine++].y=flt[nlin].y;                                                                   
//#2671        seqpnt=ine;                                                                   
//#2672    }                                                                       
//#2673
procedure refilfn(var frmpnt : TFRMHED);
//#2674    void refilfn(){
begin
//#2675
//#2676        double        tspac;                                                           
//#2677        double        tsiz=usesiz;
//#2678        float        tlen;                                                           
//#2679                                                                           
//#2680        rstMap(TXFIL);                                                                   
//#2681        fvars(clofind);                                                                   
//#2682        if(frmpnt->typ==LIN)                                                                   
//#2683            frmpnt->wind=0;                                                               
//#2684        savdo();                                                                   
//#2685        fdelstch();    //DELETE STITCH AND SET SOME VARIABLE TO READY FOR REFILL.                                                               
//#2686        setMap(WASREFIL);                                                                   
//#2687        delpnt=hed.stchs;                                                                   
//#2688        if(frmpnt->fspac<0.5&&!isclp(clofind))                                                                   
//#2689            frmpnt->fspac=0.5;                                                               
//#2690        if(frmpnt->espac<0.5)                                                                   
//#2691            frmpnt->espac=0.5;                                                               
//#2692        usesiz=frmpnt->flencnt.flen;                                                                   
//#2693        if(!chkMap(WASDO))                                                                   
//#2694            savdo();                                                               
//#2695        rstMap(WASDO);                                                                   
//#2696        if(frmpnt->xat&(AT_UND|AT_WALK)&&frmpnt->typ==LIN&&frmpnt->ftyp!=CONTF)                                                                   
//#2697            frmpnt->typ=POLI;                                                               
//#2698        isind=isind2=0;                                                                   
//#2699        rstMap(ISUND);
  case frmpnt.typ of
//#2700        switch(frmpnt->typ){
//#2701
    LIN :
      begin
//#2702        case LIN:                                                                   
//#2703                                                                           
//#2704            plen=frmpnt->esiz;                                                               
//#2705            switch(frmpnt->etyp&NEGUND){
        case frmpnt.etyp AND NEGUND of
//#2706
          EGLIN:
            begin
//#2707            case EGLIN:
//#2708
//#2709                lastflt=0;
//#2710                brdfil(frmpnt->elen);
//#2711                ritbrd();
//#2712                break;
//#2713
            end;                                                                 
//#2714            case EGBLD:                                                               
//#2715                                                                           
//#2716                lastflt=0;                                                           
//#2717                bold(frmpnt->elen);                                                           
//#2718                ritbrd();                                                           
//#2719                break;                                                           
//#2720                                                                           
//#2721            case EGCLP:                                                               
//#2722                                                                           
//#2723                oclp(frmpnt->clp,frmpnt->nclp);                                                           
//#2724                clpout();                                                           
//#2725                seqpnt=0;                                                           
//#2726                clpbrd(0);                                                           
//#2727                ritbrd();                                                           
//#2728                break;                                                           
//#2729                                                                           
//#2730            case EGSAT:                                                               
//#2731                                                                           
//#2732                rstMap(SAT1);                                                           
//#2733                slbrd();                                                           
//#2734                ritbrd();                                                           
//#2735                break;                                                           
//#2736                                                                           
//#2737            case EGPRP:                                                               
//#2738                                                                           
//#2739                if(frmpnt->sids>2){                                                           
//#2740                                                                           
//#2741                    rstMap(SAT1);                                                       
//#2742                    plbrd(frmpnt->espac);                                                       
//#2743                    ritbrd();                                                       
//#2744                }                                                           
//#2745                break;                                                           
//#2746                                                                           
//#2747            case EGAP:                                                               
//#2748                                                                           
//#2749                lapbrd();                                                           
//#2750                ritapbrd();                                                           
//#2751                rstMap(SAT1);                                                           
//#2752                slbrd();                                                           
//#2753                ritbrd();                                                           
//#2754                break;                                                           
//#2755                                                                           
//#2756            case EGHOL:                                                               
//#2757                                                                           
//#2758                plen=frmpnt->esiz*2;                                                           
//#2759                tlen=bfclen;                                                           
//#2760                bfclen=getblen();                                                           
//#2761                satout(20);                                                           
//#2762                blbrd(frmpnt->espac);                                                           
//#2763                bfclen=tlen;                                                           
//#2764                ritbrd();                                                           
//#2765                break;                                                           
//#2766                                                                           
//#2767            case EGPIC:                                                               
//#2768                                                                           
//#2769                oclp(frmpnt->clp,frmpnt->nclp);                                                           
//#2770                seqpnt=0;                                                           
//#2771                tlen=bfclen;                                                           
//#2772                bfclen=getplen();                                                           
//#2773                clpic(0);                                                           
//#2774                bfclen=tlen;                                                           
//#2775                ritbrd();                                                           
//#2776                break;                                                           
//#2777                                                                           
//#2778            case EGDUB:                                                               
//#2779                                                                           
//#2780                lastflt=0;                                                           
//#2781                dubfn();                                                           
//#2782                ritbrd();                                                           
//#2783                break;                                                           
//#2784                                                                           
//#2785            case EGCHNL:                                                               
//#2786                                                                           
//#2787                setMap(LINCHN);                                                           
//#2788                chnfn();                                                           
//#2789                ritbrd();                                                           
//#2790                break;                                                           
//#2791                                                                           
//#2792            case EGCHNH:                                                               
//#2793                                                                           
//#2794                rstMap(LINCHN);                                                           
//#2795                chnfn();                                                           
//#2796                ritbrd();                                                           
//#2797                break;                                                           
//#2798                                                                           
//#2799            case EGCLPX:                                                               
//#2800                                                                           
//#2801                oclp(frmpnt->clp,frmpnt->nclp);                                                           
//#2802                duxclp();                                                           
//#2803                ritbrd();                                                           
//#2804                break;                                                           
//#2805            }
        end;                                                               
//#2806            if(frmpnt->ftyp==CONTF&&frmpnt->at&FRECONT){                                                               
//#2807                                                                           
//#2808                contf();                                                           
//#2809                ritfil();                                                           
//#2810            }                                                               
//#2811            break;                                                               
//#2812
      end;

    POLI :
//#2813        case POLI:
      begin
//#2814
//#2815            chkcwlk();                                                               
//#2816            chkwlk();                                                               
//#2817            chkund();                                                               
//#2818            rstMap(ISUND);
        if frmpnt.ftyp <> 0 then
        begin
//#2819            if(frmpnt->ftyp){                                                               
//#2820
//#2821                tspac=stspace;                                                           
//#2822                stspace=frmpnt->fspac;                                                           
//#2823                switch((unsigned)frmpnt->ftyp){
          case frmpnt.ftyp of
//#2824
            VRTF:  fnvrt(frmpnt);
//#2825                case VRTF:                                                           
//#2826                                                                           
//#2827                    fnvrt();                                                       
//#2828                    lconflt=frmpnt->flt;                                                       
//#2829                    break;                                                       
//#2830                                                                           
//#2831                case HORF:                                                           
//#2832                                                                           
//#2833                    fnhor();                                                       
//#2834                    lconflt=angfrm.flt;                                                       
//#2835                    break;                                                       
//#2836                                                                           
//#2837                case ANGF:                                                           
//#2838                                                                           
//#2839                    ang=PI/2-frmpnt->angclp.fang;                                                       
//#2840                    filang();                                                       
//#2841                    lconflt=angfrm.flt;                                                       
//#2842                    break;                                                       
//#2843
            VCLPF : begin
//#2844                case VCLPF:
//#2845
                //oclp();
//#2846                    oclp(frmpnt->angclp.clp,frmpnt->flencnt.nclp);
//#2847                    setangf(0);
//#2848                    fvars(clofind);
//#2849                    clpcon();
//#2850                    goto skpfil;
              end;
//#2851
//#2852                case HCLPF:
//#2853
//#2854                    oclp(frmpnt->angclp.clp,frmpnt->flencnt.nclp);                                                       
//#2855                    horclpfn();                                                       
//#2856                    goto skpfil;                                                       
//#2857                                                                           
//#2858                case ANGCLPF:                                                           
//#2859                                                                           
//#2860                    oclp(frmpnt->angclp.clp,frmpnt->flencnt.nclp);                                                       
//#2861                    rstMap(ISUND);                                                       
//#2862                    angclpfn();                                                       
//#2863                    goto skpfil;                                                       
//#2864                                                                           
//#2865                case TXVRTF:                                                           
//#2866                                                                           
//#2867                    setangf(0);                                                       
//#2868                    setxt();                                                       
//#2869                    clpcon();                                                       
//#2870                    goto skpfil;                                                       
//#2871                                                                           
//#2872                case TXHORF:                                                           
//#2873                                                                           
//#2874                    setxt();                                                       
//#2875                    horclpfn();                                                       
//#2876                    goto skpfil;                                                       
//#2877                                                                           
//#2878                case TXANGF:                                                           
//#2879                                                                           
//#2880                    setxt();                                                       
//#2881                    rstMap(ISUND);                                                       
//#2882                    angclpfn();                                                       
//#2883                    goto skpfil;                                                       
//#2884                }
          end; //case frmpnt.ftyp

          lcon();
//#2885                lcon();                                                           
//#2886                bakseq();                                                           
//#2887                if(frmpnt->ftyp!=VRTF&&frmpnt->ftyp!=TXVRTF){                                                           
//#2888                                                                           
//#2889                    ang=-ang;                                                       
//#2890                    rotbak();                                                       
//#2891                }                                                           
//#2892    skpfil:;                                                                       
//#2893                ritfil();                                                           
//#2894                stspace=tspac;                                                           
//#2895            }
        end                                                              
//#2896            chkbrd();                                                               
//#2897            break;                                                               
//#2898
      end;

    SAT :
      begin
//#2899        case SAT:
//#2900                                                                           
//#2901            chkcwlk();                                                               
//#2902            chkwlk();                                                               
//#2903            chkund();                                                               
//#2904            rstMap(ISUND);                                                               
//#2905            switch(frmpnt->ftyp){                                                               
//#2906                                                                           
//#2907            case SATF:                                                               
//#2908                                                                           
//#2909                tspac=stspace;                                                           
//#2910                stspace=frmpnt->fspac;                                                           
//#2911                usesiz=frmpnt->flencnt.flen;                                                           
//#2912                satfil();                                                           
//#2913                stspace=tspac;                                                           
//#2914                ritfil();                                                           
//#2915                break;                                                           
//#2916                                                                           
//#2917            case CLPF:                                                               
//#2918                                                                           
//#2919                oclp(frmpnt->angclp.clp,frmpnt->flencnt.nclp);                                                           
//#2920                fmclp();                                                           
//#2921                ritfil();                                                           
//#2922                break;                                                           
//#2923                                                                           
//#2924            case FTHF:                                                               
//#2925                                                                           
//#2926                if(rstMap(FLPBLND))                                                           
//#2927                    frmpnt->xat^=AT_FTHBLND;                                                       
//#2928                setMap(CNV2FTH);                                                           
//#2929                fthrfn();                                                           
//#2930                fritfil();                                                           
//#2931                break;                                                           
//#2932            }
      end;                                                           
//#2933            chkbrd();                                                               
//#2934        }
    end;                                                                   
//#2935        usesiz=tsiz;                                                                   
//#2936        intlv();                                                                   
//#2937        ritot(hed.stchs);                                                                   
//#2938        setfchk();                                                                   
//#2939    }
end;                                                                    
//#2940                                                                           
//#2941    void refil(){                                                                       
//#2942                                                                           
//#2943        unsigned trg,ind,at;                                                                   
//#2944                                                                           
//#2945        if(!chku(WRNOF))                                                                   
//#2946        {                                                                   
//#2947            trg=(clofind<<FRMSHFT)|USMSK;                                                               
//#2948            for(ind=0;ind<hed.stchs;ind++){                                                               
//#2949                                                                           
//#2950                at=stchs[ind].at;                                                           
//#2951                if(!(at&NOTFRM)&&(at&(USMSK|FRMSK))==trg){                                                           
//#2952                                                                           
//#2953                    if(hfdat)                                                       
//#2954                        setMap(WASFRMFRM);                                                   
//#2955                    undat();                                                       
//#2956                    tabmsg(IDS_REFIL);                                                       
//#2957                    setMap(MOVMSG);                                                       
//#2958                    okcan();                                                       
//#2959                    return;                                                       
//#2960                }                                                           
//#2961            }                                                               
//#2962        }                                                                   
//#2963        refilfn();                                                                   
//#2964    }                                                                       
//#2965                                                                           
//#2966    void setfpnt(){                                                                       
//#2967                                                                           
//#2968        POINT        stchpx;                                                           
//#2969        FLPNT*        dpnt;                                                           
//#2970                                                                           
//#2971        unfrm();                                                                   
//#2972        fvars(clofind);                                                                   
//#2973        dpnt=&frmpnt->flt[0];                                                                   
//#2974        stchpx.x=msg.pt.x-stOrg.x;                                                                   
//#2975        stchpx.y=msg.pt.y-stOrg.y;                                                                   
//#2976        rats();                                                                   
//#2977        px2stchf(stchpx,&dpnt[clofine]);                                                                   
//#2978        frmout(clofind);                                                                   
//#2979        refil();                                                                   
//#2980        setMap(WASFPNT);                                                                   
//#2981        rstMap(SELBOX);                                                                   
//#2982        setMap(FRMPSEL);                                                                   
//#2983        ritfcor(&flt[clofine]);                                                                   
//#2984        setMap(RESTCH);                                                                   
//#2985    }                                                                       
//#2986                                                                           
//#2987    unsigned short nxt(unsigned short ind){                                                                       
//#2988                                                                           
//#2989        ind++;                                                                   
//#2990        if(ind>(unsigned)sids-1)                                                                   
//#2991            ind=0;                                                               
//#2992        return ind;                                                                   
//#2993    }                                                                       
//#2994                                                                           
//#2995    unsigned short prv(unsigned ind){                                                                       
//#2996                                                                           
//#2997        if(ind)                                                                   
//#2998            ind--;                                                               
//#2999        else                                                                   
//#3000            ind=sids-1;                                                               
//#3001        return ind;                                                                   
//#3002    }                                                                       
//#3003                                                                           
//#3004    unsigned proj(DUBPNT pnt,double slop,FLPNT pnt0,FLPNT pnt1,DUBPNT* ipnt){                                                                       
//#3005                                                                           
//#3006        DUBPNT    difl;                                                               
//#3007        double    slopl,con,conl,xmin,xmax,ymin,ymax,tdub;                                                               
//#3008                                                                           
//#3009        difl.x=pnt1.x-pnt0.x;                                                                   
//#3010        if(difl.x){                                                                   
//#3011                                                                           
//#3012            difl.y=pnt1.y-pnt0.y;                                                               
//#3013            slopl=difl.y/difl.x;                                                               
//#3014            conl=pnt0.y-slopl*pnt0.x;                                                               
//#3015            con=pnt.y-slop*pnt.x;                                                               
//#3016            ipnt->x=(conl-con)/(slop-slopl);                                                               
//#3017            ipnt->y=ipnt->x*slop+con;                                                               
//#3018        }                                                                   
//#3019        else{                                                                   
//#3020                                                                           
//#3021            ipnt->x=pnt0.x;                                                               
//#3022            con=pnt.y-slop*pnt.x;                                                               
//#3023            ipnt->y=ipnt->x*slop+con;                                                               
//#3024        }                                                                   
//#3025        xmin=pnt0.x;                                                                   
//#3026        xmax=pnt1.x;                                                                   
//#3027        if(xmin>xmax){                                                                   
//#3028                                                                           
//#3029            tdub=xmin;                                                               
//#3030            xmin=xmax;                                                               
//#3031            xmax=tdub;                                                               
//#3032        }                                                                   
//#3033        if(difl.y){                                                                   
//#3034                                                                           
//#3035            ymin=pnt0.y;                                                               
//#3036            ymax=pnt1.y;                                                               
//#3037            if(ymin>ymax){                                                               
//#3038                                                                           
//#3039                tdub=ymin;                                                           
//#3040                ymin=ymax;                                                           
//#3041                ymax=tdub;                                                           
//#3042            }                                                               
//#3043            if(ipnt->x<xmin||ipnt->x>xmax||ipnt->y<ymin||ipnt->y>ymax)                                                               
//#3044                return 0;                                                           
//#3045            else                                                               
//#3046                return 1;                                                           
//#3047        }                                                                   
//#3048        else{                                                                   
//#3049                                                                           
//#3050            if(ipnt->x<xmin||ipnt->x>xmax)                                                               
//#3051                return 0;                                                           
//#3052            else                                                               
//#3053                return 1;                                                           
//#3054        }                                                                   
//#3055    }                                                                       
//#3056


  //I think it is test wether pntx within pnt0.x ~ pnt1.X
  function projv(pntx : double; pnt0, pnt1 : TFloatPoint; var ipnt : TDoublePoint): boolean;
//#3057    unsigned projv(double pntx,FLPNT pnt0,FLPNT pnt1,DUBPNT* ipnt){                                                                       
//#3058
  var
    tdub, slop, dx : Double;
//#3059        double tdub,slop,dx;
//#3060
  begin
    ipnt.x := pntx;
    dx := pnt1.X - pnt0.X;         //distance
    if dx > 0 then
                                                //#3061        ipnt->x=pntx;
                                                //#3062        dx=pnt1.x-pnt0.x;
                                                //#3063        if(dx){
    begin
      slop := (pnt1.Y - pnt0.Y) / dx;
      ipnt.y := (pntx - pnt0.X) * slop + pnt0.Y;

      //swap x position
      if pnt0.X > pnt1.X then
      begin
                                                //#3065            slop=(pnt1.y-pnt0.y)/dx;
                                                //#3066            ipnt->y=(pntx-pnt0.x)*slop+pnt0.y;
                                                //#3067            if(pnt0.x>pnt1.x){
        tdub := pnt0.x;
        pnt0.X := pnt1.X;
        pnt1.X := tdub;
                                                //#3068                tdub=pnt0.x;
                                                //#3069                pnt0.x=pnt1.x;
                                                //#3070                pnt1.x=tdub;
                                                //#3071            }
      end;
      if (pntx < pnt0.X) or (pntx > pnt1.X) then
        result := false
      else
        result := true;
                                                //#3072            if(pntx<pnt0.x||pntx>pnt1.x)
                                                //#3073                return 0;
                                                //#3074            else
                                                //#3075                return 1;
                                                //#3076        }
    end
    else
      result := false;
                                                //#3077        else
                                                //#3078            return 0;
                                                //#3079    }
  end;
  
//#3080
//#3081    unsigned projh(double pnty,FLPNT pnt0,FLPNT pnt1,DUBPNT* ipnt){
//#3082
//#3083        double tdub,slop,dx,dy;                                                                   
//#3084                                                                           
//#3085        ipnt->y=pnty;                                                                   
//#3086        dx=pnt1.x-pnt0.x;                                                                   
//#3087        if(dx){                                                                   
//#3088                                                                           
//#3089            dy=pnt1.y-pnt0.y;                                                               
//#3090            if(dy){                                                               
//#3091                                                                           
//#3092                slop=dy/dx;                                                           
//#3093                ipnt->x=(pnty-pnt0.y)/slop+pnt0.x;                                                           
//#3094            }                                                               
//#3095            else                                                               
//#3096                return 0;                                                           
//#3097        }                                                                   
//#3098        else                                                                   
//#3099            ipnt->x=pnt0.x;                                                               
//#3100        if(pnt0.y>pnt1.y){                                                                   
//#3101            tdub=pnt0.y;                                                               
//#3102            pnt0.y=pnt1.y;                                                               
//#3103            pnt1.y=tdub;                                                               
//#3104        }                                                                   
//#3105        if(pnty<pnt0.y||pnty>pnt1.y)                                                                   
//#3106            return 0;                                                               
//#3107        else                                                                   
//#3108            return 1;                                                               
//#3109    }                                                                       
//#3110                                                                           
//#3111    void filang(){                                                                       
//#3112                                                                           
//#3113        unsigned    ind;                                                               
//#3114                                                                           
//#3115        frmcpy(&angfrm,&formlst[clofind]);                                                                   
//#3116        rotcntr.x=(double)(angfrm.rct.right-angfrm.rct.left)/2+angfrm.rct.left;                                                                   
//#3117        rotcntr.y=(double)(angfrm.rct.top-angfrm.rct.bottom)/2+angfrm.rct.bottom;                                                                   
//#3118        angfrm.flt=angflt;                                                                   
//#3119        for(ind=0;ind<angfrm.sids;ind++){                                                                   
//#3120                                                                           
//#3121            angfrm.flt[ind].x=frmpnt->flt[ind].x;                                                               
//#3122            angfrm.flt[ind].y=frmpnt->flt[ind].y;                                                               
//#3123            rotflt(&angfrm.flt[ind]);                                                               
//#3124        }                                                                   
//#3125        frmpnt=&angfrm;                                                                   
//#3126        fnvrt();                                                                   
//#3127        frmpnt=&formlst[clofind];                                                                   
//#3128    }                                                                       
//#3129                                                                           
//#3130    void makpoli(){                                                                       
//#3131                                                                           
//#3132        if(frmpnt->typ==SAT){                                                                   
//#3133                                                                           
//#3134            if(frmpnt->stpt)                                                               
//#3135                delsac(clofind);                                                           
//#3136        }                                                                   
//#3137        frmpnt->typ=POLI;                                                                   
//#3138    }                                                                       
//#3139                                                                           
//#3140    void filinu(float pntx,float pnty){                                                                       
//#3141                                                                           
//#3142        unsigned    cnt;                                                               
//#3143        double        len;                                                           
//#3144        DUBPNT        ipnt,stp,dif;                                                           
//#3145                                                                           
//#3146        ipnt.x=sPnt.x;                                                                   
//#3147        ipnt.y=sPnt.y;                                                                   
//#3148        dif.x=pntx-sPnt.x;                                                                   
//#3149        dif.y=pnty-sPnt.y;                                                                   
//#3150        len=hypot(dif.x,dif.y);                                                                   
//#3151        cnt=len/usesiz;                                                                   
//#3152        if(chkmax(cnt,seqpnt)||cnt+seqpnt>MAXSEQ-3)                                                                   
//#3153            return;                                                               
//#3154        if(cnt){                                                                   
//#3155                                                                           
//#3156            if(chkMap(FILDIR))                                                               
//#3157                cnt++;                                                           
//#3158            stp.x=dif.x/cnt;                                                               
//#3159            stp.y=dif.y/cnt;                                                               
//#3160            while(cnt>0){                                                               
//#3161                                                                           
//#3162                ipnt.x+=stp.x;                                                           
//#3163                ipnt.y+=stp.y;                                                           
//#3164                oseq[seqpnt].x=ipnt.x;                                                           
//#3165                oseq[seqpnt++].y=ipnt.y;                                                           
//#3166                cnt--;                                                           
//#3167            }                                                               
//#3168        }                                                                   
//#3169        else{                                                                   
//#3170                                                                           
//#3171            oseq[seqpnt].x=pntx;                                                               
//#3172            oseq[seqpnt++].y=pnty;                                                               
//#3173        }                                                                   
//#3174        sPnt.x=pntx;                                                                   
//#3175        sPnt.y=pnty;                                                                   
//#3176    }                                                                       
//#3177                                                                           
//#3178    void filin(DUBPNT pnt){                                                                       
//#3179                                                                           
//#3180        DUBPNT dif,stp,ipnt;                                                                   
//#3181        double len;                                                                   
//#3182        int cnt;                                                                   
//#3183                                                                           
//#3184        dif.x=pnt.x-sPnt.x;                                                                   
//#3185        dif.y=pnt.y-sPnt.y;                                                                   
//#3186        len=hypot(dif.x,dif.y);                                                                   
//#3187        ipnt.x=sPnt.x;                                                                   
//#3188        ipnt.y=sPnt.y;                                                                   
//#3189        cnt=len/usesiz;                                                                   
//#3190        if(chkmax(cnt,seqpnt)||(cnt+seqpnt)>MAXSEQ-3)                                                                   
//#3191            return;                                                               
//#3192        if(cnt){                                                                   
//#3193                                                                           
//#3194            if(chkMap(FILDIR))                                                               
//#3195                cnt++;                                                           
//#3196            stp.x=dif.x/cnt;                                                               
//#3197            stp.y=dif.y/cnt;                                                               
//#3198            while(cnt>0){                                                               
//#3199                                                                           
//#3200                ipnt.x+=stp.x;                                                           
//#3201                ipnt.y+=stp.y;                                                           
//#3202                oseq[seqpnt].x=ipnt.x;                                                           
//#3203                oseq[seqpnt++].y=ipnt.y;                                                           
//#3204                cnt--;                                                           
//#3205            }                                                               
//#3206        }                                                                   
//#3207        else{                                                                   
//#3208                                                                           
//#3209            oseq[seqpnt].x=pnt.x;                                                               
//#3210            oseq[seqpnt++].y=pnt.y;                                                               
//#3211        }                                                                   
//#3212        sPnt.x=pnt.x;                                                                   
//#3213        sPnt.y=pnt.y;                                                                   
//#3214    }                                                                       
//#3215                                                                           
//#3216    unsigned short isclos(SMALPNTL* pnt0,SMALPNTL* pnt1){                                                                       
//#3217                                                                           
//#3218        float        lo0,hi0,lo1,hi1;                                                           
//#3219                                                                           
//#3220        hi0=pnt0[1].y+rgclos;                                                                   
//#3221        lo0=pnt0[0].y-rgclos;                                                                   
//#3222        hi1=pnt1[1].y+rgclos;                                                                   
//#3223        lo1=pnt1[0].y-rgclos;                                                                   
//#3224        if(hi0<lo1)                                                                   
//#3225            return 0;                                                               
//#3226        if(hi1<lo0)                                                                   
//#3227            return 0;                                                               
//#3228        return 1;                                                                   
//#3229    }                                                                       
//#3230                                                                           
//#3231    BOOL lnclos(unsigned gp0,unsigned ln0,unsigned gp1,unsigned ln1){                                                                       
//#3232                                                                           
//#3233        unsigned    ind0,ind1,cnt0,cnt1;                                                               
//#3234        SMALPNTL*    pnt0;                                                               
//#3235        SMALPNTL*    pnt1;                                                               
//#3236                                                                           
//#3237        if(gp1>grindpnt-2)                                                                   
//#3238            return 0;                                                               
//#3239        if(!gp0)                                                                   
//#3240            return 0;                                                               
//#3241        cnt0=(grinds[gp0+1]-grinds[gp0])>>1;                                                                   
//#3242        ind0=0;                                                                   
//#3243        pnt0=&lins[grinds[gp0]];                                                                   
//#3244        while(cnt0&&pnt0[ind0].lin!=ln0){                                                                   
//#3245                                                                           
//#3246            cnt0--;                                                               
//#3247            ind0+=2;                                                               
//#3248        }                                                                   
//#3249        if(cnt0){                                                                   
//#3250                                                                           
//#3251            cnt1=(grinds[gp1+1]-grinds[gp1])>>1;                                                               
//#3252            ind1=0;                                                               
//#3253            pnt1=&lins[grinds[gp1]];                                                               
//#3254            while(cnt1&&pnt1[ind1].lin!=ln1){                                                               
//#3255                                                                           
//#3256                cnt1--;                                                           
//#3257                ind1+=2;                                                           
//#3258            }                                                               
//#3259            if(cnt1){                                                               
//#3260                                                                           
//#3261                if(isclos(&pnt0[ind0],&pnt1[ind1]))                                                           
//#3262                    return 1;                                                       
//#3263                else                                                           
//#3264                    return 0;                                                       
//#3265            }                                                               
//#3266        }                                                                   
//#3267        return 0;                                                                   
//#3268    }                                                                       
//#3269                                                                           
//#3270    unsigned short regclos(unsigned rg0,unsigned rg1){                                                                       
//#3271                                                                           
//#3272        SMALPNTL*    pnt0s;                                                               
//#3273        SMALPNTL*    pnt0e;                                                               
//#3274        SMALPNTL*    pnt1s;                                                               
//#3275        SMALPNTL*    pnt1e;                                                               
//#3276        unsigned     grp0s;                                                               
//#3277        unsigned     grp0e;                                                               
//#3278        unsigned     grp1s;                                                               
//#3279        unsigned     grp1e;                                                               
//#3280        unsigned    grps;                                                               
//#3281        unsigned    grpe;                                                               
//#3282        unsigned    lins,line;                                                               
//#3283        unsigned    prlin,polin;                                                               
//#3284                                                                           
//#3285        pnt0s=&*seq[rgns[rg0].strt];                                                                   
//#3286        pnt1s=&*seq[rgns[rg1].strt];                                                                   
//#3287        grp1s=pnt1s->grp;                                                                   
//#3288        grp0s=pnt0s->grp;                                                                   
//#3289        if(grp0s>grp1s){                                                                   
//#3290                                                                           
//#3291            grps=grp0s;                                                               
//#3292            lins=pnt0s->lin;                                                               
//#3293            prlin=pnt1s->lin;                                                               
//#3294        }                                                                   
//#3295        else{                                                                   
//#3296                                                                           
//#3297            grps=grp1s;                                                               
//#3298            lins=pnt1s->lin;                                                               
//#3299            prlin=pnt0s->lin;                                                               
//#3300        }                                                                   
//#3301        if(grps&&lnclos(grps-1,prlin,grps,lins)){                                                                   
//#3302                                                                           
//#3303            nxtgrp=grps;                                                               
//#3304            return 1;                                                               
//#3305        }                                                                   
//#3306        else{                                                                   
//#3307                                                                           
//#3308            pnt0e=&*seq[rgns[rg0].end];                                                               
//#3309            pnt1e=&*seq[rgns[rg1].end];                                                               
//#3310            grp1e=pnt1e->grp;                                                               
//#3311            grp0e=pnt0e->grp;                                                               
//#3312            if(grp0e<grp1e){                                                               
//#3313                                                                           
//#3314                grpe=grp0e;                                                           
//#3315                line=pnt0e->lin;                                                           
//#3316                polin=pnt1e->lin;                                                           
//#3317            }                                                               
//#3318            else{                                                               
//#3319                                                                           
//#3320                grpe=grp1e;                                                           
//#3321                line=pnt1e->lin;                                                           
//#3322                polin=pnt0e->lin;                                                           
//#3323            }                                                               
//#3324            if(lnclos(grpe,line,grpe+1,polin)){                                                               
//#3325                                                                           
//#3326                nxtgrp=grpe;                                                           
//#3327                return 1;                                                           
//#3328            }                                                               
//#3329        }                                                                   
//#3330    //    if(abs(grp0s-grp1s)<2){                                                                   
//#3331        if( abs( (int)(grp0s - grp1s) ) < 2 ){ // xiaoguang                                                                   
//#3332                                                                           
//#3333            if(isclos(pnt0s,pnt1s)){                                                               
//#3334                                                                           
//#3335                nxtgrp=grp0s;                                                           
//#3336                return 1;                                                           
//#3337            }                                                               
//#3338        }                                                                   
//#3339    //    if(abs(grp0s-grp1e)<2){                                                                   
//#3340        if( abs((int)(grp0s - grp1e)) < 2 ){ // xiaoguang                                                                       
//#3341                                                                           
//#3342            if(isclos(pnt0s,pnt1e)){                                                               
//#3343                                                                           
//#3344                nxtgrp=grp0s;                                                           
//#3345                return 1;                                                           
//#3346            }                                                               
//#3347        }                                                                   
//#3348    //    if(abs(grp0e-grp1s)<2){                                                                   
//#3349        if ( abs((int)(grp0e - grp1s)) < 2 ){ // xiaoguang                                                                   
//#3350                                                                           
//#3351            if(isclos(pnt0e,pnt1s)){                                                               
//#3352                                                                           
//#3353                nxtgrp=grp0e;                                                           
//#3354                return 1;                                                           
//#3355            }                                                               
//#3356        }                                                                   
//#3357    //    if(abs(grp0e-grp1e)<2){                                                                   
//#3358        if( abs((int)(grp0e - grp1e)) < 2 ){ // xiaoguang                                                                   
//#3359                                                                           
//#3360            if(isclos(pnt0e,pnt1e)){                                                               
//#3361                                                                           
//#3362                nxtgrp=grp0e;                                                           
//#3363                return 1;                                                           
//#3364            }                                                               
//#3365        }                                                                   
//#3366        return 0;                                                                   
//#3367    }                                                                       
//#3368                                                                           
//#3369    BOOL unvis(){                                                                       
//#3370                                                                           
//#3371        for(vispnt=0;vispnt<rgcnt;vispnt++){                                                                   
//#3372                                                                           
//#3373            if(!visit[vispnt])                                                               
//#3374                return 1;                                                           
//#3375        }                                                                   
//#3376        return 0;                                                                   
//#3377    }                                                                       
//#3378                                                                           
//#3379    unsigned setseq(unsigned bpnt){                                                                       
//#3380                                                                           
//#3381        _asm{                                                                   
//#3382                xor        eax,eax                                                   
//#3383                mov        ebx,seqmap                                                   
//#3384                mov        ecx,bpnt                                                   
//#3385                bts        [ebx],ecx                                                   
//#3386                jnc        short setseqx                                                   
//#3387                inc        eax                                                   
//#3388    setseqx:                                                                       
//#3389        }                                                                   
//#3390    }                                                                       
//#3391                                                                           
//#3392    void rspnt(float fx,float fy){                                                                       
//#3393                                                                           
//#3394        bseq[opnt].x=fx;                                                                   
//#3395        bseq[opnt].y=fy;                                                                   
//#3396        bseq[opnt++].attr=0;                                                                   
//#3397    }                                                                       
//#3398                                                                           
//#3399    void dunseq(unsigned strt,unsigned fin){                                                                       
//#3400                                                                           
//#3401        SMALPNTL*    lin0;                                                               
//#3402        SMALPNTL*    lin1;                                                               
//#3403        unsigned    ind;                                                               
//#3404        double        dy,miny;                                                           
//#3405                                                                           
//#3406        miny=1e30;                                                                   
//#3407        for(ind=strt;ind<=fin;ind++){                                                                   
//#3408                                                                           
//#3409            lin0=&*seq[ind];                                                               
//#3410            dy=lin0[1].y-lin0->y;                                                               
//#3411            if(dy<miny)                                                               
//#3412                miny=dy;                                                           
//#3413        }                                                                   
//#3414        miny/=2;                                                                   
//#3415        lin0=&*seq[strt];                                                                   
//#3416        lin1=&*seq[fin];                                                                   
//#3417        if(miny=1e30/2)                                                                   
//#3418            miny=0;                                                               
//#3419        rspnt(lin0->x,lin0->y+miny);                                                                   
//#3420        rspnt(lin1->x,lin1->y+miny);                                                                   
//#3421        lastgrp=lin1->grp;                                                                   
//#3422    }                                                                       
//#3423                                                                           
//#3424    void movseq(unsigned ind){                                                                       
//#3425                                                                           
//#3426        SMALPNTL* lin;                                                                   
//#3427                                                                           
//#3428        lin=&*seq[ind];                                                                   
//#3429        bseq[opnt].attr=SEQBOT;                                                                   
//#3430        bseq[opnt].x=lin->x;                                                                   
//#3431        bseq[opnt].y=lin->y;                                                                   
//#3432        opnt++;                                                                   
//#3433        lin++;                                                                   
//#3434        bseq[opnt].attr=SEQTOP;                                                                   
//#3435        bseq[opnt].x=lin->x;                                                                   
//#3436        bseq[opnt].y=lin->y;                                                                   
//#3437        opnt++;                                                                   
//#3438    }                                                                       
//#3439                                                                           
//#3440    void duseq2(unsigned ind){                                                                       
//#3441                                                                           
//#3442        seqlin=&*seq[ind];                                                                   
//#3443        rspnt((seqlin[1].x-seqlin[0].x)/2+seqlin[0].x,(seqlin[1].y-seqlin[0].y)/2+seqlin[0].y);                                                                   
//#3444    }                                                                       
//#3445                                                                           
//#3446    void duseq1(){                                                                       
//#3447                                                                           
//#3448        rspnt((seqlin[1].x-seqlin[0].x)/2+seqlin[0].x,(seqlin[1].y-seqlin[0].y)/2+seqlin[0].y);                                                                   
//#3449    }                                                                       
//#3450                                                                           
//#3451    void duseq(unsigned strt,unsigned fin){                                                                       
//#3452                                                                           
//#3453        unsigned    ind,topbak;                                                               
//#3454                                                                           
//#3455        seqlin=0;                                                                   
//#3456        rstMap(SEQDUN);                                                                   
//#3457        topbak=seq[strt][1].lin;                                                                   
//#3458        if(strt>fin){                                                                   
//#3459                                                                           
//#3460            for(ind=strt;(int)ind>=(int)fin;ind--){                                                               
//#3461                                                                           
//#3462                if(setseq(ind)){                                                           
//#3463                                                                           
//#3464                    if(!setMap(SEQDUN))                                                       
//#3465                        duseq2(ind);                                                   
//#3466                    else{                                                       
//#3467                                                                           
//#3468                        if(topbak!=seq[ind][1].lin){                                                   
//#3469                                                                           
//#3470                            if(ind)                                               
//#3471                                duseq2(ind+1);                                           
//#3472                            duseq2(ind);                                               
//#3473                            topbak=seqlin[1].lin;                                               
//#3474                        }                                                   
//#3475                    }                                                       
//#3476                }                                                           
//#3477                else{                                                           
//#3478                                                                           
//#3479                    if(rstMap(SEQDUN))                                                       
//#3480                        duseq2(ind+1);                                                   
//#3481                    seqlin=&*seq[ind];                                                       
//#3482                    movseq(ind);                                                       
//#3483                }                                                           
//#3484            }                                                               
//#3485            if(rstMap(SEQDUN))                                                               
//#3486                duseq2(ind+1);                                                           
//#3487            lastgrp=seqlin->grp;                                                               
//#3488        }                                                                   
//#3489        else{                                                                   
//#3490                                                                           
//#3491            for(ind=strt;ind<=fin;ind++){                                                               
//#3492                                                                           
//#3493                if(setseq(ind)){                                                           
//#3494                                                                           
//#3495                    if(!setMap(SEQDUN))                                                       
//#3496                        duseq2(ind);                                                   
//#3497                    else{                                                       
//#3498                                                                           
//#3499                        if(topbak!=seq[ind][1].lin){                                                   
//#3500                                                                           
//#3501                            if(ind)                                               
//#3502                                duseq2(ind-1);                                           
//#3503                            duseq2(ind);                                               
//#3504                            topbak=seqlin[1].lin;                                               
//#3505                        }                                                   
//#3506                    }                                                       
//#3507                }                                                           
//#3508                else{                                                           
//#3509                                                                           
//#3510                    if(rstMap(SEQDUN)){                                                       
//#3511                                                                           
//#3512                        if(ind)                                                   
//#3513                            duseq2(ind-1);                                               
//#3514                    }                                                       
//#3515                    seqlin=&*seq[ind];                                                       
//#3516                    movseq(ind);                                                       
//#3517                }                                                           
//#3518            }                                                               
//#3519            if(rstMap(SEQDUN)){                                                               
//#3520                                                                           
//#3521                if(ind)                                                           
//#3522                    duseq2(ind-1);                                                       
//#3523            }                                                               
//#3524            lastgrp=seqlin->grp;                                                               
//#3525        }                                                                   
//#3526    }                                                                       
//#3527                                                                           
//#3528    void brkseq(unsigned strt,unsigned fin){                                                                       
//#3529                                                                           
//#3530        SMALPNTL*    lin=0;                                                               
//#3531        unsigned    ind,bgrp=0;                                                               
//#3532                                                                           
//#3533        rstMap(SEQDUN);                                                                   
//#3534        if(strt>fin){                                                                   
//#3535                                                                           
//#3536            bgrp=seq[strt]->grp+1;                                                               
//#3537            for(ind=strt;(int)ind>=(int)fin;ind--){                                                               
//#3538                                                                           
//#3539                bgrp--;                                                           
//#3540                if(seq[ind]->grp!=bgrp){                                                           
//#3541                                                                           
//#3542                    rspnt(seqlin[0].x,seqlin[0].y);                                                       
//#3543                    seqlin=&*seq[ind];                                                       
//#3544                    rspnt(seqlin[0].x,seqlin[0].y);                                                       
//#3545                    bgrp=seqlin[0].grp;                                                       
//#3546                }                                                           
//#3547                else                                                           
//#3548                    seqlin=&*seq[ind];                                                       
//#3549                if(setseq(ind)){                                                           
//#3550                                                                           
//#3551                    if(!setMap(SEQDUN))                                                       
//#3552                        duseq1();                                                   
//#3553                }                                                           
//#3554                else                                                           
//#3555                    movseq(ind);                                                       
//#3556            }                                                               
//#3557            lastgrp=seqlin->grp;                                                               
//#3558        }                                                                   
//#3559        else{                                                                   
//#3560                                                                           
//#3561            bgrp=seq[strt]->grp-1;                                                               
//#3562            for(ind=strt;ind<=fin;ind++){                                                               
//#3563                                                                           
//#3564                bgrp++;                                                           
//#3565                if(seq[ind]->grp!=bgrp){                                                           
//#3566                                                                           
//#3567                    rspnt(seqlin[0].x,seqlin[0].y);                                                       
//#3568                    seqlin=&*seq[ind];                                                       
//#3569                    rspnt(seqlin[0].x,seqlin[0].y);                                                       
//#3570                    bgrp=seqlin[0].grp;                                                       
//#3571                }                                                           
//#3572                else                                                           
//#3573                    seqlin=&*seq[ind];                                                       
//#3574                if(setseq(ind)){                                                           
//#3575                                                                           
//#3576                    if(!setMap(SEQDUN))                                                       
//#3577                        duseq1();                                                   
//#3578                }                                                           
//#3579                else                                                           
//#3580                    movseq(ind);                                                       
//#3581            }                                                               
//#3582            lastgrp=seqlin->grp;                                                               
//#3583        }                                                                   
//#3584        if(rstMap(SEQDUN))                                                                   
//#3585            duseq1();                                                               
//#3586    }                                                                       
//#3587                                                                           
//#3588    void brkdun(unsigned strt,unsigned fin){                                                                       
//#3589                                                                           
//#3590        rspnt(seq[strt]->x,seq[strt]->y);                                                                   
//#3591        rspnt(seq[fin]->x,seq[fin]->y);                                                                   
//#3592        rspnt(lconflt[seq[strt]->lin].x,lconflt[seq[strt]->lin].y);                                                                   
//#3593        setMap(BRKFIX);                                                                   
//#3594    }                                                                       
//#3595                                                                           
//#3596    void durgn(unsigned pthi){                                                                       
//#3597                                                                           
//#3598        unsigned    dun,gdif,mindif,ind,fdif,bdif;                                                               
//#3599        unsigned    seql,seqn;                                                               
//#3600        unsigned    seqs,seqe;                                                               
//#3601        unsigned    grpn,grps,grpe;                                                               
//#3602        unsigned    rgind;                                                               
//#3603        SMALPNTL*    pnts;                                                               
//#3604        SMALPNTL*    pnte;                                                               
//#3605        double        len,minlen;                                                           
//#3606        BSEQPNT*    bpnt;                                                               
//#3607                                                                           
//#3608        rgind=mpath[pthi].vrt;                                                                   
//#3609        durpnt=&rgns[rgind];                                                                   
//#3610        grpn=mpath[pthi].grpn;                                                                   
//#3611        seqs=durpnt->strt;                                                                   
//#3612        seqe=durpnt->end;                                                                   
//#3613        if(mpath[pthi].skp||rstMap(BRKFIX)){                                                                   
//#3614                                                                           
//#3615            if(bseq[opnt-1].attr!=SEQBOT)                                                               
//#3616                rspnt(bseq[opnt-2].x,bseq[opnt-2].y);                                                           
//#3617            pnts=&*seq[rgind];                                                               
//#3618            dun=seq[seqs]->lin;                                                               
//#3619            bpnt=&bseq[opnt-1];                                                               
//#3620            minlen=1e99;                                                               
//#3621            for(ind=0;ind<sids;ind++){                                                               
//#3622                                                                           
//#3623                len=hypot(bpnt->x-lconflt[ind].x,bpnt->y-lconflt[ind].y);                                                           
//#3624                if(len<minlen){                                                           
//#3625                                                                           
//#3626                    minlen=len;                                                       
//#3627                    mindif=ind;                                                       
//#3628                }                                                           
//#3629            }                                                               
//#3630            if(minlen)                                                               
//#3631                rspnt(lconflt[mindif].x,lconflt[mindif].y);                                                           
//#3632            fdif=(sids+dun-mindif)%sids;                                                               
//#3633            bdif=(sids-dun+mindif)%sids;                                                               
//#3634            if(fdif<bdif){                                                               
//#3635                                                                           
//#3636                ind=nxt(mindif);                                                           
//#3637                while(ind!=dun){                                                           
//#3638                                                                           
//#3639                    rspnt(lconflt[ind].x,lconflt[ind].y);                                                       
//#3640                    ind=nxt(ind);                                                       
//#3641                }                                                           
//#3642                rspnt(lconflt[ind].x,lconflt[ind].y);                                                           
//#3643            }                                                               
//#3644            else{                                                               
//#3645                                                                           
//#3646                ind=prv(mindif);                                                           
//#3647                while(ind!=dun){                                                           
//#3648                                                                           
//#3649                    rspnt(lconflt[ind].x,lconflt[ind].y);                                                       
//#3650                    ind=prv(ind);                                                       
//#3651                }                                                           
//#3652                rspnt(lconflt[ind].x,lconflt[ind].y);                                                           
//#3653            }                                                               
//#3654        }                                                                   
//#3655        if(visit[rgind])                                                                   
//#3656            dun=1;                                                               
//#3657        else{                                                                   
//#3658                                                                           
//#3659            dun=0;                                                               
//#3660            visit[rgind]++;                                                               
//#3661        }                                                                   
//#3662        pnts=&*seq[durpnt->strt];                                                                   
//#3663        pnte=&*seq[durpnt->end];                                                                   
//#3664        grps=pnts->grp;                                                                   
//#3665        grpe=pnte->grp;                                                                   
//#3666        if(grpe!=grps)                                                                   
//#3667            seql=(double)(lastgrp-grps)/(grpe-grps)*(seqe-seqs)+seqs;                                                               
//#3668        else                                                                   
//#3669            seql=0;                                                               
//#3670        if(seql>lpnt)                                                                   
//#3671            seql=0;                                                               
//#3672        len=(double)(grpe-grps)*(seqe-seqs);                                                                   
//#3673        if(len)                                                                   
//#3674            seqn=(double)(grpn-grps)/len+seqs;                                                               
//#3675        else                                                                   
//#3676            seqn=seqe;                                                               
//#3677        if(seql<seqs)                                                                   
//#3678            seql=seqs;                                                               
//#3679        if(seql>seqe)                                                                   
//#3680            seql=seqe;                                                               
//#3681        if(seqn<seqs)                                                                   
//#3682            seqn=seqs;                                                               
//#3683        if(seqn>seqe)                                                                   
//#3684            seqn=seqe;                                                               
//#3685        if(seq[seql]->grp!=lastgrp){                                                                   
//#3686                                                                           
//#3687            if(seql<seqe&&seq[seql+1]->grp==lastgrp)                                                               
//#3688                seql++;                                                           
//#3689            else{                                                               
//#3690                                                                           
//#3691                if(seql>seqs&&seq[seql-1]->grp==lastgrp)                                                           
//#3692                    seql--;                                                       
//#3693                else{                                                           
//#3694                                                                           
//#3695                    mindif=0xffffffff;                                                       
//#3696                    for(ind=seqs;ind<=seqe;ind++){                                                       
//#3697                                                                           
//#3698    //                    gdif=abs(seq[ind]->grp-lastgrp);                                                   
//#3699                        gdif = abs((int)(seq[ind]->grp - lastgrp)); // xiaoguang                                                   
//#3700                        if(gdif<mindif){                                                   
//#3701                                                                           
//#3702                            mindif=gdif;                                               
//#3703                            seql=ind;                                               
//#3704                        }                                                   
//#3705                    }                                                       
//#3706                }                                                           
//#3707            }                                                               
//#3708        }                                                                   
//#3709        if(seq[seqn]->grp!=grpn){                                                                   
//#3710                                                                           
//#3711            if(seqn<seqe&&seq[seqn+1]->grp==grpn)                                                               
//#3712                seqn++;                                                           
//#3713            else{                                                               
//#3714                                                                           
//#3715                if(seqn>seqs&&seq[seqn-1]->grp==grpn)                                                           
//#3716                    seqn--;                                                       
//#3717                else{                                                           
//#3718                                                                           
//#3719                    mindif=0xffffffff;                                                       
//#3720                    for(ind=seqs;ind<=seqe;ind++){                                                       
//#3721                                                                           
//#3722    //                    gdif=abs(seq[ind]->grp-grpn);                                                   
//#3723                        gdif = abs((int)(seq[ind]->grp - grpn)); // xiaoguang                                                   
//#3724                        if(gdif<mindif){                                                   
//#3725                                                                           
//#3726                            mindif=gdif;                                               
//#3727                            seqn=ind;                                               
//#3728                        }                                                   
//#3729                    }                                                       
//#3730                }                                                           
//#3731            }                                                               
//#3732        }                                                                   
//#3733        if(durpnt->cntbrk){                                                                   
//#3734                                                                           
//#3735            if(dun){                                                               
//#3736                                                                           
//#3737                brkdun(seql,seqn);                                                           
//#3738            }                                                               
//#3739            else{                                                               
//#3740                                                                           
//#3741                if(lastgrp>=grpe){                                                           
//#3742                                                                           
//#3743                    brkseq(seqe,seqs);                                                       
//#3744                    if(pthi<mpathi-1&&seqe!=seqn)                                                       
//#3745                        brkseq(seqs,seqn);                                                   
//#3746                }                                                           
//#3747                else{                                                           
//#3748                                                                           
//#3749                    if(grps<=grpn){                                                       
//#3750                                                                           
//#3751                        if(seql!=seqs)                                                   
//#3752                            brkseq(seql,seqs);                                               
//#3753                        brkseq(seqs,seqe);                                                   
//#3754                        if(pthi<mpathi-1&&seqe!=seqn)                                                   
//#3755                            brkseq(seqe,seqn);                                               
//#3756                    }                                                       
//#3757                    else{                                                       
//#3758                                                                           
//#3759                        if(seql!=seqe)                                                   
//#3760                            brkseq(seql,seqe);                                               
//#3761                        brkseq(seqe,seqs);                                                   
//#3762                        if(pthi<mpathi-1&&seqs!=seqn)                                                   
//#3763                            brkseq(seqs,seqn);                                               
//#3764                    }                                                       
//#3765                }                                                           
//#3766            }                                                               
//#3767        }                                                                   
//#3768        else{                                                                   
//#3769                                                                           
//#3770            if(dun)                                                               
//#3771                dunseq(seql,seqn);                                                           
//#3772            else{                                                               
//#3773                                                                           
//#3774                if(lastgrp>=grpe){                                                           
//#3775                                                                           
//#3776                    duseq(seqe,seqs);                                                       
//#3777                    duseq(seqs,seqn);                                                       
//#3778                }                                                           
//#3779                else{                                                           
//#3780                                                                           
//#3781                    if(grps<=grpn){                                                       
//#3782                                                                           
//#3783                        if(seql!=seqs)                                                   
//#3784                            duseq(seql,seqs);                                               
//#3785                        duseq(seqs,seqe);                                                   
//#3786                        if(pthi<mpathi-1&&seqe!=seqn)                                                   
//#3787                            duseq(seqe,seqn);                                               
//#3788                    }                                                       
//#3789                    else{                                                       
//#3790                                                                           
//#3791                        if(seql!=seqe)                                                   
//#3792                            duseq(seql,seqe);                                               
//#3793                        duseq(seqe,seqs);                                                   
//#3794                        if(pthi<mpathi-1&&seqs!=seqn)                                                   
//#3795                            duseq(seqs,seqn);                                               
//#3796                    }                                                       
//#3797                }                                                           
//#3798            }                                                               
//#3799        }                                                                   
//#3800    }                                                                       
//#3801                                                                           
//#3802    unsigned notdun(unsigned lvl){                                                                       
//#3803                                                                           
//#3804        unsigned    ind;                                                               
//#3805        int            tpiv,pivot=lvl-1;                                                       
//#3806                                                                           
//#3807        rgpth=&tmpath[mpathi];                                                                   
//#3808        rgpth[0].pcon=minds[dunrgn];                                                                   
//#3809        rgpth[0].cnt=minds[dunrgn+1]-rgpth[0].pcon;                                                                   
//#3810        for(ind=1;ind<lvl;ind++){                                                                   
//#3811                                                                           
//#3812            rgpth[ind].pcon=minds[pmap[rgpth[ind-1].pcon].vrt];                                                               
//#3813            rgpth[ind].cnt=minds[pmap[rgpth[ind-1].pcon].vrt+1]-rgpth[ind].pcon;                                                               
//#3814        }                                                                   
//#3815        while(visit[pmap[rgpth[pivot].pcon].vrt]&&pivot>=0){                                                                   
//#3816                                                                           
//#3817            if(--rgpth[pivot].cnt>0)                                                               
//#3818                rgpth[pivot].pcon++;                                                           
//#3819            else{                                                               
//#3820                                                                           
//#3821                tpiv=pivot;                                                           
//#3822                do{                                                           
//#3823                                                                           
//#3824                    tpiv--;                                                       
//#3825                    if(tpiv<0)                                                       
//#3826                        return 1;                                                   
//#3827                    rgpth[tpiv].cnt--;                                                       
//#3828                    rgpth[tpiv].pcon++;                                                       
//#3829                }while(!rgpth[tpiv].cnt);                                                           
//#3830                if(tpiv<0)                                                           
//#3831                    return 1;                                                       
//#3832                tpiv++;                                                           
//#3833                while(tpiv<=pivot){                                                           
//#3834                                                                           
//#3835                    if(tpiv){                                                       
//#3836                                                                           
//#3837                        rgpth[tpiv].pcon=minds[pmap[rgpth[tpiv-1].pcon].vrt];                                                   
//#3838                        rgpth[tpiv].cnt=minds[pmap[rgpth[tpiv-1].pcon].vrt+1]-rgpth[tpiv].pcon;                                                   
//#3839                    }                                                       
//#3840                    else{                                                       
//#3841                                                                           
//#3842                        if(--rgpth[0].cnt)                                                   
//#3843                            rgpth[0].pcon++;                                               
//#3844                        else                                                   
//#3845                            return 1;                                               
//#3846                    }                                                       
//#3847                    tpiv++;                                                       
//#3848                }                                                           
//#3849            }                                                               
//#3850        }                                                                   
//#3851        return 0;                                                                   
//#3852    }                                                                       
//#3853                                                                           
//#3854    double reglen(unsigned reg){                                                                       
//#3855                                                                           
//#3856        double        len,minlen=1e99;                                                           
//#3857        unsigned    ind,ine;                                                               
//#3858        SMALPNTL*    pnts[4];                                                               
//#3859                                                                           
//#3860        pnts[0]=seq[rgns[reg].strt];                                                                   
//#3861        pnts[1]=&seq[rgns[reg].strt][1];                                                                   
//#3862        pnts[2]=seq[rgns[reg].end];                                                                   
//#3863        pnts[3]=&seq[rgns[reg].end][1];                                                                   
//#3864        for(ind=0;ind<4;ind++){                                                                   
//#3865                                                                           
//#3866            for(ine=0;ine<4;ine++){                                                               
//#3867                                                                           
//#3868                len=hypot(dunpnts[ind].x-pnts[ine]->x,dunpnts[ind].y-pnts[ine]->y);                                                           
//#3869                if(len<minlen)                                                           
//#3870                    minlen=len;                                                       
//#3871            }                                                               
//#3872        }                                                                   
//#3873        return minlen;                                                                   
//#3874    }                                                                       
//#3875                                                                           
//#3876    void nxtrgn(){                                                                       
//#3877                                                                           
//#3878        unsigned    ind,nureg;;                                                               
//#3879        SMALPNTL*    tpnt;                                                               
//#3880        double        len,minlen=1e99;                                                           
//#3881                                                                           
//#3882        pthlen=1;                                                                   
//#3883        while(notdun(pthlen)){                                                                   
//#3884                                                                           
//#3885            pthlen++;                                                               
//#3886            if(pthlen>8){                                                               
//#3887                                                                           
//#3888                tpnt=&*seq[rgns[dunrgn].strt];                                                           
//#3889                dunpnts[0].x=tpnt[0].x;                                                           
//#3890                dunpnts[0].y=tpnt[0].y;                                                           
//#3891                dunpnts[1].x=tpnt[1].x;                                                           
//#3892                dunpnts[1].y=tpnt[1].y;                                                           
//#3893                tpnt=&*seq[rgns[dunrgn].end];                                                           
//#3894                dunpnts[2].x=tpnt[0].x;                                                           
//#3895                dunpnts[2].y=tpnt[0].y;                                                           
//#3896                dunpnts[3].x=tpnt[1].x;                                                           
//#3897                dunpnts[3].y=tpnt[1].y;                                                           
//#3898                nureg=0;                                                           
//#3899                for(ind=0;ind<rgcnt;ind++){                                                           
//#3900                                                                           
//#3901                    if(!visit[ind]){                                                       
//#3902                                                                           
//#3903                        len=reglen(ind);                                                   
//#3904                        if(len<minlen){                                                   
//#3905                                                                           
//#3906                            minlen=len;                                               
//#3907                            nureg=ind;                                               
//#3908                        }                                                   
//#3909                    }                                                       
//#3910                }                                                           
//#3911                tmpath[mpathi].skp=1;                                                           
//#3912                for(ind=0;ind<cpnt;ind++){                                                           
//#3913                                                                           
//#3914                    if(pmap[ind].vrt==nureg){                                                       
//#3915                                                                           
//#3916                        tmpath[mpathi++].pcon=ind;                                                   
//#3917                        visit[nureg]=1;                                                   
//#3918                        dunrgn=nureg;                                                   
//#3919                        return;                                                   
//#3920                    }                                                       
//#3921                }                                                           
//#3922                tmpath[mpathi].cnt=vispnt;                                                           
//#3923                tmpath[mpathi++].pcon=0xffffffff;                                                           
//#3924                visit[vispnt]=1;                                                           
//#3925                dunrgn=vispnt;                                                           
//#3926                return;                                                           
//#3927            }                                                               
//#3928        }                                                                   
//#3929        for(ind=0;ind<pthlen;ind++){                                                                   
//#3930                                                                           
//#3931            tmpath[mpathi].skp=0;                                                               
//#3932            tmpath[mpathi++].pcon=rgpth[ind].pcon;                                                               
//#3933            visit[pmap[rgpth[ind].pcon].vrt]=1;                                                               
//#3934        }                                                                   
//#3935        dunrgn=pmap[rgpth[ind-1].pcon].vrt;                                                                   
//#3936    }                                                                       
//#3937                                                                           
//#3938    SMALPNTL* srtref(const void* arg){                                                                       
//#3939                                                                           
//#3940        _asm{                                                                   
//#3941                                                                           
//#3942                mov        eax,arg                                                   
//#3943                mov        eax,[eax]                                                   
//#3944        }                                                                   
//#3945    }                                                                       
//#3946                                                                           
//#3947    int sqcomp(const void *arg1, const void *arg2){                                                                       
//#3948                                                                           
//#3949        SMALPNTL* pnt0;                                                                   
//#3950        SMALPNTL* pnt1;                                                                   
//#3951                                                                           
//#3952        pnt0=srtref(arg1);                                                                   
//#3953        pnt1=srtref(arg2);                                                                   
//#3954                                                                           
//#3955        if(pnt0->lin==pnt1->lin){                                                                   
//#3956                                                                           
//#3957            if(pnt0->grp==pnt1->grp){                                                               
//#3958                                                                           
//#3959                if(pnt0->y==pnt1->y)return 0;                                                           
//#3960                else{                                                           
//#3961                                                                           
//#3962                    if(pnt0->y>pnt1->y)                                                       
//#3963                        return 1;                                                   
//#3964                    else                                                       
//#3965                        return -1;                                                   
//#3966                }                                                           
//#3967            }                                                               
//#3968            else{                                                               
//#3969                                                                           
//#3970                if(pnt0->grp>pnt1->grp)                                                           
//#3971                    return 1;                                                       
//#3972                else                                                           
//#3973                    return -1;                                                       
//#3974            }                                                               
//#3975        }                                                                   
//#3976        else{                                                                   
//#3977                                                                           
//#3978            if(pnt0->lin>pnt1->lin)                                                               
//#3979                return 1;                                                           
//#3980            else                                                               
//#3981                return -1;                                                           
//#3982        }                                                                   
//#3983    }                                                                       
//#3984                                                                           
//#3985    void nxtseq(unsigned pthi){                                                                       
//#3986                                                                           
//#3987        unsigned nxtvrt,ind;                                                                   
//#3988                                                                           
//#3989        ind=minds[mpath[pthi].vrt];                                                                   
//#3990        nxtvrt=mpath[pthi+1].vrt;                                                                   
//#3991        while(ind<minds[mpath[pthi].vrt+1]&&pmap[ind].vrt!=nxtvrt){                                                                   
//#3992                                                                           
//#3993            ind++;                                                               
//#3994        }                                                                   
//#3995        mpath[mpath0++].grpn=pmap[ind].grpn;                                                                   
//#3996    }                                                                       
//#3997                                                                           
//#3998    #define BUGSEQ 0                                                                       
//#3999
procedure lcon();
//#4000    void lcon(){
//#4001
//#4002        unsigned        ind,ine,blin,cnt,sgrp;
var
  ind,ine,blin,cnt,sgrp,tcon : cardinal;
  trgns : TArrayOfTRGN;
//#4003        RGN*            trgns;
//#4004        short            tcon;
  pcon, tmap : TArrayOfTRCON;
//#4005        RCON*            pcon;
//#4006        RCON*            tmap;
  tpnt : TArrayOfTSMALPNTL;
//#4007        SMALPNTL*        tpnt;
//#4008        unsigned*        tsrgns;
//#4009        unsigned        sind;
//#4010
//#4011    #if BUGSEQ
//#4012
//#4013        unsigned        bugcol;
//#4014    #endif
//#4015
begin
//#4016        if(spnt){
//#4017
//#4018            seq=new SMALPNTL*[spnt>>1];
//#4019            lpnt=0;
//#4020            for(ind=0;ind<spnt;ind+=2)
//#4021                seq[lpnt++]=&lins[ind];
//#4022            qsort((void*)seq,lpnt,4,sqcomp);
//#4023            rgcnt=0;
//#4024            trgns=(RGN*)oseq;
//#4025            trgns[0].strt=0;
//#4026            blin=seq[0]->lin;
//#4027            for(ind=0;ind<lpnt;ind++){
//#4028                                                                           
//#4029                if(blin!=seq[ind]->lin){                                                           
//#4030                                                                           
//#4031                    trgns[rgcnt++].end=ind-1;                                                       
//#4032                    trgns[rgcnt].strt=ind;                                                       
//#4033                    blin=seq[ind]->lin;                                                       
//#4034                }                                                           
//#4035            }                                                               
//#4036            trgns[rgcnt++].end=ind-1;                                                               
//#4037            rgns=new RGN[rgcnt];                                                               
//#4038            visit=new char[rgcnt];                                                               
//#4039            for(ind=0;ind<rgcnt;ind++){                                                               
//#4040                                                                           
//#4041                rgns[ind].strt=trgns[ind].strt;                                                           
//#4042                rgns[ind].end=trgns[ind].end;                                                           
//#4043                visit[ind]=0;                                                           
//#4044                rgns[ind].cntbrk=0;                                                           
//#4045            }                                                               
//#4046            tsrgns=(unsigned*)oseq;                                                               
//#4047            sind=0;                                                               
//#4048            for(ind=0;ind<rgcnt;ind++){                                                               
//#4049                                                                           
//#4050                cnt=0;                                                           
//#4051                if((rgns[ind].end-rgns[ind].strt)>1){                                                           
//#4052                                                                           
//#4053                    sgrp=seq[rgns[ind].strt]->grp;                                                       
//#4054                    for(ine=rgns[ind].strt+1;ine<=rgns[ind].end;ine++){                                                       
//#4055                                                                           
//#4056                        sgrp++;                                                   
//#4057                        if(seq[ine]->grp!=sgrp){                                                   
//#4058                                                                           
//#4059                            if(!cnt)                                               
//#4060                                rgns[ind].brk=sind;                                           
//#4061                            cnt++;                                               
//#4062                            sgrp=seq[ine]->grp;                                               
//#4063                            tsrgns[sind++]=ine;                                               
//#4064                        }                                                   
//#4065                    }                                                       
//#4066                }                                                           
//#4067                rgns[ind].cntbrk=cnt;                                                           
//#4068            }                                                               
//#4069            srgns=new unsigned[sind];                                                               
//#4070            for(ind=0;ind<sind;ind++)                                                               
//#4071                srgns[ind]=tsrgns[ind];                                                           
//#4072            tmap=(RCON*)bseq;                                                               
//#4073            minds=new unsigned[rgcnt+1];                                                               
//#4074                                                                           
//#4075    #if BUGSEQ                                                                       
//#4076            bugcol=0;seqpnt=0;                                                               
//#4077            for(ind=0;ind<rgcnt;ind++){                                                               
//#4078                                                                           
//#4079                for(ine=rgns[ind].strt;ine<=rgns[ind].end;ine++){                                                           
//#4080                                                                           
//#4081                    tpnt=&*seq[ine];                                                       
//#4082                    stchs[seqpnt].at=bugcol;                                                       
//#4083                    stchs[seqpnt].x=tpnt[0].x;                                                       
//#4084                    stchs[seqpnt++].y=tpnt[0].y;                                                       
//#4085                    stchs[seqpnt].at=bugcol;                                                       
//#4086                    stchs[seqpnt].x=tpnt[1].x;                                                       
//#4087                    stchs[seqpnt++].y=tpnt[1].y;                                                       
//#4088                }                                                           
//#4089                bugcol++;                                                           
//#4090                bugcol&=0xf;                                                           
//#4091            }                                                               
//#4092            hed.stchs=seqpnt;                                                               
//#4093            goto seqskip;                                                               
//#4094    #endif                                                                       
//#4095            opnt=0;                                                               
//#4096            if(rgcnt>1){                                                               
//#4097                                                                           
//#4098                ine=0;cpnt=0;                                                           
//#4099                for(ind=0;ind<rgcnt;ind++){                                                           
//#4100                                                                           
//#4101                    pcon=&tmap[cpnt];                                                       
//#4102                    minds[ind]=cpnt;                                                       
//#4103                    cnt=0;rgclos=0;                                                       
//#4104                    for(ine=0;ine<rgcnt;ine++){                                                       
//#4105                                                                           
//#4106                        if(ind!=ine){                                                   
//#4107                                                                           
//#4108                            tcon=regclos(ind,ine);                                               
//#4109                            if(tcon){                                               
//#4110                                                                           
//#4111                                tmap[cpnt].con=tcon;                                           
//#4112                                tmap[cpnt].grpn=nxtgrp;                                           
//#4113                                tmap[cpnt++].vrt=ine;                                           
//#4114                                cnt++;                                           
//#4115                            }                                               
//#4116                        }                                                   
//#4117                    }                                                       
//#4118                    while(!cnt){                                                       
//#4119                                                                           
//#4120                        rgclos+=stspace;                                                   
//#4121                        cnt=0;                                                   
//#4122                        for(ine=0;ine<rgcnt;ine++){                                                   
//#4123                                                                           
//#4124                            if(ind!=ine){                                               
//#4125                                                                           
//#4126                                tcon=regclos(ind,ine);                                           
//#4127                                if(tcon){                                           
//#4128                                                                           
//#4129                                    tmap[cpnt].con=tcon;                                       
//#4130                                    tmap[cpnt].grpn=nxtgrp;                                       
//#4131                                    tmap[cpnt++].vrt=ine;                                       
//#4132                                    cnt++;                                       
//#4133                                }                                           
//#4134                            }                                               
//#4135                        }                                                   
//#4136                    }                                                       
//#4137                }                                                           
//#4138                minds[ind]=cpnt;                                                           
//#4139                pmap=new RCON[cpnt+1];                                                           
//#4140                for(ind=0;ind<cpnt;ind++){                                                           
//#4141                                                                           
//#4142                    pmap[ind].con=tmap[ind].con;                                                       
//#4143                    pmap[ind].vrt=tmap[ind].vrt;                                                       
//#4144                    pmap[ind].grpn=tmap[ind].grpn;                                                       
//#4145                }                                                           
//#4146                //find the leftmost region                                                           
//#4147                sgrp=0xffffffff;ine=0;                                                           
//#4148                for(ind=0;ind<rgcnt;ind++){                                                           
//#4149                                                                           
//#4150                    tpnt=&*seq[rgns[ind].strt];                                                       
//#4151                    if(tpnt->grp<sgrp){                                                       
//#4152                                                                           
//#4153                        sgrp=tpnt->grp;                                                   
//#4154                        ine=ind;                                                   
//#4155                    }                                                       
//#4156                }                                                           
//#4157                opnt=0;                                                           
//#4158                tmpath=(RGSEQ*)oseq;                                                           
//#4159                //find the leftmost region in pmap                                                           
//#4160                mpathi=1;                                                           
//#4161                for(ind=0;ind<cpnt;ind++){                                                           
//#4162                                                                           
//#4163                    if(pmap[ind].vrt==ine)                                                       
//#4164                        goto lconskip;                                                   
//#4165                }                                                           
//#4166                pmap[cpnt].vrt=ine;                                                           
//#4167                pmap[cpnt].grpn=0;                                                           
//#4168                ind=cpnt;                                                           
//#4169    lconskip:;                                                                       
//#4170                //set the first entry in the temporary path to the leftmost region                                                           
//#4171                tmpath[0].pcon=ind;                                                           
//#4172                tmpath[0].cnt=1;                                                           
//#4173                tmpath[0].skp=0;                                                           
//#4174                visit[ine]=1;                                                           
//#4175                dunrgn=ine;                                                           
//#4176                while(unvis())                                                           
//#4177                    nxtrgn();                                                       
//#4178                ine=0;                                                           
//#4179                cnt=0xffffffff;                                                           
//#4180                mpath=(FSEQ*)&oseq[OSEQLEN>>1];                                                           
//#4181                for(ind=0;ind<mpathi;ind++){                                                           
//#4182                                                                           
//#4183                    mpath[ine].skp=tmpath[ind].skp;                                                       
//#4184                    if(tmpath[ind].pcon==0xffffffff){                                                       
//#4185                                                                           
//#4186                        mpath[ine++].vrt=tmpath[ind].cnt;                                                   
//#4187                        cnt=tmpath[ind].cnt;                                                   
//#4188                    }                                                       
//#4189                    else{                                                       
//#4190                                                                           
//#4191                        if(tmpath[ind].pcon!=cnt){                                                   
//#4192                                                                           
//#4193                            cnt=tmpath[ind].pcon;                                               
//#4194                            mpath[ine++].vrt=pmap[tmpath[ind].pcon].vrt;                                               
//#4195                        }                                                   
//#4196                    }                                                       
//#4197                }                                                           
//#4198                mpathi=ind;mpath0=0;                                                           
//#4199                for(ind=0;ind<mpathi;ind++)                                                           
//#4200                    nxtseq(ind);                                                       
//#4201                ine=(lpnt>>5)+1;                                                           
//#4202                seqmap=new unsigned[ine];                                                           
//#4203                for(ind=0;ind<ine;ind++)                                                           
//#4204                    seqmap[ind]=0;                                                       
//#4205                for(ind=0;ind<rgcnt;ind++)                                                           
//#4206                    visit[ind]=0;                                                       
//#4207                lastgrp=0;                                                           
//#4208                for(ind=0;ind<mpath0;ind++){                                                           
//#4209                                                                           
//#4210    //                sprintf(msgbuf,"ind %d,vrt %d,grpn %d\n",ind,pmap[ind].vrt,pmap[ind].grpn);                                                       
//#4211    //                OutputDebugString(msgbuf);                                                       
//#4212                    if(!unvis())                                                       
//#4213                        break;                                                   
//#4214                    durgn(ind);                                                       
//#4215                }                                                           
//#4216            }                                                               
//#4217            else{                                                               
//#4218                                                                           
//#4219                pmap=new RCON[1];                                                           
//#4220                mpath=new FSEQ[1];                                                           
//#4221                ine=(lpnt>>5)+1;                                                           
//#4222                seqmap=new unsigned[ine];                                                           
//#4223                for(ind=0;ind<ine;ind++)                                                           
//#4224                    seqmap[ind]=0;                                                       
//#4225                lastgrp=0;                                                           
//#4226                mpath[0].vrt=0;                                                           
//#4227                mpath[0].grpn=seq[rgns[0].end]->grp;                                                           
//#4228                mpath[0].skp=0;                                                           
//#4229                durgn(0);                                                           
//#4230                delete mpath;                                                           
//#4231            }                                                               
//#4232    //skip:;                                                                       
//#4233                                                                           
//#4234    #if BUGSEQ                                                                       
//#4235                                                                           
//#4236    seqskip:;                                                                       
//#4237    #endif                                                                       
//#4238            delete seq;                                                               
//#4239            delete lins;                                                               
//#4240            delete rgns;                                                               
//#4241            delete minds;                                                               
//#4242            delete visit;                                                               
//#4243            delete pmap;                                                               
//#4244            delete grinds;                                                               
//#4245            delete seqmap;                                                               
//#4246            delete srgns;                                                               
//#4247        }                                                                   
//#4248    }
end;                                                                
//#4249                                                                           
//#4250    BOOL notin(unsigned ond){                                                                       
//#4251                                                                           
//#4252        DUBPNT        pnt;                                                           
//#4253        unsigned    ind,cnt;                                                               
//#4254        DUBPNT        ipnt;                                                           
//#4255        double        len;                                                           
//#4256                                                                           
//#4257        cnt=0;minot=1e99;                                                                   
//#4258        pnt.x=(oseq[ond+1].x-oseq[ond].x)/2+oseq[ond].x;                                                                   
//#4259        pnt.y=(oseq[ond+1].y-oseq[ond].y)/2+oseq[ond].y;                                                                   
//#4260        for(ind=0;ind<frmpnt->sids;ind++){                                                                   
//#4261                                                                           
//#4262            if(projv(pnt.x,lin[ind],lin[ind+1],&ipnt)){                                                               
//#4263                                                                           
//#4264                if(ipnt.y>pnt.y)                                                           
//#4265                    cnt++;                                                       
//#4266                len=fabs(ipnt.y-pnt.y);                                                           
//#4267                if(len<minot){                                                           
//#4268                                                                           
//#4269                    minot=len;                                                       
//#4270                    minotl=ind;                                                       
//#4271                }                                                           
//#4272            }                                                               
//#4273        }                                                                   
//#4274        if(projv(pnt.x,lin[ind],lin[0],&ipnt)){                                                                   
//#4275                                                                           
//#4276            if(ipnt.y>pnt.y)                                                               
//#4277                cnt++;                                                           
//#4278            len=fabs(ipnt.y-pnt.y);                                                               
//#4279            if(len<minot){                                                               
//#4280                                                                           
//#4281                minot=len;                                                           
//#4282                minotl=ind;                                                           
//#4283            }                                                               
//#4284        }                                                                   
//#4285        return !(cnt&1);                                                                   
//#4286    }                                                                       
//#4287                                                                           
//#4288    unsigned seqtab[]=                                                                       
//#4289    {                                                                       
//#4290        12,7,15,11,13,17,                                                                   
//#4291    };                                                                       
//#4292                                                                           
//#4293    #define RITSIZ 6                                                                       
//#4294                                                                           
//#4295    void bakseq(){                                                                       
//#4296                                                                           
//#4297    #if BUGBAK                                                                       
//#4298                                                                           
//#4299        for(seqpnt=0;seqpnt<opnt;seqpnt++)                                                                   
//#4300        {                                                                   
//#4301            oseq[seqpnt].x=bseq[seqpnt].x;                                                               
//#4302            oseq[seqpnt].y=bseq[seqpnt].y;                                                               
//#4303        }                                                                   
//#4304        frmpnt->fmax=6000;                                                                   
//#4305    #else                                                                       
//#4306                                                                           
//#4307        int            cnt,rcnt;                                                       
//#4308        int            ind,rit;                                                       
//#4309        DUBPNT        dif,pnt,stp;                                                           
//#4310        double        len,rslop;                                                           
//#4311        double        usesiz2=usesiz*2;                                                           
//#4312        double        usesizh=usesiz/2;                                                           
//#4313        double        usesiz9=usesiz/9;                                                           
//#4314        double        stspac2=stspace*2;                                                           
//#4315                                                                           
//#4316        seqpnt=0;                                                                   
//#4317        rstMap(FILDIR);                                                                   
//#4318        ind=opnt-1;                                                                   
//#4319        oseq[seqpnt].x=bseq[ind].x;                                                                   
//#4320        oseq[seqpnt].y=bseq[ind].y;                                                                   
//#4321        seqpnt++;                                                                   
//#4322        sPnt.x=bseq[ind].x;                                                                   
//#4323        sPnt.y=bseq[ind].y;                                                                   
//#4324        ind--;                                                                   
//#4325        while(ind>0){                                                                   
//#4326                                                                           
//#4327            rcnt=ind%RITSIZ;                                                               
//#4328            if(seqpnt>MAXSEQ){                                                               
//#4329                                                                           
//#4330                seqpnt=MAXSEQ-1;                                                           
//#4331                return;                                                           
//#4332            }                                                               
//#4333            rit=bseq[ind].x/stspac2;                                                               
//#4334            dif.x=bseq[ind].x-bseq[ind+1].x;                                                               
//#4335            dif.y=bseq[ind].y-bseq[ind+1].y;                                                               
//#4336            if(dif.y)                                                               
//#4337                rslop=dif.x/dif.y;                                                           
//#4338            else                                                               
//#4339                rslop=1e99;                                                           
//#4340            switch(bseq[ind].attr){                                                               
//#4341                                                                           
//#4342            case SEQTOP:                                                               
//#4343                                                                           
//#4344                if(frmpnt->xat&AT_SQR){                                                           
//#4345                                                                           
//#4346                    if(toglMap(FILDIR)){                                                       
//#4347                                                                           
//#4348                        oseq[seqpnt].x=bseq[ind-1].x;                                                   
//#4349                        oseq[seqpnt++].y=bseq[ind-1].y;                                                   
//#4350                        cnt=ceil(bseq[ind].y/usesiz);                                                   
//#4351    blntop:;                                                                       
//#4352                        oseq[seqpnt].y=cnt*usesiz+(rit%seqtab[rcnt])*usesiz9;                                                   
//#4353                        if(oseq[seqpnt].y>bseq[ind].y)                                                   
//#4354                            goto blntopx;                                               
//#4355                        dif.y=oseq[seqpnt].y-bseq[ind].y;                                                   
//#4356                        oseq[seqpnt++].x=bseq[ind].x;                                                   
//#4357                        cnt++;                                                   
//#4358                        goto blntop;                                                   
//#4359    blntopx:;                                                                       
//#4360                        oseq[seqpnt].x=bseq[ind].x;                                                   
//#4361                        oseq[seqpnt++].y=bseq[ind].y;                                                   
//#4362                    }                                                       
//#4363                    else{                                                       
//#4364                                                                           
//#4365                        oseq[seqpnt].x=bseq[ind].x;                                                   
//#4366                        oseq[seqpnt++].y=bseq[ind].y;                                                   
//#4367                        cnt=floor(bseq[ind].y/usesiz);                                                   
//#4368    blntbot:;                                                                       
//#4369                        oseq[seqpnt].y=cnt*usesiz-((rit+2)%seqtab[rcnt])*usesiz9;                                                   
//#4370                        if(oseq[seqpnt].y<bseq[ind-1].y)                                                   
//#4371                            goto blntbotx;                                               
//#4372                        dif.y=oseq[seqpnt].y-bseq[ind-1].y;                                                   
//#4373                        oseq[seqpnt++].x=bseq[ind].x;                                                   
//#4374                        cnt--;                                                   
//#4375                        goto blntbot;                                                   
//#4376    blntbotx:;                                                                       
//#4377                        oseq[seqpnt].x=bseq[ind-1].x;                                                   
//#4378                        oseq[seqpnt++].y=bseq[ind-1].y;                                                   
//#4379                    }                                                       
//#4380                }                                                           
//#4381                else{                                                           
//#4382                                                                           
//#4383                    cnt=ceil(bseq[ind+1].y/usesiz);                                                       
//#4384    toplab:;                                                                       
//#4385                    oseq[seqpnt].y=cnt*usesiz+(rit%seqtab[rcnt])*usesiz9;                                                       
//#4386                    if(oseq[seqpnt].y>bseq[ind].y)                                                       
//#4387                        goto toplabx;                                                   
//#4388                    dif.y=oseq[seqpnt].y-bseq[ind+1].y;                                                       
//#4389                    dif.x=rslop*dif.y;                                                       
//#4390                    oseq[seqpnt++].x=bseq[ind+1].x+dif.x;                                                       
//#4391                    cnt++;                                                       
//#4392                    goto toplab;                                                       
//#4393    toplabx:;                                                                       
//#4394                    oseq[seqpnt].x=bseq[ind].x;                                                       
//#4395                    oseq[seqpnt++].y=bseq[ind].y;                                                       
//#4396                }                                                           
//#4397                break;                                                           
//#4398                                                                           
//#4399            case SEQBOT:                                                               
//#4400                                                                           
//#4401                if(!(frmpnt->xat&AT_SQR)){                                                           
//#4402                                                                           
//#4403                    cnt=floor(bseq[ind+1].y/usesiz);                                                       
//#4404    botlab:;                                                                       
//#4405                    oseq[seqpnt].y=cnt*usesiz-((rit+2)%seqtab[rcnt])*usesiz9;                                                       
//#4406                    if(oseq[seqpnt].y<bseq[ind].y)                                                       
//#4407                        goto botlabx;                                                   
//#4408                    dif.y=oseq[seqpnt].y-bseq[ind+1].y;                                                       
//#4409                    dif.x=rslop*dif.y;                                                       
//#4410                    oseq[seqpnt++].x=bseq[ind+1].x+dif.x;                                                       
//#4411                    cnt--;                                                       
//#4412                    goto botlab;                                                       
//#4413    botlabx:;                                                                       
//#4414                    oseq[seqpnt].x=bseq[ind].x;                                                       
//#4415                    oseq[seqpnt++].y=bseq[ind].y;                                                       
//#4416                }                                                           
//#4417                break;                                                           
//#4418                                                                           
//#4419            case 0:                                                               
//#4420                                                                           
//#4421                dif.x=bseq[ind].x-bseq[ind+1].x;                                                           
//#4422                dif.y=bseq[ind].y-bseq[ind+1].y;                                                           
//#4423                rstMap(FILDIR);                                                           
//#4424                len=hypot(dif.x,dif.y);                                                           
//#4425                if(len){                                                           
//#4426                                                                           
//#4427                    if(len>usesiz2){                                                       
//#4428                                                                           
//#4429                        pnt.x=bseq[ind+1].x;                                                   
//#4430                        pnt.y=bseq[ind+1].y;                                                   
//#4431                        cnt=len/usesiz-1;                                                   
//#4432                        if(chkmax(cnt,seqpnt)||(cnt+seqpnt)>MAXSEQ-3)                                                   
//#4433                            return;                                               
//#4434                        stp.x=dif.x/cnt;                                                   
//#4435                        stp.y=dif.y/cnt;                                                   
//#4436                        while(cnt){                                                   
//#4437                                                                           
//#4438                            pnt.x+=stp.x;                                               
//#4439                            pnt.y+=stp.y;                                               
//#4440                            oseq[seqpnt].x=pnt.x;                                               
//#4441                            oseq[seqpnt++].y=pnt.y;                                               
//#4442                            cnt--;                                               
//#4443                        }                                                   
//#4444                    }                                                       
//#4445                }                                                           
//#4446                oseq[seqpnt].x=bseq[ind].x;                                                           
//#4447                oseq[seqpnt++].y=bseq[ind].y;                                                           
//#4448            }                                                               
//#4449            ind--;                                                               
//#4450        }
//#4451    #endif
//#4452    }
//#4453
{procedure QuickSort(LPtr, RPtr: PInteger);
var
  P: Integer;
  IPtr, JPtr: PInteger;
  Temp: Integer;
const
  OddMask = SizeOf(Integer) and not(SizeOf(Integer) - 1);
begin
  if Integer(RPtr) - Integer(LPtr) > SortThreshold shl 2 then
  repeat
//    P := PInteger(Integer(LPtr) + (((Integer(RPtr) - Integer(LPtr)) shr 2) shr 1) shl 2)^ and $7FFFFFFF;

    P := Integer(RPtr) - Integer(LPtr);
    if (P and OddMask > 0) then Dec(P, SizeOf(Integer));
    P := PInteger(Integer(LPtr) + P shr 1)^ and $7FFFFFFF;

    IPtr := LPtr;
    JPtr := RPtr;
    repeat
      while (IPtr^ and $7FFFFFFF) < P do Inc(IPtr);
      while (JPtr^ and $7FFFFFFF) > P do Dec(JPtr);
      if Integer(IPtr) <= Integer(JPtr) then
      begin
        Temp := IPtr^;
        IPtr^ := JPtr^;
        JPtr^ := Temp;
//        Swap(IPtr^, JPtr^);
        Inc(IPtr);
        Dec(JPtr);
      end;
    until Integer(IPtr) > Integer(JPtr);
    if Integer(LPtr) < Integer(JPtr) then QuickSort(LPtr, JPtr);
    LPtr := IPtr;
  until Integer(IPtr) >= Integer(RPtr)
  else
    InsertionSort(LPtr, RPtr);
end;}
procedure PQSort(var A: TArrayOfPDUBPNTL);

  procedure QuickSortLin(var A: TArrayOfPDUBPNTL; iLo, iHi: Integer);
  var
    Lo, Hi, Mid: Integer;
    T : PDUBPNTL;
  begin
    Lo := iLo;
    Hi := iHi;
    Mid := A[(Lo + Hi) div 2].lin;
    repeat
      while A[Lo].lin < Mid do Inc(Lo);
      while A[Hi].lin > Mid do Dec(Hi);
      if Lo <= Hi then
      begin
//        VisualSwap(A[Lo], A[Hi], Lo, Hi);
        T := A[Lo];
        A[Lo] := A[Hi];
        A[Hi] := T;
        Inc(Lo);
        Dec(Hi);
      end;
    until Lo > Hi;
    if Hi > iLo then QuickSortLin(A, iLo, Hi);
    if Lo < iHi then QuickSortLin(A, Lo, iHi);
//    if Terminated then Exit;
  end;

  procedure QuickSortX(var A: TArrayOfPDUBPNTL; iLo, iHi: Integer);
  var
    Lo, Hi: cardinal;
    Mid : tfloat;
    T : PDUBPNTL;
  begin
    Lo := iLo;
    Hi := iHi;
    Mid := A[(Lo + Hi) div 2].x;
    repeat
      while A[Lo].x < Mid do Inc(Lo);
      while A[Hi].x > Mid do Dec(Hi);
      if Lo <= Hi then
      begin
//        VisualSwap(A[Lo], A[Hi], Lo, Hi);
        T := A[Lo];
        A[Lo] := A[Hi];
        A[Hi] := T;
        Inc(Lo);
        Dec(Hi);
      end;
    until Lo > Hi;
    if Hi > iLo then QuickSortX(A, iLo, Hi);
    if Lo < iHi then QuickSortX(A, Lo, iHi);
//    if Terminated then Exit;
  end;

begin
  QuickSortLin(A, Low(A), High(A));
end;


procedure TQSort(var A: TArrayOfTDUBPNTL);

  procedure QuickSortLin(var A: TArrayOfTDUBPNTL; iLo, iHi: Integer);
  var
    Lo, Hi, Mid: Integer;
    T : TDUBPNTL;
  begin
    Lo := iLo;
    Hi := iHi;
    Mid := A[(Lo + Hi) div 2].lin;
    repeat
      while A[Lo].lin < Mid do Inc(Lo);
      while A[Hi].lin > Mid do Dec(Hi);
      if Lo <= Hi then
      begin
//        VisualSwap(A[Lo], A[Hi], Lo, Hi);
        T := A[Lo];
        A[Lo] := A[Hi];
        A[Hi] := T;
        Inc(Lo);
        Dec(Hi);
      end;
    until Lo > Hi;
    if Hi > iLo then QuickSortLin(A, iLo, Hi);
    if Lo < iHi then QuickSortLin(A, Lo, iHi);
//    if Terminated then Exit;
  end;

  procedure QuickSortX(var A: TArrayOfTDUBPNTL; iLo, iHi: Integer);
  var
    Lo, Hi: cardinal;
    Mid : tfloat;
    T : TDUBPNTL;
  begin
    Lo := iLo;
    Hi := iHi;
    Mid := A[(Lo + Hi) div 2].x;
    repeat
      while A[Lo].x < Mid do Inc(Lo);
      while A[Hi].x > Mid do Dec(Hi);
      if Lo <= Hi then
      begin
//        VisualSwap(A[Lo], A[Hi], Lo, Hi);
        T := A[Lo];
        A[Lo] := A[Hi];
        A[Hi] := T;
        Inc(Lo);
        Dec(Hi);
      end;
    until Lo > Hi;
    if Hi > iLo then QuickSortX(A, iLo, Hi);
    if Lo < iHi then QuickSortX(A, Lo, iHi);
//    if Terminated then Exit;
  end;

begin
  QuickSortLin(A, Low(A), High(A));
end;

procedure fnvrt(var frmpnt : TFRMHED);  //Find Node Vertically?
//#4454    void fnvrt(){
//#4455
var ind,ine,inf,cnt,lincnt, tind : cardinal;
    tcnt : integer;
//#4456        unsigned    ind,ine,inf,cnt,lincnt=0,tind;
//#4457        int            tcnt;
  jpts :  TArrayOfTDUBPNTL;
  pjpts : TArrayOfPDUBPNTL;
//#4458        DUBPNTL*    jpts;
//#4459        DUBPNTL**    pjpts;
//#4460        double        lox,hix,mx0,mstp;
  lox,hix: single;
  mx0,mstp : Double;
  tpnt : TDoublePoint;
//#4461        DUBPNT        tpnt;
//#4462        unsigned*    tgrinds;
//#4463
  tgrinds : TArrayOfCardinal;

  orilen,addlen : integer;

//================================== TAKEN FROM GLOBAL ========================
//#328    FLPNT*            lin;                    //pointer to the line of the polygon being filled
  lin : TArrayOfFloatPoint;
  lins : TArrayOfTSMALPNTL;
  grindpnt,grpind,maxlins,spnt : integer;
  sids : cardinal;
//#341    BSEQPNT            bseq[BSEQLEN];            //reverse sequence for polygon fills
  //bseq : array[0..BSEQLEN-1] of TBSEQPNT;
//#408    unsigned*        grinds;                    //array of group indices for sequencing
  grinds : TArrayOfCardinal;

begin
  //PArrayOfFloatPoint(lin) := @frmpnt.flt;
  lin := @frmpnt.flt[0];
  sids:= frmpnt.sids;
  lox := lin[0].X;
  hix := lin[0].X;
                                          //#4464        lin=frmpnt->flt;
                                          //#4465        sids=frmpnt->sids;
                                          //#4466        lox=hix=lin[0].x;
  for ind := 1 to frmpnt.sids -1 do
  begin
    hix := max(hix, lin[ind].X);
    lox := min(lox, lin[ind].X);
                                          //#4467        for(ind=1;ind<sids;ind++){
                                          //#4468
                                          //#4469            if(lin[ind].x>hix)
                                          //#4470                hix=lin[ind].x;
                                          //#4471            if(lin[ind].x<lox)
                                          //#4472                lox=lin[ind].x;
                                          //#4473        }
  end;

  //temporary translate LOX to most left point
  tcnt := round(lox /stspace);            //#4474        tcnt=lox/stspace;
  lox := stspace * tcnt;                  //#4475        lox=stspace*tcnt;

  cnt := round((hix - lox) / stspace +1); // how many vertical line will available for horizontals Pixels.X
                                          //#4476        cnt=(hix-lox)/stspace+1;

  mstp := (hix-lox) /cnt; //gap between stitch horizontally    M_STEP
                                          //#4479        mstp=(hix-lox)/cnt;
  mx0 := lox;                             //#4480        mx0=lox;
  maxlins := 0; //max vertical line       //#4481        maxlins=0;
  lincnt  := 0; //total line in a form.

  //okay, there will be (cnt)_stitcs for horizontal.
  //FIND lincnt, find maxlins
  for ind := 0 to cnt -1 do               //#4482        for(ind=0;ind<cnt;ind++){
  begin
    inf := 0;
    lox := lox + mstp;
                                          //#4484            inf=0;
                                          //#4485            lox+=mstp;
    for ine := 0 to sids-1 do             //#4486            for(ine=0;ine<(unsigned)sids-1;ine++){
    begin
      if projv(lox, lin[ine], lin[ine+1], tpnt) then
        inc(inf);
                                          //#4488                if(projv(lox,lin[ine],lin[ine+1],&tpnt))
                                          //#4489                    inf++;
                                          //#4490            }
    end;
    if projv(lox, lin[ine], lin[0], tpnt) then  //#4491            if(projv(lox,lin[ine],lin[0],&tpnt)) inf++
      inc(inf);
    inc(lincnt, inf);                     //#4493            lincnt+=inf;
    maxlins := max(inf,maxlins);          //#4494            if(inf>maxlins)
                                          //#4495                maxlins=inf;
  end;                                    //#4496        }


  maxlins := maxlins shr 1; // = Div 2
  setlength(lins, lincnt);
  spnt := 0;
  grpind := 0; //current group index
//#4497        maxlins=(maxlins>>1);
//#4498        lins=new SMALPNTL[lincnt];
//#4499        spnt=0;grpind=0;
  //tgrinds := TArrayOfCardinal(@bseq);//#4500        tgrinds=(unsigned* )bseq;
  setlength(tgrinds, BSEQLEN);

  grindpnt := 0; //#4501        grindpnt=0;

  setlength(jpts, sids+2);
  setlength(pjpts, sids+2);
                                          //#4477        jpts=new DUBPNTL[sids+2];
                                          //#4478        pjpts=new DUBPNTL*[sids+2];


  for ind := 0 to cnt-1 do                          //#4502        for(ind=0;ind<cnt;ind++){
  begin
    mx0 := mx0 +  mstp;                             //#4504            mx0+=mstp;
    inf := 0;                                       //#4505            inf=0;


    //USING PJPTS:
    (*for ine := 0 to sids -2 do                      //#4506            for(ine=0;ine<(unsigned)sids-1;ine++){
    begin
      if projv(mx0,lin[ine],lin[ine+1],tpnt) then   //#4508                if(projv(mx0,lin[ine],lin[ine+1],&tpnt)){
      begin
         pjpts[inf]    := @jpts[inf];               //#4509
         jpts[inf].lin := ine;                      //#4510                    pjpts[inf]=&jpts[inf];
         jpts[inf].x   := tpnt.x;                   //#4511                    jpts[inf].lin=ine;
         inc(inf);                                  //#4512                    jpts[inf].x=tpnt.x;
         pjpts[inf]    := @jpts[inf];
         jpts[inf].y   := tpnt.y;                   //#4513                    jpts[inf++].y=tpnt.y;
      end;                                          //#4515                }
    end;                                            //#4516            }
    if projv(mx0,lin[ine],lin[0],tpnt)  then
    begin
       pjpts[inf] := @jpts[inf];
       jpts[inf].lin := ine;
       jpts[inf].x := tpnt.x;
       inc(inf);
       pjpts[inf]    := @jpts[inf];
       jpts[inf].y := tpnt.y;
                                //#4517            if(projv(mx0,lin[ine],lin[0],&tpnt)){
                                //#4519                pjpts[inf]=&jpts[inf];
                                //#4520                jpts[inf].lin=ine;
                                //#4521                jpts[inf].x=tpnt.x;
                                //#4522                jpts[inf++].y=tpnt.y;
                                //#4523            }
    end;




    if inf > 1 then
    begin
//#4524            if(inf>1){
      inf := inf and $fffffffe;
//#4526                inf&=0xfffffffe;
//#4527                tgrinds[grindpnt++]=spnt;
      inc(grindpnt);
      tgrinds[grindpnt] := spnt;
      setlength(pjpts, inf);
      QSort(pjpts);
      setlength(pjpts, sids+2);

//#4528                qsort((void* )pjpts,inf,4,comp);
//#4529                ine=0;
//#4530                tind=spnt;
      ine := 0;
      tind := spnt;
      while ine < inf do
//#4531                while(ine<inf){
      begin
				lins[spnt].lin  := pjpts[ine].lin;
				lins[spnt].grp  :=grpind;
				lins[spnt].x    :=pjpts[ine].x;
        inc(spnt);
        inc(ine);
				lins[spnt].y  :=pjpts[ine].y;
				lins[spnt].lin  :=pjpts[ine].lin;
				lins[spnt].grp  :=grpind;
				lins[spnt].x    :=pjpts[ine].x;
        inc(spnt);
        inc(ine);
        //avoid access violoation:
        if ine < inf then
  				lins[spnt].y  :=pjpts[ine].y
        //else
  				//lins[spnt].y  :=pjpts[ine-1].y
          ;

//#4533                    lins[spnt].lin = pjpts[ine]->lin;
//#4534                    lins[spnt].grp = grpind;
//#4535                    lins[spnt].x   = pjpts[ine]->x;
//#4536                    lins[spnt++].y = pjpts[ine++]->y;
//#4537                    lins[spnt].lin = pjpts[ine]->lin;
//#4538                    lins[spnt].grp = grpind;
//#4539                    lins[spnt].x   = pjpts[ine]->x;
//#4540                    lins[spnt++].y = pjpts[ine++]->y;
      end;      //#4541                }
      if spnt <> tind then
        inc(grpind);
//#4542                if(spnt!=tind)
//#4543                    grpind++;
//#4544            }
    end;*)

    //USING JPTS
    for ine := 0 to sids -2 do                      //#4506            for(ine=0;ine<(unsigned)sids-1;ine++){
    begin
      if projv(mx0,lin[ine],lin[ine+1],tpnt) then   //#4508                if(projv(mx0,lin[ine],lin[ine+1],&tpnt)){
      begin
         //pjpts[inf]    := @jpts[inf];               //#4509
         jpts[inf].lin := ine;                      //#4510                    pjpts[inf]=&jpts[inf];
         jpts[inf].x   := tpnt.x;                   //#4511                    jpts[inf].lin=ine;
         //pjpts[inf]    := @jpts[inf];
         jpts[inf].y   := tpnt.y;                   //#4513                    jpts[inf++].y=tpnt.y;
         inc(inf);                                  //#4512                    jpts[inf].x=tpnt.x;
      end;                                          //#4515                }
    end;                                            //#4516            }
    if projv(mx0,lin[ine],lin[0],tpnt)  then
    begin
       //pjpts[inf] := @jpts[inf];
       jpts[inf].lin := ine;
       jpts[inf].x := tpnt.x;
       //pjpts[inf]    := @jpts[inf];
       jpts[inf].y := tpnt.y;
       inc(inf);
                                //#4517            if(projv(mx0,lin[ine],lin[0],&tpnt)){
                                //#4519                pjpts[inf]=&jpts[inf];
                                //#4520                jpts[inf].lin=ine;
                                //#4521                jpts[inf].x=tpnt.x;
                                //#4522                jpts[inf++].y=tpnt.y;
                                //#4523            }
    end;




    if inf > 1 then
    begin
//#4524            if(inf>1){
      inf := inf and $fffffffe;
//#4526                inf&=0xfffffffe;
//#4527                tgrinds[grindpnt++]=spnt;
      inc(grindpnt);
      tgrinds[grindpnt] := spnt;
      setlength(jpts, inf);
      TQSort(jpts);
      setlength(jpts, sids+2);

//#4528                qsort((void* )pjpts,inf,4,comp);
//#4529                ine=0;
//#4530                tind=spnt;
      ine := 0;
      tind := spnt;
      while ine < inf do
//#4531                while(ine<inf){
      begin
				lins[spnt].lin  := jpts[ine].lin;
				lins[spnt].grp  :=grpind;
				lins[spnt].x    :=jpts[ine].x;
				lins[spnt].y  :=jpts[ine].y;

        inc(spnt);
        inc(ine);

				lins[spnt].lin  :=jpts[ine].lin;
				lins[spnt].grp  :=grpind;
				lins[spnt].x    :=jpts[ine].x;
        lins[spnt].y    :=jpts[ine].y;
        inc(spnt);
        inc(ine);

//#4533                    lins[spnt].lin = jpts[ine]->lin;
//#4534                    lins[spnt].grp = grpind;
//#4535                    lins[spnt].x   = jpts[ine]->x;
//#4536                    lins[spnt++].y = jpts[ine++]->y;
//#4537                    lins[spnt].lin = jpts[ine]->lin;
//#4538                    lins[spnt].grp = grpind;
//#4539                    lins[spnt].x   = jpts[ine]->x;
//#4540                    lins[spnt++].y = jpts[ine++]->y;
      end;      //#4541                }
      if spnt <> tind then
        inc(grpind);
//#4542                if(spnt!=tind)
//#4543                    grpind++;
//#4544            }
    end;
//#4545        }
  end;

  //X2NIE DEBUG
  orilen := length(frmpnt.flt);
  addlen := length(lins);
  setlength(frmpnt.flt, orilen + addlen);

  setlength(frmpnt.clp, orilen + addlen);
  fillchar(frmpnt.clp[0], sizeof(TFloatPoint) * (orilen + addlen), 0 );
  for ind := 0 to addlen-1 do
  begin
    with frmpnt.flt[orilen + ind] do
    begin
      x := lins[ind].x;
      y := lins[ind].y;
    end;
    frmpnt.clp[orilen + ind].X := lins[ind].lin;
  end;

(*
//#4546        tgrinds[grindpnt++]=spnt;
  {is save spnt to point array at index grindpnt, and the index grown one
  grow up by one
  seems like that fnvrt() is just to calculate the points
  and because tgrind is point to bseq,
  so we need to track the bseq
  Maybe Thred filling with bseq
  Just a guess}
  inc(grindpnt);
  tgrinds[grindpnt] := spnt;


//#4547        grinds=new unsigned[grindpnt];
//#4548        for(ind=0;ind<grindpnt;ind++)
//#4549            grinds[ind]=tgrinds[ind];
//#4550        grpind--;
//#4551        delete jpts;
//#4552        delete pjpts;
//#4553    }
*)
end;
//#4554
//#4555    void fnhor(){
//#4556
//#4557        unsigned    ind;
//#4558
//#4559        frmcpy(&angfrm,&formlst[clofind]);                                                                   
//#4560        rotcntr.x=(double)(angfrm.rct.right-angfrm.rct.left)/2+angfrm.rct.left;                                                                   
//#4561        rotcntr.y=(double)(angfrm.rct.top-angfrm.rct.bottom)/2+angfrm.rct.bottom;                                                                   
//#4562        ang=PI/2;                                                                   
//#4563        angfrm.flt=angflt;                                                                   
//#4564        for(ind=0;ind<angfrm.sids;ind++){                                                                   
//#4565                                                                           
//#4566            angfrm.flt[ind].x=frmpnt->flt[ind].x;                                                               
//#4567            angfrm.flt[ind].y=frmpnt->flt[ind].y;                                                               
//#4568            rotflt(&angfrm.flt[ind]);                                                               
//#4569        }                                                                   
//#4570        frmpnt=&angfrm;                                                                   
//#4571        fnvrt();                                                                   
//#4572        frmpnt=&formlst[clofind];                                                                   
//#4573    }                                                                       
//#4574
procedure fsvrt(var frmpnt : TFRMHED);
//#4575    void fsvrt(){
begin
//#4577        delmclp(clofind); //DEL CLIP
                                    //#759    void delmclp(unsigned fpnt){
                                    //#760
                                    //#761        unsigned    src,dst;
                                    //#762
                                    //#763        if(clpad){
                                    //#764
                                    //#765            if(isclp(fpnt)){
                                    //#766
                                    //#767                dst=findclp(fpnt);
                                    //#768                src=dst+formlst[fpnt].flencnt.nclp;
                                    //#769                MoveMemory(&clps[dst],&clps[src],sizeof(FLPNT)*(clpad-src));
                                    //#770                if(iseclp(fpnt))
                                    //#771                    formlst[fpnt].clp-=formlst[fpnt].flencnt.nclp;
                                    //#772                clpsub(fpnt,formlst[fpnt].flencnt.nclp);
                                    //#773                if(clpad>formlst[fpnt].flencnt.nclp)
                                    //#774                    clpad-=formlst[fpnt].flencnt.nclp;
                                    //#775                else
                                    //#776                    clpad=0;
                                    //#777                formlst[fpnt].flencnt.nclp=0;
                                    //#778            }
                                    //#779        }
                                    //#780    }

//#4578        deltx();     //DEL TEXTURE
//#4579        makpoli();   //set selected form as polygon
//#4580        frmpnt->ftyp=VRTF;
//#4581        frmpnt->typ=POLI;

//#4582        frmpnt->fcol=actcol;
//#4583        fsizpar();   //SET FORM CONSTRAINT_SIZE TO DEFAULT
                                  //#1034    void fsizpar(){
                                  //#1035
                                  //#1036        frmpnt->fmax=ini.maxsiz;
                                  //#1037        frmpnt->flencnt.flen=usesiz;
                                  //#1038        frmpnt->fmin=minsiz;
                                  //#1039    }

//#4584        frmpnt->fspac=stspace; //SET SPACE BETWEEN STITCH TO DEFAULT
//#4585        frmpnt->typ=POLI;
//#4586        dusqr();
                                  //#669    void dusqr(){
                                  //#671        if(chku(SQRFIL))
                                  //#672            frmpnt->xat|=AT_SQR;
                                  //#673        else
                                  //#674            frmpnt->xat&=(~AT_SQR);
                                  //#675    }

//#4587        refilfn(); //REFILL FORM N.   N= CURRENT WORKING FORM
  refilfn( frmpnt)
//#4588    }
end;

procedure filvrt(var frmpnt : TFRMHED); //called by menu: mnu_FILL_VERTClick()
//#4590    void filvrt(){
//#4592        unsigned ind;;
begin
//#4594        if(filmsgs(FMM_VRT))                                                                   
//#4595            return;                                                               
//#4596        if(fselpnt){    //number of selected forms;                                                               
//#4597                                                                           
//#4598            savdo();                                                               
//#4599            for(ind=0;ind<fselpnt;ind++){ //for selected forms                                                               
//#4600
  begin
//#4601                clofind=selist[ind]; //closest form to the cursor
//#4602                fvars(clofind);
    //if frmpnt.
      fsvrt(frmpnt);
//#4603                if(frmpnt->typ!=LIN)
//#4604                    fsvrt();
//#4605            }
  end;
//#4606            setMap(INIT);                                                               
//#4607            coltab();                                                               
//#4608            setMap(RESTCH);                                                               
//#4609        }                                                                   
//#4610        else{                                                                   
//#4611                                                                           
//#4612            if(chkMap(FORMSEL)){                                                               
//#4613                                                                           
//#4614                savdo();                                                           
//#4615                fsvrt();                                                           
//#4616                setMap(INIT);                                                           
//#4617                coltab();                                                           
//#4618                setMap(RESTCH);                                                           
//#4619            }                                                               
//#4620        }                                                                   
//#4621    }
end;                                                                       
//#4622                                                                           
//#4623    void fshor(){                                                                       
//#4624                                                                           
//#4625        delmclp(clofind);                                                                   
//#4626        deltx();                                                                   
//#4627        makpoli();                                                                   
//#4628        frmpnt->ftyp=HORF;                                                                   
//#4629        frmpnt->fcol=actcol;                                                                   
//#4630        fsizpar();                                                                   
//#4631        frmpnt->fspac=stspace;                                                                   
//#4632        frmpnt->angclp.fang=(float)PI/2;                                                                   
//#4633        frmpnt->typ=POLI;                                                                   
//#4634        dusqr();                                                                   
//#4635        refil();                                                                   
//#4636    }                                                                       
//#4637                                                                           
//#4638    void filhor(){                                                                       
//#4639                                                                           
//#4640        unsigned ind;                                                                   
//#4641                                                                           
//#4642        if(filmsgs(FMM_HOR))                                                                   
//#4643            return;                                                               
//#4644        if(fselpnt){                                                                   
//#4645                                                                           
//#4646            for(ind=0;ind<fselpnt;ind++){                                                               
//#4647                                                                           
//#4648                clofind=selist[ind];                                                           
//#4649                fvars(clofind);                                                           
//#4650                if(frmpnt->typ!=LIN)                                                           
//#4651                    fshor();                                                       
//#4652            }                                                               
//#4653            setMap(INIT);                                                               
//#4654            coltab();                                                               
//#4655            setMap(RESTCH);                                                               
//#4656        }                                                                   
//#4657        else{                                                                   
//#4658                                                                           
//#4659            if(chkMap(FORMSEL)){                                                               
//#4660                                                                           
//#4661                fshor();                                                           
//#4662                setMap(INIT);                                                           
//#4663                coltab();                                                           
//#4664                setMap(RESTCH);                                                           
//#4665            }                                                               
//#4666        }                                                                   
//#4667    }                                                                       
//#4668                                                                           
//#4669    void fsangl(){                                                                       
//#4670                                                                           
//#4671        double bang;                                                                   
//#4672                                                                           
//#4673        bang=ang;                                                                   
//#4674        delmclp(clofind);                                                                   
//#4675        deltx();                                                                   
//#4676        makpoli();                                                                   
//#4677        frmpnt->ftyp=ANGF;                                                                   
//#4678        ang=PI/2-ang;                                                                   
//#4679        frmpnt->angclp.fang=(float)ini.angl;                                                                   
//#4680        frmpnt->fcol=actcol;                                                                   
//#4681        fsizpar();                                                                   
//#4682        frmpnt->fspac=stspace;                                                                   
//#4683        frmpnt->typ=POLI;                                                                   
//#4684        dusqr();                                                                   
//#4685        refil();                                                                   
//#4686        ang=bang;                                                                   
//#4687    }                                                                       
//#4688                                                                           
//#4689    void filangl(){                                                                       
//#4690                                                                           
//#4691        unsigned ind;                                                                   
//#4692                                                                           
//#4693        if(filmsgs(FMM_ANG))                                                                   
//#4694            return;                                                               
//#4695        ang=ini.angl;                                                                   
//#4696        if(fselpnt){                                                                   
//#4697                                                                           
//#4698            savdo();                                                               
//#4699            for(ind=0;ind<fselpnt;ind++){                                                               
//#4700                                                                           
//#4701                clofind=selist[ind];                                                           
//#4702                fvars(clofind);                                                           
//#4703                if(frmpnt->typ!=LIN)                                                           
//#4704                    fsangl();                                                       
//#4705            }                                                               
//#4706            setMap(INIT);                                                               
//#4707            coltab();                                                               
//#4708            setMap(RESTCH);                                                               
//#4709        }                                                                   
//#4710        else{                                                                   
//#4711                                                                           
//#4712            if(chkMap(FORMSEL)){                                                               
//#4713                                                                           
//#4714                savdo();                                                           
//#4715                fsangl();                                                           
//#4716                setMap(INIT);                                                           
//#4717                coltab();                                                           
//#4718                setMap(RESTCH);                                                           
//#4719            }                                                               
//#4720        }                                                                   
//#4721    }                                                                       
//#4722                                                                           
//#4723    void sRct2px(FLRCT strct,RECT* pxrct){                                                                       
//#4724                                                                           
//#4725        pxrct->left=(strct.left-zRct.left)*zrat.x+0.5;                                                                   
//#4726        pxrct->right=(strct.right-zRct.left)*zrat.x+0.5;                                                                   
//#4727        pxrct->top=(scRct.bottom)-(strct.top-zRct.bottom)*zrat.y+0.5;                                                                   
//#4728        pxrct->bottom=(scRct.bottom)-(strct.bottom-zRct.bottom)*zrat.y+0.5;                                                                   
//#4729    }                                                                       
//#4730                                                                           
//#4731    void setmfrm(){                                                                       
//#4732                                                                           
//#4733        unsigned    ind;                                                               
//#4734        POINT        tpnt;                                                           
//#4735        POINT        tof;                                                           
//#4736                                                                           
//#4737    //    formlst[formpnt].wind=ini.wind;                                                                   
//#4738        sfCor2px(formlst[clofind].flt[0],&tpnt);                                                                   
//#4739        tof.x=msg.pt.x-stOrg.x-tpnt.x+fmovdif.x;                                                                   
//#4740        tof.y=msg.pt.y-stOrg.y-tpnt.y+fmovdif.y;                                                                   
//#4741        for(ind=0;ind<formlst[clofind].sids;ind++){                                                                   
//#4742                                                                           
//#4743            sfCor2px(formlst[clofind].flt[ind],&tpnt);                                                               
//#4744            flin[ind].x=tpnt.x+tof.x;                                                               
//#4745            flin[ind].y=tpnt.y+tof.y;                                                               
//#4746        }                                                                   
//#4747        flin[ind].x=flin[0].x;                                                                   
//#4748        flin[ind].y=flin[0].y;                                                                   
//#4749    }                                                                       
//#4750                                                                           
//#4751    void strtchbox(){                                                                       
//#4752                                                                           
//#4753        SetROP2(rsdc,R2_XORPEN);                                                                   
//#4754        SelectObject(rsdc,fPen);                                                                   
//#4755        Polyline(rsdc,sizlin,5);                                                                   
//#4756        SetROP2(rsdc,R2_COPYPEN);                                                                   
//#4757    }                                                                       
//#4758                                                                           
//#4759    void unstrtch(){                                                                       
//#4760                                                                           
//#4761        if(rstMap(SHOSTRTCH))                                                                   
//#4762            strtchbox();                                                               
//#4763    }                                                                       
//#4764                                                                           
//#4765    unsigned chkfrm(){                                                                       
//#4766                                                                           
//#4767        POINT        tpnt0,tpnt1;                                                           
//#4768        RECT        trct;                                                           
//#4769        unsigned    ind;                                                               
//#4770        double        len,mlen=1e99;                                                           
//#4771                                                                           
//#4772        fvars(clofind);
//#4773        tpnt0.x=msg.pt.x-stOrg.x;                                                                   
//#4774        tpnt0.y=msg.pt.y-stOrg.y;                                                                   
//#4775        nuflen=frmpnt->sids+1;                                                                   
//#4776        duzrat();                                                                   
//#4777        sRct2px(frmpnt->rct,&trct);                                                                   
//#4778        rctlin[0].x=rctlin[6].x=rctlin[7].x=rctlin[8].x=trct.left;                                                                   
//#4779        rctlin[1].x=rctlin[5].x=midl(trct.right,trct.left);                                                                   
//#4780        rctlin[0].y=rctlin[1].y=rctlin[2].y=rctlin[8].y=trct.top;                                                                   
//#4781        rctlin[3].y=rctlin[7].y=midl(trct.top,trct.bottom);                                                                   
//#4782        rctlin[4].y=rctlin[5].y=rctlin[6].y=trct.bottom;                                                                   
//#4783        rctlin[2].x=rctlin[3].x=rctlin[4].x=trct.right;                                                                   
//#4784        for(ind=0;ind<10;ind++){                                                                   
//#4785                                                                           
//#4786            len=hypot(rctlin[ind].x-tpnt0.x,rctlin[ind].y-tpnt0.y);                                                               
//#4787            if(len<mlen){                                                               
//#4788                                                                           
//#4789                mlen=len;                                                           
//#4790                cntrl=ind;                                                           
//#4791            }                                                               
//#4792            if(mlen<CLOSENUF){                                                               
//#4793                                                                           
//#4794                ritfrct(clofind,rsdc);                                                           
//#4795                for(ind=0;ind<4;ind++){                                                           
//#4796                                                                           
//#4797                    sizlin[ind].x=rctlin[ind<<1].x;                                                       
//#4798                    sizlin[ind].y=rctlin[ind<<1].y;                                                       
//#4799                }                                                           
//#4800                sizlin[4].x=sizlin[0].x;                                                           
//#4801                sizlin[4].y=sizlin[0].y;                                                           
//#4802                if(cntrl&1)                                                           
//#4803                    setMap(STRTCH);                                                       
//#4804                else{                                                           
//#4805                                                                           
//#4806                    setMap(EXPAND);                                                       
//#4807                    xpct=(double)(frmpnt->rct.right-frmpnt->rct.left)/(frmpnt->rct.top-frmpnt->rct.bottom);                                                       
//#4808                }                                                           
//#4809                cntrl>>=1;                                                           
//#4810                setMap(SHOSTRTCH);                                                           
//#4811                strtchbox();                                                           
//#4812                return 1;                                                           
//#4813            }                                                               
//#4814        }                                                                   
//#4815        if(tpnt0.x>=trct.left&&tpnt0.x<=trct.right&&                                                                   
//#4816            tpnt0.y>=trct.top&&tpnt0.y<=trct.bottom){                                                               
//#4817                                                                           
//#4818            sfCor2px(frmpnt->flt[0],&tpnt1);                                                               
//#4819            fmovdif.x=tpnt1.x-tpnt0.x;                                                               
//#4820            fmovdif.y=tpnt1.y-tpnt0.y;                                                               
//#4821            setMap(FRMOV);                                                               
//#4822            return 1;                                                               
//#4823        }                                                                   
//#4824        else                                                                   
//#4825            return 0;                                                               
//#4826    }                                                                       
//#4827                                                                           
//#4828    void rstfrm(){                                                                       
//#4829                                                                           
//#4830        FLPNT        pof;                                                           
//#4831        unsigned    ind;                                                               
//#4832        POINT        tpnt;                                                           
//#4833        unsigned    tat=(clofind<<4);                                                               
//#4834                                                                           
//#4835        setmfrm();                                                                   
//#4836        rstMap(FRMOV);                                                                   
//#4837        tpnt.x=msg.pt.x+fmovdif.x;                                                                   
//#4838        tpnt.y=msg.pt.y+fmovdif.y;                                                                   
//#4839        pxCor2stch(tpnt);                                                                   
//#4840        pof.x=sPnt.x-frmpnt->flt[0].x;                                                                   
//#4841        pof.y=sPnt.y-frmpnt->flt[0].y;                                                                   
//#4842        for(ind=0;ind<frmpnt->sids;ind++){                                                                   
//#4843                                                                           
//#4844            frmpnt->flt[ind].x+=pof.x;                                                               
//#4845            frmpnt->flt[ind].y+=pof.y;                                                               
//#4846        }                                                                   
//#4847        frmpnt->rct.bottom+=pof.y;                                                                   
//#4848        frmpnt->rct.top+=pof.y;                                                                   
//#4849        frmpnt->rct.left+=pof.x;                                                                   
//#4850        frmpnt->rct.right+=pof.x;                                                                   
//#4851        for(ind=0;ind<hed.stchs;ind++){                                                                   
//#4852                                                                           
//#4853            if((stchs[ind].at&FRMSK)==tat&&stchs[ind].at&ALTYPMSK&&!(stchs[ind].at&NOTFRM)){                                                               
//#4854                                                                           
//#4855                stchs[ind].x+=pof.x;                                                           
//#4856                stchs[ind].y+=pof.y;                                                           
//#4857            }                                                               
//#4858        }                                                                   
//#4859    }                                                                       
//#4860                                                                           
//#4861    void clrfills(){                                                                       
//#4862                                                                           
//#4863        unsigned ind;                                                                   
//#4864                                                                           
//#4865        for(ind=0;ind<formpnt;ind++){                                                                   
//#4866                                                                           
//#4867            formlst[ind].nclp=0;                                                               
//#4868            formlst[ind].flencnt.nclp=0;                                                               
//#4869            formlst[ind].etyp=0;                                                               
//#4870            formlst[ind].ftyp=0;                                                               
//#4871            formlst[ind].at&=NFRECONT;                                                               
//#4872            formlst[ind].xat&=!(AT_UND|AT_WALK);                                                               
//#4873        }                                                                   
//#4874        clpad=0;                                                                   
//#4875    }                                                                       
//#4876                                                                           
//#4877    void dusat(){                                                                       
//#4878                                                                           
//#4879        POINT* plin=&flin[satpt-1];                                                                   
//#4880                                                                           
//#4881        SetROP2(rsdc,R2_XORPEN);                                                                   
//#4882        SelectObject(rsdc,fPen);                                                                   
//#4883        Polyline(rsdc,plin,2);                                                                   
//#4884        SetROP2(rsdc,R2_COPYPEN);                                                                   
//#4885    //    SetROP2(sdc,R2_XORPEN);                                                                   
//#4886    //    SelectObject(sdc,fPen);                                                                   
//#4887    //    Polyline(sdc,plin,2);                                                                   
//#4888    //    SetROP2(sdc,R2_COPYPEN);                                                                   
//#4889    }                                                                       
//#4890                                                                           
//#4891    void unsat(){                                                                       
//#4892                                                                           
//#4893        if(rstMap(SHOSAT))                                                                   
//#4894            dusat();                                                               
//#4895    }                                                                       
//#4896                                                                           
//#4897    void drwsat(){                                                                       
//#4898                                                                           
//#4899        unsat();                                                                   
//#4900        px2stch();                                                                   
//#4901        flin[satpt].x=msg.pt.x-stOrg.x;                                                                   
//#4902        flin[satpt].y=msg.pt.y-stOrg.y;                                                                   
//#4903        setMap(SHOSAT);                                                                   
//#4904        dusat();                                                                   
//#4905    }                                                                       
//#4906                                                                           
//#4907    void satpnt0(){                                                                       
//#4908                                                                           
//#4909        px2stch();                                                                   
//#4910        flin[0].x=msg.pt.x-stOrg.x;                                                                   
//#4911        flin[0].y=msg.pt.y-stOrg.y;                                                                   
//#4912        tpoly[0].x=sPnt.x;                                                                   
//#4913        tpoly[0].y=sPnt.y;                                                                   
//#4914        satpt=1;                                                                   
//#4915        setMap(SATPNT);                                                                   
//#4916    }                                                                       
//#4917                                                                           
//#4918    void satpnt1(){                                                                       
//#4919                                                                           
//#4920        unsat();                                                                   
//#4921        px2stch();                                                                   
//#4922        flin[satpt].x=msg.pt.x-stOrg.x;                                                                   
//#4923        flin[satpt].y=msg.pt.y-stOrg.y;                                                                   
//#4924        dusat();                                                                   
//#4925        tpoly[satpt].x=sPnt.x;                                                                   
//#4926        tpoly[satpt].y=sPnt.y;                                                                   
//#4927        satpt++;                                                                   
//#4928        setMap(RESTCH);                                                                   
//#4929    }                                                                       
//#4930                                                                           
//#4931    void satfix(){                                                                       
//#4932                                                                           
//#4933        unsigned ind;                                                                   
//#4934                                                                           
//#4935        if(satpt>1){                                                                   
//#4936                                                                           
//#4937            formlst[formpnt].flt=adflt(satpt);                                                               
//#4938            for(ind=0;ind<satpt;ind++){                                                               
//#4939                                                                           
//#4940                formlst[formpnt].flt[ind].x=tpoly[ind].x;                                                           
//#4941                formlst[formpnt].flt[ind].y=tpoly[ind].y;                                                           
//#4942            }                                                               
//#4943            formlst[formpnt].sids=satpt;                                                               
//#4944            frmout(formpnt);                                                               
//#4945            formlst[formpnt].stpt=0;                                                               
//#4946            formpnt++;                                                               
//#4947            setMap(INIT);                                                               
//#4948        }                                                                   
//#4949        rstMap(SHOSAT);                                                                   
//#4950        setMap(RESTCH);                                                                   
//#4951    }                                                                       
//#4952                                                                           
//#4953    void delcon(unsigned cpnt)                                                                       
//#4954    {                                                                       
//#4955        unsigned ind;                                                                   
//#4956        unsigned loc;                                                                   
//#4957        SATCON* tp;                                                                   
//#4958        FRMHED* fp;                                                                   
//#4959                                                                           
//#4960        tp=&frmpnt->sacang.sac[cpnt];                                                                   
//#4961        loc=&frmpnt->sacang.sac[cpnt]-satks;                                                                   
//#4962        if(satkad>loc)                                                                   
//#4963            MoveMemory(tp,&tp[1],(satkad-loc+1)*sizeof(SATCON));                                                               
//#4964        for(ind=clofind+1;ind<formpnt;ind++)                                                                   
//#4965        {                                                                   
//#4966            fp=&formlst[ind];                                                               
//#4967            if(fp->typ==SAT&&fp->stpt)                                                               
//#4968                fp->sacang.sac--;                                                           
//#4969        }                                                                   
//#4970        if(clofine<wpar)                                                                   
//#4971            wpar--;                                                               
//#4972        frmpnt->stpt--;                                                                   
//#4973        satkad--;                                                                   
//#4974        stpt=frmpnt->stpt;                                                                   
//#4975        if(frmpnt->ftyp==SATF)                                                                   
//#4976            refil();                                                               
//#4977        coltab();                                                                   
//#4978        setMap(RESTCH);                                                                   
//#4979    }                                                                       
//#4980                                                                           
//#4981    BOOL satselfn(){                                                                       
//#4982                                                                           
//#4983        unsigned ind,ine,playcod;                                                                   
//#4984        double        tlen,len=1e99;                                                           
//#4985        double        dx,dy;                                                           
//#4986                                                                           
//#4987        px2stch();                                                                   
//#4988        for(ind=0;ind<formpnt;ind++){                                                                   
//#4989                                                                           
//#4990            playcod=(formlst[ind].at&FRMLMSK)>>1;                                                               
//#4991            if(!actl||!playcod||playcod==actl){                                                               
//#4992                                                                           
//#4993                for(ine=0;ine<formlst[ind].sids;ine++){                                                           
//#4994                                                                           
//#4995                    dx=sPnt.x-formlst[ind].flt[ine].x;                                                       
//#4996                    dy=sPnt.y-formlst[ind].flt[ine].y;                                                       
//#4997                    tlen=hypot(dx,dy);                                                       
//#4998                    if(tlen<len){                                                       
//#4999                                                                           
//#5000                        len=tlen;                                                   
//#5001                        clofind=ind;                                                   
//#5002                        clofine=ine;                                                   
//#5003                    }                                                       
//#5004                }                                                           
//#5005            }                                                               
//#5006        }                                                                   
//#5007        if(len<CLOSENUF)                                                                   
//#5008            return 1;                                                               
//#5009        else                                                                   
//#5010            return 0;                                                               
//#5011    }                                                                       
//#5012                                                                           
//#5013    void satsel(){                                                                       
//#5014                                                                           
//#5015        if(satselfn()){                                                                   
//#5016                                                                           
//#5017            fvars(clofind);                                                               
//#5018            duzrat();                                                               
//#5019            xstrt=clofine;                                                               
//#5020            sfCor2px(frmpnt->flt[clofine],&flin[0]);                                                               
//#5021            rstMap(SHOCON);                                                               
//#5022            setMap(SATCNKT);                                                               
//#5023            if(frmpnt->typ==POLI)                                                               
//#5024                frmpnt->typ=SAT;                                                           
//#5025        }                                                                   
//#5026    }                                                                       
//#5027                                                                           
//#5028    void ducon(){                                                                       
//#5029                                                                           
//#5030        SetROP2(rsdc,R2_XORPEN);                                                                   
//#5031        SelectObject(rsdc,fPen);                                                                   
//#5032        Polyline(rsdc,flin,2);                                                                   
//#5033        SetROP2(rsdc,R2_COPYPEN);                                                                   
//#5034    }                                                                       
//#5035                                                                           
//#5036    void uncon(){                                                                       
//#5037                                                                           
//#5038        if(rstMap(SHOCON))                                                                   
//#5039            ducon();                                                               
//#5040    }                                                                       
//#5041                                                                           
//#5042    void drwcon(){                                                                       
//#5043                                                                           
//#5044        uncon();                                                                   
//#5045        flin[1].x=msg.pt.x-stOrg.x;                                                                   
//#5046        flin[1].y=msg.pt.y-stOrg.y;                                                                   
//#5047        setMap(SHOCON);                                                                   
//#5048        ducon();                                                                   
//#5049    }                                                                       
//#5050                                                                           
//#5051    int scomp(const void *arg1, const void *arg2){                                                                       
//#5052                                                                           
//#5053        _asm{                                                                   
//#5054                                                                           
//#5055                xor        eax,eax                                                   
//#5056                mov        ebx,arg2                                                   
//#5057                mov        ebx,[ebx]                                                   
//#5058                mov        bx,[ebx]                                                   
//#5059                mov        ecx,arg1                                                   
//#5060                mov        ecx,[ecx]                                                   
//#5061                mov        cx,[ecx]                                                   
//#5062                cmp        bx,cx                                                   
//#5063                je        short scmpx                                                   
//#5064                jc        short scmp1                                                   
//#5065                dec        eax                                                   
//#5066                jmp        short scmpx                                                   
//#5067    scmp1:        inc        eax                                                       
//#5068    scmpx:                                                                       
//#5069        }                                                                   
//#5070    #pragma warning(disable:4035;once:)                                                                       
//#5071    }                                                                       
//#5072                                                                           
//#5073    unsigned setchk(unsigned bPnt){                                                                       
//#5074                                                                           
//#5075        _asm{                                                                   
//#5076                xor        eax,eax                                                   
//#5077                mov        ebx,chkmap                                                   
//#5078                mov        ecx,bPnt                                                   
//#5079                bts        [ebx],ecx                                                   
//#5080                jnc        short setcx                                                   
//#5081                dec        eax                                                   
//#5082    setcx:                                                                       
//#5083        }                                                                   
//#5084    }                                                                       
//#5085                                                                           
//#5086    unsigned chkchk(unsigned ind){                                                                       
//#5087                                                                           
//#5088        _asm{                                                                   
//#5089                xor        eax,eax                                                   
//#5090                mov        ebx,chkmap                                                   
//#5091                mov        ecx,ind                                                   
//#5092                bt        [ebx],ecx                                                   
//#5093                jc        short ccx                                                   
//#5094                dec        eax                                                   
//#5095    ccx:                                                                       
//#5096        }                                                                   
//#5097    }                                                                       
//#5098                                                                           
//#5099    unsigned nxtchk(unsigned ind){                                                                       
//#5100                                                                           
//#5101        _asm{                                                                   
//#5102                xor        eax,eax                                                   
//#5103                mov        ebx,ind                                                   
//#5104                shl        ebx,2                                                   
//#5105                add        ebx,chkmap                                                   
//#5106                mov        ecx,[ebx]                                                   
//#5107                bsf        eax,ecx                                                   
//#5108                jne        short nxtc1                                                   
//#5109                dec        eax                                                   
//#5110                jmp        short nxtcx                                                   
//#5111    nxtc1:        btr        ecx,eax                                                       
//#5112                mov        [ebx],ecx                                                   
//#5113    nxtcx:                                                                       
//#5114        }                                                                   
//#5115    }                                                                       
//#5116                                                                           
//#5117    unsigned prvchk(unsigned ind){                                                                       
//#5118                                                                           
//#5119        _asm{                                                                   
//#5120                xor        eax,eax                                                   
//#5121                mov        ebx,ind                                                   
//#5122                shl        ebx,2                                                   
//#5123                add        ebx,chkmap                                                   
//#5124                mov        ecx,[ebx]                                                   
//#5125                bsr        eax,ecx                                                   
//#5126                jne        short prvc1                                                   
//#5127                dec        eax                                                   
//#5128                jmp        short prvcx                                                   
//#5129    prvc1:        btr        ecx,eax                                                       
//#5130                mov        [ebx],ecx                                                   
//#5131    prvcx:                                                                       
//#5132        }                                                                   
//#5133    }                                                                       
//#5134                                                                           
//#5135    void satadj()                                                                       
//#5136    {                                                                       
//#5137        unsigned    ind,ine,inf,psac,mapsiz,prstpt;                                                               
//#5138        SATCON*        spnt;                                                           
//#5139        SATCON*        dpnt;                                                           
//#5140        unsigned short bstpt;                                                                   
//#5141        FRMHED*        fp;                                                           
//#5142                                                                           
//#5143        fvars(clofind);                                                                   
//#5144        bstpt=frmpnt->stpt;                                                                   
//#5145        for(ind=0;ind<frmpnt->stpt;ind++)                                                                   
//#5146        {                                                                   
//#5147            if(sac[ind].fin>sids-1)                                                               
//#5148                sac[ind].fin=sids-1;                                                           
//#5149            if(sac[ind].strt>sids-1)                                                               
//#5150                sac[ind].strt=sids-1;                                                           
//#5151        }                                                                   
//#5152        spnt=(SATCON*)bseq;                                                                   
//#5153        mapsiz=(sids>>5)+1;                                                                   
//#5154        chkmap=(unsigned*)oseq;                                                                   
//#5155        psac=0;                                                                   
//#5156        prstpt=stpt;                                                                   
//#5157        for(ind=0;ind<stpt;ind++)                                                                   
//#5158        {                                                                   
//#5159            if(sac[ind].strt!=sac[ind].fin)                                                               
//#5160            {                                                               
//#5161                sac[psac].strt=sac[ind].strt;                                                           
//#5162                sac[psac].fin=sac[ind].fin;                                                           
//#5163                psac++;                                                           
//#5164            }                                                               
//#5165        }                                                                   
//#5166        stpt=frmpnt->stpt=ind;                                                                   
//#5167        if(wpar||frmpnt->at&FRMEND)                                                                   
//#5168        {                                                                   
//#5169            for(ind=0;ind<mapsiz;ind++)                                                               
//#5170                chkmap[ind]=0;                                                           
//#5171            if(frmpnt->at&FRMEND)                                                               
//#5172            {                                                               
//#5173                setchk(0);                                                           
//#5174                setchk(1);                                                           
//#5175            }                                                               
//#5176            if(wpar)                                                               
//#5177            {                                                               
//#5178                setchk(wpar);                                                           
//#5179                setchk(wpar+1);                                                           
//#5180            }                                                               
//#5181            ine=0;                                                               
//#5182            for(ind=0;ind<stpt;ind++)                                                               
//#5183            {                                                               
//#5184                if(chkchk(sac[ind].strt)&&chkchk(sac[ind].fin))                                                           
//#5185                {                                                           
//#5186                    spnt[ine].strt=sac[ind].strt;                                                       
//#5187                    spnt[ine].fin=sac[ind].fin;                                                       
//#5188                    ine++;                                                       
//#5189                }                                                           
//#5190            }                                                               
//#5191            stpt=frmpnt->stpt=ine;                                                               
//#5192            if(wpar)                                                               
//#5193            {                                                               
//#5194                ine=0;                                                           
//#5195                for(ind=0;ind<stpt;ind++)                                                           
//#5196                {                                                           
//#5197                    if(sac[ind].strt<wpar)                                                       
//#5198                    {                                                       
//#5199                        spnt[ine].strt=sac[ind].strt;                                                   
//#5200                        spnt[ine++].fin=sac[ind].fin;                                                   
//#5201                    }                                                       
//#5202                }                                                           
//#5203                stpt=frmpnt->stpt=ine;                                                           
//#5204            }                                                               
//#5205        }                                                                   
//#5206        else                                                                   
//#5207        {                                                                   
//#5208            for(ind=0;ind<stpt;ind++)                                                               
//#5209            {                                                               
//#5210                spnt[ind].strt=sac[ind].strt;                                                           
//#5211                spnt[ind].fin=sac[ind].fin;                                                           
//#5212            }                                                               
//#5213        }                                                                   
//#5214        if(stpt)                                                                   
//#5215        {                                                                   
//#5216            for(ind=0;ind<mapsiz;ind++)                                                               
//#5217                chkmap[ind]=0;                                                           
//#5218            for(ind=0;ind<stpt;ind++)                                                               
//#5219            {                                                               
//#5220                ine=sac[ind].strt;                                                           
//#5221                if(ine>(unsigned)wpar-1)                                                           
//#5222                    ine=wpar-1;                                                       
//#5223                if(setchk(ine))                                                           
//#5224                {                                                           
//#5225                    inf=ine;                                                       
//#5226                    if(inf)                                                       
//#5227                        inf--;                                                   
//#5228                    while(!chkchk(ine)&&ine<(unsigned)wpar-1)                                                       
//#5229                        ine++;                                                   
//#5230                    while(inf&&(!chkchk(inf)))                                                       
//#5231                        inf--;                                                   
//#5232                    if(!chkchk(ine)&&!chkchk(inf))                                                       
//#5233                        break;                                                   
//#5234                    if(chkchk(ine)&&chkchk(inf))                                                       
//#5235                    {                                                       
//#5236                        if(ine-sac[ind].strt>sac[ind].strt-inf)                                                   
//#5237                            setchk(inf);                                               
//#5238                        else                                                   
//#5239                            setchk(ine);                                               
//#5240                    }                                                       
//#5241                    else{                                                       
//#5242                                                                           
//#5243                        if(chkchk(ine))                                                   
//#5244                            setchk(inf);                                               
//#5245                        else                                                   
//#5246                            setchk(ine);                                               
//#5247                    }                                                       
//#5248                                                                           
//#5249                }                                                           
//#5250            }                                                               
//#5251            inf=0;                                                               
//#5252            for(ind=0;ind<mapsiz;ind++)                                                               
//#5253            {                                                               
//#5254                do                                                           
//#5255                {                                                           
//#5256                    ine=nxtchk(ind);                                                       
//#5257                    if(ine<sids)                                                       
//#5258                        sac[inf++].strt=ine+(ind<<5);                                                   
//#5259                }while(ine<sids);                                                           
//#5260            }                                                               
//#5261            stpt=frmpnt->stpt=inf;                                                               
//#5262            for(ind=0;ind<mapsiz;ind++)                                                               
//#5263                chkmap[ind]=0;                                                           
//#5264            for(ind=0;ind<stpt;ind++)                                                               
//#5265            {                                                               
//#5266                ine=inf=sac[ind].fin;                                                           
//#5267                if(ine>(unsigned)sids-1)                                                           
//#5268                    ine=sids-1;                                                       
//#5269                if(setchk(ine))                                                           
//#5270                {                                                           
//#5271                    if(ine<(unsigned)sids-1)                                                       
//#5272                        ine++;                                                   
//#5273                    if(inf>(unsigned)wpar+1)                                                       
//#5274                        inf--;                                                   
//#5275                    while(!chkchk(ine)&&ine<(unsigned)sids-1)                                                       
//#5276                        ine++;                                                   
//#5277                    while(inf>(unsigned)wpar-1&&(!chkchk(inf)))                                                       
//#5278                        inf--;                                                   
//#5279                    if(!chkchk(ine)&&!chkchk(inf))                                                       
//#5280                        break;                                                   
//#5281                    if(chkchk(ine)&&chkchk(inf))                                                       
//#5282                    {                                                       
//#5283                        if(ine-sac[ind].fin>sac[ind].fin-inf)                                                   
//#5284                            setchk(inf);                                               
//#5285                        else                                                   
//#5286                            setchk(ine);                                               
//#5287                    }                                                       
//#5288                    else                                                       
//#5289                    {                                                       
//#5290                        if(chkchk(ine))                                                   
//#5291                            setchk(ine);                                               
//#5292                        else                                                   
//#5293                            setchk(inf);                                               
//#5294                    }                                                       
//#5295                }                                                           
//#5296            }                                                               
//#5297            inf=0;                                                               
//#5298            for(ind=mapsiz-1;ind<mapsiz;ind--)                                                               
//#5299            {                                                               
//#5300                do                                                           
//#5301                {                                                           
//#5302                    ine=prvchk(ind);                                                       
//#5303                    if(ine<sids)                                                       
//#5304                        sac[inf++].fin=ine+(ind<<5);                                                   
//#5305                }while(ine<sids);                                                           
//#5306            }                                                               
//#5307            if(inf<stpt)                                                               
//#5308                inf=stpt;                                                           
//#5309            stpt=frmpnt->stpt=inf;                                                               
//#5310            if(wpar)                                                               
//#5311            {                                                               
//#5312                if(stpt>sids-wpar-2)                                                           
//#5313                    stpt=sids-wpar-2;                                                       
//#5314                if(stpt>wpar-2)                                                           
//#5315                    stpt=wpar-2;                                                       
//#5316                frmpnt->stpt=stpt;                                                           
//#5317            }                                                               
//#5318        }                                                                   
//#5319        if(frmpnt->stpt<bstpt)                                                                   
//#5320        {                                                                   
//#5321            ine=bstpt-stpt;                                                               
//#5322            spnt=dpnt=frmpnt->sacang.sac;                                                               
//#5323            dpnt+=frmpnt->stpt;                                                               
//#5324            spnt+=bstpt;                                                               
//#5325            MoveMemory(dpnt,spnt,sizeof(SATCON)*(&satks[satkad]-spnt+1));                                                               
//#5326            for(ind=clofind+1;ind<formpnt;ind++)                                                               
//#5327            {                                                               
//#5328                fp=&formlst[ind];                                                           
//#5329                if(fp->typ==SAT)                                                           
//#5330                    fp->sacang.sac-=ine;                                                       
//#5331            }                                                               
//#5332            satkad-=ine;                                                               
//#5333        }                                                                   
//#5334    }                                                                       
//#5335                                                                           
//#5336    void satclos(){                                                                       
//#5337                                                                           
//#5338        unsigned    ind,clos,psac;                                                               
//#5339        double        dx,dy,tlen,len=1e99;                                                           
//#5340        SATCON*        tsac;                                                           
//#5341                                                                           
//#5342        uninsf();                                                                   
//#5343        px2stch();                                                                   
//#5344        psac=frmpnt->stpt;                                                                   
//#5345        tsac=frmpnt->sacang.sac;                                                                   
//#5346        clos=xstrt;                                                                   
//#5347        for(ind=0;ind<frmpnt->sids;ind++){                                                                   
//#5348                                                                           
//#5349            dx=sPnt.x-frmpnt->flt[ind].x;                                                               
//#5350            dy=sPnt.y-frmpnt->flt[ind].y;                                                               
//#5351            tlen=hypot(dx,dy);                                                               
//#5352            if(tlen<len){                                                               
//#5353                                                                           
//#5354                len=tlen;                                                           
//#5355                clofine=ind;                                                           
//#5356            }                                                               
//#5357        }                                                                   
//#5358        rstMap(SATCNKT);                                                                   
//#5359        if(frmpnt->typ==LIN){                                                                   
//#5360                                                                           
//#5361            frmpnt->ftyp=CONTF;                                                               
//#5362            clos=clofine;                                                               
//#5363            if(xstrt>clos){                                                               
//#5364                                                                           
//#5365                psac=clos;                                                           
//#5366                clos=xstrt;                                                           
//#5367                xstrt=psac;                                                           
//#5368            }                                                               
//#5369            if(!xstrt)                                                               
//#5370                xstrt++;                                                           
//#5371            if(xstrt==frmpnt->sids-2&&clos==(unsigned)frmpnt->sids-1){                                                               
//#5372                                                                           
//#5373                xstrt=1;                                                           
//#5374                clos=frmpnt->sids-2;                                                           
//#5375            }                                                               
//#5376            if(clos>=(unsigned)frmpnt->sids-2){                                                               
//#5377                                                                           
//#5378                clos=frmpnt->sids-2;                                                           
//#5379                if(xstrt>=(unsigned)frmpnt->sids-2)                                                           
//#5380                    xstrt=frmpnt->sids-2;                                                       
//#5381            }                                                               
//#5382            if(clos-xstrt<2){                                                               
//#5383                                                                           
//#5384                clos=xstrt+2;                                                           
//#5385                if(clos>(unsigned)frmpnt->sids-2){                                                           
//#5386                                                                           
//#5387                    clos=clos-frmpnt->sids-2;                                                       
//#5388                    clos-=clos;                                                       
//#5389                    xstrt-=clos;                                                       
//#5390                }                                                           
//#5391            }                                                               
//#5392            frmpnt->angclp.sat.strt=xstrt;                                                               
//#5393            frmpnt->angclp.sat.fin=clos;                                                               
//#5394        }                                                                   
//#5395        else{                                                                   
//#5396                                                                           
//#5397            if(clofine<clos){                                                               
//#5398                                                                           
//#5399                ind=clofine;                                                           
//#5400                clofine=clos;                                                           
//#5401                clos=ind;                                                           
//#5402            }                                                               
//#5403            if(clos==0&&clofine==(unsigned)sids-1){                                                               
//#5404                                                                           
//#5405                clos=sids-1;                                                           
//#5406                clofine=sids;                                                           
//#5407            }                                                               
//#5408            if(clos==1&&clofine==(unsigned)sids){                                                               
//#5409                                                                           
//#5410                clos=0;                                                           
//#5411                clofine=1;                                                           
//#5412            }                                                               
//#5413            if(clofine-clos==1){                                                               
//#5414                                                                           
//#5415                if(frmpnt->at&FRMEND)                                                           
//#5416                    frmpnt->wpar=clos;                                                       
//#5417                else{                                                           
//#5418                                                                           
//#5419                    if(clos)                                                       
//#5420                        rotfrm(clos);                                                   
//#5421                    frmpnt->at|=FRMEND;                                                       
//#5422                }                                                           
//#5423                satadj();                                                           
//#5424            }                                                               
//#5425            else{                                                               
//#5426                                                                           
//#5427                if(stpt){                                                           
//#5428                                                                           
//#5429                    sacspac(&frmpnt->sacang.sac[frmpnt->stpt],1);                                                       
//#5430                    frmpnt->sacang.sac[frmpnt->stpt].strt=clos;                                                       
//#5431                    frmpnt->sacang.sac[frmpnt->stpt++].fin=clofine;                                                       
//#5432                    satadj();                                                       
//#5433                }                                                           
//#5434                else{                                                           
//#5435                                                                           
//#5436                    frmpnt->sacang.sac=nusac(clofind,1);                                                       
//#5437                    frmpnt->sacang.sac[psac].strt=clos;                                                       
//#5438                    frmpnt->sacang.sac[psac].fin=clofine;                                                       
//#5439                    frmpnt->stpt=1;                                                       
//#5440                }                                                           
//#5441            }                                                               
//#5442        }                                                                   
//#5443    }                                                                       
//#5444                                                                           
//#5445    void satknkt(){                                                                       
//#5446                                                                           
//#5447        satclos();                                                                   
//#5448        fvars(clofind);                                                                   
//#5449        refil();                                                                   
//#5450        setMap(RESTCH);                                                                   
//#5451    }                                                                       
//#5452                                                                           
//#5453    void ritseq1(unsigned ind){                                                                       
//#5454                                                                           
//#5455        bseq[seqpnt].x=flt[ind].x;                                                                   
//#5456        bseq[seqpnt].y=flt[ind].y;                                                                   
//#5457        seqpnt++;                                                                   
//#5458    }                                                                       
//#5459                                                                           
//#5460    void satfn(unsigned astrt,unsigned afin,unsigned bstrt,unsigned bfin){                                                                       
//#5461                                                                           
//#5462        unsigned    anxt,bprv,cnt,ind,acnt,bcnt,ine,inf,tcnt,acind,bcind,pacnt=0,pbcnt=0;                                                               
//#5463        unsigned    asegs,bsegs;                                                               
//#5464        unsigned*    acnts;                                                               
//#5465        unsigned*    bcnts;                                                               
//#5466        double        alen,blen;                                                           
//#5467        DUBPNT        apnt,bpnt,adif,bdif,astp,bstp;                                                           
//#5468                                                                           
//#5469        if(astrt!=afin&&bstrt!=bfin){                                                                   
//#5470                                                                           
//#5471            if(!setMap(SAT1)){                                                               
//#5472                                                                           
//#5473                if(chkMap(FTHR)){                                                           
//#5474                                                                           
//#5475                    bseq[seqpnt].attr=0;                                                       
//#5476                    ritseq1(astrt%sids);                                                       
//#5477                }                                                           
//#5478                else{                                                           
//#5479                                                                           
//#5480                    if(chkMap(BARSAT)){                                                       
//#5481                                                                           
//#5482                        ritseq1(astrt%sids);                                                   
//#5483                        ritseq1(bstrt%sids);                                                   
//#5484                    }                                                       
//#5485                    else{                                                       
//#5486                                                                           
//#5487                        sPnt.x=flt[astrt].x;                                                   
//#5488                        sPnt.y=flt[astrt].y;                                                   
//#5489                        oseq[seqpnt].x=sPnt.x;                                                   
//#5490                        oseq[seqpnt++].y=sPnt.y;                                                   
//#5491                    }                                                       
//#5492                }                                                           
//#5493            }                                                               
//#5494            alen=lens[afin]-lens[astrt];                                                               
//#5495            blen=lens[bstrt]-lens[bfin];                                                               
//#5496            if(fabs(alen)>fabs(blen))                                                               
//#5497                cnt=fabs(blen)/stspace;                                                           
//#5498            else                                                               
//#5499                cnt=fabs(alen)/stspace;                                                           
//#5500    //        asegs=abs(afin-astrt);                                                               
//#5501    //        bsegs=abs(bstrt-bfin);                                                               
//#5502            asegs = abs((int)(afin - astrt)); // xiaoguang                                                               
//#5503            bsegs = abs((int)(bstrt - bfin)); // xiaoguang                                                               
//#5504            acnts=new unsigned[asegs];                                                               
//#5505            bcnts=new unsigned[bsegs];                                                               
//#5506            ine=astrt;                                                               
//#5507            tcnt=0;                                                               
//#5508            for(ind=0;ind<asegs-1;ind++){                                                               
//#5509                                                                           
//#5510                inf=nxt(ine);                                                           
//#5511                acnts[ind]=((lens[inf]-lens[ine])/alen)*cnt+0.5;                                                           
//#5512                tcnt+=acnts[ind];                                                           
//#5513                ine++;                                                           
//#5514            }                                                               
//#5515            acnts[ind]=cnt-tcnt;                                                               
//#5516            ind=bstrt;                                                               
//#5517            ine=prv(ind);                                                               
//#5518            inf=0;                                                               
//#5519            tcnt=0;                                                               
//#5520            while(ine>bfin){                                                               
//#5521                                                                           
//#5522                bcnts[inf]=((lens[ind]-lens[ine])/blen)*cnt+0.5;                                                           
//#5523                tcnt+=bcnts[inf++];                                                           
//#5524                ine=prv(--ind);                                                           
//#5525            }                                                               
//#5526            bcnts[inf]=cnt-tcnt;                                                               
//#5527            apnt.x=flt[astrt].x;                                                               
//#5528            apnt.y=flt[astrt].y;                                                               
//#5529            anxt=nxt(astrt);                                                               
//#5530            bprv=prv(bstrt);                                                               
//#5531            acnt=acnts[pacnt++];                                                               
//#5532            bcnt=bcnts[pbcnt++];                                                               
//#5533            acind=astrt;                                                               
//#5534            bcind=bstrt;                                                               
//#5535            adif.x=flt[anxt].x-flt[acind].x;                                                               
//#5536            adif.y=flt[anxt].y-flt[acind].y;                                                               
//#5537            if(bcind==sids){                                                               
//#5538                                                                           
//#5539                bdif.x=flt[bprv].x-flt[0].x;                                                           
//#5540                bdif.y=flt[bprv].y-flt[0].y;                                                           
//#5541                bpnt.x=flt[0].x;                                                           
//#5542                bpnt.y=flt[0].y;                                                           
//#5543            }                                                               
//#5544            else{                                                               
//#5545                                                                           
//#5546                bdif.x=flt[bprv].x-flt[bcind].x;                                                           
//#5547                bdif.y=flt[bprv].y-flt[bcind].y;                                                           
//#5548                bpnt.x=flt[bcind].x;                                                           
//#5549                bpnt.y=flt[bcind].y;                                                           
//#5550            }                                                               
//#5551            acind=nxt(acind);                                                               
//#5552            bcind=prv(bcind);                                                               
//#5553            astp.x=adif.x/acnt;                                                               
//#5554            astp.y=adif.y/acnt;                                                               
//#5555            bstp.x=bdif.x/bcnt;                                                               
//#5556            bstp.y=bdif.y/bcnt;                                                               
//#5557    nuseg:;                                                                       
//#5558                                                                             
//#5559            if(chkMap(FTHR)){                                                               
//#5560                                                                           
//#5561                while(acnt&&bcnt){                                                           
//#5562                                                                           
//#5563                    apnt.x+=astp.x;                                                       
//#5564                    apnt.y+=astp.y;                                                       
//#5565                    bpnt.x+=bstp.x;                                                       
//#5566                    bpnt.y+=bstp.y;                                                       
//#5567                    if(toglMap(FILDIR)){                                                       
//#5568                                                                           
//#5569                        bseq[seqpnt].attr=0;                                                   
//#5570                        bseq[seqpnt].x=apnt.x;                                                   
//#5571                        bseq[seqpnt++].y=apnt.y;                                                   
//#5572                    }                                                       
//#5573                    else{                                                       
//#5574                                                                           
//#5575                        bseq[seqpnt].attr=1;                                                   
//#5576                        bseq[seqpnt].x=bpnt.x;                                                   
//#5577                        bseq[seqpnt++].y=bpnt.y;                                                   
//#5578                    }                                                       
//#5579                    if(seqpnt>MAXSEQ-6){                                                       
//#5580                                                                           
//#5581                        seqpnt=MAXSEQ-6;                                                   
//#5582                        return;                                                   
//#5583                    }                                                       
//#5584                    acnt--;                                                       
//#5585                    bcnt--;                                                       
//#5586                }                                                           
//#5587            }                                                               
//#5588            else{                                                               
//#5589                                                                           
//#5590                if(chkMap(BARSAT)){                                                           
//#5591                                                                           
//#5592                    while(acnt&&bcnt){                                                       
//#5593                                                                           
//#5594                        apnt.x+=astp.x;                                                   
//#5595                        apnt.y+=astp.y;                                                   
//#5596                        bpnt.x+=bstp.x;                                                   
//#5597                        bpnt.y+=bstp.y;                                                   
//#5598                        if(toglMap(FILDIR)){                                                   
//#5599                                                                           
//#5600                            bseq[seqpnt].attr=0;                                               
//#5601                            bseq[seqpnt].x=apnt.x;                                               
//#5602                            bseq[seqpnt++].y=apnt.y;                                               
//#5603                            bseq[seqpnt].attr=1;                                               
//#5604                            bseq[seqpnt].x=bpnt.x;                                               
//#5605                            bseq[seqpnt++].y=bpnt.y;                                               
//#5606                        }                                                   
//#5607                        else{                                                   
//#5608                                                                           
//#5609                            bseq[seqpnt].attr=2;                                               
//#5610                            bseq[seqpnt].x=bpnt.x;                                               
//#5611                            bseq[seqpnt++].y=bpnt.y;                                               
//#5612                            bseq[seqpnt].attr=3;                                               
//#5613                            bseq[seqpnt].x=apnt.x;                                               
//#5614                            bseq[seqpnt++].y=apnt.y;                                               
//#5615                        }                                                   
//#5616                        if(seqpnt>MAXSEQ-6){                                                   
//#5617                                                                           
//#5618                            seqpnt=MAXSEQ-6;                                               
//#5619                            return;                                               
//#5620                        }                                                   
//#5621                        acnt--;                                                   
//#5622                        bcnt--;                                                   
//#5623                    }                                                       
//#5624                }                                                           
//#5625                else{                                                           
//#5626                                                                           
//#5627                    while(acnt&&bcnt){                                                       
//#5628                                                                           
//#5629                        apnt.x+=astp.x;                                                   
//#5630                        apnt.y+=astp.y;                                                   
//#5631                        bpnt.x+=bstp.x;                                                   
//#5632                        bpnt.y+=bstp.y;                                                   
//#5633                        if(toglMap(FILDIR)){                                                   
//#5634                                                                           
//#5635                            if(chku(SQRFIL))                                               
//#5636                                filinu(bpnt.x,bpnt.y);                                           
//#5637                            filin(apnt);                                               
//#5638                        }                                                   
//#5639                        else{                                                   
//#5640                                                                           
//#5641                            if(chku(SQRFIL))                                               
//#5642                                filinu(apnt.x,apnt.y);                                           
//#5643                            filin(bpnt);                                               
//#5644                        }                                                   
//#5645                        acnt--;                                                   
//#5646                        bcnt--;                                                   
//#5647                    }                                                       
//#5648                }                                                           
//#5649            }                                                               
//#5650            if((pacnt<asegs||pbcnt<bsegs)){                                                               
//#5651                                                                           
//#5652                if(!acnt){                                                           
//#5653                                                                           
//#5654                    acnt=acnts[pacnt++];                                                       
//#5655                    anxt=nxt(acind);                                                       
//#5656                    adif.x=flt[anxt].x-flt[acind].x;                                                       
//#5657                    adif.y=flt[anxt].y-flt[acind].y;                                                       
//#5658                    acind=nxt(acind);                                                       
//#5659                    astp.x=adif.x/acnt;                                                       
//#5660                    astp.y=adif.y/acnt;                                                       
//#5661                }                                                           
//#5662                if(!bcnt){                                                           
//#5663                                                                           
//#5664                    bcnt=bcnts[pbcnt++];                                                       
//#5665                    bprv=prv(bcind);                                                       
//#5666                    bdif.x=flt[bprv].x-flt[bcind].x;                                                       
//#5667                    bdif.y=flt[bprv].y-flt[bcind].y;                                                       
//#5668                    bcind=prv(bcind);                                                       
//#5669                    bstp.x=bdif.x/bcnt;                                                       
//#5670                    bstp.y=bdif.y/bcnt;                                                       
//#5671                }                                                           
//#5672                if((acnt||bcnt)&&acnt<MAXSEQ&&bcnt<MAXSEQ)                                                           
//#5673                    goto nuseg;                                                       
//#5674            }                                                               
//#5675            delete acnts;                                                               
//#5676            delete bcnts;                                                               
//#5677        }                                                                   
//#5678    }                                                                       
//#5679                                                                           
//#5680    void satmf(){                                                                       
//#5681                                                                           
//#5682        unsigned    ind,ine;                                                               
//#5683        double        len,dx,dy;                                                           
//#5684                                                                           
//#5685        ind=0;                                                                   
//#5686        if(frmpnt->at&FRMEND)                                                                   
//#5687            ind=1;                                                               
//#5688        satfn(ind,sac[0].strt,sids,sac[0].fin);                                                                   
//#5689        for(ind=0;ind<(unsigned)stpt-1;ind++)                                                                   
//#5690            satfn(sac[ind].strt,sac[ind+1].strt,sac[ind].fin,sac[ind+1].fin);                                                               
//#5691        if(wpar)                                                                   
//#5692            satfn(sac[ind].strt,wpar,sac[ind].fin,wpar+1);                                                               
//#5693        else{                                                                   
//#5694                                                                           
//#5695            if(sac[ind].fin-sac[ind].strt>2){                                                               
//#5696                                                                           
//#5697                len=(lens[sac[ind].fin]-lens[sac[ind].strt])/2+lens[sac[ind].strt];                                                           
//#5698                ine=sac[ind].strt;                                                           
//#5699                while(len>lens[ine])                                                           
//#5700                    ine++;                                                       
//#5701                dx=lens[ine]-len;                                                           
//#5702                dy=len-lens[ine-1];                                                           
//#5703                if(dy>dx)                                                           
//#5704                    ine--;                                                       
//#5705                satfn(sac[ind].strt,ine,sac[ind].fin,ine);                                                           
//#5706            }                                                               
//#5707            else                                                               
//#5708                satfn(sac[ind].strt,sac[ind].strt+1,sac[ind].fin,sac[ind].strt+1);                                                           
//#5709        }                                                                   
//#5710    }                                                                       
//#5711                                                                           
//#5712    extern void prbug();                                                                       
//#5713                                                                           
//#5714    void satfil(){                                                                       
//#5715                                                                           
//#5716        unsigned        ind;                                                           
//#5717        double            len,dx,dy;                                                       
//#5718        double            tspac;                                                       
//#5719                                                                           
//#5720        fvars(clofind);                                                                   
//#5721        satadj();                                                                   
//#5722        tspac=stspace;                                                                   
//#5723        stspace/=2;                                                                   
//#5724        seqpnt=0;                                                                   
//#5725        rstMap(SAT1);                                                                   
//#5726        rstMap(FILDIR);                                                                   
//#5727        frmpnt->ftyp=SATF;                                                                   
//#5728        lens=new double[sids+1];                                                                   
//#5729        len=0;                                                                   
//#5730        for(ind=0;ind<(unsigned)sids-1;ind++){                                                                   
//#5731                                                                           
//#5732            lens[ind]=len;                                                               
//#5733            dx=flt[ind+1].x-flt[ind].x;                                                               
//#5734            dy=flt[ind+1].y-flt[ind].y;                                                               
//#5735            len+=hypot(dx,dy);                                                               
//#5736        }                                                                   
//#5737        lens[ind]=len;                                                                   
//#5738        dx=flt[0].x-flt[ind].x;                                                                   
//#5739        dy=flt[0].y-flt[ind].y;                                                                   
//#5740        len+=hypot(dx,dy);                                                                   
//#5741        lens[ind+1]=len;                                                                   
//#5742        if(wpar){                                                                   
//#5743                                                                           
//#5744            if(stpt){                                                               
//#5745                                                                           
//#5746                satmf();                                                           
//#5747                goto satdun;                                                           
//#5748            }                                                               
//#5749            else{                                                               
//#5750                                                                           
//#5751                satfn(1,wpar,sids,wpar+1);                                                           
//#5752                goto satdun;                                                           
//#5753            }                                                               
//#5754        }                                                                   
//#5755        if(frmpnt->at&FRMEND){                                                                   
//#5756                                                                           
//#5757            if(stpt){                                                               
//#5758                                                                           
//#5759                satmf();                                                           
//#5760                goto satdun;                                                           
//#5761            }                                                               
//#5762            else{                                                               
//#5763                                                                           
//#5764                if(sids==3&&formlst[clofind].at&1){                                                           
//#5765                                                                           
//#5766                    satfn(2,3,2,1);                                                       
//#5767                    goto satdun;                                                       
//#5768                }                                                           
//#5769                else{                                                           
//#5770                                                                           
//#5771                    len=(len-lens[1])/2;                                                       
//#5772                    ind=1;                                                       
//#5773                    if(!chkMap(BARSAT)){                                                       
//#5774                                                                           
//#5775                        oseq[0].x=sPnt.x=flt[1].x;                                                   
//#5776                        oseq[0].y=sPnt.y=flt[1].y;                                                   
//#5777                        seqpnt=1;                                                   
//#5778                    }                                                       
//#5779                    while(len>lens[ind])                                                       
//#5780                        ind++;                                                   
//#5781                    dx=lens[ind]-len;                                                       
//#5782                    dy=len-lens[ind-1];                                                       
//#5783                    if(dy>dx)                                                       
//#5784                        ind--;                                                   
//#5785                    satfn(1,ind,sids,ind);                                                       
//#5786                }                                                           
//#5787                goto satdun;                                                           
//#5788            }                                                               
//#5789        }                                                                   
//#5790        if(stpt){                                                                   
//#5791                                                                           
//#5792            satmf();                                                               
//#5793            goto satdun;                                                               
//#5794        }                                                                   
//#5795        len/=2;                                                                   
//#5796        ind=0;                                                                   
//#5797        if(!chkMap(BARSAT)&&!chkMap(FTHR)){                                                                   
//#5798                                                                           
//#5799            oseq[0].x=sPnt.x=flt[0].x;                                                               
//#5800            oseq[0].y=sPnt.y=flt[0].y;                                                               
//#5801            seqpnt=1;                                                               
//#5802        }                                                                   
//#5803        while(len>lens[ind])                                                                   
//#5804            ind++;                                                               
//#5805        dx=lens[ind]-len;                                                                   
//#5806        dy=len-lens[ind-1];                                                                   
//#5807        if(dy>dx)                                                                   
//#5808            ind--;                                                               
//#5809        satfn(0,ind,sids,ind);                                                                   
//#5810    satdun:;                                                                       
//#5811                                                                           
//#5812        delete lens;                                                                   
//#5813        stspace=tspac;                                                                   
//#5814    }                                                                       
//#5815                                                                           
//#5816    void filsfn(){                                                                       
//#5817                                                                           
//#5818        delmclp(clofind);                                                                   
//#5819        deltx();                                                                   
//#5820        frmpnt->typ=SAT;                                                                   
//#5821        fsizpar();                                                                   
//#5822        frmpnt->ftyp=SATF;                                                                   
//#5823        frmpnt->fcol=actcol;                                                                   
//#5824        frmpnt->fspac=stspace;                                                                   
//#5825        frmpnt->typ=SAT;                                                                   
//#5826        refilfn();                                                                   
//#5827    }                                                                       
//#5828                                                                           
//#5829    void filsat(){                                                                       
//#5830                                                                           
//#5831        unsigned ind;                                                                   
//#5832                                                                           
//#5833        if(filmsgs(FMM_FAN))                                                                   
//#5834            return;                                                               
//#5835        if(fselpnt){                                                                   
//#5836                                                                           
//#5837            savdo();                                                               
//#5838            for(ind=0;ind<fselpnt;ind++){                                                               
//#5839                                                                           
//#5840                clofind=selist[ind];                                                           
//#5841                fvars(clofind);                                                           
//#5842                if(frmpnt->typ!=LIN)                                                           
//#5843                    filsfn();                                                       
//#5844            }                                                               
//#5845            setMap(INIT);                                                               
//#5846            coltab();                                                               
//#5847            setMap(RESTCH);                                                               
//#5848        }                                                                   
//#5849        else{                                                                   
//#5850                                                                           
//#5851            if(chkMap(FORMSEL)){                                                               
//#5852                                                                           
//#5853                savdo();                                                           
//#5854                filsfn();                                                           
//#5855                setMap(INIT);                                                           
//#5856                coltab();                                                           
//#5857                setMap(RESTCH);                                                           
//#5858            }                                                               
//#5859        }                                                                   
//#5860    }                                                                       
//#5861                                                                           
//#5862    unsigned closat(){                                                                       
//#5863                                                                           
//#5864        unsigned    ind,ine;                                                               
//#5865        double        len=1e99,tlen,dx,dy;                                                           
//#5866                                                                           
//#5867        px2stch();                                                                   
//#5868        for(ind=0;ind<formpnt;ind++){                                                                   
//#5869                                                                           
//#5870            if(!actl||(unsigned)((formlst[ind].at&FRMLMSK)>>1)==actl||!(formlst[ind].at&FRMLMSK)){                                                               
//#5871                                                                           
//#5872                flt=formlst[ind].flt;                                                           
//#5873                for(ine=0;ine<formlst[ind].sids;ine++){                                                           
//#5874                                                                           
//#5875                    dx=sPnt.x-flt[ine].x;                                                       
//#5876                    dy=sPnt.y-flt[ine].y;                                                       
//#5877                    tlen=hypot(dx,dy);                                                       
//#5878                    if(tlen<len){                                                       
//#5879                                                                           
//#5880                        len=tlen;                                                   
//#5881                        clofind=ind;                                                   
//#5882                        clofine=ine;                                                   
//#5883                    }                                                       
//#5884                }                                                           
//#5885            }                                                               
//#5886        }                                                                   
//#5887        if(len==1e99)                                                                   
//#5888            return 0;                                                               
//#5889        else                                                                   
//#5890            return 1;                                                               
//#5891    }                                                                       
//#5892                                                                           
//#5893    void nufpnt(unsigned pnu){                                                                       
//#5894                                                                           
//#5895        unsigned ind;                                                                   
//#5896                                                                           
//#5897        pnu++;                                                                   
//#5898        fltspac(&finspnt->flt[pnu],1);                                                                   
//#5899        finspnt->flt[pnu].x=sPnt.x;                                                                   
//#5900        finspnt->flt[pnu].y=sPnt.y;                                                                   
//#5901        finspnt->sids++;                                                                   
//#5902        for(ind=0;ind<finspnt->stpt;ind++){                                                                   
//#5903                                                                           
//#5904            if(finspnt->sacang.sac[ind].strt>pnu-1)                                                               
//#5905                finspnt->sacang.sac[ind].strt++;                                                           
//#5906            if(finspnt->sacang.sac[ind].fin>pnu-1)                                                               
//#5907                finspnt->sacang.sac[ind].fin++;                                                           
//#5908        }                                                                   
//#5909        if(finspnt->wpar>=pnu){                                                                   
//#5910                                                                           
//#5911            finspnt->wpar++;                                                               
//#5912            finspnt->wpar%=sids;                                                               
//#5913        }                                                                   
//#5914        if(finspnt->ftyp==CONTF){                                                                   
//#5915                                                                           
//#5916            if(finspnt->angclp.sat.strt>pnu-1)                                                               
//#5917                finspnt->angclp.sat.strt++;                                                           
//#5918            if(finspnt->angclp.sat.fin>pnu-1)                                                               
//#5919                finspnt->angclp.sat.fin++;                                                           
//#5920        }                                                                   
//#5921        frmlin(finspnt->flt,finspnt->sids);                                                                   
//#5922    }                                                                       
//#5923                                                                           
//#5924    double p2p(FLPNT pnt0,FLPNT pnt1){                                                                       
//#5925                                                                           
//#5926        return hypot(pnt0.x-pnt1.x,pnt0.y-pnt1.y);                                                                   
//#5927    }                                                                       
//#5928                                                                           
//#5929    unsigned upsat(){                                                                       
//#5930                                                                           
//#5931        unsigned    ind;                                                               
//#5932        double        dwnlen,uplen,p2clos,p2up,p2dwn;                                                           
//#5933                                                                           
//#5934        sids=finspnt->sids;                                                                   
//#5935        flt=finspnt->flt;                                                                   
//#5936        p2clos=p2p(sPnt,flt[clofine]);                                                                   
//#5937        ind=prv(clofine);                                                                   
//#5938        dwnlen=p2p(flt[ind],flt[clofine]);                                                                   
//#5939        p2dwn=p2p(flt[ind],sPnt);                                                                   
//#5940        ind=nxt(clofine);                                                                   
//#5941        uplen=p2p(flt[ind],flt[clofine]);                                                                   
//#5942        p2up=p2p(flt[ind],sPnt);                                                                   
//#5943        if((p2dwn+p2clos)/dwnlen>(p2up+p2clos)/uplen)                                                                   
//#5944            return 0;                                                               
//#5945        else{                                                                   
//#5946                                                                           
//#5947            return 1;                                                               
//#5948        }                                                                   
//#5949    }                                                                       
//#5950                                                                           
//#5951    void insat(){                                                                       
//#5952                                                                           
//#5953        if(closat()){                                                                   
//#5954                                                                           
//#5955            savdo();                                                               
//#5956            frmpnt=&formlst[clofind];                                                               
//#5957            finspnt=frmpnt;                                                               
//#5958            fvars(clofind);                                                               
//#5959            if(upsat()){                                                               
//#5960                                                                           
//#5961                if(!clofine&&finspnt->typ==LIN)                                                           
//#5962                    setMap(PRELIN);                                                       
//#5963                else                                                           
//#5964                    clofine=prv(clofine);                                                       
//#5965                nufpnt(clofine);                                                           
//#5966                if(rstMap(PRELIN)){                                                           
//#5967                                                                           
//#5968                    sPnt.x=finspnt->flt[0].x;                                                       
//#5969                    sPnt.y=finspnt->flt[0].y;                                                       
//#5970                    finspnt->flt[0].x=finspnt->flt[1].x;                                                       
//#5971                    finspnt->flt[0].y=finspnt->flt[1].y;                                                       
//#5972                    finspnt->flt[1].x=sPnt.x;                                                       
//#5973                    finspnt->flt[1].y=sPnt.y;                                                       
//#5974                }                                                           
//#5975            }                                                               
//#5976            else                                                               
//#5977                nufpnt(clofine);                                                           
//#5978            refil();                                                               
//#5979        }                                                                   
//#5980        setMap(RESTCH);                                                                   
//#5981    }                                                                       
//#5982                                                                           
//#5983    BOOL chkdel(){                                                                       
//#5984                                                                           
//#5985        if(frmpnt->typ==LIN){                                                                   
//#5986                                                                           
//#5987            if(frmpnt->sids>2)                                                               
//#5988                return 0;                                                           
//#5989            else                                                               
//#5990                return 1;                                                           
//#5991        }                                                                   
//#5992        else{                                                                   
//#5993                                                                           
//#5994            if(frmpnt->sids>3)                                                               
//#5995                return 0;                                                           
//#5996            else                                                               
//#5997                return 1;                                                           
//#5998        }                                                                   
//#5999    }                                                                       
//#6000                                                                           
//#6001    void delspnt(){                                                                       
//#6002                                                                           
//#6003        unsigned    ind,ine;                                                               
//#6004        SATCON*        sac;                                                           
//#6005        FLPNT*        tflt;                                                           
//#6006        FRMHED*    fp;                                                               
//#6007                                                                           
//#6008        fvars(clofind);                                                                   
//#6009        if(chkdel()){                                                                   
//#6010                                                                           
//#6011            setMap(DELTO);                                                               
//#6012            frmdel();                                                               
//#6013            rstMap(FRMPSEL);                                                               
//#6014            coltab();                                                               
//#6015            setMap(RESTCH);                                                               
//#6016            return;                                                               
//#6017        }                                                                   
//#6018        if(frmpnt->typ==SAT){                                                                   
//#6019                                                                           
//#6020            if(clofine<frmpnt->wpar)                                                               
//#6021                frmpnt->wpar--;                                                           
//#6022            if(frmpnt->stpt){                                                               
//#6023                                                                           
//#6024                sac=frmpnt->sacang.sac;                                                           
//#6025                ind=0;                                                           
//#6026                while(sac[ind].strt!=clofine&&sac[ind].fin!=clofine&&ind<frmpnt->stpt)                                                           
//#6027                    ind++;                                                       
//#6028                if(ind<frmpnt->stpt&&(sac[ind].strt==clofine||sac[ind].fin==clofine)){                                                           
//#6029                                                                           
//#6030                    while(ind<frmpnt->stpt){                                                       
//#6031                                                                           
//#6032                        sac[ind].strt=sac[ind+1].strt;                                                   
//#6033                        sac[ind].fin=sac[ind+1].fin;                                                   
//#6034                        ind++;                                                   
//#6035                    }                                                       
//#6036                    frmpnt->stpt--;                                                       
//#6037                    satkad--;                                                       
//#6038                    for(ine=clofind+1;ine<formpnt;ine++)                                                       
//#6039                    {                                                       
//#6040                        fp=&formlst[ine];                                                   
//#6041                        if(fp->typ==SAT&&fp->stpt)                                                   
//#6042                            fp->sacang.sac++;                                               
//#6043                    }                                                       
//#6044                }                                                           
//#6045                for(ind=0;ind<frmpnt->stpt;ind++){                                                           
//#6046                                                                           
//#6047                    if(sac[ind].strt>clofine)                                                       
//#6048                        sac[ind].strt--;                                                   
//#6049                    if(sac[ind].fin>clofine)                                                       
//#6050                        sac[ind].fin--;                                                   
//#6051                }                                                           
//#6052            }                                                               
//#6053        }                                                                   
//#6054        MoveMemory(&frmpnt->flt[clofine],&frmpnt->flt[clofine+1],(fltad-clofine)*sizeof(SHRTPNT));                                                                   
//#6055        frmpnt->sids--;                                                                   
//#6056        fltad--;                                                                   
//#6057        fvars(clofind);                                                                   
//#6058        if(clofine>(unsigned)frmpnt->sids-1)                                                                   
//#6059            clofine=frmpnt->sids-1;                                                               
//#6060        setMap(FRMPSEL);                                                                   
//#6061        for(ind=clofind+1;ind<formpnt;ind++)                                                                   
//#6062            formlst[ind].flt--;                                                               
//#6063        ritfcor(&flt[clofine]);                                                                   
//#6064        ritnum(STR_NUMPNT,clofine);                                                                   
//#6065        frmout(clofind);                                                                   
//#6066        tflt=&frmpnt->flt[clofine];                                                                   
//#6067        if(tflt->x<zRct.left||tflt->x>zRct.right||tflt->y<zRct.bottom||tflt->y>zRct.top)                                                                   
//#6068            shft(frmpnt->flt[clofine]);                                                               
//#6069        refil();                                                                   
//#6070    }                                                                       
//#6071                                                                           
//#6072    void unfil(){                                                                       
//#6073                                                                           
//#6074        unsigned src,dst,trg,at;                                                                   
//#6075        unsigned mlen;                                                                   
//#6076                                                                           
//#6077        if(filmsgs(FMX_UNF))                                                                   
//#6078            return;                                                               
//#6079        if(fselpnt){                                                                   
//#6080                                                                           
//#6081            mlen=(fselpnt>>5)+1;                                                               
//#6082            for(src=0;src<mlen;src++)                                                               
//#6083                rmap[src]=0;                                                           
//#6084            for(src=0;src<fselpnt;src++){                                                               
//#6085                                                                           
//#6086                frmpnt=&formlst[selist[src]];                                                           
//#6087                if(frmpnt->ftyp||frmpnt->etyp){                                                           
//#6088                                                                           
//#6089                    delclps(selist[src]);                                                       
//#6090                    deltx();                                                       
//#6091                    setr(selist[src]);                                                       
//#6092                    frmpnt->ftyp=0;                                                       
//#6093                    frmpnt->etyp=0;                                                       
//#6094                    frmpnt->xat&=!(AT_UND|AT_CWLK|AT_WALK);                                                       
//#6095                }                                                           
//#6096            }                                                               
//#6097            dst=0;                                                               
//#6098            for(src=0;src<hed.stchs;src++){                                                               
//#6099                                                                           
//#6100                if(!chkr((stchs[src].at&FRMSK)>>FRMSHFT)){                                                           
//#6101                                                                           
//#6102                    stchs[dst].at=stchs[src].at;                                                       
//#6103                    stchs[dst].x=stchs[src].x;                                                       
//#6104                    stchs[dst++].y=stchs[src].y;                                                       
//#6105                }                                                           
//#6106            }                                                               
//#6107            hed.stchs=dst;                                                               
//#6108            coltab();                                                               
//#6109            setMap(RESTCH);                                                               
//#6110        }                                                                   
//#6111        else{                                                                   
//#6112                                                                           
//#6113            if(chkMap(FORMSEL)){                                                               
//#6114                                                                           
//#6115                if(!rstMap(IGNOR)&&!chku(WRNOF)){                                                           
//#6116                                                                           
//#6117                    trg=(clofind<<FRMSHFT)|USMSK;                                                       
//#6118                    mlen=stchs[0].at&(FRMSK|USMSK);                                                       
//#6119                    for(src=0;src<hed.stchs;src++){                                                       
//#6120                                                                           
//#6121                        at=stchs[src].at;                                                   
//#6122                        if(!(at&NOTFRM)&&(at&(USMSK|FRMSK))==trg){                                                   
//#6123                                                                           
//#6124                            tabmsg(IDS_UNFIL);                                               
//#6125                            setMap(FILMSG);                                               
//#6126                            okcan();                                               
//#6127                            setMap(IGNOR);                                               
//#6128                            bakpnt.x=msg.pt.x;                                               
//#6129                            bakpnt.y=msg.pt.y;                                               
//#6130                            return;                                               
//#6131                        }                                                   
//#6132                    }                                                       
//#6133                }                                                           
//#6134                trg=clofind<<FRMSHFT;                                                           
//#6135                dst=0;                                                           
//#6136                for(src=0;src<hed.stchs;src++){                                                           
//#6137                                                                           
//#6138                    if((stchs[src].at&FRMSK)!=trg||(stchs[src].at&NOTFRM)){                                                       
//#6139                                                                           
//#6140                        stchs[dst].at=stchs[src].at;                                                   
//#6141                        stchs[dst].x=stchs[src].x;                                                   
//#6142                        stchs[dst++].y=stchs[src].y;                                                   
//#6143                    }                                                       
//#6144                }                                                           
//#6145                delclps(clofind);                                                           
//#6146                deltx();                                                           
//#6147                frmpnt->ftyp=0;                                                           
//#6148                frmpnt->etyp=0;                                                           
//#6149                frmpnt->xat&=!(AT_UND|AT_CWLK|AT_WALK);                                                           
//#6150                hed.stchs=dst;                                                           
//#6151                ritot(hed.stchs);                                                           
//#6152            }                                                               
//#6153        }                                                                   
//#6154    }                                                                       
//#6155                                                                           
//#6156    void satzum(){                                                                       
//#6157                                                                           
//#6158        rstMap(SHOSAT);                                                                   
//#6159        duzrat();                                                                   
//#6160        sids=satpt;                                                                   
//#6161        frmlin(tpoly,satpt);                                                                   
//#6162        SetROP2(sdc,R2_XORPEN);                                                                   
//#6163        SelectObject(sdc,fPen);                                                                   
//#6164        Polyline(sdc,flin,satpt);                                                                   
//#6165        SetROP2(sdc,R2_COPYPEN);                                                                   
//#6166        drwsat();                                                                   
//#6167    }                                                                       
//#6168                                                                           
//#6169    void rotfrm(unsigned nu0){                                                                       
//#6170                                                                           
//#6171        FLPNT*            flt0;                                                       
//#6172        FLPNT*            flt1;                                                       
//#6173        SATCON*            nsac;                                                       
//#6174        SATCON**        psac;                                                           
//#6175        unsigned        ind,ine,xpnt=nu0;                                                           
//#6176        unsigned short    tlin;                                                               
//#6177                                                                           
//#6178        fvars(clofind);                                                                   
//#6179        flt0=frmpnt->flt;                                                                   
//#6180        sids=frmpnt->sids;                                                                   
//#6181        flt1=new FLPNT[sids];                                                                   
//#6182        for(ind=0;ind<sids;ind++){                                                                   
//#6183                                                                           
//#6184            flt1[ind].x=flt0[ind].x;                                                               
//#6185            flt1[ind].y=flt0[ind].y;                                                               
//#6186        }                                                                   
//#6187        for(ind=0;ind<sids;ind++){                                                                   
//#6188                                                                           
//#6189            flt0[ind].x=flt1[xpnt].x;                                                               
//#6190            flt0[ind].y=flt1[xpnt].y;                                                               
//#6191            xpnt=nxt(xpnt);                                                               
//#6192        }                                                                   
//#6193        ine=0;                                                                   
//#6194        if(frmpnt->typ==SAT){                                                                   
//#6195                                                                           
//#6196            if(frmpnt->wpar)                                                               
//#6197                frmpnt->wpar=(frmpnt->wpar+frmpnt->sids                                                           
//#6198                    -nu0)%frmpnt->sids;                                                       
//#6199            for(ind=0;ind<frmpnt->stpt;ind++){                                                               
//#6200                                                                           
//#6201                if(sac[ind].strt!=nu0&&sac[ind].fin!=nu0){                                                           
//#6202                                                                           
//#6203                    sac[ine].strt=(sac[ind].strt+sids-nu0)%sids;                                                       
//#6204                    sac[ine].fin=(sac[ind].fin+sids-nu0)%sids;                                                       
//#6205                    if(sac[ine].strt>sac[ine].fin){                                                       
//#6206                                                                           
//#6207                        tlin=sac[ine].strt;                                                   
//#6208                        sac[ine].strt=sac[ine].fin;                                                   
//#6209                        sac[ind].fin=tlin;                                                   
//#6210                    }                                                       
//#6211                    ine++;                                                       
//#6212                }                                                           
//#6213            }                                                               
//#6214        }                                                                   
//#6215        frmpnt->stpt=ine;                                                                   
//#6216        psac=new SATCON*[ine];                                                                   
//#6217        nsac=new SATCON[ine];                                                                   
//#6218        for(ind=0;ind<ine;ind++){                                                                   
//#6219                                                                           
//#6220            psac[ind]=&nsac[ind];                                                               
//#6221            nsac[ind].strt=sac[ind].strt;                                                               
//#6222            nsac[ind].fin=sac[ind].fin;                                                               
//#6223        }                                                                   
//#6224        qsort((void*)psac,ine,4,scomp);                                                                   
//#6225        for(ind=0;ind<ine;ind++){                                                                   
//#6226                                                                           
//#6227            sac[ind].strt=psac[ind]->strt;                                                               
//#6228            sac[ind].fin=psac[ind]->fin;                                                               
//#6229        }                                                                   
//#6230        if(frmpnt->xat&AT_STRT)                                                                   
//#6231            frmpnt->strt=(frmpnt->strt+sids-nu0)%sids;                                                               
//#6232        if(frmpnt->xat&AT_END)                                                                   
//#6233            frmpnt->end=(frmpnt->end+sids-nu0)%sids;                                                               
//#6234        delete flt1;                                                                   
//#6235        delete nsac;                                                                   
//#6236        delete psac;                                                                   
//#6237    }                                                                       
//#6238                                                                           
//#6239                                                                           
//#6240    void frm0(){                                                                       
//#6241                                                                           
//#6242        if(chkMap(FRMPSEL)){                                                                   
//#6243                                                                           
//#6244            savdo();                                                               
//#6245            rotfrm(clofine);                                                               
//#6246            clofine=0;                                                               
//#6247            satadj();                                                               
//#6248            refil();                                                               
//#6249            coltab();                                                               
//#6250            setMap(RESTCH);                                                               
//#6251        }                                                                   
//#6252    }                                                                       
//#6253                                                                           
//#6254    void duinsf(){                                                                       
//#6255                                                                           
//#6256        SetROP2(rsdc,R2_XORPEN);                                                                   
//#6257        SelectObject(rsdc,fPen);                                                                   
//#6258        Polyline(rsdc,inlin,2);                                                                   
//#6259        SetROP2(rsdc,R2_COPYPEN);                                                                   
//#6260    }                                                                       
//#6261                                                                           
//#6262    void uninsf(){                                                                       
//#6263                                                                           
//#6264        if(rstMap(SHOINSF))                                                                   
//#6265            duinsf();                                                               
//#6266    }                                                                       
//#6267                                                                           
//#6268    void rinfrm(){                                                                       
//#6269                                                                           
//#6270        frmlin(finspnt->flt,finspnt->sids);                                                                   
//#6271        SelectObject(sdc,fPen);                                                                   
//#6272        SetROP2(sdc,R2_XORPEN);                                                                   
//#6273        if(fgpnt1||finspnt->typ!=LIN)                                                                   
//#6274            Polyline(sdc,&flin[fgpnt0],2);                                                               
//#6275        inlin[0].x=flin[fgpnt0].x;                                                                   
//#6276        inlin[0].y=flin[fgpnt0].y;                                                                   
//#6277        inlin[1].x=msg.pt.x-stOrg.x;                                                                   
//#6278        inlin[1].y=msg.pt.y-stOrg.y;                                                                   
//#6279        setMap(SHOINSF);                                                                   
//#6280        duinsf();                                                                   
//#6281    }                                                                       
//#6282                                                                           
//#6283    void infrm(){                                                                       
//#6284                                                                           
//#6285        if(closat()){                                                                   
//#6286                                                                           
//#6287            finspnt=&formlst[clofind];                                                               
//#6288            fvars(clofind);                                                               
//#6289            if(upsat()){                                                               
//#6290                                                                           
//#6291                if(!clofine&&finspnt->typ==LIN){                                                           
//#6292                                                                           
//#6293                    fgpnt0=0;                                                       
//#6294                    setMap(PRELIN);                                                       
//#6295                }                                                           
//#6296                else{                                                           
//#6297                                                                           
//#6298                    fgpnt0=prv(clofine);                                                       
//#6299                    fgpnt1=clofine;                                                       
//#6300                }                                                           
//#6301            }                                                               
//#6302            else{                                                               
//#6303                                                                           
//#6304                fgpnt0=clofine;                                                           
//#6305                fgpnt1=nxt(clofine);                                                           
//#6306            }                                                               
//#6307            setMap(INSFRM);                                                               
//#6308            setMap(INIT);                                                               
//#6309            rinfrm();                                                               
//#6310        }                                                                   
//#6311    }                                                                       
//#6312                                                                           
//#6313    void setins(){                                                                       
//#6314                                                                           
//#6315        px2stch();                                                                   
//#6316        nufpnt(fgpnt0);                                                                   
//#6317        if(chkMap(PRELIN)){                                                                   
//#6318                                                                           
//#6319            sPnt.x=finspnt->flt[0].x;                                                               
//#6320            sPnt.y=finspnt->flt[0].y;                                                               
//#6321            finspnt->flt[0].x=finspnt->flt[1].x;                                                               
//#6322            finspnt->flt[0].y=finspnt->flt[1].y;                                                               
//#6323            finspnt->flt[1].x=sPnt.x;                                                               
//#6324            finspnt->flt[1].y=sPnt.y;                                                               
//#6325        }                                                                   
//#6326        else{                                                                   
//#6327                                                                           
//#6328            sids=finspnt->sids;                                                               
//#6329            fgpnt0=nxt(fgpnt0);                                                               
//#6330            fgpnt1=nxt(fgpnt0);                                                               
//#6331        }                                                                   
//#6332        frmlin(finspnt->flt,finspnt->sids);                                                                   
//#6333        inlin[0].x=flin[fgpnt0].x;                                                                   
//#6334        inlin[0].y=flin[fgpnt0].y;                                                                   
//#6335        inlin[1].x=msg.pt.x-stOrg.x;                                                                   
//#6336        inlin[1].y=msg.pt.y-stOrg.y;                                                                   
//#6337        setMap(INSFRM);                                                                   
//#6338        duinsf();                                                                   
//#6339        setMap(RESTCH);                                                                   
//#6340    }                                                                       
//#6341                                                                           
//#6342    void bdrlin(unsigned strt,unsigned fin,double siz){                                                                       
//#6343                                                                           
//#6344        DUBPNT        dif,stp,pnt;                                                           
//#6345        double        len,tang;                                                           
//#6346        unsigned    cnt;                                                               
//#6347                                                                           
//#6348        _asm finit;                                                                   
//#6349        dif.x=flt[fin].x-flt[strt].x;                                                                   
//#6350        dif.y=flt[fin].y-flt[strt].y;                                                                   
//#6351        len=hypot(dif.x,dif.y);                                                                   
//#6352        if(chku(LINSPAC)){                                                                   
//#6353                                                                           
//#6354            cnt=len/siz+0.5;                                                               
//#6355            if(cnt){                                                               
//#6356                                                                           
//#6357                stp.x=dif.x/cnt;                                                           
//#6358                stp.y=dif.y/cnt;                                                           
//#6359            }                                                               
//#6360        }                                                                   
//#6361        else{                                                                   
//#6362                                                                           
//#6363            cnt=(len-siz/2)/siz+1;                                                               
//#6364            tang=atan2(dif.y,dif.x);                                                               
//#6365            stp.x=cos(tang)*siz;                                                               
//#6366            stp.y=sin(tang)*siz;                                                               
//#6367        }                                                                   
//#6368        if(cnt){                                                                   
//#6369                                                                           
//#6370            pnt.x=flt[strt].x+stp.x;                                                               
//#6371            pnt.y=flt[strt].y+stp.y;                                                               
//#6372            cnt--;                                                               
//#6373            while(cnt){                                                               
//#6374                                                                           
//#6375                oseq[seqpnt].x=pnt.x;                                                           
//#6376                oseq[seqpnt++].y=pnt.y;                                                           
//#6377                pnt.x+=stp.x;                                                           
//#6378                pnt.y+=stp.y;                                                           
//#6379                cnt--;                                                           
//#6380            }                                                               
//#6381        }                                                                   
//#6382        oseq[seqpnt].x=flt[fin].x;                                                                   
//#6383        oseq[seqpnt++].y=flt[fin].y;                                                                   
//#6384    }                                                                       
//#6385                                                                           
//#6386    void brdfil(double siz){                                                                       
//#6387                                                                           
//#6388        unsigned        ind;                                                           
//#6389        unsigned short    nlin,tlin;                                                               
//#6390                                                                           
//#6391        if(frmpnt->xat&AT_STRT)                                                                   
//#6392            tlin=frmpnt->strt;                                                               
//#6393        else                                                                   
//#6394            tlin=getlast();                                                               
//#6395        seqpnt=0;                                                                   
//#6396        oseq[seqpnt].x=flt[tlin].x;                                                                   
//#6397        oseq[seqpnt++].y=flt[tlin].y;                                                                   
//#6398        for(ind=0;ind<(unsigned)sids-1;ind++){                                                                   
//#6399                                                                           
//#6400            nlin=nxt(tlin);                                                               
//#6401            bdrlin(tlin,nlin,siz);                                                               
//#6402            tlin=nlin;                                                               
//#6403        }                                                                   
//#6404        if(frmpnt->typ!=LIN){                                                                   
//#6405                                                                           
//#6406            nlin=nxt(tlin);                                                               
//#6407            bdrlin(tlin,nlin,siz);                                                               
//#6408        }                                                                   
//#6409    }                                                                       
//#6410                                                                           
//#6411    void bsizpar(){                                                                       
//#6412                                                                           
//#6413        frmpnt->emax=ini.maxsiz;                                                                   
//#6414        frmpnt->elen=usesiz;                                                                   
//#6415        frmpnt->emin=minsiz;                                                                   
//#6416    }                                                                       
//#6417                                                                           
//#6418    void sbord(){                                                                       
//#6419                                                                           
//#6420        fvars(clofind);                                                                   
//#6421        deleclp(clofind);                                                                   
//#6422        frmpnt->etyp=EGLIN;                                                                   
//#6423        bsizpar();                                                                   
//#6424        refilfn();                                                                   
//#6425    }                                                                       
//#6426                                                                           
//#6427    void bord(){                                                                       
//#6428                                                                           
//#6429        unsigned ind;                                                                   
//#6430                                                                           
//#6431        if(filmsgs(FML_LIN))                                                                   
//#6432            return;                                                               
//#6433        if(fselpnt){                                                                   
//#6434                                                                           
//#6435            for(ind=0;ind<fselpnt;ind++){                                                               
//#6436                                                                           
//#6437                clofind=selist[ind];                                                           
//#6438                fvars(clofind);                                                           
//#6439                frmpnt->bcol=actcol;                                                           
//#6440                sbord();                                                           
//#6441            }                                                               
//#6442            setMap(INIT);                                                               
//#6443            coltab();                                                               
//#6444            setMap(RESTCH);                                                               
//#6445        }                                                                   
//#6446        else{                                                                   
//#6447                                                                           
//#6448            if(chkMap(FORMSEL)){                                                               
//#6449                                                                           
//#6450                frmpnt->bcol=actcol;                                                           
//#6451                sbord();                                                           
//#6452                coltab();                                                           
//#6453                setMap(INIT);                                                           
//#6454                setMap(RESTCH);                                                           
//#6455            }                                                               
//#6456        }                                                                   
//#6457    }                                                                       
//#6458                                                                           
//#6459    BOOL ritclp(FLPNT pnt){                                                                       
//#6460                                                                           
//#6461        FLPNT        adj;                                                           
//#6462        unsigned    ind;                                                               
//#6463                                                                           
//#6464        if(chkmax(clplen,seqpnt))                                                                   
//#6465            return 1;                                                               
//#6466        adj.x=pnt.x-clpref.x;                                                                   
//#6467        adj.y=pnt.y-clpref.y;                                                                   
//#6468        for(ind=0;ind<clplen;ind++){                                                                   
//#6469                                                                           
//#6470            oseq[seqpnt].x=filclp[ind].x+adj.x;                                                               
//#6471            oseq[seqpnt++].y=filclp[ind].y+adj.y;                                                               
//#6472        }                                                                   
//#6473        return 0;                                                                   
//#6474    }                                                                       
//#6475                                                                           
//#6476    BOOL clpsid(unsigned strt,unsigned fin){                                                                       
//#6477                                                                           
//#6478        unsigned        ind,cnt;                                                           
//#6479        FLPNT            dif,stp,pnt;                                                       
//#6480        double            len,tdub;                                                       
//#6481        SHRTPNT            rpnt;                                                       
//#6482                                                                           
//#6483        rpnt.x=clprct.left;                                                                   
//#6484        rpnt.y=clprct.bottom;                                                                   
//#6485        pnt.x=flt[strt].x;                                                                   
//#6486        pnt.y=flt[fin].y;                                                                   
//#6487        dif.x=flt[fin].x-flt[strt].x;                                                                   
//#6488        dif.y=flt[fin].y-flt[strt].y;                                                                   
//#6489        len=hypot(dif.x,dif.y);                                                                   
//#6490        ang=atan2(dif.y,dif.x);                                                                   
//#6491        rotang1(rpnt,&clpref);                                                                   
//#6492        cnt=len/clpsiz.cx;                                                                   
//#6493        if(cnt){                                                                   
//#6494                                                                           
//#6495            if(cnt>1)                                                               
//#6496                tdub=((len-cnt*clpsiz.cx)/(cnt-1)+clpsiz.cx)/len;                                                           
//#6497            else                                                               
//#6498                tdub=(len-clpsiz.cx)/2;                                                           
//#6499            stp.x=dif.x*tdub;                                                               
//#6500            stp.y=dif.y*tdub;                                                               
//#6501            pnt.x=flt[strt].x;                                                               
//#6502            pnt.y=flt[strt].y;                                                               
//#6503            ang=atan2(dif.y,dif.x);                                                               
//#6504            for(ind=0;ind<clplen;ind++)                                                               
//#6505                rotangf(clprev[ind],&filclp[ind]);                                                           
//#6506            for(ind=0;ind<cnt;ind++){                                                               
//#6507                                                                           
//#6508                if(ritclp(pnt))                                                           
//#6509                    break;                                                       
//#6510                pnt.x+=stp.x;                                                           
//#6511                pnt.y+=stp.y;                                                           
//#6512            }                                                               
//#6513            return 1;                                                               
//#6514        }                                                                   
//#6515        return 0;                                                                   
//#6516    }                                                                       
//#6517                                                                           
//#6518    void linsid(){                                                                       
//#6519                                                                           
//#6520        FLPNT        dif;                                                           
//#6521        unsigned    cnt,ind;                                                               
//#6522        double        len;                                                           
//#6523                                                                           
//#6524        dif.x=flt[clpstrt+1].x-sPnt.x;                                                                   
//#6525        dif.y=flt[clpstrt+1].y-sPnt.y;                                                                   
//#6526        len=hypot(dif.x,dif.y);                                                                   
//#6527        cnt=len/clpsiz.cx;                                                                   
//#6528        if(cnt){                                                                   
//#6529                                                                           
//#6530            ang=clpang;                                                               
//#6531            rotangf(rclpref,&clpref);                                                               
//#6532            for(ind=0;ind<clplen;ind++)                                                               
//#6533                rotangf(clprev[ind],&filclp[ind]);                                                           
//#6534            for(ind=0;ind<cnt;ind++){                                                               
//#6535                                                                           
//#6536                ritclp(sPnt);                                                           
//#6537                sPnt.x+=vct0.x;                                                           
//#6538                sPnt.y+=vct0.y;                                                           
//#6539            }                                                               
//#6540        }                                                                   
//#6541    }                                                                       
//#6542                                                                           
//#6543    BOOL nupnt(){                                                                       
//#6544                                                                           
//#6545        double        len,dif;                                                           
//#6546        unsigned    ind;                                                               
//#6547                                                                           
//#6548        mvpnt.x=flt[clpstrt+2].x;                                                                   
//#6549        mvpnt.y=flt[clpstrt+2].y;                                                                   
//#6550        len=hypot(mvpnt.x-sPnt.x,mvpnt.y-sPnt.y);                                                                   
//#6551        if(len>clpsiz.cx){                                                                   
//#6552                                                                           
//#6553            for(ind=0;ind<10;ind++){                                                               
//#6554                                                                           
//#6555                len=hypot(mvpnt.x-sPnt.x,mvpnt.y-sPnt.y);                                                           
//#6556                dif=clpsiz.cx-len;                                                           
//#6557                mvpnt.x+=dif*cosang;                                                           
//#6558                mvpnt.y+=dif*sinang;                                                           
//#6559                if(fabs(dif)<0.01)                                                           
//#6560                    break;                                                       
//#6561            }                                                               
//#6562            return 1;                                                               
//#6563        }                                                                   
//#6564        return 0;                                                                   
//#6565    }                                                                       
//#6566                                                                           
//#6567    void lincrnr(){                                                                       
//#6568                                                                           
//#6569        DUBPNT        dif;                                                           
//#6570        unsigned    ind;                                                               
//#6571                                                                           
//#6572        sinang=sin(clpang);                                                                   
//#6573        cosang=cos(clpang);                                                                   
//#6574        if(nupnt()){                                                                   
//#6575                                                                           
//#6576            dif.x=mvpnt.x-sPnt.x;                                                               
//#6577            dif.y=mvpnt.y-sPnt.y;                                                               
//#6578            ang=atan2(dif.y,dif.x);                                                               
//#6579            rotangf(rclpref,&clpref);                                                               
//#6580            for(ind=0;ind<clplen;ind++)                                                               
//#6581                rotangf(clprev[ind],&filclp[ind]);                                                           
//#6582            ritclp(sPnt);                                                               
//#6583            sPnt.x=mvpnt.x;                                                               
//#6584            sPnt.y=mvpnt.y;                                                               
//#6585        }                                                                   
//#6586    }                                                                       
//#6587                                                                           
//#6588    void durev(){                                                                       
//#6589                                                                           
//#6590        unsigned    ind;                                                               
//#6591        double        mid;                                                           
//#6592                                                                           
//#6593        mid=(clprct.right-clprct.left)/2+clprct.left;                                                                   
//#6594        if(clpnu[0].x>mid){                                                                   
//#6595                                                                           
//#6596            for(ind=0;ind<clplen;ind++){                                                               
//#6597                                                                           
//#6598                clprev[ind].x=clprct.right-clpnu[ind].x;                                                           
//#6599                clprev[ind].y=clpnu[ind].y;                                                           
//#6600            }                                                               
//#6601        }                                                                   
//#6602        else{                                                                   
//#6603                                                                           
//#6604            for(ind=0;ind<clplen;ind++){                                                               
//#6605                                                                           
//#6606                clprev[ind].x=clpnu[ind].x;                                                           
//#6607                clprev[ind].y=clpnu[ind].y;                                                           
//#6608            }                                                               
//#6609        }                                                                   
//#6610    }                                                                       
//#6611                                                                           
//#6612    void setvct(unsigned strt,unsigned fin){                                                                       
//#6613                                                                           
//#6614        clpang=atan2(flt[fin].y-flt[strt].y,flt[fin].x-flt[strt].x);                                                                   
//#6615        vct0.x=clpsiz.cx*cos(clpang);                                                                   
//#6616        vct0.y=clpsiz.cx*sin(clpang);                                                                   
//#6617    }                                                                       
//#6618                                                                           
//#6619    void clpbrd(unsigned short strtlin){                                                                       
//#6620                                                                           
//#6621        unsigned        ind,ref;                                                           
//#6622        unsigned short    nlin;                                                               
//#6623                                                                           
//#6624        bac=0;                                                                   
//#6625        seqpnt=0;                                                                   
//#6626        rstMap(CLPBAK);                                                                   
//#6627        plen=clpsiz.cx/2;                                                                   
//#6628        plen2=clpsiz.cx;                                                                   
//#6629        filclp=new FLPNT[clplen];                                                                   
//#6630        clprev=new FLPNT[clplen];                                                                   
//#6631        rotcntr.x=(clprct.right-clprct.left)/2+clprct.left;                                                                   
//#6632        clpref.y=rotcntr.y=(clprct.top-clprct.bottom)/2+clprct.bottom;                                                                   
//#6633        clpref.x=clprct.left;                                                                   
//#6634        durev();                                                                   
//#6635        ref=0;                                                                   
//#6636        if(frmpnt->typ==LIN){                                                                   
//#6637                                                                           
//#6638            sPnt.x=flt[0].x;                                                               
//#6639            sPnt.y=flt[0].y;                                                               
//#6640            setvct(0,1);                                                               
//#6641            rclpref.y=(clprct.top-clprct.bottom)/2+clprct.bottom;                                                               
//#6642            rclpref.x=(clprct.top=clprct.left)/2+clprct.left;                                                               
//#6643            for(clpstrt=0;clpstrt<(unsigned)sids-2;clpstrt++){                                                               
//#6644                                                                           
//#6645                linsid();                                                           
//#6646                setvct(clpstrt+1,clpstrt+2);                                                           
//#6647                lincrnr();                                                           
//#6648            }                                                               
//#6649            linsid();                                                               
//#6650        }                                                                   
//#6651        else{                                                                   
//#6652                                                                           
//#6653            clpout();                                                               
//#6654            ref=strtlin;                                                               
//#6655            for(ind=0;ind<sids;ind++){                                                               
//#6656                                                                           
//#6657                nlin=prv(strtlin);                                                           
//#6658                if(clpsid(ref,nlin))                                                           
//#6659                    ref=nlin;                                                       
//#6660                strtlin=nlin;                                                           
//#6661            }                                                               
//#6662        }                                                                   
//#6663        delete filclp;                                                                   
//#6664        delete clprev;                                                                   
//#6665    }                                                                       
//#6666                                                                           
//#6667    void outfn(unsigned strt,unsigned fin,double satwid){                                                                       
//#6668                                                                           
//#6669        double        ang;                                                           
//#6670        double        len;                                                           
//#6671        double        xof,yof;                                                           
//#6672                                                                           
//#6673        if(fabs(angs[strt])<TINY&&fabs(angs[fin])<TINY){                                                                   
//#6674                                                                           
//#6675            xof=0;                                                               
//#6676            yof=satwid;                                                               
//#6677        }                                                                   
//#6678        else{                                                                   
//#6679                                                                           
//#6680    #define SATHRESH 10                                                                       
//#6681                                                                           
//#6682            ang=(angs[fin]-angs[strt])/2;                                                               
//#6683            len=satwid/cos(ang);                                                               
//#6684            if(len<-satwid*SATHRESH)                                                               
//#6685                len=-satwid*SATHRESH;                                                           
//#6686            if(len>satwid*SATHRESH)                                                               
//#6687                len=satwid*SATHRESH;                                                           
//#6688            ang+=angs[strt]+PI/2;                                                               
//#6689            xof=len*cos(ang);                                                               
//#6690            yof=len*sin(ang);                                                               
//#6691        }                                                                   
//#6692        ipnts[fin].x=flt[fin].x-xof;                                                                   
//#6693        ipnts[fin].y=flt[fin].y-yof;                                                                   
//#6694        opnts[fin].x=flt[fin].x+xof;                                                                   
//#6695        opnts[fin].y=flt[fin].y+yof;                                                                   
//#6696    }                                                                       
//#6697                                                                           
//#6698    void duangs(){                                                                       
//#6699                                                                           
//#6700        unsigned ind;                                                                   
//#6701                                                                           
//#6702        for(ind=0;ind<(unsigned)sids-1;ind++)                                                                   
//#6703            angs[ind]=atan2(flt[ind+1].y-flt[ind].y,flt[ind+1].x-flt[ind].x);                                                               
//#6704        angs[ind]=atan2(flt[0].y-flt[ind].y,flt[0].x-flt[ind].x);                                                                   
//#6705    }                                                                       
//#6706                                                                           
//#6707    void satout(double satwid){                                                                       
//#6708                                                                           
//#6709        unsigned    ind;                                                               
//#6710        unsigned    cnt;                                                               
//#6711                                                                           
//#6712        if(sids){                                                                   
//#6713                                                                           
//#6714            duangs();                                                               
//#6715            opnts=opntlst;                                                               
//#6716            ipnts=ipntlst;                                                               
//#6717            for(ind=0;ind<(unsigned)sids-1;ind++)                                                               
//#6718                outfn(ind,ind+1,0.1);                                                           
//#6719            cnt=0;                                                               
//#6720            for(ind=0;ind<sids;ind++)                                                               
//#6721            {                                                               
//#6722                if(cisin(ipnts[ind].x,ipnts[ind].y))                                                           
//#6723                    cnt++;                                                       
//#6724            }                                                               
//#6725            satwid/=2;                                                               
//#6726            for(ind=0;ind<(unsigned)sids-1;ind++)                                                               
//#6727                outfn(ind,ind+1,satwid);                                                           
//#6728            outfn(ind,0,satwid);                                                               
//#6729            rstMap(INDIR);                                                               
//#6730            if(cnt<(unsigned)sids>>1)                                                               
//#6731            {                                                               
//#6732                setMap(INDIR);                                                           
//#6733                opnts=ipntlst;                                                           
//#6734                ipnts=opntlst;                                                           
//#6735            }                                                               
//#6736        }                                                                   
//#6737    //    bugdraw                                                                   
//#6738    /*    SetROP2(rsdc,R2_XORPEN);                                                                   
//#6739        SelectObject(rsdc,fPen);                                                                   
//#6740        frmlin(opnts,sids);                                                                   
//#6741        Polyline(rsdc,flin,sids+1);                                                                   
//#6742        frmlin(ipnts,sids);                                                                   
//#6743        Polyline(rsdc,flin,sids+1);                                                                   
//#6744        SetROP2(rsdc,R2_COPYPEN);                                                                   
//#6745        _asm nop;*/                                                                   
//#6746    }                                                                       
//#6747                                                                           
//#6748    void clpout(){                                                                       
//#6749                                                                           
//#6750        if(frmpnt->typ==LIN)                                                                   
//#6751            satout(plen);                                                               
//#6752        else{                                                                   
//#6753                                                                           
//#6754            satout(clpsiz.cy);                                                               
//#6755            ipnts=frmpnt->flt;                                                               
//#6756        }                                                                   
//#6757    }                                                                       
//#6758                                                                           
//#6759    void fsclp(){                                                                       
//#6760                                                                           
//#6761        unsigned    ind;                                                               
//#6762                                                                           
//#6763        deleclp(clofind);                                                                   
//#6764        frmpnt->etyp=EGCLP;                                                                   
//#6765        frmpnt->nclp=clplen;                                                                   
//#6766        frmpnt->clp=nueclp(clofind,clplen);                                                                   
//#6767        frmpnt->esiz=clpsiz.cy;                                                                   
//#6768        frmpnt->espac=clpsiz.cx;                                                                   
//#6769        frmpnt->bcol=actcol;                                                                   
//#6770        bsizpar();                                                                   
//#6771        for(ind=0;ind<clplen;ind++){                                                                   
//#6772                                                                           
//#6773            frmpnt->clp[ind].x=clpnu[ind].x;                                                               
//#6774            frmpnt->clp[ind].y=clpnu[ind].y;                                                               
//#6775        }                                                                   
//#6776        plen=clpsiz.cy/2;                                                                   
//#6777        clpout();                                                                   
//#6778        refilfn();                                                                   
//#6779    }                                                                       
//#6780                                                                           
//#6781    void fclp(){                                                                       
//#6782                                                                           
//#6783        unsigned ind;                                                                   
//#6784                                                                           
//#6785        if(filmsgs(FML_CLP))                                                                   
//#6786            return;                                                               
//#6787        if(OpenClipboard(hWnd)){                                                                   
//#6788                                                                           
//#6789            fvars(clofind);                                                               
//#6790            hClip=RegisterClipboardFormat(pcdClip);                                                               
//#6791            hClpMem=GetClipboardData(hClip);                                                               
//#6792            if(hClpMem){                                                               
//#6793                                                                           
//#6794                savdo();                                                           
//#6795                redclp();                                                           
//#6796                CloseClipboard();                                                           
//#6797                if(clpsiz.cx>CLPMIN){                                                           
//#6798                                                                           
//#6799                    if(fselpnt){                                                       
//#6800                                                                           
//#6801                        for(ind=0;ind<fselpnt;ind++){                                                   
//#6802                                                                           
//#6803                            clofind=selist[ind];                                               
//#6804                            fvars(clofind);                                               
//#6805                            fsclp();                                               
//#6806                        }                                                   
//#6807                        setMap(INIT);                                                   
//#6808                        coltab();                                                   
//#6809                        setMap(RESTCH);                                                   
//#6810                    }                                                       
//#6811                    else{                                                       
//#6812                                                                           
//#6813                        if(chkMap(FORMSEL)){                                                   
//#6814                                                                           
//#6815                            fsclp();                                               
//#6816                            setMap(INIT);                                               
//#6817                            coltab();                                               
//#6818                            setMap(RESTCH);                                               
//#6819                        }                                                   
//#6820                    }                                                       
//#6821                }                                                           
//#6822                else                                                           
//#6823                    tabmsg(IDS_CLP);                                                       
//#6824            }                                                               
//#6825            else                                                               
//#6826                CloseClipboard();                                                           
//#6827        }                                                                   
//#6828    }                                                                       
//#6829                                                                           
//#6830    void filinsb(DUBPNT pnt){                                                                       
//#6831                                                                           
//#6832        double        len;                                                           
//#6833        DUBPNT        dif,stp;                                                           
//#6834        unsigned    cnt;                                                               
//#6835                                                                           
//#6836        dif.x=pnt.x-sPnt.x;                                                                   
//#6837        dif.y=pnt.y-sPnt.y;                                                                   
//#6838        len=hypot(dif.x,dif.y);                                                                   
//#6839        if(len>MAXSTCH){                                                                   
//#6840                                                                           
//#6841            cnt=len/MAXSTCH+1;                                                               
//#6842            stp.x=dif.x/cnt;                                                               
//#6843            stp.y=dif.y/cnt;                                                               
//#6844            cnt--;                                                               
//#6845            if(chkmax(cnt,seqpnt))                                                               
//#6846                return;                                                           
//#6847            while(cnt){                                                               
//#6848                                                                           
//#6849                sPnt.x+=stp.x;                                                           
//#6850                sPnt.y+=stp.y;                                                           
//#6851                oseq[seqpnt].x=sPnt.x;                                                           
//#6852                oseq[seqpnt++].y=sPnt.y;                                                           
//#6853                cnt--;                                                           
//#6854            }                                                               
//#6855        }                                                                   
//#6856        if(seqpnt&0xffff0000)                                                                   
//#6857            return;                                                               
//#6858        oseq[seqpnt].x=pnt.x;                                                                   
//#6859        oseq[seqpnt++].y=pnt.y;                                                                   
//#6860        sPnt.x=pnt.x;                                                                   
//#6861        sPnt.y=pnt.y;                                                                   
//#6862    }                                                                       
//#6863                                                                           
//#6864    BOOL chkbak(DUBPNT pnt){                                                                       
//#6865                                                                           
//#6866        unsigned ind;                                                                   
//#6867        double        len;                                                           
//#6868                                                                           
//#6869        for(ind=0;ind<8;ind++){                                                                   
//#6870                                                                           
//#6871            len=hypot(filbak[ind].x-pnt.x,filbak[ind].y-pnt.y);                                                               
//#6872            if(len<stspace)                                                               
//#6873                return 1;                                                           
//#6874        }                                                                   
//#6875        return 0;                                                                   
//#6876    }                                                                       
//#6877                                                                           
//#6878    BOOL linx(FLPNT* flt,unsigned strt,unsigned fin,DUBPNT* npnt){                                                                       
//#6879                                                                           
//#6880        DUBPNT    dif;                                                               
//#6881        DUBPNT    tdub;                                                               
//#6882                                                                           
//#6883        dif.x=opnts[strt].x-flt[strt].x;                                                                   
//#6884        dif.y=opnts[strt].y-flt[strt].y;                                                                   
//#6885        if(!dif.x&&!dif.y)                                                                   
//#6886            return 0;                                                               
//#6887        tdub.x=flt[strt].x;                                                                   
//#6888        tdub.y=flt[strt].y;                                                                   
//#6889        if(dif.x){                                                                   
//#6890                                                                           
//#6891            if(proj(tdub,dif.y/dif.x,opnts[fin],flt[fin],npnt))                                                               
//#6892                return 1;                                                           
//#6893            else                                                               
//#6894                return 0;                                                           
//#6895        }                                                                   
//#6896        else{                                                                   
//#6897                                                                           
//#6898            if(projv(tdub.x,flt[fin],opnts[fin],npnt))                                                               
//#6899                return 1;                                                           
//#6900            else                                                               
//#6901                return 0;                                                           
//#6902        }                                                                   
//#6903    }                                                                       
//#6904                                                                           
//#6905    void filinsbw(DUBPNT pnt){                                                                       
//#6906                                                                           
//#6907        filbak[pfbak].x=pnt.x;                                                                   
//#6908        filbak[pfbak++].y=pnt.y;                                                                   
//#6909        pfbak&=0x7;                                                                   
//#6910        filinsb(pnt);                                                                   
//#6911    }                                                                       
//#6912                                                                           
//#6913    void sbfn(FLPNT* flt,unsigned strt,unsigned fin){                                                                       
//#6914                                                                           
//#6915        DUBPNT        idif,odif,istp,ostp,opnt,ipnt;                                                           
//#6916        DUBPNT        bdif,bstp,bpnt;                                                           
//#6917        DUBPNT        npnt;                                                           
//#6918        double        ilen,olen,blen;                                                           
//#6919        unsigned    cnt,iflg,oflg,bcnt,ind,xflg;                                                               
//#6920                                                                           
//#6921        if(!setMap(SAT1)){                                                                   
//#6922                                                                           
//#6923            sPnt.x=flt[strt].x;                                                               
//#6924            sPnt.y=flt[strt].y;                                                               
//#6925        }                                                                   
//#6926        idif.x=flt[fin].x-flt[strt].x;                                                                   
//#6927        idif.y=flt[fin].y-flt[strt].y;                                                                   
//#6928        odif.x=opnts[fin].x-opnts[strt].x;                                                                   
//#6929        odif.y=opnts[fin].y-opnts[strt].y;                                                                   
//#6930        ilen=hypot(idif.x,idif.y);                                                                   
//#6931        olen=hypot(odif.x,odif.y);                                                                   
//#6932        ipnt.x=flt[strt].x;                                                                   
//#6933        ipnt.y=flt[strt].y;                                                                   
//#6934        opnt.x=opnts[strt].x;                                                                   
//#6935        opnt.y=opnts[strt].y;                                                                   
//#6936        xflg=pfbak=iflg=oflg=bcnt=0;                                                                   
//#6937        for(ind=0;ind<8;ind++){                                                                   
//#6938                                                                           
//#6939            filbak[ind].x=(float)1e12;                                                               
//#6940            filbak[ind].y=(float)1e12;                                                               
//#6941        }                                                                   
//#6942        if(olen>ilen){                                                                   
//#6943                                                                           
//#6944            cnt=olen/stspace;                                                               
//#6945            iflg=1;                                                               
//#6946            if(linx(flt,strt,fin,&npnt)){                                                               
//#6947                                                                           
//#6948                xflg=1;                                                           
//#6949                idif.x=idif.y=ilen=0;                                                           
//#6950                ipnt.x=npnt.x;                                                           
//#6951                ipnt.y=npnt.y;                                                           
//#6952            }                                                               
//#6953        }                                                                   
//#6954        else{                                                                   
//#6955                                                                           
//#6956            cnt=ilen/stspace;                                                               
//#6957            oflg=1;                                                               
//#6958            if(linx(flt,strt,fin,&npnt)){                                                               
//#6959                                                                           
//#6960                xflg=1;                                                           
//#6961                odif.x=odif.y=olen=0;                                                           
//#6962                opnt.x=npnt.x;                                                           
//#6963                opnt.y=npnt.y;                                                           
//#6964            }                                                               
//#6965        }                                                                   
//#6966        if(!cnt)                                                                   
//#6967            cnt=1;                                                               
//#6968        if(chkmax(cnt,seqpnt))                                                                   
//#6969            return;                                                               
//#6970        istp.x=idif.x/cnt;                                                                   
//#6971        istp.y=idif.y/cnt;                                                                   
//#6972        ostp.x=odif.x/cnt;                                                                   
//#6973        ostp.y=odif.y/cnt;                                                                   
//#6974        for(ind=0;ind<cnt;ind++){                                                                   
//#6975                                                                           
//#6976            ipnt.x+=istp.x;                                                               
//#6977            ipnt.y+=istp.y;                                                               
//#6978            opnt.x+=ostp.x;                                                               
//#6979            opnt.y+=ostp.y;                                                               
//#6980            if(toglMap(FILDIR)){                                                               
//#6981                                                                           
//#6982                if(iflg){                                                           
//#6983                                                                           
//#6984                    bdif.x=ipnt.x-sPnt.x;                                                       
//#6985                    bdif.y=ipnt.y-sPnt.y;                                                       
//#6986                    blen=hypot(bdif.x,bdif.y);                                                       
//#6987                    bcnt=blen/stspace;                                                       
//#6988                    bstp.x=bdif.x/bcnt;                                                       
//#6989                    bstp.y=bdif.y/bcnt;                                                       
//#6990                    bpnt.x=ipnt.x;                                                       
//#6991                    bpnt.y=ipnt.y;                                                       
//#6992                    while(chkbak(bpnt)){                                                       
//#6993                                                                           
//#6994                        bpnt.x-=bstp.x;                                                   
//#6995                        bpnt.y-=bstp.y;                                                   
//#6996                    }                                                       
//#6997                    filinsbw(bpnt);                                                       
//#6998                }                                                           
//#6999                else                                                           
//#7000                    filinsb(ipnt);                                                       
//#7001            }                                                               
//#7002            else{                                                               
//#7003                                                                           
//#7004                if(oflg){                                                           
//#7005                                                                           
//#7006                    bdif.x=opnt.x-sPnt.x;                                                       
//#7007                    bdif.y=opnt.y-sPnt.y;                                                       
//#7008                    blen=hypot(bdif.x,bdif.y);                                                       
//#7009                    bcnt=blen/stspace;                                                       
//#7010                    bstp.x=bdif.x/bcnt;                                                       
//#7011                    bstp.y=bdif.y/bcnt;                                                       
//#7012                    bpnt.x=opnt.x;                                                       
//#7013                    bpnt.y=opnt.y;                                                       
//#7014                    while(chkbak(bpnt)){                                                       
//#7015                                                                           
//#7016                        bpnt.x-=bstp.x;                                                   
//#7017                        bpnt.y-=bstp.y;                                                   
//#7018                    }                                                       
//#7019                    filinsbw(bpnt);                                                       
//#7020                }                                                           
//#7021                else                                                           
//#7022                    filinsb(opnt);                                                       
//#7023            }                                                               
//#7024        }                                                                   
//#7025    }                                                                       
//#7026                                                                           
//#7027    void sfn(unsigned short strtlin){                                                                       
//#7028                                                                           
//#7029        unsigned ind;                                                                   
//#7030        unsigned short nlin;                                                                   
//#7031                                                                           
//#7032        for(ind=0;ind<frmpnt->sids;ind++){                                                                   
//#7033                                                                           
//#7034            nlin=nxt(strtlin);                                                               
//#7035            sbfn(ipnts,strtlin,nlin);                                                               
//#7036            strtlin=nlin;                                                               
//#7037        }                                                                   
//#7038        oseq[0].x=oseq[seqpnt-1].x;                                                                   
//#7039        oseq[0].y=oseq[seqpnt-1].y;                                                                   
//#7040        if(seqpnt>MAXSEQ-2)                                                                   
//#7041            seqpnt=MAXSEQ-2;                                                               
//#7042    }                                                                       
//#7043                                                                           
//#7044    void sbrd(){                                                                       
//#7045                                                                           
//#7046        double            tspac;                                                       
//#7047        unsigned        strt;                                                           
//#7048                                                                           
//#7049        strt=getlast();                                                                   
//#7050        tspac=stspace;                                                                   
//#7051        rstMap(SAT1);                                                                   
//#7052        rstMap(FILDIR);                                                                   
//#7053        seqpnt=1;                                                                   
//#7054        if(frmpnt->etyp&EGUND){                                                                   
//#7055                                                                           
//#7056            stspace=USPAC;                                                               
//#7057            satout(plen*URAT);                                                               
//#7058            sfn(strt);                                                               
//#7059            setMap(FILDIR);                                                               
//#7060            sfn(strt);                                                               
//#7061        }                                                                   
//#7062        fvars(clofind);                                                                   
//#7063        satout(plen);                                                                   
//#7064        stspace=frmpnt->espac;                                                                   
//#7065        sfn(strt);                                                                   
//#7066        stspace=tspac;                                                                   
//#7067    }                                                                       
//#7068                                                                           
//#7069    void rfn(unsigned tlin){                                                                       
//#7070                                                                           
//#7071        unsigned ind,nlin;                                                                   
//#7072                                                                           
//#7073        for(ind=0;ind<frmpnt->sids;ind++){                                                                   
//#7074                                                                           
//#7075            nlin=nxt(tlin);                                                               
//#7076            sbfn(ipnts,tlin,nlin);                                                               
//#7077            tlin=nlin;                                                               
//#7078        }                                                                   
//#7079    }                                                                       
//#7080                                                                           
//#7081    void rbrd(){                                                                       
//#7082                                                                           
//#7083        unsigned short    tlin=getlast();                                                               
//#7084        double            tspac;                                                       
//#7085                                                                           
//#7086        rstMap(SAT1);                                                                   
//#7087        rstMap(FILDIR);                                                                   
//#7088        tspac=stspace;                                                                   
//#7089        stspace=USPAC;                                                                   
//#7090        rfn(tlin);                                                                   
//#7091        setMap(FILDIR);                                                                   
//#7092        rfn(tlin);                                                                   
//#7093        satout(plen);                                                                   
//#7094        stspace=tspac;                                                                   
//#7095        rfn(tlin);                                                                   
//#7096    }                                                                       
//#7097                                                                           
//#7098    void satends(unsigned blnt){                                                                       
//#7099                                                                           
//#7100        FLPNT        stp;                                                           
//#7101                                                                           
//#7102        if(blnt&SBLNT){                                                                   
//#7103                                                                           
//#7104            stp.x=sin(angs[0])*plen/2;                                                               
//#7105            stp.y=cos(angs[0])*plen/2;                                                               
//#7106            if(chkMap(INDIR))                                                               
//#7107            {                                                               
//#7108                stp.x=-stp.x;                                                           
//#7109                stp.y=-stp.y;                                                           
//#7110            }                                                               
//#7111            ipnts[0].x=frmpnt->flt[0].x+stp.x;                                                               
//#7112            ipnts[0].y=frmpnt->flt[0].y-stp.y;                                                               
//#7113            opnts[0].x=frmpnt->flt[0].x-stp.x;                                                               
//#7114            opnts[0].y=frmpnt->flt[0].y+stp.y;                                                               
//#7115        }                                                                   
//#7116        else{                                                                   
//#7117                                                                           
//#7118            ipnts[0].x=opnts[0].x=flt[0].x;                                                               
//#7119            ipnts[0].y=opnts[0].y=flt[0].y;                                                               
//#7120        }                                                                   
//#7121        if(blnt&FBLNT){                                                                   
//#7122                                                                           
//#7123            stp.x=sin(angs[sids-2])*plen/2;                                                               
//#7124            stp.y=cos(angs[sids-2])*plen/2;                                                               
//#7125            if(chkMap(INDIR))                                                               
//#7126            {                                                               
//#7127                stp.x=-stp.x;                                                           
//#7128                stp.y=-stp.y;                                                           
//#7129            }                                                               
//#7130            ipnts[sids-1].x=frmpnt->flt[sids-1].x+stp.x;                                                               
//#7131            ipnts[sids-1].y=frmpnt->flt[sids-1].y-stp.y;                                                               
//#7132            opnts[sids-1].x=frmpnt->flt[sids-1].x-stp.x;                                                               
//#7133            opnts[sids-1].y=frmpnt->flt[sids-1].y+stp.y;                                                               
//#7134        }                                                                   
//#7135        else{                                                                   
//#7136                                                                           
//#7137            ipnts[sids-1].x=opnts[sids-1].x=flt[sids-1].x;                                                               
//#7138            ipnts[sids-1].y=opnts[sids-1].y=flt[sids-1].y;                                                               
//#7139        }                                                                   
//#7140    }                                                                       
//#7141                                                                           
//#7142    void slbrd(){                                                                       
//#7143                                                                           
//#7144        unsigned    ind;                                                               
//#7145        double        tspac=stspace;                                                           
//#7146                                                                           
//#7147        seqpnt=0;                                                                   
//#7148        if(frmpnt->etyp&EGUND){                                                                   
//#7149                                                                           
//#7150            plen=frmpnt->esiz*URAT;                                                               
//#7151            satout(plen);                                                               
//#7152            satends(frmpnt->at);                                                               
//#7153            rstMap(SAT1);                                                               
//#7154            rstMap(FILDIR);                                                               
//#7155            stspace=USPAC;                                                               
//#7156            for(ind=0;ind<(unsigned)frmpnt->sids-1;ind++)                                                               
//#7157                sbfn(ipnts,ind,ind+1);                                                           
//#7158            toglMap(FILDIR);                                                               
//#7159            for(ind=frmpnt->sids-1;ind;ind--)                                                               
//#7160                sbfn(ipnts,ind,ind-1);                                                           
//#7161        }                                                                   
//#7162        plen=frmpnt->esiz;                                                                   
//#7163        satout(plen);                                                                   
//#7164        satends(frmpnt->at);                                                                   
//#7165        stspace=frmpnt->espac;                                                                   
//#7166        rstMap(SAT1);                                                                   
//#7167        for(ind=0;ind<(unsigned)frmpnt->sids-1;ind++)                                                                   
//#7168            sbfn(ipnts,ind,ind+1);                                                               
//#7169        stspace=tspac;                                                                   
//#7170    }                                                                       
//#7171                                                                           
//#7172    void satsbrd(){                                                                       
//#7173                                                                           
//#7174        deleclp(clofind);                                                                   
//#7175        frmpnt->etyp=EGSAT;                                                                   
//#7176        if(chku(DUND))                                                                   
//#7177            frmpnt->etyp|=EGUND;                                                               
//#7178        bsizpar();                                                                   
//#7179        frmpnt->esiz=brdwid;                                                                   
//#7180        frmpnt->espac=stspace/2;                                                                   
//#7181        frmpnt->bcol=actcol;                                                                   
//#7182        refilfn();                                                                   
//#7183    }                                                                       
//#7184                                                                           
//#7185    void satbrd(){                                                                       
//#7186                                                                           
//#7187        unsigned ind;                                                                   
//#7188                                                                           
//#7189        if(filmsgs(FML_ANGS))                                                                   
//#7190            return;                                                               
//#7191        if(fselpnt){                                                                   
//#7192                                                                           
//#7193            for(ind=0;ind<fselpnt;ind++){                                                               
//#7194                                                                           
//#7195                clofind=selist[ind];                                                           
//#7196                fvars(clofind);                                                           
//#7197                if(chku(BLUNT))                                                           
//#7198                    frmpnt->at|=(SBLNT|FBLNT);                                                       
//#7199                else                                                           
//#7200                    frmpnt->at&=NOBLNT;                                                       
//#7201                satsbrd();                                                           
//#7202            }                                                               
//#7203            setMap(INIT);                                                               
//#7204            coltab();                                                               
//#7205            setMap(RESTCH);                                                               
//#7206        }                                                                   
//#7207        else{                                                                   
//#7208                                                                           
//#7209            if(chkMap(FORMSEL)){                                                               
//#7210                                                                           
//#7211                fvars(clofind);                                                           
//#7212                if(chku(BLUNT))                                                           
//#7213                    frmpnt->at|=(SBLNT|FBLNT);                                                       
//#7214                else                                                           
//#7215                    frmpnt->at&=NOBLNT;                                                       
//#7216                satsbrd();                                                           
//#7217                setMap(INIT);                                                           
//#7218                coltab();                                                           
//#7219                ritot(hed.stchs);                                                           
//#7220                setMap(RESTCH);                                                           
//#7221            }                                                               
//#7222        }                                                                   
//#7223    }                                                                       
//#7224                                                                           
//#7225    void lapbrd(){                                                                       
//#7226                                                                           
//#7227        double        tsiz;                                                           
//#7228        unsigned    ind;                                                               
//#7229                                                                           
//#7230        seqpnt=0;                                                                   
//#7231        tsiz=usesiz;                                                                   
//#7232        usesiz=APSPAC;                                                                   
//#7233        for(ind=0;ind<(unsigned)sids-1;ind++)                                                                   
//#7234            bdrlin(ind,ind+1,APSPAC);                                                               
//#7235        for(ind=sids-1;ind;ind--)                                                                   
//#7236            bdrlin(ind,ind-1,APSPAC);                                                               
//#7237        usesiz=tsiz;                                                                   
//#7238    }                                                                       
//#7239                                                                           
//#7240    void apbrd(){                                                                       
//#7241                                                                           
//#7242        unsigned        ind;                                                           
//#7243        unsigned short    nlin,tlin=0;                                                               
//#7244                                                                           
//#7245        seqpnt=0;                                                                   
//#7246        oseq[seqpnt].x=flt[tlin].x;                                                                   
//#7247        oseq[seqpnt++].y=flt[tlin].y;                                                                   
//#7248        for(ind=0;ind<(unsigned)sids<<1;ind++){                                                                   
//#7249                                                                           
//#7250            nlin=nxt(tlin);                                                               
//#7251            bdrlin(tlin,nlin,APSPAC);                                                               
//#7252            tlin=nlin;                                                               
//#7253        }                                                                   
//#7254    }                                                                       
//#7255                                                                           
//#7256    void sapliq()                                                                       
//#7257    {                                                                       
//#7258        fvars(clofind);                                                                   
//#7259        deleclp(clofind);                                                                   
//#7260        frmpnt->etyp=EGAP;                                                                   
//#7261        if(chku(DUND))                                                                   
//#7262            frmpnt->etyp|=EGUND;                                                               
//#7263        frmpnt->espac=stspace/2;                                                                   
//#7264        frmpnt->esiz=ini.brdwid;                                                                   
//#7265        bsizpar();                                                                   
//#7266        frmpnt->bcol=actcol|(apcol<<4);                                                                   
//#7267        if(frmpnt->typ!=LIN)                                                                   
//#7268        {                                                                   
//#7269            if(frmpnt->ftyp=SAT&&frmpnt->stpt)                                                               
//#7270                delsac(clofind);                                                           
//#7271        }                                                                   
//#7272        frmpnt->ftyp=0;                                                                   
//#7273        frmpnt->typ=POLI;                                                                   
//#7274        refilfn();                                                                   
//#7275    }                                                                       
//#7276                                                                           
//#7277    void apliq(){                                                                       
//#7278                                                                           
//#7279        unsigned ind;                                                                   
//#7280                                                                           
//#7281        if(filmsgs(FML_APLQ))                                                                   
//#7282            return;                                                               
//#7283        if(fselpnt){                                                                   
//#7284                                                                           
//#7285            for(ind=0;ind<fselpnt;ind++){                                                               
//#7286                                                                           
//#7287                clofind=selist[ind];                                                           
//#7288                fvars(clofind);                                                           
//#7289                if(chku(BLUNT))                                                           
//#7290                    frmpnt->at|=(SBLNT|FBLNT);                                                       
//#7291                else                                                           
//#7292                    frmpnt->at&=NOBLNT;                                                       
//#7293                sapliq();                                                           
//#7294            }                                                               
//#7295            setMap(INIT);                                                               
//#7296            coltab();                                                               
//#7297            setMap(RESTCH);                                                               
//#7298        }                                                                   
//#7299        else{                                                                   
//#7300                                                                           
//#7301            if(chkMap(FORMSEL)){                                                               
//#7302                                                                           
//#7303                if(chku(BLUNT))                                                           
//#7304                    frmpnt->at|=(SBLNT|FBLNT);                                                       
//#7305                else                                                           
//#7306                    frmpnt->at&=NOBLNT;                                                       
//#7307                sapliq();                                                           
//#7308                setMap(INIT);                                                           
//#7309                coltab();                                                           
//#7310                setMap(RESTCH);                                                           
//#7311            }                                                               
//#7312        }                                                                   
//#7313    }                                                                       
//#7314                                                                           
//#7315    void setap(){                                                                       
//#7316                                                                           
//#7317        TCHAR    buf[HBUFSIZ];                                                               
//#7318                                                                           
//#7319        apcol=actcol;                                                                   
//#7320        LoadString(hInst,IDS_APCOL,buf,HBUFSIZ);                                                                   
//#7321        sprintf(msgbuf,buf,apcol+1);                                                                   
//#7322        shoMsg(msgbuf);                                                                   
//#7323    }                                                                       
//#7324                                                                           
//#7325    void maxtsiz(TCHAR* str,POINT* pt){                                                                       
//#7326                                                                           
//#7327        SIZE    tsiz;                                                               
//#7328                                                                           
//#7329        GetTextExtentPoint32(sdc,str,strlen(str),&tsiz);                                                                   
//#7330        pt->y=tsiz.cy;                                                                   
//#7331        if(tsiz.cx>pt->x)                                                                   
//#7332            pt->x=tsiz.cx;                                                               
//#7333    }                                                                       
//#7334                                                                           
//#7335    void maxwid(unsigned strt,unsigned fin){                                                                       
//#7336                                                                           
//#7337        POINT    pnt;                                                               
//#7338                                                                           
//#7339        pnt.x=0;                                                                   
//#7340        pnt.y=0;                                                                   
//#7341        while(strt<=fin)                                                                   
//#7342            maxtsiz(stab[strt++],&pnt);                                                               
//#7343        prfsiz=pnt.x+6;                                                                   
//#7344    }                                                                       
//#7345                                                                           
//#7346    HWND txtwin(TCHAR* str,RECT loc){                                                                       
//#7347                                                                           
//#7348        if(chkMap(REFCNT))                                                                   
//#7349        {                                                                   
//#7350            maxtsiz(str,&siz0);                                                               
//#7351            return 0;                                                               
//#7352        }                                                                   
//#7353        return CreateWindow(                                                                   
//#7354            STATIC,                                                               
//#7355            str,                                                               
//#7356            WS_CHILD|WS_VISIBLE,                                                               
//#7357            loc.left,                                                               
//#7358            loc.top,                                                               
//#7359            loc.right-loc.left,                                                               
//#7360            loc.bottom-loc.top,                                                               
//#7361            hfdat,                                                               
//#7362            NULL,                                                               
//#7363            hInst,                                                               
//#7364            NULL);                                                               
//#7365    }                                                                       
//#7366                                                                           
//#7367    HWND txtrwin(TCHAR* str,RECT loc){                                                                       
//#7368                                                                           
//#7369        if(chkMap(REFCNT))                                                                   
//#7370        {                                                                   
//#7371            maxtsiz(str,&siz1);                                                               
//#7372            return 0;                                                               
//#7373        }                                                                   
//#7374        return CreateWindow(                                                                   
//#7375            STATIC,                                                               
//#7376            str,                                                               
//#7377            SS_NOTIFY|WS_BORDER|WS_CHILD|WS_VISIBLE,                                                               
//#7378            loc.left,                                                               
//#7379            loc.top,                                                               
//#7380            loc.right-loc.left,                                                               
//#7381            loc.bottom-loc.top,                                                               
//#7382            hfdat,                                                               
//#7383            NULL,                                                               
//#7384            hInst,                                                               
//#7385            NULL);                                                               
//#7386    }                                                                       
//#7387                                                                           
//#7388    HWND numwin(TCHAR* str,RECT loc){                                                                       
//#7389                                                                           
//#7390        if(chkMap(REFCNT))                                                                   
//#7391        {                                                                   
//#7392            maxtsiz(str,&siz1);                                                               
//#7393            return 0;                                                               
//#7394        }                                                                   
//#7395        return CreateWindow(                                                                   
//#7396            STATIC,                                                               
//#7397            str,                                                               
//#7398            SS_NOTIFY|SS_RIGHT|WS_BORDER|WS_CHILD|WS_VISIBLE,                                                               
//#7399            loc.left,                                                               
//#7400            loc.top,                                                               
//#7401            loc.right-loc.left,                                                               
//#7402            loc.bottom-loc.top,                                                               
//#7403            hfdat,                                                               
//#7404            NULL,                                                               
//#7405            hInst,                                                               
//#7406            NULL);                                                               
//#7407    }                                                                       
//#7408                                                                           
//#7409    void nxtlin(){                                                                       
//#7410                                                                           
//#7411        refmcnt++;                                                                   
//#7412        loc0.top+=siz0.y;                                                                   
//#7413        loc0.bottom+=siz0.y;                                                                   
//#7414        loc1.top+=siz1.y;                                                                   
//#7415        loc1.bottom+=siz1.y;;                                                                   
//#7416    }                                                                       
//#7417                                                                           
//#7418    BOOL CALLBACK chenum(HWND hwnd,LPARAM lParam){                                                                       
//#7419                                                                           
//#7420        return DestroyWindow(hwnd);                                                                   
//#7421    }                                                                       
//#7422                                                                           
//#7423    void refrmfn()                                                                       
//#7424    {                                                                       
//#7425        char*        pchr;                                                           
//#7426        unsigned    cod,fpnt;                                                               
//#7427                                                                           
//#7428        cod=frmpnt->etyp&NEGUND;                                                                   
//#7429        fpnt=cod-1;                                                                   
//#7430        loc0.top=loc1.top=3;                                                                   
//#7431        loc0.bottom=loc1.bottom=3+siz0.y;                                                                   
//#7432        loc0.left=3;                                                                   
//#7433        loc0.right=3+siz0.x;                                                                   
//#7434        loc1.left=6+siz0.x;                                                                   
//#7435        loc1.right=6+siz0.x+siz1.x+6;                                                                   
//#7436        thTxt[LFRM]=txtwin(stab[STR_TXT0],loc0);                                                                   
//#7437        if(frmpnt->typ==LIN)                                                                   
//#7438            thDat[LFRM]=txtrwin(stab[STR_EDG1],loc1);                                                               
//#7439        else                                                                   
//#7440            thDat[LFRM]=txtrwin(stab[STR_FREH],loc1);                                                               
//#7441        nxtlin();                                                                   
//#7442        thTxt[LLAYR]=txtwin(stab[STR_TXT1],loc0);                                                                   
//#7443        sprintf(msgbuf,"%d",(frmpnt->at&FRMLMSK)>>1);                                                                   
//#7444        thDat[LLAYR]=txtrwin(msgbuf,loc1);                                                                   
//#7445        nxtlin();                                                                   
//#7446        if(frmpnt->typ!=LIN)                                                                   
//#7447        {                                                                   
//#7448            thTxt[LCWLK]=txtwin(stab[STR_CWLK],loc0);                                                               
//#7449            if(frmpnt->xat&AT_CWLK)                                                               
//#7450                thDat[LCWLK]=txtrwin(stab[STR_ON],loc1);                                                           
//#7451            else                                                               
//#7452                thDat[LCWLK]=txtrwin(stab[STR_OFF],loc1);                                                           
//#7453            nxtlin();                                                               
//#7454            thTxt[LWALK]=txtwin(stab[STR_WALK],loc0);                                                               
//#7455            if(frmpnt->xat&AT_WALK)                                                               
//#7456                thDat[LWALK]=txtrwin(stab[STR_ON],loc1);                                                           
//#7457            else                                                               
//#7458                thDat[LWALK]=txtrwin(stab[STR_OFF],loc1);                                                           
//#7459            nxtlin();                                                               
//#7460            thTxt[LUND]=txtwin(stab[STR_UND],loc0);                                                               
//#7461            if(frmpnt->xat&AT_UND)                                                               
//#7462                thDat[LUND]=txtrwin(stab[STR_ON],loc1);                                                           
//#7463            else                                                               
//#7464                thDat[LUND]=txtrwin(stab[STR_OFF],loc1);                                                           
//#7465            nxtlin();                                                               
//#7466            if(frmpnt->xat&(AT_WALK|AT_UND|AT_CWLK))                                                               
//#7467            {                                                               
//#7468                thTxt[LUNDCOL]=txtwin(stab[STR_UNDCOL],loc0);                                                           
//#7469                sprintf(msgbuf,"%d",frmpnt->ucol+1);                                                           
//#7470                thDat[LUNDCOL]=txtrwin(msgbuf,loc1);                                                           
//#7471                nxtlin();                                                           
//#7472                thTxt[LULEN]=txtwin(stab[STR_ULEN],loc0);                                                           
//#7473                sprintf(msgbuf,"%.2f",frmpnt->ulen/PFGRAN);                                                           
//#7474                thDat[LULEN]=txtrwin(msgbuf,loc1);                                                           
//#7475                nxtlin();                                                           
//#7476            }                                                               
//#7477            thTxt[LWLKIND]=txtwin(stab[STR_UWLKIND],loc0);                                                               
//#7478            sprintf(msgbuf,"%.2f",frmpnt->wind/PFGRAN);                                                               
//#7479            thDat[LWLKIND]=txtrwin(msgbuf,loc1);                                                               
//#7480            nxtlin();                                                               
//#7481            if(frmpnt->xat&AT_UND)                                                               
//#7482            {                                                               
//#7483                thTxt[LUSPAC]=txtwin(stab[STR_FUSPAC],loc0);                                                           
//#7484                sprintf(msgbuf,"%.2f",frmpnt->uspac/PFGRAN);                                                           
//#7485                thDat[LUSPAC]=txtrwin(msgbuf,loc1);                                                           
//#7486                nxtlin();                                                           
//#7487                thTxt[LUANG]=txtwin(stab[STR_FUANG],loc0);                                                           
//#7488                sprintf(msgbuf,"%.2f",frmpnt->uang*180/PI);                                                           
//#7489                thDat[LUANG]=txtrwin(msgbuf,loc1);                                                           
//#7490                nxtlin();                                                           
//#7491            }                                                               
//#7492        }                                                                   
//#7493        thTxt[LFRMFIL]=txtwin(stab[STR_TXT2],loc0);                                                                   
//#7494        thDat[LFRMFIL]=txtrwin(stab[STR_FIL0+frmpnt->ftyp],loc1);                                                                   
//#7495        nxtlin();                                                                   
//#7496        if(frmpnt->ftyp){                                                                   
//#7497                                                                           
//#7498            thTxt[LFRMCOL]=txtwin(stab[STR_TXT3],loc0);                                                               
//#7499            sprintf(msgbuf,"%d",frmpnt->fcol+1);                                                               
//#7500            thDat[LFRMCOL]=numwin(msgbuf,loc1);                                                               
//#7501            nxtlin();                                                               
//#7502            if(frmpnt->ftyp==FTHF){                                                               
//#7503                                                                           
//#7504                thTxt[LFTHCOL]=txtwin(stab[STR_FTHCOL],loc0);                                                           
//#7505                sprintf(msgbuf,"%d",frmpnt->dhx.fth.fthcol+1);                                                           
//#7506                thDat[LFTHCOL]=numwin(msgbuf,loc1);                                                           
//#7507                nxtlin();                                                           
//#7508                thTxt[LFTHTYP]=txtwin(stab[STR_FTHTYP],loc0);                                                           
//#7509                thDat[LFTHTYP]=numwin(stab[STR_FTH0+frmpnt->dhx.fth.fthtyp-1],loc1);                                                           
//#7510                nxtlin();                                                           
//#7511                thTxt[LFTHBLND]=txtwin(stab[STR_FTHBLND],loc0);                                                           
//#7512                if(frmpnt->xat&AT_FTHBLND)                                                           
//#7513                    pchr=stab[STR_ON];                                                       
//#7514                else                                                           
//#7515                    pchr=stab[STR_OFF];                                                       
//#7516                thDat[LFTHBLND]=txtrwin(pchr,loc1);                                                           
//#7517                nxtlin();                                                           
//#7518                if(!(frmpnt->xat&AT_FTHBLND)){                                                           
//#7519                                                                           
//#7520                    thTxt[LFTHDWN]=txtwin(stab[STR_FTHDWN],loc0);                                                       
//#7521                    if(frmpnt->xat&(AT_FTHDWN))                                                       
//#7522                        pchr=stab[STR_ON];                                                   
//#7523                    else                                                       
//#7524                        pchr=stab[STR_OFF];                                                   
//#7525                    thDat[LFTHDWN]=txtrwin(pchr,loc1);                                                       
//#7526                    nxtlin();                                                       
//#7527                    if(!(frmpnt->xat&AT_FTHDWN)){                                                       
//#7528                                                                           
//#7529                        thTxt[LFTHUP]=txtwin(stab[STR_FTHUP],loc0);                                                   
//#7530                        if(frmpnt->xat&AT_FTHUP)                                                   
//#7531                            pchr=stab[STR_ON];                                               
//#7532                        else                                                   
//#7533                            pchr=stab[STR_OFF];                                               
//#7534                        thDat[LFTHUP]=txtrwin(pchr,loc1);                                                   
//#7535                        nxtlin();                                                   
//#7536                    }                                                       
//#7537                }                                                           
//#7538                thTxt[LFTHUPCNT]=txtwin(stab[STR_FTHUPCNT],loc0);                                                           
//#7539                sprintf(msgbuf,"%d",frmpnt->dhx.fth.fthup);                                                           
//#7540                thDat[LFTHUPCNT]=numwin(msgbuf,loc1);                                                           
//#7541                nxtlin();                                                           
//#7542                thTxt[LFTHDWNCNT]=txtwin(stab[STR_FTHDWNCNT],loc0);                                                           
//#7543                sprintf(msgbuf,"%d",frmpnt->dhx.fth.fthdwn);                                                           
//#7544                thDat[LFTHDWNCNT]=numwin(msgbuf,loc1);                                                           
//#7545                nxtlin();                                                           
//#7546                thTxt[LFTHSIZ]=txtwin(stab[STR_FTHSIZ],loc0);                                                           
//#7547                sprintf(msgbuf,"%.2f",frmpnt->dhx.fth.fthrat);                                                           
//#7548                thDat[LFTHSIZ]=numwin(msgbuf,loc1);                                                           
//#7549                nxtlin();                                                           
//#7550                if(frmpnt->dhx.fth.fthtyp==FTHPSG){                                                           
//#7551                                                                           
//#7552                    thTxt[LFTHNUM]=txtwin(stab[STR_FTHNUM],loc0);                                                       
//#7553                    sprintf(msgbuf,"%d",frmpnt->dhx.fth.fthnum);                                                       
//#7554                    thDat[LFTHNUM]=numwin(msgbuf,loc1);                                                       
//#7555                    nxtlin();                                                       
//#7556                }                                                           
//#7557                thTxt[LFTHFLR]=txtwin(stab[STR_FTHFLR],loc0);                                                           
//#7558                sprintf(msgbuf,"%.2f",frmpnt->dhx.fth.fthflr/PFGRAN);                                                           
//#7559                thDat[LFTHFLR]=numwin(msgbuf,loc1);                                                           
//#7560                nxtlin();                                                           
//#7561            }                                                               
//#7562            if(frmpnt->ftyp!=CLPF){                                                               
//#7563                                                                           
//#7564                thTxt[LFRMSPAC]=txtwin(stab[STR_TXT4],loc0);                                                           
//#7565                sprintf(msgbuf,"%.2f",frmpnt->fspac/PFGRAN);                                                           
//#7566                thDat[LFRMSPAC]=numwin(msgbuf,loc1);                                                           
//#7567                nxtlin();                                                           
//#7568            }                                                               
//#7569            if(istx(clofind))                                                               
//#7570            {                                                               
//#7571                thTxt[LTXOF]=txtwin(stab[STR_TXOF],loc0);                                                           
//#7572                sprintf(msgbuf,"%.2f",frmpnt->txof/PFGRAN);                                                           
//#7573                thDat[LTXOF]=numwin(msgbuf,loc1);                                                           
//#7574                nxtlin();                                                           
//#7575            }                                                               
//#7576            thTxt[LMAXFIL]=txtwin(stab[STR_TXT20],loc0);                                                               
//#7577            sprintf(msgbuf,"%.2f",frmpnt->fmax/PFGRAN);                                                               
//#7578            thDat[LMAXFIL]=numwin(msgbuf,loc1);                                                               
//#7579            nxtlin();                                                               
//#7580            if(!isclp(clofind)&&!istx(clofind)){                                                               
//#7581                                                                           
//#7582                thTxt[LFRMLEN]=txtwin(stab[STR_TXT5],loc0);                                                           
//#7583                sprintf(msgbuf,"%.2f",frmpnt->flencnt.flen/PFGRAN);                                                           
//#7584                thDat[LFRMLEN]=numwin(msgbuf,loc1);                                                           
//#7585                nxtlin();                                                           
//#7586            }                                                               
//#7587            thTxt[LMINFIL]=txtwin(stab[STR_TXT21],loc0);                                                               
//#7588            sprintf(msgbuf,"%.2f",frmpnt->fmin/PFGRAN);                                                               
//#7589            thDat[LMINFIL]=numwin(msgbuf,loc1);                                                               
//#7590            nxtlin();                                                               
//#7591            if(frmpnt->ftyp==ANGF||frmpnt->ftyp==TXANGF){                                                               
//#7592                                                                           
//#7593                thTxt[LFRMANG]=txtwin(stab[STR_TXT6],loc0);                                                           
//#7594                sprintf(msgbuf,"%.2f",frmpnt->angclp.fang*180/PI);                                                           
//#7595                thDat[LFRMANG]=numwin(msgbuf,loc1);                                                           
//#7596                nxtlin();                                                           
//#7597            }                                                               
//#7598            if(frmpnt->ftyp==ANGCLPF){                                                               
//#7599                                                                           
//#7600                thTxt[LSACANG]=txtwin(stab[STR_TXT6],loc0);                                                           
//#7601                sprintf(msgbuf,"%.2f",frmpnt->sacang.ang*180/PI);                                                           
//#7602                thDat[LSACANG]=numwin(msgbuf,loc1);                                                           
//#7603                nxtlin();                                                           
//#7604            }                                                               
//#7605            if(frmpnt->ftyp==VCLPF||frmpnt->ftyp==HCLPF||frmpnt->ftyp==ANGCLPF){                                                               
//#7606                                                                           
//#7607                thTxt[LFRMFAZ]=txtwin(stab[STR_TXT18],loc0);                                                           
//#7608                sprintf(msgbuf,"%d",frmpnt->wpar);                                                           
//#7609                thDat[LFRMFAZ]=numwin(msgbuf,loc1);                                                           
//#7610                nxtlin();                                                           
//#7611            }                                                               
//#7612            if(frmpnt->ftyp==VRTF||frmpnt->ftyp==HORF||frmpnt->ftyp==ANGF||istx(clofind)){                                                               
//#7613                                                                           
//#7614                thTxt[LBFILSQR]=txtwin(stab[STR_PRF2],loc0);                                                           
//#7615                if(frmpnt->xat&AT_SQR)                                                           
//#7616                    strcpy(msgbuf,stab[STR_SQR]);                                                       
//#7617                else                                                           
//#7618                    strcpy(msgbuf,stab[STR_PNTD]);                                                       
//#7619                thDat[LBFILSQR]=txtrwin(msgbuf,loc1);                                                           
//#7620                nxtlin();                                                           
//#7621            }                                                               
//#7622        }                                                                   
//#7623        thTxt[LFSTRT]=txtwin(stab[STR_FSTRT],loc0);                                                                   
//#7624        if(frmpnt->xat&AT_STRT)                                                                   
//#7625            strcpy(msgbuf,stab[STR_ON]);                                                               
//#7626        else                                                                   
//#7627            strcpy(msgbuf,stab[STR_OFF]);                                                               
//#7628        thDat[LFSTRT]=txtrwin(msgbuf,loc1);                                                                   
//#7629        nxtlin();                                                                   
//#7630        if(frmpnt->xat&AT_STRT)                                                                   
//#7631        {                                                                   
//#7632            thTxt[LDSTRT]=txtwin(stab[STR_FSTRT],loc0);                                                               
//#7633            sprintf(msgbuf,"%d",frmpnt->strt);                                                               
//#7634            thDat[LDSTRT]=numwin(msgbuf,loc1);                                                               
//#7635            nxtlin();                                                               
//#7636        }                                                                   
//#7637        thTxt[LFEND]=txtwin(stab[STR_FEND],loc0);                                                                   
//#7638        if(frmpnt->xat&AT_END)                                                                   
//#7639            strcpy(msgbuf,stab[STR_ON]);                                                               
//#7640        else                                                                   
//#7641            strcpy(msgbuf,stab[STR_OFF]);                                                               
//#7642        thDat[LFEND]=txtrwin(msgbuf,loc1);                                                                   
//#7643        nxtlin();                                                                   
//#7644        if(frmpnt->xat&AT_END)                                                                   
//#7645        {                                                                   
//#7646            thTxt[LDEND]=txtwin(stab[STR_FEND],loc0);                                                               
//#7647            sprintf(msgbuf,"%d",frmpnt->end);                                                               
//#7648            thDat[LDEND]=numwin(msgbuf,loc1);                                                               
//#7649            nxtlin();                                                               
//#7650        }                                                                   
//#7651        thTxt[LBRD]=txtwin(stab[STR_TXT7],loc0);                                                                   
//#7652        thDat[LBRD]=txtrwin(stab[STR_EDG0+cod],loc1);                                                                   
//#7653        nxtlin();                                                                   
//#7654        if(cod){                                                                   
//#7655                                                                           
//#7656            thTxt[LBRDCOL]=txtwin(stab[STR_TXT8],loc0);                                                               
//#7657            sprintf(msgbuf,"%d",(frmpnt->bcol&0xf)+1);                                                               
//#7658            thDat[LBRDCOL]=numwin(msgbuf,loc1);                                                               
//#7659            nxtlin();                                                               
//#7660            if(egaray[fpnt]&BESPAC){                                                               
//#7661                                                                           
//#7662                thTxt[LBRDSPAC]=txtwin(stab[STR_TXT9],loc0);                                                           
//#7663                if(cod==EGPRP||cod==EGCHNH||cod==EGCHNL)                                                           
//#7664                    sprintf(msgbuf,"%.2f",frmpnt->espac/PFGRAN);                                                       
//#7665                else                                                           
//#7666                    sprintf(msgbuf,"%.2f",frmpnt->espac/PFGRAN*2);                                                       
//#7667                thDat[LBRDSPAC]=numwin(msgbuf,loc1);                                                           
//#7668                nxtlin();                                                           
//#7669            }                                                               
//#7670            if(egaray[fpnt]&BPICSPAC){                                                               
//#7671                                                                           
//#7672                thTxt[LBRDPIC]=txtwin(stab[STR_TXT16],loc0);                                                           
//#7673                sprintf(msgbuf,"%.2f",frmpnt->espac/PFGRAN);                                                           
//#7674                thDat[LBRDPIC]=numwin(msgbuf,loc1);                                                           
//#7675                nxtlin();                                                           
//#7676            }                                                               
//#7677            if(egaray[fpnt]&BEMAX){                                                               
//#7678                                                                           
//#7679                thTxt[LMAXBRD]=txtwin(stab[STR_TXT22],loc0);                                                           
//#7680                sprintf(msgbuf,"%.2f",frmpnt->emax/PFGRAN);                                                           
//#7681                thDat[LMAXBRD]=numwin(msgbuf,loc1);                                                           
//#7682                nxtlin();                                                           
//#7683            }                                                               
//#7684            if(egaray[fpnt]&BELEN){                                                               
//#7685                                                                           
//#7686                thTxt[LBRDLEN]=txtwin(stab[STR_TXT10],loc0);                                                           
//#7687                sprintf(msgbuf,"%.2f",frmpnt->elen/PFGRAN);                                                           
//#7688                thDat[LBRDLEN]=numwin(msgbuf,loc1);                                                           
//#7689                nxtlin();                                                           
//#7690            }                                                               
//#7691            if(egaray[fpnt]&BEMIN){                                                               
//#7692                                                                           
//#7693                thTxt[LMINBRD]=txtwin(stab[STR_TXT23],loc0);                                                           
//#7694                sprintf(msgbuf,"%.2f",frmpnt->emin/PFGRAN);                                                           
//#7695                thDat[LMINBRD]=numwin(msgbuf,loc1);                                                           
//#7696                nxtlin();                                                           
//#7697            }                                                               
//#7698            if(egaray[fpnt]&BESIZ){                                                               
//#7699                                                                           
//#7700                thTxt[LBRDSIZ]=txtwin(stab[STR_TXT11],loc0);                                                           
//#7701                sprintf(msgbuf,"%.2f",frmpnt->esiz/PFGRAN);                                                           
//#7702                thDat[LBRDSIZ]=numwin(msgbuf,loc1);                                                           
//#7703                nxtlin();                                                           
//#7704            }                                                               
//#7705            if(egaray[fpnt]&BRDPOS){                                                               
//#7706                                                                           
//#7707                thTxt[LBRDPOS]=txtwin(stab[STR_TXT18],loc0);                                                           
//#7708                sprintf(msgbuf,"%.2f",frmpnt->elen);                                                           
//#7709                thDat[LBRDPOS]=numwin(msgbuf,loc1);                                                           
//#7710                nxtlin();                                                           
//#7711            }                                                               
//#7712            if(egaray[fpnt]&CHNPOS){                                                               
//#7713                                                                           
//#7714                thTxt[LBRDPOS]=txtwin(stab[STR_TXT19],loc0);                                                           
//#7715                sprintf(msgbuf,"%.2f",frmpnt->elen);                                                           
//#7716                thDat[LBRDPOS]=numwin(msgbuf,loc1);                                                           
//#7717                nxtlin();                                                           
//#7718            }                                                               
//#7719            if(cod==EGAP){                                                               
//#7720                                                                           
//#7721                thTxt[LAPCOL]=txtwin(stab[STR_TXT12],loc0);                                                           
//#7722                sprintf(msgbuf,"%d",(frmpnt->bcol>>4)+1);                                                           
//#7723                thDat[LAPCOL]=numwin(msgbuf,loc1);                                                           
//#7724                nxtlin();                                                           
//#7725            }                                                               
//#7726            if(cod==EGSAT||cod==EGAP||cod==EGPRP){                                                               
//#7727                                                                           
//#7728                thTxt[LBRDUND]=txtwin(stab[STR_TXT17],loc0);                                                           
//#7729                if(frmpnt->etyp&EGUND)                                                           
//#7730                    thDat[LBRDUND]=numwin(stab[STR_ON],loc1);                                                       
//#7731                else                                                           
//#7732                    thDat[LBRDUND]=numwin(stab[STR_OFF],loc1);                                                       
//#7733                nxtlin();                                                           
//#7734            }                                                               
//#7735            if(egaray[fpnt]&BCNRSIZ){                                                               
//#7736                                                                           
//#7737                if(frmpnt->etyp==EGHOL)                                                           
//#7738                    sprintf(msgbuf,"%.2f",getblen()/PFGRAN);                                                       
//#7739                else                                                           
//#7740                    sprintf(msgbuf,"%.2f",getplen()/PFGRAN);                                                       
//#7741                thTxt[LBCSIZ]=txtwin(stab[STR_TXT13],loc0);                                                           
//#7742                thDat[LBCSIZ]=numwin(msgbuf,loc1);                                                           
//#7743                nxtlin();                                                           
//#7744            }                                                               
//#7745            if(frmpnt->typ==LIN&&egaray[fpnt]&BRDEND){                                                               
//#7746                                                                           
//#7747                thTxt[LBSTRT]=txtwin(stab[STR_TXT14],loc0);                                                           
//#7748                if(frmpnt->at&SBLNT)                                                           
//#7749                    thDat[LBSTRT]=numwin(stab[STR_BLUNT],loc1);                                                       
//#7750                else                                                           
//#7751                    thDat[LBSTRT]=numwin(stab[STR_TAPR],loc1);                                                       
//#7752                nxtlin();                                                           
//#7753                thTxt[LBFIN]=txtwin(stab[STR_TXT15],loc0);                                                           
//#7754                if(frmpnt->at&FBLNT)                                                           
//#7755                    thDat[LBFIN]=numwin(stab[STR_BLUNT],loc1);                                                       
//#7756                else                                                           
//#7757                    thDat[LBFIN]=numwin(stab[STR_TAPR],loc1);                                                       
//#7758                nxtlin();                                                           
//#7759            }                                                               
//#7760        }                                                                   
//#7761    }                                                                       
//#7762                                                                           
//#7763    void refrm(){                                                                       
//#7764                                                                           
//#7765        frmpnt=&formlst[clofind];                                                                   
//#7766        if(rstMap(PRFACT)){                                                                   
//#7767                                                                           
//#7768            DestroyWindow(hPrf);                                                               
//#7769            rstMap(WASRT);                                                               
//#7770        }                                                                   
//#7771        siz0.x=siz0.y=siz1.x=siz1.y=0;                                                                   
//#7772        setMap(REFCNT);                                                                   
//#7773        refmcnt=0;                                                                   
//#7774        refrmfn();                                                                   
//#7775        if(hfdat){                                                                   
//#7776                                                                           
//#7777            while(EnumChildWindows(hfdat,chenum,0));                                                               
//#7778            MoveWindow(hfdat,buttonWid3+3,3,siz0.x+siz1.x+18,siz0.y*refmcnt+12,TRUE);                                                               
//#7779            redraw(hfdat);                                                               
//#7780        }                                                                   
//#7781        else{                                                                   
//#7782                                                                           
//#7783            hfdat=CreateWindow(                                                               
//#7784                STATIC,                                                           
//#7785                0                                                           
//#7786                WS_CHILD|WS_VISIBLE|WS_BORDER,                                                           
//#7787                buttonWid3+3,                                                           
//#7788                3                                                           
//#7789                siz0.x+siz1.x+18,                                                           
//#7790                siz0.y*refmcnt+12,                                                           
//#7791                hWnd,                                                           
//#7792                NULL,                                                           
//#7793                hInst,                                                           
//#7794                NULL);                                                           
//#7795        }                                                                   
//#7796        rstMap(REFCNT);                                                                   
//#7797        refrmfn();                                                                   
//#7798    }                                                                       
//#7799                                                                           
//#7800    void pxrct2stch(RECT pxr,FLRCT* str){                                                                       
//#7801                                                                           
//#7802        POINT    tpnt;                                                               
//#7803                                                                           
//#7804        tpnt.x=pxr.left+stOrg.x;                                                                   
//#7805        tpnt.y=pxr.top+stOrg.y;                                                                   
//#7806        pxCor2stch(tpnt);                                                                   
//#7807        str->left=sPnt.x;                                                                   
//#7808        str->top=sPnt.y;                                                                   
//#7809        tpnt.x=pxr.right+stOrg.x;                                                                   
//#7810        tpnt.y=pxr.bottom+stOrg.y;                                                                   
//#7811        pxCor2stch(tpnt);                                                                   
//#7812        str->right=sPnt.x;                                                                   
//#7813        str->bottom=sPnt.y;                                                                   
//#7814    }                                                                       
//#7815                                                                           
//#7816    unsigned pdir(unsigned ind){                                                                       
//#7817                                                                           
//#7818        if(chkMap(PSELDIR))                                                                   
//#7819            return nxt(ind);                                                               
//#7820        else                                                                   
//#7821            return prv(ind);                                                               
//#7822    }                                                                       
//#7823                                                                           
//#7824    void setstrtch(){                                                                       
//#7825                                                                           
//#7826        FLOAT        ref=0;                                                           
//#7827        double        rat=1;                                                           
//#7828        unsigned    ind,ine;                                                               
//#7829        FLRCT        trct;                                                           
//#7830        long        tlng;                                                           
//#7831                                                                           
//#7832        savdo();                                                                   
//#7833        if(chkMap(FPSEL))                                                                   
//#7834            MoveMemory(&trct,&pselrct,sizeof(FLRCT));                                                               
//#7835        else{                                                                   
//#7836                                                                           
//#7837            if(fselpnt||chkMap(BIGBOX))                                                               
//#7838                pxrct2stch(bigrct,&trct);                                                           
//#7839            else{                                                               
//#7840                                                                           
//#7841                fvars(clofind);                                                           
//#7842                px2stch();                                                           
//#7843                trct.bottom=trct.left=trct.right=trct.top=0;                                                           
//#7844            }                                                               
//#7845        }                                                                   
//#7846        switch(cntrl){                                                                   
//#7847                                                                           
//#7848        case 0:                                                                   
//#7849                                                                           
//#7850            if(fselpnt||chkMap(BIGBOX)||chkMap(FPSEL)){                                                               
//#7851                                                                           
//#7852                ref=trct.bottom;                                                           
//#7853                tlng=msg.pt.y-stOrg.y;                                                           
//#7854                rat=(double)(bigrct.bottom-tlng)/(bigrct.bottom-bigrct.top);                                                           
//#7855            }                                                               
//#7856            else{                                                               
//#7857                                                                           
//#7858                if(chkMap(FORMSEL)){                                                           
//#7859                                                                           
//#7860                    ref=frmpnt->rct.bottom;                                                       
//#7861                    rat=(double)(sPnt.y-ref)/(frmpnt->rct.top-ref);                                                       
//#7862                    frmpnt->rct.top=sPnt.y;                                                       
//#7863                }                                                           
//#7864                else{                                                           
//#7865                                                                           
//#7866                    ref=rngrct.bottom;                                                       
//#7867                    rat=(double)(sPnt.y-ref)/(rngrct.top-ref);                                                       
//#7868                }                                                           
//#7869            }                                                               
//#7870            break;                                                               
//#7871                                                                           
//#7872        case 1:                                                                   
//#7873                                                                           
//#7874            if(fselpnt||chkMap(BIGBOX)||chkMap(FPSEL)){                                                               
//#7875                                                                           
//#7876                ref=trct.left;                                                           
//#7877                tlng=msg.pt.x-stOrg.x;                                                           
//#7878                rat=(double)(tlng-bigrct.left)/(bigrct.right-bigrct.left);                                                           
//#7879            }                                                               
//#7880            else{                                                               
//#7881                                                                           
//#7882                if(chkMap(FORMSEL)){                                                           
//#7883                                                                           
//#7884                    ref=frmpnt->rct.left;                                                       
//#7885                    rat=(double)(sPnt.x-ref)/(frmpnt->rct.right-ref);                                                       
//#7886                    frmpnt->rct.right=sPnt.x;                                                       
//#7887                }                                                           
//#7888                else{                                                           
//#7889                                                                           
//#7890                    ref=rngrct.left;                                                       
//#7891                    rat=(double)(sPnt.x-ref)/(rngrct.right-ref);                                                       
//#7892                }                                                           
//#7893            }                                                               
//#7894            break;                                                               
//#7895                                                                           
//#7896        case 2:                                                                   
//#7897                                                                           
//#7898            if(fselpnt||chkMap(BIGBOX)||chkMap(FPSEL)){                                                               
//#7899                                                                           
//#7900                ref=trct.top;                                                           
//#7901                tlng=msg.pt.y-stOrg.y;                                                           
//#7902                rat=(double)(tlng-bigrct.top)/(bigrct.bottom-bigrct.top);                                                           
//#7903            }                                                               
//#7904            else{                                                               
//#7905                                                                           
//#7906                if(chkMap(FORMSEL)){                                                           
//#7907                                                                           
//#7908                    ref=frmpnt->rct.top;                                                       
//#7909                    rat=(double)(sPnt.y-ref)/(frmpnt->rct.bottom-ref);                                                       
//#7910                    frmpnt->rct.bottom=sPnt.y;                                                       
//#7911                }                                                           
//#7912                else{                                                           
//#7913                                                                           
//#7914                    ref=rngrct.top;                                                       
//#7915                    rat=(double)(sPnt.y-ref)/(rngrct.bottom-ref);                                                       
//#7916                }                                                           
//#7917            }                                                               
//#7918            break;                                                               
//#7919                                                                           
//#7920        case 3:                                                                   
//#7921                                                                           
//#7922            if(fselpnt||chkMap(BIGBOX)||chkMap(FPSEL)){                                                               
//#7923                                                                           
//#7924                ref=trct.right;                                                           
//#7925                tlng=msg.pt.x-stOrg.x;                                                           
//#7926                rat=(double)(bigrct.right-tlng)/(bigrct.right-bigrct.left);                                                           
//#7927            }                                                               
//#7928            else{                                                               
//#7929                                                                           
//#7930                if(chkMap(FORMSEL)){                                                           
//#7931                                                                           
//#7932                    ref=frmpnt->rct.right;                                                       
//#7933                    rat=(double)(sPnt.x-ref)/(frmpnt->rct.left-ref);                                                       
//#7934                    frmpnt->rct.left=sPnt.x;                                                       
//#7935                }                                                           
//#7936                else{                                                           
//#7937                                                                           
//#7938                    ref=rngrct.right;                                                       
//#7939                    rat=(double)(sPnt.x-ref)/(rngrct.left-ref);                                                       
//#7940                }                                                           
//#7941            }                                                               
//#7942            break;                                                               
//#7943        }                                                                   
//#7944        if(cntrl&1){                                                                   
//#7945                                                                           
//#7946            if(chkMap(FPSEL)){                                                               
//#7947                                                                           
//#7948                fvars(clofind);                                                           
//#7949                ine=pselrng.strt;                                                           
//#7950                for(ind=0;ind<=pselrng.cnt;ind++){                                                           
//#7951                                                                           
//#7952                    flt[ine].x=(flt[ine].x-ref)*rat+ref;                                                       
//#7953                    ine=pdir(ine);                                                       
//#7954                }                                                           
//#7955                frmout(clofind);                                                           
//#7956                setpsel();                                                           
//#7957                setMap(RESTCH);                                                           
//#7958                return;                                                           
//#7959            }                                                               
//#7960            if(chkMap(BIGBOX)){                                                               
//#7961                                                                           
//#7962                for(ind=0;ind<formpnt;ind++){                                                           
//#7963                                                                           
//#7964                    flt=formlst[ind].flt;                                                       
//#7965                    for(ine=0;ine<formlst[ind].sids;ine++)                                                       
//#7966                        flt[ine].x=(flt[ine].x-ref)*rat+ref;                                                   
//#7967                    frmout(ind);                                                       
//#7968                }                                                           
//#7969                for(ind=0;ind<hed.stchs;ind++)                                                           
//#7970                    stchs[ind].x=(stchs[ind].x-ref)*rat+ref;                                                       
//#7971                selal();                                                           
//#7972                return;                                                           
//#7973            }                                                               
//#7974            else{                                                               
//#7975                                                                           
//#7976                if(fselpnt){                                                           
//#7977                                                                           
//#7978                    for(ind=0;ind<fselpnt;ind++){                                                       
//#7979                                                                           
//#7980                        flt=formlst[selist[ind]].flt;                                                   
//#7981                        for(ine=0;ine<formlst[selist[ind]].sids;ine++)                                                   
//#7982                            flt[ine].x=(flt[ine].x-ref)*rat+ref;                                               
//#7983                    }                                                       
//#7984                }                                                           
//#7985                else{                                                           
//#7986                                                                           
//#7987                    if(chkMap(FORMSEL)){                                                       
//#7988                                                                           
//#7989                        for(ind=0;ind<sids;ind++)                                                   
//#7990                            flt[ind].x=(flt[ind].x-ref)*rat+ref;                                               
//#7991                    }                                                       
//#7992                    else{                                                       
//#7993                                                                           
//#7994                        for(ind=gpnt0;ind<=gpnt1;ind++)                                                   
//#7995                            stchs[ind].x=(stchs[ind].x-ref)*rat+ref;                                               
//#7996                    }                                                       
//#7997                }                                                           
//#7998            }                                                               
//#7999        }                                                                   
//#8000        else{                                                                   
//#8001                                                                           
//#8002            if(chkMap(FPSEL)){                                                               
//#8003                                                                           
//#8004                fvars(clofind);                                                           
//#8005                ine=pselrng.strt;                                                           
//#8006                for(ind=0;ind<=pselrng.cnt;ind++){                                                           
//#8007                                                                           
//#8008                    flt[ine].y=(flt[ine].y-ref)*rat+ref;                                                       
//#8009                    ine=pdir(ine);                                                       
//#8010                }                                                           
//#8011                frmout(clofind);                                                           
//#8012                setpsel();                                                           
//#8013                refil();                                                           
//#8014                setMap(RESTCH);                                                           
//#8015                return;                                                           
//#8016            }                                                               
//#8017            if(chkMap(BIGBOX)){                                                               
//#8018                                                                           
//#8019                for(ind=0;ind<formpnt;ind++){                                                           
//#8020                                                                           
//#8021                    flt=formlst[ind].flt;                                                       
//#8022                    for(ine=0;ine<formlst[ind].sids;ine++)                                                       
//#8023                        flt[ine].y=(flt[ine].y-ref)*rat+ref;                                                   
//#8024                    frmout(ind);                                                       
//#8025                }                                                           
//#8026                for(ind=0;ind<hed.stchs;ind++)                                                           
//#8027                    stchs[ind].y=(stchs[ind].y-ref)*rat+ref;                                                       
//#8028                selal();                                                           
//#8029                return;                                                           
//#8030            }                                                               
//#8031            else{                                                               
//#8032                                                                           
//#8033                if(fselpnt){                                                           
//#8034                                                                           
//#8035                    for(ind=0;ind<fselpnt;ind++){                                                       
//#8036                                                                           
//#8037                        flt=formlst[selist[ind]].flt;                                                   
//#8038                        for(ine=0;ine<formlst[selist[ind]].sids;ine++)                                                   
//#8039                            flt[ine].y=(flt[ine].y-ref)*rat+ref;                                               
//#8040                    }                                                       
//#8041                }                                                           
//#8042                else{                                                           
//#8043                                                                           
//#8044                    if(chkMap(FORMSEL)){                                                       
//#8045                                                                           
//#8046                        for(ind=0;ind<sids;ind++)                                                   
//#8047                            flt[ind].y=(flt[ind].y-ref)*rat+ref;                                               
//#8048                    }                                                       
//#8049                    else{                                                       
//#8050                                                                           
//#8051                        for(ind=gpnt0;ind<=gpnt1;ind++)                                                   
//#8052                            stchs[ind].y=(stchs[ind].y-ref)*rat+ref;                                               
//#8053                    }                                                       
//#8054                }                                                           
//#8055            }                                                               
//#8056        }                                                                   
//#8057        if(fselpnt){                                                                   
//#8058                                                                           
//#8059            for(ind=0;ind<fselpnt;ind++){                                                               
//#8060                                                                           
//#8061                ine=selist[ind];                                                           
//#8062                frmout(ine);                                                           
//#8063                clofind=ine;                                                           
//#8064                refil();                                                           
//#8065            }                                                               
//#8066        }                                                                   
//#8067        else                                                                   
//#8068            if(chkMap(FORMSEL))                                                               
//#8069                refil();                                                           
//#8070        setMap(RESTCH);                                                                   
//#8071    }                                                                       
//#8072                                                                           
//#8073    void setexpand(){                                                                       
//#8074                                                                           
//#8075        DUBPNT        ref;                                                           
//#8076        POINT        tref;                                                           
//#8077        FLPNT        sref;                                                           
//#8078        DUBPNT        siz0;                                                           
//#8079        DUBPNT        siz1;                                                           
//#8080        DUBPNT        rat;                                                           
//#8081        double        aspect;                                                           
//#8082        unsigned    ind,ine;                                                               
//#8083        FLRCT        rct;                                                           
//#8084                                                                           
//#8085        savdo();                                                                   
//#8086        if(fselpnt||chkMap(BIGBOX)||chkMap(FPSEL)){                                                                   
//#8087                                                                           
//#8088            rct.bottom=bigrct.bottom;                                                               
//#8089            rct.left=bigrct.left;                                                               
//#8090            rct.right=bigrct.right;                                                               
//#8091            rct.top=bigrct.top;                                                               
//#8092            sPnt.x=msg.pt.x-stOrg.x;                                                               
//#8093            sPnt.y=msg.pt.y-stOrg.y;                                                               
//#8094            siz0.y=rct.bottom-rct.top;                                                               
//#8095        }                                                                   
//#8096        else{                                                                   
//#8097                                                                           
//#8098            px2stch();                                                               
//#8099            fvars(clofind);                                                               
//#8100            if(chkMap(FORMSEL))                                                               
//#8101                rct=frmpnt->rct;                                                           
//#8102            else{                                                               
//#8103                                                                           
//#8104                rct.bottom=rngrct.bottom;                                                           
//#8105                rct.top=rngrct.top;                                                           
//#8106                rct.right=rngrct.right;                                                           
//#8107                rct.left=rngrct.left;                                                           
//#8108            }                                                               
//#8109            siz0.y=rct.top-rct.bottom;                                                               
//#8110        }                                                                   
//#8111        rat.x=rat.y=1;                                                                   
//#8112        ref.x=ref.y=0;                                                                   
//#8113        siz0.x=rct.right-rct.left;                                                                   
//#8114        switch(cntrl){                                                                   
//#8115                                                                           
//#8116        case 0:                                                                   
//#8117                                                                           
//#8118            ref.x=rct.right;                                                               
//#8119            ref.y=rct.bottom;                                                               
//#8120            siz1.x=fabs(sPnt.x-ref.x);                                                               
//#8121            siz1.y=fabs(sPnt.y-ref.y);                                                               
//#8122            aspect=siz1.x/siz1.y;                                                               
//#8123            if(aspect<xpct)                                                               
//#8124                siz1.x=siz1.y*xpct;                                                           
//#8125            else                                                               
//#8126                siz1.y=siz1.x/xpct;                                                           
//#8127            rat.x=siz1.x/siz0.x;                                                               
//#8128            rat.y=siz1.y/siz0.y;                                                               
//#8129            if(!fselpnt&&chkMap(FORMSEL)){                                                               
//#8130                                                                           
//#8131                frmpnt->rct.left=rct.right-siz1.x;                                                           
//#8132                frmpnt->rct.top=rct.bottom+siz1.y;                                                           
//#8133            }                                                               
//#8134            break;                                                               
//#8135                                                                           
//#8136        case 1:                                                                   
//#8137                                                                           
//#8138            ref.x=rct.left;                                                               
//#8139            ref.y=rct.bottom;                                                               
//#8140            siz1.x=fabs(sPnt.x-ref.x);                                                               
//#8141            siz1.y=fabs(sPnt.y-ref.y);                                                               
//#8142            aspect=siz1.x/siz1.y;                                                               
//#8143            if(aspect<xpct)                                                               
//#8144                siz1.x=siz1.y*xpct;                                                           
//#8145            else                                                               
//#8146                siz1.y=siz1.x/xpct;                                                           
//#8147            rat.x=siz1.x/siz0.x;                                                               
//#8148            rat.y=siz1.y/siz0.y;                                                               
//#8149            if(!fselpnt&&chkMap(FORMSEL)){                                                               
//#8150                                                                           
//#8151                frmpnt->rct.right=rct.left+siz1.x;                                                           
//#8152                frmpnt->rct.top=rct.bottom+siz1.y;                                                           
//#8153            }                                                               
//#8154            break;                                                               
//#8155                                                                           
//#8156        case 2:                                                                   
//#8157                                                                           
//#8158            ref.x=rct.left;                                                               
//#8159            ref.y=rct.top;                                                               
//#8160            siz1.x=fabs(sPnt.x-ref.x);                                                               
//#8161            siz1.y=fabs(sPnt.y-ref.y);                                                               
//#8162            aspect=siz1.x/siz1.y;                                                               
//#8163            if(aspect<xpct)                                                               
//#8164                siz1.x=siz1.y*xpct;                                                           
//#8165            else                                                               
//#8166                siz1.y=siz1.x/xpct;                                                           
//#8167            rat.x=siz1.x/siz0.x;                                                               
//#8168            rat.y=siz1.y/siz0.y;                                                               
//#8169            if(!fselpnt&&chkMap(FORMSEL)){                                                               
//#8170                                                                           
//#8171                frmpnt->rct.right=rct.left+siz1.x;                                                           
//#8172                frmpnt->rct.bottom=rct.top-siz1.y;                                                           
//#8173            }                                                               
//#8174            break;                                                               
//#8175                                                                           
//#8176        case 3:                                                                   
//#8177                                                                           
//#8178            ref.x=rct.right;                                                               
//#8179            ref.y=rct.top;                                                               
//#8180            siz1.x=fabs(sPnt.x-ref.x);                                                               
//#8181            siz1.y=fabs(sPnt.y-ref.y);                                                               
//#8182            aspect=siz1.x/siz1.y;                                                               
//#8183            if(aspect<xpct)                                                               
//#8184                siz1.x=siz1.y*xpct;                                                           
//#8185            else                                                               
//#8186                siz1.y=siz1.x/xpct;                                                           
//#8187            rat.x=siz1.x/siz0.x;                                                               
//#8188            rat.y=siz1.y/siz0.y;                                                               
//#8189            if(!fselpnt&&chkMap(FORMSEL)){                                                               
//#8190                                                                           
//#8191                frmpnt->rct.left=rct.right-siz1.x;                                                           
//#8192                frmpnt->rct.bottom=rct.top-siz1.y;                                                           
//#8193            }                                                               
//#8194            break;                                                               
//#8195        }                                                                   
//#8196        tref.x=ref.x;                                                                   
//#8197        tref.y=ref.y;                                                                   
//#8198        px2stchf(tref,&sref);                                                                   
//#8199        if(chkMap(FPSEL)){                                                                   
//#8200                                                                           
//#8201            fvars(clofind);                                                               
//#8202            ine=pselrng.strt;                                                               
//#8203            for(ind=0;ind<=pselrng.cnt;ind++){                                                               
//#8204                                                                           
//#8205                flt[ine].x=(flt[ine].x-sref.x)*rat.x+sref.x;                                                           
//#8206                flt[ine].y=(flt[ine].y-sref.y)*rat.y+sref.y;                                                           
//#8207                ine=pdir(ine);                                                           
//#8208            }                                                               
//#8209            setpsel();                                                               
//#8210            frmout(clofind);                                                               
//#8211            refil();                                                               
//#8212            setMap(RESTCH);                                                               
//#8213            return;                                                               
//#8214        }                                                                   
//#8215        if(chkMap(BIGBOX)){                                                                   
//#8216                                                                           
//#8217            for(ind=0;ind<formpnt;ind++){                                                               
//#8218                                                                           
//#8219                fvars(ind);                                                           
//#8220                for(ine=0;ine<frmpnt->sids;ine++){                                                           
//#8221                                                                           
//#8222                    flt[ine].x=(flt[ine].x-sref.x)*rat.x+sref.x;                                                       
//#8223                    flt[ine].y=(flt[ine].y-sref.y)*rat.y+sref.y;                                                       
//#8224                }                                                           
//#8225                frmout(ind);                                                           
//#8226            }                                                               
//#8227            for(ind=0;ind<hed.stchs;ind++){                                                               
//#8228                                                                           
//#8229                stchs[ind].x=(stchs[ind].x-sref.x)*rat.x+sref.x;                                                           
//#8230                stchs[ind].y=(stchs[ind].y-sref.y)*rat.y+sref.y;                                                           
//#8231            }                                                               
//#8232            selal();                                                               
//#8233            return;                                                               
//#8234        }                                                                   
//#8235        else{                                                                   
//#8236                                                                           
//#8237            if(fselpnt){                                                               
//#8238                                                                           
//#8239                for(ind=0;ind<fselpnt;ind++){                                                           
//#8240                                                                           
//#8241                    fvars(selist[ind]);                                                       
//#8242                    for(ine=0;ine<frmpnt->sids;ine++){                                                       
//#8243                                                                           
//#8244                        flt[ine].x=(flt[ine].x-sref.x)*rat.x+sref.x;                                                   
//#8245                        flt[ine].y=(flt[ine].y-sref.y)*rat.y+sref.y;                                                   
//#8246                    }                                                       
//#8247                    frmout(selist[ind]);                                                       
//#8248                    clofind=selist[ind];                                                       
//#8249                    refil();                                                       
//#8250                }                                                           
//#8251            }                                                               
//#8252            else{                                                               
//#8253                                                                           
//#8254                if(chkMap(FORMSEL)){                                                           
//#8255                                                                           
//#8256                    for(ind=0;ind<sids;ind++){                                                       
//#8257                                                                           
//#8258                        flt[ind].x=(flt[ind].x-ref.x)*rat.x+ref.x;                                                   
//#8259                        flt[ind].y=(flt[ind].y-ref.y)*rat.y+ref.y;                                                   
//#8260                    }                                                       
//#8261                    refil();                                                       
//#8262                }                                                           
//#8263                else{                                                           
//#8264                                                                           
//#8265                    for(ind=gpnt0;ind<=gpnt1;ind++){                                                       
//#8266                                                                           
//#8267                        stchs[ind].x=(stchs[ind].x-ref.x)*rat.x+ref.x;                                                   
//#8268                        stchs[ind].y=(stchs[ind].y-ref.y)*rat.y+ref.y;                                                   
//#8269                    }                                                       
//#8270                }                                                           
//#8271            }                                                               
//#8272            setMap(RESTCH);                                                               
//#8273        }                                                                   
//#8274    }                                                                       
//#8275                                                                           
//#8276    void nufilcol(unsigned col){                                                                       
//#8277                                                                           
//#8278        unsigned at,ind;                                                                   
//#8279                                                                           
//#8280        if(frmpnt->fcol!=col){                                                                   
//#8281                                                                           
//#8282            frmpnt->fcol=col;                                                               
//#8283            at=(clofind<<4)|FRMFIL;                                                               
//#8284            for(ind=0;ind<hed.stchs;ind++){                                                               
//#8285                                                                           
//#8286                if((stchs[ind].at&(FRMSK|TYPMSK|FTHMSK))==at){                                                           
//#8287                                                                           
//#8288                    stchs[ind].at&=0xfffffff0;                                                       
//#8289                    stchs[ind].at|=col;                                                       
//#8290                }                                                           
//#8291            }                                                               
//#8292        }                                                                   
//#8293    }                                                                       
//#8294                                                                           
//#8295    void nufthcol(unsigned col){                                                                       
//#8296                                                                           
//#8297        unsigned at,ind;                                                                   
//#8298                                                                           
//#8299        if(frmpnt->dhx.fth.fthcol!=col){                                                                   
//#8300                                                                           
//#8301            frmpnt->dhx.fth.fthcol=col;                                                               
//#8302            at=(clofind<<4)|FTHMSK;                                                               
//#8303            for(ind=0;ind<hed.stchs;ind++){                                                               
//#8304                                                                           
//#8305                if((stchs[ind].at&(FRMSK|FTHMSK))==at){                                                           
//#8306                                                                           
//#8307                    stchs[ind].at&=0xfffffff0;                                                       
//#8308                    stchs[ind].at|=col;                                                       
//#8309                }                                                           
//#8310            }                                                               
//#8311        }                                                                   
//#8312    }                                                                       
//#8313                                                                           
//#8314    void nubrdcol(unsigned col){                                                                       
//#8315                                                                           
//#8316        unsigned at,ind;                                                                   
//#8317                                                                           
//#8318        frmpnt->bcol=col;                                                                   
//#8319        at=(clofind<<4)|FRMBFIL;                                                                   
//#8320        for(ind=0;ind<hed.stchs;ind++){                                                                   
//#8321                                                                           
//#8322            if((stchs[ind].at&(FRMSK|TYPMSK))==at){                                                               
//#8323                                                                           
//#8324                stchs[ind].at&=0xfffffff0;                                                           
//#8325                stchs[ind].at|=col;                                                           
//#8326            }                                                               
//#8327        }                                                                   
//#8328    }                                                                       
//#8329                                                                           
//#8330    void nulapcol(unsigned col){                                                                       
//#8331                                                                           
//#8332        unsigned at,ind;                                                                   
//#8333                                                                           
//#8334        if((unsigned)(frmpnt->bcol>>4)!=col){                                                                   
//#8335                                                                           
//#8336            frmpnt->bcol&=0xf;                                                               
//#8337            frmpnt->bcol|=col<<4;                                                               
//#8338            at=(clofind<<4)|TYPMSK;                                                               
//#8339            for(ind=0;ind<hed.stchs;ind++){                                                               
//#8340                                                                           
//#8341                if((stchs[ind].at&(TYPMSK|FRMSK))==at){                                                           
//#8342                                                                           
//#8343                    stchs[ind].at&=0xfffffff0;                                                       
//#8344                    stchs[ind].at|=col;                                                       
//#8345                }                                                           
//#8346            }                                                               
//#8347        }                                                                   
//#8348    }                                                                       
//#8349                                                                           
//#8350    void sidwnd(HWND wnd){                                                                       
//#8351                                                                           
//#8352        RECT        wrct;                                                           
//#8353        unsigned    baksid;                                                               
//#8354                                                                           
//#8355        msgpnt=0;                                                                   
//#8356        sidbuf[0]=0;                                                                   
//#8357        baksid=sidtyp;                                                                   
//#8358        unsid();                                                                   
//#8359        sidtyp=baksid;                                                                   
//#8360        GetWindowRect(wnd,&wrct);                                                                   
//#8361        GetWindowRect(hfdat,&msgRct);                                                                   
//#8362        hSid=CreateWindow(                                                                   
//#8363            STATIC,                                                               
//#8364            0                                                               
//#8365            WS_BORDER|WS_CHILD|WS_VISIBLE,                                                               
//#8366            msgRct.right-morg.x+3,                                                               
//#8367            wrct.top-morg.y-3,                                                               
//#8368            buttonWid3,                                                               
//#8369            wrct.bottom-wrct.top+3,                                                               
//#8370            hWnd,                                                               
//#8371            NULL,                                                               
//#8372            hInst,                                                               
//#8373            NULL);                                                               
//#8374    }                                                                       
//#8375                                                                           
//#8376    void prfsid(HWND wnd){                                                                       
//#8377                                                                           
//#8378        RECT    wrct;                                                               
//#8379                                                                           
//#8380        msgpnt=0;                                                                   
//#8381        sidbuf[0]=0;                                                                   
//#8382        unsid();                                                                   
//#8383        GetWindowRect(wnd,&wrct);                                                                   
//#8384        GetClientRect(hPrf,&msgRct);                                                                   
//#8385        hSid=CreateWindow(                                                                   
//#8386            STATIC,                                                               
//#8387            0                                                               
//#8388            WS_BORDER|WS_CHILD|WS_VISIBLE,                                                               
//#8389            wrct.right-morg.x+6,                                                               
//#8390            wrct.top-morg.y-3,                                                               
//#8391            siz1.x,                                                               
//#8392            wrct.bottom-wrct.top+3,                                                               
//#8393            hWnd,                                                               
//#8394            NULL,                                                               
//#8395            hInst,                                                               
//#8396            NULL);                                                               
//#8397    }                                                                       
//#8398                                                                           
//#8399    void sbold(){                                                                       
//#8400                                                                           
//#8401        fvars(clofind);                                                                   
//#8402        deleclp(clofind);                                                                   
//#8403        frmpnt->etyp=EGBLD;                                                                   
//#8404        frmpnt->bcol=actcol;                                                                   
//#8405        refilfn();                                                                   
//#8406    }                                                                       
//#8407                                                                           
//#8408    void dubold(){                                                                       
//#8409                                                                           
//#8410        unsigned ind;                                                                   
//#8411                                                                           
//#8412        if(filmsgs(FML_BLD))                                                                   
//#8413            return;                                                               
//#8414        if(fselpnt){                                                                   
//#8415                                                                           
//#8416            for(ind=0;ind<fselpnt;ind++){                                                               
//#8417                                                                           
//#8418                clofind=selist[ind];                                                           
//#8419                fvars(clofind);                                                           
//#8420                sbold();                                                           
//#8421            }                                                               
//#8422            setMap(INIT);                                                               
//#8423            coltab();                                                               
//#8424            setMap(RESTCH);                                                               
//#8425        }                                                                   
//#8426        else{                                                                   
//#8427                                                                           
//#8428            if(chkMap(FORMSEL)){                                                               
//#8429                                                                           
//#8430                sbold();                                                           
//#8431                coltab();                                                           
//#8432                setMap(INIT);                                                           
//#8433                setMap(RESTCH);                                                           
//#8434                ritot(hed.stchs);                                                           
//#8435            }                                                               
//#8436        }                                                                   
//#8437    }                                                                       
//#8438                                                                           
//#8439    void prftwin(TCHAR* str){                                                                       
//#8440                                                                           
//#8441        CreateWindow(                                                                   
//#8442            STATIC,                                                               
//#8443            str,                                                               
//#8444            WS_CHILD|WS_VISIBLE,                                                               
//#8445            loc0.left,                                                               
//#8446            loc0.top,                                                               
//#8447            loc0.right-loc0.left,                                                               
//#8448            loc0.bottom-loc0.top,                                                               
//#8449            hPrf,                                                               
//#8450            NULL,                                                               
//#8451            hInst,                                                               
//#8452            NULL);                                                               
//#8453    }                                                                       
//#8454                                                                           
//#8455    HWND prfnwin(TCHAR* str){                                                                       
//#8456                                                                           
//#8457        return CreateWindow(                                                                   
//#8458            STATIC,                                                               
//#8459            str,                                                               
//#8460            SS_NOTIFY|SS_RIGHT|WS_BORDER|WS_CHILD|WS_VISIBLE,                                                               
//#8461            loc1.left,                                                               
//#8462            loc1.top,                                                               
//#8463            loc1.right-loc1.left,                                                               
//#8464            loc1.bottom-loc1.top,                                                               
//#8465            hPrf,                                                               
//#8466            NULL,                                                               
//#8467            hInst,                                                               
//#8468            NULL);                                                               
//#8469    }                                                                       
//#8470                                                                           
//#8471    void prflin(unsigned lin){                                                                       
//#8472                                                                           
//#8473        prftwin(stab[lin]);                                                                   
//#8474        thDat[lin-STR_PRF0]=prfnwin(msgbuf);                                                                   
//#8475        nxtlin();                                                                   
//#8476    }                                                                       
//#8477                                                                           
//#8478    void sethup(){                                                                       
//#8479                                                                           
//#8480        if(ini.hupx==LHUPX&&ini.hupy==LHUPY){                                                                   
//#8481                                                                           
//#8482            ini.hup=LARGHUP;                                                               
//#8483            return;                                                               
//#8484        }                                                                   
//#8485        if(ini.hupx==SHUPX&&ini.hupy==SHUPY){                                                                   
//#8486                                                                           
//#8487            ini.hup=SMALHUP;                                                               
//#8488            return;                                                               
//#8489        }                                                                   
//#8490        if(ini.hupx==HUP100XY&&ini.hupy==HUP100XY){                                                                   
//#8491                                                                           
//#8492            ini.hup=HUP100;                                                               
//#8493            return;                                                               
//#8494        }                                                                   
//#8495        ini.hup=CUSTHUP;                                                                   
//#8496    }                                                                       
//#8497                                                                           
//#8498    #if LANG==ENG||LANG==HNG                                                                       
//#8499                                                                           
//#8500    void prfmsg(){                                                                       
//#8501                                                                           
//#8502        HDC        prfdc;                                                           
//#8503        RECT    prfrct;                                                               
//#8504                                                                           
//#8505        if(rstMap(INSRT))                                                                   
//#8506            setMap(WASRT);                                                               
//#8507        rstMap(BIGBOX);                                                                   
//#8508        fselpnt=0;                                                                   
//#8509        if(hfdat){                                                                   
//#8510                                                                           
//#8511            undat();                                                               
//#8512            unsid();                                                               
//#8513            sidtyp=0;                                                               
//#8514        }                                                                   
//#8515        siz0.x=siz0.y=0;                                                                   
//#8516        siz1.x=siz1.y=0;                                                                   
//#8517        maxtsiz(stab[STR_PRF0+4],&siz0);                                                                   
//#8518        maxtsiz(stab[STR_TAPR],&siz1);                                                                   
//#8519        siz0.x=prfsiz;                                                                   
//#8520        siz0.x+=4;                                                                   
//#8521    #if LANG==HNG                                                                       
//#8522        siz0.x+=10;                                                                   
//#8523    #endif                                                                       
//#8524        DestroyWindow(hPrf);                                                                   
//#8525        prfwid=siz0.x+siz1.x+18;                                                                   
//#8526        hPrf=CreateWindow(                                                                   
//#8527            STATIC,                                                               
//#8528            0                                                               
//#8529            WS_CHILD|WS_VISIBLE|WS_BORDER,                                                               
//#8530            buttonWid3+3,                                                               
//#8531            3                                                               
//#8532            prfwid,                                                               
//#8533            siz0.y*PRFLINS+12,                                                               
//#8534            hWnd,                                                               
//#8535            NULL,                                                               
//#8536            hInst,                                                               
//#8537            NULL);                                                               
//#8538        prfdc=GetDC(hPrf);                                                                   
//#8539        GetClientRect(hPrf,&prfrct);                                                                   
//#8540        FillRect(prfdc,&prfrct,(HBRUSH)(COLOR_WINDOW+1));                                                                   
//#8541        loc0.top=loc1.top=3;                                                                   
//#8542        loc0.bottom=loc1.bottom=3+siz0.y;                                                                   
//#8543        loc0.left=3;                                                                   
//#8544        loc0.right=3+siz0.x;                                                                   
//#8545        loc1.left=6+siz0.x;                                                                   
//#8546        loc1.right=6+siz0.x+siz1.x+6;                                                                   
//#8547        sprintf(msgbuf,"%d",apcol+1);                                                                   
//#8548        prflin(STR_PRF10);                                                                   
//#8549        sprintf(msgbuf,"%.2f",brdwid/PFGRAN);                                                                   
//#8550        prflin(STR_PRF3);                                                                   
//#8551        sprintf(msgbuf,"%.2f",bfclen/PFGRAN);                                                                   
//#8552        prflin(STR_PRF14);                                                                   
//#8553        sprintf(msgbuf,"%.2f",ini.chspac/PFGRAN);                                                                   
//#8554        prflin(STR_PRF23);                                                                   
//#8555        sprintf(msgbuf,"%.2f",ini.chrat);                                                                   
//#8556        prflin(STR_PRF24);                                                                   
//#8557        sprintf(msgbuf,"%.2f mm",ini.clpof/PFGRAN);                                                                   
//#8558        prflin(STR_PRF21);                                                                   
//#8559        sprintf(msgbuf,"%d",ini.faz);                                                                   
//#8560        prflin(STR_PRF22);                                                                   
//#8561        sprintf(msgbuf,"%.2f",ini.egrat);                                                                   
//#8562        prflin(STR_PRF26);                                                                   
//#8563        sprintf(msgbuf,"%.2f",ini.angl/PI*180);                                                                   
//#8564        prflin(STR_PRF1);                                                                   
//#8565        if(chku(SQRFIL))                                                                   
//#8566            strcpy(msgbuf,stab[STR_SQR]);                                                               
//#8567        else                                                                   
//#8568            strcpy(msgbuf,stab[STR_PNTD]);                                                               
//#8569        prflin(STR_PRF2);                                                                   
//#8570        sprintf(msgbuf,"%.2f",stspace/PFGRAN);                                                                   
//#8571        prflin(STR_PRF0);                                                                   
//#8572        sprintf(msgbuf,"%d",duthrsh(shopnts));                                                                   
//#8573        prflin(STR_PRF7);                                                                   
//#8574        sprintf(msgbuf,"%.2f mm",ini.grdsiz/PFGRAN);                                                                   
//#8575        prflin(STR_PRF20);                                                                   
//#8576        sethup();                                                                   
//#8577        sprintf(msgbuf,stab[STR_HUP0+ini.hup-1]);                                                                   
//#8578        prflin(STR_PRF17);                                                                   
//#8579        sprintf(msgbuf,"%.0f mm",ini.hupy/PFGRAN);                                                                   
//#8580        prflin(STR_PRF27);                                                                   
//#8581        sprintf(msgbuf,"%.0f mm",ini.hupx/PFGRAN);                                                                   
//#8582        prflin(STR_PRF18);                                                                   
//#8583        sprintf(msgbuf,"%.2f",ini.nudg);                                                                   
//#8584        prflin(STR_PRF25);                                                                   
//#8585        sprintf(msgbuf,"%.2f",picspac/PFGRAN);                                                                   
//#8586        prflin(STR_PRF16);                                                                   
//#8587        if(chku(BLUNT))                                                                   
//#8588            strcpy(msgbuf,stab[STR_BLUNT]);                                                               
//#8589        else                                                                   
//#8590            strcpy(msgbuf,stab[STR_TAPR]);                                                               
//#8591        prflin(STR_PRF15);                                                                   
//#8592        if(chku(DUND))                                                                   
//#8593            strcpy(msgbuf,stab[STR_ON]);                                                               
//#8594        else                                                                   
//#8595            strcpy(msgbuf,stab[STR_OFF]);                                                               
//#8596        prflin(STR_PRF19);                                                                   
//#8597        sprintf(msgbuf,"%.2f",smalsiz/PFGRAN);                                                                   
//#8598        prflin(STR_PRF9);                                                                   
//#8599        sprintf(msgbuf,"%.2f",snplen/PFGRAN);                                                                   
//#8600        prflin(STR_PRF11);                                                                   
//#8601        sprintf(msgbuf,"%.2f",spirwrap);                                                                   
//#8602        prflin(STR_PRF13);                                                                   
//#8603        sprintf(msgbuf,"%.2f",starat);                                                                   
//#8604        prflin(STR_PRF12);                                                                   
//#8605        sprintf(msgbuf,"%d",duthrsh(stchboxs));                                                                   
//#8606        prflin(STR_PRF8);                                                                   
//#8607        sprintf(msgbuf,"%.2f",ini.maxsiz/PFGRAN);                                                                   
//#8608        prflin(STR_PRF4);                                                                   
//#8609        sprintf(msgbuf,"%.2f",usesiz/PFGRAN);                                                                   
//#8610        prflin(STR_PRF5);                                                                   
//#8611        sprintf(msgbuf,"%.2f",minsiz/PFGRAN);                                                                   
//#8612        prflin(STR_PRF6);                                                                   
//#8613        setMap(PRFACT);                                                                   
//#8614        ReleaseDC(hWnd,prfdc);                                                                   
//#8615    }                                                                       
//#8616    #endif                                                                       
//#8617                                                                           
//#8618    #if LANG==GRM                                                                       
//#8619                                                                           
//#8620    void prfmsg(){                                                                       
//#8621                                                                           
//#8622        HDC        prfdc;                                                           
//#8623        RECT    prfrct;                                                               
//#8624                                                                           
//#8625        if(rstMap(INSRT))                                                                   
//#8626            setMap(WASRT);                                                               
//#8627        rstMap(BIGBOX);                                                                   
//#8628        fselpnt=0;                                                                   
//#8629        if(hfdat){                                                                   
//#8630                                                                           
//#8631            undat();                                                               
//#8632            unsid();                                                               
//#8633            sidtyp=0;                                                               
//#8634        }                                                                   
//#8635        siz0.x=siz0.y=0;                                                                   
//#8636        siz1.x=siz1.y=0;                                                                   
//#8637        maxtsiz(stab[STR_PRF0+4],&siz0);                                                                   
//#8638        maxtsiz(stab[STR_BLUNT],&siz1);                                                                   
//#8639        siz0.x=prfsiz;                                                                   
//#8640        siz1.x+=4;                                                                   
//#8641        DestroyWindow(hPrf);                                                                   
//#8642        prfwid=siz0.x+siz1.x+18;                                                                   
//#8643        hPrf=CreateWindow(                                                                   
//#8644            STATIC,                                                               
//#8645            0                                                               
//#8646            WS_CHILD|WS_VISIBLE|WS_BORDER,                                                               
//#8647            buttonWid3+3,                                                               
//#8648            3                                                               
//#8649            prfwid,                                                               
//#8650            siz0.y*PRFLINS+12,                                                               
//#8651            hWnd,                                                               
//#8652            NULL,                                                               
//#8653            hInst,                                                               
//#8654            NULL);                                                               
//#8655        prfdc=GetDC(hPrf);                                                                   
//#8656        GetClientRect(hPrf,&prfrct);                                                                   
//#8657        FillRect(prfdc,&prfrct,(HBRUSH)(COLOR_WINDOW+1));                                                                   
//#8658        loc0.top=loc1.top=3;                                                                   
//#8659        loc0.bottom=loc1.bottom=3+siz0.y;                                                                   
//#8660        loc0.left=3;                                                                   
//#8661        loc0.right=3+siz0.x;                                                                   
//#8662        loc1.left=6+siz0.x;                                                                   
//#8663        loc1.right=6+siz0.x+siz1.x+6;                                                                   
//#8664        sprintf(msgbuf,"%.2f",usesiz/PFGRAN);                                                                   
//#8665        prflin(STR_PRF5);                                                                   
//#8666        sprintf(msgbuf,"%.2f",ini.maxsiz/PFGRAN);                                                                   
//#8667        prflin(STR_PRF4);                                                                   
//#8668        sprintf(msgbuf,"%.2f",minsiz/PFGRAN);                                                                   
//#8669        prflin(STR_PRF6);                                                                   
//#8670        sprintf(msgbuf,"%.2f",smalsiz/PFGRAN);                                                                   
//#8671        prflin(STR_PRF9);                                                                   
//#8672        sprintf(msgbuf,"%.2f",ini.angl/PI*180);                                                                   
//#8673        prflin(STR_PRF1);                                                                   
//#8674        sprintf(msgbuf,"%.2f",stspace/PFGRAN);                                                                   
//#8675        prflin(STR_PRF0);                                                                   
//#8676        if(chku(SQRFIL))                                                                   
//#8677            strcpy(msgbuf,stab[STR_SQR]);                                                               
//#8678        else                                                                   
//#8679            strcpy(msgbuf,stab[STR_PNTD]);                                                               
//#8680        prflin(STR_PRF2);                                                                   
//#8681        sprintf(msgbuf,"%.2f",brdwid/PFGRAN);                                                                   
//#8682        prflin(STR_PRF3);                                                                   
//#8683        if(chku(BLUNT))                                                                   
//#8684            strcpy(msgbuf,stab[STR_BLUNT]);                                                               
//#8685        else                                                                   
//#8686            strcpy(msgbuf,stab[STR_TAPR]);                                                               
//#8687        prflin(STR_PRF15);                                                                   
//#8688        if(chku(DUND))                                                                   
//#8689            strcpy(msgbuf,stab[STR_ON]);                                                               
//#8690        else                                                                   
//#8691            strcpy(msgbuf,stab[STR_OFF]);                                                               
//#8692        prflin(STR_PRF19);                                                                   
//#8693        sprintf(msgbuf,"%.2f",bfclen/PFGRAN);                                                                   
//#8694        prflin(STR_PRF14);                                                                   
//#8695        sprintf(msgbuf,"%.2f",ini.chspac/PFGRAN);                                                                   
//#8696        prflin(STR_PRF23);                                                                   
//#8697        sprintf(msgbuf,"%.2f",ini.chrat);                                                                   
//#8698        prflin(STR_PRF24);                                                                   
//#8699        sprintf(msgbuf,"%.2f mm",ini.clpof/PFGRAN);                                                                   
//#8700        prflin(STR_PRF21);                                                                   
//#8701        sprintf(msgbuf,"%d",ini.faz);                                                                   
//#8702        prflin(STR_PRF22);                                                                   
//#8703        sprintf(msgbuf,"%.2f",picspac/PFGRAN);                                                                   
//#8704        prflin(STR_PRF16);                                                                   
//#8705        sethup();                                                                   
//#8706        sprintf(msgbuf,stab[STR_HUP0+ini.hup-1]);                                                                   
//#8707        prflin(STR_PRF17);                                                                   
//#8708        sprintf(msgbuf,"%.0f mm",ini.hupy/PFGRAN);                                                                   
//#8709        prflin(STR_PRF27);                                                                   
//#8710        sprintf(msgbuf,"%.0f mm",ini.hupx/PFGRAN);                                                                   
//#8711        prflin(STR_PRF18);                                                                   
//#8712        sprintf(msgbuf,"%.2f mm",ini.grdsiz/PFGRAN);                                                                   
//#8713        prflin(STR_PRF20);                                                                   
//#8714        sprintf(msgbuf,"%d",duthrsh(shopnts));                                                                   
//#8715        prflin(STR_PRF7);                                                                   
//#8716        sprintf(msgbuf,"%.2f",ini.nudg);                                                                   
//#8717        prflin(STR_PRF25);                                                                   
//#8718        sprintf(msgbuf,"%.2f",snplen/PFGRAN);                                                                   
//#8719        prflin(STR_PRF11);                                                                   
//#8720        sprintf(msgbuf,"%d",duthrsh(stchboxs));                                                                   
//#8721        prflin(STR_PRF8);                                                                   
//#8722        sprintf(msgbuf,"%.2f",ini.egrat);                                                                   
//#8723        prflin(STR_PRF26);                                                                   
//#8724        sprintf(msgbuf,"%.2f",spirwrap);                                                                   
//#8725        prflin(STR_PRF13);                                                                   
//#8726        sprintf(msgbuf,"%.2f",starat);                                                                   
//#8727        prflin(STR_PRF12);                                                                   
//#8728        sprintf(msgbuf,"%d",apcol+1);                                                                   
//#8729        prflin(STR_PRF10);                                                                   
//#8730        setMap(PRFACT);                                                                   
//#8731        ReleaseDC(hWnd,prfdc);                                                                   
//#8732    }                                                                       
//#8733    #endif                                                                       
//#8734                                                                           
//#8735    void durpoli(unsigned nsids){                                                                       
//#8736                                                                           
//#8737        double        dang;                                                           
//#8738        double        ang=0;                                                           
//#8739        double        len;                                                           
//#8740        unsigned    ind;                                                               
//#8741        DUBPNT        pnt;                                                           
//#8742                                                                           
//#8743        if(nsids<3)                                                                   
//#8744            nsids=3;                                                               
//#8745        if(nsids>100)                                                                   
//#8746            nsids=100;                                                               
//#8747        dang=PI*2/nsids;                                                                   
//#8748        len=500/nsids*zumFct*(zum0.x+zum0.y)/(LHUPX+LHUPY);                                                                   
//#8749        frmpnt=&formlst[formpnt];                                                                   
//#8750        clofind=formpnt;                                                                   
//#8751        frmclr(frmpnt);                                                                   
//#8752        frmpnt->flt=adflt(nsids);                                                                   
//#8753        frmpnt->sids=nsids;                                                                   
//#8754        frmpnt->at=actl<<1;                                                                   
//#8755        fvars(formpnt);                                                                   
//#8756        px2stch();                                                                   
//#8757        pnt.x=sPnt.x;                                                                   
//#8758        pnt.y=sPnt.y;                                                                   
//#8759        for(ind=0;ind<sids;ind++){                                                                   
//#8760                                                                           
//#8761            flt[ind].x=pnt.x;                                                               
//#8762            flt[ind].y=pnt.y;                                                               
//#8763            pnt.x+=len*cos(ang);                                                               
//#8764            pnt.y+=len*sin(ang);                                                               
//#8765            ang+=dang;                                                               
//#8766        }                                                                   
//#8767        frmpnt->typ=POLI;                                                                   
//#8768        clofind=formpnt;                                                                   
//#8769        frmout(formpnt);                                                                   
//#8770        fmovdif.x=fmovdif.y=0;                                                                   
//#8771        nuflen=nsids+1;                                                                   
//#8772        setMap(POLIMOV);                                                                   
//#8773        setmfrm();                                                                   
//#8774        setMap(SHOFRM);                                                                   
//#8775        mdufrm();                                                                   
//#8776    }                                                                       
//#8777                                                                           
//#8778    void dustar(unsigned nsids,double len){                                                                       
//#8779                                                                           
//#8780        double        dang;                                                           
//#8781        double        ang;                                                           
//#8782        unsigned    ind,tsid;                                                               
//#8783        DUBPNT        pnt,cntr;                                                           
//#8784                                                                           
//#8785        if(nsids<3)                                                                   
//#8786            nsids=3;                                                               
//#8787        if(nsids>100)                                                                   
//#8788            nsids=100;                                                               
//#8789        dang=PI/nsids;                                                                   
//#8790        ang=dang/2+PI;                                                                   
//#8791        tsid=nsids<<1;                                                                   
//#8792        frmpnt=&formlst[formpnt];                                                                   
//#8793        clofind=formpnt;                                                                   
//#8794        frmclr(frmpnt);                                                                   
//#8795        frmpnt->flt=adflt(tsid);                                                                   
//#8796        frmpnt->sids=tsid;                                                                   
//#8797        frmpnt->at=(actl<<1);                                                                   
//#8798        fvars(formpnt);                                                                   
//#8799        px2stch();                                                                   
//#8800        pnt.x=sPnt.x;                                                                   
//#8801        pnt.y=sPnt.y;                                                                   
//#8802        setMap(FILDIR);                                                                   
//#8803        for(ind=0;ind<tsid;ind++){                                                                   
//#8804                                                                           
//#8805            flt[ind].x=pnt.x;                                                               
//#8806            flt[ind].y=pnt.y;                                                               
//#8807            pnt.x+=len*cos(ang);                                                               
//#8808            pnt.y+=len*sin(ang);                                                               
//#8809            ang+=dang;                                                               
//#8810        }                                                                   
//#8811        cntr.x=(flt[nsids].x-flt[0].x)/2+flt[0].x;                                                                   
//#8812        cntr.y=(flt[nsids].y-flt[0].y)/2+flt[0].y;                                                                   
//#8813        for(ind=1;ind<tsid;ind+=2){                                                                   
//#8814                                                                           
//#8815            flt[ind].x=(flt[ind].x-cntr.x)*starat+cntr.x;                                                               
//#8816            flt[ind].y=(flt[ind].y-cntr.y)*starat+cntr.y;                                                               
//#8817        }                                                                   
//#8818        frmpnt->typ=POLI;                                                                   
//#8819        frmout(formpnt);                                                                   
//#8820        fmovdif.x=fmovdif.y=0;                                                                   
//#8821        nuflen=tsid+1;                                                                   
//#8822        setMap(POLIMOV);                                                                   
//#8823        setmfrm();                                                                   
//#8824        setMap(SHOFRM);                                                                   
//#8825        mdufrm();                                                                   
//#8826    }                                                                       
//#8827                                                                           
//#8828    void duspir(unsigned nsids){                                                                       
//#8829                                                                           
//#8830        double        dang;                                                           
//#8831        double        ang=0;                                                           
//#8832        double        len,drat,rat;                                                           
//#8833        unsigned    ind,ine,num;                                                               
//#8834        DUBPNT        pnt;                                                           
//#8835        DUBPNT        cntr;                                                           
//#8836        FLPNT*        tflt;                                                           
//#8837        FLPNT*        tdif;                                                           
//#8838                                                                           
//#8839        if(nsids<3)                                                                   
//#8840            nsids=3;                                                               
//#8841        if(nsids>100)                                                                   
//#8842            nsids=100;                                                               
//#8843        dang=PI*2/nsids;                                                                   
//#8844        len=800/nsids*zumFct*(zum0.x+zum0.y)/(LHUPX+LHUPY);                                                                   
//#8845        frmpnt=&formlst[formpnt];                                                                   
//#8846        clofind=formpnt;                                                                   
//#8847        frmclr(frmpnt);                                                                   
//#8848        num=nsids*spirwrap;                                                                   
//#8849        frmpnt->flt=adflt(num);                                                                   
//#8850        tflt=new FLPNT[nsids];                                                                   
//#8851        tdif=new FLPNT[nsids];                                                                   
//#8852        frmpnt->sids=num;                                                                   
//#8853        frmpnt->at=(actl<<1);                                                                   
//#8854        fvars(formpnt);                                                                   
//#8855        px2stch();                                                                   
//#8856        pnt.x=sPnt.x;                                                                   
//#8857        pnt.y=sPnt.y;                                                                   
//#8858        for(ind=0;ind<nsids;ind++){                                                                   
//#8859                                                                           
//#8860            tflt[ind].x=pnt.x;                                                               
//#8861            tflt[ind].y=pnt.y;                                                               
//#8862            pnt.x+=len*cos(ang);                                                               
//#8863            pnt.y+=len*sin(ang);                                                               
//#8864            ang+=dang;                                                               
//#8865        }                                                                   
//#8866        cntr.x=(tflt[nsids>>1].x-tflt[0].x)/2+tflt[0].x;                                                                   
//#8867        cntr.y=(tflt[nsids>>1].y-tflt[0].y)/2+tflt[0].y;                                                                   
//#8868        for(ind=0;ind<nsids;ind++){                                                                   
//#8869                                                                           
//#8870            tdif[ind].x=tflt[ind].x-cntr.x;                                                               
//#8871            tdif[ind].y=tflt[ind].y-cntr.y;                                                               
//#8872        }                                                                   
//#8873        drat=(double)1/num;                                                                   
//#8874        rat=drat;ine=0;                                                                   
//#8875        for(ind=0;ind<num;ind++){                                                                   
//#8876                                                                           
//#8877            frmpnt->flt[ine].x=tdif[ine%nsids].x*rat+cntr.x;                                                               
//#8878            frmpnt->flt[ine].y=tdif[ine%nsids].y*rat+cntr.y;                                                               
//#8879            rat+=drat;                                                               
//#8880            ine++;                                                               
//#8881        }                                                                   
//#8882        frmpnt->typ=LIN;                                                                   
//#8883        frmout(formpnt);                                                                   
//#8884        fmovdif.x=fmovdif.y=0;                                                                   
//#8885        nuflen=num+1;                                                                   
//#8886        setMap(POLIMOV);                                                                   
//#8887        setmfrm();                                                                   
//#8888        setMap(SHOFRM);                                                                   
//#8889        mdufrm();                                                                   
//#8890        delete tflt;                                                                   
//#8891        delete tdif;                                                                   
//#8892    }                                                                       
//#8893                                                                           
//#8894    void duhart(unsigned nsids){                                                                       
//#8895                                                                           
//#8896        double        dang;                                                           
//#8897        double        ang;                                                           
//#8898        double        len;                                                           
//#8899        unsigned    ind,ine,bind;                                                               
//#8900        float        av;                                                           
//#8901        DUBPNT        pnt;                                                           
//#8902        double        rat;                                                           
//#8903                                                                           
//#8904        if(nsids>100)                                                                   
//#8905            nsids=100;                                                               
//#8906        if(nsids<6)                                                                   
//#8907            nsids=6;                                                               
//#8908        frmpnt=&formlst[formpnt];                                                                   
//#8909        frmclr(frmpnt);                                                                   
//#8910        frmpnt->at=actl<<1;                                                                   
//#8911        flt=&flts[fltad];                                                                   
//#8912        px2stch();                                                                   
//#8913        pnt.x=sPnt.x;                                                                   
//#8914        pnt.y=sPnt.y;                                                                   
//#8915        dang=PI*2/nsids;                                                                   
//#8916        len=300/nsids*zumFct*(zum0.x+zum0.y)/(LHUPX+LHUPY);                                                                   
//#8917        ang=PI*0.28;                                                                   
//#8918        ind=0;                                                                   
//#8919        av=0;                                                                   
//#8920        while(ang>-PI*0.7){                                                                   
//#8921                                                                           
//#8922            if(pnt.x>av)                                                               
//#8923                av=pnt.x;                                                           
//#8924            flt[ind].x=pnt.x;                                                               
//#8925            flt[ind++].y=pnt.y;                                                               
//#8926            pnt.x+=len*cos(ang);                                                               
//#8927            pnt.y+=len*sin(ang);                                                               
//#8928            ang-=dang;                                                               
//#8929        }                                                                   
//#8930        dang/=4.5;                                                                   
//#8931        bind=ind;                                                                   
//#8932        while(pnt.x>flt[0].x&&ind<200){                                                                   
//#8933                                                                           
//#8934            flt[ind].x=pnt.x;                                                               
//#8935            flt[ind++].y=pnt.y;                                                               
//#8936            pnt.x+=len*cos(ang);                                                               
//#8937            pnt.y+=len*sin(ang);                                                               
//#8938            ang-=dang;                                                               
//#8939        }                                                                   
//#8940        bind--;                                                                   
//#8941        rat=(flt[bind].x-flt[0].x)/(flt[bind].x-flt[ind-1].x);                                                                   
//#8942        for(ine=bind+1;ine<ind;ine++)                                                                   
//#8943            flt[ine].x=(flt[ine].x-flt[bind].x)*rat+flt[bind].x;                                                               
//#8944        bind=ine;                                                                   
//#8945        for(ind=bind-2;ind;ind--){                                                                   
//#8946                                                                           
//#8947            flt[ine].y=flt[ind].y;                                                               
//#8948            flt[ine].x=av+av-flt[ind].x-2*(av-flt[0].x);                                                               
//#8949            ine++;                                                               
//#8950        }                                                                   
//#8951        nuflen=ine+1;                                                                   
//#8952        frmpnt->flt=adflt(ine);                                                                   
//#8953        frmpnt->sids=ine;                                                                   
//#8954        frmpnt->typ=POLI;                                                                   
//#8955        clofind=formpnt;                                                                   
//#8956        frmout(formpnt);                                                                   
//#8957        fmovdif.x=fmovdif.y=0;                                                                   
//#8958        setMap(POLIMOV);                                                                   
//#8959        setmfrm();                                                                   
//#8960        setMap(SHOFRM);                                                                   
//#8961        mdufrm();                                                                   
//#8962    }                                                                       
//#8963                                                                           
//#8964    void dulens(unsigned nsids){                                                                       
//#8965                                                                           
//#8966        double        dang;                                                           
//#8967        double        ang;                                                           
//#8968        double        len;                                                           
//#8969        unsigned    ind,ine,bind,cnt;                                                               
//#8970        float        av;                                                           
//#8971        DUBPNT        pnt;                                                           
//#8972                                                                           
//#8973        if(nsids<6)                                                                   
//#8974            nsids=6;                                                               
//#8975        if(nsids>48)                                                                   
//#8976            nsids=48;                                                               
//#8977        nsids<<=1;                                                                   
//#8978        dang=PI*2/nsids;                                                                   
//#8979        cnt=nsids/2*0.3;                                                                   
//#8980        ang=cnt*dang;                                                                   
//#8981        len=500/nsids*zumFct*(zum0.x+zum0.y)/(LHUPX+LHUPY);                                                                   
//#8982        frmpnt=&formlst[formpnt];                                                                   
//#8983        clofind=formpnt;                                                                   
//#8984        frmclr(frmpnt);                                                                   
//#8985        frmpnt->flt=&flts[fltad];                                                                   
//#8986        frmpnt->at=actl<<1;                                                                   
//#8987        fvars(formpnt);                                                                   
//#8988        px2stch();                                                                   
//#8989        pnt.x=sPnt.x;                                                                   
//#8990        pnt.y=sPnt.y;                                                                   
//#8991        ind=0;                                                                   
//#8992        sPnt.x-=(float)0.0001;                                                                   
//#8993        while(pnt.x>=sPnt.x){                                                                   
//#8994                                                                           
//#8995            flt[ind].x=pnt.x;                                                               
//#8996            flt[ind++].y=pnt.y;                                                               
//#8997            pnt.x+=len*cos(ang);                                                               
//#8998            pnt.y+=len*sin(ang);                                                               
//#8999            ang+=dang;                                                               
//#9000        }                                                                   
//#9001        bind=ind-2;                                                                   
//#9002        ine=ind;                                                                   
//#9003        av=flt[0].x;                                                                   
//#9004        for(ind=bind;ind<nsids-3;ind--){                                                                   
//#9005                                                                           
//#9006            flt[ine].y=flt[ind].y;                                                               
//#9007            flt[ine].x=av+av-flt[ind].x;                                                               
//#9008            ine++;                                                               
//#9009        }                                                                   
//#9010        nuflen=ine;                                                                   
//#9011        frmpnt->flt=adflt(ine-1);                                                                   
//#9012        frmpnt->sids=ine-1;                                                                   
//#9013        frmpnt->typ=POLI;                                                                   
//#9014        clofind=formpnt;                                                                   
//#9015        frmout(formpnt);                                                                   
//#9016        fmovdif.x=fmovdif.y=0;                                                                   
//#9017        setMap(POLIMOV);                                                                   
//#9018        setmfrm();                                                                   
//#9019        setMap(SHOFRM);                                                                   
//#9020        mdufrm();                                                                   
//#9021    }                                                                       
//#9022                                                                           
//#9023    float shreg(float hi,float ref){                                                                       
//#9024                                                                           
//#9025        return (hi-ref)*egrat+ref;                                                                   
//#9026    }                                                                       
//#9027                                                                           
//#9028    void dueg(unsigned nsids){                                                                       
//#9029                                                                           
//#9030        double        ref,hi;                                                           
//#9031        unsigned    ind;                                                               
//#9032                                                                           
//#9033        if(nsids<8)                                                                   
//#9034            nsids=8;                                                               
//#9035        fvars(formpnt);                                                                   
//#9036        durpoli(nsids);                                                                   
//#9037        ref=midl(flt[nsids/2].y,flt[0].y);                                                                   
//#9038        hi=flt[nsids>>2].y-flt[0].y;                                                                   
//#9039        for(ind=0;ind<nsids;ind++){                                                                   
//#9040                                                                           
//#9041            if(flt[ind].y<ref)                                                               
//#9042                flt[ind].y=ref-(ref-flt[ind].y)*ini.egrat;                                                           
//#9043        }                                                                   
//#9044        egrat=hi/(flt[nsids>>2].y-flt[0].y);                                                                   
//#9045        for(ind=1;ind<sids;ind++){                                                                   
//#9046                                                                           
//#9047            flt[ind].x=shreg(flt[ind].x,flt[0].x);                                                               
//#9048            flt[ind].y=shreg(flt[ind].y,flt[0].y);                                                               
//#9049        }                                                                   
//#9050    }                                                                       
//#9051                                                                           
//#9052    void duzig(unsigned nsids){                                                                       
//#9053                                                                           
//#9054        FLPNT        off;                                                           
//#9055        unsigned    ind;                                                               
//#9056                                                                           
//#9057        if(nsids<3)                                                                   
//#9058            nsids=3;                                                               
//#9059        if(nsids>100)                                                                   
//#9060            nsids=100;                                                               
//#9061        frmpnt=&formlst[formpnt];                                                                   
//#9062        clofind=formpnt;                                                                   
//#9063        frmclr(frmpnt);                                                                   
//#9064        frmpnt->flt=adflt(nsids);                                                                   
//#9065        frmpnt->sids=nsids;                                                                   
//#9066        frmpnt->at=actl<<1;                                                                   
//#9067        fvars(formpnt);                                                                   
//#9068        px2stch();                                                                   
//#9069        sPnt.x;                                                                   
//#9070        sPnt.y;                                                                   
//#9071        off.x=zum0.x/6;                                                                   
//#9072        off.y=zum0.y/(6*nsids);                                                                   
//#9073        for(ind=0;ind<nsids;ind++){                                                                   
//#9074                                                                           
//#9075            flt[ind].x=sPnt.x;                                                               
//#9076            flt[ind].y=sPnt.y;                                                               
//#9077            sPnt.y-=off.y;                                                               
//#9078            if(ind&1)                                                               
//#9079                sPnt.x+=off.x;                                                           
//#9080            else                                                               
//#9081                sPnt.x-=off.x;                                                           
//#9082        }                                                                   
//#9083        frmpnt->typ=LIN;                                                                   
//#9084        clofind=formpnt;                                                                   
//#9085        frmout(formpnt);                                                                   
//#9086        fmovdif.x=fmovdif.y=0;                                                                   
//#9087        nuflen=nsids+1;                                                                   
//#9088        setMap(POLIMOV);                                                                   
//#9089        setmfrm();                                                                   
//#9090        setMap(SHOFRM);                                                                   
//#9091        mdufrm();                                                                   
//#9092    }                                                                       
//#9093                                                                           
//#9094    void fliph(){                                                                       
//#9095                                                                           
//#9096        unsigned    ind,ine;                                                               
//#9097        float        av=0;                                                           
//#9098        FLRCT        trct;                                                           
//#9099                                                                           
//#9100        fvars(clofind);                                                                   
//#9101        if(chkMap(FPSEL)){                                                                   
//#9102                                                                           
//#9103            savdo();                                                               
//#9104            av=(pselrct.right-pselrct.left)*0.5+pselrct.left;                                                               
//#9105            ine=pselrng.strt;                                                               
//#9106            for(ind=0;ind<=pselrng.cnt;ind++){                                                               
//#9107                                                                           
//#9108                flt[ine].x=av+av-flt[ine].x;                                                           
//#9109                ine=pdir(ine);                                                           
//#9110            }                                                               
//#9111            setMap(RESTCH);                                                               
//#9112            return;                                                               
//#9113        }                                                                   
//#9114        if(chkMap(BIGBOX)){                                                                   
//#9115                                                                           
//#9116            av=(rctal.right-rctal.left)/2+rctal.left;                                                               
//#9117            for(ind=0;ind<fltad;ind++)                                                               
//#9118                flts[ind].x=av+av-flts[ind].x;                                                           
//#9119            for(ind=0;ind<hed.stchs;ind++)                                                               
//#9120                stchs[ind].x=av+av-stchs[ind].x;                                                           
//#9121            for(ind=0;ind<formpnt;ind++){                                                               
//#9122                                                                           
//#9123                formlst[ind].rct.left=av+av-formlst[ind].rct.left;                                                           
//#9124                formlst[ind].rct.right=av+av-formlst[ind].rct.right;                                                           
//#9125            }                                                               
//#9126            setMap(RESTCH);                                                               
//#9127            return;                                                               
//#9128        }                                                                   
//#9129        if(fselpnt){                                                                   
//#9130                                                                           
//#9131            savdo();                                                               
//#9132            clRmap((formpnt>>5)+1);                                                               
//#9133            pxrct2stch(bigrct,&trct);                                                               
//#9134            av=(trct.right-trct.left)/2+trct.left;                                                               
//#9135            for(ind=0;ind<fselpnt;ind++){                                                               
//#9136                                                                           
//#9137                clofind=selist[ind];                                                           
//#9138                setr(clofind);                                                           
//#9139                fvars(clofind);                                                           
//#9140                for(ine=0;ine<frmpnt->sids;ine++)                                                           
//#9141                    flt[ine].x=av+av-flt[ine].x;                                                       
//#9142                frmout(clofind);                                                           
//#9143            }                                                               
//#9144            for(ind=0;ind<hed.stchs;ind++){                                                               
//#9145                                                                           
//#9146                ine=(stchs[ind].at&FRMSK)>>FRMSHFT;                                                           
//#9147                if(chkr(ine)&&!(stchs[ind].at&NOTFRM))                                                           
//#9148                    stchs[ind].x=av+av-stchs[ind].x;                                                       
//#9149            }                                                               
//#9150            setMap(RESTCH);                                                               
//#9151        }                                                                   
//#9152        else{                                                                   
//#9153                                                                           
//#9154            if(chkMap(FORMSEL)){                                                               
//#9155                                                                           
//#9156                savdo();                                                           
//#9157                av=(frmpnt->rct.right-frmpnt->rct.left)/2+frmpnt->rct.left;                                                           
//#9158                for(ind=0;ind<sids;ind++)                                                           
//#9159                    flt[ind].x=av+av-flt[ind].x;                                                       
//#9160                for(ind=0;ind<hed.stchs;ind++){                                                           
//#9161                                                                           
//#9162                    if((stchs[ind].at&FRMSK)>>FRMSHFT==clofind&&!(stchs[ind].at&NOTFRM))                                                       
//#9163                        stchs[ind].x=av+av-stchs[ind].x;                                                   
//#9164                }                                                           
//#9165                frmout(clofind);                                                           
//#9166                setMap(RESTCH);                                                           
//#9167            }                                                               
//#9168            else{                                                               
//#9169                                                                           
//#9170                if(chkMap(GRPSEL)){                                                           
//#9171                                                                           
//#9172                    savdo();                                                       
//#9173                    rngadj();                                                       
//#9174                    selRct(&trct);                                                       
//#9175                    av=(trct.right-trct.left)/2+trct.left;                                                       
//#9176                    for(ind=gpnt0;ind<=gpnt1;ind++)                                                       
//#9177                        stchs[ind].x=av+av-stchs[ind].x;                                                   
//#9178                    setMap(RESTCH);                                                       
//#9179                }                                                           
//#9180            }                                                               
//#9181        }                                                                   
//#9182    }                                                                       
//#9183                                                                           
//#9184    void flipv(){                                                                       
//#9185                                                                           
//#9186        unsigned    ind,ine;                                                               
//#9187        float        av=0;                                                           
//#9188        FLRCT        trct;                                                           
//#9189                                                                           
//#9190        fvars(clofind);                                                                   
//#9191        if(chkMap(FPSEL)){                                                                   
//#9192                                                                           
//#9193            savdo();                                                               
//#9194            av=(pselrct.top-pselrct.bottom)*0.5+pselrct.bottom;                                                               
//#9195            ine=pselrng.strt;                                                               
//#9196            for(ind=0;ind<=pselrng.cnt;ind++){                                                               
//#9197                                                                           
//#9198                flt[ine].y=av+av-flt[ine].y;                                                           
//#9199                ine=pdir(ine);                                                           
//#9200            }                                                               
//#9201            setMap(RESTCH);                                                               
//#9202            return;                                                               
//#9203        }                                                                   
//#9204        if(chkMap(BIGBOX)){                                                                   
//#9205                                                                           
//#9206            savdo();                                                               
//#9207            av=(rctal.top-rctal.bottom)/2+rctal.bottom;                                                               
//#9208            for(ind=0;ind<fltad;ind++)                                                               
//#9209                flts[ind].y=av+av-flts[ind].y;                                                           
//#9210            for(ind=0;ind<hed.stchs;ind++)                                                               
//#9211                stchs[ind].y=av+av-stchs[ind].y;                                                           
//#9212            for(ind=0;ind<formpnt;ind++){                                                               
//#9213                                                                           
//#9214                formlst[ind].rct.bottom=av+av-formlst[ind].rct.bottom;                                                           
//#9215                formlst[ind].rct.top=av+av-formlst[ind].rct.top;                                                           
//#9216            }                                                               
//#9217            setMap(RESTCH);                                                               
//#9218            return;                                                               
//#9219        }                                                                   
//#9220        if(fselpnt){                                                                   
//#9221                                                                           
//#9222            savdo();                                                               
//#9223            clRmap((formpnt>>5)+1);                                                               
//#9224            pxrct2stch(bigrct,&trct);                                                               
//#9225            av=(trct.top-trct.bottom)/2+trct.bottom;                                                               
//#9226            for(ind=0;ind<fselpnt;ind++){                                                               
//#9227                                                                           
//#9228                clofind=selist[ind];                                                           
//#9229                setr(clofind);                                                           
//#9230                fvars(clofind);                                                           
//#9231                for(ine=0;ine<frmpnt->sids;ine++)                                                           
//#9232                    flt[ine].y=av+av-flt[ine].y;                                                       
//#9233                frmout(clofind);                                                           
//#9234            }                                                               
//#9235            for(ind=0;ind<hed.stchs;ind++){                                                               
//#9236                                                                           
//#9237                ine=(stchs[ind].at&FRMSK)>>FRMSHFT;                                                           
//#9238                if(chkr(ine)&&!(stchs[ind].at&NOTFRM))                                                           
//#9239                    stchs[ind].y=av+av-stchs[ind].y;                                                       
//#9240            }                                                               
//#9241            setMap(RESTCH);                                                               
//#9242        }                                                                   
//#9243        else{                                                                   
//#9244                                                                           
//#9245            if(chkMap(FORMSEL)){                                                               
//#9246                                                                           
//#9247                savdo();                                                           
//#9248                av=(frmpnt->rct.top-frmpnt->rct.bottom)/2+frmpnt->rct.bottom;                                                           
//#9249                for(ind=0;ind<sids;ind++)                                                           
//#9250                    flt[ind].y=av+av-flt[ind].y;                                                       
//#9251                for(ind=0;ind<hed.stchs;ind++){                                                           
//#9252                                                                           
//#9253                    if((stchs[ind].at&FRMSK)>>FRMSHFT==clofind&&!(stchs[ind].at&NOTFRM))                                                       
//#9254                        stchs[ind].y=av+av-stchs[ind].y;                                                   
//#9255                }                                                           
//#9256                frmout(clofind);                                                           
//#9257                setMap(RESTCH);                                                           
//#9258            }                                                               
//#9259            else{                                                               
//#9260                                                                           
//#9261                if(chkMap(GRPSEL)){                                                           
//#9262                                                                           
//#9263                    savdo();                                                       
//#9264                    rngadj();                                                       
//#9265                    selRct(&trct);                                                       
//#9266                    av=(trct.top-trct.bottom)/2+trct.bottom;                                                       
//#9267                    for(ind=gpnt0;ind<=gpnt1;ind++)                                                       
//#9268                        stchs[ind].y=av+av-stchs[ind].y;                                                   
//#9269                    setMap(RESTCH);                                                       
//#9270                }                                                           
//#9271            }                                                               
//#9272        }                                                                   
//#9273    }                                                                       
//#9274                                                                           
//#9275    void tomsg(){                                                                       
//#9276                                                                           
//#9277        RECT    okrct;                                                               
//#9278        SIZE    tsiz;                                                               
//#9279                                                                           
//#9280        GetWindowRect(hok,&okrct);                                                                   
//#9281        GetTextExtentPoint32(sdc,stab[STR_DELST2],strlen(stab[STR_DELST2]),&tsiz);                                                                   
//#9282        hto=CreateWindow(                                                                   
//#9283            STATIC,                                                               
//#9284            stab[STR_DELST2],                                                               
//#9285            SS_NOTIFY|WS_CHILD|WS_VISIBLE|WS_BORDER,                                                               
//#9286            3                                                               
//#9287            okrct.bottom-stOrg.y+6+tsiz.cy,                                                               
//#9288            tsiz.cx+6,                                                               
//#9289            tsiz.cy+6,                                                               
//#9290            hStch,                                                               
//#9291            NULL,                                                               
//#9292            hInst,                                                               
//#9293            NULL);                                                               
//#9294    }                                                                       
//#9295                                                                           
//#9296    void sprct(unsigned strt,unsigned fin){                                                                       
//#9297                                                                           
//#9298        DUBPNT    dif,tpnt;                                                               
//#9299        VRCT2*    tvrct;                                                               
//#9300                                                                           
//#9301        tvrct=&pvrct[strt];                                                                   
//#9302        dif.x=opnts[fin].x-opnts[strt].x;                                                                   
//#9303        dif.y=opnts[fin].y-opnts[strt].y;                                                                   
//#9304        if(dif.x&&dif.y){                                                                   
//#9305                                                                           
//#9306            slop=-dif.x/dif.y;                                                               
//#9307            tpnt.x=flt[fin].x;                                                               
//#9308            tpnt.y=flt[fin].y;                                                               
//#9309            proj(tpnt,slop,opnts[strt],opnts[fin],&tvrct->dopnt);                                                               
//#9310            proj(tpnt,slop,ipnts[strt],ipnts[fin],&tvrct->dipnt);                                                               
//#9311            tpnt.x=flt[strt].x;                                                               
//#9312            tpnt.y=flt[strt].y;                                                               
//#9313            proj(tpnt,slop,opnts[strt],opnts[fin],&tvrct->aopnt);                                                               
//#9314            proj(tpnt,slop,ipnts[strt],ipnts[fin],&tvrct->aipnt);                                                               
//#9315            tpnt.x=ipnts[strt].x;                                                               
//#9316            tpnt.y=ipnts[strt].y;                                                               
//#9317            if(proj(tpnt,slop,opnts[strt],opnts[fin],&tvrct->bopnt)){                                                               
//#9318                                                                           
//#9319                tvrct->bipnt.x=ipnts[strt].x;                                                           
//#9320                tvrct->bipnt.y=ipnts[strt].y;                                                           
//#9321            }                                                               
//#9322            else{                                                               
//#9323                                                                           
//#9324                tvrct->bopnt.x=opnts[strt].x;                                                           
//#9325                tvrct->bopnt.y=opnts[strt].y;                                                           
//#9326                tpnt.x=opnts[strt].x;                                                           
//#9327                tpnt.y=opnts[strt].y;                                                           
//#9328                proj(tpnt,slop,ipnts[strt],ipnts[fin],&tvrct->bipnt);                                                           
//#9329            }                                                               
//#9330            tpnt.x=ipnts[fin].x;                                                               
//#9331            tpnt.y=ipnts[fin].y;                                                               
//#9332            if(proj(tpnt,slop,opnts[strt],opnts[fin],&tvrct->copnt)){                                                               
//#9333                                                                           
//#9334                tvrct->cipnt.x=ipnts[fin].x;                                                           
//#9335                tvrct->cipnt.y=ipnts[fin].y;                                                           
//#9336            }                                                               
//#9337            else{                                                               
//#9338                                                                           
//#9339                tvrct->copnt.x=opnts[fin].x;                                                           
//#9340                tvrct->copnt.y=opnts[fin].y;                                                           
//#9341                tpnt.x=opnts[fin].x;                                                           
//#9342                tpnt.y=opnts[fin].y;                                                           
//#9343                proj(tpnt,slop,ipnts[strt],ipnts[fin],&tvrct->cipnt);                                                           
//#9344            }                                                               
//#9345        }                                                                   
//#9346        else{                                                                   
//#9347                                                                           
//#9348            if(dif.x){                                                               
//#9349                                                                           
//#9350                tpnt.x=flt[fin].x;                                                           
//#9351                projv(tpnt.x,opnts[strt],opnts[fin],&tvrct->dopnt);                                                           
//#9352                projv(tpnt.x,ipnts[strt],ipnts[fin],&tvrct->dipnt);                                                           
//#9353                tpnt.x=flt[strt].x;                                                           
//#9354                 projv(tpnt.x,opnts[strt],opnts[fin],&tvrct->aopnt);                                                           
//#9355                projv(tpnt.x,ipnts[strt],ipnts[fin],&tvrct->aipnt);                                                           
//#9356                tpnt.x=ipnts[strt].x;                                                           
//#9357                if(projv(tpnt.x,opnts[strt],opnts[fin],&tvrct->bopnt)){                                                           
//#9358                                                                           
//#9359                    tvrct->bipnt.x=ipnts[strt].x;                                                       
//#9360                    tvrct->bipnt.y=ipnts[strt].y;                                                       
//#9361                }                                                           
//#9362                else{                                                           
//#9363                                                                           
//#9364                    tvrct->bopnt.x=opnts[strt].x;                                                       
//#9365                    tvrct->bopnt.y=opnts[strt].y;                                                       
//#9366                    tpnt.x=opnts[strt].x;                                                       
//#9367                    projv(tpnt.x,ipnts[strt],ipnts[fin],&tvrct->bipnt);                                                       
//#9368                }                                                           
//#9369                tpnt.x=ipnts[fin].x;                                                           
//#9370                if(projv(tpnt.x,opnts[strt],opnts[fin],&tvrct->copnt)){                                                           
//#9371                                                                           
//#9372                    tvrct->cipnt.x=ipnts[fin].x;                                                       
//#9373                    tvrct->cipnt.y=ipnts[fin].y;                                                       
//#9374                }                                                           
//#9375                else{                                                           
//#9376                                                                           
//#9377                    tvrct->copnt.x=opnts[fin].x;                                                       
//#9378                    tvrct->copnt.y=opnts[fin].y;                                                       
//#9379                    tpnt.x=opnts[fin].x;                                                       
//#9380                    projv(tpnt.x,ipnts[strt],ipnts[fin],&tvrct->cipnt);                                                       
//#9381                }                                                           
//#9382            }                                                               
//#9383            else{                                                               
//#9384                                                                           
//#9385                tpnt.y=flt[fin].y;                                                           
//#9386                projh(tpnt.y,opnts[strt],opnts[fin],&tvrct->dopnt);                                                           
//#9387                projh(tpnt.y,ipnts[strt],ipnts[fin],&tvrct->dipnt);                                                           
//#9388                tpnt.y=flt[strt].y;                                                           
//#9389                projh(tpnt.y,opnts[strt],opnts[fin],&tvrct->aopnt);                                                           
//#9390                projh(tpnt.y,ipnts[strt],ipnts[fin],&tvrct->aipnt);                                                           
//#9391                tpnt.y=ipnts[strt].y;                                                           
//#9392                if(projh(tpnt.y,opnts[strt],opnts[fin],&tvrct->bopnt)){                                                           
//#9393                                                                           
//#9394                    tvrct->bipnt.x=ipnts[strt].x;                                                       
//#9395                    tvrct->bipnt.y=ipnts[strt].y;                                                       
//#9396                }                                                           
//#9397                else{                                                           
//#9398                                                                           
//#9399                    tvrct->bopnt.x=opnts[strt].x;                                                       
//#9400                    tvrct->bopnt.y=opnts[strt].y;                                                       
//#9401                    tpnt.y=opnts[strt].y;                                                       
//#9402                    projh(tpnt.y,ipnts[strt],ipnts[fin],&tvrct->bipnt);                                                       
//#9403                }                                                           
//#9404                tpnt.y=ipnts[fin].y;                                                           
//#9405                if(projh(tpnt.y,opnts[strt],opnts[fin],&tvrct->copnt)){                                                           
//#9406                                                                           
//#9407                    tvrct->cipnt.x=ipnts[fin].x;                                                       
//#9408                    tvrct->cipnt.y=ipnts[fin].y;                                                       
//#9409                }                                                           
//#9410                else{                                                           
//#9411                                                                           
//#9412                    tvrct->copnt.x=opnts[fin].x;                                                       
//#9413                    tvrct->copnt.y=opnts[fin].y;                                                       
//#9414                    tpnt.y=opnts[fin].y;                                                       
//#9415                    projh(opnts[fin].y,ipnts[strt],ipnts[fin],&tvrct->cipnt);                                                       
//#9416                }                                                           
//#9417            }                                                               
//#9418        }                                                                   
//#9419    }                                                                       
//#9420                                                                           
//#9421    void spurfn(DUBPNT* ipnt,DUBPNT* opnt,DUBPNT* uipnt,DUBPNT* uopnt){                                                                       
//#9422                                                                           
//#9423        DUBPNT    dif;                                                               
//#9424                                                                           
//#9425        dif.x=opnt->x-ipnt->x;                                                                   
//#9426        dif.y=opnt->y-ipnt->y;                                                                   
//#9427        uipnt->x=dif.x*DIURAT+ipnt->x;                                                                   
//#9428        uipnt->y=dif.y*DIURAT+ipnt->y;                                                                   
//#9429        uopnt->x=dif.x*DOURAT+ipnt->x;                                                                   
//#9430        uopnt->y=dif.y*DOURAT+ipnt->y;                                                                   
//#9431    }                                                                       
//#9432                                                                           
//#9433    void spurct(unsigned ind){                                                                       
//#9434                                                                           
//#9435        spurfn(&pvrct[ind].aipnt,&pvrct[ind].aopnt,&uvrct[ind].aipnt,&uvrct[ind].aopnt);                                                                   
//#9436        spurfn(&pvrct[ind].bipnt,&pvrct[ind].bopnt,&uvrct[ind].bipnt,&uvrct[ind].bopnt);                                                                   
//#9437        spurfn(&pvrct[ind].cipnt,&pvrct[ind].copnt,&uvrct[ind].cipnt,&uvrct[ind].copnt);                                                                   
//#9438        spurfn(&pvrct[ind].dipnt,&pvrct[ind].dopnt,&uvrct[ind].dipnt,&uvrct[ind].dopnt);                                                                   
//#9439    }                                                                       
//#9440                                                                           
//#9441    unsigned psg(){                                                                       
//#9442                                                                           
//#9443        unsigned tmp;                                                                   
//#9444                                                                           
//#9445        if(!psgacc)                                                                   
//#9446            psgacc=SEED;                                                               
//#9447        tmp=psgacc&0x48000000;                                                                   
//#9448        psgacc<<=1;                                                                   
//#9449        if(tmp==0x40000000||tmp==0x8000000)                                                                   
//#9450            psgacc++;                                                               
//#9451        return psgacc;                                                                   
//#9452    }                                                                       
//#9453                                                                           
//#9454    void duromb(DUBPNT strt0,DUBPNT fin0,DUBPNT strt1,DUBPNT fin1){                                                                       
//#9455                                                                           
//#9456        DUBPNT        dif0,dif1,stp0,stp1;                                                           
//#9457        double        len0,len1;                                                           
//#9458        unsigned    cnt,ind;                                                               
//#9459                                                                           
//#9460        if(!chkMap(UND)){                                                                   
//#9461                                                                           
//#9462            dif0.x=sPnt.x-strt0.x;                                                               
//#9463            dif0.y=sPnt.y-strt0.y;                                                               
//#9464            dif1.x=sPnt.x-strt1.x;                                                               
//#9465            dif1.y=sPnt.y-strt1.y;                                                               
//#9466            len0=hypot(dif0.x,dif0.y);                                                               
//#9467            len1=hypot(dif1.x,dif1.y);                                                               
//#9468            if(len0>len1)                                                               
//#9469                setMap(FILDIR);                                                           
//#9470            else                                                               
//#9471                rstMap(FILDIR);                                                           
//#9472        }                                                                   
//#9473        dif0.x=fin0.x-strt0.x;                                                                   
//#9474        dif0.y=fin0.y-strt0.y;                                                                   
//#9475        dif1.x=fin1.x-strt1.x;                                                                   
//#9476        dif1.y=fin1.y-strt1.y;                                                                   
//#9477        len0=hypot(dif0.x,dif0.y);                                                                   
//#9478        cnt=len0/(stspace/2);                                                                   
//#9479        if(!cnt)                                                                   
//#9480            cnt++;                                                               
//#9481        stp0.x=dif0.x/cnt;                                                                   
//#9482        stp0.y=dif0.y/cnt;                                                                   
//#9483        stp1.x=dif1.x/cnt;                                                                   
//#9484        stp1.y=dif1.y/cnt;                                                                   
//#9485        for(ind=0;ind<cnt;ind++){                                                                   
//#9486                                                                           
//#9487            if(toglMap(FILDIR))                                                               
//#9488                filinsb(strt0);                                                           
//#9489            else                                                               
//#9490                filinsb(strt1);                                                           
//#9491            strt0.x+=stp0.x;                                                               
//#9492            strt0.y+=stp0.y;                                                               
//#9493            strt1.x+=stp1.x;                                                               
//#9494            strt1.y+=stp1.y;                                                               
//#9495        }                                                                   
//#9496    }                                                                       
//#9497                                                                           
//#9498    void spend(unsigned strt,unsigned fin){                                                                       
//#9499                                                                           
//#9500        double        ilen,olen;                                                           
//#9501        DUBPNT        idif,odif;                                                           
//#9502        double        sang,fang,dang,stang;                                                           
//#9503        DUBPNT        sdif,fdif;                                                           
//#9504        DUBPNT        piv;                                                           
//#9505        double        rad,arc,irad;                                                           
//#9506        unsigned    ind,cnt,lvl;                                                               
//#9507        DUBPNT        ipnt,opnt;                                                           
//#9508                                                                           
//#9509        idif.x=pvrct[fin].cipnt.x-pvrct[strt].bipnt.x;                                                                   
//#9510        idif.y=pvrct[fin].cipnt.y-pvrct[strt].bipnt.y;                                                                   
//#9511        odif.x=pvrct[fin].copnt.x-pvrct[strt].bopnt.x;                                                                   
//#9512        odif.y=pvrct[fin].copnt.y-pvrct[strt].bopnt.y;                                                                   
//#9513        ilen=hypot(idif.x,idif.y);                                                                   
//#9514        olen=hypot(odif.x,odif.y);                                                                   
//#9515        if(olen>ilen){                                                                   
//#9516                                                                           
//#9517            piv.x=pvrct[strt].cipnt.x;                                                               
//#9518            piv.y=pvrct[strt].cipnt.y;                                                               
//#9519            sdif.x=pvrct[strt].copnt.x-piv.x;                                                               
//#9520            sdif.y=pvrct[strt].copnt.y-piv.y;                                                               
//#9521            fdif.x=pvrct[fin].bopnt.x-piv.x;                                                               
//#9522            fdif.y=pvrct[fin].bopnt.y-piv.y;                                                               
//#9523        }                                                                   
//#9524        else{                                                                   
//#9525                                                                           
//#9526            piv.x=pvrct[strt].copnt.x;                                                               
//#9527            piv.y=pvrct[strt].copnt.y;                                                               
//#9528            sdif.x=pvrct[strt].cipnt.x-piv.x;                                                               
//#9529            sdif.y=pvrct[strt].cipnt.y-piv.y;                                                               
//#9530            fdif.x=pvrct[fin].bipnt.x-piv.x;                                                               
//#9531            fdif.y=pvrct[fin].bipnt.y-piv.y;                                                               
//#9532        }                                                                   
//#9533        if(hypot(sPnt.x-piv.x,sPnt.y-piv.y)>2*PI)                                                                   
//#9534            filinsb(piv);                                                               
//#9535        sang=atan2(sdif.y,sdif.x);                                                                   
//#9536        fang=atan2(fdif.y,fdif.x);                                                                   
//#9537        dang=fang-sang;                                                                   
//#9538        if(dang>PI)                                                                   
//#9539            dang-=2*PI;                                                               
//#9540        if(dang<-PI)                                                                   
//#9541            dang+=2*PI;                                                               
//#9542        rad=hypot(sdif.x,sdif.y);                                                                   
//#9543        arc=fabs(rad*dang);                                                                   
//#9544        cnt=arc/stspace;                                                                   
//#9545        stang=dang/cnt;                                                                   
//#9546        if(!cnt)                                                                   
//#9547            cnt=1;                                                               
//#9548        for(ind=0;ind<cnt;ind++){                                                                   
//#9549                                                                           
//#9550            opnt.x=piv.x+cos(sang)*rad;                                                               
//#9551            opnt.y=piv.y+sin(sang)*rad;                                                               
//#9552            filinsb(opnt);                                                               
//#9553            if(cnt&0xfffffff0)                                                               
//#9554                lvl=psg()%cnt;                                                           
//#9555            else                                                               
//#9556                lvl=lvls[cnt][ind];                                                           
//#9557            irad=rad*lvl/cnt*0.4;                                                               
//#9558            ipnt.x=piv.x+cos(sang)*irad;                                                               
//#9559            ipnt.y=piv.y+sin(sang)*irad;                                                               
//#9560            filinsb(ipnt);                                                               
//#9561            sang+=stang;                                                               
//#9562        }                                                                   
//#9563    }                                                                       
//#9564                                                                           
//#9565    void duspnd(unsigned strt,unsigned fin){                                                                       
//#9566                                                                           
//#9567        double    len,tang;                                                               
//#9568        DUBPNT    tpnt,dif;                                                               
//#9569                                                                           
//#9570        if(chkMap(UND)){                                                                   
//#9571                                                                           
//#9572            if(chkMap(UNDPHAS)){                                                               
//#9573                                                                           
//#9574                filinsb(uvrct[strt].copnt);                                                           
//#9575                filinsb(uvrct[strt].cipnt);                                                           
//#9576                dif.x=uvrct[fin].bipnt.x-uvrct[strt].cipnt.x;                                                           
//#9577                dif.y=uvrct[fin].bipnt.y-uvrct[strt].cipnt.y;                                                           
//#9578                len=hypot(dif.x,dif.y);                                                           
//#9579                if(len>frmpnt->elen){                                                           
//#9580                                                                           
//#9581                    tang=atan2(ipnts[fin].y-opnts[fin].y,ipnts[fin].x-opnts[fin].x);                                                       
//#9582                    tpnt.x=uvrct[fin].bopnt.x+cos(tang)*plen;                                                       
//#9583                    tpnt.y=uvrct[fin].bopnt.y+sin(tang)*plen;                                                       
//#9584                    filinsb(tpnt);                                                       
//#9585                }                                                           
//#9586                filinsb(uvrct[fin].bipnt);                                                           
//#9587                filinsb(uvrct[fin].bopnt);                                                           
//#9588            }                                                               
//#9589            else{                                                               
//#9590                                                                           
//#9591                filinsb(uvrct[strt].cipnt);                                                           
//#9592                filinsb(uvrct[strt].copnt);                                                           
//#9593                dif.x=uvrct[fin].bopnt.x-uvrct[strt].copnt.x;                                                           
//#9594                dif.y=uvrct[fin].bopnt.y-uvrct[strt].copnt.y;                                                           
//#9595                len=hypot(dif.x,dif.y);                                                           
//#9596                if(len>frmpnt->elen){                                                           
//#9597                                                                           
//#9598                    tang=atan2(opnts[fin].y-ipnts[fin].y,opnts[fin].x-ipnts[fin].x);                                                       
//#9599                    tpnt.x=uvrct[fin].bipnt.x+cos(tang)*plen;                                                       
//#9600                    tpnt.y=uvrct[fin].bipnt.y+sin(tang)*plen;                                                       
//#9601                    filinsb(tpnt);                                                       
//#9602                }                                                           
//#9603                filinsb(uvrct[fin].bopnt);                                                           
//#9604                filinsb(uvrct[fin].bipnt);                                                           
//#9605            }                                                               
//#9606        }                                                                   
//#9607        else                                                                   
//#9608            spend(strt,fin);                                                               
//#9609    }                                                                       
//#9610                                                                           
//#9611    void pfn(unsigned strtlin,VRCT2* vrct){                                                                       
//#9612                                                                           
//#9613        unsigned        ind;                                                           
//#9614        unsigned short    nlin;                                                               
//#9615                                                                           
//#9616        sPnt.x=flt[strtlin].x;                                                                   
//#9617        sPnt.y=flt[strtlin].y;                                                                   
//#9618        nlin=nxt(strtlin);                                                                   
//#9619        for(ind=0;ind<frmpnt->sids;ind++){                                                                   
//#9620                                                                           
//#9621            duromb(vrct[strtlin].bipnt,vrct[strtlin].cipnt,vrct[strtlin].bopnt,vrct[strtlin].copnt);                                                               
//#9622            duspnd(strtlin,nlin);                                                               
//#9623            strtlin=nlin;                                                               
//#9624            nlin=nxt(nlin);                                                               
//#9625        }                                                                   
//#9626    }                                                                       
//#9627                                                                           
//#9628    /*                                                                       
//#9629    void plfn(double spac,VRCT2* prct){                                                                       
//#9630                                                                           
//#9631        unsigned    ind;                                                               
//#9632                                                                           
//#9633        duromb(prct[0].aipnt,prct[0].cipnt,prct[0].aopnt,prct[0].copnt);                                                                   
//#9634        duspnd(0,1);                                                                   
//#9635        for(ind=1;ind<(unsigned)sids-2;ind++){                                                                   
//#9636                                                                           
//#9637            duromb(prct[ind].bipnt,prct[ind].cipnt,prct[ind].bopnt,prct[ind].copnt);                                                               
//#9638            duspnd(ind,ind+1);                                                               
//#9639        }                                                                   
//#9640        duromb(prct[sids-2].bipnt,prct[sids-2].dipnt,prct[sids-2].bopnt,prct[sids-2].dopnt);                                                                   
//#9641    }*/                                                                       
//#9642                                                                           
//#9643    void plfn(double spac,VRCT2* prct){                                                                       
//#9644                                                                           
//#9645        unsigned    ind;                                                               
//#9646                                                                           
//#9647        duromb(prct[1].aipnt,prct[1].cipnt,prct[1].aopnt,prct[1].copnt);                                                                   
//#9648        duspnd(1,2);                                                                   
//#9649        for(ind=2;ind<(unsigned)sids-4;ind++){                                                                   
//#9650                                                                           
//#9651            duromb(prct[ind].bipnt,prct[ind].cipnt,prct[ind].bopnt,prct[ind].copnt);                                                               
//#9652            duspnd(ind,ind+1);                                                               
//#9653        }                                                                   
//#9654        duromb(prct[sids-4].bipnt,prct[sids-4].dipnt,prct[sids-4].bopnt,prct[sids-4].dopnt);                                                                   
//#9655    }                                                                       
//#9656                                                                           
//#9657    void prsmal(){                                                                       
//#9658                                                                           
//#9659        unsigned    ind,ine,ref;                                                               
//#9660        double        siz,len;                                                           
//#9661        DUBPNT        dif;                                                           
//#9662                                                                           
//#9663        ref=0;ine=0;                                                                   
//#9664        siz=USPAC*0.8;                                                                   
//#9665        if(siz>plen)                                                                   
//#9666            siz=plen*0.9;                                                               
//#9667        for(ind=1;ind<seqpnt;ind++){                                                                   
//#9668                                                                           
//#9669            dif.x=oseq[ind].x-oseq[ref].x;                                                               
//#9670            dif.y=oseq[ind].y-oseq[ref].y;                                                               
//#9671            len=hypot(dif.x,dif.y);                                                               
//#9672            if(len>siz){                                                               
//#9673                                                                           
//#9674                oseq[ine].x=oseq[ind].x;                                                           
//#9675                oseq[ine++].y=oseq[ind].y;                                                           
//#9676                ref=ind;                                                           
//#9677            }                                                               
//#9678        }                                                                   
//#9679        seqpnt=ine;                                                                   
//#9680    }                                                                       
//#9681                                                                           
//#9682    void plbak(unsigned bpnt){                                                                       
//#9683                                                                           
//#9684        unsigned    ind=seqpnt-1;                                                               
//#9685        FLPNT        tflt;                                                           
//#9686                                                                           
//#9687        while(ind>bpnt){                                                                   
//#9688                                                                           
//#9689            tflt.x=oseq[ind].x;                                                               
//#9690            tflt.y=oseq[ind].y;                                                               
//#9691            oseq[ind].x=oseq[bpnt].x;                                                               
//#9692            oseq[ind].y=oseq[bpnt].y;                                                               
//#9693            oseq[bpnt].x=tflt.x;                                                               
//#9694            oseq[bpnt].y=tflt.y;                                                               
//#9695            ind--;bpnt++;                                                               
//#9696        }                                                                   
//#9697    }                                                                       
//#9698                                                                           
//#9699    void plvct(unsigned pind,DUBPNT* vp0,DUBPNT* vp1,double len)                                                                       
//#9700    {                                                                       
//#9701        double angl;                                                                   
//#9702        double len2;                                                                   
//#9703        FLPNT vct;                                                                   
//#9704                                                                           
//#9705        len2=len/2;                                                                   
//#9706        angl=atan2(flt[pind+1].y-flt[pind].y,flt[pind+1].x-flt[pind].x)+PI/2;                                                                   
//#9707        vct.x=cos(angl)*len2;                                                                   
//#9708        vct.y=sin(angl)*len2;                                                                   
//#9709        vp0->x=flt[pind].x+vct.x;                                                                   
//#9710        vp0->y=flt[pind].y+vct.y;                                                                   
//#9711        vp1->x=flt[pind].x-vct.x;                                                                   
//#9712        vp1->y=flt[pind].y-vct.y;                                                                   
//#9713    }                                                                       
//#9714                                                                           
//#9715    void prebrd()                                                                       
//#9716    {                                                                       
//#9717        FLPNT dif;                                                                   
//#9718        double rat;                                                                   
//#9719                                                                           
//#9720        MoveMemory(&angflt[1],flt,sizeof(FLPNT)*sids);                                                                   
//#9721        dif.x=flt[1].x-flt[0].x;                                                                   
//#9722        dif.y=flt[1].y-flt[0].y;                                                                   
//#9723        if(fabs(dif.x)>fabs(dif.y))                                                                   
//#9724            rat=fabs(0.1/dif.x);                                                               
//#9725        else                                                                   
//#9726            rat=fabs(0.1/dif.y);                                                               
//#9727        angflt[0].x=flt[0].x-dif.x*rat;                                                                   
//#9728        angflt[0].y=flt[0].y-dif.y*rat;                                                                   
//#9729        MoveMemory(&angfrm,frmpnt,sizeof(FRMHED));                                                                   
//#9730        angfrm.flt=angflt;                                                                   
//#9731        angfrm.sids+=3;                                                                   
//#9732        dif.x=flt[sids-1].x-flt[sids-2].x;                                                                   
//#9733        dif.y=flt[sids-1].y-flt[sids-2].y;                                                                   
//#9734        if(dif.x>dif.y)                                                                   
//#9735            rat=0.1/dif.x;                                                               
//#9736        else                                                                   
//#9737            rat=0.1/dif.y;                                                               
//#9738        angflt[angfrm.sids-1].x=flt[sids-1].x+dif.x*rat;                                                                   
//#9739        angflt[angfrm.sids-1].y=flt[sids-1].y+dif.y*rat;                                                                   
//#9740        frmpnt=&angfrm;                                                                   
//#9741        sids=angfrm.sids;                                                                   
//#9742        flt=angfrm.flt;                                                                   
//#9743    }                                                                       
//#9744                                                                           
//#9745    void plbrd(double spac){                                                                       
//#9746                                                                           
//#9747        double            tspac;                                                       
//#9748        unsigned short    slin=getlast();                                                               
//#9749        unsigned bpnt;                                                                   
//#9750        unsigned ind;                                                                   
//#9751                                                                           
//#9752        prebrd();                                                                   
//#9753        tspac=stspace;                                                                   
//#9754        pvrct=(VRCT2*)bseq;                                                                   
//#9755        uvrct=&pvrct[sids];                                                                   
//#9756        satout(frmpnt->esiz);                                                                   
//#9757        ipnts[sids].x=ipnts[0].x;                                                                   
//#9758        ipnts[sids].y=ipnts[0].y;                                                                   
//#9759        opnts[sids].x=opnts[0].x;                                                                   
//#9760        opnts[sids].y=opnts[0].y;                                                                   
//#9761        for(ind=0;ind<(unsigned)sids-1;ind++)                                                                   
//#9762        {                                                                   
//#9763            sprct(ind,ind+1);                                                               
//#9764            spurct(ind);                                                               
//#9765        }                                                                   
//#9766        sprct(ind,0);                                                                   
//#9767        spurct(ind);                                                                   
//#9768        if(!(frmpnt->at&SBLNT))                                                                   
//#9769        {                                                                   
//#9770            pvrct[1].aipnt.x=pvrct[1].aopnt.x=uvrct[1].aipnt.x=uvrct[1].aopnt.x=frmpnt->flt[1].x;                                                               
//#9771            pvrct[1].aipnt.y=pvrct[1].aopnt.y=uvrct[1].aipnt.y=uvrct[1].aopnt.y=frmpnt->flt[1].y;                                                               
//#9772        }                                                                   
//#9773        if(!(frmpnt->at&FBLNT))                                                                   
//#9774        {                                                                   
//#9775            pvrct[sids-4].dipnt.x=pvrct[sids-4].dopnt.x=uvrct[sids-4].dipnt.x=uvrct[sids-4].dopnt.x=frmpnt->flt[sids-1].x;                                                               
//#9776            pvrct[sids-4].dipnt.y=pvrct[sids-4].dopnt.y=uvrct[sids-4].dipnt.y=uvrct[sids-4].dopnt.y=frmpnt->flt[sids-1].y;                                                               
//#9777        }                                                                   
//#9778        seqpnt=0;                                                                   
//#9779        sPnt.x=flt[0].x;                                                                   
//#9780        sPnt.y=flt[0].y;                                                                   
//#9781        if(frmpnt->etyp&EGUND){                                                                   
//#9782                                                                           
//#9783            stspace=USPAC;                                                               
//#9784            setMap(UND);                                                               
//#9785            plen=frmpnt->esiz*URAT;                                                               
//#9786            setMap(UNDPHAS);                                                               
//#9787            rstMap(FILDIR);                                                               
//#9788            plfn(USPAC,&uvrct[0]);                                                               
//#9789            bpnt=seqpnt;                                                               
//#9790            rstMap(UNDPHAS);                                                               
//#9791            sPnt.x=flt[0].x;                                                               
//#9792            sPnt.y=flt[0].y;                                                               
//#9793            setMap(FILDIR);                                                               
//#9794            plfn(USPAC,&uvrct[0]);                                                               
//#9795            plbak(bpnt);                                                               
//#9796            prsmal();                                                               
//#9797            sPnt.x=oseq[seqpnt-1].x;                                                               
//#9798            sPnt.y=oseq[seqpnt-1].y;                                                               
//#9799        }                                                                   
//#9800        rstMap(UND);                                                                   
//#9801        stspace=frmpnt->espac;                                                                   
//#9802        plfn(stspace,&pvrct[0]);                                                                   
//#9803        stspace=spac;                                                                   
//#9804        fvars(clofind);                                                                   
//#9805    }                                                                       
//#9806                                                                           
//#9807    void pbrd(double spac){                                                                       
//#9808                                                                           
//#9809        double            tspac;                                                       
//#9810        unsigned        ind;                                                           
//#9811        unsigned        strt;                                                           
//#9812                                                                           
//#9813        tspac=stspace;                                                                   
//#9814        stspace=frmpnt->espac;                                                                   
//#9815        seqpnt=0;                                                                   
//#9816        pvrct=(VRCT2*)bseq;                                                                   
//#9817        uvrct=&pvrct[sids];                                                                   
//#9818        strt=getlast();                                                                   
//#9819        satout(frmpnt->esiz);                                                                   
//#9820        for(ind=0;ind<(unsigned)sids-1;ind++){                                                                   
//#9821                                                                           
//#9822            sprct(ind,ind+1);                                                               
//#9823            spurct(ind);                                                               
//#9824        }                                                                   
//#9825        sprct(ind,0);                                                                   
//#9826        spurct(ind);                                                                   
//#9827        if(frmpnt->etyp&EGUND){                                                                   
//#9828                                                                           
//#9829            rstMap(SAT1);                                                               
//#9830            stspace=USPAC;                                                               
//#9831            setMap(UND);                                                               
//#9832            plen=frmpnt->esiz*URAT;                                                               
//#9833            satout(plen);                                                               
//#9834            setMap(UNDPHAS);                                                               
//#9835            setMap(FILDIR);                                                               
//#9836            pfn(strt,&uvrct[0]);                                                               
//#9837            rstMap(UNDPHAS);                                                               
//#9838            rstMap(FILDIR);                                                               
//#9839            pfn(strt,&uvrct[0]);                                                               
//#9840            stspace=spac;                                                               
//#9841            prsmal();                                                               
//#9842            plen=frmpnt->esiz;                                                               
//#9843            rstMap(UND);                                                               
//#9844        }                                                                   
//#9845        pfn(strt,&pvrct[0]);                                                                   
//#9846        stspace=tspac;                                                                   
//#9847    }                                                                       
//#9848                                                                           
//#9849    void prpsbrd(){                                                                       
//#9850                                                                           
//#9851        if(frmpnt->sids>2){                                                                   
//#9852                                                                           
//#9853            deleclp(clofind);                                                               
//#9854            frmpnt->etyp=EGPRP;                                                               
//#9855            if(chku(DUND))                                                               
//#9856                frmpnt->etyp|=EGUND;                                                           
//#9857            bsizpar();                                                               
//#9858            frmpnt->esiz=brdwid;                                                               
//#9859            frmpnt->espac=stspace;                                                               
//#9860            frmpnt->bcol=actcol;                                                               
//#9861            refilfn();                                                               
//#9862        }                                                                   
//#9863    }                                                                       
//#9864                                                                           
//#9865    void prpbrd(double spac){                                                                       
//#9866                                                                           
//#9867        double        tspac=stspace;                                                           
//#9868        unsigned    ind;                                                               
//#9869                                                                           
//#9870        if(filmsgs(FML_PRPS))                                                                   
//#9871            return;                                                               
//#9872        stspace=spac;                                                                   
//#9873        if(fselpnt){                                                                   
//#9874                                                                           
//#9875            for(ind=0;ind<fselpnt;ind++){                                                               
//#9876                                                                           
//#9877                clofind=selist[ind];                                                           
//#9878                fvars(clofind);                                                           
//#9879                frmpnt->esiz=stspace;                                                           
//#9880                if(chku(BLUNT))                                                           
//#9881                    frmpnt->at|=(SBLNT|FBLNT);                                                       
//#9882                else                                                           
//#9883                    frmpnt->at&=NOBLNT;                                                       
//#9884                prpsbrd();                                                           
//#9885            }                                                               
//#9886            setMap(INIT);                                                               
//#9887            coltab();                                                               
//#9888            setMap(RESTCH);                                                               
//#9889        }                                                                   
//#9890        else{                                                                   
//#9891                                                                           
//#9892            if(chkMap(FORMSEL)){                                                               
//#9893                                                                           
//#9894                fvars(clofind);                                                           
//#9895                if(chku(BLUNT))                                                           
//#9896                    frmpnt->at|=(SBLNT|FBLNT);                                                       
//#9897                else                                                           
//#9898                    frmpnt->at&=NOBLNT;                                                       
//#9899                prpsbrd();                                                           
//#9900                setMap(INIT);                                                           
//#9901                coltab();                                                           
//#9902                ritot(hed.stchs);                                                           
//#9903                setMap(RESTCH);                                                           
//#9904            }                                                               
//#9905        }                                                                   
//#9906        stspace=tspac;                                                                   
//#9907    }                                                                       
//#9908                                                                           
//#9909    void tglfrm(){                                                                       
//#9910                                                                           
//#9911        if(rstMap(SATPNT))                                                                   
//#9912            satfix();                                                               
//#9913        rstMap(HIDSTCH);                                                                   
//#9914        if(toglMap(FRMOF))                                                                   
//#9915            strcpy(oftxt,stab[STR_FRMPLUS]);                                                               
//#9916        else{                                                                   
//#9917                                                                           
//#9918            strcpy(oftxt,stab[STR_FRMINUS]);                                                               
//#9919            rstMap(FORMSEL);                                                               
//#9920            rstMap(FORMIN);                                                               
//#9921            rstMap(MOVFRM);                                                               
//#9922            rstMap(FRMPMOV);                                                               
//#9923            rstMap(FRMOV);                                                               
//#9924            rstMap(SATIN);                                                               
//#9925            rstMap(SATPNT);                                                               
//#9926            rstMap(SATCNKT);                                                               
//#9927            rstMap(FENDIN);                                                               
//#9928            rstMap(DELFRM);                                                               
//#9929            rstMap(FRMPSEL);                                                               
//#9930            rstMap(INSFRM);                                                               
//#9931        }                                                                   
//#9932        SetMenuItemInfo(hMen,ID_FRMOF,FALSE,&meninfo);                                                                   
//#9933        setMap(DUMEN);                                                                   
//#9934        setMap(RESTCH);                                                                   
//#9935    }                                                                       
//#9936                                                                           
//#9937    void frmon(){                                                                       
//#9938                                                                           
//#9939        unbsho();                                                                   
//#9940        rstMap(FRMOF);                                                                   
//#9941        strcpy(oftxt,stab[STR_FRMPLUS]);                                                                   
//#9942        SetMenuItemInfo(hMen,ID_FRMOF,FALSE,&meninfo);                                                                   
//#9943        setMap(DUMEN);                                                                   
//#9944    }                                                                       
//#9945                                                                           
//#9946    void fnord(){                                                                       
//#9947                                                                           
//#9948        int            ind;                                                       
//#9949        SHRTPNT        tpnt;                                                           
//#9950                                                                           
//#9951        fvars(clofind);                                                                   
//#9952        frmpnt=&formlst[clofind];                                                                   
//#9953        for(ind=0;ind<frmpnt->sids>>1;ind++){                                                                   
//#9954                                                                           
//#9955            tpnt.x=frmpnt->flt[ind].x;                                                               
//#9956            tpnt.y=frmpnt->flt[ind].y;                                                               
//#9957            frmpnt->flt[ind].x=frmpnt->flt[frmpnt->sids-ind-1].x;                                                               
//#9958            frmpnt->flt[ind].y=frmpnt->flt[frmpnt->sids-ind-1].y;                                                               
//#9959            frmpnt->flt[frmpnt->sids-ind-1].x=tpnt.x;                                                               
//#9960            frmpnt->flt[frmpnt->sids-ind-1].y=tpnt.y;                                                               
//#9961        }                                                                   
//#9962        refil();                                                                   
//#9963    }                                                                       
//#9964                                                                           
//#9965    void flpord(){                                                                       
//#9966                                                                           
//#9967        int            ind;                                                       
//#9968        unsigned    uind,strt,fin;                                                               
//#9969        SHRTPNT        tpnt;                                                           
//#9970                                                                           
//#9971        fvars(clofind);                                                                   
//#9972        if(chkMap(FPSEL)){                                                                   
//#9973                                                                           
//#9974            savdo();                                                               
//#9975            strt=pselrng.strt;                                                               
//#9976            fin=(pselrng.strt+pselrng.cnt)%sids;                                                               
//#9977            for(uind=0;uind<=pselrng.cnt>>1;uind++){                                                               
//#9978                                                                           
//#9979                tpnt.x=frmpnt->flt[strt].x;                                                           
//#9980                tpnt.y=frmpnt->flt[strt].y;                                                           
//#9981                frmpnt->flt[strt].x=frmpnt->flt[fin].x;                                                           
//#9982                frmpnt->flt[strt].y=frmpnt->flt[fin].y;                                                           
//#9983                frmpnt->flt[fin].x=tpnt.x;                                                           
//#9984                frmpnt->flt[fin].y=tpnt.y;                                                           
//#9985                strt=pdir(strt);                                                           
//#9986                toglMap(PSELDIR);                                                           
//#9987                fin=pdir(fin);                                                           
//#9988                toglMap(PSELDIR);                                                           
//#9989            }                                                               
//#9990            refil();                                                               
//#9991            return;                                                               
//#9992        }                                                                   
//#9993        if(fselpnt){                                                                   
//#9994                                                                           
//#9995            savdo();                                                               
//#9996            for(uind=0;uind<fselpnt;uind++){                                                               
//#9997                                                                           
//#9998                clofind=selist[uind];                                                           
//#9999                fnord();                                                           
//#10000            }                                                               
//#10001            coltab();                                                               
//#10002            setMap(RESTCH);                                                               
//#10003        }                                                                   
//#10004        else{                                                                   
//#10005                                                                           
//#10006            if(chkMap(FORMSEL)){                                                               
//#10007                                                                           
//#10008                savdo();                                                           
//#10009                fnord();                                                           
//#10010                coltab();                                                           
//#10011                setMap(RESTCH);                                                           
//#10012            }                                                               
//#10013            else{                                                               
//#10014                                                                           
//#10015                if(chkMap(GRPSEL)){                                                           
//#10016                                                                           
//#10017                    savdo();                                                       
//#10018                    rngadj();                                                       
//#10019                    uind=gpnt0;                                                       
//#10020                    for(ind=0;ind<((signed)(gpnt1-gpnt0)>>1)+1;ind++){                                                       
//#10021                                                                           
//#10022                        tpnt.at=stchs[uind].at;                                                   
//#10023                        tpnt.x=stchs[uind].x;                                                   
//#10024                        tpnt.y=stchs[uind].y;                                                   
//#10025                        stchs[uind].at=stchs[gpnt1-ind].at;                                                   
//#10026                        stchs[uind].x=stchs[gpnt1-ind].x;                                                   
//#10027                        stchs[uind].y=stchs[gpnt1-ind].y;                                                   
//#10028                        stchs[gpnt1-ind].at=tpnt.at;                                                   
//#10029                        stchs[gpnt1-ind].x=tpnt.x;                                                   
//#10030                        stchs[gpnt1-ind].y=tpnt.y;                                                   
//#10031                        uind++;                                                   
//#10032                    }                                                       
//#10033                    coltab();                                                       
//#10034                    setMap(RESTCH);                                                       
//#10035                }                                                           
//#10036            }                                                               
//#10037        }                                                                   
//#10038    }                                                                       
//#10039                                                                           
//#10040    void dudif(DUBPNT strt,DUBPNT fin,DUBPNT* dif){                                                                       
//#10041                                                                           
//#10042        dif->x=fin.x-strt.x;                                                                   
//#10043        dif->y=fin.y-strt.y;                                                                   
//#10044    }                                                                       
//#10045                                                                           
//#10046    void trfrm(DUBPNT lpnt0,DUBPNT lpnt1,DUBPNT rpnt0,DUBPNT rpnt1){                                                                       
//#10047                                                                           
//#10048        unsigned    ind;                                                               
//#10049        DUBPNT        tdif,bdif,ldif,rdif;                                                           
//#10050        DUBPNT        clprat,tmid,bmid,mdif;                                                           
//#10051                                                                           
//#10052        dudif(lpnt1,rpnt1,&tdif);                                                                   
//#10053        dudif(lpnt0,rpnt0,&bdif);                                                                   
//#10054        dudif(lpnt0,lpnt1,&ldif);                                                                   
//#10055        dudif(rpnt0,rpnt1,&rdif);                                                                   
//#10056        for(ind=0;ind<clplen;ind++){                                                                   
//#10057                                                                           
//#10058            clprat.x=clpnu[ind].x/clpsiz.cx;                                                               
//#10059            clprat.y=clpnu[ind].y/clpsiz.cy;                                                               
//#10060            tmid.x=clprat.x*(tdif.x)+lpnt1.x;                                                               
//#10061            tmid.y=clprat.x*(tdif.y)+lpnt1.y;                                                               
//#10062            bmid.x=clprat.x*(bdif.x)+lpnt0.x;                                                               
//#10063            bmid.y=clprat.x*(bdif.y)+lpnt0.y;                                                               
//#10064            dudif(bmid,tmid,&mdif);                                                               
//#10065            oseq[xpnt].x=clprat.y*mdif.x+bmid.x;                                                               
//#10066            oseq[xpnt].y=clprat.y*mdif.y+bmid.y;                                                               
//#10067            xpnt++;                                                               
//#10068        }                                                                   
//#10069    }                                                                       
//#10070                                                                           
//#10071    void clpfm(){                                                                       
//#10072                                                                           
//#10073        unsigned    ind,ine,cnt;                                                               
//#10074        double        lsiz,rsiz;                                                           
//#10075        DUBPNT        ldif,rdif;                                                           
//#10076        DUBPNT        lstp,rstp;                                                           
//#10077        DUBPNT        lpnt0,rpnt0;                                                           
//#10078        DUBPNT        lpnt1,rpnt1;                                                           
//#10079                                                                           
//#10080        xpnt=0;                                                                   
//#10081        for(ind=0;ind<seqpnt-2;ind+=2){                                                                   
//#10082                                                                           
//#10083            lsiz=hypot(bseq[ind+1].x-bseq[ind].x,bseq[ind+1].y-bseq[ind].y);                                                               
//#10084            rsiz=hypot(bseq[ind+3].x-bseq[ind+2].x,bseq[ind+3].y-bseq[ind+2].y);                                                               
//#10085            ldif.x=bseq[ind+1].x-bseq[ind].x;                                                               
//#10086            ldif.y=bseq[ind+1].y-bseq[ind].y;                                                               
//#10087            rdif.x=bseq[ind+2].x-bseq[ind+3].x;                                                               
//#10088            rdif.y=bseq[ind+2].y-bseq[ind+3].y;                                                               
//#10089            if(rsiz>lsiz)                                                               
//#10090                cnt=lsiz/clpsiz.cy;                                                           
//#10091            else                                                               
//#10092                cnt=rsiz/clpsiz.cy;                                                           
//#10093            if(!cnt)                                                               
//#10094                cnt=1;                                                           
//#10095            lstp.x=ldif.x/cnt;                                                               
//#10096            lstp.y=ldif.y/cnt;                                                               
//#10097            rstp.x=rdif.x/cnt;                                                               
//#10098            rstp.y=rdif.y/cnt;                                                               
//#10099            lpnt1.x=bseq[ind].x;                                                               
//#10100            lpnt1.y=bseq[ind].y;                                                               
//#10101            rpnt1.x=bseq[ind+3].x;                                                               
//#10102            rpnt1.y=bseq[ind+3].y;                                                               
//#10103            for(ine=0;ine<cnt;ine++){                                                               
//#10104                                                                           
//#10105                lpnt0.x=lpnt1.x;                                                           
//#10106                lpnt0.y=lpnt1.y;                                                           
//#10107                rpnt0.x=rpnt1.x;                                                           
//#10108                rpnt0.y=rpnt1.y;                                                           
//#10109                lpnt1.x+=lstp.x;                                                           
//#10110                lpnt1.y+=lstp.y;                                                           
//#10111                rpnt1.x+=rstp.x;                                                           
//#10112                rpnt1.y+=rstp.y;                                                           
//#10113                if(xpnt>MAXSEQ-clplen-1)                                                           
//#10114                    return;                                                       
//#10115                trfrm(lpnt0,lpnt1,rpnt0,rpnt1);                                                           
//#10116            }                                                               
//#10117        }                                                                   
//#10118    }                                                                       
//#10119                                                                           
//#10120    void fmclp(){                                                                       
//#10121                                                                           
//#10122        double        tspac=stspace;                                                           
//#10123                                                                           
//#10124        stspace=clpsiz.cx;                                                                   
//#10125        setMap(BARSAT);                                                                   
//#10126        satfil();                                                                   
//#10127        rstMap(BARSAT);                                                                   
//#10128        clpfm();                                                                   
//#10129        frmpnt->ftyp=CLPF;                                                                   
//#10130        seqpnt=xpnt;                                                                   
//#10131        stspace=tspac;                                                                   
//#10132    }                                                                       
//#10133                                                                           
//#10134    void filsclp(){                                                                       
//#10135                                                                           
//#10136        unsigned ind;                                                                   
//#10137                                                                           
//#10138        deltx();                                                                   
//#10139        fvars(clofind);                                                                   
//#10140        if(frmpnt->typ!=SAT)                                                                   
//#10141            frmpnt->wpar=0;                                                               
//#10142        frmpnt->typ=SAT;                                                                   
//#10143        frmpnt->ftyp=CLPF;                                                                   
//#10144        frmpnt->angclp.clp=numclp();                                                                   
//#10145        frmpnt->flencnt.nclp=clplen;                                                                   
//#10146        for(ind=0;ind<clplen;ind++){                                                                   
//#10147                                                                           
//#10148            frmpnt->angclp.clp[ind].x=clpnu[ind].x;                                                               
//#10149            frmpnt->angclp.clp[ind].y=clpnu[ind].y;                                                               
//#10150        }                                                                   
//#10151        refilfn();                                                                   
//#10152    }                                                                       
//#10153                                                                           
//#10154    void clpfil(){                                                                       
//#10155                                                                           
//#10156        unsigned ind;                                                                   
//#10157                                                                           
//#10158        if(filmsgs(FMM_CLP))                                                                   
//#10159            return;                                                               
//#10160        if(OpenClipboard(hWnd)){                                                                   
//#10161                                                                           
//#10162            hClip=RegisterClipboardFormat(pcdClip);                                                               
//#10163            hClpMem=GetClipboardData(hClip);                                                               
//#10164            if(hClpMem){                                                               
//#10165                                                                           
//#10166                redclp();                                                           
//#10167                CloseClipboard();                                                           
//#10168                if(clpsiz.cx>CLPMIN&&clpsiz.cy>CLPMIN){                                                           
//#10169                                                                           
//#10170                    if(fselpnt){                                                       
//#10171                                                                           
//#10172                        for(ind=0;ind<fselpnt;ind++){                                                   
//#10173                                                                           
//#10174                            clofind=selist[ind];                                               
//#10175                            fvars(clofind);                                               
//#10176                            if(frmpnt->typ!=LIN)                                               
//#10177                                filsclp();                                           
//#10178                        }                                                   
//#10179                        setMap(INIT);                                                   
//#10180                        coltab();                                                   
//#10181                        setMap(RESTCH);                                                   
//#10182                    }                                                       
//#10183                    else{                                                       
//#10184                                                                           
//#10185                        if(chkMap(FORMSEL)){                                                   
//#10186                                                                           
//#10187                            filsclp();                                               
//#10188                            setMap(INIT);                                               
//#10189                            coltab();                                               
//#10190                            setMap(RESTCH);                                               
//#10191                        }                                                   
//#10192                    }                                                       
//#10193                }                                                           
//#10194                else                                                           
//#10195                    tabmsg(IDS_CLP);                                                       
//#10196            }                                                               
//#10197            else                                                               
//#10198                CloseClipboard();                                                           
//#10199        }                                                                   
//#10200    }                                                                       
//#10201                                                                           
//#10202    void snpfn(unsigned xind,unsigned len){                                                                       
//#10203                                                                           
//#10204        unsigned    ind,ine,fin,ref,chk;                                                               
//#10205        double        tlen;                                                           
//#10206                                                                           
//#10207        fin=xhst[xind+len];                                                                   
//#10208        ind=xhst[xind];                                                                   
//#10209        if(fin-ind){                                                                   
//#10210                                                                           
//#10211            for(ind=xhst[xind];ind<xhst[xind+1];ind++){                                                               
//#10212                                                                           
//#10213                ref=xpnts[ind];                                                           
//#10214                for(ine=ind+1;ine<fin;ine++){                                                           
//#10215                                                                           
//#10216                    chk=xpnts[ine];                                                       
//#10217                    tlen=hypot(stchs[chk].x-stchs[ref].x,stchs[chk].y-stchs[ref].y);                                                       
//#10218                    if(tlen<snplen){                                                       
//#10219                                                                           
//#10220                        stchs[chk].x=stchs[ref].x;                                                   
//#10221                        stchs[chk].y=stchs[ref].y;                                                   
//#10222                    }                                                       
//#10223                }                                                           
//#10224            }                                                               
//#10225        }                                                                   
//#10226    }                                                                       
//#10227                                                                           
//#10228    void nutim(double siz){                                                                       
//#10229                                                                           
//#10230        htim=CreateWindow(                                                                   
//#10231            STATIC,                                                               
//#10232            0                                                               
//#10233            WS_CHILD|WS_VISIBLE|WS_BORDER,                                                               
//#10234            buttonWid3,                                                               
//#10235            0                                                               
//#10236            stchSiz.x,                                                               
//#10237            buttonHi,                                                               
//#10238            hWnd,                                                               
//#10239            NULL,                                                               
//#10240            hInst,                                                               
//#10241            NULL);                                                               
//#10242        timdc=GetDC(htim);                                                                   
//#10243        timstp=(double)stchSiz.x/siz;                                                                   
//#10244        timpos=0;                                                                   
//#10245        flin[0].y=0;                                                                   
//#10246        flin[1].y=buttonHi;                                                                   
//#10247        flin[0].x=flin[1].x=0;                                                                   
//#10248        SelectObject(timdc,uPen[0]);                                                                   
//#10249    }                                                                       
//#10250                                                                           
//#10251    void nxtim(){                                                                       
//#10252                                                                           
//#10253        Polyline(timdc,flin,2);                                                                   
//#10254        timpos+=timstp;                                                                   
//#10255        flin[0].x=flin[1].x=timpos;                                                                   
//#10256    }                                                                       
//#10257                                                                           
//#10258    void snp(unsigned strt,unsigned fin){                                                                       
//#10259                                                                           
//#10260        unsigned    ind,tuns,acc,chklen,at=0;                                                               
//#10261        FLPNT        rsiz;                                                           
//#10262        unsigned*    txhst;                                                               
//#10263                                                                           
//#10264        chkrng(&rsiz);                                                                   
//#10265        xpnts=(unsigned*)bseq;                                                                   
//#10266        ZeroMemory(bseq,65536*sizeof(unsigned));                                                                   
//#10267        xhst=txhst=new unsigned[rsiz.x+1];                                                                   
//#10268        for(ind=0;ind<rsiz.x;ind++)                                                                   
//#10269            xhst[ind]=0;                                                               
//#10270        if(chkMap(FORMSEL)){                                                                   
//#10271                                                                           
//#10272            at=(clofind<<4)&FRMSK;                                                               
//#10273            for(ind=strt;ind<fin;ind++){                                                               
//#10274                                                                           
//#10275                if(!(stchs[ind].at&NOTFRM)&&(stchs[ind].at&FRMSK)==at){                                                           
//#10276                                                                           
//#10277                    tuns=stchs[ind].x;                                                       
//#10278                    xhst[tuns]++;                                                       
//#10279                }                                                           
//#10280            }                                                               
//#10281        }                                                                   
//#10282        else{                                                                   
//#10283                                                                           
//#10284            for(ind=strt;ind<fin;ind++){                                                               
//#10285                                                                           
//#10286                tuns=stchs[ind].x;                                                           
//#10287                xhst[tuns]++;                                                           
//#10288            }                                                               
//#10289        }                                                                   
//#10290        acc=0;                                                                   
//#10291        for(ind=0;ind<rsiz.x;ind++){                                                                   
//#10292                                                                           
//#10293            tuns=xhst[ind];                                                               
//#10294            xhst[ind]=acc;                                                               
//#10295            acc+=tuns;                                                               
//#10296        }                                                                   
//#10297        xhst[ind]=acc;                                                                   
//#10298        if(chkMap(FORMSEL)){                                                                   
//#10299                                                                           
//#10300            for(ind=0;ind<hed.stchs;ind++){                                                               
//#10301                                                                           
//#10302                if(!(stchs[ind].at&NOTFRM)&&(stchs[ind].at&FRMSK)==at){                                                           
//#10303                                                                           
//#10304                    tuns=stchs[ind].x;                                                       
//#10305                    xpnts[xhst[tuns]++]=ind;                                                       
//#10306                }                                                           
//#10307            }                                                               
//#10308        }                                                                   
//#10309        else{                                                                   
//#10310                                                                           
//#10311            for(ind=0;ind<hed.stchs;ind++){                                                               
//#10312                                                                           
//#10313                tuns=stchs[ind].x;                                                           
//#10314                xpnts[xhst[tuns]++]=ind;                                                           
//#10315            }                                                               
//#10316        }                                                                   
//#10317        xhst=&xhst[1];                                                                   
//#10318        chklen=snplen*2+1;                                                                   
//#10319        nutim(rsiz.x);                                                                   
//#10320        for(ind=0;ind<rsiz.x-chklen;ind++){                                                                   
//#10321                                                                           
//#10322            snpfn(ind,chklen);                                                               
//#10323            nxtim();                                                               
//#10324        }                                                                   
//#10325        DestroyWindow(htim);                                                                   
//#10326        delete txhst;                                                                   
//#10327    }                                                                       
//#10328                                                                           
//#10329    void snap(){                                                                       
//#10330                                                                           
//#10331        savdo();                                                                   
//#10332        if(chkMap(GRPSEL)){                                                                   
//#10333                                                                           
//#10334            rngadj();                                                               
//#10335            snp(gpnt0,gpnt1);                                                               
//#10336        }                                                                   
//#10337        else                                                                   
//#10338            snp(0,hed.stchs);                                                               
//#10339        coltab();                                                                   
//#10340        setMap(RESTCH);                                                                   
//#10341    }                                                                       
//#10342                                                                           
//#10343    void setcmap(unsigned bpnt){                                                                       
//#10344                                                                           
//#10345        _asm{                                                                   
//#10346                mov        eax,colmap                                                   
//#10347                mov        ebx,bpnt                                                   
//#10348                bts        eax,ebx                                                   
//#10349                mov        colmap,eax                                                   
//#10350        }                                                                   
//#10351    }                                                                       
//#10352                                                                           
//#10353    unsigned nxtcol(){                                                                       
//#10354                                                                           
//#10355        _asm{                                                                   
//#10356                xor        eax,eax                                                   
//#10357                mov        ebx,colmap                                                   
//#10358                mov        ecx,apcol                                                   
//#10359                bt        ebx,ecx                                                   
//#10360                jnc        short nxtcol1                                                   
//#10361                mov        eax,ecx                                                   
//#10362                jmp        short nxtcolx                                                   
//#10363    nxtcol1:    bsf        eax,ebx                                                           
//#10364                jne        short nxtcolx                                                   
//#10365                dec        eax                                                   
//#10366    nxtcolx:    btc        ebx,eax                                                           
//#10367                mov        colmap,ebx                                                   
//#10368        }                                                                   
//#10369    }                                                                       
//#10370                                                                           
//#10371    unsigned chkdun(unsigned bpnt){                                                                       
//#10372                                                                           
//#10373        _asm{                                                                   
//#10374                                                                           
//#10375                xor        eax,eax                                                   
//#10376                mov        ebx,offset dunmap                                                   
//#10377                mov        ecx,bpnt                                                   
//#10378                bt        [ebx],ecx                                                   
//#10379                jc        short chkdunx                                                   
//#10380                inc        eax                                                   
//#10381    chkdunx:                                                                       
//#10382        }                                                                   
//#10383    }                                                                       
//#10384                                                                           
//#10385    unsigned setdun(unsigned bpnt){                                                                       
//#10386                                                                           
//#10387        _asm{                                                                   
//#10388                mov        ebx,offset dunmap                                                   
//#10389                mov        ecx,bpnt                                                   
//#10390                bts        [ebx],ecx                                                   
//#10391        }                                                                   
//#10392    }                                                                       
//#10393                                                                           
//#10394    unsigned isrt(unsigned bpnt){                                                                       
//#10395                                                                           
//#10396        _asm{                                                                   
//#10397                                                                           
//#10398                xor        eax,eax                                                   
//#10399                mov        ebx,offset srtmsk                                                   
//#10400                mov        ecx,bpnt                                                   
//#10401                bt        [ebx],ecx                                                   
//#10402                jnc        isrtx                                                   
//#10403                inc        eax                                                   
//#10404    isrtx:                                                                       
//#10405        }                                                                   
//#10406    }                                                                       
//#10407                                                                           
//#10408    unsigned prgflg(unsigned ind){                                                                       
//#10409                                                                           
//#10410        if((stchs[ind].at&TYPMSK)==FRMBFIL)                                                                   
//#10411            return isrt(formlst[(stchs[ind].at&FRMSK)>>4].etyp&NEGUND);                                                               
//#10412        else                                                                   
//#10413            return 0;                                                               
//#10414    }                                                                       
//#10415                                                                           
//#10416    BOOL preced(unsigned stind){                                                                       
//#10417                                                                           
//#10418        unsigned fpnt,fcol,ind,ine;                                                                   
//#10419                                                                           
//#10420        if((stchs[stind].at&TYPMSK)==FRMBFIL){                                                                   
//#10421                                                                           
//#10422            fpnt=(stchs[stind].at&FRMSK)>>FRMSHFT;                                                               
//#10423            fcol=stchs[stind].at&COLMSK;                                                               
//#10424            for(ind=0;ind<prgind;ind++){                                                               
//#10425                                                                           
//#10426                if(chkdun(ind)){                                                           
//#10427                                                                           
//#10428                    ine=preg[ind].ind;                                                       
//#10429                    if((stchs[ine].at&COLMSK)==fcol&&                                                       
//#10430                        ((stchs[ine].at&FRMSK)>>FRMSHFT)==fpnt&&                                                   
//#10431                        (stchs[ine].at&TYPMSK)==FRMFIL)                                                   
//#10432                                                                           
//#10433                        return 0;                                                   
//#10434                }                                                           
//#10435            }                                                               
//#10436            return 1;                                                               
//#10437        }                                                                   
//#10438        else                                                                   
//#10439            return 1;                                                               
//#10440    }                                                                       
//#10441                                                                           
//#10442    void rotpar(){                                                                       
//#10443                                                                           
//#10444        if(ini.rotang<(PI/180))                                                                   
//#10445            tabmsg(IDS_ROTIN);                                                               
//#10446        if(chkMap(FPSEL)){                                                                   
//#10447                                                                           
//#10448            rotcntr.x=midl(pselrct.right,pselrct.left);                                                               
//#10449            rotcntr.y=midl(pselrct.top,pselrct.bottom);                                                               
//#10450            return;                                                               
//#10451        }                                                                   
//#10452        if(chkMap(BIGBOX)){                                                                   
//#10453                                                                           
//#10454            rotcntr.x=midl(rctal.right,rctal.left);                                                               
//#10455            rotcntr.y=midl(rctal.top,rctal.bottom);                                                               
//#10456            return;                                                               
//#10457        }                                                                   
//#10458        if(fselpnt){                                                                   
//#10459                                                                           
//#10460            if(chkMap(GMRK)){                                                               
//#10461                                                                           
//#10462                rotcntr.x=mrkpnt.x;                                                           
//#10463                rotcntr.y=mrkpnt.y;                                                           
//#10464            }                                                               
//#10465            else                                                               
//#10466                dufcntr(&rotcntr);                                                           
//#10467            setMap(FRMSROT);                                                               
//#10468            return;                                                               
//#10469        }                                                                   
//#10470        if(chkMap(FORMSEL)){                                                                   
//#10471                                                                           
//#10472            rotrct.left=frmpnt->rct.left;                                                               
//#10473            rotrct.right=frmpnt->rct.right;                                                               
//#10474            rotrct.top=frmpnt->rct.top;                                                               
//#10475            rotrct.bottom=frmpnt->rct.bottom;                                                               
//#10476            if(!chkMap(GMRK)){                                                               
//#10477                                                                           
//#10478                rotcntr.x=(double)(rotrct.right-rotrct.left)/2+rotrct.left;                                                           
//#10479                rotcntr.y=(double)(rotrct.top-rotrct.bottom)/2+rotrct.bottom;                                                           
//#10480            }                                                               
//#10481            setMap(FRMROT);                                                               
//#10482        }                                                                   
//#10483        else{                                                                   
//#10484                                                                           
//#10485            if(chkMap(GRPSEL)){                                                               
//#10486                                                                           
//#10487                rngadj();                                                           
//#10488                selRct(&rotrct);                                                           
//#10489            }                                                               
//#10490        }                                                                   
//#10491        if(chkMap(GMRK)){                                                                   
//#10492                                                                           
//#10493            rotcntr.x=mrkpnt.x;                                                               
//#10494            rotcntr.y=mrkpnt.y;                                                               
//#10495        }                                                                   
//#10496        else{                                                                   
//#10497                                                                           
//#10498            rotcntr.x=(double)(rotrct.right-rotrct.left)/2+rotrct.left;                                                               
//#10499            rotcntr.y=(double)(rotrct.top-rotrct.bottom)/2+rotrct.bottom;                                                               
//#10500        }                                                                   
//#10501    }                                                                       
//#10502                                                                           
//#10503    void rotentr(){                                                                       
//#10504                                                                           
//#10505        TCHAR buf[HBUFSIZ];                                                                   
//#10506                                                                           
//#10507        LoadString(hInst,IDS_ROTA,buf,HBUFSIZ);                                                                   
//#10508        sprintf(msgbuf,buf,ang/PI*180);                                                                   
//#10509        shoMsg(msgbuf);                                                                   
//#10510        setMap(NUMIN);                                                                   
//#10511        numWnd();                                                                   
//#10512    }                                                                       
//#10513                                                                           
//#10514    void setrang(){                                                                       
//#10515                                                                           
//#10516        ang=ini.rotang;                                                                   
//#10517        rotentr();                                                                   
//#10518        setMap(NUROT);                                                                   
//#10519    }                                                                       
//#10520                                                                           
//#10521    void rotcmd(){                                                                       
//#10522                                                                           
//#10523        if(chkMap(FORMSEL)||chkMap(GRPSEL)||fselpnt||chkMap(BIGBOX)||chkMap(FPSEL)){                                                                   
//#10524                                                                           
//#10525            ang=ini.rotang;                                                               
//#10526            rotpar();                                                               
//#10527            rotentr();                                                               
//#10528            setMap(ENTROT);                                                               
//#10529        }                                                                   
//#10530        else                                                                   
//#10531            shoseln(IDS_ALLX,IDS_ROTCMD);                                                               
//#10532    }                                                                       
//#10533                                                                           
//#10534    void fnagain(){                                                                       
//#10535                                                                           
//#10536        if(chkMap(FORMSEL)||chkMap(GRPSEL)||fselpnt||chkMap(BIGBOX)||chkMap(FPSEL)){                                                                   
//#10537                                                                           
//#10538            rotpar();                                                               
//#10539            rotfn();                                                               
//#10540        }                                                                   
//#10541        else                                                                   
//#10542            alrotmsg();                                                               
//#10543    }                                                                       
//#10544                                                                           
//#10545    void rotagain(){                                                                       
//#10546                                                                           
//#10547        ang=ini.rotang;                                                                   
//#10548        fnagain();                                                                   
//#10549    }                                                                       
//#10550                                                                           
//#10551    void bakagain(){                                                                       
//#10552                                                                           
//#10553        ang=2*PI-ini.rotang;                                                                   
//#10554        fnagain();                                                                   
//#10555    }                                                                       
//#10556                                                                           
//#10557    void rotdup(){                                                                       
//#10558                                                                           
//#10559        if(chkMap(FORMSEL)||chkMap(GRPSEL)||fselpnt){                                                                   
//#10560                                                                           
//#10561            ang=ini.rotang;                                                               
//#10562            rotpar();                                                               
//#10563            rotentr();                                                               
//#10564            setMap(ENTRDUP);                                                               
//#10565        }                                                                   
//#10566        else                                                                   
//#10567            shord();                                                               
//#10568    }                                                                       
//#10569                                                                           
//#10570    void adfrm(unsigned fpnt){                                                                       
//#10571                                                                           
//#10572        FRMHED*        nupnt;                                                           
//#10573                                                                           
//#10574        frmpnt=&formlst[fpnt];                                                                   
//#10575        nupnt=&formlst[formpnt];                                                                   
//#10576        frmcpy(nupnt,frmpnt);                                                                   
//#10577        clofind=formpnt;                                                                   
//#10578        nupnt->flt=adflt(frmpnt->sids);                                                                   
//#10579        mvflpnt(nupnt->flt,frmpnt->flt,frmpnt->sids);                                                                   
//#10580        if(nupnt->typ==SAT&&nupnt->stpt){                                                                   
//#10581                                                                           
//#10582            nupnt->sacang.sac=adsatk(nupnt->stpt);                                                               
//#10583            mvsatk(nupnt->sacang.sac,frmpnt->sacang.sac,frmpnt->stpt);                                                               
//#10584        }                                                                   
//#10585        if(iseclpx(formpnt)){                                                                   
//#10586                                                                           
//#10587            nupnt->clp=adclp(nupnt->nclp);                                                               
//#10588            mvflpnt(nupnt->clp,frmpnt->clp,frmpnt->nclp);                                                               
//#10589        }                                                                   
//#10590        if(isclpx(formpnt)){                                                                   
//#10591                                                                           
//#10592            nupnt->angclp.clp=adclp(nupnt->flencnt.nclp);                                                               
//#10593            mvflpnt(nupnt->angclp.clp,frmpnt->angclp.clp,frmpnt->flencnt.nclp);                                                               
//#10594        }                                                                   
//#10595        formpnt++;                                                                   
//#10596    }                                                                       
//#10597                                                                           
//#10598    void duprot(){                                                                       
//#10599                                                                           
//#10600        adfrm(clofind);                                                                   
//#10601        rotfn();                                                                   
//#10602        refil();                                                                   
//#10603        setMap(FORMSEL);                                                                   
//#10604        setMap(RESTCH);                                                                   
//#10605    }                                                                       
//#10606                                                                           
//#10607    void duprotfs(){                                                                       
//#10608                                                                           
//#10609        unsigned    bakpnt,ind;                                                               
//#10610                                                                           
//#10611        bakpnt=formpnt;                                                                   
//#10612        rotpar();                                                                   
//#10613        for(ind=0;ind<fselpnt;ind++)                                                                   
//#10614            adfrm(selist[ind]);                                                               
//#10615        formpnt=bakpnt;                                                                   
//#10616        for(ind=0;ind<fselpnt;ind++)                                                                   
//#10617            selist[ind]=formpnt++;                                                               
//#10618        fnagain();                                                                   
//#10619    }                                                                       
//#10620                                                                           
//#10621    void duprots(){                                                                       
//#10622                                                                           
//#10623        unsigned src,dst;                                                                   
//#10624                                                                           
//#10625        rngadj();                                                                   
//#10626        dst=hed.stchs;                                                                   
//#10627        for(src=gpnt0;src<=gpnt1;src++){                                                                   
//#10628                                                                           
//#10629            stchs[dst].x=stchs[src].x;                                                               
//#10630            stchs[dst].y=stchs[src].y;                                                               
//#10631            stchs[dst++].at=stchs[src].at&(~(FRMSK|TYPMSK));                                                               
//#10632        }                                                                   
//#10633        cloInd=hed.stchs;                                                                   
//#10634        hed.stchs+=(gpnt1-gpnt0);                                                                   
//#10635        grpInd=hed.stchs;                                                                   
//#10636        hed.stchs++;                                                                   
//#10637        rngadj();                                                                   
//#10638        rotfn();                                                                   
//#10639        coltab();                                                                   
//#10640        setMap(RESTCH);                                                                   
//#10641    }                                                                       
//#10642                                                                           
//#10643    void cplayfn(unsigned fpnt,unsigned play){                                                                       
//#10644                                                                           
//#10645        FRMHED*        spnt;                                                           
//#10646                                                                           
//#10647        spnt=&formlst[fpnt];                                                                   
//#10648        fvars(formpnt);                                                                   
//#10649        frmcpy(frmpnt,spnt);                                                                   
//#10650        fvars(formpnt);                                                                   
//#10651        frmpnt->flt=adflt(frmpnt->sids);                                                                   
//#10652        MoveMemory(frmpnt->flt,spnt->flt,sids*sizeof(FLPNT));                                                                   
//#10653        if(frmpnt->typ==SAT&&frmpnt->stpt)                                                                   
//#10654        {                                                                   
//#10655            frmpnt->sacang.sac=adsatk(frmpnt->stpt);                                                               
//#10656            MoveMemory(frmpnt->sacang.sac,spnt->sacang.sac,frmpnt->stpt*sizeof(SATCON));                                                               
//#10657        }                                                                   
//#10658        frmpnt->nclp=0;                                                                   
//#10659        frmpnt->ftyp=0;                                                                   
//#10660        frmpnt->flencnt.nclp=0;;                                                                   
//#10661        frmpnt->etyp=0;                                                                   
//#10662        frmpnt->dhx.txt.ind=0;                                                                   
//#10663        frmpnt->at=formlst[formpnt].at&NFRMLMSK;                                                                   
//#10664        frmpnt->at|=play;                                                                   
//#10665        formpnt++;                                                                   
//#10666    }                                                                       
//#10667                                                                           
//#10668    void cpylayr(unsigned play){                                                                       
//#10669                                                                           
//#10670        unsigned ind,ine,playcod;                                                                   
//#10671                                                                           
//#10672        if(fselpnt){                                                                   
//#10673                                                                           
//#10674            savdo();                                                               
//#10675            for(ind=0;ind<fselpnt;ind++)                                                               
//#10676                cplayfn(selist[ind],play);                                                           
//#10677        }                                                                   
//#10678        else{                                                                   
//#10679                                                                           
//#10680            if(chkMap(FORMSEL)){                                                               
//#10681                                                                           
//#10682                savdo();                                                           
//#10683                cplayfn(clofind,play);                                                           
//#10684            }                                                               
//#10685            else{                                                               
//#10686                                                                           
//#10687                if(chkMap(GRPSEL)){                                                           
//#10688                                                                           
//#10689                    savdo();                                                       
//#10690                    playcod=play<<(LAYSHFT-1);                                                       
//#10691                    rngadj();                                                       
//#10692                    ine=hed.stchs;                                                       
//#10693                    for(ind=gpnt0;ind<gpnt1;ind++){                                                       
//#10694                                                                           
//#10695                        stchs[ine].at=stchs[ind].at&NLAYMSK|playcod;                                                   
//#10696                        stchs[ine].x=stchs[ind].x;                                                   
//#10697                        stchs[ine++].y=stchs[ind].y;                                                   
//#10698                    }                                                       
//#10699                    hed.stchs=ine;                                                       
//#10700                    coltab();                                                       
//#10701                    setMap(RESTCH);                                                       
//#10702                }                                                           
//#10703            }                                                               
//#10704        }                                                                   
//#10705    }                                                                       
//#10706                                                                           
//#10707    void movlayr(unsigned play){                                                                       
//#10708                                                                           
//#10709        unsigned slay,ind,ine;                                                                   
//#10710        unsigned stchcod;                                                                   
//#10711                                                                           
//#10712        stchcod=play<<(LAYSHFT-1);                                                                   
//#10713        if(fselpnt){                                                                   
//#10714                                                                           
//#10715            savdo();                                                               
//#10716            clRmap((formpnt>>5)+1);                                                               
//#10717            for(ind=0;ind<fselpnt;ind++){                                                               
//#10718                                                                           
//#10719                ine=selist[ind];                                                           
//#10720                slay=(formlst[ine].at&FRMLMSK)>>1;                                                           
//#10721                formlst[ine].at=(TCHAR)(formlst[ine].at&NFRMLMSK)|play;                                                           
//#10722                setr(ine);                                                           
//#10723            }                                                               
//#10724            for(ind=0;ind<hed.stchs;ind++){                                                               
//#10725                                                                           
//#10726                if(stchs[ind].at&ALTYPMSK){                                                           
//#10727                                                                           
//#10728                    ine=(stchs[ind].at&FRMSK)>>FRMSHFT;                                                       
//#10729                    if(chkr(ine))                                                       
//#10730                        stchs[ind].at=stchs[ind].at&NLAYMSK|stchcod;                                                   
//#10731                }                                                           
//#10732            }                                                               
//#10733            fselpnt=0;                                                               
//#10734            rstMap(FORMSEL);                                                               
//#10735            setMap(RESTCH);                                                               
//#10736        }                                                                   
//#10737        else{                                                                   
//#10738                                                                           
//#10739            if(chkMap(FORMSEL)){                                                               
//#10740                                                                           
//#10741                savdo();                                                           
//#10742                slay=(formlst[clofind].at&FRMLMSK)>>1;                                                           
//#10743                formlst[clofind].at=(TCHAR)(formlst[clofind].at&NFRMLMSK)|play;                                                           
//#10744                rstMap(FORMSEL);                                                           
//#10745                for(ind=0;ind<hed.stchs;ind++){                                                           
//#10746                                                                           
//#10747                    if(stchs[ind].at&ALTYPMSK&&((stchs[ind].at&FRMSK)>>FRMSHFT)==clofind)                                                       
//#10748                        stchs[ind].at=stchs[ind].at&NLAYMSK|stchcod;                                                   
//#10749                }                                                           
//#10750                setMap(RESTCH);                                                           
//#10751            }                                                               
//#10752            else{                                                               
//#10753                                                                           
//#10754                if(chkMap(GRPSEL)){                                                           
//#10755                                                                           
//#10756                    savdo();                                                       
//#10757                    rngadj();                                                       
//#10758                    for(ind=gpnt0;ind<gpnt1;ind++)                                                       
//#10759                        stchs[ind].at=stchs[ind].at&NLAYMSK|stchcod;                                                   
//#10760                    setMap(RESTCH);                                                       
//#10761                }                                                           
//#10762            }                                                               
//#10763        }                                                                   
//#10764    }                                                                       
//#10765                                                                           
//#10766    void join(){                                                                       
//#10767                                                                           
//#10768        unsigned    bakpnt,ind,sids;                                                               
//#10769        FLPNT*        tflt;                                                           
//#10770        FLPNT*        ipnt;                                                           
//#10771                                                                           
//#10772        bakpnt=clofind;                                                                   
//#10773        setMap(FRMSAM);                                                                   
//#10774        if(formpnt>1&&chkMap(FORMSEL)&&closfrm()){                                                                   
//#10775                                                                           
//#10776            sids=formlst[clofind].sids;                                                               
//#10777            tflt=(FLPNT*)&bseq;                                                               
//#10778            for(ind=0;ind<sids;ind++){                                                               
//#10779                                                                           
//#10780                tflt[ind].x=formlst[clofind].flt[clofine].x;                                                           
//#10781                tflt[ind].y=formlst[clofind].flt[clofine].y;                                                           
//#10782                clofine=nxt(clofine);                                                           
//#10783            }                                                               
//#10784            setMap(DELTO);                                                               
//#10785            frmdel();                                                               
//#10786            if(bakpnt>clofind)                                                               
//#10787                clofind=bakpnt-1;                                                           
//#10788            else                                                               
//#10789                clofind=bakpnt;                                                           
//#10790            ipnt=&formlst[clofind].flt[formlst[clofind].sids];                                                               
//#10791            fltspac(ipnt,sids);                                                               
//#10792            for(ind=0;ind<sids;ind++){                                                               
//#10793                                                                           
//#10794                ipnt[ind].x=tflt[ind].x;                                                           
//#10795                ipnt[ind].y=tflt[ind].y;                                                           
//#10796            }                                                               
//#10797            frmpnt=&formlst[clofind];                                                               
//#10798            frmpnt->sids+=sids;                                                               
//#10799            frmpnt->rct.left=frmpnt->rct.right=frmpnt->flt[0].x;                                                               
//#10800            frmpnt->rct.top=frmpnt->rct.bottom=frmpnt->flt[0].y;                                                               
//#10801            for(ind=1;ind<frmpnt->sids;ind++){                                                               
//#10802                                                                           
//#10803                if(frmpnt->flt[ind].x<frmpnt->rct.left)                                                           
//#10804                    frmpnt->rct.left=frmpnt->flt[ind].x;                                                       
//#10805                if(frmpnt->flt[ind].x>frmpnt->rct.right)                                                           
//#10806                    frmpnt->rct.right=frmpnt->flt[ind].x;                                                       
//#10807                if(frmpnt->flt[ind].y>frmpnt->rct.top)                                                           
//#10808                    frmpnt->rct.top=frmpnt->flt[ind].y;                                                       
//#10809                if(frmpnt->flt[ind].y<frmpnt->rct.bottom)                                                           
//#10810                    frmpnt->rct.bottom=frmpnt->flt[ind].y;                                                       
//#10811            }                                                               
//#10812            refil();                                                               
//#10813            coltab();                                                               
//#10814            setMap(RESTCH);                                                               
//#10815        }                                                                   
//#10816        rstMap(FRMSAM);                                                                   
//#10817    }                                                                       
//#10818                                                                           
//#10819    BOOL chkbfil(){                                                                       
//#10820                                                                           
//#10821        switch(frmpnt->etyp){                                                                   
//#10822                                                                           
//#10823        case EGLIN:                                                                   
//#10824        case EGBLD:                                                                   
//#10825        case EGSAT:                                                                   
//#10826        case EGAP:                                                                   
//#10827        case EGPRP:                                                                   
//#10828        case EGHOL:                                                                   
//#10829        case EGPIC:                                                                   
//#10830        case EGCLP:                                                                   
//#10831            return 1;                                                               
//#10832        }                                                                   
//#10833        return 0;                                                                   
//#10834    }                                                                       
//#10835                                                                           
//#10836    void refilal(){                                                                       
//#10837                                                                           
//#10838        unsigned bakpnt;                                                                   
//#10839                                                                           
//#10840        savdo();                                                                   
//#10841        bakpnt=clofind;                                                                   
//#10842        for(clofind=0;clofind<formpnt;clofind++)                                                                   
//#10843            refilfn();                                                               
//#10844        clofind=bakpnt;                                                                   
//#10845        fvars(clofind);                                                                   
//#10846        coltab();                                                                   
//#10847        setMap(RESTCH);                                                                   
//#10848    }                                                                       
//#10849                                                                           
//#10850    BOOL notsel(){                                                                       
//#10851                                                                           
//#10852        unsigned ind;                                                                   
//#10853                                                                           
//#10854        for(ind=0;ind<fselpnt;ind++){                                                                   
//#10855                                                                           
//#10856            if((unsigned)selist[ind]==clofind)                                                               
//#10857                return 0;                                                           
//#10858        }                                                                   
//#10859        return 1;                                                                   
//#10860    }                                                                       
//#10861                                                                           
//#10862    void nufsel(){                                                                       
//#10863                                                                           
//#10864        if(formpnt){                                                                   
//#10865                                                                           
//#10866            rstMap(FORMSEL);                                                               
//#10867            if(rstMap(WASEL))                                                               
//#10868                selist[fselpnt++]=baksel;                                                           
//#10869            if(notsel())                                                               
//#10870                selist[fselpnt++]=(unsigned short)clofind;                                                           
//#10871            setMap(RESTCH);                                                               
//#10872        }                                                                   
//#10873    }                                                                       
//#10874                                                                           
//#10875    void frmadj(unsigned find){                                                                       
//#10876                                                                           
//#10877        unsigned ind;                                                                   
//#10878                                                                           
//#10879        fvars(find);                                                                   
//#10880        for(ind=0;ind<frmpnt->sids;ind++){                                                                   
//#10881                                                                           
//#10882            flt[ind].x+=fmovdif.x;                                                               
//#10883            flt[ind].y-=fmovdif.y;                                                               
//#10884        }                                                                   
//#10885        frmout(find);                                                                   
//#10886    }                                                                       
//#10887                                                                           
//#10888    void setr(unsigned pbit){                                                                       
//#10889                                                                           
//#10890        _asm{                                                                   
//#10891                                                                           
//#10892                mov        ebx,offset rmap                                                   
//#10893                mov        eax,pbit                                                   
//#10894                bts        [ebx],eax                                                   
//#10895        }                                                                   
//#10896    }                                                                       
//#10897                                                                           
//#10898    void clRmap(unsigned len){                                                                       
//#10899                                                                           
//#10900        _asm{                                                                   
//#10901                                                                           
//#10902                xor        eax,eax                                                   
//#10903                mov        ecx,len                                                   
//#10904                mov        edi,offset rmap                                                   
//#10905                rep        stosd                                                   
//#10906        }                                                                   
//#10907    }                                                                       
//#10908                                                                           
//#10909    #if PESACT                                                                       
//#10910                                                                           
//#10911    BOOL setrc(unsigned pbit){                                                                       
//#10912                                                                           
//#10913           _asm{                                                                   
//#10914                                                                           
//#10915                xor        eax,eax                                                   
//#10916                mov        ebx,offset rmap                                                   
//#10917                mov        ecx,pbit                                                   
//#10918                bts        [ebx],ecx                                                   
//#10919                jnc        short setrcx                                                   
//#10920                inc        eax                                                   
//#10921    setrcx:                                                                       
//#10922        }                                                                   
//#10923    }                                                                       
//#10924    #endif                                                                       
//#10925                                                                           
//#10926    BOOL chkr(unsigned pbit){                                                                       
//#10927                                                                           
//#10928        _asm{                                                                   
//#10929                                                                           
//#10930                xor        eax,eax                                                   
//#10931                mov        ecx,pbit                                                   
//#10932                mov        ebx,offset rmap                                                   
//#10933                bt        [ebx],ecx                                                   
//#10934                jnc        chkrx                                                   
//#10935                inc        eax                                                   
//#10936    chkrx:                                                                       
//#10937        }                                                                   
//#10938    }                                                                       
//#10939                                                                           
//#10940    void frmsadj(){                                                                       
//#10941                                                                           
//#10942        unsigned ind;                                                                   
//#10943                                                                           
//#10944        clRmap(RMAPSIZ);                                                                   
//#10945        for(ind=0;ind<fselpnt;ind++)                                                                   
//#10946            setr(selist[ind]);                                                               
//#10947        for(ind=0;ind<hed.stchs;ind++){                                                                   
//#10948                                                                           
//#10949            if(stchs[ind].at&ALTYPMSK&&chkr((stchs[ind].at&FRMSK)>>FRMSHFT)){                                                               
//#10950                                                                           
//#10951                stchs[ind].x+=fmovdif.x;                                                           
//#10952                stchs[ind].y-=fmovdif.y;                                                           
//#10953            }                                                               
//#10954        }                                                                   
//#10955    }                                                                       
//#10956                                                                           
//#10957    void stchrct2px(FLRCT srct,RECT* prct){                                                                       
//#10958                                                                           
//#10959        DUBPNT    ipnt;                                                               
//#10960        POINT    opnt;                                                               
//#10961                                                                           
//#10962        ipnt.x=srct.left;                                                                   
//#10963        ipnt.y=srct.top;                                                                   
//#10964        sCor2px(ipnt,&opnt);                                                                   
//#10965        prct->left=opnt.x;                                                                   
//#10966        prct->top=opnt.y;                                                                   
//#10967        ipnt.x=srct.right;                                                                   
//#10968        ipnt.y=srct.bottom;                                                                   
//#10969        sCor2px(ipnt,&opnt);                                                                   
//#10970        prct->right=opnt.x;                                                                   
//#10971        prct->bottom=opnt.y;                                                                   
//#10972    }                                                                       
//#10973                                                                           
//#10974    void getbig(){                                                                       
//#10975                                                                           
//#10976        unsigned    ind;                                                               
//#10977        FLRCT*        trct;                                                           
//#10978                                                                           
//#10979        rctal.bottom=rctal.left=1e9;                                                                   
//#10980        rctal.top=rctal.right=0;                                                                   
//#10981        for(ind=0;ind<formpnt;ind++){                                                                   
//#10982                                                                           
//#10983            trct=&formlst[ind].rct;                                                               
//#10984            if(trct->bottom<rctal.bottom)                                                               
//#10985                rctal.bottom=trct->bottom;                                                           
//#10986            if(trct->left<rctal.left)                                                               
//#10987                rctal.left=trct->left;                                                           
//#10988            if(trct->right>rctal.right)                                                               
//#10989                rctal.right=trct->right;                                                           
//#10990            if(trct->top>rctal.top)                                                               
//#10991                rctal.top=trct->top;                                                           
//#10992        }                                                                   
//#10993        for(ind=0;ind<hed.stchs;ind++){                                                                   
//#10994                                                                           
//#10995            if(stchs[ind].x<rctal.left)                                                               
//#10996                rctal.left=stchs[ind].x;                                                           
//#10997            if(stchs[ind].x>rctal.right)                                                               
//#10998                rctal.right=stchs[ind].x;                                                           
//#10999            if(stchs[ind].y<rctal.bottom)                                                               
//#11000                rctal.bottom=stchs[ind].y;                                                           
//#11001            if(stchs[ind].y>rctal.top)                                                               
//#11002                rctal.top=stchs[ind].y;                                                           
//#11003        }                                                                   
//#11004    }                                                                       
//#11005                                                                           
//#11006    void selal(){                                                                       
//#11007                                                                           
//#11008        rstMap(FORMSEL);                                                                   
//#11009        fselpnt=0;                                                                   
//#11010        rstMap(SELBOX);                                                                   
//#11011        rstMap(GRPSEL);                                                                   
//#11012        getbig();                                                                   
//#11013        zRct.bottom=0;                                                                   
//#11014        zRct.left=0;                                                                   
//#11015        zRct.right=zum0.x;                                                                   
//#11016        zRct.top=zum0.y;                                                                   
//#11017        zumFct=1;                                                                   
//#11018        rstMap(ZUMED);                                                                   
//#11019        movStch();                                                                   
//#11020        selCnt=0;                                                                   
//#11021        rstMap(RUNPAT);                                                                   
//#11022        duzrat();                                                                   
//#11023        stchrct2px(rctal,&bigrct);                                                                   
//#11024        setMap(BIGBOX);                                                                   
//#11025        setMap(RESTCH);                                                                   
//#11026    }                                                                       
//#11027                                                                           
//#11028    void frmpnts(unsigned typ){                                                                       
//#11029                                                                           
//#11030        unsigned ind=0;                                                                   
//#11031        unsigned trg=(clofind<<4)|typ;                                                                   
//#11032                                                                           
//#11033        while(ind<hed.stchs&&(stchs[ind].at&(ALTYPMSK|FRMSK))!=trg)                                                                   
//#11034            ind++;                                                               
//#11035        cloInd=ind;                                                                   
//#11036        ind=hed.stchs-1;                                                                   
//#11037        while(ind>cloInd&&(stchs[ind].at&(ALTYPMSK|FRMSK))!=trg)                                                                   
//#11038            ind--;                                                               
//#11039        grpInd=ind;                                                                   
//#11040    }                                                                       
//#11041                                                                           
//#11042    void selfil(unsigned typ){                                                                       
//#11043                                                                           
//#11044        frm1pnt();                                                                   
//#11045        if(chkMap(FORMSEL)){                                                                   
//#11046                                                                           
//#11047            if(typ==FRMFIL&&!formlst[clofind].ftyp){                                                               
//#11048                                                                           
//#11049                tabmsg(IDS_FSELF);                                                           
//#11050                return;                                                           
//#11051            }                                                               
//#11052            if(typ==FRMBFIL&&!formlst[clofind].etyp){                                                               
//#11053                                                                           
//#11054                tabmsg(IDS_FSELB);                                                           
//#11055                return;                                                           
//#11056            }                                                               
//#11057            if(typ==FRMAPFIL&&(formlst[clofind].etyp&NEGUND)!=EGAP){                                                               
//#11058                                                                           
//#11059                tabmsg(IDS_FSELA);                                                           
//#11060                return;                                                           
//#11061            }                                                               
//#11062            frmpnts(typ);                                                               
//#11063            setMap(GRPSEL);                                                               
//#11064            rstMap(FORMSEL);                                                               
//#11065            rngadj();                                                               
//#11066            setMap(RESTCH);                                                               
//#11067        }                                                                   
//#11068        else                                                                   
//#11069            tabmsg(IDS_SEL1FRM);                                                               
//#11070    }                                                                       
//#11071                                                                           
//#11072    /*                                                                       
//#11073    BOOL notfstch(unsigned at){                                                                       
//#11074                                                                           
//#11075        _asm{                                                                   
//#11076                xor        eax,eax                                                   
//#11077                mov        ebx,at                                                   
//#11078                test    ebx,TYPMSK                                                       
//#11079                je        short notf1                                                   
//#11080                mov        ecx,clofind                                                   
//#11081                shl        ecx,4                                                   
//#11082                and        ebx,FRMSK                                                   
//#11083                cmp        ecx,ebx                                                   
//#11084                je        short notfx                                                   
//#11085    notf1:        inc        eax                                                       
//#11086    notfx:                                                                       
//#11087        }                                                                   
//#11088    }*/                                                                       
//#11089                                                                           
//#11090    BOOL notfstch(unsigned at)                                                                       
//#11091    {                                                                       
//#11092        if(at&NOTFRM)                                                                   
//#11093            return 1;                                                               
//#11094        if(((at&FRMSK)>>FRMSHFT)==clofind)                                                                   
//#11095            return 0;                                                               
//#11096        return 1;                                                                   
//#11097    }                                                                       
//#11098                                                                           
//#11099    void selalfil(){                                                                       
//#11100                                                                           
//#11101        frm1pnt();                                                                   
//#11102        if(chkMap(FORMSEL)){                                                                   
//#11103                                                                           
//#11104            cloInd=0;                                                               
//#11105            while(cloInd<hed.stchs&&notfstch(stchs[cloInd].at))                                                               
//#11106                cloInd++;                                                           
//#11107            if(cloInd!=hed.stchs)                                                               
//#11108            {                                                               
//#11109                if(cloInd)                                                           
//#11110                    cloInd--;                                                       
//#11111                grpInd=hed.stchs-1;                                                           
//#11112                while(grpInd>cloInd&&notfstch(stchs[grpInd].at))                                                           
//#11113                    grpInd--;                                                       
//#11114                setMap(GRPSEL);                                                           
//#11115                rstMap(FORMSEL);                                                           
//#11116                rngadj();                                                           
//#11117                setMap(RESTCH);                                                           
//#11118            }                                                               
//#11119            else                                                               
//#11120                tabmsg(IDS_FSELM);                                                           
//#11121        }                                                                   
//#11122        else                                                                   
//#11123            tabmsg(IDS_SEL1FRM);                                                               
//#11124    }                                                                       
//#11125                                                                           
//#11126    BOOL frmrng(unsigned fpnt,RANG* rng){                                                                       
//#11127                                                                           
//#11128        rng->strt=0;                                                                   
//#11129        rng->fin=hed.stchs;                                                                   
//#11130        if(formlst[fpnt].ftyp||formlst[fpnt].etyp){                                                                   
//#11131                                                                           
//#11132            while(rng->strt<hed.stchs&&notfstch(stchs[rng->strt].at))                                                               
//#11133                rng->strt++;                                                           
//#11134            rng->fin=hed.stchs-1;                                                               
//#11135            while(rng->fin>rng->strt&&notfstch(stchs[rng->fin].at))                                                               
//#11136                rng->fin--;                                                           
//#11137            if(rng->fin>rng->strt)                                                               
//#11138                return 1;                                                           
//#11139            else                                                               
//#11140                return 0;                                                           
//#11141        }                                                                   
//#11142        else                                                                   
//#11143            return 0;                                                               
//#11144    }                                                                       
//#11145                                                                           
//#11146    void bhfn(unsigned strt,unsigned fin,double spac){                                                                       
//#11147                                                                           
//#11148        double        len;                                                           
//#11149        DUBPNT        dif,stp,ostp,pnti,pntf,pnto;                                                           
//#11150        unsigned    cnt,ind;                                                               
//#11151                                                                           
//#11152        dif.x=flt[fin].x-flt[strt].x;                                                                   
//#11153        dif.y=flt[fin].y-flt[strt].y;                                                                   
//#11154        ang=atan2(-dif.x,dif.y);                                                                   
//#11155        ostp.x=frmpnt->esiz*cos(ang);                                                                   
//#11156        ostp.y=frmpnt->esiz*sin(ang);                                                                   
//#11157        len=hypot(dif.x,dif.y);                                                                   
//#11158        cnt=len/spac;                                                                   
//#11159        stp.x=dif.x/cnt;                                                                   
//#11160        stp.y=dif.y/cnt;                                                                   
//#11161        pnti.x=flt[strt].x;                                                                   
//#11162        pnti.y=flt[strt].y;                                                                   
//#11163        if(cnt){                                                                   
//#11164                                                                           
//#11165            for(ind=0;ind<cnt-1;ind++){                                                               
//#11166                                                                           
//#11167                pntf.x=pnti.x+stp.x;                                                           
//#11168                pntf.y=pnti.y+stp.y;                                                           
//#11169                pnto.x=pntf.x+ostp.x;                                                           
//#11170                pnto.y=pntf.y+ostp.y;                                                           
//#11171                oseq[seqpnt].x=pntf.x;                                                           
//#11172                oseq[seqpnt++].y=pntf.y;                                                           
//#11173                oseq[seqpnt].x=pnti.x;                                                           
//#11174                oseq[seqpnt++].y=pnti.y;                                                           
//#11175                oseq[seqpnt].x=pntf.x;                                                           
//#11176                oseq[seqpnt++].y=pntf.y;                                                           
//#11177                oseq[seqpnt].x=pnto.x;                                                           
//#11178                oseq[seqpnt++].y=pnto.y;                                                           
//#11179                oseq[seqpnt].x=pntf.x;                                                           
//#11180                oseq[seqpnt++].y=pntf.y;                                                           
//#11181                oseq[seqpnt].x=pnto.x;                                                           
//#11182                oseq[seqpnt++].y=pnto.y;                                                           
//#11183                oseq[seqpnt].x=pntf.x;                                                           
//#11184                oseq[seqpnt++].y=pntf.y;                                                           
//#11185                pnti.x+=stp.x;                                                           
//#11186                pnti.y+=stp.y;                                                           
//#11187            }                                                               
//#11188            pntf.x=pnti.x+stp.x;                                                               
//#11189            pntf.y=pnti.y+stp.y;                                                               
//#11190            oseq[seqpnt].x=pntf.x;                                                               
//#11191            oseq[seqpnt++].y=pntf.y;                                                               
//#11192            oseq[seqpnt].x=pnti.x;                                                               
//#11193            oseq[seqpnt++].y=pnti.y;                                                               
//#11194        }                                                                   
//#11195    }                                                                       
//#11196                                                                           
//#11197    void bhcrnr(unsigned lin){                                                                       
//#11198                                                                           
//#11199        unsigned    tlin=nxt(lin);                                                               
//#11200        DUBPNT        dif,pnt;                                                           
//#11201        double        len,rat;                                                           
//#11202                                                                           
//#11203        if(chkMap(INDIR))                                                                   
//#11204        {                                                                   
//#11205            dif.x=opnts[tlin].x-flt[tlin].x;                                                               
//#11206            dif.y=opnts[tlin].y-flt[tlin].y;                                                               
//#11207        }                                                                   
//#11208        else                                                                   
//#11209        {                                                                   
//#11210            dif.x=ipnts[tlin].x-flt[tlin].x;                                                               
//#11211            dif.y=ipnts[tlin].y-flt[tlin].y;                                                               
//#11212        }                                                                   
//#11213        len=hypot(dif.x,dif.y);                                                                   
//#11214        rat=bfclen/len;                                                                   
//#11215        dif.x*=rat;                                                                   
//#11216        dif.y*=rat;                                                                   
//#11217        pnt.x=flt[tlin].x+dif.x;                                                                   
//#11218        pnt.y=flt[tlin].y+dif.y;                                                                   
//#11219        oseq[seqpnt].x=flt[tlin].x;                                                                   
//#11220        oseq[seqpnt++].y=flt[tlin].y;                                                                   
//#11221        oseq[seqpnt].x=pnt.x;                                                                   
//#11222        oseq[seqpnt++].y=pnt.y;                                                                   
//#11223        oseq[seqpnt].x=flt[tlin].x;                                                                   
//#11224        oseq[seqpnt++].y=flt[tlin].y;                                                                   
//#11225        oseq[seqpnt].x=pnt.x;                                                                   
//#11226        oseq[seqpnt++].y=pnt.y;                                                                   
//#11227        oseq[seqpnt].x=flt[tlin].x;                                                                   
//#11228        oseq[seqpnt++].y=flt[tlin].y;                                                                   
//#11229    }                                                                       
//#11230                                                                           
//#11231    void bhbrd(double spac){                                                                       
//#11232                                                                           
//#11233        unsigned short    slin;                                                               
//#11234        unsigned short    nlin,ind;                                                               
//#11235                                                                           
//#11236        slin=getlast();                                                                   
//#11237        seqpnt=0;                                                                   
//#11238        oseq[seqpnt].x=flt[slin].x;                                                                   
//#11239        oseq[seqpnt++].y=flt[slin].y;                                                                   
//#11240        for(ind=0;ind<sids;ind++){                                                                   
//#11241                                                                           
//#11242            nlin=nxt(slin);                                                               
//#11243            bhfn(slin,nlin,spac);                                                               
//#11244            bhcrnr(slin);                                                               
//#11245            slin=nlin;                                                               
//#11246        }                                                                   
//#11247    }                                                                       
//#11248                                                                           
//#11249    void blbrd(double spac){                                                                       
//#11250                                                                           
//#11251        unsigned ind;                                                                   
//#11252                                                                           
//#11253        seqpnt=0;                                                                   
//#11254        oseq[seqpnt].x=flt[0].x;                                                                   
//#11255        oseq[seqpnt++].y=flt[0].y;                                                                   
//#11256        for(ind=0;ind<(unsigned)sids-2;ind++){                                                                   
//#11257                                                                           
//#11258            bhfn(ind,ind+1,spac);                                                               
//#11259            bhcrnr(ind);                                                               
//#11260        }                                                                   
//#11261        bhfn(ind,ind+1,spac);                                                                   
//#11262        oseq[seqpnt].x=flt[sids-1].x;                                                                   
//#11263        oseq[seqpnt++].y=flt[sids-1].y;                                                                   
//#11264    }                                                                       
//#11265                                                                           
//#11266    void bholbrd(){                                                                       
//#11267                                                                           
//#11268        deleclp(clofind);                                                                   
//#11269        frmpnt->esiz=brdwid;                                                                   
//#11270        bsizpar();                                                                   
//#11271        frmpnt->etyp=EGHOL;                                                                   
//#11272        frmpnt->espac=stspace;                                                                   
//#11273        frmpnt->bcol=actcol;                                                                   
//#11274        savblen(bfclen);                                                                   
//#11275        refilfn();                                                                   
//#11276    }                                                                       
//#11277                                                                           
//#11278    void bhol(){                                                                       
//#11279                                                                           
//#11280        double        tspac=stspace;                                                           
//#11281        unsigned    ind;                                                               
//#11282                                                                           
//#11283        if(filmsgs(FML_BHOL))                                                                   
//#11284            return;                                                               
//#11285        stspace=tspac;                                                                   
//#11286        if(fselpnt){                                                                   
//#11287                                                                           
//#11288            for(ind=0;ind<fselpnt;ind++){                                                               
//#11289                                                                           
//#11290                clofind=selist[ind];                                                           
//#11291                fvars(clofind);                                                           
//#11292                bholbrd();                                                           
//#11293            }                                                               
//#11294            setMap(INIT);                                                               
//#11295            coltab();                                                               
//#11296            setMap(RESTCH);                                                               
//#11297        }                                                                   
//#11298        else{                                                                   
//#11299                                                                           
//#11300            if(chkMap(FORMSEL)){                                                               
//#11301                                                                           
//#11302                fvars(clofind);                                                           
//#11303                bholbrd();                                                           
//#11304                setMap(INIT);                                                           
//#11305                coltab();                                                           
//#11306                ritot(hed.stchs);                                                           
//#11307                setMap(RESTCH);                                                           
//#11308            }                                                               
//#11309        }                                                                   
//#11310        stspace=tspac;                                                                   
//#11311    }                                                                       
//#11312                                                                           
//#11313    void fcntr(){                                                                       
//#11314                                                                           
//#11315        unsigned    ind,ine,inf,tat;                                                               
//#11316        FRCT        avrct;                                                           
//#11317        DUBPNT        avcntr;                                                           
//#11318        DUBPNT        cntr;                                                           
//#11319        DUBPNT        dif;                                                           
//#11320                                                                           
//#11321        avrct.bottom=avrct.left=avrct.right=avrct.top=0;                                                                   
//#11322        if(fselpnt){                                                                   
//#11323                                                                           
//#11324            savdo();                                                               
//#11325            ine=selist[0];                                                               
//#11326            avcntr.x=(formlst[ine].rct.right-formlst[ine].rct.left)/2+formlst[ine].rct.left;                                                               
//#11327            avcntr.y=(formlst[ine].rct.top-formlst[ine].rct.bottom)/2+formlst[ine].rct.bottom;                                                               
//#11328            for(ind=1;ind<fselpnt;ind++){                                                               
//#11329                                                                           
//#11330                ine=selist[ind];                                                           
//#11331                cntr.x=(formlst[ine].rct.right-formlst[ine].rct.left)/2+formlst[ine].rct.left;                                                           
//#11332                cntr.y=(formlst[ine].rct.top-formlst[ine].rct.bottom)/2+formlst[ine].rct.bottom;                                                           
//#11333                dif.x=avcntr.x-cntr.x;                                                           
//#11334                dif.y=avcntr.y-cntr.y;                                                           
//#11335                frmpnt=&formlst[ine];                                                           
//#11336                for(inf=0;inf<frmpnt->sids;inf++){                                                           
//#11337                                                                           
//#11338                    frmpnt->flt[inf].x+=dif.x;                                                       
//#11339                    frmpnt->flt[inf].y+=dif.y;                                                       
//#11340                }                                                           
//#11341                frmout(ine);                                                           
//#11342                tat=(ine<<4);                                                           
//#11343                for(inf=0;inf<hed.stchs;inf++){                                                           
//#11344                                                                           
//#11345                    if((stchs[inf].at&FRMSK)==tat&&!(stchs[ind].at&NOTFRM)){                                                       
//#11346                                                                           
//#11347                        stchs[inf].x+=dif.x;                                                   
//#11348                        stchs[inf].y+=dif.y;                                                   
//#11349                    }                                                       
//#11350                }                                                           
//#11351            }                                                               
//#11352            setMap(RESTCH);                                                               
//#11353        }                                                                   
//#11354        else                                                                   
//#11355            tabmsg(IDS_SELC);                                                               
//#11356    }                                                                       
//#11357                                                                           
//#11358    void boxsel(){                                                                       
//#11359                                                                           
//#11360        rstMap(INSRT);                                                                   
//#11361        if(!chkMap(THUMSHO)){                                                                   
//#11362                                                                           
//#11363            rstMap(BZUM);                                                               
//#11364            rstMap(BZUMIN);                                                               
//#11365            setMap(VCAPT);                                                               
//#11366            SetCapture(hWnd);                                                               
//#11367            setMap(RESTCH);                                                               
//#11368        }                                                                   
//#11369    }                                                                       
//#11370                                                                           
//#11371    void clpcrnr(unsigned lin){                                                                       
//#11372                                                                           
//#11373        unsigned    tlin=nxt(lin);                                                               
//#11374        unsigned    ind;                                                               
//#11375        DUBPNT        dif,pnt;                                                           
//#11376        FLPNT        tpnt;                                                           
//#11377        double        len,rat;                                                           
//#11378        SHRTPNT        rpnt;                                                           
//#11379                                                                           
//#11380        rpnt.x=(clprct.right-clprct.left)/2+clprct.left;                                                                   
//#11381        rpnt.y=clprct.top;                                                                   
//#11382        if(chkMap(INDIR))                                                                   
//#11383        {                                                                   
//#11384            dif.x=opnts[tlin].x-flt[tlin].x;                                                               
//#11385            dif.y=opnts[tlin].y-flt[tlin].y;                                                               
//#11386        }                                                                   
//#11387        else                                                                   
//#11388        {                                                                   
//#11389            dif.x=ipnts[tlin].x-flt[tlin].x;                                                               
//#11390            dif.y=ipnts[tlin].y-flt[tlin].y;                                                               
//#11391        }                                                                   
//#11392        ang=atan2(dif.y,dif.x)+PI/2;                                                                   
//#11393        rotang1(rpnt,&clpref);                                                                   
//#11394        for(ind=0;ind<clplen;ind++)                                                                   
//#11395            rotang1(clpnu[ind],&filclp[ind]);                                                               
//#11396        len=hypot(dif.x,dif.y);                                                                   
//#11397        rat=getplen()/len;                                                                   
//#11398        dif.x*=rat;                                                                   
//#11399        dif.y*=rat;                                                                   
//#11400        pnt.x=flt[tlin].x+dif.x;                                                                   
//#11401        pnt.y=flt[tlin].y+dif.y;                                                                   
//#11402        oseq[seqpnt].x=flt[tlin].x;                                                                   
//#11403        oseq[seqpnt++].y=flt[tlin].y;                                                                   
//#11404        oseq[seqpnt].x=pnt.x;                                                                   
//#11405        oseq[seqpnt++].y=pnt.y;                                                                   
//#11406        oseq[seqpnt].x=flt[tlin].x;                                                                   
//#11407        oseq[seqpnt++].y=flt[tlin].y;                                                                   
//#11408        oseq[seqpnt].x=pnt.x;                                                                   
//#11409        oseq[seqpnt++].y=pnt.y;                                                                   
//#11410        tpnt.x=pnt.x;                                                                   
//#11411        tpnt.y=pnt.y;                                                                   
//#11412        if(!ritclp(tpnt)){                                                                   
//#11413                                                                           
//#11414            oseq[seqpnt].x=pnt.x;                                                               
//#11415            oseq[seqpnt++].y=pnt.y;                                                               
//#11416            oseq[seqpnt].x=flt[tlin].x;                                                               
//#11417            oseq[seqpnt++].y=flt[tlin].y;                                                               
//#11418        }                                                                   
//#11419    }                                                                       
//#11420                                                                           
//#11421    void picfn(unsigned strt,unsigned fin,double spac){                                                                       
//#11422                                                                           
//#11423        double        len,tdub;                                                           
//#11424        DUBPNT        dif,stp,ostp,pnti,pntf,pnto;                                                           
//#11425        FLPNT        tpnt;                                                           
//#11426        SHRTPNT        rpnt;                                                           
//#11427        unsigned    cnt,ind;                                                               
//#11428                                                                           
//#11429        dif.x=flt[fin].x-flt[strt].x;                                                                   
//#11430        dif.y=flt[fin].y-flt[strt].y;                                                                   
//#11431        ang=atan2(-dif.x,dif.y);                                                                   
//#11432        ostp.x=frmpnt->esiz*cos(ang);                                                                   
//#11433        ostp.y=frmpnt->esiz*sin(ang);                                                                   
//#11434        len=hypot(dif.x,dif.y);                                                                   
//#11435        spac+=clpsiz.cx;                                                                   
//#11436        cnt=len/spac;                                                                   
//#11437        rpnt.x=(clprct.right-clprct.left)/2+clprct.left;                                                                   
//#11438        rpnt.y=clprct.top;                                                                   
//#11439        ang=atan2(dif.y,dif.x);                                                                   
//#11440        rotang1(rpnt,&clpref);                                                                   
//#11441        pnti.x=flt[strt].x;                                                                   
//#11442        pnti.y=flt[strt].y;                                                                   
//#11443        if(cnt){                                                                   
//#11444                                                                           
//#11445            stp.x=0;                                                               
//#11446            stp.y=0;                                                               
//#11447            if(cnt>1){                                                               
//#11448                                                                           
//#11449                tdub=((len-cnt*spac)/(cnt-1)+spac)/len;                                                           
//#11450                stp.x=dif.x*tdub;                                                           
//#11451                stp.y=dif.y*tdub;                                                           
//#11452            }                                                               
//#11453            for(ind=0;ind<clplen;ind++)                                                               
//#11454                rotang1(clpnu[ind],&filclp[ind]);                                                           
//#11455            for(ind=0;ind<cnt-1;ind++){                                                               
//#11456                                                                           
//#11457                pntf.x=pnti.x+stp.x;                                                           
//#11458                pntf.y=pnti.y+stp.y;                                                           
//#11459                pnto.x=pntf.x+ostp.x;                                                           
//#11460                pnto.y=pntf.y+ostp.y;                                                           
//#11461                oseq[seqpnt].x=pntf.x;                                                           
//#11462                oseq[seqpnt++].y=pntf.y;                                                           
//#11463                oseq[seqpnt].x=pnti.x;                                                           
//#11464                oseq[seqpnt++].y=pnti.y;                                                           
//#11465                oseq[seqpnt].x=pntf.x;                                                           
//#11466                oseq[seqpnt++].y=pntf.y;                                                           
//#11467                oseq[seqpnt].x=pnto.x;                                                           
//#11468                oseq[seqpnt++].y=pnto.y;                                                           
//#11469                oseq[seqpnt].x=pntf.x;                                                           
//#11470                oseq[seqpnt++].y=pntf.y;                                                           
//#11471                oseq[seqpnt].x=pnto.x;                                                           
//#11472                oseq[seqpnt++].y=pnto.y;                                                           
//#11473                tpnt.x=pnto.x;                                                           
//#11474                tpnt.y=pnto.y;                                                           
//#11475                if(ritclp(tpnt))                                                           
//#11476                    goto picfnx;                                                       
//#11477                oseq[seqpnt].x=pnto.x;                                                           
//#11478                oseq[seqpnt++].y=pnto.y;                                                           
//#11479                oseq[seqpnt].x=pntf.x;                                                           
//#11480                oseq[seqpnt++].y=pntf.y;                                                           
//#11481                pnti.x+=stp.x;                                                           
//#11482                pnti.y+=stp.y;                                                           
//#11483            }                                                               
//#11484            oseq[seqpnt].x=flt[fin].x;                                                               
//#11485            oseq[seqpnt++].y=flt[fin].y;                                                               
//#11486            oseq[seqpnt].x=pnti.x;                                                               
//#11487            oseq[seqpnt++].y=pnti.y;                                                               
//#11488        }                                                                   
//#11489    picfnx:;                                                                       
//#11490    }                                                                       
//#11491                                                                           
//#11492    void clpic(unsigned short strtlin){                                                                       
//#11493                                                                           
//#11494        unsigned        ind;                                                           
//#11495        unsigned short    nlin;                                                               
//#11496                                                                           
//#11497        bac=0;                                                                   
//#11498        seqpnt=0;                                                                   
//#11499        rstMap(CLPBAK);                                                                   
//#11500        plen=clpsiz.cx/2;                                                                   
//#11501        plen2=clpsiz.cx;                                                                   
//#11502        filclp=new FLPNT[clplen];                                                                   
//#11503        rotcntr.x=(clprct.right-clprct.left)/2+clprct.left;                                                                   
//#11504        clpref.y=rotcntr.y=(clprct.top-clprct.bottom)/2+clprct.bottom;                                                                   
//#11505        clpref.x=clprct.left;                                                                   
//#11506        satout(20);                                                                   
//#11507        if(frmpnt->typ==LIN){                                                                   
//#11508                                                                           
//#11509            for(ind=0;ind<(unsigned)sids-2;ind++){                                                               
//#11510                                                                           
//#11511                picfn(ind,ind+1,frmpnt->espac);                                                           
//#11512                clpcrnr(ind);                                                           
//#11513            }                                                               
//#11514            picfn(ind,ind+1,frmpnt->espac);                                                               
//#11515        }                                                                   
//#11516        else{                                                                   
//#11517                                                                           
//#11518            if(!frmpnt->ftyp){                                                               
//#11519                                                                           
//#11520                oseq[seqpnt].x=flt[strtlin].x;                                                           
//#11521                oseq[seqpnt++].y=flt[strtlin].y;                                                           
//#11522            }                                                               
//#11523            for(ind=0;ind<sids;ind++){                                                               
//#11524                                                                           
//#11525                nlin=nxt(strtlin);                                                           
//#11526                picfn(strtlin,nlin,frmpnt->espac);                                                           
//#11527                clpcrnr(strtlin);                                                           
//#11528                strtlin=nlin;                                                           
//#11529            }                                                               
//#11530            oseq[seqpnt].x=flt[strtlin].x;                                                               
//#11531            oseq[seqpnt++].y=flt[strtlin].y;                                                               
//#11532        }                                                                   
//#11533        delete filclp;                                                                   
//#11534    }                                                                       
//#11535                                                                           
//#11536    void fspic(){                                                                       
//#11537                                                                           
//#11538        unsigned    ind;                                                               
//#11539                                                                           
//#11540        deleclp(clofind);                                                                   
//#11541        frmpnt->etyp=EGPIC;                                                                   
//#11542        frmpnt->nclp=clplen;                                                                   
//#11543        frmpnt->clp=nueclp(clofind,clplen);                                                                   
//#11544        frmpnt->esiz=clpsiz.cy;                                                                   
//#11545        frmpnt->espac=picspac;                                                                   
//#11546        frmpnt->bcol=actcol;                                                                   
//#11547        bsizpar();                                                                   
//#11548        savplen(bfclen);                                                                   
//#11549        for(ind=0;ind<clplen;ind++){                                                                   
//#11550                                                                           
//#11551            frmpnt->clp[ind].x=clpnu[ind].x;                                                               
//#11552            frmpnt->clp[ind].y=clpnu[ind].y;                                                               
//#11553        }                                                                   
//#11554        plen=clpsiz.cy/2;                                                                   
//#11555        refilfn();                                                                   
//#11556    }                                                                       
//#11557                                                                           
//#11558    void picot(){                                                                       
//#11559                                                                           
//#11560        unsigned ind;                                                                   
//#11561                                                                           
//#11562        if(filmsgs(FML_PIC))                                                                   
//#11563            return;                                                               
//#11564        if(OpenClipboard(hWnd)){                                                                   
//#11565                                                                           
//#11566            savdo();                                                               
//#11567            fvars(clofind);                                                               
//#11568            hClip=RegisterClipboardFormat(pcdClip);                                                               
//#11569            hClpMem=GetClipboardData(hClip);                                                               
//#11570            if(hClpMem){                                                               
//#11571                                                                           
//#11572                redclp();                                                           
//#11573                CloseClipboard();                                                           
//#11574                if(clpsiz.cx>CLPMIN){                                                           
//#11575                                                                           
//#11576                    if(fselpnt){                                                       
//#11577                                                                           
//#11578                        for(ind=0;ind<fselpnt;ind++){                                                   
//#11579                                                                           
//#11580                            clofind=selist[ind];                                               
//#11581                            fvars(clofind);                                               
//#11582                            fspic();                                               
//#11583                        }                                                   
//#11584                        setMap(INIT);                                                   
//#11585                        coltab();                                                   
//#11586                        setMap(RESTCH);                                                   
//#11587                    }                                                       
//#11588                    else{                                                       
//#11589                                                                           
//#11590                        if(chkMap(FORMSEL)){                                                   
//#11591                                                                           
//#11592                            fspic();                                               
//#11593                            setMap(INIT);                                               
//#11594                            coltab();                                               
//#11595                            setMap(RESTCH);                                               
//#11596                        }                                                   
//#11597                    }                                                       
//#11598                }                                                           
//#11599                else                                                           
//#11600                    tabmsg(IDS_CLP);                                                       
//#11601            }                                                               
//#11602            else                                                               
//#11603                CloseClipboard();                                                           
//#11604        }                                                                   
//#11605    }                                                                       
//#11606                                                                           
//#11607    void contf(){                                                                       
//#11608                                                                           
//#11609        unsigned    ind,loind,hind,selind,lolins,hilins,selins,strt,fin;                                                               
//#11610        double        lolen,hilen,len,lospac,hispac;                                                           
//#11611        unsigned    hicnt,locnt,cnt;                                                               
//#11612        unsigned*    locnts;                                                               
//#11613        unsigned*    hicnts;                                                               
//#11614        double*        lolens;                                                           
//#11615        double*        hilens;                                                           
//#11616        DUBPNT*        lodifs;                                                           
//#11617        DUBPNT*        hidifs;                                                           
//#11618        DUBPNT*        lostps;                                                           
//#11619        DUBPNT*        histps;                                                           
//#11620        FLPNT*        loflts;                                                           
//#11621        DUBPNT*        hiflts;                                                           
//#11622        DUBPNT        lostp,lopnt;                                                           
//#11623        DUBPNT        histp,hipnt;                                                           
//#11624        DUBPNT        dif;                                                           
//#11625        FLPNT*        sels;                                                           
//#11626        FLPNT*        his;                                                           
//#11627        PVEC*        pols;                                                           
//#11628        PVEC        polref,polin,poldif;                                                           
//#11629                                                                           
//#11630        seqpnt=0;                                                                   
//#11631        strt=frmpnt->angclp.sat.strt;                                                                   
//#11632        fin=frmpnt->angclp.sat.fin;                                                                   
//#11633        hilins=sids-strt-1;                                                                   
//#11634        lolins=strt;                                                                   
//#11635        selins=fin-strt;                                                                   
//#11636        sels=&flt[strt];                                                                   
//#11637        his=&flt[fin];                                                                   
//#11638        lolen=hilen=0;                                                                   
//#11639                                                                           
//#11640        locnts=(unsigned*)bseq;                                                                   
//#11641        hicnts=&locnts[lolins];                                                                   
//#11642                                                                           
//#11643        lolens=(double*)&hicnts[hilins];                                                                   
//#11644        hilens=&lolens[lolins];                                                                   
//#11645                                                                           
//#11646        lodifs=(DUBPNT*)&hilens[hilins];                                                                   
//#11647        hidifs=&lodifs[lolins];                                                                   
//#11648        lostps=&hidifs[hilins];                                                                   
//#11649        histps=&lostps[lolins];                                                                   
//#11650        hiflts=&histps[hilins];                                                                   
//#11651                                                                           
//#11652        pols=(PVEC*)&hiflts[hilins];                                                                   
//#11653        loflts=(FLPNT*)&pols[selins];                                                                   
//#11654                                                                           
//#11655        lolen=loind=0;                                                                   
//#11656        for(ind=lolins;ind;ind--){                                                                   
//#11657                                                                           
//#11658            loflts[loind].x=flt[ind].x;                                                               
//#11659            loflts[loind].y=flt[ind].y;                                                               
//#11660            lodifs[loind].x=flt[ind-1].x-flt[ind].x;                                                               
//#11661            lodifs[loind].y=flt[ind-1].y-flt[ind].y;                                                               
//#11662            lolens[loind]=hypot(lodifs[loind].x,lodifs[loind].y);                                                               
//#11663            lolen+=lolens[loind];                                                               
//#11664            loind++;                                                               
//#11665        }                                                                   
//#11666        selind=0;                                                                   
//#11667        for(ind=strt+1;ind<=fin;ind++){                                                                   
//#11668                                                                           
//#11669            dif.x=flt[ind].x-sels[0].x;                                                               
//#11670            dif.y=flt[ind].y-sels[0].y;                                                               
//#11671            pols[selind].len=hypot(dif.x,dif.y);                                                               
//#11672            pols[selind].ang=atan2(dif.y,dif.x);                                                               
//#11673            selind++;                                                               
//#11674        }                                                                   
//#11675        hind=0;hilen=0;                                                                   
//#11676        for(ind=fin;ind<(unsigned)sids-1;ind++){                                                                   
//#11677                                                                           
//#11678            hiflts[hind].x=flt[ind].x;                                                               
//#11679            hiflts[hind].y=flt[ind].y;                                                               
//#11680            hidifs[hind].x=flt[ind+1].x-flt[ind].x;                                                               
//#11681            hidifs[hind].y=flt[ind+1].y-flt[ind].y;                                                               
//#11682            hilens[hind]=hypot(hidifs[hind].x,hidifs[hind].y);                                                               
//#11683            hilen+=hilens[hind];                                                               
//#11684            hind++;                                                               
//#11685        }                                                                   
//#11686        if(hilen>lolen)                                                                   
//#11687            len=lolen;                                                               
//#11688        else                                                                   
//#11689            len=hilen;                                                               
//#11690        cnt=len/frmpnt->fspac;                                                                   
//#11691        if(hilen<lolen){                                                                   
//#11692                                                                           
//#11693            lospac=frmpnt->fspac;                                                               
//#11694            hispac=frmpnt->fspac*hilen/lolen;                                                               
//#11695        }                                                                   
//#11696        else{                                                                   
//#11697                                                                           
//#11698            hispac=frmpnt->fspac;                                                               
//#11699            lospac=frmpnt->fspac*lolen/hilen;                                                               
//#11700        }                                                                   
//#11701        for(ind=0;ind<lolins;ind++){                                                                   
//#11702                                                                           
//#11703            locnts[ind]=lolens[ind]/lospac;                                                               
//#11704            lostps[ind].x=lodifs[ind].x/locnts[ind];                                                               
//#11705            lostps[ind].y=lodifs[ind].y/locnts[ind];                                                               
//#11706        }                                                                   
//#11707        for(ind=0;ind<hilins;ind++){                                                                   
//#11708                                                                           
//#11709            hicnts[ind]=hilens[ind]/hispac;                                                               
//#11710            histps[ind].x=hidifs[ind].x/hicnts[ind];                                                               
//#11711            histps[ind].y=hidifs[ind].y/hicnts[ind];                                                               
//#11712        }                                                                   
//#11713        loind=hind=0;                                                                   
//#11714        rstMap(FILDIR);                                                                   
//#11715        locnt=hicnt=0;                                                                   
//#11716        dif.x=flt[fin].x-flt[strt].x;                                                                   
//#11717        dif.y=flt[fin].y-flt[strt].y;                                                                   
//#11718        polref.len=hypot(dif.x,dif.y);                                                                   
//#11719        polref.ang=atan2(dif.y,dif.x);                                                                   
//#11720        while(locnt||(loind<lolins&&hind<hilins)){                                                                   
//#11721                                                                           
//#11722            if(locnt)                                                               
//#11723                locnt--;                                                           
//#11724            else{                                                               
//#11725                                                                           
//#11726                if(loind<lolins){                                                           
//#11727                                                                           
//#11728                    locnt=locnts[loind];                                                       
//#11729                    lostp.x=lostps[loind].x;                                                       
//#11730                    lostp.y=lostps[loind].y;                                                       
//#11731                    lopnt.x=loflts[loind].x;                                                       
//#11732                    lopnt.y=loflts[loind].y;                                                       
//#11733                    loind++;                                                       
//#11734                }                                                           
//#11735            }                                                               
//#11736            if(hicnt)                                                               
//#11737                hicnt--;                                                           
//#11738            else{                                                               
//#11739                                                                           
//#11740                if(hind<hilins){                                                           
//#11741                                                                           
//#11742                    hicnt=hicnts[hind];                                                       
//#11743                    histp.x=histps[hind].x;                                                       
//#11744                    histp.y=histps[hind].y;                                                       
//#11745                    hipnt.x=hiflts[hind].x;                                                       
//#11746                    hipnt.y=hiflts[hind].y;                                                       
//#11747                    hind++;                                                       
//#11748                }                                                           
//#11749            }                                                               
//#11750            dif.x=hipnt.x-lopnt.x;                                                               
//#11751            dif.y=hipnt.y-lopnt.y;                                                               
//#11752            polin.ang=atan2(dif.y,dif.x);                                                               
//#11753            polin.len=hypot(dif.x,dif.y);                                                               
//#11754            poldif.ang=polin.ang-polref.ang;                                                               
//#11755            if(polref.len>0.9*stspace){                                                               
//#11756                                                                           
//#11757                poldif.len=polin.len/polref.len;                                                           
//#11758                if(toglMap(FILDIR)){                                                           
//#11759                                                                           
//#11760                    oseq[seqpnt].x=lopnt.x;                                                       
//#11761                    oseq[seqpnt].y=lopnt.y;                                                       
//#11762                    seqpnt++;                                                       
//#11763                    for(ind=0;ind<(selins-1);ind++){                                                       
//#11764                                                                           
//#11765                        ang=pols[ind].ang+poldif.ang;                                                   
//#11766                        len=pols[ind].len*poldif.len;                                                   
//#11767                        oseq[seqpnt].x=lopnt.x+cos(ang)*len;                                                   
//#11768                        oseq[seqpnt].y=lopnt.y+sin(ang)*len;                                                   
//#11769                        seqpnt++;                                                   
//#11770                    }                                                       
//#11771                }                                                           
//#11772                else{                                                           
//#11773                                                                           
//#11774                    oseq[seqpnt].x=hipnt.x;                                                       
//#11775                    oseq[seqpnt].y=hipnt.y;                                                       
//#11776                    seqpnt++;                                                       
//#11777                    for(ind=selins-2;ind<=selins;ind--){                                                       
//#11778                                                                           
//#11779                        ang=pols[ind].ang+poldif.ang;                                                   
//#11780                        len=pols[ind].len*poldif.len;                                                   
//#11781                        oseq[seqpnt].x=lopnt.x+cos(ang)*len;                                                   
//#11782                        oseq[seqpnt].y=lopnt.y+sin(ang)*len;                                                   
//#11783                        seqpnt++;                                                   
//#11784                    }                                                       
//#11785                }                                                           
//#11786            }                                                               
//#11787            lopnt.x+=lostp.x;                                                               
//#11788            lopnt.y+=lostp.y;                                                               
//#11789            hipnt.x+=histp.x;                                                               
//#11790            hipnt.y+=histp.y;                                                               
//#11791        }                                                                   
//#11792        if(chkMap(FILDIR)){                                                                   
//#11793                                                                           
//#11794            oseq[seqpnt].x=flt[0].x;                                                               
//#11795            oseq[seqpnt++].y=flt[0].y;                                                               
//#11796        }                                                                   
//#11797        else{                                                                   
//#11798                                                                           
//#11799            oseq[seqpnt].x=flt[sids-1].x;                                                               
//#11800            oseq[seqpnt++].y=flt[sids-1].y;                                                               
//#11801        }                                                                   
//#11802        if(frmpnt->flencnt.flen<minsiz)                                                                   
//#11803            frmpnt->flencnt.flen=minsiz;                                                               
//#11804    }                                                                       
//#11805                                                                           
//#11806    BOOL contsf(unsigned find)                                                                       
//#11807    {                                                                       
//#11808        clofind=find;                                                                   
//#11809        fvars(find);                                                                   
//#11810        if(frmpnt->sids>4)                                                                   
//#11811        {                                                                   
//#11812            delclps(clofind);                                                               
//#11813            deltx();                                                               
//#11814            chkcont();                                                               
//#11815            frmpnt->fspac=stspace;                                                               
//#11816            frmpnt->fcol=actcol;                                                               
//#11817            fsizpar();                                                               
//#11818            frmpnt->at|=(actl<<1);                                                               
//#11819            refilfn();                                                               
//#11820            return 1;                                                               
//#11821        }                                                                   
//#11822        return 0;                                                                   
//#11823    }                                                                       
//#11824                                                                           
//#11825    void contfil(){                                                                       
//#11826                                                                           
//#11827        unsigned ind;                                                                   
//#11828                                                                           
//#11829        if(filmsgs(FML_CONT))                                                                   
//#11830            return;                                                               
//#11831        if(fselpnt){                                                                   
//#11832                                                                           
//#11833            savdo();                                                               
//#11834            for(ind=0;ind<fselpnt;ind++)                                                               
//#11835                contsf(selist[ind]);                                                           
//#11836            setMap(INIT);                                                               
//#11837            coltab();                                                               
//#11838            setMap(RESTCH);                                                               
//#11839        }                                                                   
//#11840        else{                                                                   
//#11841                                                                           
//#11842            fvars(clofind);                                                               
//#11843            savdo();                                                               
//#11844            if(contsf(clofind))                                                               
//#11845            {                                                               
//#11846                setMap(INIT);                                                           
//#11847                coltab();                                                           
//#11848                setMap(RESTCH);                                                           
//#11849            }                                                               
//#11850            else                                                               
//#11851                tabmsg(IDS_CONT);                                                           
//#11852        }                                                                   
//#11853    }                                                                       
//#11854                                                                           
//#11855    BOOL cmpflt(FLPNT* flt0,FLPNT* flt1){                                                                       
//#11856                                                                           
//#11857        if(flt0->x!=flt1->x)                                                                   
//#11858            return 0;                                                               
//#11859        if(flt0->y==flt1->y)                                                                   
//#11860            return 1;                                                               
//#11861        else                                                                   
//#11862            return 0;                                                               
//#11863    }                                                                       
//#11864                                                                           
//#11865    void ribon(){                                                                       
//#11866                                                                           
//#11867        FRMHED*        tfrm;                                                           
//#11868        unsigned    ind,fpnt,clobak;                                                               
//#11869                                                                           
//#11870        frm1pnt();                                                                   
//#11871        if(chkMap(FORMSEL)){                                                                   
//#11872                                                                           
//#11873            fvars(clofind);                                                               
//#11874            if(sids>2){                                                               
//#11875                                                                           
//#11876                savdo();                                                           
//#11877                clobak=clofind;                                                           
//#11878                satout(brdwid);                                                           
//#11879                                                                           
//#11880                plen=brdwid/2;                                                           
//#11881                tfrm=&formlst[formpnt];                                                           
//#11882                frmclr(tfrm);                                                           
//#11883                fpnt=0;                                                           
//#11884                tfrm->fmax=9*PFGRAN;                                                           
//#11885                tfrm->fmin=minsiz;                                                           
//#11886                maxs=9*PFGRAN;                                                           
//#11887                if(frmpnt->typ==LIN){                                                           
//#11888                                                                           
//#11889                    if(chku(BLUNT))                                                       
//#11890                        ind=0xffffffff;                                                   
//#11891                    else                                                       
//#11892                        ind=0;                                                   
//#11893                    satends(ind);                                                       
//#11894                    tfrm->flt=adflt(sids<<1);                                                       
//#11895                    tfrm->flt[0].x=opnts[0].x;                                                       
//#11896                    tfrm->flt[fpnt++].y=opnts[0].y;                                                       
//#11897                    for(ind=0;ind<sids;ind++){                                                       
//#11898                                                                           
//#11899                        tfrm->flt[fpnt].x=ipnts[ind].x;                                                   
//#11900                        tfrm->flt[fpnt++].y=ipnts[ind].y;                                                   
//#11901                    }                                                       
//#11902                    for(ind=sids-1;ind;ind--){                                                       
//#11903                                                                           
//#11904                        tfrm->flt[fpnt].x=opnts[ind].x;                                                   
//#11905                        tfrm->flt[fpnt++].y=opnts[ind].y;                                                   
//#11906                    }                                                       
//#11907                }                                                           
//#11908                else{                                                           
//#11909                                                                           
//#11910                    tfrm->flt=adflt((sids<<1)+2);                                                       
//#11911                    tfrm->flt[0].x=opnts[0].x;                                                       
//#11912                    tfrm->flt[fpnt++].y=opnts[0].y;                                                       
//#11913                    tfrm->wind=ini.wind;                                                       
//#11914                    for(ind=0;ind<sids;ind++){                                                       
//#11915                                                                           
//#11916                        tfrm->flt[fpnt].x=ipnts[ind].x;                                                   
//#11917                        tfrm->flt[fpnt++].y=ipnts[ind].y;                                                   
//#11918                    }                                                       
//#11919                    tfrm->flt[fpnt].x=ipnts[0].x;                                                       
//#11920                    tfrm->flt[fpnt++].y=ipnts[0].y;                                                       
//#11921                    tfrm->flt[fpnt].x=opnts[0].x;                                                       
//#11922                    tfrm->flt[fpnt++].y=opnts[0].y;                                                       
//#11923                    for(ind=sids-1;ind;ind--){                                                       
//#11924                                                                           
//#11925                        tfrm->flt[fpnt].x=opnts[ind].x;                                                   
//#11926                        tfrm->flt[fpnt++].y=opnts[ind].y;                                                   
//#11927                    }                                                       
//#11928                }                                                           
//#11929                tfrm->typ=SAT;                                                           
//#11930                tfrm->fcol=actcol;                                                           
//#11931                tfrm->fspac=stspace;                                                           
//#11932                tfrm->flencnt.flen=ini.maxsiz;                                                           
//#11933                tfrm->sids=fpnt;                                                           
//#11934                tfrm->at=1;                                                           
//#11935                tfrm->wpar=fpnt>>1;                                                           
//#11936                tfrm->stpt=tfrm->wpar-2;                                                           
//#11937                tfrm->sacang.sac=adsatk(tfrm->stpt);                                                           
//#11938                if(chkMap(CNV2FTH)){                                                           
//#11939                                                                           
//#11940                    tfrm->ftyp=FTHF;                                                       
//#11941                    tfrm->dhx.fth.fthrat=ini.fthrat;                                                       
//#11942                    tfrm->dhx.fth.fthup=ini.fthup;                                                       
//#11943                    tfrm->dhx.fth.fthdwn=ini.fthdwn;                                                       
//#11944                    tfrm->dhx.fth.fthtyp=ini.fthtyp;                                                       
//#11945                    tfrm->dhx.fth.fthflr=ini.fthflr;                                                       
//#11946                    tfrm->xat=ini.fthbits;                                                       
//#11947                    tfrm->dhx.fth.fthnum=ini.fthnum;                                                       
//#11948                    tfrm->dhx.fth.fthcol=(actcol+1)&COLMSK;                                                       
//#11949                }                                                           
//#11950                else                                                           
//#11951                    tfrm->ftyp=SATF;                                                       
//#11952                for(ind=0;ind<tfrm->stpt;ind++){                                                           
//#11953                                                                           
//#11954                    tfrm->sacang.sac[ind].strt=ind+2;                                                       
//#11955                    tfrm->sacang.sac[ind].fin=tfrm->sids-ind-1;                                                       
//#11956                }                                                           
//#11957                formpnt++;                                                           
//#11958                frmout(formpnt-1);                                                           
//#11959                clofind=formpnt-1;                                                           
//#11960                refilfn();                                                           
//#11961                clofind=clobak;                                                           
//#11962                setMap(DELTO);                                                           
//#11963                frmdel();                                                           
//#11964                clofind=formpnt-1;                                                           
//#11965                setMap(FORMSEL);                                                           
//#11966                setMap(INIT);                                                           
//#11967                setMap(RESTCH);                                                           
//#11968            }                                                               
//#11969            else                                                               
//#11970                tabmsg(IDS_FRM2);                                                           
//#11971        }                                                                   
//#11972        else                                                                   
//#11973            shoseln(IDS_FRM1MSG,IDS_CONVRIB);                                                               
//#11974    }                                                                       
//#11975                                                                           
//#11976    void dupfn(){                                                                       
//#11977                                                                           
//#11978        savdo();                                                                   
//#11979        rotpar();                                                                   
//#11980        if(ini.rotang){                                                                   
//#11981                                                                           
//#11982            if(chkMap(FORMSEL))                                                               
//#11983                duprot();                                                           
//#11984            else{                                                               
//#11985                                                                           
//#11986                if(chkMap(GRPSEL))                                                           
//#11987                    duprots();                                                       
//#11988                else{                                                           
//#11989                                                                           
//#11990                    if(fselpnt)                                                       
//#11991                        duprotfs();                                                   
//#11992                    else                                                       
//#11993                        shord();                                                   
//#11994                }                                                           
//#11995            }                                                               
//#11996        }                                                                   
//#11997        else{                                                                   
//#11998                                                                           
//#11999            rotentr();                                                               
//#12000            setMap(ENTRDUP);                                                               
//#12001        }                                                                   
//#12002    }                                                                       
//#12003                                                                           
//#12004    void redup(){                                                                       
//#12005                                                                           
//#12006        ang=ini.rotang;                                                                   
//#12007        dupfn();                                                                   
//#12008    }                                                                       
//#12009                                                                           
//#12010    void bakdup(){                                                                       
//#12011                                                                           
//#12012        ang=2*PI-ini.rotang;                                                                   
//#12013        dupfn();                                                                   
//#12014    }                                                                       
//#12015                                                                           
//#12016    void shrnks(unsigned find){                                                                       
//#12017                                                                           
//#12018        unsigned    ind,ine,cnt;                                                               
//#12019        DUBPNT        dif;                                                           
//#12020        double        len,rat,dlen,adif;                                                           
//#12021                                                                           
//#12022        oclp(frmpnt->clp,frmpnt->nclp);                                                                   
//#12023        for(ind=0;ind<(unsigned)sids-1;ind++){                                                                   
//#12024                                                                           
//#12025            dif.x=flt[ind+1].x-flt[ind].x;                                                               
//#12026            dif.y=flt[ind+1].y-flt[ind].y;                                                               
//#12027            len=hypot(dif.x,dif.y);                                                               
//#12028            cnt=len/clpsiz.cx+0.5;                                                               
//#12029            rat=(clpsiz.cx*cnt+0.004)/len;                                                               
//#12030            flt[ind+1].x=flt[ind].x+dif.x*rat;                                                               
//#12031            flt[ind+1].y=flt[ind].y+dif.y*rat;                                                               
//#12032        }                                                                   
//#12033        dif.x=flt[0].x-flt[1].x;                                                                   
//#12034        dif.y=flt[0].y-flt[1].y;                                                                   
//#12035        len=hypot(dif.x,dif.y);                                                                   
//#12036        ang=atan2(dif.y,dif.x);                                                                   
//#12037        for(ine=0;ine<5;ine++){                                                                   
//#12038                                                                           
//#12039            dif.x=flt[0].x-flt[ind].x;                                                               
//#12040            dif.y=flt[0].y-flt[ind].y;                                                               
//#12041            dlen=hypot(dif.x,dif.y);                                                               
//#12042            cnt=dlen/clpsiz.cx;                                                               
//#12043            adif=dlen-cnt*clpsiz.cx;                                                               
//#12044            ang-=adif/len;                                                               
//#12045            dif.x=cos(ang)*len;                                                               
//#12046            dif.y=sin(ang)*len;                                                               
//#12047            flt[0].x=flt[1].x+dif.x;                                                               
//#12048            flt[0].y=flt[1].y+dif.y;                                                               
//#12049        }                                                                   
//#12050        refil();                                                                   
//#12051    }                                                                       
//#12052                                                                           
//#12053    void shrnk(){                                                                       
//#12054                                                                           
//#12055        fvars(clofind);                                                                   
//#12056        if(chkMap(FORMSEL)&&frmpnt->etyp==EGCLP){                                                                   
//#12057                                                                           
//#12058            shrnks(clofind);                                                               
//#12059            coltab();                                                               
//#12060            setMap(RESTCH);                                                               
//#12061        }                                                                   
//#12062        else                                                                   
//#12063            shoseln(IDS_FRMCLP,IDS_SHRNK);                                                               
//#12064    }                                                                       
//#12065                                                                           
//#12066    void mvfrms(FRMHED* dst,FRMHED* src,unsigned cnt){                                                                       
//#12067                                                                           
//#12068        _asm{                                                                   
//#12069                                                                           
//#12070                mov        esi,src                                                   
//#12071                mov        edi,dst                                                   
//#12072                mov        eax,cnt                                                   
//#12073                mov        ecx,fsizeof                                                   
//#12074                mul        ecx                                                   
//#12075                mov        ecx,eax                                                   
//#12076                rep        movsd                                                   
//#12077        }                                                                   
//#12078    }                                                                       
//#12079                                                                           
//#12080    void dufdat(unsigned find){                                                                       
//#12081                                                                           
//#12082        FRMHED*    dst;                                                               
//#12083        FRMHED* src;                                                                   
//#12084                                                                           
//#12085        dst=&rfrmlst[frepnt++];                                                                   
//#12086        src=&formlst[find];                                                                   
//#12087        mvfrms(dst,src,1);                                                                   
//#12088        mvflpnt(&rflts[fltad],dst->flt,dst->sids);                                                                   
//#12089        dst->flt=&flts[fltad];                                                                   
//#12090        fltad+=dst->sids;                                                                   
//#12091        if(dst->stpt){                                                                   
//#12092                                                                           
//#12093            mvsatk(&rsats[satkad],dst->sacang.sac,dst->stpt);                                                               
//#12094            dst->sacang.sac=&satks[satkad];                                                               
//#12095            satkad+=dst->stpt;                                                               
//#12096        }                                                                   
//#12097        if(iseclpx(find))                                                                   
//#12098        {                                                                   
//#12099            mvflpnt(&rclps[clpad],dst->clp,dst->nclp);                                                               
//#12100            dst->clp=&clps[clpad];                                                               
//#12101            clpad+=dst->nclp;                                                               
//#12102        }                                                                   
//#12103        if(isclpx(find))                                                                   
//#12104        {                                                                   
//#12105            mvflpnt(&rclps[clpad],dst->angclp.clp,dst->flencnt.nclp);                                                               
//#12106            dst->angclp.clp=&clps[clpad];                                                               
//#12107            clpad+=dst->flencnt.nclp;                                                               
//#12108        }                                                                   
//#12109    }                                                                       
//#12110                                                                           
//#12111    void stchfrm(unsigned fnum,unsigned* at){                                                                       
//#12112                                                                           
//#12113        _asm{                                                                   
//#12114                                                                           
//#12115                mov        eax,fnum                                                   
//#12116                shl        eax,FRMSHFT                                                   
//#12117                mov        ebx,at                                                   
//#12118                mov        ecx,[ebx]                                                   
//#12119                and        ecx,NFRMSK                                                   
//#12120                or        ecx,eax                                                   
//#12121                mov        [ebx],ecx                                                   
//#12122        }                                                                   
//#12123    }                                                                       
//#12124                                                                           
//#12125    void frmnumfn(unsigned nunum){                                                                       
//#12126                                                                           
//#12127        unsigned    ind,srcpnt,strt,fin,cod;                                                               
//#12128                                                                           
//#12129        if(nunum!=clofind){                                                                   
//#12130                                                                           
//#12131            if(clofind>nunum){                                                               
//#12132                                                                           
//#12133                strt=nunum;                                                           
//#12134                fin=clofind;                                                           
//#12135            }                                                               
//#12136            else{                                                               
//#12137                                                                           
//#12138                strt=clofind;                                                           
//#12139                fin=nunum;                                                           
//#12140            }                                                               
//#12141            srcpnt=frepnt=0;                                                               
//#12142            rfrmlst=(FRMHED*)&bseq;                                                               
//#12143            rflts=(FLPNT*)&rfrmlst[formpnt];                                                               
//#12144            rsats=(SATCON*)&oseq;                                                               
//#12145            rclps=(FLPNT*)&rsats[satkad];                                                               
//#12146            fltad=satkad=clpad=0;                                                               
//#12147            for(ind=0;ind<formpnt;ind++){                                                               
//#12148                                                                           
//#12149                if(ind==nunum)                                                           
//#12150                    dufdat(clofind);                                                       
//#12151                else{                                                           
//#12152                                                                           
//#12153                    if(srcpnt==clofind)                                                       
//#12154                        srcpnt++;                                                   
//#12155                    dufdat(srcpnt++);                                                       
//#12156                }                                                           
//#12157            }                                                               
//#12158            mvfrms(formlst,rfrmlst,formpnt);                                                               
//#12159            mvflpnt(flts,rflts,fltad);                                                               
//#12160            mvsatk(satks,rsats,satkad);                                                               
//#12161            mvflpnt(clps,rclps,clpad);                                                               
//#12162            for(ind=0;ind<hed.stchs;ind++){                                                               
//#12163                                                                           
//#12164                if(stchs[ind].at&TYPMSK){                                                           
//#12165                                                                           
//#12166                    cod=(stchs[ind].at&FRMSK)>>FRMSHFT;                                                       
//#12167                    if(cod==clofind)                                                       
//#12168                            stchfrm(nunum,&stchs[ind].at);                                               
//#12169                    else{                                                       
//#12170                                                                           
//#12171                        if(cod>=strt&&cod<=fin){                                                   
//#12172                                                                           
//#12173                            if(nunum<clofind)                                               
//#12174                                stchfrm(cod+1,&stchs[ind].at);                                           
//#12175                            else                                               
//#12176                                stchfrm(cod-1,&stchs[ind].at);                                           
//#12177                        }                                                   
//#12178                    }                                                       
//#12179                }                                                           
//#12180            }                                                               
//#12181            clofind=nunum;                                                               
//#12182            ritnum(STR_NUMFRM,clofind);                                                               
//#12183        }                                                                   
//#12184    }                                                                       
//#12185                                                                           
//#12186    void frmnum(){                                                                       
//#12187                                                                           
//#12188        TCHAR    buf[HBUFSIZ];                                                               
//#12189                                                                           
//#12190        if(formpnt&&chkMap(FORMSEL)){                                                                   
//#12191                                                                           
//#12192            LoadString(hInst,IDS_FRML,buf,HBUFSIZ);                                                               
//#12193            sprintf(msgbuf,buf,formpnt);                                                               
//#12194            shoMsg(msgbuf);                                                               
//#12195            setMap(NUMIN);                                                               
//#12196            setMap(ENTRFNUM);                                                               
//#12197            numWnd();                                                               
//#12198        }                                                                   
//#12199        else                                                                   
//#12200            shoseln(IDS_FRM1MSG,IDS_SETFRM);                                                               
//#12201    }                                                                       
//#12202                                                                           
//#12203    unsigned duat(unsigned at){                                                                       
//#12204                                                                           
//#12205        _asm{                                                                   
//#12206                                                                           
//#12207                mov        eax,at                                                   
//#12208                mov        ebx,eax                                                   
//#12209                shr        eax,TYPSHFT                                                   
//#12210                inc        eax                                                   
//#12211                and        al,3                                                   
//#12212                and        ebx,FRMSK                                                   
//#12213                shr        ebx,2                                                   
//#12214                or        eax,ebx                                                   
//#12215        }                                                                   
//#12216    }                                                                       
//#12217                                                                           
//#12218    void srtf(unsigned strt,unsigned fin){                                                                       
//#12219                                                                           
//#12220        unsigned*    frmhst;                                                               
//#12221        unsigned    ind,ine,tmp;                                                               
//#12222                                                                           
//#12223        if(strt!=fin){                                                                   
//#12224                                                                           
//#12225            frmhst=(unsigned*)&bseq;                                                               
//#12226            for(ind=0;ind<formpnt<<2;ind++)                                                               
//#12227                frmhst[ind]=0;                                                           
//#12228            for(ind=strt;ind<fin;ind++)                                                               
//#12229                frmhst[duat(hifstch[ind].at)]++;                                                           
//#12230            ine=strt;                                                               
//#12231            for(ind=0;ind<formpnt<<2;ind++){                                                               
//#12232                                                                           
//#12233                tmp=frmhst[ind];                                                           
//#12234                frmhst[ind]=ine;                                                           
//#12235                ine+=tmp;                                                           
//#12236            }                                                               
//#12237            for(ind=strt;ind<fin;ind++)                                                               
//#12238                mvstch(&stchs[frmhst[duat(hifstch[ind].at)]++],&hifstch[ind]);                                                           
//#12239        }                                                                   
//#12240    }                                                                       
//#12241                                                                           
//#12242    void srtbyfrm(){                                                                       
//#12243                                                                           
//#12244        unsigned    ind,ine,tmp;                                                               
//#12245        unsigned    colhst[16];                                                               
//#12246        unsigned    colr[16];                                                               
//#12247                                                                           
//#12248        if(formpnt){                                                                   
//#12249                                                                           
//#12250            savdo();                                                               
//#12251            colr[apcol]=0;                                                               
//#12252            for(ind=0;ind<16;ind++){                                                               
//#12253                                                                           
//#12254                if(ind!=apcol)                                                           
//#12255                    colr[ind]=ind+1;                                                       
//#12256            }                                                               
//#12257            hifstch=&stchs[MAXSEQ];                                                               
//#12258            for(ind=0;ind<16;ind++)                                                               
//#12259                colhst[ind]=0;                                                           
//#12260            for(ind=0;ind<hed.stchs;ind++)                                                               
//#12261                colhst[colr[stchs[ind].at&0xf]]++;                                                           
//#12262            ine=0;                                                               
//#12263            for(ind=0;ind<16;ind++){                                                               
//#12264                                                                           
//#12265                tmp=colhst[ind];                                                           
//#12266                colhst[ind]=ine;                                                           
//#12267                ine+=tmp;                                                           
//#12268            }                                                               
//#12269            for(ind=0;ind<hed.stchs;ind++)                                                               
//#12270                mvstch(&hifstch[colhst[colr[stchs[ind].at&0xf]]++],&stchs[ind]);                                                           
//#12271            srtf(0,colhst[0]);                                                               
//#12272            for(ind=0;ind<15;ind++)                                                               
//#12273                srtf(colhst[ind],colhst[ind+1]);                                                           
//#12274        }                                                                   
//#12275        else                                                                   
//#12276            srtcol();                                                               
//#12277        coltab();                                                                   
//#12278        setMap(RESTCH);                                                                   
//#12279    }                                                                       
//#12280                                                                           
//#12281    void dufcntr(DUBPNT* cntr){                                                                       
//#12282                                                                           
//#12283        unsigned    ind;                                                               
//#12284        FLRCT*        trct;                                                           
//#12285        FLRCT        brct;                                                           
//#12286                                                                           
//#12287        trct=&formlst[selist[0]].rct;                                                                   
//#12288        brct.left=trct->left;                                                                   
//#12289        brct.right=trct->right;                                                                   
//#12290        brct.top=trct->top;                                                                   
//#12291        brct.bottom=trct->bottom;                                                                   
//#12292        for(ind=1;ind<fselpnt;ind++){                                                                   
//#12293                                                                           
//#12294            trct=&formlst[selist[ind]].rct;                                                               
//#12295            if(trct->left<brct.left)                                                               
//#12296            brct.left=trct->left;                                                               
//#12297            if(trct->right>brct.right)                                                               
//#12298            brct.right=trct->right;                                                               
//#12299            if(trct->bottom<brct.bottom)                                                               
//#12300            brct.bottom=trct->bottom;                                                               
//#12301            if(trct->top>brct.top)                                                               
//#12302            brct.top=trct->top;                                                               
//#12303        }                                                                   
//#12304        cntr->x=(brct.right-brct.left)/2+brct.left;                                                                   
//#12305        cntr->y=(brct.top-brct.bottom)/2+brct.bottom;                                                                   
//#12306    }                                                                       
//#12307                                                                           
//#12308    void cntrx(){                                                                       
//#12309                                                                           
//#12310        DUBPNT        mrkcntr;                                                           
//#12311        DUBPNT        selcntr;                                                           
//#12312        unsigned    ind,flg;                                                               
//#12313        FLRCT*        trct;                                                           
//#12314        FLRCT        grct;                                                           
//#12315                                                                           
//#12316        if(chkMap(GMRK)){                                                                   
//#12317                                                                           
//#12318            mrkcntr.x=mrkpnt.x;                                                               
//#12319            mrkcntr.y=mrkpnt.y;                                                               
//#12320        }                                                                   
//#12321        else{                                                                   
//#12322                                                                           
//#12323            mrkcntr.x=zum0.x/2;                                                               
//#12324            mrkcntr.y=zum0.y/2;                                                               
//#12325        }                                                                   
//#12326        flg=0;                                                                   
//#12327        if(fselpnt){                                                                   
//#12328                                                                           
//#12329            flg=1;                                                               
//#12330            savdo();                                                               
//#12331            dufcntr(&selcntr);                                                               
//#12332            fmovdif.x=mrkcntr.x-selcntr.x;                                                               
//#12333            fmovdif.y=-mrkcntr.y+selcntr.y;                                                               
//#12334            if(chkMap(CNTRV))                                                               
//#12335                fmovdif.y=0;                                                           
//#12336            if(chkMap(CNTRH))                                                               
//#12337                fmovdif.x=0;                                                           
//#12338            for(ind=0;ind<fselpnt;ind++)                                                               
//#12339                frmadj(selist[ind]);                                                           
//#12340            frmsadj();                                                               
//#12341        }                                                                   
//#12342        else{                                                                   
//#12343                                                                           
//#12344            if(chkMap(FORMSEL)){                                                               
//#12345                                                                           
//#12346                flg=1;                                                           
//#12347                savdo();                                                           
//#12348                trct=&formlst[clofind].rct;                                                           
//#12349                selcntr.x=(trct->right-trct->left)/2+trct->left;                                                           
//#12350                selcntr.y=(trct->top-trct->bottom)/2+trct->bottom;                                                           
//#12351                fmovdif.x=mrkcntr.x-selcntr.x;                                                           
//#12352                fmovdif.y=-mrkcntr.y+selcntr.y;                                                           
//#12353                if(chkMap(CNTRV))                                                           
//#12354                    fmovdif.y=0;                                                       
//#12355                if(chkMap(CNTRH))                                                           
//#12356                    fmovdif.x=0;                                                       
//#12357                frmadj(clofind);                                                           
//#12358                for(ind=0;ind<hed.stchs;ind++){                                                           
//#12359                                                                           
//#12360                    if(stchs[ind].at&ALTYPMSK&&(stchs[ind].at&FRMSK)>>FRMSHFT==clofind){                                                       
//#12361                                                                           
//#12362                        stchs[ind].x+=fmovdif.x;                                                   
//#12363                        stchs[ind].y-=fmovdif.y;                                                   
//#12364                    }                                                       
//#12365                }                                                           
//#12366            }                                                               
//#12367            else{                                                               
//#12368                                                                           
//#12369                if(chkMap(GRPSEL)){                                                           
//#12370                                                                           
//#12371                    flg=1;                                                       
//#12372                    savdo();                                                       
//#12373                    rngadj();                                                       
//#12374                    grct.right=grct.left=stchs[gpnt0].x;                                                       
//#12375                    grct.top=grct.bottom=stchs[gpnt0].y;                                                       
//#12376                    for(ind=gpnt0+1;ind<=gpnt1;ind++){                                                       
//#12377                                                                           
//#12378                        if(stchs[ind].x<grct.left)                                                   
//#12379                            grct.left=stchs[ind].x;                                               
//#12380                        if(stchs[ind].x>grct.right)                                                   
//#12381                            grct.right=stchs[ind].x;                                               
//#12382                        if(stchs[ind].y<grct.bottom)                                                   
//#12383                            grct.bottom=stchs[ind].y;                                               
//#12384                        if(stchs[ind].y>grct.top)                                                   
//#12385                            grct.top=stchs[ind].y;                                               
//#12386                    }                                                       
//#12387                    selcntr.x=(grct.right-grct.left)/2+grct.left;                                                       
//#12388                    selcntr.y=(grct.top-grct.bottom)/2+grct.bottom;                                                       
//#12389                    fmovdif.x=mrkcntr.x-selcntr.x;                                                       
//#12390                    fmovdif.y=-mrkcntr.y+selcntr.y;                                                       
//#12391                    if(chkMap(CNTRV))                                                       
//#12392                        fmovdif.y=0;                                                   
//#12393                    if(chkMap(CNTRH))                                                       
//#12394                        fmovdif.x=0;                                                   
//#12395                    for(ind=gpnt0;ind<=gpnt1;ind++){                                                       
//#12396                                                                           
//#12397                        stchs[ind].x+=fmovdif.x;                                                   
//#12398                        stchs[ind].y-=fmovdif.y;                                                   
//#12399                    }                                                       
//#12400                }                                                           
//#12401                else                                                           
//#12402                    shoseln(IDS_FGRPF,IDS_CENT);                                                       
//#12403            }                                                               
//#12404        }                                                                   
//#12405        if(flg)                                                                   
//#12406            setMap(RESTCH);                                                               
//#12407    }                                                                       
//#12408                                                                           
//#12409    void centir(){                                                                       
//#12410                                                                           
//#12411        DUBPNT        scntr;                                                           
//#12412        DUBPNT        dcntr;                                                           
//#12413        DUBPNT        dif;                                                           
//#12414        unsigned    ind;                                                               
//#12415                                                                           
//#12416        rstMap(BIGBOX);                                                                   
//#12417        getbig();                                                                   
//#12418        dcntr.x=(rctal.right-rctal.left)/2+rctal.left;                                                                   
//#12419        dcntr.y=(rctal.top-rctal.bottom)/2+rctal.bottom;                                                                   
//#12420        scntr.x=zum0.x/2;                                                                   
//#12421        scntr.y=zum0.y/2;                                                                   
//#12422        dif.x=scntr.x-dcntr.x;                                                                   
//#12423        dif.y=scntr.y-dcntr.y;                                                                   
//#12424        for(ind=0;ind<hed.stchs;ind++){                                                                   
//#12425                                                                           
//#12426            stchs[ind].x+=dif.x;                                                               
//#12427            stchs[ind].y+=dif.y;                                                               
//#12428        }                                                                   
//#12429        for(ind=0;ind<fltad;ind++){                                                                   
//#12430                                                                           
//#12431            flts[ind].x+=dif.x;                                                               
//#12432            flts[ind].y+=dif.y;                                                               
//#12433        }                                                                   
//#12434        for(ind=0;ind<formpnt;ind++)                                                                   
//#12435            frmout(ind);                                                               
//#12436        setfchk();                                                                   
//#12437        setMap(RESTCH);                                                                   
//#12438    }                                                                       
//#12439                                                                           
//#12440    void bean(unsigned strt,unsigned fin){                                                                       
//#12441                                                                           
//#12442        unsigned ind,ine,inf;                                                                   
//#12443                                                                           
//#12444        ine=MAXSEQ;                                                                   
//#12445        ind=strt;                                                                   
//#12446        beancnt=0;                                                                   
//#12447        mvstch(ine++,ind);                                                                   
//#12448        if(stchs[ind+2].x!=stchs[ind].x||stchs[ind+2].y!=stchs[ind].y){                                                                   
//#12449                                                                           
//#12450                mvstch(ine++,ind+1);                                                           
//#12451                mvstch(ine++,ind);                                                           
//#12452                beancnt+=2;                                                           
//#12453        }                                                                   
//#12454        ind++;                                                                   
//#12455        mvstch(ine++,ind);                                                                   
//#12456        if(stchs[ind+2].x!=stchs[ind].x||stchs[ind+2].y!=stchs[ind].y){                                                                   
//#12457                                                                           
//#12458                mvstch(ine++,ind+1);                                                           
//#12459                mvstch(ine++,ind);                                                           
//#12460                beancnt+=2;                                                           
//#12461        }                                                                   
//#12462        ind++;                                                                   
//#12463        while(ind<(unsigned)fin-2){                                                                   
//#12464                                                                           
//#12465            mvstch(ine++,ind);                                                               
//#12466            if(    (stchs[ind+2].x!=stchs[ind].x||stchs[ind+2].y!=stchs[ind].y)&&                                                           
//#12467                (stchs[ind-2].x!=stchs[ind].x||stchs[ind-2].y!=stchs[ind].y)){                                                           
//#12468                                                                           
//#12469                mvstch(ine++,ind+1);                                                           
//#12470                mvstch(ine++,ind);                                                           
//#12471                beancnt+=2;                                                           
//#12472            }                                                               
//#12473            ind++;                                                               
//#12474        }                                                                   
//#12475        mvstch(ine++,ind);                                                                   
//#12476        if((stchs[ind-2].x!=stchs[ind].x||stchs[ind-2].y!=stchs[ind].y)){                                                                   
//#12477                                                                           
//#12478            mvstch(ine++,ind+1);                                                               
//#12479            mvstch(ine++,ind);                                                               
//#12480            beancnt+=2;                                                               
//#12481        }                                                                   
//#12482        ind++;                                                                   
//#12483        while(ind<hed.stchs)                                                                   
//#12484            mvstch(ine++,ind++);                                                               
//#12485        inf=strt;                                                                   
//#12486        for(ind=MAXSEQ;ind<ine;ind++)                                                                   
//#12487            mvstch(inf++,ind);                                                               
//#12488        hed.stchs=inf;                                                                   
//#12489    }                                                                       
//#12490                                                                           
//#12491    void dubean(){                                                                       
//#12492                                                                           
//#12493        if(hed.stchs){                                                                   
//#12494                                                                           
//#12495            savdo();                                                               
//#12496            if(chkMap(GRPSEL)){                                                               
//#12497                                                                           
//#12498                rngadj();                                                           
//#12499                bean(gpnt0,gpnt1);                                                           
//#12500                if(cloInd>grpInd)                                                           
//#12501                    cloInd+=beancnt;                                                       
//#12502                else                                                           
//#12503                    grpInd+=beancnt;                                                       
//#12504                grpAdj();                                                           
//#12505            }                                                               
//#12506            else                                                               
//#12507                bean(0,hed.stchs-1);                                                           
//#12508            coltab();                                                               
//#12509            setMap(RESTCH);                                                               
//#12510        }                                                                   
//#12511    }                                                                       
//#12512                                                                           
//#12513    void unbean(unsigned strt,unsigned fin){                                                                       
//#12514                                                                           
//#12515        unsigned ind,ine;                                                                   
//#12516                                                                           
//#12517        ine=MAXSEQ;                                                                   
//#12518        beancnt=0;                                                                   
//#12519        for(ind=strt;ind<=fin;ind++){                                                                   
//#12520                                                                           
//#12521            mvstch(ine++,ind);                                                               
//#12522            if(stchs[ind].x==stchs[ind+2].x&&stchs[ind].y==stchs[ind+2].y){                                                               
//#12523                                                                           
//#12524                ind+=2;                                                           
//#12525                beancnt+=2;                                                           
//#12526            }                                                               
//#12527        }                                                                   
//#12528        if(beancnt)                                                                   
//#12529            beancnt-=2;;                                                               
//#12530        if(ind>(unsigned)hed.stchs-1)                                                                   
//#12531            ind=hed.stchs-1;                                                               
//#12532        while(ind<hed.stchs)                                                                   
//#12533            mvstch(ine++,ind++);                                                               
//#12534        mvstchs(strt,MAXSEQ,ine);                                                                   
//#12535        hed.stchs=strt+ine;                                                                   
//#12536    }                                                                       
//#12537                                                                           
//#12538    void debean(){                                                                       
//#12539                                                                           
//#12540        savdo();                                                                   
//#12541        if(chkMap(GRPSEL)){                                                                   
//#12542                                                                           
//#12543            rngadj();                                                               
//#12544            unbean(gpnt0,gpnt1);                                                               
//#12545            if(cloInd>grpInd)                                                               
//#12546                cloInd-=beancnt;                                                           
//#12547            else                                                               
//#12548                grpInd-=beancnt;                                                           
//#12549            if(cloInd>(unsigned)hed.stchs-1)                                                               
//#12550                cloInd=hed.stchs-1;                                                           
//#12551            if(grpInd>(unsigned)hed.stchs-1)                                                               
//#12552                grpInd=hed.stchs-1;                                                           
//#12553            grpAdj();                                                               
//#12554        }                                                                   
//#12555        else                                                                   
//#12556            unbean(0,hed.stchs-1);                                                               
//#12557        coltab();                                                                   
//#12558        setMap(RESTCH);                                                                   
//#12559    }                                                                       
//#12560                                                                           
//#12561    void mvfrmsb(FRMHED* dst,FRMHED* src,unsigned cnt){                                                                       
//#12562                                                                           
//#12563        _asm{                                                                   
//#12564                                                                           
//#12565                std                                                           
//#12566                mov        eax,fsizeof                                                   
//#12567                mul        cnt                                                   
//#12568                mov        ecx,eax                                                   
//#12569                mov        edi,dst                                                   
//#12570                add        edi,64                                                   
//#12571                mov        esi,src                                                   
//#12572                add        esi,64                                                   
//#12573                rep        movsd                                                   
//#12574                cld                                                           
//#12575        }                                                                   
//#12576    }                                                                       
//#12577                                                                           
//#12578    void mvfltsb(FLPNT* dst,FLPNT* src,unsigned cnt){                                                                       
//#12579                                                                           
//#12580        _asm{                                                                   
//#12581                                                                           
//#12582                std                                                           
//#12583                mov        ecx,cnt                                                   
//#12584                shl        ecx,1                                                   
//#12585                mov        esi,src                                                   
//#12586                add        esi,4                                                   
//#12587                mov        edi,dst                                                   
//#12588                add        edi,4                                                   
//#12589                rep        movsd                                                   
//#12590                cld                                                           
//#12591        }                                                                   
//#12592    }                                                                       
//#12593                                                                           
//#12594    void clpspac(FLPNT* pins,unsigned cnt){                                                                       
//#12595                                                                           
//#12596        mvfltsb(&clps[clpad+cnt-1],&clps[clpad-1],clpad-clpind(pins));                                                                   
//#12597    }                                                                       
//#12598                                                                           
//#12599    void stchadj(){                                                                       
//#12600                                                                           
//#12601        unsigned ind,lo,hi;                                                                   
//#12602                                                                           
//#12603        for(ind=0;ind<hed.stchs;ind++){                                                                   
//#12604                                                                           
//#12605            hi=stchs[ind].at&FRMSK;                                                               
//#12606            lo=hi>>FRMSHFT;                                                               
//#12607            if(lo>clofind){                                                               
//#12608                                                                           
//#12609                stchs[ind].at&=NFRMSK;                                                           
//#12610                hi+=1<<FRMSHFT;                                                           
//#12611                stchs[ind].at|=hi;                                                           
//#12612            }                                                               
//#12613        }                                                                   
//#12614        refilfn();                                                                   
//#12615        lo=clofind<<FRMSHFT;                                                                   
//#12616        for(ind=hed.stchs-1;ind<hed.stchs;ind--){                                                                   
//#12617                                                                           
//#12618            hi=stchs[ind].at&FRMSK;                                                               
//#12619            if((stchs[ind].at&FRMSK)==lo){                                                               
//#12620                                                                           
//#12621                delpnt=ind+1;                                                           
//#12622                break;                                                           
//#12623            }                                                               
//#12624        }                                                                   
//#12625        clofind++;                                                                   
//#12626        refilfn();                                                                   
//#12627        rstMap(FRMPSEL);                                                                   
//#12628    }                                                                       
//#12629                                                                           
//#12630    void spltsat(SATCON tsac){                                                                       
//#12631                                                                           
//#12632        FLPNT*        hiflt;                                                           
//#12633        unsigned    ind,lo,hi,hibak;                                                               
//#12634                                                                           
//#12635        hiflt=(FLPNT*)&oseq;                                                                   
//#12636        mvfrmsb(&formlst[formpnt],&formlst[formpnt-1],formpnt-clofind);                                                                   
//#12637        formpnt++;                                                                   
//#12638        if(clofind<(unsigned)formpnt-2)                                                                   
//#12639            mvfltsb(&flts[fltad+1],&flts[fltad-1],fltad-fltind(formlst[clofind+2].flt));                                                               
//#12640        fltad+=2;                                                                   
//#12641        for(ind=clofind+2;ind<formpnt;ind++)                                                                   
//#12642            formlst[ind].flt+=2;                                                               
//#12643        lo=0;                                                                   
//#12644        hibak=tsac.strt+(sids-tsac.fin)+1;                                                                   
//#12645        hi=hibak+1;                                                                   
//#12646        for(ind=0;ind<sids;ind++){                                                                   
//#12647                                                                           
//#12648            if(ind==tsac.strt||ind==tsac.fin){                                                               
//#12649                                                                           
//#12650                hiflt[lo].x=flt[ind].x;                                                           
//#12651                hiflt[lo++].y=flt[ind].y;                                                           
//#12652                if(ind==tsac.strt){                                                           
//#12653                                                                           
//#12654                    hiflt[hi].x=flt[ind].x;                                                       
//#12655                    hiflt[hi++].y=flt[ind].y;                                                       
//#12656                }                                                           
//#12657                else{                                                           
//#12658                                                                           
//#12659                    hiflt[hibak].x=flt[ind].x;                                                       
//#12660                    hiflt[hibak].y=flt[ind].y;                                                       
//#12661                }                                                           
//#12662            }                                                               
//#12663            else{                                                               
//#12664                                                                           
//#12665                if(ind<tsac.strt){                                                           
//#12666                                                                           
//#12667                    hiflt[lo].x=flt[ind].x;                                                       
//#12668                    hiflt[lo++].y=flt[ind].y;                                                       
//#12669                }                                                           
//#12670                else{                                                           
//#12671                                                                           
//#12672                    if(ind<tsac.fin){                                                       
//#12673                                                                           
//#12674                        hiflt[hi].x=flt[ind].x;                                                   
//#12675                        hiflt[hi++].y=flt[ind].y;                                                   
//#12676                    }                                                       
//#12677                    else{                                                       
//#12678                                                                           
//#12679                        hiflt[lo].x=flt[ind].x;                                                   
//#12680                        hiflt[lo++].y=flt[ind].y;                                                   
//#12681                    }                                                       
//#12682                }                                                           
//#12683            }                                                               
//#12684        }                                                                   
//#12685        for(ind=0;ind<hi;ind++){                                                                   
//#12686                                                                           
//#12687            flt[ind].x=hiflt[ind].x;                                                               
//#12688            flt[ind].y=hiflt[ind].y;                                                               
//#12689        }                                                                   
//#12690        frmpnt->sids=lo;                                                                   
//#12691        formlst[clofind+1].sids=hi-lo;                                                                   
//#12692        formlst[clofind+1].flt=&flt[lo];                                                                   
//#12693        frmout(clofind);                                                                   
//#12694        frmout(clofind+1);                                                                   
//#12695        lo=tsac.strt+1-tsac.fin;                                                                   
//#12696        for(ind=0;ind<xpnt;ind++)                                                                   
//#12697            frmpnt->sacang.sac[ind].fin+=lo;                                                               
//#12698        if(frmpnt->wpar)                                                                   
//#12699            frmpnt->wpar=tsac.strt;                                                               
//#12700        lo=ind+1;                                                                   
//#12701        while(ind<(unsigned)frmpnt->stpt){                                                                   
//#12702                                                                           
//#12703            frmpnt->sacang.sac[ind].strt-=(tsac.strt-1);                                                               
//#12704            frmpnt->sacang.sac[ind].fin-=(tsac.strt-1);                                                               
//#12705            ind++;                                                               
//#12706        }                                                                   
//#12707        if(formlst[clofind+1].wpar)                                                                   
//#12708            formlst[clofind+1].wpar-=(tsac.strt-1);                                                               
//#12709        mvsatk(&frmpnt->sacang.sac[lo-1],&frmpnt->sacang.sac[lo],satkad-sacind(&frmpnt->sacang.sac[lo]));                                                                   
//#12710        satkad--;                                                                   
//#12711        formlst[clofind+1].sacang.sac=&frmpnt->sacang.sac[xpnt];                                                                   
//#12712        formlst[clofind+1].stpt=frmpnt->stpt-xpnt-1;                                                                   
//#12713        frmpnt->stpt=xpnt;                                                                   
//#12714        for(ind=clofind+2;ind<formpnt;ind++)                                                                   
//#12715            formlst[ind].sacang.sac--;                                                               
//#12716        if(iseclp(clofind)){                                                                   
//#12717                                                                           
//#12718            clpspac(frmpnt->clp,frmpnt->nclp);                                                               
//#12719            for(ind=clofind+1;ind<formpnt;ind++)                                                               
//#12720                formlst[ind].clp+=frmpnt->nclp;                                                           
//#12721        }                                                                   
//#12722        stchadj();                                                                   
//#12723    }                                                                       
//#12724                                                                           
//#12725    BOOL spltlin(){                                                                       
//#12726                                                                           
//#12727        unsigned ind;                                                                   
//#12728                                                                           
//#12729        if(clofine<2||frmpnt->sids-clofine<2)                                                                   
//#12730            return 0;                                                               
//#12731        mvfrmsb(&formlst[formpnt],&formlst[formpnt-1],formpnt-clofind);                                                                   
//#12732        formpnt++;                                                                   
//#12733        frmpnt->sids=clofine;                                                                   
//#12734        formlst[clofind+1].sids-=clofine;                                                                   
//#12735        formlst[clofind+1].flt=&frmpnt->flt[clofine];                                                                   
//#12736        frmout(clofind);                                                                   
//#12737        frmout(clofind+1);                                                                   
//#12738        if(iseclp(clofind)){                                                                   
//#12739                                                                           
//#12740            clpspac(frmpnt->clp,frmpnt->nclp);                                                               
//#12741            for(ind=clofind+1;ind<formpnt;ind++)                                                               
//#12742                formlst[ind].clp+=frmpnt->nclp;                                                           
//#12743        }                                                                   
//#12744        stchadj();                                                                   
//#12745        return 1;                                                                   
//#12746    }                                                                       
//#12747                                                                           
//#12748    void spltfrm(){                                                                       
//#12749                                                                           
//#12750        if(chkMap(FRMPSEL)){                                                                   
//#12751                                                                           
//#12752            savdo();                                                               
//#12753            fvars(clofind);                                                               
//#12754            if(frmpnt->typ==SAT){                                                               
//#12755                                                                           
//#12756                if(frmpnt->stpt){                                                           
//#12757                                                                           
//#12758                    delfstchs();                                                       
//#12759                    frmpnt->ftyp=0;                                                       
//#12760                    frmpnt->etyp=0;                                                       
//#12761                    for(xpnt=0;xpnt<frmpnt->stpt;xpnt++){                                                       
//#12762                                                                           
//#12763                        if(frmpnt->sacang.sac[xpnt].strt==clofine||frmpnt->sacang.sac[xpnt].fin==clofine){                                                   
//#12764                                                                           
//#12765                            spltsat(frmpnt->sacang.sac[xpnt]);                                               
//#12766                            return;                                               
//#12767                        }                                                   
//#12768                    }                                                       
//#12769                    spltmsg();                                                       
//#12770                }                                                           
//#12771                else                                                           
//#12772                    spltmsg();                                                       
//#12773            }                                                               
//#12774            else{                                                               
//#12775                                                                           
//#12776                if(frmpnt->typ=LIN){                                                           
//#12777                                                                           
//#12778                    if(spltlin()){                                                       
//#12779                                                                           
//#12780                        coltab();                                                   
//#12781                        setMap(RESTCH);                                                   
//#12782                    }                                                       
//#12783                    else                                                       
//#12784                        tabmsg(IDS_FRM3);                                                   
//#12785                    return;                                                       
//#12786                }                                                           
//#12787                else                                                           
//#12788                    spltmsg();                                                       
//#12789            }                                                               
//#12790        }                                                                   
//#12791        spltmsg();                                                                   
//#12792    }                                                                       
//#12793                                                                           
//#12794    void stchs2frm(){                                                                       
//#12795                                                                           
//#12796        unsigned ind,ine,len;                                                                   
//#12797                                                                           
//#12798        if(chkMap(GRPSEL)){                                                                   
//#12799                                                                           
//#12800            rngadj();                                                               
//#12801            if((gpnt1-gpnt0)>12000){                                                               
//#12802                                                                           
//#12803                tabmsg(IDS_STMAX);                                                           
//#12804                return;                                                           
//#12805            }                                                               
//#12806            len=gpnt1-gpnt0+1;                                                               
//#12807            frmpnt=&formlst[formpnt];                                                               
//#12808            frmclr(frmpnt);                                                               
//#12809            frmpnt->typ=LIN;                                                               
//#12810            frmpnt->sids=len;                                                               
//#12811            frmpnt->flt=adflt(len);                                                               
//#12812            ine=0;                                                               
//#12813            for(ind=gpnt0;ind<=gpnt1;ind++){                                                               
//#12814                                                                           
//#12815                frmpnt->flt[ine].x=stchs[ind].x;                                                           
//#12816                frmpnt->flt[ine++].y=stchs[ind].y;                                                           
//#12817            }                                                               
//#12818            frmout(formpnt);                                                               
//#12819            formpnt++;                                                               
//#12820            if(cloInd>grpInd){                                                               
//#12821                                                                           
//#12822                if(cloInd<(unsigned)hed.stchs-1)                                                           
//#12823                    cloInd++;                                                       
//#12824            }                                                               
//#12825            else{                                                               
//#12826                                                                           
//#12827                if(grpInd<(unsigned)hed.stchs-1)                                                           
//#12828                    grpInd++;                                                       
//#12829            }                                                               
//#12830            delstchm();                                                               
//#12831            rstMap(GRPSEL);                                                               
//#12832            coltab();                                                               
//#12833            setMap(RESTCH);                                                               
//#12834        }                                                                   
//#12835        else                                                                   
//#12836            shoseln(IDS_GRPMSG,IDS_STCH2FRM);                                                               
//#12837    }                                                                       
//#12838                                                                           
//#12839    int lencmp(const void *arg1,const void *arg2){                                                                       
//#12840                                                                           
//#12841        _asm{                                                                   
//#12842                mov        ebx,arg1                                                   
//#12843                mov        ebx,[ebx]                                                   
//#12844                fld        dword ptr[ebx]                                                   
//#12845                mov        ebx,arg2                                                   
//#12846                mov        ebx,[ebx]                                                   
//#12847                fld        dword ptr[ebx]                                                   
//#12848                fcompp                                                           
//#12849                fstsw    ax                                                       
//#12850                mov        ebx,eax                                                   
//#12851                xor        eax,eax                                                   
//#12852                test    bh,6                                                       
//#12853                jne        short lcmpx                                                   
//#12854                test    bh,1                                                       
//#12855                je        short lcmp2                                                   
//#12856                inc        eax                                                   
//#12857                jmp        short lcmpx                                                   
//#12858    lcmp2:        dec        eax                                                       
//#12859    lcmpx:                                                                       
//#12860        }                                                                   
//#12861    }                                                                       
//#12862                                                                           
//#12863    void chksid(unsigned find){                                                                       
//#12864                                                                           
//#12865        unsigned ind,lim;                                                                   
//#12866                                                                           
//#12867        if(vclpsid!=find){                                                                   
//#12868                                                                           
//#12869            if((find-vclpsid+sids)%sids<(unsigned)(sids>>1)){                                                               
//#12870                                                                           
//#12871                ind=nxt(vclpsid);                                                           
//#12872                lim=nxt(find);                                                           
//#12873                while(ind!=lim){                                                           
//#12874                                                                           
//#12875                    oseq[seqpnt].x=flt[ind].x;                                                       
//#12876                    oseq[seqpnt++].y=flt[ind].y;                                                       
//#12877                    ind=nxt(ind);                                                       
//#12878                }                                                           
//#12879            }                                                               
//#12880            else{                                                               
//#12881                                                                           
//#12882                ind=vclpsid;                                                           
//#12883                while(ind!=find){                                                           
//#12884                                                                           
//#12885                    oseq[seqpnt].x=flt[ind].x;                                                       
//#12886                    oseq[seqpnt++].y=flt[ind].y;                                                       
//#12887                    ind=prv(ind);                                                       
//#12888                }                                                           
//#12889            }                                                               
//#12890        }                                                                   
//#12891    }                                                                       
//#12892                                                                           
//#12893    void ritseg(){                                                                       
//#12894                                                                           
//#12895        unsigned    ind;                                                               
//#12896        BOOL        pntd;                                                           
//#12897                                                                           
//#12898        pntd=1;                                                                   
//#12899        if(frmpnt->xat&AT_SQR)                                                                   
//#12900            pntd=0;                                                               
//#12901        if(chkMap(FILDIR)){                                                                   
//#12902                                                                           
//#12903            ind=clpsegs[xpnt].strt;                                                               
//#12904            if(chkMap(TXFIL)&&pntd)                                                               
//#12905                ind++;                                                           
//#12906            chksid(clpsegs[xpnt].asid);                                                               
//#12907            while(ind<=clpsegs[xpnt].fin){                                                               
//#12908                                                                           
//#12909                oseq[seqpnt].x=clipnts[ind].x;                                                           
//#12910                oseq[seqpnt++].y=clipnts[ind++].y;                                                           
//#12911            }                                                               
//#12912            vclpsid=clpsegs[xpnt].zsid;                                                               
//#12913        }                                                                   
//#12914        else{                                                                   
//#12915                                                                           
//#12916            ind=clpsegs[xpnt].fin;                                                               
//#12917            if(chkMap(TXFIL)&&pntd)                                                               
//#12918                ind--;                                                           
//#12919            chksid(clpsegs[xpnt].zsid);                                                               
//#12920            if(clpsegs[xpnt].strt){                                                               
//#12921                                                                           
//#12922                while(ind>=clpsegs[xpnt].strt){                                                           
//#12923                                                                           
//#12924                    oseq[seqpnt].x=clipnts[ind].x;                                                       
//#12925                    oseq[seqpnt++].y=clipnts[ind--].y;                                                       
//#12926                }                                                           
//#12927            }                                                               
//#12928            else{                                                               
//#12929                                                                           
//#12930                while(ind<clpsegs[xpnt].strt){                                                           
//#12931                                                                           
//#12932                    oseq[seqpnt].x=clipnts[ind].x;                                                       
//#12933                    oseq[seqpnt++].y=clipnts[ind--].y;                                                       
//#12934                }                                                           
//#12935            }                                                               
//#12936            vclpsid=clpsegs[xpnt].asid;                                                               
//#12937        }                                                                   
//#12938        clpsegs[xpnt].dun=1;                                                                   
//#12939    }                                                                       
//#12940                                                                           
//#12941    unsigned lenref(float* pflt){                                                                       
//#12942                                                                           
//#12943        _asm{                                                                   
//#12944                                                                           
//#12945                mov        eax,pflt                                                   
//#12946                sub        eax,clpsegs                                                   
//#12947                xor        ecx,ecx                                                   
//#12948                mov        ecx,29                                                   
//#12949                xor        edx,edx                                                   
//#12950                div        ecx                                                   
//#12951                shl        eax,1                                                   
//#12952                cmp        dl,18                                                   
//#12953                jne        short lrefx                                                   
//#12954                inc        eax                                                   
//#12955    lrefx:                                                                       
//#12956        }                                                                   
//#12957    }                                                                       
//#12958                                                                           
//#12959    BOOL clpnxt(unsigned sind){                                                                       
//#12960                                                                           
//#12961        unsigned ind;                                                                   
//#12962                                                                           
//#12963        ind=1;                                                                   
//#12964        rstMap(FILDIR);                                                                   
//#12965        while(ind<pcseg){                                                                   
//#12966                                                                           
//#12967            if(toglMap(FILDIR)){                                                               
//#12968                                                                           
//#12969                opnt=(sind+ind)%pcseg2;                                                           
//#12970                if(!clpsegs[lenref(plens[opnt])>>1].dun)                                                           
//#12971                    return 0;                                                       
//#12972                ind++;                                                           
//#12973            }                                                               
//#12974            else{                                                               
//#12975                                                                           
//#12976                opnt=(sind+pcseg2-ind)%pcseg2;                                                           
//#12977                if(!clpsegs[lenref(plens[opnt])>>1].dun)                                                           
//#12978                    return 0;                                                       
//#12979            }                                                               
//#12980        }                                                                   
//#12981        return 1;                                                                   
//#12982    }                                                                       
//#12983                                                                           
//#12984    BOOL nucseg(){                                                                       
//#12985                                                                           
//#12986        unsigned    ind;                                                               
//#12987                                                                           
//#12988        if(chkMap(FILDIR))                                                                   
//#12989            ind=clpsegs[xpnt].eind;                                                               
//#12990        else                                                                   
//#12991            ind=clpsegs[xpnt].bind;                                                               
//#12992        if(clpnxt(ind))                                                                   
//#12993            return 0;                                                               
//#12994        ind=lenref(plens[opnt]);                                                                   
//#12995        if(ind&1)                                                                   
//#12996            rstMap(FILDIR);                                                               
//#12997        else                                                                   
//#12998            setMap(FILDIR);                                                               
//#12999        xpnt=ind>>1;                                                                   
//#13000        return 1;                                                                   
//#13001    }                                                                       
//#13002                                                                           
//#13003    void mvpclp(unsigned dst,unsigned src){                                                                       
//#13004                                                                           
//#13005        _asm{                                                                   
//#13006                mov        edi,dst                                                   
//#13007                shl        edi,2                                                   
//#13008                add        edi,pclpsrt                                                   
//#13009                mov        edi,[edi]                                                   
//#13010                mov        esi,src                                                   
//#13011                shl        esi,2                                                   
//#13012                add        esi,pclpsrt                                                   
//#13013                mov        esi,[esi]                                                   
//#13014                xor        ecx,ecx                                                   
//#13015                mov        cl,5                                                   
//#13016                rep        movsd                                                   
//#13017        }                                                                   
//#13018    }                                                                       
//#13019                                                                           
//#13020    float getlen(unsigned ind){                                                                       
//#13021                                                                           
//#13022        clipnts[ind].sid%=sids;                                                                   
//#13023        return    lens[clipnts[ind].sid]+                                                               
//#13024                hypot(flt[clipnts[ind].sid].x-clipnts[ind].x,                                                           
//#13025                flt[clipnts[ind].sid].y-clipnts[ind].y);                                                           
//#13026    }                                                                       
//#13027                                                                           
//#13028    unsigned leftsid(){                                                                       
//#13029                                                                           
//#13030        unsigned    ind,sid;                                                               
//#13031        float        minx;                                                           
//#13032                                                                           
//#13033        minx=1e9;                                                                   
//#13034        sid=0;                                                                   
//#13035        for(ind=0;ind<sids;ind++){                                                                   
//#13036                                                                           
//#13037            if(flt[ind].x<minx){                                                               
//#13038                                                                           
//#13039                minx=flt[ind].x;                                                           
//#13040                sid=ind;                                                           
//#13041            }                                                               
//#13042        }                                                                   
//#13043        return sid;                                                                   
//#13044    }                                                                       
//#13045                                                                           
//#13046    int clpcmp(const void* arg1,const void* arg2){                                                                       
//#13047                                                                           
//#13048        _asm{                                                                   
//#13049                                                                           
//#13050                xor        eax,eax                                                   
//#13051                mov        ebx,arg1                                                   
//#13052                mov        esi,arg2                                                   
//#13053                mov        ecx,[ebx]                                                   
//#13054                mov        edx,[esi]                                                   
//#13055                cmp        ecx,edx                                                   
//#13056                jne        short clpcmp1                                                   
//#13057                add        ebx,4                                                   
//#13058                add        esi,4                                                   
//#13059                mov        ecx,[ebx]                                                   
//#13060                mov        edx,[esi]                                                   
//#13061                cmp        ecx,edx                                                   
//#13062                je        short clpcmpx                                                   
//#13063    clpcmp1:    jc        short clpcmp2                                                           
//#13064                inc        eax                                                   
//#13065                jmp        short clpcmpx                                                   
//#13066    clpcmp2:    dec        eax                                                           
//#13067    clpcmpx:                                                                       
//#13068        }                                                                   
//#13069    }                                                                       
//#13070                                                                           
//#13071    BOOL isect(unsigned find0,unsigned find1,FLPNT* ipnt,float* len){                                                                       
//#13072                                                                           
//#13073        DUBPNT        dif;                                                           
//#13074        DUBPNT        tpnt;                                                           
//#13075        DUBPNT        tipnt;                                                           
//#13076        unsigned    flg;                                                               
//#13077        float        lft;                                                           
//#13078        float        rit;                                                           
//#13079                                                                           
//#13080        dif.x=vpnt1.x-vpnt0.x;                                                                   
//#13081        dif.y=vpnt1.y-vpnt0.y;                                                                   
//#13082        tpnt.x=vpnt0.x;                                                                   
//#13083        tpnt.y=vpnt0.y;                                                                   
//#13084        flg=0;                                                                   
//#13085        if(dif.x&&dif.y)                                                                   
//#13086            flg=proj(tpnt,dif.y/dif.x,flt[find0],flt[find1],&tipnt);                                                               
//#13087        else{                                                                   
//#13088                                                                           
//#13089            if(dif.y)                                                               
//#13090                flg=projv(tpnt.x,flt[find0],flt[find1],&tipnt);                                                           
//#13091            else{                                                               
//#13092                                                                           
//#13093                if(dif.x)                                                           
//#13094                    flg=projh(tpnt.y,flt[find0],flt[find1],&tipnt);                                                       
//#13095                else                                                           
//#13096                    if(flt[find0].y==vpnt0.y&&flt[find1].y==vpnt0.y)                                                       
//#13097                    {                                                       
//#13098                        if(flt[find0].x<flt[find1].x)                                                   
//#13099                        {                                                   
//#13100                            lft=flt[find0].x;                                               
//#13101                            rit=flt[find1].x;                                               
//#13102                        }                                                   
//#13103                        else                                                   
//#13104                        {                                                   
//#13105                            lft=flt[find1].x;                                               
//#13106                            rit=flt[find0].x;                                               
//#13107                        }                                                   
//#13108                        if(vpnt0.x>lft&&vpnt0.x<rit)                                                   
//#13109                        {                                                   
//#13110                            ipnt->x=vpnt0.x;                                               
//#13111                            ipnt->y=vpnt0.y;                                               
//#13112                            *len=0;                                               
//#13113                            return 1;                                               
//#13114                        }                                                   
//#13115                        return 0;                                                   
//#13116                    }                                                       
//#13117                    else                                                       
//#13118                        return 0;                                                   
//#13119            }                                                               
//#13120        }                                                                   
//#13121        if(tipnt.x<TINY)                                                                   
//#13122            tipnt.x=0;                                                               
//#13123        if(tipnt.y<TINY)                                                                   
//#13124            tipnt.y=0;                                                               
//#13125        ipnt->x=(float)tipnt.x;                                                                   
//#13126        ipnt->y=(float)tipnt.y;                                                                   
//#13127        *len=hypot(tipnt.x-vpnt0.x,tipnt.y-vpnt0.y);                                                                   
//#13128             hypot(tipnt.x-vpnt1.x,tipnt.y-vpnt1.y);                                                               
//#13129        return flg;                                                                   
//#13130    }                                                                       
//#13131                                                                           
//#13132    unsigned insect(){                                                                       
//#13133                                                                           
//#13134        unsigned    ind,ine,cnt;                                                               
//#13135        unsigned    svrt,nvrt;                                                               
//#13136        FLRCT        lrct;                                                           
//#13137        FLPNT*        ipnt;                                                           
//#13138                                                                           
//#13139        if(vpnt1.x>vpnt0.x){                                                                   
//#13140                                                                           
//#13141            lrct.left=vpnt0.x;                                                               
//#13142            lrct.right=vpnt1.x;                                                               
//#13143        }                                                                   
//#13144        else{                                                                   
//#13145                                                                           
//#13146            lrct.left=vpnt1.x;                                                               
//#13147            lrct.right=vpnt0.x;                                                               
//#13148        }                                                                   
//#13149        if(vpnt1.y>vpnt0.y){                                                                   
//#13150                                                                           
//#13151            lrct.top=vpnt1.y;                                                               
//#13152            lrct.bottom=vpnt0.y;                                                               
//#13153        }                                                                   
//#13154        else{                                                                   
//#13155                                                                           
//#13156            lrct.top=vpnt0.y;                                                               
//#13157            lrct.bottom=vpnt1.y;                                                               
//#13158        }                                                                   
//#13159        ine=cnt=0;                                                                   
//#13160        for(ind=vstrt;ind<vfin;ind++){                                                                   
//#13161                                                                           
//#13162            svrt=vclpx[ind].sid;                                                               
//#13163            nvrt=nxt(svrt);                                                               
//#13164            if(isect(svrt,nvrt,&clpsrt[ine].pnt,&clpsrt[ine].sidlen)){                                                               
//#13165                                                                           
//#13166                ipnt=&clpsrt[ine].pnt;                                                           
//#13167                if(    ipnt->x>=lrct.left&&                                                       
//#13168                    ipnt->x<=lrct.right&&                                                       
//#13169                    ipnt->y>=lrct.bottom&&                                                       
//#13170                    ipnt->y<=lrct.top){                                                       
//#13171                                                                           
//#13172                    clpsrt[ine].seglen=hypot(clpsrt[ine].pnt.x-vpnt0.x,clpsrt[ine].pnt.y-vpnt0.y);                                                       
//#13173                    clpsrt[ine].lin=svrt;                                                       
//#13174                    pclpsrt[ine]=&clpsrt[ine];                                                       
//#13175                    ine++;                                                       
//#13176                    cnt++;                                                       
//#13177                }                                                           
//#13178            }                                                               
//#13179        }                                                                   
//#13180        if(cnt>1){                                                                   
//#13181                                                                           
//#13182            qsort((void*)pclpsrt,cnt,4,lencmp);                                                               
//#13183            ine=1;                                                               
//#13184            for(ind=0;ind<cnt-1;ind++){                                                               
//#13185                                                                           
//#13186                if(fabs(pclpsrt[ind]->seglen-pclpsrt[ind+1]->seglen)>TINY)                                                           
//#13187                    mvpclp(ine++,ind+1);                                                       
//#13188            }                                                               
//#13189            cnt=ine;                                                               
//#13190        }                                                                   
//#13191        return cnt;                                                                   
//#13192    }                                                                       
//#13193                                                                           
//#13194    BOOL isin(float pntx,float pnty){                                                                       
//#13195                                                                           
//#13196        unsigned    ind,acnt;                                                               
//#13197        unsigned    svrt,nvrt;                                                               
//#13198        DUBPNT        ipnt;                                                           
//#13199                                                                           
//#13200        if(pntx<isrct.left)                                                                   
//#13201            return 0;                                                               
//#13202        if(pntx>isrct.right)                                                                   
//#13203            return 0;                                                               
//#13204        if(pnty<isrct.bottom)                                                                   
//#13205            return 0;                                                               
//#13206        if(pnty>isrct.top)                                                                   
//#13207            return 0;                                                               
//#13208        acnt=0;                                                                   
//#13209        for(ind=vstrt;ind<vfin;ind++)                                                                   
//#13210        {                                                                   
//#13211            svrt=vclpx[ind].sid;                                                               
//#13212            nvrt=nxt(svrt);                                                               
//#13213            if(projv(pntx,flt[svrt],flt[nvrt],&ipnt))                                                               
//#13214            {                                                               
//#13215                if(ipnt.y>pnty)                                                           
//#13216                {                                                           
//#13217                    if(flt[svrt].x!=pntx&&flt[nvrt].x!=pntx)                                                       
//#13218                        acnt++;                                                   
//#13219                    else                                                       
//#13220                    {                                                       
//#13221                        if(flt[svrt].x<flt[nvrt].x)                                                   
//#13222                        {                                                   
//#13223                            if(flt[nvrt].x!=pntx)                                               
//#13224                                acnt++;                                           
//#13225                        }                                                   
//#13226                        else                                                   
//#13227                        {                                                   
//#13228                            if(flt[svrt].x!=pntx)                                               
//#13229                                acnt++;                                           
//#13230                        }                                                   
//#13231                    }                                                       
//#13232                }                                                           
//#13233            }                                                               
//#13234        }                                                                   
//#13235        return acnt&1;                                                                   
//#13236    }                                                                       
//#13237                                                                           
//#13238    unsigned clpnseg(unsigned strt,unsigned fin){                                                                       
//#13239                                                                           
//#13240        clpsegs[pcseg].strt=strt;                                                                   
//#13241        clpsegs[pcseg].blen=getlen(strt);                                                                   
//#13242        clpsegs[pcseg].asid=clipnts[strt].sid;                                                                   
//#13243        clpsegs[pcseg].elen=getlen(fin);                                                                   
//#13244        clpsegs[pcseg].zsid=clipnts[fin].sid;                                                                   
//#13245        clpsegs[pcseg].fin=fin;                                                                   
//#13246        clpsegs[pcseg++].dun=0;                                                                   
//#13247        return fin+1;                                                                   
//#13248    }                                                                       
//#13249                                                                           
//#13250    unsigned vclpfor(unsigned ind){                                                                       
//#13251                                                                           
//#13252        while(!clipnts[ind].flg&&ind<xpnt)                                                                   
//#13253            ind++;                                                               
//#13254        return ind;                                                                   
//#13255    }                                                                       
//#13256                                                                           
//#13257    unsigned vclpbak(unsigned ind){                                                                       
//#13258                                                                           
//#13259        while(!clipnts[ind].flg&&ind)                                                                   
//#13260            ind--;                                                               
//#13261        return ind;                                                                   
//#13262    }                                                                       
//#13263                                                                           
//#13264    BOOL vscmp(unsigned ind,unsigned ine){                                                                       
//#13265                                                                           
//#13266        _asm{                                                                   
//#13267                                                                           
//#13268                xor        eax,eax                                                   
//#13269                mov        esi,ind                                                   
//#13270                mov        edi,ine                                                   
//#13271                shl        esi,3                                                   
//#13272                shl        edi,3                                                   
//#13273                mov        ecx,offset oseq                                                   
//#13274                add        esi,ecx                                                   
//#13275                add        edi,ecx                                                   
//#13276                mov        ecx,[esi]                                                   
//#13277                cmp        ecx,[edi]                                                   
//#13278                je        short vscmp1                                                   
//#13279                inc        eax                                                   
//#13280                jmp        short vscmpx                                                   
//#13281    vscmp1:        add        esi,4                                                       
//#13282                add        edi,4                                                   
//#13283                mov        ecx,[esi]                                                   
//#13284                cmp        ecx,[edi]                                                   
//#13285                je        short vscmpx                                                   
//#13286                inc        eax                                                   
//#13287    vscmpx:                                                                       
//#13288        }                                                                   
//#13289    }                                                                       
//#13290                                                                           
//#13291    void duflt(){                                                                       
//#13292                                                                           
//#13293        unsigned    ind;                                                               
//#13294        float        lft;                                                           
//#13295                                                                           
//#13296        lft=1e9;                                                                   
//#13297        for(ind=0;ind<sids;ind++){                                                                   
//#13298                                                                           
//#13299            if(flt[ind].x<lft)                                                               
//#13300                lft=flt[ind].x;                                                           
//#13301        }                                                                   
//#13302        if(lft<clpsiz.cx){                                                                   
//#13303                                                                           
//#13304            setMap(WASNEG);                                                               
//#13305            fltof=clpsiz.cx+fabs(lft)+.05;                                                               
//#13306            for(ind=0;ind<sids;ind++)                                                               
//#13307                flt[ind].x+=fltof;                                                           
//#13308            frmpnt->rct.left+=fltof;                                                               
//#13309            frmpnt->rct.right+=fltof;                                                               
//#13310        }                                                                   
//#13311        else                                                                   
//#13312            rstMap(WASNEG);                                                               
//#13313    }                                                                       
//#13314                                                                           
//#13315    void inspnt()                                                                       
//#13316    {                                                                       
//#13317        clipnts[xpnt+1].x=clipnts[xpnt].x;                                                                   
//#13318        clipnts[xpnt+1].y=clipnts[xpnt].y;                                                                   
//#13319        clipnts[xpnt].x=midl(clipnts[xpnt+1].x,clipnts[xpnt-1].x);                                                                   
//#13320        clipnts[xpnt].y=midl(clipnts[xpnt+1].y,clipnts[xpnt-1].y);                                                                   
//#13321        clipnts[xpnt].flg=1;                                                                   
//#13322        xpnt++;                                                                   
//#13323    }                                                                       
//#13324                                                                           
//#13325    void clpcon(){
//#13326                                                                           
//#13327        RECT        nrct;                                                           
//#13328        unsigned    ind,ine,inf,ing,nof,clpneg;                                                               
//#13329        unsigned    strt,fin,segxs,segps,seg,clrnum;                                                               
//#13330        unsigned    cnt;                                                               
//#13331        int            tine;                                                       
//#13332        FLPNT        ploc;                                                           
//#13333        double        tlen,minx;                                                           
//#13334        float        fnof;                                                           
//#13335        unsigned    clpnof;                                                               
//#13336        double        clpvof;                                                           
//#13337        TXPNT*        ptx;                                                           
//#13338                                                                           
//#13339        duflt();                                                                   
//#13340        clpwid=clpsiz.cx+frmpnt->fspac;                                                                   
//#13341        if(chkMap(ISUND))                                                                   
//#13342            clpwid=frmpnt->uspac;                                                               
//#13343        if(frmpnt->fspac<0)                                                                   
//#13344            clpneg=1;                                                               
//#13345        else                                                                   
//#13346            clpneg=0;                                                               
//#13347        if(clpwid<CLPMINAUT)                                                                   
//#13348            clpwid=(float)CLPMINAUT;                                                               
//#13349        if(chkMap(TXFIL))                                                                   
//#13350        {                                                                   
//#13351            if(txad&&frmpnt->dhx.txt.ind+frmpnt->dhx.txt.cnt<=txad)                                                               
//#13352                clpwid=frmpnt->fspac;                                                           
//#13353            else                                                               
//#13354                return;                                                           
//#13355        }                                                                   
//#13356        lens=new double[sids+1];                                                                   
//#13357        clplens=new double[sids];                                                                   
//#13358        clpsrt=new CLIPSORT[sids];                                                                   
//#13359        pclpsrt=new CLIPSORT*[sids];                                                                   
//#13360        ine=leftsid();                                                                   
//#13361        tlen=0;                                                                   
//#13362        lens[ine]=0;                                                                   
//#13363        ine=nxt(ine);                                                                   
//#13364        for(ind=0;ind<=sids;ind++){                                                                   
//#13365                                                                           
//#13366            inf=nxt(ine);                                                               
//#13367            lens[ine]=tlen;                                                               
//#13368            clplens[ine]=hypot(flt[inf].x-flt[ine].x,flt[inf].y-flt[ine].y);                                                               
//#13369            tlen+=clplens[ine];                                                               
//#13370            ine=inf;                                                               
//#13371        }                                                                   
//#13372        clpcirc=tlen;                                                                   
//#13373        clpcirc2=tlen/2;                                                                   
//#13374        clpseq=(FLPNT*)&stchs[MAXSEQ];                                                                   
//#13375    //    clpsegs=(CLPSEG*)&bseq;                                                                   
//#13376        clpsegs=(CLPSEG*)&stchs[MAXSEQ];                                                                   
//#13377        nrct.left=floor(frmpnt->rct.left/clpwid);                                                                   
//#13378        nrct.right=ceil(frmpnt->rct.right/clpwid);                                                                   
//#13379        nrct.bottom=floor(frmpnt->rct.bottom/clpsiz.cy-1);                                                                   
//#13380        nrct.top=ceil(frmpnt->rct.top/clpsiz.cy+1)+2;                                                                   
//#13381        nof=0;                                                                   
//#13382        if(frmpnt->wpar>1)                                                                   
//#13383            clpnof=frmpnt->wpar;                                                               
//#13384        else                                                                   
//#13385            clpnof=0;                                                               
//#13386        if(clpnof){                                                                   
//#13387                                                                           
//#13388            nrct.top++;                                                               
//#13389            if(frmpnt->fspac<0){                                                               
//#13390                                                                           
//#13391                nrct.bottom--;                                                           
//#13392                nrct.left-=(float)clpsiz.cx/clpwid;                                                           
//#13393                nrct.right+=(float)clpsiz.cx/clpwid;                                                           
//#13394            }                                                               
//#13395        }                                                                   
//#13396        if(clpneg&&!clpnof)                                                                   
//#13397            nrct.left-=(float)clpsiz.cx/clpwid;                                                               
//#13398        if(nrct.bottom<0){                                                                   
//#13399                                                                           
//#13400            nof=1-nrct.bottom;                                                               
//#13401            nrct.bottom+=nof;                                                               
//#13402            nrct.top+=nof;                                                               
//#13403            fnof=clpsiz.cy*nof;                                                               
//#13404            for(ind=0;ind<sids;ind++)                                                               
//#13405                flt[ind].y+=fnof;                                                           
//#13406        }                                                                   
//#13407    /*                                                                       
//#13408        ing=0;                                                                   
//#13409        for(ind=nrct.left;ind<=(unsigned)nrct.right;ind++){                                                                   
//#13410                                                                           
//#13411            ploc.x=ind*clpwid;                                                               
//#13412            for(ine=nrct.bottom;ine<=(unsigned)nrct.top;ine++){                                                               
//#13413                                                                           
//#13414                ploc.y=ine*clpsiz.cy;                                                           
//#13415                for(inf=0;inf<clplen;inf++){                                                           
//#13416                                                                           
//#13417                    stchs[ing].x=ploc.x+clpnu[inf].x;                                                       
//#13418                    stchs[ing].y=ploc.y+clpnu[inf].y;                                                       
//#13419                    stchs[ing].at=0;                                                       
//#13420                    ing++;                                                       
//#13421                                                                           
//#13422                }                                                           
//#13423            }                                                               
//#13424        }                                                                   
//#13425        hed.stchs=ing;                                                                   
//#13426        return;*/                                                                   
//#13427                                                                           
//#13428    //    clipnts=(CLIPNT*)&stchs[MAXSEQ];                                                                   
//#13429        clipnts=(CLIPNT*)&bseq;                                                                   
//#13430        vclpx=(VCLPX*)&opnt;                                                                   
//#13431        segxs=0;                                                                   
//#13432        for(ind=0;ind<sids;ind++){                                                                   
//#13433                                                                           
//#13434            strt=floor(flt[ind].x/clpwid);                                                               
//#13435            fin=floor((flt[nxt(ind)].x)/clpwid);                                                               
//#13436            if(strt>fin){                                                               
//#13437                                                                           
//#13438                ine=strt;                                                           
//#13439                strt=fin;                                                           
//#13440                fin=ine;                                                           
//#13441            }                                                               
//#13442            if(frmpnt->fspac<0)                                                               
//#13443                fin+=clpsiz.cx/clpwid;                                                           
//#13444            if(fin>(unsigned)nrct.right)                                                               
//#13445                fin=nrct.right;                                                           
//#13446            if(clpneg)                                                               
//#13447                strt-=(float)clpsiz.cx/clpwid;                                                           
//#13448            for(ine=strt;ine<=fin;ine++){                                                               
//#13449                vclpx[segxs].sid=ind;                                                           
//#13450                vclpx[segxs++].seg=ine;                                                           
//#13451            }                                                               
//#13452        }                                                                   
//#13453        qsort((void*)vclpx,segxs,8,clpcmp);                                                                   
//#13454        iclpx=(unsigned*)&vclpx[segxs];                                                                   
//#13455        ine=1;inf=vclpx[0].seg;                                                                   
//#13456        iclpx[0]=0;                                                                   
//#13457        for(ind=1;ind<segxs;ind++){                                                                   
//#13458                                                                           
//#13459            if(vclpx[ind].seg!=inf){                                                               
//#13460                                                                           
//#13461                iclpx[ine++]=ind;                                                           
//#13462                inf=vclpx[ind].seg;                                                           
//#13463            }                                                               
//#13464        }                                                                   
//#13465        iclpx[ine]=ind;                                                                   
//#13466        isrct.left=isrct.right=flt[0].x;                                                                   
//#13467        isrct.top=isrct.bottom=flt[0].y;                                                                   
//#13468        for(ind=1;ind<sids;ind++)                                                                   
//#13469        {                                                                   
//#13470            if(flt[ind].x>isrct.right)                                                               
//#13471                isrct.right=flt[ind].x;                                                           
//#13472            if(flt[ind].x<isrct.left)                                                               
//#13473                isrct.left=flt[ind].x;                                                           
//#13474            if(flt[ind].y>isrct.top)                                                               
//#13475                isrct.top=flt[ind].y;                                                           
//#13476            if(flt[ind].y<isrct.bottom)                                                               
//#13477                isrct.bottom=flt[ind].y;                                                           
//#13478        }                                                                   
//#13479        segps=ine;                                                                   
//#13480        ind=vstrt=cnt=0;                                                                   
//#13481        seg=vclpx[0].seg;                                                                   
//#13482        clrnum=(nrct.top>>5)+1;                                                                   
//#13483        xpnt=0;                                                                   
//#13484        for(ind=0;ind<segps;ind++){                                                                   
//#13485                                                                           
//#13486            vstrt=iclpx[ind];                                                               
//#13487            vfin=iclpx[ind+1];                                                               
//#13488            ploc.x=clpwid*(ind+nrct.left);                                                               
//#13489            clpvof=0;                                                               
//#13490            if(chkMap(TXFIL))                                                               
//#13491            {                                                               
//#13492                tine=(ind+nrct.left)%frmpnt->dhx.txt.lins;                                                           
//#13493                clplen=txsegs[tine].cnt;                                                           
//#13494                ptx=&txpnts[frmpnt->dhx.txt.ind+txsegs[tine].lin];                                                           
//#13495                vpnt0.x=ploc.x;                                                           
//#13496                if(frmpnt->txof)                                                           
//#13497                {                                                           
//#13498                    inf=(ind+nrct.left)/frmpnt->dhx.txt.lins;                                                       
//#13499                    clpvof=fmod(frmpnt->txof*inf,frmpnt->dhx.txt.hi);                                                       
//#13500                }                                                           
//#13501            }                                                               
//#13502            else                                                               
//#13503            {                                                               
//#13504                if(clpnof)                                                           
//#13505                    clpvof=(float)(ind%clpnof)/clpnof*clpsiz.cy;                                                       
//#13506                vpnt0.x=ploc.x+clpnu[0].x;                                                           
//#13507            }                                                               
//#13508            vpnt0.y=nrct.bottom*clpsiz.cy;                                                               
//#13509            if(clpnof)                                                               
//#13510                clpvof=(float)(ind%clpnof)/clpnof*clpsiz.cy;                                                           
//#13511            for(tine=nrct.bottom;tine<nrct.top;tine++){                                                               
//#13512                                                                           
//#13513                ploc.y=tine*clpsiz.cy-clpvof;                                                           
//#13514                vpnt1.x=ploc.x+clpnu[0].x;                                                           
//#13515                vpnt1.y=ploc.y+clpnu[0].y;                                                           
//#13516                if(!xpnt){                                                           
//#13517                                                                           
//#13518                    vpnt0.x=vpnt1.x;                                                       
//#13519                    vpnt0.y=vpnt1.y;                                                       
//#13520                }                                                           
//#13521                for(inf=0;inf<clplen;inf++){                                                           
//#13522                                                                           
//#13523                    if(chkMap(TXFIL))                                                       
//#13524                    {                                                       
//#13525                        vpnt1.x=ploc.x;                                                   
//#13526                        vpnt1.y=ploc.y+ptx[inf].y;                                                   
//#13527                    }                                                       
//#13528                    else                                                       
//#13529                    {                                                       
//#13530                        vpnt1.x=ploc.x+clpnu[inf].x;                                                   
//#13531                        vpnt1.y=ploc.y+clpnu[inf].y;                                                   
//#13532                    }                                                       
//#13533                    clipnts[xpnt].x=vpnt0.x;                                                       
//#13534                    clipnts[xpnt].y=vpnt0.y;                                                       
//#13535                    if(isin(vpnt0.x,vpnt0.y))                                                       
//#13536                    {                                                       
//#13537                        if(xpnt&&clipnts[xpnt-1].flg==2)                                                   
//#13538                            inspnt();                                               
//#13539                        clipnts[xpnt].flg=0;                                                   
//#13540                    }                                                       
//#13541                    else                                                       
//#13542                    {                                                       
//#13543                        if(xpnt&&!clipnts[xpnt-1].flg)                                                   
//#13544                            inspnt();                                               
//#13545                        clipnts[xpnt].flg=2;                                                   
//#13546                    }                                                       
//#13547                    xpnt++;                                                       
//#13548                    cnt=insect();                                                       
//#13549                    if(cnt)                                                       
//#13550                    {                                                       
//#13551                        for(ing=0;ing<cnt;ing++){                                                   
//#13552                                                                           
//#13553                            clipnts[xpnt].sid=pclpsrt[ing]->lin;                                               
//#13554                            clipnts[xpnt].x=pclpsrt[ing]->pnt.x;                                               
//#13555                            clipnts[xpnt].y=pclpsrt[ing]->pnt.y;                                               
//#13556                            clipnts[xpnt].flg=1;                                               
//#13557                            xpnt++;                                               
//#13558                            if(xpnt>MAXSEQ<<2)                                               
//#13559                                goto clpskp;                                           
//#13560                        }                                                   
//#13561                    }                                                       
//#13562                    vpnt0.x=vpnt1.x;                                                       
//#13563                    vpnt0.y=vpnt1.y;                                                       
//#13564                }                                                           
//#13565            }                                                               
//#13566            clipnts[xpnt-1].flg=2;                                                               
//#13567        }                                                                   
//#13568    clpskp:;                                                                       
//#13569                                                                           
//#13570        clipnts[xpnt].flg=2;                                                                   
//#13571        if(nof){                                                                   
//#13572                                                                           
//#13573            fnof=nof*clpsiz.cy;                                                               
//#13574            for(ind=0;ind<xpnt;ind++)                                                               
//#13575                clipnts[ind].y-=fnof;                                                           
//#13576            for(ind=0;ind<sids;ind++)                                                               
//#13577                flt[ind].y-=fnof;                                                           
//#13578        }                                                                   
//#13579    #define CLPVU 0                                                                       
//#13580    #define CLPNOP 0                                                                       
//#13581                                                                           
//#13582    #if CLPVU==1                                                                       
//#13583                                                                           
//#13584        goto clp1skp;                                                                   
//#13585                                                                           
//#13586    #endif                                                                       
//#13587                                                                           
//#13588        pcseg=0;                                                                   
//#13589        regof=vclpx[0].seg;                                                                   
//#13590        rstMap(FILDIR);                                                                   
//#13591        ine=0;                                                                   
//#13592        if(xpnt)                                                                   
//#13593        {                                                                   
//#13594            for(ind=0;ind<xpnt-1;ind++){                                                               
//#13595                                                                           
//#13596                switch(clipnts[ind].flg)                                                           
//#13597                {                                                           
//#13598                case 0:        //inside                                                   
//#13599                                                                           
//#13600                    setMap(FILDIR);                                                       
//#13601                    break;                                                       
//#13602                                                                           
//#13603                case 1:        //line                                                   
//#13604                                                                           
//#13605                    if(toglMap(FILDIR))                                                       
//#13606                        clpnseg(ine,ind);                                                   
//#13607                    else                                                       
//#13608                        ine=ind;                                                   
//#13609                    break;                                                       
//#13610                                                                           
//#13611                case 2:        //outside                                                   
//#13612                                                                           
//#13613                    rstMap(FILDIR);                                                       
//#13614                    break;                                                       
//#13615                }                                                           
//#13616            }                                                               
//#13617        }                                                                   
//#13618                                                                           
//#13619    #if CLPVU==1                                                                       
//#13620                                                                           
//#13621    clp1skp:;                                                                       
//#13622                                                                           
//#13623    #endif                                                                       
//#13624                                                                           
//#13625        delete lens;                                                                   
//#13626        delete clplens;                                                                   
//#13627        delete clpsrt;                                                                   
//#13628        delete pclpsrt;                                                                   
//#13629                                                                           
//#13630        if(pcseg){                                                                   
//#13631                                                                           
//#13632            clplim=pcseg>>3;                                                               
//#13633            clplim=pcseg>>1;                                                               
//#13634            if(!clplim)                                                               
//#13635                clplim=1;                                                           
//#13636            if(clplim>12)                                                               
//#13637                clplim=12;                                                           
//#13638            plens=(float**)&clpsegs[pcseg];                                                               
//#13639            ine=0;                                                               
//#13640            for(ind=0;ind<pcseg;ind++){                                                               
//#13641                                                                           
//#13642                plens[ine++]=&clpsegs[ind].blen;                                                           
//#13643                plens[ine++]=&clpsegs[ind].elen;                                                           
//#13644            }                                                               
//#13645            qsort((void*)plens,ine,4,lencmp);                                                               
//#13646            ind=sizeof(CLPSEG);                                                               
//#13647            for(ind=0;ind<ine;ind++){                                                               
//#13648                                                                           
//#13649                inf=lenref(plens[ind]);                                                           
//#13650                ing=inf>>1;                                                           
//#13651                if(inf&1)                                                           
//#13652                    clpsegs[ing].eind=ind;                                                       
//#13653                else                                                           
//#13654                    clpsegs[ing].bind=ind;                                                       
//#13655            }                                                               
//#13656                                                                           
//#13657    #if CLPVU==1                                                                       
//#13658                                                                           
//#13659            for(ind=0;ind<xpnt;ind++){                                                               
//#13660                                                                           
//#13661                stchs[ind].x=clipnts[ind].x;                                                           
//#13662                stchs[ind].y=clipnts[ind].y;                                                           
//#13663                stchs[ind].at=0;                                                           
//#13664            }                                                               
//#13665            hed.stchs=xpnt;                                                               
//#13666    #endif                                                                       
//#13667                                                                           
//#13668    #if    CLPVU==2                                                                   
//#13669                                                                           
//#13670            inf=0;                                                               
//#13671            for(ind=0;ind<pcseg;ind++){                                                               
//#13672                                                                           
//#13673                for(ine=clpsegs[ind].strt;ine<=clpsegs[ind].fin;ine++){                                                           
//#13674                                                                           
//#13675                    stchs[inf].x=clipnts[ine].x;                                                       
//#13676                    stchs[inf].y=clipnts[ine].y;                                                       
//#13677                    stchs[inf++].at=ind&0xf;                                                       
//#13678                }                                                           
//#13679            }                                                               
//#13680            hed.stchs=inf;                                                               
//#13681                                                                           
//#13682    #endif                                                                       
//#13683                                                                           
//#13684            minx=1e99;                                                               
//#13685                                                                           
//#13686    #if CLPVU==0                                                                       
//#13687                                                                           
//#13688            xpnt=0;                                                               
//#13689            setMap(FILDIR);                                                               
//#13690            seqpnt=0;                                                               
//#13691            pcseg2=pcseg<<1;                                                               
//#13692            vclpsid=clpsegs[0].asid;                                                               
//#13693            strtlen=clpsegs[0].elen;                                                               
//#13694            ritseg();                                                               
//#13695            while(nucseg()){                                                               
//#13696                                                                           
//#13697                if(seqpnt>MAXSEQ-3)                                                           
//#13698                    break;                                                       
//#13699                ritseg();                                                           
//#13700            }                                                               
//#13701            chksid(0);                                                               
//#13702            if(seqpnt>MAXSEQ-100)                                                               
//#13703                seqpnt=MAXSEQ-100;                                                           
//#13704            ine=0;inf=0;                                                               
//#13705            for(ind=0;ind<seqpnt;ind++){                                                               
//#13706                                                                           
//#13707                if(vscmp(ind,ine)){                                                           
//#13708                                                                           
//#13709                    ine++;                                                       
//#13710                    oseq[ine].x=oseq[ind].x;                                                       
//#13711                    oseq[ine].y=oseq[ind].y;                                                       
//#13712                }                                                           
//#13713                else                                                           
//#13714                    inf++;                                                       
//#13715            }                                                               
//#13716            seqpnt=ine;                                                               
//#13717            if(chkMap(WASNEG)){                                                               
//#13718                                                                           
//#13719                for(ind=0;ind<seqpnt;ind++)                                                           
//#13720                    oseq[ind].x-=fltof;                                                       
//#13721                for(ind=0;ind<sids;ind++)                                                           
//#13722                    flt[ind].x-=fltof;                                                       
//#13723                frmpnt->rct.left-=fltof;                                                           
//#13724                frmpnt->rct.right-=fltof;                                                           
//#13725            }                                                               
//#13726    #endif                                                                       
//#13727        }                                                                   
//#13728    }                                                                       
//#13729
procedure vrtsclp();
//#13730    void vrtsclp(){
begin
//#13732        unsigned ind;
//#13733
//#13734        fvars(clofind);
//#13735        delmclp(clofind);
//#13736        deltx();
//#13737        frmpnt->flencnt.nclp=clplen;
//#13738        frmpnt->angclp.clp=numclp();
//#13739        frmpnt->wpar=ini.faz;
//#13740        makpoli();
//#13741        frmpnt->fspac=ini.clpof;
//#13742        for(ind=0;ind<clplen;ind++){
//#13743
//#13744            frmpnt->angclp.clp[ind].x=clpnu[ind].x;
//#13745            frmpnt->angclp.clp[ind].y=clpnu[ind].y;
//#13746        }
//#13747        frmpnt->ftyp=VCLPF;
//#13748        frmpnt->fcol=actcol;
//#13749        frmpnt->typ=POLI;
//#13750        refilfn();
//#13751    }
end;
//#13752
procedure vrtclp();
//#13753    void vrtclp(){
begin
//#13755        unsigned ind;                                                                   
//#13756                                                                           
//#13757        if(filmsgs(FMM_CLP))                                                                   
//#13758            return;                                                               
//#13759        if(OpenClipboard(hWnd)){                                                                   
//#13760                                                                           
//#13761            hClip=RegisterClipboardFormat(pcdClip);                                                               
//#13762            hClpMem=GetClipboardData(hClip);                                                               
//#13763            if(hClpMem){                                                               
//#13764                                                                           
//#13765                redclp();                                                           
//#13766                CloseClipboard();                                                           
//#13767                if(clpsiz.cy>CLPMIN){                                                           
//#13768                                                                           
//#13769                    if(fselpnt){                                                       
//#13770                                                                           
//#13771                        setMap(NOCLP);                                                   
//#13772                        for(ind=0;ind<fselpnt;ind++){                                                   
//#13773                                                                           
//#13774                            clofind=selist[ind];                                               
//#13775                            fvars(clofind);                                               
//#13776                            if(frmpnt->typ!=LIN)                                               
//#13777                                vrtsclp();                                           
//#13778                        }                                                   
//#13779                        rstMap(NOCLP);                                                   
//#13780                        setMap(INIT);                                                   
//#13781                        coltab();                                                   
//#13782                        setMap(RESTCH);                                                   
//#13783                    }                                                       
//#13784                    else{                                                       
//#13785                                                                           
//#13786                        if(chkMap(FORMSEL)){                                                   
//#13787                                                                           
//#13788                            fvars(clofind);                                               
//#13789                            vrtsclp();                                               
//#13790                            setMap(INIT);                                               
//#13791                            coltab();                                               
//#13792                            setMap(RESTCH);                                               
//#13793                        }                                                   
//#13794                    }                                                       
//#13795                }                                                           
//#13796                else                                                           
//#13797                    tabmsg(IDS_CLP);                                                       
//#13798            }                                                               
//#13799            else                                                               
//#13800                CloseClipboard();                                                           
//#13801        }                                                                   
//#13802    }
end;                                                                       
//#13803
//#13804    void angout(){                                                                       
//#13805                                                                           
//#13806        FLRCT*        trct;                                                           
//#13807        unsigned    ine;                                                               
//#13808                                                                           
//#13809        if(angfrm.sids){                                                                   
//#13810                                                                           
//#13811            trct=&angfrm.rct;                                                               
//#13812            flt=angfrm.flt;                                                               
//#13813            trct->left=trct->right=flt[0].x;                                                               
//#13814            trct->bottom=trct->top=flt[0].y;                                                               
//#13815            for(ine=1;ine<angfrm.sids;ine++){                                                               
//#13816                                                                           
//#13817                if(flt[ine].x>trct->right)                                                           
//#13818                    trct->right=flt[ine].x;                                                       
//#13819                if(flt[ine].x<trct->left)                                                           
//#13820                    trct->left=flt[ine].x;                                                       
//#13821                if(flt[ine].y<trct->bottom)                                                           
//#13822                    trct->bottom=flt[ine].y;                                                       
//#13823                if(flt[ine].y>trct->top)                                                           
//#13824                    trct->top=flt[ine].y;                                                       
//#13825            }                                                               
//#13826        }                                                                   
//#13827    }                                                                       
//#13828                                                                           
//#13829    void horclpfn(){                                                                       
//#13830                                                                           
//#13831        unsigned ind;                                                                   
//#13832                                                                           
//#13833        frmcpy(&angfrm,&formlst[clofind]);                                                                   
//#13834        rotcntr.x=(double)(angfrm.rct.right-angfrm.rct.left)/2+angfrm.rct.left;                                                                   
//#13835        rotcntr.y=(double)(angfrm.rct.top-angfrm.rct.bottom)/2+angfrm.rct.bottom;                                                                   
//#13836        angfrm.flt=angflt;                                                                   
//#13837        ang=PI/2;                                                                   
//#13838        for(ind=0;ind<angfrm.sids;ind++){                                                                   
//#13839                                                                           
//#13840            angfrm.flt[ind].x=frmpnt->flt[ind].x;                                                               
//#13841            angfrm.flt[ind].y=frmpnt->flt[ind].y;                                                               
//#13842            rotflt(&angfrm.flt[ind]);                                                               
//#13843        }                                                                   
//#13844        angout();                                                                   
//#13845        frmpnt=&angfrm;                                                                   
//#13846        flt=angfrm.flt;                                                                   
//#13847        clpcon();                                                                   
//#13848        ang=-PI/2;                                                                   
//#13849        rotbak();                                                                   
//#13850        fvars(clofind);                                                                   
//#13851    }                                                                       
//#13852                                                                           
//#13853    void horsclp(){                                                                       
//#13854                                                                           
//#13855        unsigned ind;                                                                   
//#13856                                                                           
//#13857        fvars(clofind);                                                                   
//#13858        delmclp(clofind);                                                                   
//#13859        deltx();                                                                   
//#13860        frmpnt->flencnt.nclp=clplen;                                                                   
//#13861        frmpnt->angclp.clp=numclp();                                                                   
//#13862        frmpnt->flencnt.nclp=clplen;                                                                   
//#13863        frmpnt->wpar=ini.faz;                                                                   
//#13864        makpoli();                                                                   
//#13865        frmpnt->fspac=ini.clpof;                                                                   
//#13866        for(ind=0;ind<clplen;ind++){                                                                   
//#13867                                                                           
//#13868            frmpnt->angclp.clp[ind].x=clpnu[ind].x;                                                               
//#13869            frmpnt->angclp.clp[ind].y=clpnu[ind].y;                                                               
//#13870        }                                                                   
//#13871        frmpnt->ftyp=HCLPF;                                                                   
//#13872        frmpnt->fcol=actcol;                                                                   
//#13873        frmpnt->typ=POLI;                                                                   
//#13874        flt=frmpnt->flt;                                                                   
//#13875        refilfn();                                                                   
//#13876    }                                                                       
//#13877                                                                           
//#13878    void horclp(){                                                                       
//#13879                                                                           
//#13880        unsigned ind;                                                                   
//#13881                                                                           
//#13882        if(filmsgs(FMM_CLP))                                                                   
//#13883            return;                                                               
//#13884        if(OpenClipboard(hWnd)){                                                                   
//#13885                                                                           
//#13886            hClip=RegisterClipboardFormat(pcdClip);                                                               
//#13887            hClpMem=GetClipboardData(hClip);                                                               
//#13888            if(hClpMem){                                                               
//#13889                                                                           
//#13890                redclp();                                                           
//#13891                CloseClipboard();                                                           
//#13892                if(clpsiz.cy>CLPMIN){                                                           
//#13893                                                                           
//#13894                    if(fselpnt){                                                       
//#13895                                                                           
//#13896                        setMap(NOCLP);                                                   
//#13897                        for(ind=0;ind<fselpnt;ind++){                                                   
//#13898                                                                           
//#13899                            clofind=selist[ind];                                               
//#13900                            fvars(clofind);                                               
//#13901                            if(frmpnt->typ!=LIN)                                               
//#13902                                horsclp();                                           
//#13903                        }                                                   
//#13904                        setMap(NOCLP);                                                   
//#13905                        setMap(INIT);                                                   
//#13906                        coltab();                                                   
//#13907                        setMap(RESTCH);                                                   
//#13908                    }                                                       
//#13909                    else{                                                       
//#13910                                                                           
//#13911                        if(chkMap(FORMSEL)){                                                   
//#13912                                                                           
//#13913                            fvars(clofind);                                               
//#13914                            horsclp();                                               
//#13915                            setMap(INIT);                                               
//#13916                            coltab();                                               
//#13917                            setMap(RESTCH);                                               
//#13918                        }                                                   
//#13919                    }                                                       
//#13920                }                                                           
//#13921                else                                                           
//#13922                    tabmsg(IDS_CLP);                                                       
//#13923            }                                                               
//#13924            else                                                               
//#13925                CloseClipboard();                                                           
//#13926        }                                                                   
//#13927    }                                                                       
//#13928                                                                           
//#13929    void angclpfn()                                                                       
//#13930    {                                                                       
//#13931        unsigned    ind;                                                               
//#13932        FLPNT*        tflt;                                                           
//#13933                                                                           
//#13934        frmcpy(&angfrm,&formlst[clofind]);                                                                   
//#13935        rotcntr.x=(double)(angfrm.rct.right-angfrm.rct.left)/2+angfrm.rct.left;                                                                   
//#13936        rotcntr.y=(double)(angfrm.rct.top-angfrm.rct.bottom)/2+angfrm.rct.bottom;                                                                   
//#13937        angfrm.flt=angflt;                                                                   
//#13938        if(chkMap(ISUND))                                                                   
//#13939        {                                                                   
//#13940            ang=PI/2-frmpnt->uang;                                                               
//#13941            tflt=insid();                                                               
//#13942            for(ind=0;ind<angfrm.sids;ind++)                                                               
//#13943            {                                                               
//#13944                angflt[ind].x=tflt[ind].x;                                                           
//#13945                angflt[ind].y=tflt[ind].y;                                                           
//#13946                rotflt(&angflt[ind]);                                                           
//#13947            }                                                               
//#13948        }                                                                   
//#13949        else                                                                   
//#13950        {                                                                   
//#13951            if(chkMap(TXFIL))                                                               
//#13952                ang=PI/2-frmpnt->angclp.fang;                                                           
//#13953            else                                                               
//#13954                ang=PI/2-frmpnt->sacang.ang;                                                           
//#13955            for(ind=0;ind<angfrm.sids;ind++)                                                               
//#13956            {                                                               
//#13957                angflt[ind].x=frmpnt->flt[ind].x;                                                           
//#13958                angflt[ind].y=frmpnt->flt[ind].y;                                                           
//#13959                rotflt(&angflt[ind]);                                                           
//#13960            }                                                               
//#13961        }                                                                   
//#13962        angout();                                                                   
//#13963        frmpnt=&angfrm;                                                                   
//#13964        flt=angflt;                                                                   
//#13965        clpcon();                                                                   
//#13966        ang=-ang;                                                                   
//#13967        rotbak();                                                                   
//#13968        fvars(clofind);                                                                   
//#13969    }                                                                       
//#13970                                                                           
//#13971    void angsclp(){                                                                       
//#13972                                                                           
//#13973        unsigned ind;                                                                   
//#13974                                                                           
//#13975        fvars(clofind);                                                                   
//#13976        delmclp(clofind);                                                                   
//#13977        deltx();                                                                   
//#13978        frmpnt->angclp.clp=numclp();                                                                   
//#13979        frmpnt->flencnt.nclp=clplen;                                                                   
//#13980        frmpnt->wpar=ini.faz;                                                                   
//#13981        makpoli();                                                                   
//#13982        frmpnt->sacang.ang=ini.angl;                                                                   
//#13983        frmpnt->fspac=ini.clpof;                                                                   
//#13984        for(ind=0;ind<clplen;ind++){                                                                   
//#13985                                                                           
//#13986            frmpnt->angclp.clp[ind].x=clpnu[ind].x;                                                               
//#13987            frmpnt->angclp.clp[ind].y=clpnu[ind].y;                                                               
//#13988        }                                                                   
//#13989        frmpnt->ftyp=ANGCLPF;                                                                   
//#13990        frmpnt->fcol=actcol;                                                                   
//#13991        frmpnt->typ=POLI;                                                                   
//#13992        refilfn();                                                                   
//#13993    }                                                                       
//#13994                                                                           
//#13995    void angclp(){                                                                       
//#13996                                                                           
//#13997        unsigned ind;                                                                   
//#13998                                                                           
//#13999        if(filmsgs(FMM_CLP))                                                                   
//#14000            return;                                                               
//#14001        if(OpenClipboard(hWnd)){                                                                   
//#14002                                                                           
//#14003            hClip=RegisterClipboardFormat(pcdClip);                                                               
//#14004            hClpMem=GetClipboardData(hClip);                                                               
//#14005            if(hClpMem){                                                               
//#14006                                                                           
//#14007                redclp();                                                           
//#14008                CloseClipboard();                                                           
//#14009                if(clpsiz.cy>CLPMIN){                                                           
//#14010                                                                           
//#14011                    if(fselpnt){                                                       
//#14012                                                                           
//#14013                        setMap(NOCLP);                                                   
//#14014                        for(ind=0;ind<fselpnt;ind++){                                                   
//#14015                                                                           
//#14016                            clofind=selist[ind];                                               
//#14017                            fvars(clofind);                                               
//#14018                            if(frmpnt->typ!=LIN)                                               
//#14019                                angsclp();                                           
//#14020                        }                                                   
//#14021                        rstMap(NOCLP);                                                   
//#14022                        setMap(INIT);                                                   
//#14023                        coltab();                                                   
//#14024                        setMap(RESTCH);                                                   
//#14025                    }                                                       
//#14026                    else{                                                       
//#14027                                                                           
//#14028                        if(chkMap(FORMSEL)){                                                   
//#14029                                                                           
//#14030                            frmpnt=&formlst[clofind];                                               
//#14031                            angsclp();                                               
//#14032                            setMap(INIT);                                               
//#14033                            coltab();                                               
//#14034                            setMap(RESTCH);                                               
//#14035                        }                                                   
//#14036                    }                                                       
//#14037                }                                                           
//#14038                else                                                           
//#14039                    tabmsg(IDS_CLP);                                                       
//#14040            }                                                               
//#14041            else                                                               
//#14042                CloseClipboard();                                                           
//#14043        }                                                                   
//#14044    }                                                                       
//#14045                                                                           
//#14046    void dubfn(){                                                                       
//#14047                                                                           
//#14048        unsigned ind,ine;                                                                   
//#14049                                                                           
//#14050        brdfil(frmpnt->elen);                                                                   
//#14051        ine=seqpnt;                                                                   
//#14052        for(ind=seqpnt-1;ind<seqpnt;ind--){                                                                   
//#14053                                                                           
//#14054            oseq[ine].x=oseq[ind].x;                                                               
//#14055            oseq[ine++].y=oseq[ind].y;                                                               
//#14056        }                                                                   
//#14057        seqpnt=ine;                                                                   
//#14058    }                                                                       
//#14059                                                                           
//#14060    void dubsfil(){                                                                       
//#14061                                                                           
//#14062        fvars(clofind);                                                                   
//#14063        deleclp(clofind);                                                                   
//#14064        frmpnt->etyp=EGDUB;                                                                   
//#14065        seqpnt=0;                                                                   
//#14066        frmpnt->bcol=actcol;                                                                   
//#14067        dubfn();                                                                   
//#14068        bsizpar();                                                                   
//#14069        refilfn();                                                                   
//#14070    }                                                                       
//#14071                                                                           
//#14072    void dubfil(){                                                                       
//#14073                                                                           
//#14074        unsigned ind;                                                                   
//#14075                                                                           
//#14076        if(filmsgs(FML_LIN))                                                                   
//#14077            return;                                                               
//#14078        if(fselpnt){                                                                   
//#14079                                                                           
//#14080            for(ind=0;ind<fselpnt;ind++){                                                               
//#14081                                                                           
//#14082                clofind=selist[ind];                                                           
//#14083                fvars(clofind);                                                           
//#14084                dubsfil();                                                           
//#14085            }                                                               
//#14086            setMap(INIT);                                                               
//#14087            coltab();                                                               
//#14088            setMap(RESTCH);                                                               
//#14089        }                                                                   
//#14090        else{                                                                   
//#14091                                                                           
//#14092            if(chkMap(FORMSEL)){                                                               
//#14093                                                                           
//#14094                dubsfil();                                                           
//#14095                coltab();                                                           
//#14096                setMap(INIT);                                                           
//#14097                setMap(RESTCH);                                                           
//#14098            }                                                               
//#14099        }                                                                   
//#14100    }                                                                       
//#14101                                                                           
//#14102    void col2frm(){                                                                       
//#14103                                                                           
//#14104        unsigned*    fcnts;                                                               
//#14105        unsigned*    bcnts;                                                               
//#14106        unsigned*    fthcnts;                                                               
//#14107        unsigned*    ucnts;                                                               
//#14108        unsigned    ind,ine,cod,cnt,maxcol;                                                               
//#14109        unsigned    strt,fin,chngcnt,fp16;                                                               
//#14110        TCHAR        buf[HBUFSIZ];                                                           
//#14111                                                                           
//#14112        chngcnt=0;                                                                   
//#14113        fp16=formpnt<<4;                                                                   
//#14114        if(formpnt){                                                                   
//#14115                                                                           
//#14116            fcnts=(unsigned*)&oseq;                                                               
//#14117            bcnts=(unsigned*)&bseq;                                                               
//#14118            fthcnts=&bcnts[fp16];                                                               
//#14119            ucnts=&fthcnts[fp16];                                                               
//#14120            for(ind=0;ind<fp16;ind++){                                                               
//#14121                                                                           
//#14122                fcnts[ind]=0;                                                           
//#14123                bcnts[ind]=0;                                                           
//#14124                fthcnts[ind]=0;                                                           
//#14125                ucnts[ind]=0;                                                           
//#14126            }                                                               
//#14127            for(ind=0;ind<hed.stchs;ind++){                                                               
//#14128                                                                           
//#14129                cod=stchs[ind].at&0x3fff;                                                           
//#14130                if(stchs[ind].at&(WLKMSK|CWLKMSK|UNDMSK))                                                           
//#14131                    ucnts[cod]++;                                                       
//#14132                else                                                           
//#14133                {                                                           
//#14134                    if(stchs[ind].at&FTHMSK)                                                       
//#14135                        fthcnts[cod]++;                                                   
//#14136                    else{                                                       
//#14137                                                                           
//#14138                        switch(stchs[ind].at&TYPMSK){                                                   
//#14139                                                                           
//#14140                            case FRMFIL:                                               
//#14141                                                                           
//#14142                                fcnts[cod]++;                                           
//#14143                                break;                                           
//#14144                                                                           
//#14145                            case FRMBFIL:                                               
//#14146                                                                           
//#14147                                bcnts[cod]++;                                           
//#14148                                break;                                           
//#14149                        }                                                   
//#14150                    }                                                       
//#14151                }                                                           
//#14152            }                                                               
//#14153            strt=0;fin=16;                                                               
//#14154            for(ind=0;ind<formpnt;ind++){                                                               
//#14155                                                                           
//#14156                if(formlst[ind].ftyp){                                                           
//#14157                                                                           
//#14158                    cnt=maxcol=0;                                                       
//#14159                    for(ine=strt;ine<fin;ine++){                                                       
//#14160                                                                           
//#14161                        if(fcnts[ine]>cnt){                                                   
//#14162                                                                           
//#14163                            cnt=fcnts[ine];                                               
//#14164                            maxcol=ine;                                               
//#14165                        }                                                   
//#14166                    }                                                       
//#14167                    maxcol&=0xf;                                                       
//#14168                    if(formlst[ind].fcol!=maxcol){                                                       
//#14169                                                                           
//#14170                        chngcnt++;                                                   
//#14171                        formlst[ind].fcol=maxcol;                                                   
//#14172                    }                                                       
//#14173                    if(formlst[ind].ftyp==FTHF&&formlst[ind].xat&AT_FTHBLND){                                                       
//#14174                                                                           
//#14175                        cnt=maxcol=0;                                                   
//#14176                        for(ine=strt;ine<fin;ine++){                                                   
//#14177                                                                           
//#14178                            if(fthcnts[ine]>cnt){                                               
//#14179                                                                           
//#14180                                cnt=fcnts[ine];                                           
//#14181                                maxcol=ine;                                           
//#14182                            }                                               
//#14183                        }                                                   
//#14184                        maxcol&=0xf;                                                   
//#14185                        if(formlst[ind].dhx.fth.fthcol!=maxcol){                                                   
//#14186                                                                           
//#14187                            chngcnt++;                                               
//#14188                            formlst[ind].dhx.fth.fthcol=maxcol;                                               
//#14189                        }                                                   
//#14190                    }                                                       
//#14191                }                                                           
//#14192                if(formlst[ind].etyp){                                                           
//#14193                                                                           
//#14194                    cnt=maxcol=0;                                                       
//#14195                    for(ine=strt;ine<fin;ine++){                                                       
//#14196                                                                           
//#14197                        if(bcnts[ine]>cnt){                                                   
//#14198                                                                           
//#14199                            cnt=bcnts[ine];                                               
//#14200                            maxcol=ine;                                               
//#14201                        }                                                   
//#14202                    }                                                       
//#14203                    maxcol&=0xf;                                                       
//#14204                    if(formlst[ind].bcol!=maxcol){                                                       
//#14205                                                                           
//#14206                        chngcnt++;                                                   
//#14207                        formlst[ind].bcol=maxcol;                                                   
//#14208                    }                                                       
//#14209                }                                                           
//#14210                if(formlst[ind].xat&(AT_WALK|AT_CWLK|AT_UND)){                                                           
//#14211                                                                           
//#14212                    cnt=maxcol=0;                                                       
//#14213                    for(ine=strt;ine<fin;ine++){                                                       
//#14214                                                                           
//#14215                        if(ucnts[ine]>cnt){                                                   
//#14216                                                                           
//#14217                            cnt=bcnts[ine];                                               
//#14218                            maxcol=ine;                                               
//#14219                        }                                                   
//#14220                    }                                                       
//#14221                    maxcol&=0xf;                                                       
//#14222                    if(formlst[ind].ucol!=maxcol){                                                       
//#14223                                                                           
//#14224                        chngcnt++;                                                   
//#14225                        formlst[ind].ucol=maxcol;                                                   
//#14226                    }                                                       
//#14227                }                                                           
//#14228                strt+=16;                                                           
//#14229                fin+=16;                                                           
//#14230            }                                                               
//#14231        }                                                                   
//#14232        LoadString(hInst,IDS_NCOLCHG,buf,HBUFSIZ);                                                                   
//#14233        sprintf(msgbuf,buf,chngcnt);                                                                   
//#14234        shoMsg(msgbuf);                                                                   
//#14235    }                                                                       
//#14236                                                                           
//#14237    BOOL fxpnt(){                                                                       
//#14238                                                                           
//#14239        double        len,dif;                                                           
//#14240        unsigned    ind;                                                               
//#14241                                                                           
//#14242        mvpnt.x=flt[nxstrt].x;                                                                   
//#14243        mvpnt.y=flt[nxstrt].y;                                                                   
//#14244        len=hypot(mvpnt.x-sPnt.x,mvpnt.y-sPnt.y);                                                                   
//#14245        if(len>adjspac){                                                                   
//#14246                                                                           
//#14247            for(ind=0;ind<10;ind++){                                                               
//#14248                                                                           
//#14249                len=hypot(mvpnt.x-sPnt.x,mvpnt.y-sPnt.y);                                                           
//#14250                dif=adjspac-len;                                                           
//#14251                mvpnt.x+=dif*cosins[clpstrt];                                                           
//#14252                mvpnt.y+=dif*sins[clpstrt];                                                           
//#14253                if(fabs(dif)<0.2)                                                           
//#14254                    break;                                                       
//#14255            }                                                               
//#14256            return 1;                                                               
//#14257        }                                                                   
//#14258        return 0;                                                                   
//#14259    }                                                                       
//#14260                                                                           
//#14261    void fxlit(){                                                                       
//#14262                                                                           
//#14263        double        len;                                                           
//#14264        unsigned    cnt;                                                               
//#14265        DUBPNT        dif;                                                           
//#14266                                                                           
//#14267        if(fxpnt()){                                                                   
//#14268                                                                           
//#14269            sPnt.x=mvpnt.x;                                                               
//#14270            sPnt.y=mvpnt.y;                                                               
//#14271            beancnt++;                                                               
//#14272            len=hypot(flt[nxstrt].x-sPnt.x,flt[nxstrt].y-sPnt.y);                                                               
//#14273            cnt=floor(len/adjspac);                                                               
//#14274            dif.x=adjspac*cosins[clpstrt];                                                               
//#14275            dif.y=adjspac*sins[clpstrt];                                                               
//#14276            sPnt.x+=dif.x*cnt;                                                               
//#14277            sPnt.y+=dif.y*cnt;                                                               
//#14278            beancnt+=cnt;                                                               
//#14279        }                                                                   
//#14280    }                                                                       
//#14281                                                                           
//#14282    void fxlin(){                                                                       
//#14283                                                                           
//#14284        double        len;                                                           
//#14285        unsigned    cnt;                                                               
//#14286        unsigned    ind;                                                               
//#14287        DUBPNT        dif;                                                           
//#14288                                                                           
//#14289        if(fxpnt()){                                                                   
//#14290                                                                           
//#14291            chpnts[xpnt].x=sPnt.x=mvpnt.x;                                                               
//#14292            chpnts[xpnt].y=sPnt.y=mvpnt.y;                                                               
//#14293            xpnt++;                                                               
//#14294            len=hypot(flt[nxstrt].x-sPnt.x,flt[nxstrt].y-sPnt.y);                                                               
//#14295            cnt=floor(len/adjspac);                                                               
//#14296            dif.x=adjspac*cosins[clpstrt];                                                               
//#14297            dif.y=adjspac*sins[clpstrt];                                                               
//#14298            for(ind=0;ind<cnt;ind++){                                                               
//#14299                                                                           
//#14300                sPnt.x+=dif.x;                                                           
//#14301                sPnt.y+=dif.y;                                                           
//#14302                chpnts[xpnt].x=sPnt.x;                                                           
//#14303                chpnts[xpnt].y=sPnt.y;                                                           
//#14304                xpnt++;                                                           
//#14305            }                                                               
//#14306        }                                                                   
//#14307    }                                                                       
//#14308                                                                           
//#14309    void fxlen(){                                                                       
//#14310                                                                           
//#14311        double        ter;                                                           
//#14312        double        minter;                                                           
//#14313        double        minspac;                                                           
//#14314        double        hival;                                                           
//#14315        double        loval;                                                           
//#14316        double        spac2;                                                           
//#14317        unsigned    inicnt;                                                               
//#14318        unsigned    lupcnt;                                                               
//#14319        unsigned    ind,mind;                                                               
//#14320        double        len;                                                           
//#14321                                                                           
//#14322        chpnts=(FLPNT*)bseq;                                                                   
//#14323        adjspac=0;                                                                   
//#14324        for(ind=1;ind<(unsigned)sids;ind++){                                                                   
//#14325                                                                           
//#14326            len=hypot(flt[ind].x-flt[0].x,flt[ind].y-flt[0].y);                                                               
//#14327            if(len>frmpnt->espac)                                                               
//#14328                goto fxlab;                                                           
//#14329            else{                                                               
//#14330                                                                           
//#14331                if(len>adjspac){                                                           
//#14332                                                                           
//#14333                    adjspac=len;                                                       
//#14334                    mind=ind;                                                       
//#14335                }                                                           
//#14336            }                                                               
//#14337        }                                                                   
//#14338        chpnts[0].x=flt[0].x;                                                                   
//#14339        chpnts[0].y=flt[0].y;                                                                   
//#14340        chpnts[1].x=flt[1].x;                                                                   
//#14341        chpnts[1].y=flt[1].y;                                                                   
//#14342        xpnt=2;                                                                   
//#14343        return;                                                                   
//#14344    fxlab:;                                                                       
//#14345        adjspac=frmpnt->espac;                                                                   
//#14346        spac2=adjspac/2;                                                                   
//#14347        ter=1e9;                                                                   
//#14348        lupcnt=inicnt=0;                                                                   
//#14349        loval=0;                                                                   
//#14350        hival=1;                                                                   
//#14351        while(lupcnt<100&&(hival-loval)>TINY){                                                                   
//#14352                                                                           
//#14353            beancnt=0;                                                               
//#14354            sPnt.x=flt[0].x;                                                               
//#14355            sPnt.y=flt[0].y;                                                               
//#14356            xpnt=1;                                                               
//#14357            chpnts[0].x=sPnt.x;                                                               
//#14358            chpnts[0].y=sPnt.y;                                                               
//#14359            for(clpstrt=0;clpstrt<(unsigned)sids-1;clpstrt++){                                                               
//#14360                                                                           
//#14361                nxstrt=clpstrt+1;                                                           
//#14362                fxlit();                                                           
//#14363            }                                                               
//#14364            if(frmpnt->typ!=LIN){                                                               
//#14365                                                                           
//#14366                nxstrt=0;                                                           
//#14367                fxlit();                                                           
//#14368            }                                                               
//#14369            else                                                               
//#14370                nxstrt=sids-1;                                                           
//#14371            if(!inicnt){                                                               
//#14372                                                                           
//#14373                inicnt=beancnt;                                                           
//#14374                loval=adjspac;                                                           
//#14375                minter=ter=(double)hypot(flt[nxstrt].x-sPnt.x,flt[nxstrt].y-sPnt.y);                                                           
//#14376                minspac=adjspac;                                                           
//#14377                ter/=inicnt;                                                           
//#14378                adjspac+=ter/2;                                                           
//#14379                hival=loval+ter;                                                           
//#14380            }                                                               
//#14381            else{                                                               
//#14382                                                                           
//#14383                ter=hypot(flt[nxstrt].x-sPnt.x,flt[nxstrt].y-sPnt.y);                                                           
//#14384                if(ter>spac2)                                                           
//#14385                    ter=frmpnt->espac-ter;                                                       
//#14386                if(ter<minter){                                                           
//#14387                                                                           
//#14388                    minter=ter;                                                       
//#14389                    minspac=adjspac;                                                       
//#14390                }                                                           
//#14391                if(inicnt==beancnt)                                                           
//#14392                    loval=adjspac;                                                       
//#14393                else{                                                           
//#14394                                                                           
//#14395                    if(beancnt>inicnt)                                                       
//#14396                        hival=adjspac;                                                   
//#14397                    else                                                       
//#14398                        loval=adjspac;                                                   
//#14399                }                                                           
//#14400                adjspac=loval+(hival-loval)/2;                                                           
//#14401            }                                                               
//#14402            lupcnt++;                                                               
//#14403        }                                                                   
//#14404        sPnt.x=flt[0].x;                                                                   
//#14405        sPnt.y=flt[0].y;                                                                   
//#14406        opnt=1;                                                                   
//#14407        adjspac=minspac;                                                                   
//#14408        for(clpstrt=0;clpstrt<(unsigned)sids-1;clpstrt++){                                                                   
//#14409                                                                           
//#14410            nxstrt=clpstrt+1;                                                               
//#14411            fxlin();                                                               
//#14412        }                                                                   
//#14413        if(frmpnt->typ!=LIN){                                                                   
//#14414                                                                           
//#14415            nxstrt=0;                                                               
//#14416            fxlin();                                                               
//#14417        }                                                                   
//#14418        ter=hypot(flt[nxstrt].x-sPnt.x,flt[nxstrt].y-sPnt.y);                                                                   
//#14419        if(ter<spac2)                                                                   
//#14420            xpnt--;                                                               
//#14421        chpnts[xpnt].x=flt[nxstrt].x;                                                                   
//#14422        chpnts[xpnt].y=flt[nxstrt].y;                                                                   
//#14423        xpnt++;                                                                   
//#14424    /*    for(opnt=0;opnt<xpnt;opnt++){                                                                   
//#14425                                                                           
//#14426            stchs[opnt].x=chpnts[opnt].x;                                                               
//#14427            stchs[opnt].y=chpnts[opnt].y;                                                               
//#14428            stchs[opnt++].at=0;                                                               
//#14429        }                                                                   
//#14430        hed.stchs=opnt;                                                                   
//#14431        coltab();                                                                   
//#14432        setMap(RESTCH);*/                                                                   
//#14433    }                                                                       
//#14434                                                                           
//#14435    void duchfn(unsigned strt,unsigned fin){                                                                       
//#14436                                                                           
//#14437        FLPNT        pnts[5];                                                           
//#14438        float        midx;                                                           
//#14439        float        midy;                                                           
//#14440        DUBPNT        dif;                                                           
//#14441        DUBPNT        difrat;                                                           
//#14442        DUBPNT        off;                                                           
//#14443        unsigned    ine;                                                               
//#14444        double        tang;                                                           
//#14445                                                                           
//#14446        dif.x=chpnts[fin].x-chpnts[strt].x;                                                                   
//#14447        dif.y=chpnts[fin].y-chpnts[strt].y;                                                                   
//#14448        difrat.x=dif.x*frmpnt->elen;                                                                   
//#14449        difrat.y=dif.y*frmpnt->elen;                                                                   
//#14450        pnts[0].x=chpnts[strt].x;                                                                   
//#14451        pnts[0].y=chpnts[strt].y;                                                                   
//#14452        pnts[4].x=chpnts[fin].x;                                                                   
//#14453        pnts[4].y=chpnts[fin].y;                                                                   
//#14454        tang=atan2(dif.y,dif.x)+PI/2;                                                                   
//#14455        off.x=cos(tang)*frmpnt->esiz;                                                                   
//#14456        off.y=sin(tang)*frmpnt->esiz;                                                                   
//#14457        midx=chpnts[strt].x+difrat.x;                                                                   
//#14458        midy=chpnts[strt].y+difrat.y;                                                                   
//#14459        pnts[1].x=midx+off.x;                                                                   
//#14460        pnts[1].y=midy+off.y;                                                                   
//#14461        pnts[3].x=midx-off.x;                                                                   
//#14462        pnts[3].y=midy-off.y;                                                                   
//#14463        dif.x=chpnts[fin+1].x-chpnts[fin].x;                                                                   
//#14464        dif.y=chpnts[fin+1].y-chpnts[fin].y;                                                                   
//#14465        pnts[2].x=chpnts[fin].x+dif.x/4;                                                                   
//#14466        pnts[2].y=chpnts[fin].y+dif.y/4;                                                                   
//#14467        for(ine=0;ine<chncnt;ine++){                                                                   
//#14468                                                                           
//#14469            oseq[seqpnt].x=pnts[chseq[ine]].x;                                                               
//#14470            oseq[seqpnt].y=pnts[chseq[ine]].y;                                                               
//#14471            seqpnt++;                                                               
//#14472        }                                                                   
//#14473    }                                                                       
//#14474                                                                           
//#14475    void duch(){                                                                       
//#14476                                                                           
//#14477        unsigned ind,bak;                                                                   
//#14478                                                                           
//#14479        div4=adjspac/4;                                                                   
//#14480        seqpnt=0;                                                                   
//#14481        if(xpnt>1){                                                                   
//#14482                                                                           
//#14483            for(ind=0;ind<(unsigned)xpnt-2;ind++)                                                               
//#14484                duchfn(ind,ind+1);                                                           
//#14485            if(frmpnt->typ==LIN){                                                               
//#14486                                                                           
//#14487                duchfn(ind,ind+1);                                                           
//#14488                bak=8;                                                           
//#14489                if(chkMap(LINCHN))                                                           
//#14490                    bak--;                                                       
//#14491                oseq[seqpnt-bak].x=chpnts[ind+1].x;                                                           
//#14492                oseq[seqpnt-bak].y=chpnts[ind+1].y;                                                           
//#14493                oseq[seqpnt].x=chpnts[ind+1].x;                                                           
//#14494                oseq[seqpnt++].y=chpnts[ind+1].y;                                                           
//#14495            }                                                               
//#14496            else{                                                               
//#14497                                                                           
//#14498                duchfn(ind,0);                                                           
//#14499                oseq[seqpnt].x=chpnts[xpnt-1].x;                                                           
//#14500                oseq[seqpnt].y=chpnts[xpnt-1].y;                                                           
//#14501                seqpnt++;                                                           
//#14502            }                                                               
//#14503        }                                                                   
//#14504        else                                                                   
//#14505            tabmsg(IDS_CHANSMAL);                                                               
//#14506    }                                                                       
//#14507                                                                           
//#14508    void dufxlen(){                                                                       
//#14509                                                                           
//#14510        unsigned ind;                                                                   
//#14511                                                                           
//#14512        duangs();                                                                   
//#14513        sins=(double*)angflt;                                                                   
//#14514        cosins=(double*)tpoly;                                                                   
//#14515        for(ind=0;ind<(unsigned)sids;ind++){                                                                   
//#14516                                                                           
//#14517            sins[ind]=sin(angs[ind]);                                                               
//#14518            cosins[ind]=cos(angs[ind]);                                                               
//#14519        }                                                                   
//#14520        sins[ind]=sin(abs(angs[0]-angs[ind]));                                                                   
//#14521        fxlen();                                                                   
//#14522    }                                                                       
//#14523                                                                           
//#14524    void chnfn(){                                                                       
//#14525                                                                           
//#14526        chncnt=10;                                                                   
//#14527        if(chkMap(LINCHN))                                                                   
//#14528            chncnt--;                                                               
//#14529        fvars(clofind);                                                                   
//#14530        deleclp(clofind);                                                                   
//#14531        dufxlen();                                                                   
//#14532        dulast();                                                                   
//#14533        seqpnt=0;                                                                   
//#14534        duch();                                                                   
//#14535    }                                                                       
//#14536                                                                           
//#14537    void chan(){                                                                       
//#14538                                                                           
//#14539        frmpnt->bcol=actcol;                                                                   
//#14540        frmpnt->espac=ini.chspac;                                                                   
//#14541        frmpnt->esiz=brdwid;                                                                   
//#14542        frmpnt->elen=ini.chrat;                                                                   
//#14543        frmpnt->emax=ini.maxsiz;                                                                   
//#14544        frmpnt->emin=minsiz;                                                                   
//#14545        if(chkMap(LINCHN))                                                                   
//#14546            frmpnt->etyp=EGCHNL;                                                               
//#14547        else                                                                   
//#14548            frmpnt->etyp=EGCHNH;                                                               
//#14549        refilfn();                                                                   
//#14550    }                                                                       
//#14551                                                                           
//#14552    void chain(){                                                                       
//#14553                                                                           
//#14554        unsigned ind;                                                                   
//#14555                                                                           
//#14556        if(filmsgs(FML_CHAIN))                                                                   
//#14557            return;                                                               
//#14558        savdo();                                                                   
//#14559        if(fselpnt){                                                                   
//#14560                                                                           
//#14561            for(ind=0;ind<fselpnt;ind++){                                                               
//#14562                                                                           
//#14563                clofind=selist[ind];                                                           
//#14564                fvars(clofind);                                                           
//#14565                chan();                                                           
//#14566            }                                                               
//#14567            setMap(INIT);                                                               
//#14568            coltab();                                                               
//#14569            setMap(RESTCH);                                                               
//#14570        }                                                                   
//#14571        else{                                                                   
//#14572                                                                           
//#14573            if(chkMap(FORMSEL)){                                                               
//#14574                                                                           
//#14575                fvars(clofind);                                                           
//#14576                chan();                                                           
//#14577                setMap(INIT);                                                           
//#14578                coltab();                                                           
//#14579                ritot(hed.stchs);                                                           
//#14580                setMap(RESTCH);                                                           
//#14581            }                                                               
//#14582        }                                                                   
//#14583    }                                                                       
//#14584                                                                           
//#14585    BOOL cisin(float pntx,float pnty){                                                                       
//#14586                                                                           
//#14587        unsigned    ind,acnt;                                                               
//#14588        unsigned    nvrt;                                                               
//#14589        DUBPNT        ipnt;                                                           
//#14590        FLRCT*        trct;                                                           
//#14591                                                                           
//#14592        trct=&frmpnt->rct;                                                                   
//#14593        if(pntx>=trct->right)                                                                   
//#14594            return 0;                                                               
//#14595        if(pntx<=trct->left)                                                                   
//#14596            return 0;                                                               
//#14597        if(pnty>=trct->top)                                                                   
//#14598            return 0;                                                               
//#14599        if(pnty<=trct->bottom)                                                                   
//#14600            return 0;                                                               
//#14601        acnt=0;                                                                   
//#14602        for(ind=0;ind<sids;ind++)                                                                   
//#14603        {                                                                   
//#14604            nvrt=nxt(ind);                                                               
//#14605            if(projv(pntx,flt[ind],flt[nvrt],&ipnt))                                                               
//#14606            {                                                               
//#14607                if(ipnt.y>=pnty)                                                           
//#14608                {                                                           
//#14609                    if(flt[ind].x!=pntx&&flt[nvrt].x!=pntx)                                                       
//#14610                        acnt++;                                                   
//#14611                    else                                                       
//#14612                    {                                                       
//#14613                        if(flt[ind].x<flt[nvrt].x)                                                   
//#14614                        {                                                   
//#14615                            if(flt[nvrt].x!=pntx)                                               
//#14616                                acnt++;                                           
//#14617                        }                                                   
//#14618                        else                                                   
//#14619                        {                                                   
//#14620                            if(flt[ind].x!=pntx)                                               
//#14621                                acnt++;                                           
//#14622                        }                                                   
//#14623                    }                                                       
//#14624                }                                                           
//#14625            }                                                               
//#14626        }                                                                   
//#14627        return acnt&1;                                                                   
//#14628    }                                                                       
//#14629                                                                           
//#14630    void crop(){                                                                       
//#14631                                                                           
//#14632        unsigned ind,ine;                                                                   
//#14633                                                                           
//#14634        frm1pnt();                                                                   
//#14635        if(chkMap(FORMSEL)){                                                                   
//#14636                                                                           
//#14637            savdo();                                                               
//#14638            fvars(clofind);                                                               
//#14639            ine=0;                                                               
//#14640            vstrt=0;                                                               
//#14641            vfin=sids;                                                               
//#14642            for(ind=0;ind<hed.stchs;ind++){                                                               
//#14643                                                                           
//#14644                if(cisin(stchs[ind].x,stchs[ind].y)){                                                           
//#14645                                                                           
//#14646                    stchs[ine].x=stchs[ind].x;                                                       
//#14647                    stchs[ine].y=stchs[ind].y;                                                       
//#14648                    stchs[ine++].at=stchs[ind].at;                                                       
//#14649                }                                                           
//#14650            }                                                               
//#14651            hed.stchs=ine;                                                               
//#14652            coltab();                                                               
//#14653            setMap(RESTCH);                                                               
//#14654        }                                                                   
//#14655        else                                                                   
//#14656            shoseln(IDS_FRM1MSG,IDS_CROP);                                                               
//#14657    }                                                                       
//#14658                                                                           
//#14659    void xclpfn(unsigned strt,unsigned fin){                                                                       
//#14660                                                                           
//#14661        unsigned    ind;                                                               
//#14662        DUBPNT        dif;                                                           
//#14663        double        len;                                                           
//#14664        double        rat;                                                           
//#14665        FLPNT*        tflt;                                                           
//#14666                                                                           
//#14667        tflt=(FLPNT*)&stchs[MAXPCS];                                                                   
//#14668        dif.x=chpnts[fin].x-chpnts[strt].x;                                                                   
//#14669        dif.y=chpnts[fin].y-chpnts[strt].y;                                                                   
//#14670        len=hypot(dif.x,dif.y);                                                                   
//#14671        rat=len/clpsiz.cx;                                                                   
//#14672        ang=atan2(dif.y,dif.x);                                                                   
//#14673        for(ind=0;ind<clplen;ind++){                                                                   
//#14674                                                                           
//#14675            tflt[ind].x=rclps[ind].x*rat;                                                               
//#14676            tflt[ind].y=rclps[ind].y;                                                               
//#14677            rotflt(&tflt[ind]);                                                               
//#14678            oseq[seqpnt].x=chpnts[strt].x+tflt[ind].x;                                                               
//#14679            oseq[seqpnt++].y=chpnts[strt].y+tflt[ind].y;                                                               
//#14680        }                                                                   
//#14681    }                                                                       
//#14682                                                                           
//#14683    void duxclp(){                                                                       
//#14684                                                                           
//#14685        unsigned ind;                                                                   
//#14686                                                                           
//#14687        duangs();                                                                   
//#14688        dufxlen();                                                                   
//#14689        clpxadj();                                                                   
//#14690        seqpnt=0;                                                                   
//#14691        rotcntr.x=rotcntr.y=0;                                                                   
//#14692        for(ind=1;ind<xpnt;ind++)                                                                   
//#14693            xclpfn(ind-1,ind);                                                               
//#14694        if(frmpnt->typ!=LIN){                                                                   
//#14695                                                                           
//#14696            oseq[seqpnt].x=chpnts[0].x;                                                               
//#14697            oseq[seqpnt++].y=chpnts[0].y;                                                               
//#14698        }                                                                   
//#14699    }                                                                       
//#14700                                                                           
//#14701    void dulast(){                                                                       
//#14702                                                                           
//#14703        unsigned    ind,ine,mind;                                                               
//#14704        double        minlen;                                                           
//#14705        double        len;                                                           
//#14706                                                                           
//#14707        rclps=(FLPNT*)&chpnts[xpnt];                                                                   
//#14708        if(lastch()){                                                                   
//#14709                                                                           
//#14710            minlen=1e99;                                                               
//#14711            mind=0;                                                               
//#14712            for(ind=0;ind<xpnt;ind++){                                                               
//#14713                                                                           
//#14714                len=hypot(lastpnt.x-chpnts[ind].x,lastpnt.y-chpnts[ind].y);                                                           
//#14715                if(len<minlen){                                                           
//#14716                                                                           
//#14717                    minlen=len;                                                       
//#14718                    mind=ind;                                                       
//#14719                }                                                           
//#14720            }                                                               
//#14721            if(mind){                                                               
//#14722                                                                           
//#14723                ine=0;                                                           
//#14724                for(ind=mind;ind<xpnt-1;ind++){                                                           
//#14725                                                                           
//#14726                    rclps[ine].x=chpnts[ind].x;                                                       
//#14727                    rclps[ine++].y=chpnts[ind].y;                                                       
//#14728                }                                                           
//#14729                for(ind=0;ind<=mind;ind++){                                                           
//#14730                                                                           
//#14731                    rclps[ine].x=chpnts[ind].x;                                                       
//#14732                    rclps[ine++].y=chpnts[ind].y;                                                       
//#14733                }                                                           
//#14734                MoveMemory(chpnts,rclps,sizeof(FLPNT)*ine);                                                           
//#14735            }                                                               
//#14736        }                                                                   
//#14737    }                                                                       
//#14738                                                                           
//#14739    void clpxadj(){                                                                       
//#14740                                                                           
//#14741        unsigned    ind;                                                               
//#14742        double        pivot;                                                           
//#14743                                                                           
//#14744        dulast();                                                                   
//#14745        if(frmpnt->typ==LIN){                                                                   
//#14746                                                                           
//#14747            pivot=clpsiz.cy/2;                                                               
//#14748            for(ind=0;ind<clplen;ind++){                                                               
//#14749                                                                           
//#14750                rclps[ind].x=clpnu[ind].x;                                                           
//#14751                rclps[ind].y=-clpnu[ind].y+pivot;                                                           
//#14752            }                                                               
//#14753        }                                                                   
//#14754        else{                                                                   
//#14755                                                                           
//#14756            for(ind=0;ind<clplen;ind++){                                                               
//#14757                                                                           
//#14758                rclps[ind].x=clpnu[ind].x;                                                           
//#14759                rclps[ind].y=-clpnu[ind].y;                                                           
//#14760            }                                                               
//#14761        }                                                                   
//#14762    }                                                                       
//#14763                                                                           
//#14764    void fsclpx(){                                                                       
//#14765                                                                           
//#14766        unsigned    ind;                                                               
//#14767                                                                           
//#14768        deleclp(clofind);                                                                   
//#14769        frmpnt->etyp=EGCLPX;                                                                   
//#14770        frmpnt->nclp=clplen;                                                                   
//#14771        frmpnt->clp=nueclp(clofind,clplen);                                                                   
//#14772        frmpnt->esiz=clpsiz.cy;                                                                   
//#14773        frmpnt->espac=clpsiz.cx;                                                                   
//#14774        frmpnt->bcol=actcol;                                                                   
//#14775        bsizpar();                                                                   
//#14776        for(ind=0;ind<clplen;ind++){                                                                   
//#14777                                                                           
//#14778            frmpnt->clp[ind].x=clpnu[ind].x;                                                               
//#14779            frmpnt->clp[ind].y=clpnu[ind].y;                                                               
//#14780        }                                                                   
//#14781        rotcntr.x=rotcntr.y=0;                                                                   
//#14782        duxclp();                                                                   
//#14783        refilfn();                                                                   
//#14784    }                                                                       
//#14785                                                                           
//#14786    void filclpx(){                                                                       
//#14787                                                                           
//#14788        unsigned    ind;                                                               
//#14789                                                                           
//#14790        if(filmsgs(FML_CLP))                                                                   
//#14791            return;                                                               
//#14792        if(OpenClipboard(hWnd)){                                                                   
//#14793                                                                           
//#14794            fvars(clofind);                                                               
//#14795            hClip=RegisterClipboardFormat(pcdClip);                                                               
//#14796            hClpMem=GetClipboardData(hClip);                                                               
//#14797             if(hClpMem){                                                               
//#14798                                                                           
//#14799                savdo();                                                           
//#14800                redclp();                                                           
//#14801                CloseClipboard();                                                           
//#14802                if(clpsiz.cx>CLPMIN){                                                           
//#14803                                                                           
//#14804                    if(fselpnt){                                                       
//#14805                                                                           
//#14806                        for(ind=0;ind<fselpnt;ind++){                                                   
//#14807                                                                           
//#14808                            clofind=selist[ind];                                               
//#14809                            fvars(clofind);                                               
//#14810                            fsclpx();                                               
//#14811                        }                                                   
//#14812                        setMap(INIT);                                                   
//#14813                        coltab();                                                   
//#14814                        setMap(RESTCH);                                                   
//#14815                    }                                                       
//#14816                    else{                                                       
//#14817                                                                           
//#14818                        if(chkMap(FORMSEL)){                                                   
//#14819                                                                           
//#14820                            fsclpx();                                               
//#14821                            setMap(INIT);                                               
//#14822                            coltab();                                               
//#14823                            setMap(RESTCH);                                               
//#14824                        }                                                   
//#14825                    }                                                       
//#14826                }                                                           
//#14827                else                                                           
//#14828                    tabmsg(IDS_CLP);                                                       
//#14829            }                                                               
//#14830            else{                                                               
//#14831                                                                           
//#14832                shoMsg("no clipboard data");                                                           
//#14833                CloseClipboard();                                                           
//#14834            }                                                               
//#14835        }                                                                   
//#14836    }                                                                       
//#14837                                                                           
//#14838    BOOL CALLBACK wavprc(HWND hwndlg,UINT umsg,WPARAM wparam,LPARAM lparam){                                                                       
//#14839                                                                           
//#14840        TCHAR    buf[HBUFSIZ];                                                               
//#14841                                                                           
//#14842        switch(umsg){                                                                   
//#14843                                                                           
//#14844        case WM_INITDIALOG:                                                                   
//#14845                                                                           
//#14846            SendMessage(hwndlg,WM_SETFOCUS,0,0);                                                               
//#14847    reinit:;                                                                       
//#14848            sprintf(buf,"%d",ini.wavpnts);                                                               
//#14849            SetWindowText(GetDlgItem(hwndlg,IDC_WAVPNTS),buf);                                                               
//#14850            sprintf(buf,"%d",ini.wavstrt);                                                               
//#14851            SetWindowText(GetDlgItem(hwndlg,IDC_WAVSTRT),buf);                                                               
//#14852            sprintf(buf,"%d",ini.wavend);                                                               
//#14853            SetWindowText(GetDlgItem(hwndlg,IDC_WAVEND),buf);                                                               
//#14854            sprintf(buf,"%d",ini.wavs);                                                               
//#14855            SetWindowText(GetDlgItem(hwndlg,IDC_WAVS),buf);                                                               
//#14856            break;                                                               
//#14857                                                                           
//#14858        case WM_COMMAND:                                                                   
//#14859                                                                           
//#14860            switch(LOWORD(wparam)){                                                               
//#14861                                                                           
//#14862            case IDCANCEL:                                                               
//#14863                                                                           
//#14864                EndDialog(hwndlg,0);                                                            
//#14865                return TRUE;                                                           
//#14866                                                                           
//#14867            case IDOK:                                                               
//#14868                                                                           
//#14869                GetWindowText(GetDlgItem(hwndlg,IDC_WAVPNTS),buf,HBUFSIZ);                                                           
//#14870                ini.wavpnts=atoi(buf);                                                           
//#14871                GetWindowText(GetDlgItem(hwndlg,IDC_WAVSTRT),buf,HBUFSIZ);                                                           
//#14872                ini.wavstrt=atoi(buf);                                                           
//#14873                GetWindowText(GetDlgItem(hwndlg,IDC_WAVEND),buf,HBUFSIZ);                                                           
//#14874                ini.wavend=atoi(buf);                                                           
//#14875                GetWindowText(GetDlgItem(hwndlg,IDC_WAVS),buf,HBUFSIZ);                                                           
//#14876                ini.wavs=atoi(buf);                                                           
//#14877                if(ini.wavpnts>100)                                                           
//#14878                    ini.wavpnts=100;                                                       
//#14879                if(ini.wavpnts<3)                                                           
//#14880                    ini.wavpnts=3;                                                       
//#14881                if(ini.wavstrt==ini.wavend)                                                           
//#14882                    ini.wavend+=(ini.wavpnts>>2);                                                       
//#14883                ini.wavstrt%=ini.wavpnts;                                                           
//#14884                ini.wavend%=ini.wavpnts;                                                           
//#14885                EndDialog(hwndlg,1);                                                           
//#14886                break;                                                           
//#14887                                                                           
//#14888            case IDC_DEFWAV:                                                               
//#14889                                                                           
//#14890                ini.wavpnts=IWAVPNTS;                                                           
//#14891                ini.wavstrt=IWAVSTRT;                                                           
//#14892                ini.wavend=IWAVEND;                                                           
//#14893                ini.wavs=IWAVS;                                                           
//#14894                goto reinit;                                                           
//#14895            }                                                               
//#14896        }                                                                   
//#14897        return 0;                                                                   
//#14898    }                                                                       
//#14899                                                                           
//#14900    void wavfrm(){                                                                       
//#14901                                                                           
//#14902        unsigned    ind,ine,inf;                                                               
//#14903        unsigned    end;                                                               
//#14904        unsigned    cnt;                                                               
//#14905        FLPNT*        tflt;                                                           
//#14906        FLPNT        pos;                                                           
//#14907        double        hrat;                                                           
//#14908        double        vrat;                                                           
//#14909        FLPNT        siz;                                                           
//#14910                                                                           
//#14911        unmsg();                                                                   
//#14912        if(DialogBox(hInst,MAKEINTRESOURCE(IDD_WAV),hWnd,(DLGPROC)wavprc)){                                                                   
//#14913                                                                           
//#14914            ind=fltad;                                                               
//#14915            end=ini.wavend+1;                                                               
//#14916            durpoli(ini.wavpnts);                                                               
//#14917            mdufrm();                                                               
//#14918            fltad=ind;                                                               
//#14919            tflt=(FLPNT*)&bseq;                                                               
//#14920            ine=0;                                                               
//#14921            ind=ini.wavstrt;                                                               
//#14922            while(ind!=ini.wavend){                                                               
//#14923                                                                           
//#14924                inf=(ind+1)%ini.wavpnts;                                                           
//#14925                tflt[ine].x=-flt[inf].x+flt[ind].x;                                                           
//#14926                tflt[ine].y=-flt[inf].y+flt[ind].y;                                                           
//#14927                ine++;                                                           
//#14928                ind=inf;                                                           
//#14929            }                                                               
//#14930            cnt=ine;                                                               
//#14931            ine=0;                                                               
//#14932            pos.x=pos.y=0;                                                               
//#14933            for(inf=0;inf<ini.wavs;inf++){                                                               
//#14934                                                                           
//#14935                if(inf&1){                                                           
//#14936                                                                           
//#14937                    for(ind=0;ind<cnt;ind++){                                                       
//#14938                                                                           
//#14939                        flt[ine].x=pos.x;                                                   
//#14940                        flt[ine].y=pos.y;                                                   
//#14941                        ine++;                                                   
//#14942                        pos.x+=tflt[ind].x;                                                   
//#14943                        pos.y+=tflt[ind].y;                                                   
//#14944                    }                                                       
//#14945                }                                                           
//#14946                else{                                                           
//#14947                                                                           
//#14948                    for(ind=cnt-1;ind<cnt;ind--){                                                       
//#14949                                                                           
//#14950                        flt[ine].x=pos.x;                                                   
//#14951                        flt[ine].y=pos.y;                                                   
//#14952                        ine++;                                                   
//#14953                        pos.x+=tflt[ind].x;                                                   
//#14954                        pos.y+=tflt[ind].y;                                                   
//#14955                    }                                                       
//#14956                }                                                           
//#14957            }                                                               
//#14958            flt[ine].x=pos.x;                                                               
//#14959            flt[ine].y=pos.y;                                                               
//#14960            ine++;                                                               
//#14961            ang=-atan2(flt[ine-1].y-flt[0].y,flt[ine-1].x-flt[0].x);                                                               
//#14962            for(ind=0;ind<ine;ind++)                                                               
//#14963                rotflt(&flt[ind]);                                                           
//#14964            frmpnt->typ=LIN;                                                               
//#14965            frmpnt->sids=ine;                                                               
//#14966            fltad+=ine;                                                               
//#14967            frmout(formpnt);                                                               
//#14968            rstMap(FORMSEL);                                                               
//#14969            siz.x=frmpnt->rct.right-frmpnt->rct.left;                                                               
//#14970            siz.y=frmpnt->rct.top-frmpnt->rct.bottom;                                                               
//#14971            hrat=zum0.x/4/siz.x;                                                               
//#14972            if(hrat>1)                                                               
//#14973                hrat=1;                                                           
//#14974            vrat=zum0.y/4/siz.y;                                                               
//#14975            if(vrat<hrat)                                                               
//#14976                hrat=vrat;                                                           
//#14977            if(hrat<1){                                                               
//#14978                                                                           
//#14979                for(ind=0;ind<ine;ind++){                                                           
//#14980                                                                           
//#14981                    flt[ind].x=(flt[ind].x-flt[0].x)*hrat+flt[0].x;                                                       
//#14982                    flt[ind].y=(flt[ind].y-flt[0].y)*hrat+flt[0].y;                                                       
//#14983                }                                                           
//#14984            }                                                               
//#14985            frmout(formpnt);                                                               
//#14986            for(ind=0;ind<ine;ind++){                                                               
//#14987                                                                           
//#14988                flt[ind].x-=frmpnt->rct.left;                                                           
//#14989                flt[ind].y-=frmpnt->rct.bottom;                                                           
//#14990            }                                                               
//#14991            fmovdif.x=fmovdif.y=0;                                                               
//#14992            nuflen=ine+1;                                                               
//#14993            setmfrm();                                                               
//#14994            mdufrm();                                                               
//#14995        }                                                                   
//#14996    }                                                                       
//#14997                                                                           
//#14998    void srtfrm(){                                                                       
//#14999                                                                           
//#15000        unsigned    ind,ine,inf,tot,sav;                                                               
//#15001        unsigned    hst[MAXFORMS];                                                               
//#15002        SHRTPNT*    hstch;                                                               
//#15003                                                                           
//#15004        if(hed.stchs){                                                                   
//#15005                                                                           
//#15006            savdo();                                                               
//#15007            FillMemory(hst,sizeof(unsigned)*MAXFORMS,0);                                                               
//#15008            for(ind=0;ind<hed.stchs;ind++)                                                               
//#15009                hst[(stchs[ind].at&FRMSK)>>FRMSHFT]++;                                                           
//#15010            tot=0;                                                               
//#15011            for(ind=0;ind<MAXFORMS;ind++){                                                               
//#15012                                                                           
//#15013                sav=hst[ind];                                                           
//#15014                hst[ind]=tot;                                                           
//#15015                tot+=sav;                                                           
//#15016            }                                                               
//#15017            hstch=&stchs[MAXSEQ];                                                               
//#15018            for(ind=0;ind<hed.stchs;ind++){                                                               
//#15019                                                                           
//#15020                ine=(stchs[ind].at&FRMSK)>>FRMSHFT;                                                           
//#15021                inf=hst[ine]++;                                                           
//#15022                hstch[inf].x=stchs[ind].x;                                                           
//#15023                hstch[inf].y=stchs[ind].y;                                                           
//#15024                hstch[inf].at=stchs[ind].at;                                                           
//#15025            }                                                               
//#15026            MoveMemory(stchs,hstch,sizeof(SHRTPNT)*hed.stchs);                                                               
//#15027            coltab();                                                               
//#15028            setMap(RESTCH);                                                               
//#15029        }                                                                   
//#15030    }                                                                       
//#15031                                                                           
//#15032    #pragma warning(default:4244)                                                                       

end.
