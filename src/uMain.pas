unit uMain;

interface

uses
  Windows, Messages, SysUtils, Variants, Classes, Graphics, Controls, Forms,
  Dialogs, Menus, XPMan,
  Thred_Types, stitch_Items,
  StdCtrls, //gmGridBased_List,
  gmSwatch_List,
  GR32_Image, GR32,
  gmGridBased_ListView, gmSwatch_ListView, gmGridBased_FileDlg,
  gmSwatch_FileDlgs, ComCtrls, {JvExComCtrls, JvPageScroller,} ExtCtrls,
  gmGridBased_List;

type
  TfrmMain = class(TForm)
    mm1: TMainMenu;
    mnu_FILE_NEW1: TMenuItem;
    mnu_FILE_OPEN1: TMenuItem;
    mnu_CLOSE: TMenuItem;
    mnu_THUM: TMenuItem;
    mnu_OPNPCD: TMenuItem;
    mnu_PES2CRD: TMenuItem;
    mnu_INSFIL: TMenuItem;
    mnu_OVRLAY: TMenuItem;
    mnu_FILE_SAVE2: TMenuItem;
    mnu_FILE_SAVE3: TMenuItem;
    mnu_LODBIT: TMenuItem;
    mnu_SAVMAP: TMenuItem;
    mnu_HIDBITF: TMenuItem;
    mnu_DELMAP: TMenuItem;
    mnu_PURG: TMenuItem;
    mnu_PURGDIR: TMenuItem;
    mnu_FLOK: TMenuItem;
    mnu_RUNPAT: TMenuItem;
    mnu_SETAP: TMenuItem;
    mnu_VIEW_STCHBAK: TMenuItem;
    mnu_BITCOL: TMenuItem;
    mnu_CLPSPAC: TMenuItem;
    mnu_CHKOF: TMenuItem;
    mnu_CHKON: TMenuItem;
    mnu_CHKREP: TMenuItem;
    mnu_CHKREPMSG: TMenuItem;
    mnu_VIEW_SET_DATACHECK: TMenuItem;
    mnu_SETPREF: TMenuItem;
    mnu_FIL2SEL_ON: TMenuItem;
    mnu_FIL2SEL_OFF: TMenuItem;
    mnu_FRMBOX: TMenuItem;
    mnu_FRMX: TMenuItem;
    mnu_GRDHI: TMenuItem;
    mnu_GRDMED: TMenuItem;
    mnu_GRDEF: TMenuItem;
    mnu_GRDRED: TMenuItem;
    mnu_GRDBLU: TMenuItem;
    mnu_GRDGRN: TMenuItem;
    mnu_LINBEXACT: TMenuItem;
    mnu_LINBEVEN: TMenuItem;
    mnu_AUXPCS: TMenuItem;
    mnu_AUXDST: TMenuItem;
    mnu_SETNEDL: TMenuItem;
    mnu_RSTNEDL: TMenuItem;
    mnu_NUDGPIX: TMenuItem;
    mnu_BSAVON: TMenuItem;
    mnu_BSAVOF: TMenuItem;
    mnu_STCHPIX: TMenuItem;
    mnu_FRMPIX: TMenuItem;
    mnu_FRMPBOX: TMenuItem;
    mnu_MARKESC: TMenuItem;
    mnu_MARKQ: TMenuItem;
    mnu_ROTAUXON: TMenuItem;
    mnu_ROTAUXOFF: TMenuItem;
    mnu_UANG: TMenuItem;
    mnu_WIND: TMenuItem;
    mnu_USPAC: TMenuItem;
    mnu_USTCH: TMenuItem;
    mnu_WARNOF: TMenuItem;
    mnu_VUBAK: TMenuItem;
    mnu_ZUMFUL: TMenuItem;
    mnu_SIZ30: TMenuItem;
    mnu_SIZ40: TMenuItem;
    mnu_SIZ60: TMenuItem;
    mnu_TSIZDEF: TMenuItem;
    mnu_VUTHRDS: TMenuItem;
    mnu_VUSELTHRDS: TMenuItem;
    mnu_DESIZ: TMenuItem;
    mnu_KNOTON: TMenuItem;
    mnu_KNOTOF: TMenuItem;
    mnu_BAKMRK: TMenuItem;
    mnu_ABOUT: TMenuItem;
    mnu_FORM: TMenuItem;
    mnu_CNTRH: TMenuItem;
    mnu_CNTRV: TMenuItem;
    mnu_CNTRX: TMenuItem;
    mnu_CENTIRE: TMenuItem;
    mnu_CNTR: TMenuItem;
    mnu_CHK: TMenuItem;
    mnu_2FTHR: TMenuItem;
    mnu_RIBON: TMenuItem;
    mnu_DUBEAN: TMenuItem;
    mnu_UNBEAN: TMenuItem;
    mnu_STCHS2FRM: TMenuItem;
    mnu_LAYCPY0: TMenuItem;
    mnu_LAYCPY1: TMenuItem;
    mnu_LAYCPY2: TMenuItem;
    mnu_LAYCPY3: TMenuItem;
    mnu_LAYCPY4: TMenuItem;
    mnu_CROP: TMenuItem;
    mnu_DELFRMS: TMenuItem;
    mnu_DELSTCH: TMenuItem;
    mnu_DELFRE: TMenuItem;
    mnu_DELKNOT: TMenuItem;
    mnu_REMBIG: TMenuItem;
    mnu_DELETE: TMenuItem;
    mnu_REMZERO: TMenuItem;
    mnu_FLIPH: TMenuItem;
    mnu_FLIPV: TMenuItem;
    mnu_FLPORD: TMenuItem;
    mnu_SETBCOL: TMenuItem;
    mnu_MAXBLEN: TMenuItem;
    mnu_MINBLEN: TMenuItem;
    mnu_SETBLEN: TMenuItem;
    mnu_SETBSPAC: TMenuItem;
    mnu_SETCWLK: TMenuItem;
    mnu_NOTCWLK: TMenuItem;
    mnu_SETWLK: TMenuItem;
    mnu_NOTWLK: TMenuItem;
    mnu_SETFANG: TMenuItem;
    mnu_SETFCOL: TMenuItem;
    mnu_MAXFLEN: TMenuItem;
    mnu_MINFLEN: TMenuItem;
    mnu_SETFLEN: TMenuItem;
    mnu_SETFSPAC: TMenuItem;
    mnu_FRMHI: TMenuItem;
    mnu_FRMIND: TMenuItem;
    mnu_SETUND: TMenuItem;
    mnu_NOTUND: TMenuItem;
    mnu_SETUANG: TMenuItem;
    mnu_SETUCOL: TMenuItem;
    mnu_SETUSPAC: TMenuItem;
    mnu_UNDLEN: TMenuItem;
    mnu_FRMWID: TMenuItem;
    mnu_MV2FRNT: TMenuItem;
    mnu_MOVMRK: TMenuItem;
    mnu_MV2BAK: TMenuItem;
    mnu_LAYMOV0: TMenuItem;
    mnu_LAYMOV1: TMenuItem;
    mnu_LAYMOV2: TMenuItem;
    mnu_LAYMOV3: TMenuItem;
    mnu_LAYMOV4: TMenuItem;
    mnu_REFILAL: TMenuItem;
    mnu_REPAIR: TMenuItem;
    mnu_EDIT_RESET_COL: TMenuItem;
    mnu_RETRACE: TMenuItem;
    mnu_RTRVCLP: TMenuItem;
    mnu_ROTAGAIN: TMenuItem;
    mnu_ROTDUP: TMenuItem;
    mnu_DUPAGAIN: TMenuItem;
    mnu_ROTCMD: TMenuItem;
    mnu_ALFRM: TMenuItem;
    mnu_SELAL: TMenuItem;
    mnu_SELALSTCH: TMenuItem;
    mnu_EDIT_SELECTCOLOR: TMenuItem;
    mnu_SELAP: TMenuItem;
    mnu_SELBRD: TMenuItem;
    mnu_SELWLK: TMenuItem;
    mnu_SELFIL: TMenuItem;
    mnu_SELFSTCHS: TMenuItem;
    mnu_SELUND: TMenuItem;
    mnu_DESNAM: TMenuItem;
    mnu_SETSIZ: TMenuItem;
    mnu_FTHDEF: TMenuItem;
    mnu_FILSTRT: TMenuItem;
    mnu_FILEND: TMenuItem;
    mnu_FRMNUM: TMenuItem;
    mnu_FRM2COL: TMenuItem;
    mnu_FRM0: TMenuItem;
    mnu_KNOTS: TMenuItem;
    mnu_KNOTAT: TMenuItem;
    mnu_SETMRK: TMenuItem;
    mnu_CLPADJ: TMenuItem;
    mnu_SETROT: TMenuItem;
    mnu_ROTMRK: TMenuItem;
    mnu_ROTSEG: TMenuItem;
    mnu535: TMenuItem;
    mnu_MRKCNTR: TMenuItem;
    mnu_MRKPNT: TMenuItem;
    mnu_SHRINK: TMenuItem;
    mnu_SNAP2: TMenuItem;
    mnu_SNAP2GRD: TMenuItem;
    mnu_SORT: TMenuItem;
    mnu_SRTBF: TMenuItem;
    mnu_SRTF: TMenuItem;
    mnu_SPLTFRM: TMenuItem;
    mnu_TRDIF: TMenuItem;
    mnu_HIDBIT: TMenuItem;
    mnu_BLAK: TMenuItem;
    mnu_TRCSEL: TMenuItem;
    mnu_TRACE: TMenuItem;
    mnu_TRACEDG: TMenuItem;
    mnu_UNGRPLO: TMenuItem;
    mnu_UNGRPHI: TMenuItem;
    mnuMIN: TMenuItem;
    mnu_ZUMOUT: TMenuItem;
    mnu_BACK: TMenuItem;
    mnu_REDO: TMenuItem;
    mnu_ROT: TMenuItem;
    mnu_PREF: TMenuItem;
    mnu_FILSAT: TMenuItem;
    mnu_FETHR: TMenuItem;
    mnu_FILL_VERT: TMenuItem;
    mnu_FILL_HOR: TMenuItem;
    mnu_FILANG: TMenuItem;
    mnu_CLPFIL: TMenuItem;
    mnu_VRTCLP: TMenuItem;
    mnu_HORCLP: TMenuItem;
    mnu_ANGCLP: TMenuItem;
    mnu_CONTF: TMenuItem;
    mnu_TXFIL: TMenuItem;
    mnu_FILIN: TMenuItem;
    mnu_BOLD: TMenuItem;
    mnu_SATBRD: TMenuItem;
    mnu_PERP: TMenuItem;
    mnu_APLIQ: TMenuItem;
    mnu_FILBUT: TMenuItem;
    mnu_FILCLP: TMenuItem;
    mnu_FILCLPX: TMenuItem;
    mnu_PICOT: TMenuItem;
    mnu_DUBFIL: TMenuItem;
    mnu_LINCHN: TMenuItem;
    mnu_OPNCHN: TMenuItem;
    mnu_UNFIL: TMenuItem;
    mnu_REFILF: TMenuItem;
    mnu_ADEND: TMenuItem;
    mnu_FRMOF: TMenuItem;
    mnu_LA: TMenuItem;
    mnu_L1: TMenuItem;
    mnu_L2: TMenuItem;
    mnu_L3: TMenuItem;
    mnu_L4: TMenuItem;
    mnu_HLP: TMenuItem;
    dlgOpen1: TOpenDialog;
    lstCustomColor: TListBox;
    lst2: TListBox;
    lst3: TListBox;
    lst4: TListBox;
    lst5: TListBox;
    swaDefault: TgmSwatchListView;
    swlCustom: TgmSwatchList;
    pmSwa: TPopupMenu;
    Select1: TMenuItem;
    LoadColorfromfile1: TMenuItem;
    Savecolorstofile1: TMenuItem;
    swa2: TgmSwatchListView;
    swlDefault: TgmSwatchList;
    dlgOpenSwa: TOpenSwatchDialog;
    N1: TMenuItem;
    dlgColor1: TColorDialog;
    EditColor1: TMenuItem;
    swa1: TgmSwatchListView;
    spl1: TSplitter;
    pgscrlr1: TPageScroller;
    pb: TPaintBox32;
    pmForm: TPopupMenu;
    Line1: TMenuItem;
    Freehand1: TMenuItem;
    RegularPolygon1: TMenuItem;
    Line2: TMenuItem;
    procedure FormMouseMove(Sender: TObject; Shift: TShiftState; X,
      Y: Integer);
    procedure FormMouseUp(Sender: TObject; Button: TMouseButton;
      Shift: TShiftState; X, Y: Integer);
    procedure FormMouseDown(Sender: TObject; Button: TMouseButton;
      Shift: TShiftState; X, Y: Integer);
    procedure FormKeyPress(Sender: TObject; var Key: Char);
    procedure FormKeyDown(Sender: TObject; var Key: Word;
      Shift: TShiftState);
    procedure FormCreate(Sender: TObject);
    procedure mnu_FILE_OPEN1Click(Sender: TObject);
    procedure mnu_FILE_NEW1Click(Sender: TObject);
    procedure lstCustomColorDrawItem(Control: TWinControl; Index: Integer;
      Rect: TRect; State: TOwnerDrawState);
    procedure lst2DrawItem(Control: TWinControl; Index: Integer;
      Rect: TRect; State: TOwnerDrawState);
    procedure lst3DrawItem(Control: TWinControl; Index: Integer;
      Rect: TRect; State: TOwnerDrawState);
    procedure lst4DrawItem(Control: TWinControl; Index: Integer;
      Rect: TRect; State: TOwnerDrawState);
    procedure lst5DrawItem(Control: TWinControl; Index: Integer;
      Rect: TRect; State: TOwnerDrawState);
    procedure LoadColorfromfile1Click(Sender: TObject);
    procedure EditColor1Click(Sender: TObject);
    procedure mnu_HLPClick(Sender: TObject);
    procedure pbPaintBuffer(Sender: TObject);
    procedure mnu_FILE_SAVE2Click(Sender: TObject);
    procedure mnu_FILE_SAVE3Click(Sender: TObject);
    procedure mnu_FORMClick(Sender: TObject);
    procedure Line1Click(Sender: TObject);
  private
    filnam : TFileName;
    FIni: TThredIniFile;
    FStitchs : TStitchCollection;

    useCol,
    custCol,
    bakCust,
    bakBit : T16Colors;

    procedure redini;
    procedure nuFil();
    procedure defpref;
    procedure save;
    { Private declarations }
  public
    { Public declarations }
    property ini : TThredIniFile read FIni;// write FIni;
  end;

var
  frmMain: TfrmMain;

implementation

uses
  GR32_polygons,
  Thred_Constants, Thred_Defaults,
  gmSwatch_rwTHR, gmSwatch_rwACO, gmSwatch_rwSWA,
  Stitch_FileDlg, Stitch_rwTHR, Stitch_rwPCS, Stitch_rwPES,
  Stitch_Lines32;

{$R *.dfm}

//#1    #include <windows.h>                                                                       
//#2    #include <stdio.h>                                                                       
//#3    #include <math.h>
//#4    #include <float.h>                                                                       
//#5    #include <tchar.h>                                                                       
//#6    #include "lang.h"                                                                       
//#7    #include "resource.h"                                                                       
//#8    #include "thred.h"                                                                       
//#9                                                                           
//#10    void clrhbut(unsigned strt);                                                                       
//#11    void delsfrms(unsigned cod);                                                                       
//#12    void renam();                                                                       
//#13    BOOL chkchksum();                                                                       
//#14    void fthrfn();                                                                       
//#15    void dufdef();                                                                       
//#16    void delet();                                                                       
//#17    void frmx(POINT cpnt,HDC dc);                                                                       
//#18    void setpsel();                                                                       
//#19    void unlin();                                                                       
//#20    void redraw(HWND dWnd);                                                                       
//#21    void duIns();                                                                       
//#22    void cros(unsigned ind);                                                                       
//#23    void shft(FLPNT shPnt);                                                                       
//#24    void movStch();                                                                       
//#25    void nuAct(unsigned ind);                                                                       
//#26    void movbox();                                                                       
//#27    void xlin();                                                                       
//#28    unsigned pt2colInd(unsigned pInd);                                                                       
//#29    void xlin1();                                                                       
//#30    void delstchm();                                                                       
//#31    void drwLin(unsigned ind,unsigned len,HPEN hPen);                                                                       
//#32    void zRctAdj();                                                                       
//#33    void lenCalc();                                                                       
//#34    void ritnum(unsigned cod,unsigned num);                                                                       
//#35    void ritot(unsigned num);                                                                       
//#36    void endpnt();                                                                       
//#37    void rstAll();                                                                       
//#38    void shoMsg(TCHAR* str);                                                                       
//#39    void delsmal(unsigned ind,unsigned fin);                                                                       
//#40    void patdun();                                                                       
//#41    void selRct(FLRCT* srct);                                                                       
//#42    void thrsav();                                                                       
//#43    void okcan();                                                                       
//#44    void rstdu();                                                                       
//#45    void unmsg();                                                                       
//#46    void frmdel();                                                                       
//#47    void unsid();                                                                       
//#48    void unbsho();                                                                       
//#49    void rngadj();                                                                       
//#50    void rotfn();                                                                       
//#51    void dusel(HDC dc);                                                                       
//#52    void rSelbox();                                                                       
//#53    void unsel();                                                                       
//#54    void rotpix(POINT rpnt,POINT* tpnt);                                                                       
//#55    BOOL cmpstch(unsigned ind0,unsigned ind1);                                                                       
//#56    void duselrng();                                                                       
//#57    void unthum();                                                                       
//#58    void insfil();                                                                       
//#59    void chkhup();                                                                       
//#60    void stch2map(RECT* bitrct);                                                                       
//#61    void ilin();                                                                       
//#62    void clRmap(unsigned len);                                                                       
//#63    void rotfns();                                                                       
//#64    void nuslst(unsigned find);                                                                       
//#65    void dstcurs();                                                                       
//#66    void mvstch(unsigned dst,unsigned src);                                                                       
//#67    void save();                                                                       
//#68    void mvstchs(unsigned dst,unsigned src,unsigned cnt);                                                                       
//#69    void fndknt();                                                                       
//#70    COLORREF fswap(COLORREF tcol);                                                                       
//#71    void dubuf();                                                                       
//#72    unsigned bufref();                                                                       
//#73    void hupfn();                                                                       
//#74    unsigned setRmp(unsigned pbit);                                                                       
//#75    void untrace();                                                                       
//#76    void trcols(COLORREF col);                                                                       
//#77    void dutrnum0(unsigned num);                                                                       
//#78    void dutrnum1();                                                                       
//#79    void trinit();                                                                       
//#80    void trdif();                                                                       
//#81    void blak();                                                                       
//#82    void trcsel();                                                                       
//#83    void fnamtabs();                                                                       
//#84                                                                           
//#85    extern void txsnap();                                                                       
//#86    extern void dazdef();                                                                       
//#87    extern void txof();                                                                       
//#88    extern void rstxt();                                                                       
//#89    extern void frmchkx();                                                                       
//#90    extern unsigned clofinx;                                                                       
//#91    extern void prbug();                                                                       
//#92    extern void repar();                                                                       
//#93    extern void setfchk();                                                                       
//#94    extern void chgchk(int cod);                                                                       
//#95    extern void lodchk();                                                                       
//#96    extern void chgwrn();                                                                       
//#97    extern void savtxt();                                                                       
//#98    extern void redtx();                                                                       
//#99    extern void txdun();                                                                       
//#100    extern void deltx();                                                                       
//#101    extern void clrstch();                                                                       
//#102    extern void setclpspac();                                                                       
//#103    extern void setshft();                                                                       
//#104    extern void mvshft();                                                                       
//#105    extern void dushft();                                                                       
//#106    extern void dufind(float idnt);                                                                       
//#107    extern void setfind();                                                                       
//#108    extern void nudsiz();                                                                       
//#109    extern void rtrclp();                                                                       
//#110    extern void redtx();                                                                       
//#111    extern TXPNT* adtx(int cnt);                                                                       
//#112    extern BOOL istx(unsigned find);                                                                       
//#113    extern void dutxtfil();                                                                       
//#114    extern TXPNT txpnts[MAXSEQ];                                                                       
//#115    extern int txad;                                                                       
//#116    extern TCHAR hlpbuf[HBUFSIZ];                                                                       
//#117    extern TXTSCR tscr;                                                                       
//#118    extern void txtkey(unsigned cod);                                                                       
//#119    extern int ptxhst;                                                                       
//#120    extern TXHST thsts[16];                                                                       
//#121    extern void txtlin();                                                                       
//#122    extern void txtclp();                                                                       
//#123    extern void rstxt();                                                                       
//#124    extern void txtform();                                                                       
//#125    extern int cloxcnt;                                                                       
//#126    extern void txtrup();                                                                       
//#127    extern void txtrmov();                                                                       
//#128    extern void txtrbut();                                                                       
//#129    extern void txtlbut();                                                                       
//#130    extern void duauxnam();                                                                       
//#131    extern void hsizmsg();                                                                       
//#132    extern void drwtxtr();                                                                       
//#133    extern void setfilstrt();                                                                       
//#134    extern void setfilend();                                                                       
//#135    extern void setfhi();                                                                       
//#136    extern void dufhi(float len);                                                                       
//#137    extern void setfwid();                                                                       
//#138    extern void dufwid(float len);                                                                       
//#139    extern void setfmin();                                                                       
//#140    extern void setfmax();                                                                       
//#141    extern void setbmin();                                                                       
//#142    extern void setbmax();                                                                       
//#143    extern void dufmin(float len);                                                                       
//#144    extern void dufmax(float len);                                                                       
//#145    extern void dubmin(float len);                                                                       
//#146    extern void dubmax(float len);                                                                       
//#147    extern void dubspac(float len);                                                                       
//#148    extern void setbspac();                                                                       
//#149    extern void setbcol();                                                                       
//#150    extern void setfcol();                                                                       
//#151    extern void setblen();                                                                       
//#152    extern void dublen(float len);                                                                       
//#153    extern void dufcol(unsigned col);                                                                       
//#154    extern void dubcol(unsigned col);                                                                       
//#155    extern void dundcol(unsigned col);                                                                       
//#156    extern void setucol();                                                                       
//#157    extern void setfang();                                                                       
//#158    extern void dufspac(float spac);                                                                       
//#159    extern void setfspac();                                                                       
//#160    extern void setflen();                                                                       
//#161    extern void duflen(float len);                                                                       
//#162    extern void dufang(float ang);                                                                       
//#163    extern void dufxang(float ang);                                                                       
//#164    extern void sfuang();                                                                       
//#165    extern void duspac(float spac);                                                                       
//#166    extern void uspac();                                                                       
//#167    extern void dusulen(float len);                                                                       
//#168    extern void undlen();                                                                       
//#169    extern void setund();                                                                       
//#170    extern void setwlk();                                                                       
//#171    extern void setcwlk();                                                                       
//#172    extern void notund();                                                                       
//#173    extern void notwlk();                                                                       
//#174    extern void notcwlk();                                                                       
//#175    #ifdef _DEBUG                                                                       
//#176    extern void dmpat();                                                                       
//#177    #endif                                                                       
//#178    extern void ducod();                                                                       
//#179    extern FLPNT iseq[MAXSEQ];                                                                       
//#180    extern BOOL chkrypt(unsigned arg0,unsigned arg1,unsigned arg2,unsigned arg3);                                                                       
//#181    extern void selalfrm();                                                                       
//#182    extern void setuang();                                                                       
//#183    extern void setuspac();                                                                       
//#184    extern void setulen();                                                                       
//#185    extern void setwlkind();                                                                       
//#186    extern void dubit(unsigned bit);                                                                       
//#187    extern void abstim();                                                                       
//#188    extern char* dgbuf;                                                                       
//#189    extern void pes2crd();                                                                       
//#190    extern void fritfil();                                                                       
//#191    extern void tst();                                                                       
//#192    extern void fethrf();                                                                       
//#193    extern void nufthcol(unsigned col);                                                                       
//#194    extern void fethr();                                                                       
//#195    extern void fltspac(FLPNT* strt,unsigned cnt);                                                                       
//#196    extern unsigned fltind(FLPNT* pnt);                                                                       
//#197    extern unsigned pdir(unsigned ind);                                                                       
//#198    extern void unpsel();                                                                       
//#199    extern void    sRct2px(FLRCT strct,RECT* pxrct);                                                                   
//#200    extern void dupsel(HDC dc);                                                                       
//#201    extern void fsizpar();                                                                       
//#202    extern void bsizpar();                                                                       
//#203    extern void form();                                                                       
//#204    extern void duform(unsigned ind);                                                                       
//#205    extern void drwfrm();                                                                       
//#206    extern void dufrm();                                                                       
//#207    extern void mdufrm();                                                                       
//#208    extern void setfrm();                                                                       
//#209    extern void unfrm();                                                                       
//#210    extern void munfrm();                                                                       
//#211    extern unsigned closfrm();                                                                       
//#212    extern void frmovlin();                                                                       
//#213    extern void setfpnt();                                                                       
//#214    extern void ritfrct(unsigned ind,HDC dc);                                                                       
//#215    extern void delfrms();                                                                       
//#216    extern void filvrt();                                                                       
//#217    extern void filhor();                                                                       
//#218    extern void frmcpy(FRMHED* dst,FRMHED* src);                                                                       
//#219    extern void filangl();                                                                       
//#220    extern void satpnt0();                                                                       
//#221    extern unsigned chkfrm();                                                                       
//#222    extern void setmfrm();                                                                       
//#223    extern void rstfrm();                                                                       
//#224    extern void clrfills();                                                                       
//#225    extern void drwsat();                                                                       
//#226    extern void satpnt1();                                                                       
//#227    extern void satfix();                                                                       
//#228    extern void filsat();                                                                       
//#229    extern void satsel();                                                                       
//#230    extern void drwcon();                                                                       
//#231    extern void satknkt();                                                                       
//#232    extern void insat();                                                                       
//#233    extern void delspnt();                                                                       
//#234    extern void unfil();                                                                       
//#235    extern void frmlin(FLPNT* scr,unsigned sidz);                                                                       
//#236    extern void rats();                                                                       
//#237    extern void satzum();                                                                       
//#238    extern void frmpnts();                                                                       
//#239    extern void frm0();                                                                       
//#240    extern void infrm();                                                                       
//#241    extern void duinsf();                                                                       
//#242    extern void uninsf();                                                                       
//#243    extern void setins();                                                                       
//#244    extern void refil();                                                                       
//#245    extern void frmout(unsigned ind);                                                                       
//#246    extern void delcon(unsigned cpnt);                                                                       
//#247    extern void satadj();                                                                       
//#248    extern void fvars(unsigned ind);                                                                       
//#249    extern void    bord();                                                                   
//#250    extern void fclp();                                                                       
//#251    extern void ispcdclp();                                                                       
//#252    extern void    satbrd();                                                                   
//#253    extern void    apliq();                                                                   
//#254    extern void setap();                                                                       
//#255    extern void refrm();                                                                       
//#256    extern void strtchbox();                                                                       
//#257    extern void unstrtch();                                                                       
//#258    extern void setstrtch();                                                                       
//#259    extern void setexpand();                                                                       
//#260    extern void nufilcol(unsigned col);                                                                       
//#261    extern void maxtsiz(TCHAR* str,POINT* pt);                                                                       
//#262    extern void nubrdcol(unsigned col);                                                                       
//#263    extern void nulapcol(unsigned col);                                                                       
//#264    extern void sidwnd(HWND wnd);                                                                       
//#265    extern void delmfil(unsigned col);                                                                       
//#266    extern unsigned find1st();                                                                       
//#267    extern void dubold();                                                                       
//#268    extern void px2stchf(POINT pxpnt,FLPNT* stpnt);                                                                       
//#269    extern void prfmsg();                                                                       
//#270    extern void prfsid(HWND wnd);                                                                       
//#271    extern void durpoli(unsigned sidz);                                                                       
//#272    extern void fliph();                                                                       
//#273    extern void flipv();                                                                       
//#274    extern void savdisc();                                                                       
//#275    extern void tomsg();                                                                       
//#276    extern void    getfinfo(unsigned ind);                                                                   
//#277    extern void prpbrd(double spac);                                                                       
//#278    extern void tglfrm();                                                                       
//#279    extern void frmon();                                                                       
//#280    extern void frmclr(FRMHED* dst);                                                                       
//#281    extern void flpord();                                                                       
//#282    extern void rinfrm();                                                                       
//#283    extern void clpfil();                                                                       
//#284    extern void snap();                                                                       
//#285    extern void fsort();                                                                       
//#286    extern void dustar(unsigned nsids,double len);                                                                       
//#287    extern void rotcmd();                                                                       
//#288    extern void rotagain();                                                                       
//#289    extern void rotdup();                                                                       
//#290    extern void duprot();                                                                       
//#291    extern void cpylayr(unsigned play);                                                                       
//#292    extern void movlayr(unsigned play);                                                                       
//#293    extern void duspir(unsigned nsids);                                                                       
//#294    extern void sfCor2px(FLPNT stpnt,POINT* pxpnt);                                                                       
//#295    extern void frmsqr(unsigned ind);                                                                       
//#296    extern float midl(float hi,float lo);                                                                       
//#297    extern void oclp(FLPNT* clp,unsigned nclp);                                                                       
//#298    extern void join();                                                                       
//#299    extern void refilal();                                                                       
//#300    extern void nufsel();                                                                       
//#301    extern void frmadj(unsigned find);                                                                       
//#302    extern void ratsr();                                                                       
//#303    extern void frmsadj();                                                                       
//#304    extern void pxrct2stch(RECT pxr,FLRCT* str);                                                                       
//#305    extern void fselrct(unsigned fpnt);                                                                       
//#306    extern unsigned short nxt(unsigned short ind);                                                                       
//#307    extern unsigned short prv(unsigned ind);                                                                       
//#308    extern void setr(unsigned pbit);                                                                       
//#309    extern BOOL chkr(unsigned pbit);                                                                       
//#310    extern void selal();                                                                       
//#311    extern void selfil(unsigned typ);                                                                       
//#312    extern void    selalfil();                                                                   
//#313    extern BOOL notfstch(unsigned at);                                                                       
//#314    extern BOOL frmrng(unsigned fpnt,RANG* rng);                                                                       
//#315    extern void refilfn();                                                                       
//#316    extern void bhol();                                                                       
//#317    extern void deleclp(unsigned fpnt);                                                                       
//#318    extern void delmclp(unsigned fpnt);                                                                       
//#319    extern void delsac(unsigned fpnt);                                                                       
//#320    extern void delflt(unsigned fpnt);                                                                       
//#321    extern void bholbrd();                                                                       
//#322    extern void fcntr();                                                                       
//#323    extern void savblen(float len);                                                                       
//#324    extern void boxsel();                                                                       
//#325    extern void picot();                                                                       
//#326    extern void blunt();                                                                       
//#327    extern void clpic(unsigned short strtlin);                                                                       
//#328    extern unsigned getlast();                                                                       
//#329    extern void ritbrd();                                                                       
//#330    extern void savplen(float len);                                                                       
//#331    extern void contfil();                                                                       
//#332    extern void chkcont();                                                                       
//#333    extern void grpmsg();                                                                       
//#334    extern void grpmsg1();                                                                       
//#335    extern void help();                                                                       
//#336    extern void ribon();                                                                       
//#337    extern void dubig();                                                                       
//#338    extern unsigned psg();                                                                       
//#339    extern void redup();                                                                       
//#340    extern void bakdup();                                                                       
//#341    extern void bakagain();                                                                       
//#342    extern void shrnk();                                                                       
//#343    extern void setrang();                                                                       
//#344    extern void frmnum();                                                                       
//#345    extern void frmnumfn(unsigned nunum);                                                                       
//#346    extern void srtbyfrm();                                                                       
//#347    extern void cntrx();                                                                       
//#348    extern void centir();                                                                       
//#349    extern BOOL notsel();                                                                       
//#350    extern void dubean();                                                                       
//#351    extern void debean();                                                                       
//#352    extern void spltfrm();                                                                       
//#353    extern void stchs2frm();                                                                       
//#354    extern void stCor2px(SHRTPNT stpnt,POINT* pxpnt);                                                                       
//#355    extern void    vrtclp();                                                                   
//#356    extern void horclp();                                                                       
//#357    extern void angclp();                                                                       
//#358    extern void dubfil();                                                                       
//#359    extern void horclpfn();                                                                       
//#360    extern void horsclp();                                                                       
//#361    extern void vrtsclp();                                                                       
//#362    extern void angsclp();                                                                       
//#363    extern void dubsfil();                                                                       
//#364    extern void makspac(unsigned strt,unsigned cnt);                                                                       
//#365    extern void    duhart(unsigned nsids);                                                                   
//#366    extern void dulens(unsigned nsids);                                                                       
//#367    extern void sethup();                                                                       
//#368    extern void sizstch(FLRCT* rct);                                                                       
//#369    extern void col2frm();                                                                       
//#370    extern void rstr(unsigned pbit);                                                                       
//#371    extern unsigned projh(double pnty,FLPNT pnt0,FLPNT pnt1,DUBPNT* ipnt);                                                                       
//#372    extern void stchrct2px(FLRCT srct,RECT* prct);                                                                       
//#373    extern void chan();                                                                       
//#374    extern void crop();                                                                       
//#375    extern void dueg(unsigned nsids);                                                                       
//#376    extern void selsqr(POINT cpnt,HDC dc);                                                                       
//#377    extern void shortr();                                                                       
//#378    extern void msgstr(unsigned cod);                                                                       
//#379    extern void shoseln(unsigned cod0,unsigned cod1);                                                                       
//#380    extern void    tabmsg(unsigned cod);                                                                   
//#381    extern void keydays(unsigned daz);                                                                       
//#382    extern void lodstr();                                                                       
//#383    extern TCHAR* stab[STR_LEN];                                                                       
//#384    extern void butxt(unsigned ind,TCHAR* str);                                                                       
//#385    extern void riter();                                                                       
//#386    extern void crmsg(TCHAR* nam);                                                                       
//#387    extern void filnopn(unsigned cod,TCHAR* nam);                                                                       
//#388    extern void bfilmsg();                                                                       
//#389    extern void tsizmsg(TCHAR* sizstr,double siz);                                                                       
//#390    extern void setear();                                                                       
//#391    extern void maxwid(unsigned strt,unsigned fin);                                                                       
//#392    extern void    chain();                                                                   
//#393    extern void duzig(unsigned nsids);                                                                       
//#394    extern void dusat();                                                                       
//#395    extern void filclpx();                                                                       
//#396    extern void duxclp();                                                                       
//#397    extern void fsclpx();                                                                       
//#398    extern void wavfrm();                                                                       
//#399    extern void srtfrm();                                                                       
//#400    extern void rct2sel(RECT rct,POINT* lin);                                                                       
//#401                                                                           
//#402    #if PESACT                                                                       
//#403                                                                           
//#404    extern BOOL setrc(unsigned pbit);                                                                       
//#405    #endif                                                                       
//#406                                                                           
//#407    extern POINT            pselin[9];                                                           
//#408    extern FLPNT            lastpnt;                                                           
//#409    extern unsigned            xpnt;                                                           
//#410    extern unsigned            formpnt;                                                           
//#411    extern unsigned            frmstrt;                                                           
//#412    extern unsigned            frmend;                                                           
//#413    extern unsigned            delpnt;                                                           
//#414    extern FRMHED            formlst[MAXFORMS];                                                           
//#415    extern POINT            flin[MAXFRMLINS];                                                           
//#416    extern unsigned            clofine;                                                           
//#417    extern unsigned            clofind;                                                           
//#418    extern unsigned            nuflen;                                                           
//#419    extern unsigned short    wpar;                                                                   
//#420    extern double            stspace;                                                           
//#421    extern double            angl;                                                           
//#422    extern double            brdwid;                                                           
//#423    extern unsigned            cntrl;                                                           
//#424    extern double            xpct;                                                           
//#425    extern unsigned short    sids;                                                                   
//#426    extern FLPNT            lolft;                                                           
//#427    extern HWND                thDat[LASTLIN];                                                       
//#428    extern FLPNT*            flt;                                                           
//#429    extern SATCON*            sac;                                                           
//#430    extern unsigned            satpt;                                                           
//#431    extern POINT            mvlin[3];                                                           
//#432    extern double            snplen;                                                           
//#433    extern double            starat;                                                           
//#434    extern double            spirwrap;                                                           
//#435    extern POINT            rctlin[10];                                                           
//#436    extern FLPNT            fmovdif;                                                           
//#437    extern unsigned            fselpnt;                                                           
//#438    extern unsigned            baksel;                                                           
//#439    extern POINT            biglin[9];                                                           
//#440    extern RECT                bigrct;                                                       
//#441    extern FLPNT            fmovdif;                                                           
//#442    extern unsigned short    selist[MAXFORMS];                                                                   
//#443    extern double            hfrat;                                                           
//#444    extern double            vfrat;                                                           
//#445    extern BSEQPNT            bseq[BSEQLEN];                                                           
//#446    extern FLPNT            flts[MAXFRMPNTS];        //form points                                                   
//#447    extern unsigned            fltad;                    //next index to append form points                                       
//#448    extern FLPNT            clps[MAXCLPNTS];        //main clipboard fill points for forms                                                   
//#449    extern unsigned            clpad;                    //next index to append main clipboard points                                       
//#450    extern SATCON            satks[MAXSAC];            //satin form connects                                               
//#451    extern unsigned            satkad;                    //next index to append satin connect points                                       
//#452    extern float            bfclen;                                                           
//#453    extern HWND                thTxt[LASTLIN];                                                       
//#454    extern float            picspac;                                                           
//#455    extern FLPNT            oseq[OSEQLEN];                                                           
//#456    extern HWND                hindx;                                                       
//#457    extern HWND                hnxt;                                                       
//#458    extern HWND                hsrch;                                                       
//#459    extern HWND                hlptxt;                                                       
//#460    extern TCHAR*            cpyrit;                                                           
//#461    extern unsigned            psgacc;                                                           
//#462    extern TCHAR*            laytxt[];                                                           
//#463    extern FRMHED*            finspnt;                                                           
//#464    extern unsigned            fgpnt0;                                                           
//#465    extern unsigned            opnt;                                                           
//#466    extern TCHAR*            shrtmsg;                                                           
//#467    extern FLRCT            rctal;                                                           
//#468    extern long                prfwid;                                                       
//#469    extern HWND                hMsg;                                                       
//#470                                                                           
//#471    unsigned char            cryptkey[4096];                                                           
//#472                                                                           
//#473    //select box                                                                       
//#474    #define                NERCNT        4        //number of entries in the near array                                       
//#475                                                                           
//#476    unsigned short chk1loc[]=                                                                       
//#477    {                                                                       
//#478        3632                                                                   
//#479        3168                                                                   
//#480        393                                                                   
//#481        2246                                                                   
//#482        802                                                                   
//#483        1817                                                                   
//#484        3175                                                                   
//#485        2254                                                                   
//#486    };                                                                       
//#487                                                                           
//#488    //main variables                                                                       
//#489    HINSTANCE            hInst;            //main instance handle                                               
//#490    HWND                hWnd;            //main window handle                                           
//#491    MSG                    msg;            //main message loop message                                       
//#492    RECT                mRct;            //main window size                                           
//#493    RECT                bRct;            //color bar rectangle                                           
//#494    RECT                bcRct;            //color bar client rectangle                                           
//#495    RECT                minLenRct;        //minimum length rectangle                                               
//#496    RECT                maxLenRct;        //maximum length rectangle                                               
//#497    unsigned            minpnt;            //pointer to the smallest stitch in the selected range                                               
//#498    unsigned            maxpnt;            //pointer to the largest stitch in the selected range                                               
//#499    unsigned            srchpnt;        //pointer to the current selection for length search                                                   
//#500    HDC                    mdc;            //main device context handle                                       
//#501    HDC                    sdc;            //stitch window memory device context                                       
//#502    HDC                    rsdc;            //stitch window device context                                       
//#503    HDC                    bitdc;            //bitmap device context                                       
//#504    HDC                    bdc;            //color bar device context                                       
//#505    HBITMAP                sbmp;            //bitmap for the memory stitch device context                                           
//#506    POINT                morg;            //offset origin of the main window                                           
//#507    POINT                stOrg;            //offset origin of the stitch window                                           
//#508    SIZE                txSiz;            //used for measuring sizes of text items                                           
//#509    SIZE                scrPix;            //screen size in pixels                                           
//#510    SIZE                scrSiz;            //screen size in millimeters                                           
//#511    DUBRCT                zRct;            //zoom rectangle                                           
//#512    RECT                sRct;            //stitch window size,absolute                                           
//#513    RECT                scRct;            //stitch window size,client                                           
//#514    DRAWITEMSTRUCT        *ds;            //for owner-draw windows                                                   
//#515    POINT                pstch;            //stitch coordinates                                           
//#516    double                zumFct=1;        //zoom factor                                               
//#517    POINT                zum0;            //size of the unzoomed stitch window                                           
//#518    POINT                pPnt;            //converted from stich to pixel                                           
//#519    POINT                pxNer[NERCNT];    //selected points                                                   
//#520    POINT                boxPix;            //single select box point                                           
//#521    double                cloSum;            //distance of closest point to a mouse click                                           
//#522    unsigned            cloInd;            //index of closest point                                               
//#523    unsigned            selclo;            //copy of index of closest point                                               
//#524    unsigned            grpInd;            //last point selected in group                                               
//#525    unsigned            gpnt0;            //lower end of selected stitches                                               
//#526    unsigned            gpnt1;            //higher end of selected stitches                                               
//#527    unsigned            opnt0;            //lower end of previous selection                                               
//#528    unsigned            opnt1;            //higher end of previous selection                                               
//#529    TCHAR                numbuf[5];        //stitch number entered by user                                               
//#530    TCHAR                sidbuf[11];        //side window number for entering form data sheet numbers                                               
//#531    unsigned            numpnt=0;        //pointer to the next number to be entered                                                   
//#532    unsigned            stchdigs;        //number of decimal digits in the number of stitches                                                   
//#533    POINT*                plin;            //for drawing lines on the screen                                           
//#534    unsigned            drwpnt;            //line index for display routine                                               
//#535    double                stchAspct;        //aspect ratio of the stitch window                                               
//#536    double                minsiz=MINSIZ*PFAFGRAN;    //minimum stitch size                                                   
//#537    double                usesiz=USESIZ*PFAFGRAN;    //user selected stitch size                                                   
//#538    double                smalsiz=SMALSIZ*PFAFGRAN;//user can remove stitches smaller than this                                                       
//#539    unsigned            rmap[RMAPSIZ];    //bitmap to tell when stitches have been marked                                                       
//#540    TCHAR*                pcdClip="PMust_Format";                                                       
//#541    TCHAR*                thredclp="threditor";                                                       
//#542    CLPSTCH*            clpdat;            //for pcs clipboard data                                               
//#543    FRMCLP*                frmclpdat;        //for thred form clipboard data                                               
//#544    FRMSCLP*            frmsclpdat;        //multiple form clipboard header                                                   
//#545    FPCLP*                fpclpdat;        //form points clipboard header                                               
//#546    void*                clpvoid;        //for memory allocation for clipboard data                                               
//#547    void*                tclpvoid;        //for memory allocation for thred format clipboard data                                               
//#548    FLSIZ                clpsiz;            //clipboard rectangle size                                           
//#549    FLRCT                clprct;            //clipboard rectangle                                           
//#550    unsigned            clplen;            //number of stitchs extracted from clipboard                                               
//#551    POINT                clporg;            //origin of clipboard box in stitch coordinates                                           
//#552    HGLOBAL                hClpMem;        //handle to the clipboard memory                                               
//#553    SIZE                selsiz;            //size of the select box                                           
//#554    POINT                selof;            //offset of the spot the user selected from the lower left of the select box                                           
//#555    DUBPNT                zrat;            //zoom ratio used to draw stitch window                                           
//#556    double                ang;            //rotation angle                                           
//#557    double                hang;            //angle of the rotation handle                                           
//#558    double                savang;            //saved rotation angle                                           
//#559    FLRCT                rotrct;            //rotation rectangle                                           
//#560    DUBPNT                bsrat;            //bitmap to stitch hoop ratios                                           
//#561    DUBPNT                birat;            //stitch hoop to bitmap ratios                                           
//#562    RECT                bsrct;            //bitmap sorce rectangle for zoomed view                                           
//#563    RECT                bdrct;            //stitch window destination rectangle for zooomed view                                           
//#564    unsigned            bwid;            //bitmap width                                               
//#565    unsigned            bhi;            //bitmap height                                               
//#566    DUBPNT                zumend;            //bitmap end points in stitch points                                           
//#567    POINT                scend;            //stitch window end points                                           
//#568    POINT                dstend;            //ends of the destination bitmap for bitmap drawing                                           
//#569    unsigned*            bpnt;            //monochrome bitmap data                                               
//#570    unsigned            bitCol=BITCOL;    //bitmap color                                                       
//#571    TCHAR                msgbuf[MSGSIZ];    //for user messages                                                   
//#572    unsigned            msgpnt;            //pointer to the message buffer                                               
//#573    double                shopnts=SHOPNTS;//show stitch grid below this zoom level                                                       
//#574    double                tsiz30=TSIZ30;    //#30 thread size                                                   
//#575    double                tsiz40=TSIZ40;    //#40 thread size                                                   
//#576    double                tsiz60=TSIZ60;    //#40 thread size                                                   
//#577    unsigned            runpnt;            //point for animating stitchout                                               
//#578    unsigned            runum;            //number of stitches to draw in each frame                                               
//#579    int                    delay;            //time delay for stitchout                                       
//#580    double                stchboxs=STCHBOX;//threshold for drawing stitch boxes                                                       
//#581    //WARNING the size of the following array must be changed if the maximum movie speed is changed                                                                       
//#582    POINT                movilin[100];    //line for movie stitch draw                                                   
//#583    RECT                msgRct;            //rectangle containing the text message                                           
//#584    void*                bakdat[16];        //backup data                                               
//#585    unsigned            dupnt0=0;        //undo storage pointer                                                   
//#586    unsigned            dupnt1=0;        //undo retrieval pointers                                                   
//#587    unsigned            apcol=15;        //underlay color                                                   
//#588    unsigned            lastcod=0xffff;    //last key code                                                       
//#589    unsigned            sidtyp=0;        //data type for form data form numerical entry                                                   
//#590    DUBPNT                mrkpnt;            //stitch coordinates of the zoom mark                                           
//#591    unsigned            prfind=0;        //index to the active preference window                                                   
//#592    unsigned            fmenid[]={FM_ONAM0,FM_ONAM1,FM_ONAM2,FM_ONAM3};    //recently used file menu ID's                                                       
//#593    TCHAR                vernams[OLDVER][MAX_PATH];    //temporary storage for old file version names                                                   
//#594    unsigned            baknum;            //points to old version to be read                                               
//#595    unsigned            actl=0;            //active layer                                               
//#596    unsigned            laycod;            //active layer code                                               
//#597    long                funscnt;        //number of forms the on the clipboard                                               
//#598    unsigned*            finds;            //array of form indices for delete multiple forms                                               
//#599    POINT                stchar[3];        //arrow for selected stitch                                               
//#600    RANG                selfrng;        //first and last stitch for min/max stitch select                                               
//#601    DUBPNT                bzrat;            //bitmap to hoop ratio                                           
//#602    unsigned            menhi;            //menu height                                               
//#603    unsigned            fnamord[50];    //file name order table                                                       
//#604    unsigned char        fnamcod[128];    //file name encoding                                                           
//#605    unsigned char        frencod[256];    //file name decode                                                           
//#606    TCHAR                fildes[50];        //file designer name in clear                                               
//#607    HWND                fwnd;            //first window not destroyed for exiting enumerate loop                                           
//#608    RANG                selrang;        //range of selected forms                                               
//#609    unsigned            bakfrm;            //saved form index                                               
//#610    unsigned char        amsk;            //cursor and mask                                                   
//#611    double                zumflor;        //minimum allowed zoom value                                               
//#612    FLRCT                chkhuprct;        //for checking the hoop size                                               
//#613    unsigned            daz;            //days untill a merchant key expires                                               
//#614    BALSTCH*            pbal;            //balarad stitch pointer                                               
//#615    FLPNT                balof;            //balarad offset
//#616    unsigned            clpmap=MCLPF|MVCLPF|MHCLPF|MANGCLPF; //for checking if a fill is a clipboard fill                                                           
//#617    unsigned            bakstch=0;        //stitch count for last message                                                   
//#618    SHRTPNT*            stchsr;            //rotated stitches for rotate and save                                               
//#619    unsigned            sidloc;            //side message window location                                               
//#620    POINT                sidsiz;            //size of the side message window                                           
//#621    TCHAR**                sidstr;            //string array displayed in sidmsg                                           
//#622    TCHAR*                per;            //pointer to the error string                                           
//#623    unsigned            loksel;            //selection for lock list box                                               
//#624    unsigned            unloksel;        //eslection for unlock list box                                                   
//#625    RANG                selrng;            //select range for locking                                           
//#626    TCHAR                colnam[MAX_PATH];//.thw file name                                                       
//#627    TCHAR                rgbnam[MAX_PATH];//.rgb file name                                                       
//#628    DUBPNT                rcel;            //size of an rmap cell for drawing stitch boxes                                           
//#629    unsigned            wcol;            //color being dragged                                               
//#630    unsigned            prfsiz;            //size of the text part of the preference window                                               
//#631    RNGC                pselrng;        //selected form points                                               
//#632    FLRCT                pselrct;        //rectangle enclosing selected form points                                               
//#633    RECT                pxselrct;        //display form point select rectangle                                               
//#634    POINT*                fplin;            //form point clipboard paste into form line                                           
//#635                                                                           
//#636    #if    PESACT                                                                   
//#637    unsigned char*        pescols;        //pes colors                                                       
//#638    TCHAR*                peschr;            //pes card data buffer                                           
//#639    FLPNT                sof;            //offset fro writing pes files                                           
//#640    PESTCH*                pestchs;        //pes stitch buffer                                               
//#641    unsigned char        pescolrs[16];    //pes equivalent colors                                                           
//#642    unsigned char*        pestch;            //pes stitches                                                   
//#643    unsigned            pcolind;        //pes color index                                                   
//#644    #endif                                                                       
//#645                                                                           
//#646    POINT                pselfin;        //point to draw a the end cross for form select points                                               
//#647    unsigned            fsizeof;        //size of form header divided by 4                                                   
//#648    HDC                    tracedc;        //trace device context                                           
//#649    HBITMAP                tracebit;        //trace bitmap                                               
//#650    unsigned            sref;            //brightness of reference pixel                                               
//#651    unsigned*            tracbits;        //trace bitmap data                                                   
//#652    POINT                tracpnt;        //current point being traced                                               
//#653    unsigned            tracind;        //index of the next point in the traced line                                                   
//#654    unsigned            trmapsiz;        //size of the trace bitmap in double words                                                   
//#655    unsigned*            tracmap;        //bitmap of selected trace pixels                                                   
//#656    unsigned*            edgmap;            //detected edges of trace areas                                               
//#657    long                tracmov[]={1,1,0,0,-1,-1,0,0};    //for moving the trace bits                                                   
//#658    TRCPNT*                trclin;            //collection of traced points                                           
//#659    TRCPNT*                diflin;            //differenced collection of traced points                                           
//#660    long                tracof;            //trace bitmap offset for landscap                                           
//#661    unsigned            trcdir;            //trace direction                                               
//#662    unsigned            inidir;            //initial trace direction                                               
//#663    TRCPNT                trdif0;            //difference from one trace pixel to the next                                           
//#664    TRCPNT                trdif1;            //difference from one trace pixel to the next                                           
//#665    COLORREF            uref;            //color of the up reference pixel                                               
//#666    COLORREF            dref;            //color of the down reference pixel                                               
//#667    COLORREF            curef;            //complement color of the up reference pixel                                               
//#668    COLORREF            cdref;            //complement color of the down reference pixel                                               
//#669    POINT                trcmpnt;        //message point for trace parsing                                               
//#670    RECT                hirct;            //high trace mask rectangle                                           
//#671    RECT                midrct;            //midle trace mask rectangle                                           
//#672    RECT                lorct;            //low trace mask rectangle                                           
//#673    unsigned            hicols[3];        //separated upper reference colors                                                   
//#674    unsigned            pxcols[3];        //separated pixel reference colors                                                   
//#675    unsigned            locols[3];        //separated lower reference colors                                                   
//#676    unsigned            trbits[]={TRCRED,TRCGRN,TRCBLU};    //trace bits                                                       
//#677    unsigned            trmsks[]={REDMSK,GRNMSK,BLUMSK};    //trace masks                                                       
//#678    unsigned            trgb[]={BLUCOL,GRNCOL,REDCOL};        //trace colors                                                   
//#679    unsigned            tradj[9];        //seperated colors for ajacent pixels                                                   
//#680    unsigned*            difmap;            //difference bitmap                                               
//#681    TCHAR                trbuf[4];        //for composing color numbers                                               
//#682    TCHAR                trinbuf[4];        //for user input color numbers                                               
//#683    unsigned            colm;            //trace color column                                               
//#684    POINT                bitpnt;            //a point on the bitmap                                           
//#685                                                                           
//#686    //cursors                                                                       
//#687    HCURSOR             hAr;            //arrow                                               
//#688    HCURSOR             hCros;            //cross                                               
//#689    HCURSOR             hfrm;            //form                                               
//#690    HCURSOR             hdlin;            //dlin                                               
//#691    HCURSOR                hnedu;            //upright needle                                           
//#692    HCURSOR                hnedlu;            //left up needle                                            
//#693    HCURSOR                hnedld;            //left down needle                                            
//#694    HCURSOR                hnedru;            //right up needle                                            
//#695    HCURSOR                hnedrd;            //right down needle                                            
//#696    CURS                curs;            //cursor mask structure                                           
//#697                                                                           
//#698    HPEN                lPen;            //line pen for stitch move lines                                           
//#699    HPEN                bPen[4];        //box pens                                               
//#700    HPEN                uPen[16];        //user color pens                                               
//#701    HPEN                xPen;            //pen for crosses in color windows                                           
//#702    HPEN                gPen;            //pen for group select                                           
//#703    HPEN                grdPen;            //pen for stitch grid                                           
//#704    HPEN                bakPen;            //background color pen                                           
//#705    HPEN                bitPen;            //bitmap pen                                           
//#706    HPEN                fPen;            //form pen                                           
//#707    HPEN                ypen[5];        //layer pens                                               
//#708    HPEN                fPen3;            //three-pixel form pen                                           
//#709    HPEN                fsPen;            //form select pen                                           
//#710    HPEN                mrkPen;            //zoom mark pen                                           
//#711    HPEN                fmpen;            //multiple selected forms pen                                           
//#712    HPEN                alpen;            //pen for drawing large boxes                                           
//#713    HPEN                kpen;            //knot pen                                           
//#714    HPEN                blakpen;        //black pen                                               
//#715                                                                           
//#716    unsigned            bakwid;            //width of the background pen                                               
//#717                                                                           
//#718    //brushes                                                                       
//#719    HBRUSH                hStchBak;        //background color brush                                               
//#720    HBRUSH                hbrDefCol[16];    //default color brushes                                                   
//#721    HBRUSH                hbrUseCol[16];    //user color brushes                                                   
//#722                                                                           
//#723    //clipboard handle                                                                       
//#724    unsigned            hClip=0;        //pcs format                                                   
//#725    unsigned            htclp=0;        //thred format                                                   
//#726                                                                           
//#727    //for the choose color dialog box                                                                       
//#728    CHOOSECOLOR            gCol;                                                           
//#729    COLORREF            custCol[16];                                                           
//#730    //for the bakground color dialog box                                                                       
//#731    CHOOSECOLOR            bCol;                                                           
//#732    COLORREF            bakCust[16];                                                           
//#733    //for the bitmap color dialog box                                                                       
//#734    CHOOSECOLOR            btCol;                                                           
//#735    COLORREF            bakBit[16];                                                           
//#736                                                                           
//#737    TCHAR                thrdSiz[16][2];    //user selected thread sizes                                                   
//#738    unsigned            pixSiz[16];        //thread sizes in pixels                                                   
//#739    unsigned            sizInd[16];        //thread size indices                                                   
//#740                                                                           
//#741    HMENU                hMen;            //main menu                                           
//#742    HMENU                hfilMen;        //fill submenu                                               
//#743    HMENU                hfileMen;        //file submenu                                               
//#744    HMENU                hfilBrdMen;        //border fill submenu                                               
//#745    HMENU                hvumen;            //view submenu                                           
//#746    HMENU                hvsmen;            //view/set                                           
//#747    HMENU                hedmen;            //edit submenu                                           
//#748    HWND                hDef[16];        //default color windows                                               
//#749    HWND                hCol[16];        //user color windows                                               
//#750    HWND                hSiz[16];        //thread size windows                                               
//#751    HWND                hSizChng[3];    //thread size change windows                                                   
//#752    HWND                hStch;            //stitch window                                           
//#753    HWND                hVrt;            //vertical scroll bar                                           
//#754    HWND                hHor;            //horizontal scroll bar                                           
//#755    HWND                hbuts[9];        //button windows                                               
//#756    HWND                hstep;            //trace step window                                           
//#757    HWND                hBar;            //color bar                                           
//#758    HWND                hok;            //ok button                                           
//#759    HWND                hdsc;            //discard button                                           
//#760    HWND                hcan;            //cancel button                                           
//#761    HWND                hmin;            //minimum stitch text box                                           
//#762    HWND                hgNum;            //general number input box                                           
//#763    HWND                hSped;            //speed scroll bar for movie                                           
//#764    HWND                hSid=0;            //main side message window                                           
//#765    HWND                hsidWnd[16];    //side message windows                                                   
//#766    HWND                hPrf;            //preferences window                                           
//#767    HWND                hfdat=0;        //form data sheet                                               
//#768    HWND                hto;            //asking user if she wants delete the sitches associated with a form                                           
//#769    HWND                hvu[OLDVER];    //handles of mulitple file viewing windows                                                   
//#770    HWND                htrup[3];        //trace up number windows                                               
//#771    HWND                htrdwn[3];        //trace down number windows                                               
//#772                                                                           
//#773    HWND                hctrc[3];        //trace control windows                                               
//#774    HWND                hstrc[3];        //trace select windows                                               
//#775    unsigned            trshft[]={0,8,16};//trace shift values                                                           
//#776    HBRUSH                trbrsh[3];        //red,green,and blue brushes                                               
//#777    HWND                htred;            //red trace window                                           
//#778    HWND                htgrn;            //green trace window                                           
//#779    HWND                htblu;            //blue trace window                                           
//#780    HWND                hcred;            //red control window                                           
//#781    HWND                hcgrn;            //green control window                                           
//#782    HWND                hcblu;            //blue control window                                           
//#783    HWND                htrnum;            //trace number input window                                           
//#784    HBRUSH                hbred;            //red brush                                           
//#785    HBRUSH                hbgrn;            //green brush                                           
//#786    HBRUSH                hblu;            //blue brush                                           
//#787    HBRUSH                hblk;            //black brush                                           
//#788    HBRUSH                tbrsh;            //temporary brush                                           
//#789                                                                           
//#790    COLORREF            useCol[16];        //user colors                                                   
//#791    COLORREF            stchBak;        //stich window background                                                   
//#792    COLORREF            boxRef[]={0x404040,0x408040,0x804040,0x404080};                                                           
//#793    unsigned            actcol=0;        //active color selector                                                   
//#794    unsigned            buttonHi;        //button height                                                   
//#795    unsigned            buttonWid;        //button width                                                   
//#796    unsigned            buttonWid3;        //button width times 3                                                   
//#797    unsigned            numwid;            //width of 0                                               
//#798    int                    tPix[3];        //thread sizes in pixels                                           
//#799    unsigned            cbit;            //color bitmap for recording colors on screen                                               
//#800    double                ner[NERCNT];    //distances of the closest points                                                   
//#801                                        //to a mouse click                                   
//#802    long                nerInd[NERCNT];    //indices of the closest points                                                   
//#803    unsigned            selCnt;            //number of boxes selected                                               
//#804    unsigned            slpnt=0;        //pointer for drawing stitch select lines                                                   
//#805    POINT                slin[MAXSEQ];    //stitch select line                                                   
//#806    FLRCT                rngrct;            //stitch range rectangle                                           
//#807    FLPNT                rngsiz;            //from check ranges                                           
//#808    FLPNT                bigsiz;            //size of multiple select rectangle                                           
//#809    unsigned            movpnt;            //for resequencing stitches                                               
//#810    double                pixang;            //angle for pixel rotate                                           
//#811    SIZE                pcolsiz;        //size of the pick color message                                               
//#812    POINT                inspnt;            //size of file insert window                                           
//#813    FLPNT                inscntr;        //center point in inserted file                                               
//#814    unsigned            numcod;            //keyboard numerical input                                               
//#815    double                loang;            //low angle for angle from mark                                           
//#816    double                organg;            //original angle for angle from mark                                           
//#817    double                hiang;            //hi angle for angle from mark                                           
//#818    unsigned            knotab[MAXKNOTS];//pointers to knots                                                           
//#819    unsigned            knotcnt;        //number of knots in the design                                                   
//#820    unsigned            knotat;            //knot stitch attribute                                               
//#821    FLPNT                knotstp;        //knot step                                               
//#822    TCHAR                kstrtdat[]={2,3,1,4,0};    //knot spacings                                                   
//#823    TCHAR                kendat[]={-2,-3,-1,-4,0};    //reverse knot spacings                                                   
//#824    TCHAR                klstdat[]={0,-4,-1,-3,-2};    //reverse knot spacings                                                   
//#825    FLRCT                clprcta;        //rectangle for adjsut range ends for clipboard fills                                               
//#826    TCHAR*                balpnt;            //used in the balarad interface                                           
//#827    HANDLE                balfil;            //balarad file handle                                           
//#828                                                                           
//#829    //graphics variables                                                                       
//#830    double                aspct=(double)LHUPX/LHUPY;    //aspect ratio of the stich window                                                   
//#831    SCROLLINFO            scrol;                        //scrool bar i/o structure                                   
//#832    POINT                stchSiz;                    //size of the stich window in pixels                                   
//#833    FLPNT                sPnt;                        //for converting pixels coordinates                               
//#834                                                    // to stitch cordinates                       
//#835    POINT                cPnt;            //closest point to a mouse click                                           
//#836    FLPNT                zBoxo;            //zoom box origin                                           
//#837                                                                           
//#838    COLORREF defCol[]={                                                                       
//#839                                                                           
//#840        0x000000,                                                                   
//#841        0x800000,                                                                   
//#842        0xFF0000,                                                                   
//#843        0x808000,                                                                   
//#844        0xFFFF00,                                                                   
//#845        0x800080,                                                                   
//#846        0xFF00FF,                                                                   
//#847        0x000080,                                                                   
//#848        0x0000FF,                                                                   
//#849        0x008000,                                                                   
//#850        0x00FF00,                                                                   
//#851        0x008080,                                                                   
//#852        0x00FFFF,                                                                   
//#853        0x808080,                                                                   
//#854        0xC0C0C0,                                                                   
//#855        0xFFFFFF                                                                   
//#856    };                                                                       
//#857                                                                           
//#858    long                selbox;                                                       
//#859    long                boxOff[4];                                                       
//#860                                                                           
//#861    unsigned            defMap=0xaf;    //bitmap for color number colors                                                       
//#862    unsigned            vind;            //vertical index, calculated from mouse click                                               
//#863    unsigned            thrdSel;        //thread selected for size change                                                   
//#864                                                                           
//#865    //file open stuff                                                                       
//#866                                                                           
//#867    MENUITEMINFO filinfo={                                                                       
//#868                                                                           
//#869        sizeof(MENUITEMINFO),                                                                   
//#870        MIIM_TYPE,                                                                   
//#871        MFT_STRING,                                                                   
//#872        0                                                                   
//#873        0                                                                   
//#874        0                                                                   
//#875        0                                                                   
//#876        0                                                                   
//#877        0                                                                   
//#878        msgbuf,                                                                   
//#879        13                                                                   
//#880    };                                                                       
//#881                                                                           
//#882    const TCHAR            fltr[MAX_PATH]=            Thredworks (THR)\0*.thr\0Pfaff (PCS)\0*.pcs\0Tajima (DST)\0*.dst\0\0;                                               
//#883    const TCHAR            bfltr[MAX_PATH]="Microsoft (BMP)\0*.bmp\0\0";                                                           
//#884    TCHAR                cstFltr[MAX_PATH]=    ;                                                   
//#885    TCHAR                filnam[MAX_PATH]={0};                                                       
//#886    TCHAR                thrnam[MAX_PATH];                                                       
//#887    TCHAR                auxnam[MAX_PATH];                                                       
//#888    TCHAR                genam[MAX_PATH];                                                       
//#889    TCHAR                defDir[MAX_PATH]="c:\\";                                                       
//#890    TCHAR                defbmp[MAX_PATH]="c:\\";                                                       
//#891    TCHAR                balnam0[MAX_PATH]={0};    //balarad semaphore file                                                   
//#892    TCHAR                balnam1[MAX_PATH]={0};    //balarad data file                                                   
//#893    TCHAR                balnam2[MAX_PATH];                                                       
//#894    TCHAR                srchnam[MAX_PATH];                                                       
//#895    TCHAR                homdir[MAX_PATH];    //directory from which thred was executed                                                   
//#896    TCHAR*                phom;            //pointer to the home file name                                           
//#897    PCSTCH*                filBuf;                                                       
//#898    HANDLE                hFil=0;                                                       
//#899    HANDLE                hPcs=0;                                                       
//#900    HANDLE                hIni=0;                                                       
//#901    HANDLE                hinsf;            //insert file handle                                           
//#902    HANDLE                hBmp;            //bitmap handle                                           
//#903    unsigned            siz;            //size of file                                               
//#904    unsigned long        red;            //bytes actually read from file                                                   
//#905    unsigned            colCnt;            //number of color changes                                               
//#906    TCHAR                iniNam[MAX_PATH];    //.ini file name                                                   
//#907    unsigned            savcol;            //for saving files                                               
//#908    TCHAR                bnam[16];        //bitmap file name from pcs file                                               
//#909    TCHAR                lbnam[MAX_PATH];//bitmap file name from user load                                                       
//#910    OPENFILENAME        ofn={                                                               
//#911                                                                           
//#912        sizeof(OPENFILENAME),    //lStructsize                                                               
//#913        hWnd,                    //hwndOwner                                                
//#914        hInst,                    //hInstance                                                
//#915        fltr,                    //lpstrFilter                                                
//#916        cstFltr,                //lpstrCustomFilter                                                    
//#917        MAX_PATH,                //nMaxCustFilter                                                    
//#918        0                        //nFilterIndex                                            
//#919        filnam,                    //lpstrFile                                                
//#920        MAX_PATH,                //nMaxFile                                                    
//#921        0                        //lpstrFileTitle                                            
//#922        0                        //nMaxFileTitle                                            
//#923        defDir,                    //lpstr    ialDir                                            
//#924        0                        //lpstrTitle                                           
//#925        OFN_OVERWRITEPROMPT,    //Flags                                                               
//#926        0                        //nFileOffset                                           
//#927        0                        //nFileExtension                                            
//#928        thr,                    //lpstrDefExt                                                
//#929        0                        //lCustData                                            
//#930        0                        //lpfnHook                                           
//#931        0                        //lpTemplateName                                           
//#932        };                                                                   
//#933    TCHAR*                thumnams;                //pointer to storage for thumbnail names                                       
//#934    TCHAR**                pthums;                    //pointers to the thumbnail names                                   
//#935    TCHAR*                thumsel[4];                //pointers to thumbnails selectef for display                                       
//#936    unsigned            thumcnt;                //number of thumbnail file names                                           
//#937    unsigned            thumdcnt;                //number of thumbnail file names selected for display                                           
//#938    unsigned            thumind;                //index into the thumbnail filname table                                           
//#939    TCHAR                thumsrch[32];            //storage for the thumnail search string                                           
//#940    TCHAR                insnam[MAX_PATH]={0};    //insert file name                                                   
//#941    unsigned            insflt;                    //saved float pointer for inserting files                                       
//#942    unsigned            insfpnt;                //saved form pointer for inserting files                                           
//#943    unsigned            insfstch;                //saved stitch pointer for inserting files                                           
//#944                                                                           
//#945    OPENFILENAME obn={                                                                       
//#946        sizeof(OPENFILENAME),    //lStructsize                                                               
//#947        hWnd,                    //hwndOwner                                                
//#948        hInst,                    //hInstance                                                
//#949        bfltr,                    //lpstrFilter                                                
//#950        cstFltr,                //lpstrCustomFilter                                                    
//#951        MAX_PATH,                //nMaxCustFilter                                                    
//#952        0                        //nFilterIndex                                            
//#953        lbnam,                    //lpstrFile                                                
//#954        MAX_PATH,                //nMaxFile                                                    
//#955        0                        //lpstrFileTitle                                            
//#956        0                        //nMaxFileTitle                                            
//#957        defbmp,                    //lpstr    ialDir                                            
//#958        0                        //lpstrTitle                                           
//#959        OFN_OVERWRITEPROMPT,    //Flags                                                               
//#960        0                        //nFileOffset                                           
//#961        0                        //nFileExtension                                            
//#962        bmp,                    //lpstrDefExt                                                
//#963        0                        //lCustData                                            
//#964        0                        //lpfnHook                                           
//#965        0                        //lpTemplateName                                           
//#966    };                                                                       
//#967                                                                           
//#968    BITMAPFILEHEADER    bhed;    //bitmap file header                                                               
//#969    BITMAPV4HEADER        b4hed;    //bitmap version4 file header                                                           
//#970    BITMAPINFO            binf;    //bitmap info                                                       
//#971    BITMAPINFOHEADER    binfh;    //bitmap info header                                                               
//#972                                                                           
//#973    COLORREF defUseCol[]={                                                                       
//#974                                                                           
//#975        0x00000000,                                                                   
//#976        0x002dffff,                                                                   
//#977        0x003f87e9,                                                                   
//#978        0x000762f8,                                                                   
//#979        0x000000ff,                                                                   
//#980        0x002f03af,                                                                   
//#981        0x007248b7,                                                                   
//#982        0x00ff0080,                                                                   
//#983        0x00920166,                                                                   
//#984        0x00a00000,                                                                   
//#985        0x00ff2424,                                                                   
//#986        0x006a4d15,                                                                   
//#987        0x00f5800a,                                                                   
//#988        0x004b7807,                                                                   
//#989        0x00156a1e,                                                                   
//#990        0x00dbe6e3,                                                                   
//#991    };                                                                       
//#992                                                                           
//#993    COLORREF defCustCol[]={                                                                       
//#994                                                                           
//#995        0x729674,                                                                   
//#996        0x1a1eb9,                                                                   
//#997        0x427347,                                                                   
//#998        0xbfff,                                                                   
//#999        0xd3c25f,                                                                   
//#1000        0xc3ced0,                                                                   
//#1001        0x4a8459,                                                                   
//#1002        0x8cacd0,                                                                   
//#1003        0x81aeb6,                                                                   
//#1004        0x7243a5,                                                                   
//#1005        0xbdadda,                                                                   
//#1006        0x9976c5,                                                                   
//#1007        0x96d9f5,                                                                   
//#1008        0xe2ddd6,                                                                   
//#1009        0x245322,                                                                   
//#1010        0x7b60ae                                                                   
//#1011    };                                                                       
//#1012                                                                           
//#1013    COLORREF defBakCust[]={                                                                       
//#1014                                                                           
//#1015        0xa3c5dc,                                                                   
//#1016        0xadc7b6,                                                                   
//#1017        0xd1fcfb,                                                                   
//#1018        0xdcd7c0,                                                                   
//#1019        0xebddcd,                                                                   
//#1020        0xc6b3b3,                                                                   
//#1021        0xdec9ce,                                                                   
//#1022        0xd2d1e9,                                                                   
//#1023        0xdfdffd,                                                                   
//#1024        0xbee6ef,                                                                   
//#1025        0x8fb8b1,                                                                   
//#1026        0x85c2e0,                                                                   
//#1027        0xabc1c9,                                                                   
//#1028        0xd3d3c7,                                                                   
//#1029        0x7c9c84,                                                                   
//#1030        0x9acddc                                                                   
//#1031    };                                                                       
//#1032                                                                           
//#1033    COLORREF defBakBit[]={                                                                       
//#1034                                                                           
//#1035        0xc0d5bf,                                                                   
//#1036        0xc8dfee,                                                                   
//#1037        0x708189,                                                                   
//#1038        0xa5a97a,                                                                   
//#1039        0xb8d6fe,                                                                   
//#1040        0x8a8371,                                                                   
//#1041        0x4b6cb8,                                                                   
//#1042        0x9cdcc2,                                                                   
//#1043        0x366d39,                                                                   
//#1044        0xdcfcfb,                                                                   
//#1045        0x3c4f75,                                                                   
//#1046        0x95b086,                                                                   
//#1047        0xc9dcba,                                                                   
//#1048        0x43377b,                                                                   
//#1049        0xb799ae,                                                                   
//#1050        0x54667a                                                                   
//#1051    };                                                                       
//#1052                                                                           
//#1053    unsigned namloc[]={                                                                       
//#1054                                                                           
//#1055        999    //0                                                               
//#1056        1024    //1                                                               
//#1057        2        //2                                                           
//#1058        2051    //3                                                               
//#1059        2050    //4                                                               
//#1060        5        //5                                                           
//#1061        7        //6                                                           
//#1062        1        //7                                                           
//#1063        17        //8                                                           
//#1064        9        //9                                                           
//#1065        2058    //10                                                               
//#1066        11        //11                                                           
//#1067        51        //12                                                           
//#1068        6        //13                                                           
//#1069        14        //14                                                           
//#1070        2055    //15                                                               
//#1071        8        //16                                                           
//#1072        2056    //17                                                               
//#1073        18        //18                                                           
//#1074        2057    //19                                                               
//#1075        10        //20                                                           
//#1076        21        //21                                                           
//#1077        22        //22                                                           
//#1078        23        //23                                                           
//#1079        99        //24                                                           
//#1080        3075    //25                                                               
//#1081        26        //26                                                           
//#1082        2075    //27                                                               
//#1083        28        //28                                                           
//#1084        2062    //29                                                               
//#1085        30        //30                                                           
//#1086        63        //31                                                           
//#1087        65        //32                                                           
//#1088        132    //33                                                               
//#1089        68        //34                                                           
//#1090        2083    //35                                                               
//#1091        36        //36                                                           
//#1092        37        //37                                                           
//#1093        311    //38                                                               
//#1094        3081    //39                                                               
//#1095        80        //40                                                           
//#1096        41        //41                                                           
//#1097        42        //42                                                           
//#1098        43        //43                                                           
//#1099        1035    //44                                                               
//#1100        1547    //45                                                               
//#1101        3800    //46                                                               
//#1102        47        //47                                                           
//#1103        96        //48                                                           
//#1104        2054    //49                                                               
//#1105    };                                                                       
//#1106                                                                           
//#1107    POINT                mlin0[2];        //move point line                                               
//#1108    POINT                mlin1[2];        //move point line                                               
//#1109    POINT                inlin[3];        //the insert line                                               
//#1110    POINT                blin[5];        //the zoom box                                               
//#1111    POINT                clplin[5];        //for displaying clipboard insert rectangle                                               
//#1112    POINT                rlinb[5];        //for drawing the rotate rectangle                                               
//#1113    POINT                rlinv[2];        //vertical part of the rotate cross                                               
//#1114    POINT                rlinh[2];        //horizontal part of the rotate cross                                               
//#1115    POINT                rlinu[2];        //line from the cursor to the center of the rotate cross                                               
//#1116    POINT                sizlin[5];        //stretch and expand                                               
//#1117                                                                           
//#1118    COLCHNG                colch[MAXCHNG];                                                       
//#1119    HED                    hed;            //pcs file header                                       
//#1120    STREX                hedx;            //thred file header extension                                           
//#1121    INIFIL                ini;            //initialization file                                           
//#1122    DUBPNT                rotcntr;        //center of stitch rotation                                               
//#1123    POINT                pixcntr;        //center of pixel rotation                                               
//#1124                                                                           
//#1125    PCSTCH*                stind;            //stitch pointer                                           
//#1126    void sCor2px(DUBPNT stpnt,POINT* pxpnt);                                                                       
//#1127                                                                           
//#1128    typedef struct _dstdat{                                                                       
//#1129                                                                           
//#1130        TCHAR    cor;                                                               
//#1131        TCHAR    val;                                                               
//#1132    }DSTDAT;                                                                       
//#1133                                                                           
//#1134    #define XCOR 0                                                                       
//#1135    #define YCOR 1                                                                       
//#1136                                                                           
//#1137    DSTDAT    dstval[]={                                                                   
//#1138                                                                           
//#1139        {XCOR,1},                                                                   
//#1140        {XCOR,-1},                                                                   
//#1141        {XCOR,9},                                                                   
//#1142        {XCOR,-9},                                                                   
//#1143        {YCOR,-9},                                                                   
//#1144        {YCOR,9},                                                                   
//#1145        {YCOR,-1},                                                                   
//#1146        {YCOR,1},                                                                   
//#1147        {XCOR,3},                                                                   
//#1148        {XCOR,-3},                                                                   
//#1149        {XCOR,27},                                                                   
//#1150        {XCOR,-27},                                                                   
//#1151        {YCOR,-27},                                                                   
//#1152        {YCOR,27},                                                                   
//#1153        {YCOR,-3},                                                                   
//#1154        {YCOR,3},                                                                   
//#1155        {XCOR,0},                                                                   
//#1156        {XCOR,0},                                                                   
//#1157        {XCOR,81},                                                                   
//#1158        {XCOR,-81},                                                                   
//#1159        {YCOR,-81},                                                                   
//#1160        {YCOR,81},                                                                   
//#1161    };                                                                       
//#1162                                                                           
//#1163    unsigned char rencod[]={        //name decryption table                                                               
//#1164                                                                           
//#1165        0x40,                                                                   
//#1166        0x61,                                                                   
//#1167        0x2,                                                                   
//#1168        0x1,                                                                   
//#1169        0x4,                                                                   
//#1170        0x5,                                                                   
//#1171        0x6,                                                                   
//#1172        0x3c,                                                                   
//#1173        0x8,                                                                   
//#1174        0x12,                                                                   
//#1175        0x15,                                                                   
//#1176        0xb,                                                                   
//#1177        0x18,                                                                   
//#1178        0xd,                                                                   
//#1179        0x1d,                                                                   
//#1180        0x3,                                                                   
//#1181        0x10,                                                                   
//#1182        0x23,                                                                   
//#1183        0x9,                                                                   
//#1184        0x13,                                                                   
//#1185        0x28,                                                                   
//#1186        0xa,                                                                   
//#1187        0x16,                                                                   
//#1188        0x2f,                                                                   
//#1189        0x58,                                                                   
//#1190        0x19,                                                                   
//#1191        0x1a,                                                                   
//#1192        0x1b,                                                                   
//#1193        0x3b,                                                                   
//#1194        0x11,                                                                   
//#1195        0x1e,                                                                   
//#1196        0xf,                                                                   
//#1197        0x68,                                                                   
//#1198        0x41,                                                                   
//#1199        0x22,                                                                   
//#1200        0x63,                                                                   
//#1201        0x48,                                                                   
//#1202        0x4a,                                                                   
//#1203        0x26,                                                                   
//#1204        0x27,                                                                   
//#1205        0x14,                                                                   
//#1206        0x29,                                                                   
//#1207        0x55,                                                                   
//#1208        0x57,                                                                   
//#1209        0x2c,                                                                   
//#1210        0x2d,                                                                   
//#1211        0x6b,                                                                   
//#1212        0x5f,                                                                   
//#1213        0xe,                                                                   
//#1214        0xc,                                                                   
//#1215        0x59,                                                                   
//#1216        0x33,                                                                   
//#1217        0x34,                                                                   
//#1218        0x5a,                                                                   
//#1219        0x76,                                                                   
//#1220        0x37,                                                                   
//#1221        0x70,                                                                   
//#1222        0x73,                                                                   
//#1223        0x50,                                                                   
//#1224        0x5d,                                                                   
//#1225        0x1f,                                                                   
//#1226        0x7b,                                                                   
//#1227        0x7c,                                                                   
//#1228        0x3e,                                                                   
//#1229        0x71,                                                                   
//#1230        0x20,                                                                   
//#1231        0x42,                                                                   
//#1232        0x43,                                                                   
//#1233        0x62,                                                                   
//#1234        0x45,                                                                   
//#1235        0x31,                                                                   
//#1236        0x46,                                                                   
//#1237        0x24,                                                                   
//#1238        0x49,                                                                   
//#1239        0x25,                                                                   
//#1240        0x65,                                                                   
//#1241        0x66,                                                                   
//#1242        0x4d,                                                                   
//#1243        0x4e,                                                                   
//#1244        0x67,                                                                   
//#1245        0x21,                                                                   
//#1246        0x74,                                                                   
//#1247        0x69,                                                                   
//#1248        0x53,                                                                   
//#1249        0x54,                                                                   
//#1250        0x2a,                                                                   
//#1251        0x56,                                                                   
//#1252        0x5c,                                                                   
//#1253        0x30,                                                                   
//#1254        0x32,                                                                   
//#1255        0x35,                                                                   
//#1256        0x6c,                                                                   
//#1257        0x2e,                                                                   
//#1258        0x6d,                                                                   
//#1259        0x5e,                                                                   
//#1260        0x17,                                                                   
//#1261        0x0,                                                                   
//#1262        0x7,                                                                   
//#1263        0x44,                                                                   
//#1264        0x1c,                                                                   
//#1265        0x64,                                                                   
//#1266        0x4b,                                                                   
//#1267        0x4c,                                                                   
//#1268        0x4f,                                                                   
//#1269        0x51,                                                                   
//#1270        0x52,                                                                   
//#1271        0x6a,                                                                   
//#1272        0x75,                                                                   
//#1273        0x47,                                                                   
//#1274        0x5b,                                                                   
//#1275        0x6e,                                                                   
//#1276        0x77,                                                                   
//#1277        0x60,                                                                   
//#1278        0x38,                                                                   
//#1279        0x72,                                                                   
//#1280        0x79,                                                                   
//#1281        0x3a,                                                                   
//#1282        0x2b,                                                                   
//#1283        0x36,                                                                   
//#1284        0x6f,                                                                   
//#1285        0x7f,                                                                   
//#1286        0x39,                                                                   
//#1287        0x7d,                                                                   
//#1288        0x3d,                                                                   
//#1289        0x78,                                                                   
//#1290        0x7a,                                                                   
//#1291        0x3f,                                                                   
//#1292        0x7e,                                                                   
//#1293    };                                                                       
//#1294                                                                           
//#1295    unsigned rdcurstrt[]={0x8,0x18,0x3c,0x7c};                                                                       
//#1296    unsigned rdcurfin[]={0x48000000,0x50000000,0xa0000000,0xc0000000,0x80000000};                                                                       
//#1297    unsigned rucurstrt[]={0x80000000,0xa0000000,0x48000000,0x24000000,0x12000000};                                                                       
//#1298    unsigned rucurfin[]={0x3c,0x1c,0xc};                                                                       
//#1299    unsigned ldcurstrt[]={0x20000000,0x60000000,0xf0000000,0xf8000000};                                                                       
//#1300    unsigned ldcurfin[]={0x44,0x24,0x14,0x6,0x4};                                                                       
//#1301    unsigned lucurstrt[]={0x2,0x6,0x14,0x24,0x44};                                                                       
//#1302    unsigned lucurfin[]={0x70000000,0x30000000,0x20000000};                                                                       
//#1303                                                                           
//#1304    unsigned xdst[]={                                                                       
//#1305                                                                           
//#1306        0x090a0a,    //-121                                                               
//#1307        0x090a08,    //-120                                                               
//#1308        0x090a09,    //-119                                                               
//#1309        0x09080a,    //-118                                                               
//#1310        0x090808,    //-117                                                               
//#1311        0x090809,    //-116                                                               
//#1312        0x09090a,    //-115                                                               
//#1313        0x090908,    //-114                                                               
//#1314        0x090909,    //-113                                                               
//#1315        0x090a02,    //-112                                                               
//#1316        0x090a00,    //-111                                                               
//#1317        0x090a01,    //-110                                                               
//#1318        0x090802,    //-109                                                               
//#1319        0x090800,    //-108                                                               
//#1320        0x090801,    //-107                                                               
//#1321        0x090902,    //-106                                                               
//#1322        0x090900,    //-105                                                               
//#1323        0x090901,    //-104                                                               
//#1324        0x090a06,    //-103                                                               
//#1325        0x090a04,    //-102                                                               
//#1326        0x090a05,    //-101                                                               
//#1327        0x090806,    //-100                                                               
//#1328        0x090804,    //-99                                                               
//#1329        0x090805,    //-98                                                               
//#1330        0x090906,    //-97                                                               
//#1331        0x090904,    //-96                                                               
//#1332        0x090905,    //-95                                                               
//#1333        0x09020a,    //-94                                                               
//#1334        0x090208,    //-93                                                               
//#1335        0x090209,    //-92                                                               
//#1336        0x09000a,    //-91                                                               
//#1337        0x090008,    //-90                                                               
//#1338        0x090009,    //-89                                                               
//#1339        0x09010a,    //-88                                                               
//#1340        0x090108,    //-87                                                               
//#1341        0x090109,    //-86                                                               
//#1342        0x090202,    //-85                                                               
//#1343        0x090200,    //-84                                                               
//#1344        0x090201,    //-83                                                               
//#1345        0x090002,    //-82                                                               
//#1346        0x090000,    //-81                                                               
//#1347        0x090001,    //-80                                                               
//#1348        0x090102,    //-79                                                               
//#1349        0x090100,    //-78                                                               
//#1350        0x090101,    //-77                                                               
//#1351        0x090206,    //-76                                                               
//#1352        0x090204,    //-75                                                               
//#1353        0x090205,    //-74                                                               
//#1354        0x090006,    //-73                                                               
//#1355        0x090004,    //-72                                                               
//#1356        0x090005,    //-71                                                               
//#1357        0x090106,    //-70                                                               
//#1358        0x090104,    //-69                                                               
//#1359        0x090105,    //-68                                                               
//#1360        0x09060a,    //-67                                                               
//#1361        0x090608,    //-66                                                               
//#1362        0x090609,    //-65                                                               
//#1363        0x09040a,    //-64                                                               
//#1364        0x090408,    //-63                                                               
//#1365        0x090409,    //-62                                                               
//#1366        0x09050a,    //-61                                                               
//#1367        0x090508,    //-60                                                               
//#1368        0x090509,    //-59                                                               
//#1369        0x090602,    //-58                                                               
//#1370        0x090600,    //-57                                                               
//#1371        0x090601,    //-56                                                               
//#1372        0x090402,    //-55                                                               
//#1373        0x090400,    //-54                                                               
//#1374        0x090401,    //-53                                                               
//#1375        0x090502,    //-52                                                               
//#1376        0x090500,    //-51                                                               
//#1377        0x090501,    //-50                                                               
//#1378        0x090606,    //-49                                                               
//#1379        0x090604,    //-48                                                               
//#1380        0x090605,    //-47                                                               
//#1381        0x090406,    //-46                                                               
//#1382        0x090404,    //-45                                                               
//#1383        0x090405,    //-44                                                               
//#1384        0x090506,    //-43                                                               
//#1385        0x090504,    //-42                                                               
//#1386        0x090505,    //-41                                                               
//#1387        0x010a0a,    //-40                                                               
//#1388        0x010a08,    //-39                                                               
//#1389        0x010a09,    //-38                                                               
//#1390        0x01080a,    //-37                                                               
//#1391        0x010808,    //-36                                                               
//#1392        0x010809,    //-35                                                               
//#1393        0x01090a,    //-34                                                               
//#1394        0x010908,    //-33                                                               
//#1395        0x010909,    //-32                                                               
//#1396        0x010a02,    //-31                                                               
//#1397        0x010a00,    //-30                                                               
//#1398        0x010a01,    //-29                                                               
//#1399        0x010802,    //-28                                                               
//#1400        0x010800,    //-27                                                               
//#1401        0x010801,    //-26                                                               
//#1402        0x010902,    //-25                                                               
//#1403        0x010900,    //-24                                                               
//#1404        0x010901,    //-23                                                               
//#1405        0x010a06,    //-22                                                               
//#1406        0x010a04,    //-21                                                               
//#1407        0x010a05,    //-20                                                               
//#1408        0x010806,    //-19                                                               
//#1409        0x010804,    //-18                                                               
//#1410        0x010805,    //-17                                                               
//#1411        0x010906,    //-16                                                               
//#1412        0x010904,    //-15                                                               
//#1413        0x010905,    //-14                                                               
//#1414        0x01020a,    //-13                                                               
//#1415        0x010208,    //-12                                                               
//#1416        0x010209,    //-11                                                               
//#1417        0x01000a,    //-10                                                               
//#1418        0x010008,    //-9                                                               
//#1419        0x010009,    //-8                                                               
//#1420        0x01010a,    //-7                                                               
//#1421        0x010108,    //-6                                                               
//#1422        0x010109,    //-5                                                               
//#1423        0x010202,    //-4                                                               
//#1424        0x010200,    //-3                                                               
//#1425        0x010201,    //-2                                                               
//#1426        0x010002,    //-1                                                               
//#1427        0x010000,    //0                                                               
//#1428        0x010001,    //1                                                               
//#1429        0x010102,    //2                                                               
//#1430        0x010100,    //3                                                               
//#1431        0x010101,    //4                                                               
//#1432        0x010206,    //5                                                               
//#1433        0x010204,    //6                                                               
//#1434        0x010205,    //7                                                               
//#1435        0x010006,    //8                                                               
//#1436        0x010004,    //9                                                               
//#1437        0x010005,    //10                                                               
//#1438        0x010106,    //11                                                               
//#1439        0x010104,    //12                                                               
//#1440        0x010105,    //13                                                               
//#1441        0x01060a,    //14                                                               
//#1442        0x010608,    //15                                                               
//#1443        0x010609,    //16                                                               
//#1444        0x01040a,    //17                                                               
//#1445        0x010408,    //18                                                               
//#1446        0x010409,    //19                                                               
//#1447        0x01050a,    //20                                                               
//#1448        0x010508,    //21                                                               
//#1449        0x010509,    //22                                                               
//#1450        0x010602,    //23                                                               
//#1451        0x010600,    //24                                                               
//#1452        0x010601,    //25                                                               
//#1453        0x010402,    //26                                                               
//#1454        0x010400,    //27                                                               
//#1455        0x010401,    //28                                                               
//#1456        0x010502,    //29                                                               
//#1457        0x010500,    //30                                                               
//#1458        0x010501,    //31                                                               
//#1459        0x010606,    //32                                                               
//#1460        0x010604,    //33                                                               
//#1461        0x010605,    //34                                                               
//#1462        0x010406,    //35                                                               
//#1463        0x010404,    //36                                                               
//#1464        0x010405,    //37                                                               
//#1465        0x010506,    //38                                                               
//#1466        0x010504,    //39                                                               
//#1467        0x010505,    //40                                                               
//#1468        0x050a0a,    //41                                                               
//#1469        0x050a08,    //42                                                               
//#1470        0x050a09,    //43                                                               
//#1471        0x05080a,    //44                                                               
//#1472        0x050808,    //45                                                               
//#1473        0x050809,    //46                                                               
//#1474        0x05090a,    //47                                                               
//#1475        0x050908,    //48                                                               
//#1476        0x050909,    //49                                                               
//#1477        0x050a02,    //50                                                               
//#1478        0x050a00,    //51                                                               
//#1479        0x050a01,    //52                                                               
//#1480        0x050802,    //53                                                               
//#1481        0x050800,    //54                                                               
//#1482        0x050801,    //55                                                               
//#1483        0x050902,    //56                                                               
//#1484        0x050900,    //57                                                               
//#1485        0x050901,    //58                                                               
//#1486        0x050a06,    //59                                                               
//#1487        0x050a04,    //60                                                               
//#1488        0x050a05,    //61                                                               
//#1489        0x050806,    //62                                                               
//#1490        0x050804,    //63                                                               
//#1491        0x050805,    //64                                                               
//#1492        0x050906,    //65                                                               
//#1493        0x050904,    //66                                                               
//#1494        0x050905,    //67                                                               
//#1495        0x05020a,    //68                                                               
//#1496        0x050208,    //69                                                               
//#1497        0x050209,    //70                                                               
//#1498        0x05000a,    //71                                                               
//#1499        0x050008,    //72                                                               
//#1500        0x050009,    //73                                                               
//#1501        0x05010a,    //74                                                               
//#1502        0x050108,    //75                                                               
//#1503        0x050109,    //76                                                               
//#1504        0x050202,    //77                                                               
//#1505        0x050200,    //78                                                               
//#1506        0x050201,    //79                                                               
//#1507        0x050002,    //80                                                               
//#1508        0x050000,    //81                                                               
//#1509        0x050001,    //82                                                               
//#1510        0x050102,    //83                                                               
//#1511        0x050100,    //84                                                               
//#1512        0x050101,    //85                                                               
//#1513        0x050206,    //86                                                               
//#1514        0x050204,    //87                                                               
//#1515        0x050205,    //88                                                               
//#1516        0x050006,    //89                                                               
//#1517        0x050004,    //90                                                               
//#1518        0x050005,    //91                                                               
//#1519        0x050106,    //92                                                               
//#1520        0x050104,    //93                                                               
//#1521        0x050105,    //94                                                               
//#1522        0x05060a,    //95                                                               
//#1523        0x050608,    //96                                                               
//#1524        0x050609,    //97                                                               
//#1525        0x05040a,    //98                                                               
//#1526        0x050408,    //99                                                               
//#1527        0x050409,    //100                                                               
//#1528        0x05050a,    //101                                                               
//#1529        0x050508,    //102                                                               
//#1530        0x050509,    //103                                                               
//#1531        0x050602,    //104                                                               
//#1532        0x050600,    //105                                                               
//#1533        0x050601,    //106                                                               
//#1534        0x050402,    //107                                                               
//#1535        0x050400,    //108                                                               
//#1536        0x050401,    //109                                                               
//#1537        0x050502,    //110                                                               
//#1538        0x050500,    //111                                                               
//#1539        0x050501,    //112                                                               
//#1540        0x050606,    //113                                                               
//#1541        0x050604,    //114                                                               
//#1542        0x050605,    //115                                                               
//#1543        0x050406,    //116                                                               
//#1544        0x050404,    //117                                                               
//#1545        0x050405,    //118                                                               
//#1546        0x050506,    //119                                                               
//#1547        0x050504,    //120                                                               
//#1548        0x050505,    //121                                                               
//#1549    };                                                                       
//#1550                                                                           
//#1551    unsigned ydst[]={                                                                       
//#1552                                                                           
//#1553        0x115050,    //-121                                                               
//#1554        0x115010,    //-120                                                               
//#1555        0x115090,    //-119                                                               
//#1556        0x111050,    //-118                                                               
//#1557        0x111010,    //-117                                                               
//#1558        0x111090,    //-116                                                               
//#1559        0x119050,    //-115                                                               
//#1560        0x119010,    //-114                                                               
//#1561        0x119090,    //-113                                                               
//#1562        0x115040,    //-112                                                               
//#1563        0x115000,    //-111                                                               
//#1564        0x115080,    //-110                                                               
//#1565        0x111040,    //-109                                                               
//#1566        0x111000,    //-108                                                               
//#1567        0x111080,    //-107                                                               
//#1568        0x119040,    //-106                                                               
//#1569        0x119000,    //-105                                                               
//#1570        0x119080,    //-104                                                               
//#1571        0x115060,    //-103                                                               
//#1572        0x115020,    //-102                                                               
//#1573        0x1150a0,    //-101                                                               
//#1574        0x111060,    //-100                                                               
//#1575        0x111020,    //-99                                                               
//#1576        0x1110a0,    //-98                                                               
//#1577        0x119060,    //-97                                                               
//#1578        0x119020,    //-96                                                               
//#1579        0x1190a0,    //-95                                                               
//#1580        0x114050,    //-94                                                               
//#1581        0x114010,    //-93                                                               
//#1582        0x114090,    //-92                                                               
//#1583        0x110050,    //-91                                                               
//#1584        0x110010,    //-90                                                               
//#1585        0x110090,    //-89                                                               
//#1586        0x118050,    //-88                                                               
//#1587        0x118010,    //-87                                                               
//#1588        0x118090,    //-86                                                               
//#1589        0x114040,    //-85                                                               
//#1590        0x114000,    //-84                                                               
//#1591        0x114080,    //-83                                                               
//#1592        0x110040,    //-82                                                               
//#1593        0x110000,    //-81                                                               
//#1594        0x110080,    //-80                                                               
//#1595        0x118040,    //-79                                                               
//#1596        0x118000,    //-78                                                               
//#1597        0x118080,    //-77                                                               
//#1598        0x114060,    //-76                                                               
//#1599        0x114020,    //-75                                                               
//#1600        0x1140a0,    //-74                                                               
//#1601        0x110060,    //-73                                                               
//#1602        0x110020,    //-72                                                               
//#1603        0x1100a0,    //-71                                                               
//#1604        0x118060,    //-70                                                               
//#1605        0x118020,    //-69                                                               
//#1606        0x1180a0,    //-68                                                               
//#1607        0x116050,    //-67                                                               
//#1608        0x116010,    //-66                                                               
//#1609        0x116090,    //-65                                                               
//#1610        0x112050,    //-64                                                               
//#1611        0x112010,    //-63                                                               
//#1612        0x112090,    //-62                                                               
//#1613        0x11a050,    //-61                                                               
//#1614        0x11a010,    //-60                                                               
//#1615        0x11a090,    //-59                                                               
//#1616        0x116040,    //-58                                                               
//#1617        0x116000,    //-57                                                               
//#1618        0x116080,    //-56                                                               
//#1619        0x112040,    //-55                                                               
//#1620        0x112000,    //-54                                                               
//#1621        0x112080,    //-53                                                               
//#1622        0x11a040,    //-52                                                               
//#1623        0x11a000,    //-51                                                               
//#1624        0x11a080,    //-50                                                               
//#1625        0x116060,    //-49                                                               
//#1626        0x116020,    //-48                                                               
//#1627        0x1160a0,    //-47                                                               
//#1628        0x112060,    //-46                                                               
//#1629        0x112020,    //-45                                                               
//#1630        0x1120a0,    //-44                                                               
//#1631        0x11a060,    //-43                                                               
//#1632        0x11a020,    //-42                                                               
//#1633        0x11a0a0,    //-41                                                               
//#1634        0x015050,    //-40                                                               
//#1635        0x015010,    //-39                                                               
//#1636        0x015090,    //-38                                                               
//#1637        0x011050,    //-37                                                               
//#1638        0x011010,    //-36                                                               
//#1639        0x011090,    //-35                                                               
//#1640        0x019050,    //-34                                                               
//#1641        0x019010,    //-33                                                               
//#1642        0x019090,    //-32                                                               
//#1643        0x015040,    //-31                                                               
//#1644        0x015000,    //-30                                                               
//#1645        0x015080,    //-29                                                               
//#1646        0x011040,    //-28                                                               
//#1647        0x011000,    //-27                                                               
//#1648        0x011080,    //-26                                                               
//#1649        0x019040,    //-25                                                               
//#1650        0x019000,    //-24                                                               
//#1651        0x019080,    //-23                                                               
//#1652        0x015060,    //-22                                                               
//#1653        0x015020,    //-21                                                               
//#1654        0x0150a0,    //-20                                                               
//#1655        0x011060,    //-19                                                               
//#1656        0x011020,    //-18                                                               
//#1657        0x0110a0,    //-17                                                               
//#1658        0x019060,    //-16                                                               
//#1659        0x019020,    //-15                                                               
//#1660        0x0190a0,    //-14                                                               
//#1661        0x014050,    //-13                                                               
//#1662        0x014010,    //-12                                                               
//#1663        0x014090,    //-11                                                               
//#1664        0x010050,    //-10                                                               
//#1665        0x010010,    //-9                                                               
//#1666        0x010090,    //-8                                                               
//#1667        0x018050,    //-7                                                               
//#1668        0x018010,    //-6                                                               
//#1669        0x018090,    //-5                                                               
//#1670        0x014040,    //-4                                                               
//#1671        0x014000,    //-3                                                               
//#1672        0x014080,    //-2                                                               
//#1673        0x010040,    //-1                                                               
//#1674        0x010000,    //0                                                               
//#1675        0x010080,    //1                                                               
//#1676        0x018040,    //2                                                               
//#1677        0x018000,    //3                                                               
//#1678        0x018080,    //4                                                               
//#1679        0x014060,    //5                                                               
//#1680        0x014020,    //6                                                               
//#1681        0x0140a0,    //7                                                               
//#1682        0x010060,    //8                                                               
//#1683        0x010020,    //9                                                               
//#1684        0x0100a0,    //10                                                               
//#1685        0x018060,    //11                                                               
//#1686        0x018020,    //12                                                               
//#1687        0x0180a0,    //13                                                               
//#1688        0x016050,    //14                                                               
//#1689        0x016010,    //15                                                               
//#1690        0x016090,    //16                                                               
//#1691        0x012050,    //17                                                               
//#1692        0x012010,    //18                                                               
//#1693        0x012090,    //19                                                               
//#1694        0x01a050,    //20                                                               
//#1695        0x01a010,    //21                                                               
//#1696        0x01a090,    //22                                                               
//#1697        0x016040,    //23                                                               
//#1698        0x016000,    //24                                                               
//#1699        0x016080,    //25                                                               
//#1700        0x012040,    //26                                                               
//#1701        0x012000,    //27                                                               
//#1702        0x012080,    //28                                                               
//#1703        0x01a040,    //29                                                               
//#1704        0x01a000,    //30                                                               
//#1705        0x01a080,    //31                                                               
//#1706        0x016060,    //32                                                               
//#1707        0x016020,    //33                                                               
//#1708        0x0160a0,    //34                                                               
//#1709        0x012060,    //35                                                               
//#1710        0x012020,    //36                                                               
//#1711        0x0120a0,    //37                                                               
//#1712        0x01a060,    //38                                                               
//#1713        0x01a020,    //39                                                               
//#1714        0x01a0a0,    //40                                                               
//#1715        0x215050,    //41                                                               
//#1716        0x215010,    //42                                                               
//#1717        0x215090,    //43                                                               
//#1718        0x211050,    //44                                                               
//#1719        0x211010,    //45                                                               
//#1720        0x211090,    //46                                                               
//#1721        0x219050,    //47                                                               
//#1722        0x219010,    //48                                                               
//#1723        0x219090,    //49                                                               
//#1724        0x215040,    //50                                                               
//#1725        0x215000,    //51                                                               
//#1726        0x215080,    //52                                                               
//#1727        0x211040,    //53                                                               
//#1728        0x211000,    //54                                                               
//#1729        0x211080,    //55                                                               
//#1730        0x219040,    //56                                                               
//#1731        0x219000,    //57                                                               
//#1732        0x219080,    //58                                                               
//#1733        0x215060,    //59                                                               
//#1734        0x215020,    //60                                                               
//#1735        0x2150a0,    //61                                                               
//#1736        0x211060,    //62                                                               
//#1737        0x211020,    //63                                                               
//#1738        0x2110a0,    //64                                                               
//#1739        0x219060,    //65                                                               
//#1740        0x219020,    //66                                                               
//#1741        0x2190a0,    //67                                                               
//#1742        0x214050,    //68                                                               
//#1743        0x214010,    //69                                                               
//#1744        0x214090,    //70                                                               
//#1745        0x210050,    //71                                                               
//#1746        0x210010,    //72                                                               
//#1747        0x210090,    //73                                                               
//#1748        0x218050,    //74                                                               
//#1749        0x218010,    //75                                                               
//#1750        0x218090,    //76                                                               
//#1751        0x214040,    //77                                                               
//#1752        0x214000,    //78                                                               
//#1753        0x214080,    //79                                                               
//#1754        0x210040,    //80                                                               
//#1755        0x210000,    //81                                                               
//#1756        0x210080,    //82                                                               
//#1757        0x218040,    //83                                                               
//#1758        0x218000,    //84                                                               
//#1759        0x218080,    //85                                                               
//#1760        0x214060,    //86                                                               
//#1761        0x214020,    //87                                                               
//#1762        0x2140a0,    //88                                                               
//#1763        0x210060,    //89                                                               
//#1764        0x210020,    //90                                                               
//#1765        0x2100a0,    //91                                                               
//#1766        0x218060,    //92                                                               
//#1767        0x218020,    //93                                                               
//#1768        0x2180a0,    //94                                                               
//#1769        0x216050,    //95                                                               
//#1770        0x216010,    //96                                                               
//#1771        0x216090,    //97                                                               
//#1772        0x212050,    //98                                                               
//#1773        0x212010,    //99                                                               
//#1774        0x212090,    //100                                                               
//#1775        0x21a050,    //101                                                               
//#1776        0x21a010,    //102                                                               
//#1777        0x21a090,    //103                                                               
//#1778        0x216040,    //104                                                               
//#1779        0x216000,    //105                                                               
//#1780        0x216080,    //106                                                               
//#1781        0x212040,    //107                                                               
//#1782        0x212000,    //108                                                               
//#1783        0x212080,    //109                                                               
//#1784        0x21a040,    //110                                                               
//#1785        0x21a000,    //111                                                               
//#1786        0x21a080,    //112                                                               
//#1787        0x216060,    //113                                                               
//#1788        0x216020,    //114                                                               
//#1789        0x2160a0,    //115                                                               
//#1790        0x212060,    //116                                                               
//#1791        0x212020,    //117                                                               
//#1792        0x2120a0,    //118                                                               
//#1793        0x21a060,    //119                                                               
//#1794        0x21a020,    //120                                                               
//#1795        0x21a0a0,    //121                                                               
//#1796    };                                                                       
//#1797                                                                           
//#1798    #if PESACT                                                                       
//#1799                                                                           
//#1800    unsigned pestrn[]={                                                                       
//#1801                                                                           
//#1802        0xf0f0f0, //00                                                                    
//#1803        0x940a1a, //01                                                                    
//#1804        0xff750f, //02                                                                    
//#1805        0x4c9300, //03                                                                    
//#1806        0xfebdba, //04                                                                    
//#1807        0x0000ec, //05                                                                    
//#1808        0x5a99e4, //06                                                                    
//#1809        0xab48cc, //07                                                                    
//#1810        0xfac4fd, //08                                                                    
//#1811        0xcd84dd, //09                                                                    
//#1812        0x8ad36b, //10                                                                    
//#1813        0x45a9e4, //11                                                                    
//#1814        0x42bdff, //12                                                                    
//#1815        0x00e6ff, //13                                                                    
//#1816        0x00d96c, //14                                                                    
//#1817        0x41a9c1, //15                                                                    
//#1818        0x97adb5, //16                                                                    
//#1819        0x5f9cba, //17                                                                    
//#1820        0x9ef5fa, //18                                                                    
//#1821        0x808080, //19                                                                    
//#1822        0x000000, //20                                                                   
//#1823        0xdf1c00, //21                                                                    
//#1824        0xb800df, //22                                                                    
//#1825        0x626262, //23                                                                    
//#1826        0x0d2669, //24                                                                    
//#1827        0x6000ff, //25                                                                    
//#1828        0x0082bf, //26                                                                    
//#1829        0x7891f3, //27                                                                    
//#1830        0x0568ff, //28                                                                    
//#1831        0xf0f0f0, //29                                                                    
//#1832        0xcd32c8, //30                                                                    
//#1833        0x9bbfb0, //31                                                                    
//#1834        0xebbf65, //32                                                                    
//#1835        0x04baff, //33                                                                    
//#1836        0x6cf0ff, //34                                                                    
//#1837        0x15cafe, //35                                                                    
//#1838        0x0181f3, //36                                                                    
//#1839        0x23a937, //37                                                                    
//#1840        0x5f4623, //38                                                                    
//#1841        0x95a6a6, //39                                                                    
//#1842        0xa6bfce, //40                                                                    
//#1843        0x02aa96, //41                                                                    
//#1844        0xc6e3ff, //42                                                                    
//#1845        0xd799ff, //43                                                                    
//#1846        0x047000, //44                                                                    
//#1847        0xfbcced, //45                                                                    
//#1848        0xd889c0, //46                                                                    
//#1849        0xb4d9e7, //47                                                                    
//#1850        0x860ee9, //48                                                                    
//#1851        0x2968cf, //49                                                                    
//#1852        0x158640, //50                                                                    
//#1853        0x9717db, //51                                                                    
//#1854        0x04a7ff, //52                                                                    
//#1855        0xffffb9, //53                                                                    
//#1856        0x278922, //54                                                                    
//#1857        0xcd12b6, //55                                                                    
//#1858        0x00aa00, //56                                                                    
//#1859        0xdca9fe, //57                                                                    
//#1860        0x10d5fe, //58                                                                    
//#1861        0xdf9700, //59                                                                    
//#1862        0x84ffff, //60                                                                    
//#1863        0x74e7cf, //61                                                                    
//#1864        0x42bdff, //62                                                                    
//#1865        0xb4d9e7  //63                                                                    
//#1866    };                                                                       
//#1867    #endif                                                                       
//#1868                                                                           
//#1869    DSTREC*        drecs;        //pointer to dst stitch records                                                       
//#1870    unsigned    dstcnt;        //number of dst stitch records                                                           
//#1871    unsigned    trinum;        //for trinary/binary translation                                                           
//#1872    POINT        dstplus;    //plus offset written into the dst file header                                                           
//#1873    POINT        dstmin;        //minus offset written into the dst file header                                                       
//#1874                                                                           
//#1875    //bitmap for upper case characters                                                                       
//#1876    unsigned upmap[]={                                                                       
//#1877                                                                           
//#1878                //fedcba9876543210fedcba9876543210                                                           
//#1879    0            //00000000000000000000000000000000                                                           
//#1880                //?>=</:9876543210 /.-,+*)('&%$#"!                                                           
//#1881    0            //00000000000000000000000000000000                                                           
//#1882                //_^]\[ZYXWVUTSRQPONMLKJIHGFEDCBA@                                                           
//#1883    0x07fffffe,    //00000111111111111111111111111110                                                                   
//#1884                // ~}|{zyxwvutsrqponmlkjihgfedcba'                                                           
//#1885    0            //00000000000000000000000000000000                                                           
//#1886    };                                                                       
//#1887                                                                           
//#1888    unsigned            map[MAPLEN];    //bitmap                                                       
//#1889    unsigned            umap=0;            //for storage of persistent binary variables set by the user                                               
//#1890                                                                           
//#1891    SHRTPNT                stchs[MAXPCS];    //main stitch buffer                                                   
//#1892    SHRTPNT*            sind;            //stitch pointer for saving file                                               
//#1893    SHRTPNT                clpnu[MAXSEQ];    //for temporary copy of imported clipboard data                                                   
//#1894    FRMHED*                frmpnt;            //pointer to selected form                                           
//#1895    unsigned            filtyps[]=        //fill type array for side window display                                                   
//#1896    {0,VRTF,HORF,ANGF,SATF,CLPF,CONTF,VCLPF,HCLPF,ANGCLPF,FTHF,TXVRTF,TXHORF,TXANGF};                                                                       
//#1897    //edge fill type array for side window display                                                                       
//#1898    unsigned            egtyps[]={0,EGLIN,EGBLD,EGCLP,EGSAT,EGAP,EGPRP,EGHOL,EGPIC,EGDUB,EGCHNL,EGCHNH,EGCLPX};                                                            
//#1899    //feather fill types                                                                       
//#1900    unsigned            fthtyps[]={FTHSIN,FTHSIN2,FTHLIN,FTHPSG,FTHRMP,FTHFAZ};                                                           
//#1901                                                                           
//#1902    //bitmap functions

function setMap(bPnt: DWORD):DWORD;
label  setx;
//#1903    unsigned setMap(unsigned bPnt){
//#1904
begin //asm
//#1905        _asm{
//#1906
//#1907                xor        eax,eax
//#1908                mov        ebx,offset map
//#1909                mov        ecx,bPnt
//#1910                bts        [ebx],ecx
//#1911                jnc        short setx
//#1912                dec        eax
//#1913    setx:
//#1914        }
//#1915    #pragma warning(disable:4035;once:)
//#1916    }
//#1917

{

                xor        eax,eax;
                mov        ebx,offset map;
                mov        ecx,bPnt;
                bts        [ebx],ecx;
                jnc        short setx;
                dec        eax
    setx:}
end;
//#1918    void clrMap(unsigned len){
//#1919
//#1920        _asm{
//#1921                                                                           
//#1922                mov        edi,offset map                                                   
//#1923                mov        ecx,len                                                   
//#1924                xor        eax,eax                                                   
//#1925                rep        stosd                                                   
//#1926        }                                                                   
//#1927    }                                                                       
//#1928                                                                           
//#1929    unsigned rstMap(unsigned bPnt){                                                                       
//#1930                                                                           
//#1931        _asm{                                                                   
//#1932                                                                           
//#1933                xor        eax,eax                                                   
//#1934                mov        ebx,offset map                                                   
//#1935                mov        ecx,bPnt                                                   
//#1936                btr        [ebx],ecx                                                   
//#1937                jnc        short rstx                                                   
//#1938                dec        eax                                                   
//#1939    rstx:                                                                       
//#1940        }                                                                   
//#1941    #pragma warning(disable:4035;once:)                                                                       
//#1942    }                                                                       
//#1943                                                                           
//#1944    unsigned toglMap(unsigned bPnt){                                                                       
//#1945                                                                           
//#1946        _asm{                                                                   
//#1947                                                                           
//#1948                xor        eax,eax                                                   
//#1949                mov        ebx,offset map                                                   
//#1950                mov        edx,bPnt                                                   
//#1951                btc        [ebx],edx                                                   
//#1952                jnc        short toglx                                                   
//#1953                dec        eax                                                   
//#1954    toglx:                                                                       
//#1955    #pragma warning(disable:4035;once:)                                                                       
//#1956        }                                                                   
//#1957    }                                                                       
//#1958                                                                           
//#1959    unsigned chkMap(unsigned bPnt){                                                                       
//#1960                                                                           
//#1961        _asm{                                                                   
//#1962                                                                           
//#1963                xor        eax,eax                                                   
//#1964                mov        ebx,offset map                                                   
//#1965                mov        edx,bPnt                                                   
//#1966                bt        [ebx],edx                                                   
//#1967                jnc        short chkx                                                   
//#1968                dec        eax                                                   
//#1969    chkx:                                                                       
//#1970    #pragma warning(disable:4035;once:)                                                                       
//#1971        }                                                                   
//#1972    }                                                                       
//#1973                                                                           
//#1974    void cpymap(unsigned dst,unsigned src){                                                                       
//#1975                                                                           
//#1976        _asm{                                                                   
//#1977                                                                           
//#1978                mov        ebx,offset map                                                   
//#1979                mov        eax,dst                                                   
//#1980                btr        [ebx],eax                                                   
//#1981                mov        edx,src                                                   
//#1982                bt        [ebx],edx                                                   
//#1983                jnc        short cpx                                                   
//#1984                bts        [ebx],eax                                                   
//#1985    cpx:                                                                       
//#1986        }                                                                   
//#1987    }                                                                       
//#1988                                                                           
//#1989    //user bitmap functions                                                                       
//#1990    unsigned setu(unsigned bPnt){                                                                       
//#1991                                                                           
//#1992        _asm{                                                                   
//#1993                                                                           
//#1994                xor        eax,eax                                                   
//#1995                mov        ebx,offset umap                                                   
//#1996                mov        ecx,bPnt                                                   
//#1997                bts        [ebx],ecx                                                   
//#1998                jnc        short setx                                                   
//#1999                dec        eax                                                   
//#2000    setx:                                                                       
//#2001        }                                                                   
//#2002    #pragma warning(disable:4035;once:)                                                                       
//#2003    }                                                                       
//#2004                                                                           
//#2005    unsigned rstu(unsigned bPnt){                                                                       
//#2006                                                                           
//#2007        _asm{                                                                   
//#2008                                                                           
//#2009                xor        eax,eax                                                   
//#2010                mov        ebx,offset umap                                                   
//#2011                mov        ecx,bPnt                                                   
//#2012                btr        [ebx],ecx                                                   
//#2013                jnc        short rstx                                                   
//#2014                dec        eax                                                   
//#2015    rstx:                                                                       
//#2016        }                                                                   
//#2017    #pragma warning(disable:4035;once:)                                                                       
//#2018    }                                                                       
//#2019                                                                           
//#2020    unsigned chku(unsigned bPnt){                                                                       
//#2021                                                                           
//#2022        _asm{                                                                   
//#2023                                                                           
//#2024                xor        eax,eax                                                   
//#2025                mov        ebx,offset umap                                                   
//#2026                mov        edx,bPnt                                                   
//#2027                bt        [ebx],edx                                                   
//#2028                jnc        short chkx                                                   
//#2029                dec        eax                                                   
//#2030    chkx:                                                                       
//#2031    #pragma warning(disable:4035;once:)                                                                       
//#2032        }                                                                   
//#2033    }                                                                       
//#2034                                                                           
//#2035    unsigned toglu(unsigned bPnt){                                                                       
//#2036                                                                           
//#2037        _asm{                                                                   
//#2038                                                                           
//#2039                xor        eax,eax                                                   
//#2040                mov        ebx,offset umap                                                   
//#2041                mov        edx,bPnt                                                   
//#2042                btc        [ebx],edx                                                   
//#2043                jnc        short toglx                                                   
//#2044                dec        eax                                                   
//#2045    toglx:                                                                       
//#2046    #pragma warning(disable:4035;once:)                                                                       
//#2047        }                                                                   
//#2048    }                                                                       
//#2049                                                                           
//#2050    unsigned dumsk(unsigned pnt){                                                                       
//#2051                                                                           
//#2052        _asm{                                                                   
//#2053                                                                           
//#2054                mov        eax,pnt                                                   
//#2055                and        al,31                                                   
//#2056                mov        cl,32                                                   
//#2057                sub        cl,al                                                   
//#2058                xor        eax,eax                                                   
//#2059                inc        eax                                                   
//#2060                shl        eax,cl                                                   
//#2061                dec        eax                                                   
//#2062                not        eax                                                   
//#2063                bswap    eax                                                       
//#2064        }                                                                   
//#2065    }                                                                       
//#2066                                                                           
//#2067    BOOL CALLBACK dnamproc(HWND hwndlg,UINT umsg,WPARAM wparam,LPARAM lparam)                                                                       
//#2068    {                                                                       
//#2069        HWND hwnd;                                                                   
//#2070        switch(umsg)                                                                   
//#2071        {                                                                   
//#2072        case WM_INITDIALOG:                                                                   
//#2073                                                                           
//#2074            hwnd=GetDlgItem(hwndlg,IDC_DESED);                                                               
//#2075            SetWindowText(hwnd,ini.desnam);                                                               
//#2076            SetFocus(hwnd);                                                               
//#2077            SendMessage(hwnd,EM_SETSEL,0,-1);                                                               
//#2078            break;                                                               
//#2079                                                                           
//#2080        case WM_COMMAND:                                                                   
//#2081                                                                           
//#2082            switch(LOWORD(wparam))                                                               
//#2083            {                                                               
//#2084            case IDCANCEL:                                                               
//#2085                                                                           
//#2086                EndDialog(hwndlg,0);                                                            
//#2087                return TRUE;                                                           
//#2088                                                                           
//#2089            case IDOK:                                                               
//#2090                                                                           
//#2091                hwnd=GetDlgItem(hwndlg,IDC_DESED);                                                           
//#2092                GetWindowText(hwnd,ini.desnam,50);                                                           
//#2093                EndDialog(hwndlg,0);                                                           
//#2094                sprintf(msgbuf,stab[STR_THRED],ini.desnam);                                                           
//#2095                SetWindowText(hWnd,msgbuf);                                                           
//#2096                return TRUE;                                                           
//#2097            }                                                               
//#2098        }                                                                   
//#2099        return 0;                                                                   
//#2100    }                                                                       
//#2101                                                                           
//#2102    void getdes()                                                                       
//#2103    {                                                                       
//#2104         DialogBox(hInst,MAKEINTRESOURCE(IDD_DESNAM),hWnd,(DLGPROC)dnamproc);                                                                   
//#2105    }                                                                       
//#2106                                                                           
//#2107    void ler(){                                                                       
//#2108                                                                           
//#2109        per=strerror(GetLastError());                                                                   
//#2110    }                                                                       
//#2111                                                                           
//#2112    BOOL isclp(unsigned find){                                                                       
//#2113                                                                           
//#2114        if((1<<formlst[find].ftyp)&clpmap)                                                                   
//#2115            return 1;                                                               
//#2116        return 0;                                                                   
//#2117    }                                                                       
//#2118                                                                           
//#2119    BOOL isclpx(unsigned find){                                                                       
//#2120                                                                           
//#2121        if(isclp(find)&&formlst[find].flencnt.nclp)                                                                   
//#2122            return 1;                                                               
//#2123        return 0;                                                                   
//#2124    }                                                                       
//#2125                                                                           
//#2126    BOOL isfclp(){                                                                       
//#2127                                                                           
//#2128        if(isclp(clofind)&&formlst[clofind].ftyp!=CLPF)                                                                   
//#2129            return 1;                                                               
//#2130        return 0;                                                                   
//#2131    }                                                                       
//#2132                                                                           
//#2133    BOOL iseclp(unsigned find){                                                                       
//#2134                                                                           
//#2135        if(formlst[find].etyp==EGCLP||formlst[find].etyp==EGPIC||formlst[find].etyp==EGCLPX)                                                                   
//#2136            return 1;                                                               
//#2137        return 0;                                                                   
//#2138    }                                                                       
//#2139                                                                           
//#2140    BOOL iseclpx(unsigned find){                                                                       
//#2141                                                                           
//#2142        if(iseclp(find)&&formlst[find].nclp)                                                                   
//#2143            return 1;                                                               
//#2144        return 0;                                                                   
//#2145    }                                                                       
//#2146                                                                           
//#2147    double stlen(unsigned stind){                                                                       
//#2148                                                                           
//#2149        return hypot(stchs[stind+1].x-stchs[stind].x,stchs[stind+1].y-stchs[stind].y);                                                                   
//#2150    }                                                                       
//#2151                                                                           
//#2152    void undat(){                                                                       
//#2153                                                                           
//#2154        if(hfdat){                                                                   
//#2155                                                                           
//#2156            DestroyWindow(hfdat);                                                               
//#2157            hfdat=0;                                                               
//#2158        }                                                                   
//#2159    }                                                                       
//#2160                                                                           
//#2161    void qchk(){                                                                       
//#2162                                                                           
//#2163        if(chku(MARQ)){                                                                   
//#2164                                                                           
//#2165            CheckMenuItem(hMen,ID_MARKESC,MF_CHECKED);                                                               
//#2166            CheckMenuItem(hMen,ID_MARKQ,MF_UNCHECKED);                                                               
//#2167        }                                                                   
//#2168        else{                                                                   
//#2169                                                                           
//#2170            CheckMenuItem(hMen,ID_MARKESC,MF_UNCHECKED);                                                               
//#2171            CheckMenuItem(hMen,ID_MARKQ,MF_CHECKED);                                                               
//#2172        }                                                                   
//#2173        setMap(DUMEN);                                                                   
//#2174    }                                                                       
//#2175                                                                           
//#2176    void nedmen(){                                                                       
//#2177                                                                           
//#2178        if(chku(NEDOF)){                                                                   
//#2179                                                                           
//#2180            CheckMenuItem(hMen,ID_SETNEDL,MF_UNCHECKED);                                                               
//#2181            CheckMenuItem(hMen,ID_RSTNEDL,MF_CHECKED);                                                               
//#2182        }                                                                   
//#2183        else{                                                                   
//#2184                                                                           
//#2185            CheckMenuItem(hMen,ID_SETNEDL,MF_CHECKED);                                                               
//#2186            CheckMenuItem(hMen,ID_RSTNEDL,MF_UNCHECKED);                                                               
//#2187        }                                                                   
//#2188        setMap(DUMEN);                                                                   
//#2189    }                                                                       
//#2190                                                                           
//#2191    void knotmen(){                                                                       
//#2192                                                                           
//#2193        if(chku(KNOTOF)){                                                                   
//#2194                                                                           
//#2195            CheckMenuItem(hMen,ID_KNOTON,MF_UNCHECKED);                                                               
//#2196            CheckMenuItem(hMen,ID_KNOTOF,MF_CHECKED);                                                               
//#2197        }                                                                   
//#2198        else{                                                                   
//#2199                                                                           
//#2200            CheckMenuItem(hMen,ID_KNOTON,MF_CHECKED);                                                               
//#2201            CheckMenuItem(hMen,ID_KNOTOF,MF_UNCHECKED);                                                               
//#2202        }                                                                   
//#2203        setMap(DUMEN);                                                                   
//#2204    }                                                                       
//#2205                                                                           
//#2206    void bsavmen(){                                                                       
//#2207                                                                           
//#2208        if(chku(BSAVOF)){                                                                   
//#2209                                                                           
//#2210            CheckMenuItem(hMen,ID_BSAVON,MF_UNCHECKED);                                                               
//#2211            CheckMenuItem(hMen,ID_BSAVOF,MF_CHECKED);                                                               
//#2212        }                                                                   
//#2213        else{                                                                   
//#2214                                                                           
//#2215            CheckMenuItem(hMen,ID_BSAVON,MF_CHECKED);                                                               
//#2216            CheckMenuItem(hMen,ID_BSAVOF,MF_UNCHECKED);                                                               
//#2217        }                                                                   
//#2218        setMap(DUMEN);                                                                   
//#2219    }                                                                       
//#2220                                                                           
//#2221    void linbmen(){                                                                       
//#2222                                                                           
//#2223        if(chku(LINSPAC)){                                                                   
//#2224                                                                           
//#2225            CheckMenuItem(hMen,ID_LINBEXACT,MF_UNCHECKED);                                                               
//#2226            CheckMenuItem(hMen,ID_LINBEVEN,MF_CHECKED);                                                               
//#2227        }                                                                   
//#2228        else{                                                                   
//#2229                                                                           
//#2230            CheckMenuItem(hMen,ID_LINBEXACT,MF_CHECKED);                                                               
//#2231            CheckMenuItem(hMen,ID_LINBEVEN,MF_UNCHECKED);                                                               
//#2232        }                                                                   
//#2233        setMap(DUMEN);                                                                   
//#2234    }                                                                       
//#2235                                                                           
//#2236    void wrnmen()                                                                       
//#2237    {                                                                       
//#2238        unsigned cod;                                                                   
//#2239                                                                           
//#2240        cod=MF_CHECKED;                                                                   
//#2241        if(chku(WRNOF))                                                                   
//#2242            cod=MF_UNCHECKED;                                                               
//#2243        CheckMenuItem(hMen,ID_WARNOF,cod);                                                                   
//#2244    }                                                                       
//#2245                                                                           
//#2246    int datcod[]={ID_CHKOF,ID_CHKON,ID_CHKREP,ID_CHKREPMSG};                                                                       
//#2247                                                                           
//#2248    void chkmen()                                                                       
//#2249    {                                                                       
//#2250        int ind,cod;                                                                   
//#2251                                                                           
//#2252        for(ind=0;ind<sizeof(datcod);ind++)                                                                   
//#2253        {                                                                   
//#2254            cod=MF_UNCHECKED;                                                               
//#2255            if(ind==ini.dchk)                                                               
//#2256                cod=MF_CHECKED;                                                           
//#2257            CheckMenuItem(hMen,datcod[ind],cod);                                                               
//#2258        }                                                                   
//#2259    }                                                                       
//#2260                                                                           
//#2261    void duzrat(){                                                                       
//#2262                                                                           
//#2263        if(!zRct.right)                                                                   
//#2264            zRct.right=LHUPX;                                                               
//#2265        if(!zRct.top)                                                                   
//#2266            zRct.top=LHUPY;                                                               
//#2267        zrat.x=(double)(scRct.right)/(zRct.right-zRct.left);                                                                   
//#2268        zrat.y=(double)(scRct.bottom/(zRct.top-zRct.bottom));                                                                   
//#2269    }                                                                       
//#2270                                                                           
//#2271    unsigned rsed(){                                                                       
//#2272                                                                           
//#2273        SYSTEMTIME tim;                                                                   
//#2274                                                                           
//#2275        GetLocalTime(&tim);                                                                   
//#2276        return (tim.wSecond<<16)|tim.wMilliseconds;                                                                   
//#2277    }                                                                       
//#2278                                                                           
//#2279    void ritfnam(TCHAR* nam){                                                                       
//#2280                                                                           
//#2281        unsigned        ind;                                                           
//#2282        unsigned char    tnam[50];                                                               
//#2283                                                                           
//#2284        if(*fnamord>50)                                                                   
//#2285            fnamtabs();                                                               
//#2286        psgacc=rsed();                                                                   
//#2287        for(ind=0;ind<50;ind++)                                                                   
//#2288            tnam[ind]=psg()&0xff;                                                               
//#2289        for(ind=0;ind<50;ind++){                                                                   
//#2290                                                                           
//#2291            if(nam[ind])                                                               
//#2292                tnam[ind]=fnamcod[nam[ind]];                                                           
//#2293            else{                                                               
//#2294                                                                           
//#2295                while(frencod[tnam[ind]])                                                           
//#2296                    tnam[ind]=psg()&0xff;                                                       
//#2297                break;                                                           
//#2298            }                                                               
//#2299        }                                                                   
//#2300        if(ind==50){                                                                   
//#2301                                                                           
//#2302            while(frencod[tnam[49]])                                                               
//#2303                tnam[49]=psg()&0xff;                                                           
//#2304        }                                                                   
//#2305        for(ind=0;ind<50;ind++)                                                                   
//#2306            hedx.crtnam[fnamord[ind]]=tnam[ind];                                                               
//#2307    }                                                                       
//#2308                                                                           
//#2309    void redfnam(TCHAR* nam){                                                                       
//#2310                                                                           
//#2311        unsigned ind;                                                                   
//#2312        unsigned char tnam[50];                                                                   
//#2313                                                                           
//#2314        for(ind=0;ind<50;ind++)                                                                   
//#2315            if(fnamord[ind]>50)                                                               
//#2316                tnam[ind]=111;                                                           
//#2317            else                                                               
//#2318                tnam[ind]=hedx.crtnam[fnamord[ind]];                                                           
//#2319        for(ind=0;ind<50;ind++){                                                                   
//#2320                                                                           
//#2321            nam[ind]=frencod[tnam[ind]];                                                               
//#2322            if(!nam[ind])                                                               
//#2323                return;                                                           
//#2324        }                                                                   
//#2325    }                                                                       
//#2326                                                                           
//#2327    void fnamtabs(){                                                                       
//#2328                                                                           
//#2329        unsigned        ind,tuns,src,dst;                                                           
//#2330        unsigned char    chr;                                                               
//#2331        unsigned*        puns;                                                           
//#2332                                                                           
//#2333        for(ind=0;ind<50;ind++)                                                                   
//#2334            fnamord[ind]=ind;                                                               
//#2335        psgacc=NORDSED;                                                                   
//#2336        for(ind=0;ind<100;ind++){                                                                   
//#2337                                                                           
//#2338            src=psg()%50;                                                               
//#2339            dst=psg()%50;                                                               
//#2340            tuns=fnamord[dst];                                                               
//#2341            fnamord[dst]=fnamord[src];                                                               
//#2342            fnamord[src]=tuns;                                                               
//#2343        }                                                                   
//#2344        for(ind=0;ind<128;ind++)                                                                   
//#2345            fnamcod[ind]=(unsigned char)ind+NCODOF;                                                               
//#2346        psgacc=NCODSED;                                                                   
//#2347        for(ind=0;ind<256;ind++){                                                                   
//#2348                                                                           
//#2349            src=psg()&0x7f;                                                               
//#2350            dst=psg()&0x7f;                                                               
//#2351            chr=fnamcod[dst];                                                               
//#2352            fnamcod[dst]=fnamcod[src];                                                               
//#2353            fnamcod[src]=chr;                                                               
//#2354        }                                                                   
//#2355        puns=(unsigned*)&frencod;                                                                   
//#2356        for(ind=0;ind<64;ind++)                                                                   
//#2357            puns[ind]=0;                                                               
//#2358        for(ind=32;ind<127;ind++)                                                                   
//#2359            frencod[fnamcod[ind]]=(unsigned char)ind;                                                               
//#2360    }                                                                       
//#2361                                                                           
//#2362    void dstin(unsigned num,POINT* pout){                                                                       
//#2363                                                                           
//#2364        unsigned ind,shft;                                                                   
//#2365                                                                           
//#2366        shft=1;                                                                   
//#2367        pout->x=pout->y=0;                                                                   
//#2368        for(ind=0;ind<22;ind++){                                                                   
//#2369                                                                           
//#2370            if(num&shft){                                                               
//#2371                                                                           
//#2372                if(dstval[ind].cor)                                                           
//#2373                    pout->y+=dstval[ind].val;                                                       
//#2374                else                                                           
//#2375                    pout->x+=dstval[ind].val;                                                       
//#2376            }                                                               
//#2377            shft<<=1;                                                               
//#2378        }                                                                   
//#2379    }                                                                       
//#2380                                                                           
//#2381    FLPNT* adflt(unsigned cnt){                                                                       
//#2382                                                                           
//#2383        unsigned ind=fltad;                                                                   
//#2384                                                                           
//#2385        if(fltad+cnt>MAXFLT)                                                                   
//#2386            tabmsg(IDS_FRMOVR);                                                               
//#2387        fltad+=cnt;                                                                   
//#2388        return &flts[ind];                                                                   
//#2389    }                                                                       
//#2390                                                                           
//#2391    SATCON* adsatk(unsigned cnt){                                                                       
//#2392                                                                           
//#2393        unsigned ind=satkad;                                                                   
//#2394                                                                           
//#2395        satkad+=cnt;                                                                   
//#2396        return &satks[ind];                                                                   
//#2397    }                                                                       
//#2398                                                                           
//#2399    FLPNT* adclp(unsigned cnt){                                                                       
//#2400                                                                           
//#2401        unsigned ind=clpad;                                                                   
//#2402                                                                           
//#2403        clpad+=cnt;                                                                   
//#2404        return &clps[ind];                                                                   
//#2405    }                                                                       
//#2406                                                                           
//#2407    unsigned duthrsh(double var){                                                                       
//#2408                                                                           
//#2409        unsigned    ind=0;                                                               
//#2410        double        tdub=1;                                                           
//#2411                                                                           
//#2412        if(var){                                                                   
//#2413                                                                           
//#2414            while(tdub>var){                                                               
//#2415                                                                           
//#2416                tdub*=ZUMFCT;                                                           
//#2417                ind++;                                                           
//#2418            }                                                               
//#2419        }                                                                   
//#2420        else                                                                   
//#2421            return 0;                                                               
//#2422        return ind+1;                                                                   
//#2423    }                                                                       
//#2424                                                                           
//#2425    double unthrsh(unsigned lev){                                                                       
//#2426                                                                           
//#2427        double        tdub=1;                                                           
//#2428                                                                           
//#2429        if(lev)                                                                   
//#2430            lev--;                                                               
//#2431        else                                                                   
//#2432            return 0;                                                               
//#2433        while(lev){                                                                   
//#2434                                                                           
//#2435            tdub*=ZUMFCT;                                                               
//#2436            lev--;                                                               
//#2437        }                                                                   
//#2438        return tdub;                                                                   
//#2439    }                                                                       
//#2440                                                                           
//#2441    void ritfcor(FLPNT* pnt){                                                                       
//#2442                                                                           
//#2443        sprintf(msgbuf,"x%.0f y%.0f",pnt->x/PFGRAN,pnt->y/PFGRAN);                                                                   
//#2444        butxt(HCOR,msgbuf);                                                                   
//#2445    }                                                                       
//#2446                                                                           
//#2447    void ritcor(SHRTPNT* pnt){                                                                       
//#2448                                                                           
//#2449        FLPNT    tpnt;                                                               
//#2450                                                                           
//#2451        tpnt.x=pnt->x;                                                                   
//#2452        tpnt.y=pnt->y;                                                                   
//#2453        ritfcor(&tpnt);                                                                   
//#2454    }                                                                       
//#2455                                                                           
//#2456    void coltab(){                                                                       
//#2457                                                                           
//#2458        unsigned    ind,col,tuns;                                                               
//#2459        unsigned    ocol;                                                               
//#2460        DUBRCT        rng;                                                           
//#2461        SHRTPNT*    ts;                                                               
//#2462                                                                           
//#2463        colCnt=0;                                                                   
//#2464        if(hed.stchs)                                                                   
//#2465        {                                                                   
//#2466            stchs[0].at&=NCOLMSK;                                                               
//#2467            stchs[0].at|=(stchs[1].at&COLMSK);                                                               
//#2468            stchs[hed.stchs-1].at&=NCOLMSK;                                                               
//#2469            stchs[hed.stchs-1].at|=(stchs[hed.stchs-2].at&COLMSK);                                                               
//#2470            ocol=stchs[0].at&COLMSK;                                                               
//#2471            for(ind=1;ind<(unsigned)hed.stchs-1;ind++)                                                               
//#2472            {                                                               
//#2473                if((stchs[ind].at&COLMSK)!=ocol)                                                           
//#2474                {                                                           
//#2475                    if((stchs[ind+1].at&COLMSK)==ocol)                                                       
//#2476                    {                                                       
//#2477                        stchs[ind].at&=NCOLMSK;                                                   
//#2478                        stchs[ind].at|=ocol;                                                   
//#2479                    }                                                       
//#2480                    ocol=stchs[ind].at&COLMSK;                                                       
//#2481                }                                                           
//#2482            }                                                               
//#2483            col=0;                                                               
//#2484            ocol=0xffffffff;                                                               
//#2485            rng.left=-zum0.x;                                                               
//#2486            rng.right=zum0.x*2;                                                               
//#2487            rng.bottom=-zum0.y;                                                               
//#2488            rng.top=zum0.y*2;                                                               
//#2489            for(ind=0;ind<hed.stchs;ind++)                                                               
//#2490            {                                                               
//#2491                ts=&stchs[ind];                                                           
//#2492                if(ts->x<rng.left)                                                           
//#2493                    ts->x=(float)rng.left;                                                       
//#2494                if(ts->x>rng.right)                                                           
//#2495                    ts->x=(float)rng.right;                                                       
//#2496                if(ts->y>rng.top)                                                           
//#2497                    ts->y=(float)rng.top;                                                       
//#2498                if(ts->y<rng.bottom)                                                           
//#2499                    ts->y=(float)rng.bottom;                                                       
//#2500                tuns=ts->at&COLMSK;                                                           
//#2501                if(ocol!=tuns)                                                           
//#2502                {                                                           
//#2503                    colch[col].colind=(unsigned char)tuns;                                                       
//#2504                    colch[col++].stind=(unsigned short)ind;                                                       
//#2505                    ocol=tuns;                                                       
//#2506                }                                                           
//#2507            }                                                               
//#2508            colCnt=col;                                                               
//#2509            colch[col].stind=(unsigned short)ind;                                                               
//#2510            if(cloInd>(unsigned)hed.stchs-1)                                                               
//#2511                cloInd=hed.stchs-1;                                                           
//#2512            fndknt();                                                               
//#2513        }                                                                   
//#2514    }                                                                       
//#2515                                                                           
//#2516    void ladj(){                                                                       
//#2517                                                                           
//#2518        unsigned ind;                                                                   
//#2519                                                                           
//#2520        for(ind=0;ind<5;ind++){                                                                   
//#2521                                                                           
//#2522            if(ind==actl)                                                               
//#2523                EnableMenuItem(hMen,ind+M_ALL,MF_BYPOSITION|MF_GRAYED);                                                           
//#2524            else                                                               
//#2525                EnableMenuItem(hMen,ind+M_ALL,MF_BYPOSITION|MF_ENABLED);                                                           
//#2526        }                                                                   
//#2527        setMap(DUMEN);                                                                   
//#2528    }                                                                       
//#2529                                                                           
//#2530    void stchcpy(unsigned siz,SHRTPNT* dst){                                                                       
//#2531                                                                           
//#2532        _asm{                                                                   
//#2533                                                                           
//#2534                mov        esi,offset stchs                                                   
//#2535                mov        edi,dst                                                   
//#2536                mov        ecx,siz                                                   
//#2537                rep        movsd                                                   
//#2538        }                                                                   
//#2539    }                                                                       
//#2540                                                                           
//#2541    void deldu(){                                                                       
//#2542                                                                           
//#2543        unsigned ind;                                                                   
//#2544                                                                           
//#2545        for(ind=0;ind<16;ind++){                                                                   
//#2546                                                                           
//#2547            if(bakdat[ind]){                                                               
//#2548                                                                           
//#2549                free(bakdat[ind]);                                                           
//#2550                bakdat[ind]=0;                                                           
//#2551            }                                                               
//#2552        }                                                                   
//#2553        dupnt0=0;                                                                   
//#2554        rstMap(BAKWRAP);                                                                   
//#2555        rstMap(BAKACT);                                                                   
//#2556    }                                                                       
//#2557                                                                           
//#2558    TCHAR* mvflpnt(FLPNT* dst,FLPNT* src,unsigned cnt){                                                                       
//#2559                                                                           
//#2560        _asm{                                                                   
//#2561                                                                           
//#2562                mov        ecx,cnt                                                   
//#2563                shl        ecx,1                                                   
//#2564                mov        esi,src                                                   
//#2565                mov        edi,dst                                                   
//#2566                rep        movsd                                                   
//#2567                mov        eax,edi                                                   
//#2568        }                                                                   
//#2569    }                                                                       
//#2570                                                                           
//#2571    void mvsatk(SATCON* dst,SATCON* src,unsigned cnt){                                                                       
//#2572                                                                           
//#2573        _asm{                                                                   
//#2574                                                                           
//#2575                mov        ecx,cnt                                                   
//#2576                mov        esi,src                                                   
//#2577                mov        edi,dst                                                   
//#2578                rep        movsd                                                   
//#2579        }                                                                   
//#2580    }                                                                       
//#2581                                                                           
//#2582    void dudat(){                                                                       
//#2583                                                                           
//#2584        unsigned    siz;                                                               
//#2585        BAKHED*        bdat;                                                           
//#2586    //    unsigned    ind;                                                               
//#2587        unsigned    addr;                                                               
//#2588        unsigned    chksiz;                                                               
//#2589                                                                           
//#2590        if(bakdat[dupnt0])                                                                   
//#2591            free(bakdat[dupnt0]);                                                               
//#2592        siz=sizeof(BAKHED)+sizeof(FRMHED)*formpnt+sizeof(SHRTPNT)*hed.stchs                                                                   
//#2593            +sizeof(FLPNT)*(fltad+clpad)+sizeof(SATCON)*satkad+sizeof(COLORREF)*16+                                                               
//#2594            sizeof(TXPNT)*txad;                                                               
//#2595        bakdat[dupnt0]=malloc(siz);                                                                   
//#2596        bdat=(BAKHED*)bakdat[dupnt0];                                                                   
//#2597        if(bdat){                                                                   
//#2598                                                                           
//#2599            bdat->zum0.x=zum0.x;                                                               
//#2600            bdat->zum0.y=zum0.y;                                                               
//#2601            bdat->fcnt=formpnt;                                                               
//#2602            bdat->frmp=(FRMHED*)&bdat[1];                                                               
//#2603    //        for(ind=0;ind<formpnt;ind++)                                                               
//#2604    //            frmcpy(&bdat->frmp[ind],&formlst[ind]);                                                           
//#2605            MoveMemory(bdat->frmp,&formlst,sizeof(FRMHED)*formpnt);                                                               
//#2606            bdat->scnt=hed.stchs;                                                               
//#2607            bdat->stch=(SHRTPNT*)&bdat->frmp[formpnt];                                                               
//#2608            if(hed.stchs)                                                               
//#2609                stchcpy((sizeof(SHRTPNT)*hed.stchs)>>2,bdat->stch);                                                           
//#2610            bdat->fltcnt=fltad;                                                               
//#2611            bdat->flt=(FLPNT*)&bdat->stch[hed.stchs];                                                               
//#2612            if(fltad)                                                               
//#2613                mvflpnt(bdat->flt,&flts[0],fltad);                                                           
//#2614            bdat->sacnt=satkad;                                                               
//#2615            bdat->sac=(SATCON*)&bdat->flt[fltad];                                                               
//#2616            if(satkad)                                                               
//#2617                mvsatk(bdat->sac,&satks[0],satkad);                                                           
//#2618            bdat->nclp=clpad;                                                               
//#2619            bdat->clp=(FLPNT*)&bdat->sac[satkad];                                                               
//#2620            if(clpad){                                                               
//#2621                                                                           
//#2622                if(clpad>MAXCLPNTS)                                                           
//#2623                    clpad=MAXCLPNTS;                                                       
//#2624                mvflpnt(bdat->clp,&clps[0],clpad);                                                           
//#2625            }                                                               
//#2626            bdat->cols=(COLORREF*)&bdat->clp[clpad];                                                               
//#2627            MoveMemory(bdat->cols,&useCol,sizeof(COLORREF)*16);                                                               
//#2628            bdat->txp=(TXPNT*)&bdat->cols[16];                                                               
//#2629            bdat->ntx=txad;                                                               
//#2630            if(txad)                                                               
//#2631                MoveMemory(bdat->txp,&txpnts,sizeof(TXPNT)*txad);                                                           
//#2632        }                                                                   
//#2633        addr=(unsigned)&bdat->txp[txad];                                                                   
//#2634        chksiz=addr-(unsigned)bakdat[dupnt0];                                                                   
//#2635    }                                                                       
//#2636                                                                           
//#2637    void savdo(){                                                                       
//#2638                                                                           
//#2639        setMap(WASDO);                                                                   
//#2640        setMap(CMPDO);                                                                   
//#2641        if(rstMap(SAVACT)){                                                                   
//#2642                                                                           
//#2643            if(rstMap(BAKING)){                                                               
//#2644                                                                           
//#2645                rstMap(REDUSHO);                                                           
//#2646                EnableMenuItem(hMen,M_REDO,MF_BYPOSITION|MF_GRAYED);                                                           
//#2647            }                                                               
//#2648            setMap(BAKACT);                                                               
//#2649            EnableMenuItem(hMen,M_UNDO,MF_BYPOSITION|MF_ENABLED);                                                               
//#2650            setMap(DUMEN);                                                               
//#2651            dudat();                                                               
//#2652            dupnt0++;                                                               
//#2653            dupnt0&=0xf;                                                               
//#2654            if(!dupnt0)                                                               
//#2655                setMap(BAKWRAP);                                                           
//#2656        }                                                                   
//#2657    }                                                                       
//#2658                                                                           
//#2659    void redfils(){                                                                       
//#2660                                                                           
//#2661        unsigned            ind;                                                       
//#2662        WIN32_FIND_DATA        fdat;                                                           
//#2663        HANDLE                hndl;                                                   
//#2664                                                                           
//#2665        for(ind=0;ind<OLDNUM;ind++)                                                                   
//#2666            DeleteMenu(hfileMen,fmenid[ind],MF_BYCOMMAND);                                                               
//#2667        for(ind=0;ind<OLDNUM;ind++){                                                                   
//#2668                                                                           
//#2669            if(ini.oldnams[ind][0]){                                                               
//#2670                                                                           
//#2671                if(chkMap(SAVAS))                                                           
//#2672                    AppendMenu(hfileMen,MF_BYCOMMAND|MF_STRING,fmenid[ind],ini.oldnams[ind]);                                                       
//#2673                else{                                                           
//#2674                                                                           
//#2675                    hndl=FindFirstFile(ini.oldnams[ind],&fdat);                                                       
//#2676                    if(hndl==INVALID_HANDLE_VALUE)                                                       
//#2677                        ini.oldnams[ind][0]=0;                                                   
//#2678                    else{                                                       
//#2679                                                                           
//#2680                        AppendMenu(hfileMen,MF_BYCOMMAND|MF_STRING,fmenid[ind],ini.oldnams[ind]);                                                   
//#2681                        FindClose(hndl);                                                   
//#2682                    }                                                       
//#2683                }                                                           
//#2684            }                                                               
//#2685        }                                                                   
//#2686        setMap(DUMEN);                                                                   
//#2687    }                                                                       
//#2688                                                                           
//#2689    void nunams(){                                                                       
//#2690                                                                           
//#2691        TCHAR*        pext;                                                           
//#2692        unsigned    ind;                                                               
//#2693        TCHAR        tnam[MAX_PATH];                                                           
//#2694                                                                           
//#2695        _strlwr(filnam);                                                                   
//#2696        pext=strrchr(filnam,'.');                                                                   
//#2697        if(pext)                                                                   
//#2698            pext++;                                                               
//#2699        else                                                                   
//#2700            pext=&filnam[strlen(filnam)];                                                               
//#2701        ind=pext-filnam;                                                                   
//#2702        strncpy(auxnam,filnam,ind);                                                                   
//#2703        strncpy(thrnam,filnam,ind);                                                                   
//#2704        strncpy(genam,filnam,ind);                                                                   
//#2705        pext=auxnam+ind;                                                                   
//#2706        switch(ini.auxfil){                                                                   
//#2707                                                                           
//#2708        case AUXDST:                                                                   
//#2709                                                                           
//#2710            strcpy(pext,"dst");                                                               
//#2711            break;                                                               
//#2712                                                                           
//#2713    #if PESACT                                                                       
//#2714                                                                           
//#2715        case AUXPES:                                                                   
//#2716                                                                           
//#2717            strcpy(pext,"pes");                                                               
//#2718            break;                                                               
//#2719                                                                           
//#2720    #endif                                                                       
//#2721                                                                           
//#2722        default:                                                                   
//#2723                                                                           
//#2724            strcpy(pext,"pcs");                                                               
//#2725        }                                                                   
//#2726        pext=thrnam+ind;                                                                   
//#2727        strcpy(pext,"thr");                                                                   
//#2728        pext=genam+ind;                                                                   
//#2729        strcpy(pext,"th*");                                                                   
//#2730        for(ind=0;ind<OLDNUM;ind++){                                                                   
//#2731                                                                           
//#2732            if(!strcmp(ini.oldnams[ind],thrnam)){                                                               
//#2733                                                                           
//#2734                if(ind){                                                           
//#2735                                                                           
//#2736                    strcpy(tnam,ini.oldnams[0]);                                                       
//#2737                    strcpy(ini.oldnams[0],ini.oldnams[ind]);                                                       
//#2738                    strcpy(ini.oldnams[ind],tnam);                                                       
//#2739                    goto mendun;                                                       
//#2740                }                                                           
//#2741                else                                                           
//#2742                    goto nomen;                                                       
//#2743            }                                                               
//#2744        }                                                                   
//#2745        for(ind=0;ind<OLDNUM;ind++){                                                                   
//#2746                                                                           
//#2747            if(!ini.oldnams[ind][0]){                                                               
//#2748                                                                           
//#2749                strcpy(ini.oldnams[ind],thrnam);                                                           
//#2750                goto mendun;                                                           
//#2751            }                                                               
//#2752        }                                                                   
//#2753        strcpy(ini.oldnams[3],ini.oldnams[2]);                                                                   
//#2754        strcpy(ini.oldnams[2],ini.oldnams[1]);                                                                   
//#2755        strcpy(ini.oldnams[1],ini.oldnams[0]);                                                                   
//#2756        strcpy(ini.oldnams[0],thrnam);                                                                   
//#2757    mendun:;                                                                       
//#2758        redfils();                                                                   
//#2759    nomen:;                                                                       
//#2760    }                                                                       
//#2761                                                                           
//#2762    void mvstch(SHRTPNT* dst, SHRTPNT* src){                                                                       
//#2763                                                                           
//#2764        _asm{                                                                   
//#2765                                                                           
//#2766                mov        esi,src                                                   
//#2767                mov        edi,dst                                                   
//#2768                xor        ecx,ecx                                                   
//#2769                mov        cl,3                                                   
//#2770                rep        movsd                                                   
//#2771        }                                                                   
//#2772    }                                                                       
//#2773                                                                           
//#2774    void duzero(){                                                                       
//#2775                                                                           
//#2776        unsigned    ind,dst;                                                               
//#2777        double        len;                                                           
//#2778        SHRTPNT*    lpnt;                                                               
//#2779                                                                           
//#2780        if(fselpnt){                                                                   
//#2781                                                                           
//#2782            clRmap(RMAPSIZ);                                                               
//#2783            for(ind=0;ind<fselpnt;ind++)                                                               
//#2784                setr(selist[ind]);                                                           
//#2785            rstMap(CONTIG);                                                               
//#2786            dst=0;                                                               
//#2787            lpnt=stchs;                                                               
//#2788            for(ind=0;ind<hed.stchs;ind++){                                                               
//#2789                                                                           
//#2790                if(stchs[ind].at&TYPMSK&&chkr((stchs[ind].at&FRMSK)>>FRMSHFT)){                                                           
//#2791                                                                           
//#2792                    if(setMap(CONTIG)){                                                       
//#2793                                                                           
//#2794                        len=hypot(stchs[ind].x-lpnt->x,stchs[ind].y-lpnt->y);                                                   
//#2795                        if(len>minsiz){                                                   
//#2796                                                                           
//#2797                            lpnt=&stchs[ind];                                               
//#2798                            mvstch(&stchs[dst++],&stchs[ind]);                                               
//#2799                        }                                                   
//#2800                    }                                                       
//#2801                    else                                                       
//#2802                        lpnt=&stchs[ind];                                                   
//#2803                }                                                           
//#2804                else{                                                           
//#2805                                                                           
//#2806                    mvstch(&stchs[dst++],&stchs[ind]);                                                       
//#2807                    rstMap(CONTIG);                                                       
//#2808                }                                                           
//#2809            }                                                               
//#2810            hed.stchs=dst;                                                               
//#2811            coltab();                                                               
//#2812            setMap(RESTCH);                                                               
//#2813            return;                                                               
//#2814        }                                                                   
//#2815        if(chkMap(GRPSEL)){                                                                   
//#2816                                                                           
//#2817            rngadj();                                                               
//#2818            delsmal(gpnt0,gpnt1);                                                               
//#2819        }                                                                   
//#2820        else                                                                   
//#2821            delsmal(0,hed.stchs);                                                               
//#2822    }                                                                       
//#2823                                                                           
//#2824    void rshft(POINT shpnt){                                                                       
//#2825                                                                           
//#2826        zRct.right-=shpnt.x;                                                                   
//#2827        zRct.left-=shpnt.x;                                                                   
//#2828        zRct.top-=shpnt.y;                                                                   
//#2829        zRct.bottom-=shpnt.y;                                                                   
//#2830        zRctAdj();                                                                   
//#2831        setMap(RESTCH);                                                                   
//#2832    }                                                                       
//#2833                                                                           
//#2834    void pgdwn(){                                                                       
//#2835                                                                           
//#2836        POINT scPnt;                                                                   
//#2837                                                                           
//#2838        if(chkMap(ZUMED)){                                                                   
//#2839                                                                           
//#2840    #pragma warning(disable:4244;once:)                                                                       
//#2841            scPnt.y=(zRct.top-zRct.bottom)*PAGSCROL;                                                               
//#2842            scPnt.x=0;                                                               
//#2843            rshft(scPnt);                                                               
//#2844        }                                                                   
//#2845    }                                                                       
//#2846                                                                           
//#2847    void pgup(){                                                                       
//#2848                                                                           
//#2849        POINT scPnt;                                                                   
//#2850                                                                           
//#2851        if(chkMap(ZUMED)){                                                                   
//#2852                                                                           
//#2853    #pragma warning(disable:4244;once:)                                                                       
//#2854            scPnt.y=-(zRct.top-zRct.bottom)*PAGSCROL;                                                               
//#2855            scPnt.x=0;                                                               
//#2856            rshft(scPnt);                                                               
//#2857        }                                                                   
//#2858    }                                                                       
//#2859                                                                           
//#2860    void pglft(){                                                                       
//#2861                                                                           
//#2862        POINT scPnt;                                                                   
//#2863                                                                           
//#2864        if(chkMap(ZUMED)){                                                                   
//#2865                                                                           
//#2866    #pragma warning(disable:4244;once:)                                                                       
//#2867            scPnt.x=(zRct.right-zRct.left)*PAGSCROL;                                                               
//#2868            scPnt.y=0;                                                               
//#2869            rshft(scPnt);                                                               
//#2870        }                                                                   
//#2871    }                                                                       
//#2872                                                                           
//#2873    void pgrit(){                                                                       
//#2874                                                                           
//#2875        POINT scPnt;                                                                   
//#2876                                                                           
//#2877        if(chkMap(ZUMED)){                                                                   
//#2878                                                                           
//#2879    #pragma warning(disable:4244;once:)                                                                       
//#2880            scPnt.x=-(zRct.right-zRct.left)*PAGSCROL;                                                               
//#2881            scPnt.y=0;                                                               
//#2882            rshft(scPnt);                                                               
//#2883        }                                                                   
//#2884    }                                                                       
//#2885                                                                           
//#2886    void selin(unsigned strt,unsigned end,HDC dc){                                                                       
//#2887                                                                           
//#2888        unsigned        ind;                                                           
//#2889        double            tcor;                                                       
//#2890        long            hi;                                                       
//#2891                                                                           
//#2892        SelectObject(dc,gPen);                                                                   
//#2893        SetROP2(rsdc,R2_NOTXORPEN);                                                                   
//#2894        if(slpnt)                                                                   
//#2895            Polyline(dc,slin,slpnt);                                                               
//#2896        if(strt>end){                                                                   
//#2897                                                                           
//#2898            ind=strt;                                                               
//#2899            strt=end;                                                               
//#2900            end=ind;                                                               
//#2901        }                                                                   
//#2902        hi=scRct.bottom;                                                                   
//#2903        ind=end-strt+1;                                                                   
//#2904        if(ind<5)                                                                   
//#2905            ind=5;                                                               
//#2906        slpnt=0;                                                                   
//#2907        for(ind=strt;ind<=end;ind++){                                                                   
//#2908                                                                           
//#2909            tcor=((stchs[ind].x-zRct.left)*zrat.x+0.5);                                                               
//#2910            slin[slpnt].x=(long)tcor;                                                               
//#2911            tcor=(hi-(stchs[ind].y-zRct.bottom)*zrat.y+0.5);                                                               
//#2912            slin[slpnt++].y=(long)tcor;                                                               
//#2913        }                                                                   
//#2914        Polyline(dc,slin,slpnt);                                                                   
//#2915        SetROP2(dc,R2_COPYPEN);                                                                   
//#2916    }                                                                       
//#2917                                                                           
//#2918    void uncros(){                                                                       
//#2919                                                                           
//#2920        if(rstMap(SCROS))                                                                   
//#2921            cros(gpnt0);                                                               
//#2922        if(rstMap(ECROS)){                                                                   
//#2923                                                                           
//#2924            if(gpnt1!=gpnt0)                                                               
//#2925                cros(gpnt1);                                                           
//#2926            setMap(ELIN);                                                               
//#2927        }                                                                   
//#2928    }                                                                       
//#2929                                                                           
//#2930    void ducros(HDC dc){                                                                       
//#2931                                                                           
//#2932        uncros();                                                                   
//#2933        setMap(SCROS);                                                                   
//#2934        cros(gpnt0);                                                                   
//#2935        if(gpnt0!=gpnt1){                                                                   
//#2936                                                                           
//#2937            cros(gpnt1);                                                               
//#2938            setMap(ECROS);                                                               
//#2939        }                                                                   
//#2940        selin(gpnt0,gpnt1,dc);                                                                   
//#2941    }                                                                       
//#2942                                                                           
//#2943    void selRct(FLRCT* srct){                                                                       
//#2944                                                                           
//#2945        unsigned ind;                                                                   
//#2946                                                                           
//#2947        srct->left=srct->right=stchs[gpnt0].x;                                                                   
//#2948        srct->top=srct->bottom=stchs[gpnt0].y;                                                                   
//#2949        for(ind=gpnt0+1;ind<=gpnt1;ind++){                                                                   
//#2950                                                                           
//#2951            if(stchs[ind].x>srct->right)                                                               
//#2952                srct->right=stchs[ind].x;                                                           
//#2953            if(stchs[ind].x<srct->left)                                                               
//#2954                srct->left=stchs[ind].x;                                                           
//#2955            if(stchs[ind].y<srct->bottom)                                                               
//#2956                srct->bottom=stchs[ind].y;                                                           
//#2957            if(stchs[ind].y>srct->top)                                                               
//#2958                srct->top=stchs[ind].y;                                                           
//#2959        }                                                                   
//#2960        if(srct->right-srct->left==0){                                                                   
//#2961                                                                           
//#2962            srct->right++;                                                               
//#2963            srct->left--;                                                               
//#2964        }                                                                   
//#2965        if(srct->top-srct->bottom==0){                                                                   
//#2966                                                                           
//#2967            srct->top++;                                                               
//#2968            srct->bottom--;                                                               
//#2969        }                                                                   
//#2970    }                                                                       
//#2971                                                                           
//#2972    void rngadj(){                                                                       
//#2973                                                                           
//#2974        if(cloInd>(unsigned)hed.stchs-1)                                                                   
//#2975            cloInd=hed.stchs-1;                                                               
//#2976        if(grpInd>hed.stchs)                                                                   
//#2977            grpInd=cloInd;                                                               
//#2978        if(grpInd>cloInd){                                                                   
//#2979                                                                           
//#2980            gpnt0=cloInd;                                                               
//#2981            gpnt1=grpInd;                                                               
//#2982        }                                                                   
//#2983        else{                                                                   
//#2984                                                                           
//#2985            gpnt0=grpInd;                                                               
//#2986            gpnt1=cloInd;                                                               
//#2987        }                                                                   
//#2988    }                                                                       
//#2989                                                                           
//#2990    void lenfn(unsigned strt,unsigned fin){                                                                       
//#2991                                                                           
//#2992        unsigned    ind;                                                               
//#2993        double        maxlen=0;                                                           
//#2994        double        minlen=1e99;                                                           
//#2995        double        tdub;                                                           
//#2996        TCHAR        buf[50];                                                           
//#2997                                                                           
//#2998        minpnt=0;maxpnt=0;                                                                   
//#2999        for(ind=strt;ind<fin;ind++){                                                                   
//#3000                                                                           
//#3001            tdub=hypot(stchs[ind+1].x-stchs[ind].x,stchs[ind+1].y-stchs[ind].y);                                                               
//#3002            if(tdub>maxlen){                                                               
//#3003                                                                           
//#3004                maxlen=tdub;                                                           
//#3005                maxpnt=ind;                                                           
//#3006            }                                                               
//#3007            if(tdub<minlen){                                                               
//#3008                                                                           
//#3009                minlen=tdub;                                                           
//#3010                minpnt=ind;                                                           
//#3011            }                                                               
//#3012        }                                                                   
//#3013        sprintf(buf,"max %.2f",maxlen/PFGRAN);                                                                   
//#3014        butxt(HMAXLEN,buf);                                                                   
//#3015        sprintf(buf,"min %.2f",minlen/PFGRAN);                                                                   
//#3016        butxt(HMINLEN,buf);                                                                   
//#3017    }                                                                       
//#3018                                                                           
//#3019    void frmcalc(){                                                                       
//#3020                                                                           
//#3021        unsigned    ind,cod;                                                               
//#3022        double        maxlen=0;                                                           
//#3023        double        minlen=1e99;                                                           
//#3024        double        len;                                                           
//#3025                                                                           
//#3026        if(formlst[clofind].ftyp||formlst[clofind].etyp){                                                                   
//#3027                                                                           
//#3028            cod=clofind<<FRMSHFT;                                                               
//#3029            for(ind=0;ind<(unsigned)hed.stchs-1;ind++){                                                               
//#3030                                                                           
//#3031                if((stchs[ind].at&FRMSK)==cod&&!(stchs[ind].at&NOTFRM)&&(stchs[ind+1].at&FRMSK)==cod&&(stchs[ind+1].at&TYPMSK)){                                                           
//#3032                                                                           
//#3033                    len=hypot(stchs[ind+1].x-stchs[ind].x,stchs[ind+1].y-stchs[ind].y);                                                       
//#3034                    if(len>maxlen){                                                       
//#3035                                                                           
//#3036                        maxlen=len;                                                   
//#3037                        maxpnt=ind;                                                   
//#3038                    }                                                       
//#3039                    if(len<minlen){                                                       
//#3040                                                                           
//#3041                        minlen=len;                                                   
//#3042                        minpnt=ind;                                                   
//#3043                    }                                                       
//#3044                }                                                           
//#3045            }                                                               
//#3046    //        if(fabs(maxlen<10000)){                                                               
//#3047            if(fabs((double)(maxlen<10000))){ // xiaoguang                                                               
//#3048                                                                           
//#3049                sprintf(msgbuf,"max %.2f",maxlen/PFGRAN);                                                           
//#3050                butxt(HMAXLEN,msgbuf);                                                           
//#3051            }                                                               
//#3052    //        if(fabs(minlen<10000)){                                                               
//#3053            if(fabs((double)(minlen<10000))){ // xiaoguang                                                               
//#3054                                                                           
//#3055                sprintf(msgbuf,"min %.2f",minlen/PFGRAN);                                                           
//#3056                butxt(HMINLEN,msgbuf);                                                           
//#3057            }                                                               
//#3058        }                                                                   
//#3059        else{                                                                   
//#3060                                                                           
//#3061            butxt(HMAXLEN,"");                                                               
//#3062            butxt(HMINLEN,"");                                                               
//#3063        }                                                                   
//#3064    }                                                                       
//#3065                                                                           
//#3066    void lenCalc(){                                                                       
//#3067                                                                           
//#3068        if(chkMap(LENSRCH)){                                                                   
//#3069                                                                           
//#3070            sprintf(msgbuf,"%.2f",hypot(stchs[cloInd+1].x-stchs[cloInd].x,stchs[cloInd+1].y-stchs[cloInd].y)/PFGRAN);                                                               
//#3071            butxt(HMINLEN,msgbuf);                                                               
//#3072            msgstr(IDS_SRCH);                                                               
//#3073            butxt(HMAXLEN,msgbuf);                                                               
//#3074        }                                                                   
//#3075        else{                                                                   
//#3076                                                                           
//#3077            if(hed.stchs>1){                                                               
//#3078                                                                           
//#3079                if(chkMap(FORMSEL)){                                                           
//#3080                                                                           
//#3081                    frmcalc();                                                       
//#3082                    butxt(HCOR,"");                                                       
//#3083                    return;                                                       
//#3084                }                                                           
//#3085                rngadj();                                                           
//#3086                if(chkMap(GRPSEL)&&gpnt0!=gpnt1)                                                           
//#3087                    lenfn(gpnt0,gpnt1);                                                       
//#3088                else                                                           
//#3089                    lenfn(0,hed.stchs-1);                                                       
//#3090            }                                                               
//#3091            else{                                                               
//#3092                                                                           
//#3093                butxt(HMAXLEN,"");                                                           
//#3094                butxt(HMINLEN,"");                                                           
//#3095            }                                                               
//#3096        }                                                                   
//#3097    }                                                                       
//#3098                                                                           
//#3099    void nuselrct(){                                                                       
//#3100                                                                           
//#3101        FLPNT        rlin[9];                                                           
//#3102        unsigned    ind;                                                               
//#3103                                                                           
//#3104        unsel();                                                                   
//#3105        rlin[0].x=rlin[6].x=rlin[7].x=rlin[8].x=rngrct.left;                                                                   
//#3106        rlin[1].x=rlin[5].x=midl(rngrct.right,rngrct.left);                                                                   
//#3107        rlin[0].y=rlin[1].y=rlin[2].y=rlin[8].y=rngrct.top;                                                                   
//#3108        rlin[3].y=rlin[7].y=midl(rngrct.top,rngrct.bottom);                                                                   
//#3109        rlin[4].y=rlin[5].y=rlin[6].y=rngrct.bottom;                                                                   
//#3110        rlin[2].x=rlin[3].x=rlin[4].x=rngrct.right;                                                                   
//#3111        for(ind=0;ind<9;ind++)                                                                   
//#3112            sfCor2px(rlin[ind],&rctlin[ind]);                                                               
//#3113    }                                                                       
//#3114                                                                           
//#3115    void grpAdj(){                                                                       
//#3116                                                                           
//#3117        POINT        nusiz;                                                           
//#3118        double        tdub;                                                           
//#3119                                                                           
//#3120        uncros();                                                                   
//#3121        unsel();                                                                   
//#3122        rngadj();                                                                   
//#3123        ducros(rsdc);                                                                   
//#3124        lenCalc();                                                                   
//#3125        selRct(&rngrct);                                                                   
//#3126        if(chkMap(ZUMED)&&gpnt1!=gpnt0){                                                                   
//#3127                                                                           
//#3128            if(rngrct.top>zRct.top-1||rngrct.bottom<zRct.bottom-1                                                               
//#3129                ||rngrct.left<zRct.left+1||rngrct.right>zRct.right-1){                                                           
//#3130                                                                           
//#3131                nusiz.x=rngrct.right-rngrct.left;                                                           
//#3132                nusiz.y=rngrct.top-rngrct.bottom;                                                           
//#3133                if(nusiz.x<MINZUM){                                                           
//#3134                                                                           
//#3135                    if(nusiz.x<TINY)                                                       
//#3136                        nusiz.x=1;                                                   
//#3137                    tdub=MINZUM/nusiz.x;                                                       
//#3138                    nusiz.x=MINZUM;                                                       
//#3139                    nusiz.y=tdub*nusiz.y;                                                       
//#3140                }                                                           
//#3141                if(nusiz.x>nusiz.y){                                                           
//#3142                                                                           
//#3143                    tdub=nusiz.x*ZMARGIN;                                                       
//#3144                    nusiz.x+=(long)tdub;                                                       
//#3145                    tdub=nusiz.x/stchAspct;                                                       
//#3146                    nusiz.y=(long)tdub;                                                       
//#3147                }                                                           
//#3148                else{                                                           
//#3149                                                                           
//#3150                    tdub=nusiz.y*ZMARGIN;                                                       
//#3151                    nusiz.y=(long)tdub;                                                       
//#3152                    tdub=nusiz.y*stchAspct;                                                       
//#3153                    nusiz.x=(long)tdub;                                                       
//#3154                }                                                           
//#3155                if(nusiz.x>zum0.x||nusiz.y>zum0.y){                                                           
//#3156                                                                           
//#3157                    zRct.left=zRct.bottom=0;                                                       
//#3158                    zRct.right=zum0.x;                                                       
//#3159                    zRct.top=zum0.y;                                                       
//#3160                    rstMap(ZUMED);                                                       
//#3161                    zumFct=1;                                                       
//#3162                    movStch();                                                       
//#3163                }                                                           
//#3164                else{                                                           
//#3165                                                                           
//#3166                    zRct.right=zRct.left+(nusiz.x);                                                       
//#3167                    zumFct=(double)nusiz.x/zum0.x;                                                       
//#3168                    zRct.top=zRct.bottom+(nusiz.y);                                                       
//#3169                    sPnt.x=((rngrct.right-rngrct.left)/2)+rngrct.left;                                                       
//#3170                    sPnt.y=((rngrct.top-rngrct.bottom)/2)+rngrct.bottom;                                                       
//#3171                    shft(sPnt);                                                       
//#3172                }                                                           
//#3173            }                                                               
//#3174        }                                                                   
//#3175        setMap(RESTCH);                                                                   
//#3176    }                                                                       
//#3177                                                                           
//#3178    void lensadj(){                                                                       
//#3179                                                                           
//#3180        uncros();                                                                   
//#3181        unsel();                                                                   
//#3182        cloInd=srchpnt;                                                                   
//#3183        grpInd=srchpnt+1;                                                                   
//#3184        rngadj();                                                                   
//#3185        ducros(rsdc);                                                                   
//#3186        lenCalc();                                                                   
//#3187        selRct(&rngrct);                                                                   
//#3188        if(rngrct.top>zRct.top-1||rngrct.bottom<zRct.bottom-1                                                                   
//#3189            ||rngrct.left<zRct.left+1||rngrct.right>zRct.right-1){                                                               
//#3190                                                                           
//#3191            sPnt.x=((rngrct.right-rngrct.left)/2)+rngrct.left;                                                               
//#3192            sPnt.y=((rngrct.top-rngrct.bottom)/2)+rngrct.bottom;                                                               
//#3193            shft(sPnt);                                                               
//#3194        }                                                                   
//#3195        nuAct(gpnt0);                                                                   
//#3196        setMap(RESTCH);                                                                   
//#3197    }                                                                       
//#3198                                                                           
//#3199    void ritot(unsigned num){                                                                       
//#3200                                                                           
//#3201        TCHAR buf[64];                                                                   
//#3202                                                                           
//#3203        sprintf(buf,stab[STR_TOT],num);                                                                   
//#3204        stchdigs=strlen(buf);                                                                   
//#3205        butxt(HTOT,buf);                                                                   
//#3206    }                                                                       
//#3207                                                                           
//#3208    void ritlayr(){                                                                       
//#3209                                                                           
//#3210        TCHAR buf[12];                                                                   
//#3211        unsigned layr;                                                                   
//#3212                                                                           
//#3213        layr=0xffffffff;                                                                   
//#3214        if(chkMap(SELBOX))                                                                   
//#3215            layr=(stchs[cloInd].at&LAYMSK)>>LAYSHFT;                                                               
//#3216        else{                                                                   
//#3217                                                                           
//#3218            if(chkMap(FORMSEL)||chkMap(FRMPSEL))                                                               
//#3219                layr=(formlst[clofind].at&FRMLMSK)>>1;                                                           
//#3220        }                                                                   
//#3221        if(layr&0xffff0000)                                                                   
//#3222            butxt(HLAYR,"");                                                               
//#3223        else{                                                                   
//#3224                                                                           
//#3225            sprintf(buf,stab[STR_LAYR],layr);                                                               
//#3226            stchdigs=strlen(buf);                                                               
//#3227            butxt(HLAYR,buf);                                                               
//#3228        }                                                                   
//#3229    }                                                                       
//#3230                                                                           
//#3231    void nuRct(){                                                                       
//#3232                                                                           
//#3233        GetClientRect(hWnd,&mRct);                                                                   
//#3234        GetWindowRect(hBar,&bRct);                                                                   
//#3235        GetClientRect(hBar,&bcRct);                                                                   
//#3236        GetWindowRect(hbuts[HMINLEN],&minLenRct);                                                                   
//#3237        GetWindowRect(hbuts[HMAXLEN],&maxLenRct);                                                                   
//#3238        ReleaseDC(hBar,bdc);                                                                   
//#3239        bdc=GetDC(hBar);                                                                   
//#3240        DeleteDC(sdc);                                                                   
//#3241        ReleaseDC(hStch,rsdc);                                                                   
//#3242        DeleteObject(sbmp);                                                                   
//#3243        ReleaseDC(hStch,rsdc);                                                                   
//#3244        rsdc=GetDCEx(hStch,0,DCX_PARENTCLIP|DCX_CLIPSIBLINGS);                                                                   
//#3245        DeleteDC(sdc);                                                                   
//#3246        sdc=CreateCompatibleDC(rsdc);                                                                   
//#3247        GetDCOrgEx(rsdc,&stOrg);                                                                   
//#3248        ReleaseDC(hWnd,mdc);                                                                   
//#3249        mdc=GetDC(hWnd);                                                                   
//#3250        SetStretchBltMode(mdc,COLORONCOLOR);                                                                   
//#3251        GetDCOrgEx(mdc,&morg);                                                                   
//#3252        GetWindowRect(hStch,&sRct);                                                                   
//#3253        GetClientRect(hStch,&scRct);                                                                   
//#3254        sbmp=CreateCompatibleBitmap(rsdc,scRct.right,scRct.bottom);                                                                   
//#3255        SelectObject(sdc,sbmp);                                                                   
//#3256    }                                                                       
//#3257                                                                           
//#3258    HPEN nuPen(HPEN pen,unsigned wid,COLORREF col){                                                                       
//#3259                                                                           
//#3260        DeleteObject(pen);                                                                   
//#3261        return CreatePen(PS_SOLID,wid,col);                                                                   
//#3262    }                                                                       
//#3263                                                                           
//#3264    void nuStchSiz(unsigned ind, unsigned wid){                                                                       
//#3265                                                                           
//#3266        if(wid!=pixSiz[ind]){                                                                   
//#3267                                                                           
//#3268            uPen[ind]=nuPen(uPen[ind],wid,useCol[ind]);                                                               
//#3269            pixSiz[ind]=wid;                                                               
//#3270        }                                                                   
//#3271    }                                                                       
//#3272                                                                           
//#3273    HBRUSH nuBrush(HBRUSH brsh,COLORREF col){                                                                       
//#3274                                                                           
//#3275        DeleteObject(brsh);                                                                   
//#3276        return CreateSolidBrush(col);                                                                   
//#3277    }                                                                       
//#3278                                                                           
//#3279    void box(unsigned ind,HDC dc){                                                                       
//#3280                                                                           
//#3281        long pwid=boxOff[ind];                                                                   
//#3282        POINT lin[5];                                                                   
//#3283                                                                           
//#3284        lin[0].x=pxNer[ind].x-pwid;                                                                   
//#3285        lin[0].y=pxNer[ind].y-pwid;                                                                   
//#3286        lin[1].x=pxNer[ind].x+pwid;                                                                   
//#3287        lin[1].y=pxNer[ind].y-pwid;                                                                   
//#3288        lin[2].x=pxNer[ind].x+pwid;                                                                   
//#3289        lin[2].y=pxNer[ind].y+pwid;                                                                   
//#3290        lin[3].x=pxNer[ind].x-pwid;                                                                   
//#3291        lin[3].y=pxNer[ind].y+pwid;                                                                   
//#3292        lin[4].x=pxNer[ind].x-pwid;                                                                   
//#3293        lin[4].y=pxNer[ind].y-pwid;                                                                   
//#3294        Polyline(dc,lin,5);                                                                   
//#3295    }                                                                       
//#3296                                                                           
//#3297    void boxs(){                                                                       
//#3298                                                                           
//#3299        unsigned    ind;                                                               
//#3300                                                                           
//#3301        SetROP2(rsdc,R2_NOTXORPEN);                                                                    
//#3302        for(ind=0;ind<selCnt;ind++){                                                                   
//#3303                                                                           
//#3304            SelectObject(rsdc,bPen[ind]);                                                               
//#3305            box(ind,rsdc);                                                               
//#3306        }                                                                   
//#3307        SetROP2(rsdc,R2_COPYPEN);                                                                   
//#3308    }                                                                       
//#3309                                                                           
//#3310    void dubx(){                                                                       
//#3311                                                                           
//#3312        POINT lin[5];                                                                   
//#3313        long pwid=boxOff[0];                                                                   
//#3314                                                                           
//#3315        SelectObject(sdc,bPen[0]);                                                                   
//#3316        SelectObject(rsdc,bPen[0]);                                                                   
//#3317        SetROP2(sdc,R2_NOTXORPEN);                                                                    
//#3318        SetROP2(rsdc,R2_NOTXORPEN);                                                                    
//#3319        lin[0].x=boxPix.x-pwid;                                                                   
//#3320        lin[0].y=boxPix.y-pwid;                                                                   
//#3321        lin[1].x=boxPix.x+pwid;                                                                   
//#3322        lin[1].y=boxPix.y-pwid;                                                                   
//#3323        lin[2].x=boxPix.x+pwid;                                                                   
//#3324        lin[2].y=boxPix.y+pwid;                                                                   
//#3325        lin[3].x=boxPix.x-pwid;                                                                   
//#3326        lin[3].y=boxPix.y+pwid;                                                                   
//#3327        lin[4].x=boxPix.x-pwid;                                                                   
//#3328        lin[4].y=boxPix.y-pwid;                                                                   
//#3329        Polyline(sdc,lin,5);                                                                   
//#3330        Polyline(rsdc,lin,5);                                                                   
//#3331        SetROP2(sdc,R2_COPYPEN);                                                                   
//#3332        SetROP2(rsdc,R2_COPYPEN);                                                                   
//#3333    }                                                                       
//#3334                                                                           
//#3335    void duar(){                                                                       
//#3336                                                                           
//#3337        POINT rpnt;                                                                   
//#3338                                                                           
//#3339        stchar[1].x=pPnt.x;                                                                   
//#3340        stchar[1].y=pPnt.y;                                                                   
//#3341        pixcntr.x=pPnt.x;                                                                   
//#3342        pixcntr.y=pPnt.y;                                                                   
//#3343        rpnt.x=pPnt.x-10;                                                                   
//#3344        rpnt.y=pPnt.y+10;                                                                   
//#3345        rotpix(rpnt,&stchar[0]);                                                                   
//#3346        rpnt.y=pPnt.y-10;                                                                   
//#3347        rotpix(rpnt,&stchar[2]);                                                                   
//#3348        SelectObject(sdc,bPen[0]);                                                                   
//#3349        SelectObject(rsdc,bPen[0]);                                                                   
//#3350        SetROP2(sdc,R2_NOTXORPEN);                                                                    
//#3351        SetROP2(rsdc,R2_NOTXORPEN);                                                                    
//#3352        Polyline(sdc,stchar,3);                                                                   
//#3353        Polyline(rsdc,stchar,3);                                                                   
//#3354        SetROP2(sdc,R2_COPYPEN);                                                                   
//#3355        SetROP2(rsdc,R2_COPYPEN);                                                                   
//#3356    }                                                                       
//#3357                                                                           
//#3358    void dubox(){                                                                       
//#3359                                                                           
//#3360        pixang=atan2(stchs[cloInd+1].y-stchs[cloInd].y,stchs[cloInd+1].x-stchs[cloInd].x);                                                                   
//#3361        duar();                                                                   
//#3362        rstMap(ELIN);                                                                   
//#3363        setMap(SELBOX);                                                                   
//#3364        rstMap(FRMPSEL);                                                                   
//#3365        redraw(hBar);                                                                   
//#3366        if(!numpnt)                                                                   
//#3367            ritnum(STR_NUMSEL,cloInd);                                                               
//#3368    }                                                                       
//#3369                                                                           
//#3370    void unbox(){                                                                       
//#3371                                                                           
//#3372        if(rstMap(SELBOX)){                                                                   
//#3373                                                                           
//#3374            SelectObject(rsdc,bPen[0]);                                                               
//#3375            SetROP2(rsdc,R2_NOTXORPEN);                                                                
//#3376            Polyline(rsdc,stchar,3);                                                               
//#3377            SetROP2(rsdc,R2_COPYPEN);                                                               
//#3378        }                                                                   
//#3379    }                                                                       
//#3380                                                                           
//#3381    void unboxs(){                                                                       
//#3382                                                                           
//#3383        if(selCnt){                                                                   
//#3384                                                                           
//#3385            boxs();                                                               
//#3386            selCnt=0;                                                               
//#3387        }                                                                   
//#3388    }                                                                       
//#3389                                                                           
//#3390    void redraw(HWND dWnd){                                                                       
//#3391                                                                           
//#3392        unsigned ind;                                                                   
//#3393                                                                           
//#3394        RedrawWindow(dWnd,NULL,NULL,RDW_INVALIDATE);                                                                   
//#3395        if(dWnd==hStch){                                                                   
//#3396                                                                           
//#3397            for(ind=0;ind<16;ind++){                                                               
//#3398                                                                           
//#3399                if(hDef[ind])                                                           
//#3400                    RedrawWindow(hDef[ind],NULL,NULL,RDW_INVALIDATE);                                                       
//#3401            }                                                               
//#3402            RedrawWindow(hBar,NULL,NULL,RDW_INVALIDATE);                                                               
//#3403        }                                                                   
//#3404    }                                                                       
//#3405                                                                           
//#3406    unsigned stch2px(unsigned stind){                                                                       
//#3407                                                                           
//#3408    #pragma warning(disable:4244;once:)                                                                       
//#3409        pPnt.x=(stchs[stind].x-zRct.left)*zrat.x+0.5;                                                                   
//#3410    #pragma warning(disable:4244;once:)                                                                       
//#3411        pPnt.y=scRct.bottom-(stchs[stind].y-zRct.bottom)*zrat.y+0.5;                                                                   
//#3412        if(    pPnt.x>=0&&                                                               
//#3413            pPnt.x<=scRct.right&&                                                               
//#3414            pPnt.y>=0&&                                                               
//#3415            pPnt.y<=scRct.bottom)                                                               
//#3416                                                                           
//#3417            return 1;                                                               
//#3418        else                                                                   
//#3419            return 0;                                                               
//#3420    }                                                                       
//#3421                                                                           
//#3422    void stch2px1(unsigned stind){                                                                       
//#3423                                                                           
//#3424    #pragma warning(disable:4244;once:)                                                                       
//#3425        pPnt.x=(stchs[stind].x-zRct.left)*zrat.x+0.5;                                                                   
//#3426    #pragma warning(disable:4244;once:)                                                                       
//#3427        pPnt.y=scRct.bottom-(stchs[stind].y-zRct.bottom)*zrat.y+0.5;                                                                   
//#3428    }                                                                       
//#3429                                                                           
//#3430    void stch2pxr(FLPNT stpnt){                                                                       
//#3431                                                                           
//#3432    #pragma warning(disable:4244;once:)                                                                       
//#3433        pPnt.x=(stpnt.x-zRct.left)*zrat.x+0.5;                                                                   
//#3434    #pragma warning(disable:4244;once:)                                                                       
//#3435        pPnt.y=scRct.bottom-(stpnt.y-zRct.bottom)*zrat.y+0.5;                                                                   
//#3436    }                                                                       
//#3437                                                                           
//#3438    void movins(){                                                                       
//#3439                                                                           
//#3440        if(chkMap(INSRT)){                                                                   
//#3441                                                                           
//#3442            if(chkMap(LIN1)){                                                               
//#3443                                                                           
//#3444                if(chkMap(BAKEND))                                                           
//#3445                    stch2px1(hed.stchs-1);                                                       
//#3446                else                                                           
//#3447                    stch2px1(0);                                                       
//#3448                endpnt();                                                           
//#3449            }                                                               
//#3450            else                                                               
//#3451                duIns();                                                           
//#3452        }                                                                   
//#3453    }                                                                       
//#3454                                                                           
//#3455    void defNam(TCHAR* fNam){                                                                       
//#3456                                                                           
//#3457        TCHAR* last;                                                                   
//#3458                                                                           
//#3459        if(fNam[0]){                                                                   
//#3460                                                                           
//#3461            strcpy(defDir,fNam);                                                               
//#3462            last=strrchr(defDir,'\\');                                                               
//#3463            if(last-defDir==2)                                                               
//#3464                last[1]=0;                                                           
//#3465            else                                                               
//#3466                last[0]=0;                                                           
//#3467        }                                                                   
//#3468    }                                                                       
//#3469                                                                           
//#3470    void defbNam(){                                                                       
//#3471                                                                           
//#3472        TCHAR* last;                                                                   
//#3473                                                                           
//#3474        if(lbnam[0]){                                                                   
//#3475                                                                           
//#3476            strcpy(defbmp,lbnam);                                                               
//#3477            last=strrchr(defbmp,'\\');                                                               
//#3478            if(last-defbmp==2)                                                               
//#3479                last[1]=0;                                                           
//#3480            else                                                               
//#3481                last[0]=0;                                                           
//#3482        }                                                                   
//#3483    }                                                                       
//#3484                                                                           
//#3485    void ritini(){                                                                       
//#3486                                                                           
//#3487        unsigned    ind;                                                               
//#3488        RECT        wrct;                                                           
//#3489                                                                           
//#3490        strcpy(ini.defDir,defDir);                                                                   
//#3491        for(ind=0;ind<16;ind++){                                                                   
//#3492                                                                           
//#3493            ini.stchCols[ind]=    useCol[ind];                                                           
//#3494            ini.bakCol[ind]=    bakCust[ind];                                                           
//#3495            ini.selStch[ind]=    custCol[ind];                                                           
//#3496            ini.bakBit[ind]=    bakBit[ind];                                                           
//#3497        }                                                                   
//#3498        ini.stchBak=stchBak;                                                                   
//#3499        ini.bitCol=bitCol;                                                                   
//#3500        ini.minsiz=minsiz;                                                                   
//#3501        ini.shopnts=shopnts;                                                                   
//#3502        ini.tsiz30=tsiz30;                                                                   
//#3503        ini.tsiz40=tsiz40;                                                                   
//#3504        ini.tsiz60=tsiz60;                                                                   
//#3505        ini.usesiz=usesiz;                                                                   
//#3506        ini.smalsiz=smalsiz;                                                                   
//#3507        ini.stchboxs=stchboxs;                                                                   
//#3508        ini.stspace=stspace;                                                                   
//#3509        ini.umap=umap;                                                                   
//#3510        ini.brdwid=brdwid;                                                                   
//#3511        ini.apcol=apcol;                                                                   
//#3512        ini.snplen=snplen;                                                                   
//#3513        ini.starat=starat;                                                                   
//#3514        ini.spirwrap=spirwrap;                                                                   
//#3515        ini.bfclen=bfclen;                                                                   
//#3516        ini.picspac=picspac;                                                                   
//#3517        if(!chku(SAVMAX)){                                                                   
//#3518                                                                           
//#3519            GetWindowRect(hWnd,&wrct);                                                               
//#3520            ini.irct.left=wrct.left;                                                               
//#3521            ini.irct.right=wrct.right;                                                               
//#3522            ini.irct.bottom=wrct.bottom;                                                               
//#3523            ini.irct.top=wrct.top;                                                               
//#3524        }                                                                   
//#3525        hIni=CreateFile(iniNam,(GENERIC_WRITE|GENERIC_READ),0,NULL,                                                                   
//#3526            CREATE_ALWAYS,0,NULL);                                                               
//#3527        if(hIni!=INVALID_HANDLE_VALUE)                                                                   
//#3528            WriteFile(hIni,&ini,sizeof(INIFIL),&red,NULL);                                                               
//#3529        CloseHandle(hIni);                                                                   
//#3530    }                                                                       
//#3531                                                                           
//#3532    BOOL gcmp(void* pnt,unsigned cnt){                                                                       
//#3533                                                                           
//#3534        _asm{                                                                   
//#3535                                                                           
//#3536                xor        eax,eax                                                   
//#3537                mov        esi,offset bseq                                                   
//#3538                mov        edi,pnt                                                   
//#3539                mov        ecx,cnt                                                   
//#3540                repe    cmpsd                                                       
//#3541                je        short gcmpx                                                   
//#3542                inc        eax                                                   
//#3543    gcmpx:                                                                       
//#3544        }                                                                   
//#3545    }                                                                       
//#3546                                                                           
//#3547    BOOL gcmpw(short wrd,unsigned ofst){                                                                       
//#3548                                                                           
//#3549        _asm{                                                                   
//#3550                                                                           
//#3551                xor        eax,eax                                                   
//#3552                mov        ebx,offset bseq                                                   
//#3553                add        ebx,ofst                                                   
//#3554                mov        bx,[ebx]                                                   
//#3555                cmp        bx,wrd                                                   
//#3556                je        short gcmpwx                                                   
//#3557                inc        eax                                                   
//#3558    gcmpwx:                                                                       
//#3559        }                                                                   
//#3560    }                                                                       
//#3561                                                                           
//#3562    BOOL bufcmp(TCHAR* tbuf,unsigned siz){                                                                       
//#3563                                                                           
//#3564        _asm{                                                                   
//#3565                                                                           
//#3566                xor        eax,eax                                                   
//#3567                mov        esi,tbuf                                                   
//#3568                mov        edi,offset bseq                                                   
//#3569                mov        ecx,siz                                                   
//#3570                repe    cmpsb                                                       
//#3571                jne        short bufcmp1                                                   
//#3572                inc        eax                                                   
//#3573    bufcmp1:                                                                       
//#3574        }                                                                   
//#3575    }                                                                       
//#3576                                                                           
//#3577    BOOL savcmp(){                                                                       
//#3578                                                                           
//#3579    #ifdef _DEBUG                                                                       
//#3580                                                                           
//#3581        return 1;                                                                   
//#3582                                                                           
//#3583    #else                                                                       
//#3584                                                                           
//#3585        return !chkMap(CMPDO);                                                                   
//#3586                                                                           
//#3587    #endif                                                                       
//#3588    }                                                                       
//#3589                                                                           
//#3590    void thr2bal(unsigned dst,unsigned src,unsigned cod){                                                                       
//#3591                                                                           
//#3592    #define BALRAT 1.6666666666667                                                                       
//#3593                                                                           
//#3594        pbal[dst].flg=0;                                                                   
//#3595        pbal[dst].cod=(unsigned char)cod;                                                                   
//#3596        pbal[dst].x=(stchs[src].x-balof.x)*BALRAT;                                                                   
//#3597        pbal[dst].y=(stchs[src].y-balof.y)*BALRAT;                                                                   
//#3598    }                                                                       
//#3599                                                                           
//#3600    unsigned coldis(COLORREF acol,COLORREF bcol){                                                                       
//#3601                                                                           
//#3602        unsigned dis;                                                                   
//#3603                                                                           
//#3604    //    dis=abs((acol&0xff)-(bcol&0xff));                                                                   
//#3605        dis = abs( (int)( (acol & 0xff) - (bcol & 0xff) ) ); // xiaoguang                                                                   
//#3606        acol>>=8;                                                                   
//#3607        bcol>>=8;                                                                   
//#3608    //    dis+=abs((acol&0xff)-(bcol&0xff));                                                                   
//#3609        dis += abs( (int)( (acol & 0xff)-(bcol & 0xff) ) ); // xiaoguang                                                                   
//#3610        acol>>=8;                                                                   
//#3611        bcol>>=8;                                                                   
//#3612    //    dis+=abs((acol&0xff)-(bcol&0xff));                                                                   
//#3613        dis += abs( (int)((acol & 0xff) - (bcol & 0xff)) ); // xiaoguang                                                                   
//#3614        return dis;                                                                   
//#3615    }                                                                       
//#3616                                                                           
//#3617    void bal2thr(unsigned dst,unsigned src,unsigned cod){                                                                       
//#3618                                                                           
//#3619    #define IBALRAT 0.6                                                                       
//#3620                                                                           
//#3621        stchs[dst].at=cod;                                                                   
//#3622        stchs[dst].x=pbal[src].x*IBALRAT+balof.x;                                                                   
//#3623        stchs[dst].y=pbal[src].y*IBALRAT+balof.y;                                                                   
//#3624    }                                                                       
//#3625                                                                           
//#3626    unsigned colmatch(COLORREF col){                                                                       
//#3627                                                                           
//#3628        unsigned ind,dis,mindis,pdis;                                                                   
//#3629                                                                           
//#3630        if(colCnt<16){                                                                   
//#3631                                                                           
//#3632            for(ind=0;ind<colCnt;ind++){                                                               
//#3633                                                                           
//#3634                if(col==useCol[ind])                                                           
//#3635                    return ind;                                                       
//#3636            }                                                               
//#3637            useCol[colCnt++]=col;                                                               
//#3638            return colCnt-1;                                                               
//#3639        }                                                                   
//#3640        else{                                                                   
//#3641                                                                           
//#3642            mindis=0xffffffff;                                                               
//#3643            for(ind=0;ind<colCnt;ind++){                                                               
//#3644                                                                           
//#3645                dis=coldis(col,useCol[ind]);                                                           
//#3646                if(!dis)                                                           
//#3647                    return ind;                                                       
//#3648                pdis=0;                                                           
//#3649                if(dis<mindis){                                                           
//#3650                                                                           
//#3651                    pdis=ind;                                                       
//#3652                    mindis=dis;                                                       
//#3653                }                                                           
//#3654            }                                                               
//#3655            return pdis;                                                               
//#3656        }                                                                   
//#3657    }                                                                       
//#3658                                                                           
//#3659    void redbal(){                                                                       
//#3660                                                                           
//#3661        HANDLE            btfil;                                                       
//#3662        BALHED            bhed;                                                       
//#3663        unsigned long    red;                                                               
//#3664        unsigned        ind,ine,bcnt,pbcol,col;                                                           
//#3665                                                                           
//#3666        hed.stchs=0;                                                                   
//#3667        formpnt=0;                                                                   
//#3668        btfil=CreateFile(balnam2,GENERIC_READ,0,0,OPEN_EXISTING,0,0);                                                                   
//#3669        if(btfil!=INVALID_HANDLE_VALUE){                                                                   
//#3670                                                                           
//#3671            ReadFile(btfil,(BALHED*)&bhed,sizeof(BALHED),&red,0);                                                               
//#3672            if(red==sizeof(BALHED)){                                                               
//#3673                                                                           
//#3674                pbal=(BALSTCH*)&bseq;                                                           
//#3675                ReadFile(btfil,(BALSTCH*)pbal,sizeof(bseq),&red,0);                                                           
//#3676                bcnt=red/sizeof(BALSTCH);                                                           
//#3677                ini.stchBak=stchBak=bhed.bcol;                                                           
//#3678                bakPen=nuPen(bakPen,1,stchBak);                                                           
//#3679                bakwid=1;                                                           
//#3680                DeleteObject(hStchBak);                                                           
//#3681                hStchBak=CreateSolidBrush(stchBak);                                                           
//#3682                zum0.x=ini.hupx=bhed.xhup*IBALRAT;                                                           
//#3683                zum0.y=ini.hupy=bhed.yhup*IBALRAT;                                                           
//#3684                balof.x=ini.hupx/2;                                                           
//#3685                balof.y=ini.hupy/2;                                                           
//#3686                ini.hup=hed.hup=CUSTHUP;                                                           
//#3687                useCol[0]=bhed.col[0];                                                           
//#3688                col=0;                                                           
//#3689                pbcol=1;                                                           
//#3690                ine=0;                                                           
//#3691                colCnt=1;                                                           
//#3692                for(ind=0;ind<bcnt;ind++){                                                           
//#3693                                                                           
//#3694                    switch(pbal[ind].cod){                                                       
//#3695                                                                           
//#3696                    case BALNORM:                                                       
//#3697                                                                           
//#3698                        bal2thr(ine++,ind,col);                                                   
//#3699                        break;                                                   
//#3700                                                                           
//#3701                    case BALSTOP:                                                       
//#3702                                                                           
//#3703                        col=colmatch(bhed.col[pbcol++]);                                                   
//#3704                        break;                                                   
//#3705                    }                                                       
//#3706                }                                                           
//#3707                for(ind=0;ind<colCnt;ind++){                                                           
//#3708                                                                           
//#3709                    uPen[ind]=CreatePen(PS_SOLID,1,useCol[ind]);                                                       
//#3710                    hbrUseCol[ind]=nuBrush(hbrUseCol[ind],useCol[ind]);                                                       
//#3711                }                                                           
//#3712                hed.stchs=ine;                                                           
//#3713                coltab();                                                           
//#3714                redraw(hBar);                                                           
//#3715                setMap(INIT);                                                           
//#3716                setMap(RESTCH);                                                           
//#3717            }                                                               
//#3718        }                                                                   
//#3719        CloseHandle(btfil);                                                                   
//#3720    }                                                                       
//#3721                                                                           
//#3722    void ritbal(){                                                                       
//#3723                                                                           
//#3724        BALHED            bhed;                                                       
//#3725        unsigned*        phed;                                                           
//#3726        unsigned        ind,ine,col;                                                           
//#3727        HANDLE            bfil;                                                       
//#3728        TCHAR*            pbchr;                                                       
//#3729        TCHAR            onam[MAX_PATH];                                                       
//#3730        unsigned long    wrot;                                                               
//#3731                                                                           
//#3732        if(*balnam0&&*balnam1&&hed.stchs){                                                                   
//#3733                                                                           
//#3734            if(!*filnam){                                                               
//#3735                                                                           
//#3736                strcpy(filnam,defDir);                                                           
//#3737                strcat(filnam,"\\balfil.thr");                                                           
//#3738            }                                                               
//#3739            strcpy(onam,filnam);                                                               
//#3740            pbchr=strrchr(onam,'.');                                                               
//#3741            if(pbchr)                                                               
//#3742                strcpy(pbchr,".thv");                                                           
//#3743            else                                                               
//#3744                strcat(pbchr,".thv");                                                           
//#3745            bfil=CreateFile(onam,GENERIC_WRITE,0,0,CREATE_ALWAYS,0,0);                                                               
//#3746            if(bfil==INVALID_HANDLE_VALUE)                                                               
//#3747                return;                                                           
//#3748            phed=(unsigned*)&bhed;                                                               
//#3749            for(ind=0;ind<(sizeof(BALHED)>>2);ind++)                                                               
//#3750                phed[ind]=0;                                                           
//#3751            col=stchs[0].at&COLMSK;                                                               
//#3752            bhed.col[0]=useCol[col];                                                               
//#3753            ine=1;                                                               
//#3754            for(ind=1;ind<hed.stchs;ind++){                                                               
//#3755                                                                           
//#3756                if(col!=(stchs[ind].at&COLMSK)){                                                           
//#3757                                                                           
//#3758                    col=stchs[ind].at&COLMSK;                                                       
//#3759                    bhed.col[ine++]=useCol[col];                                                       
//#3760                    if(ine&0xffffff00)                                                       
//#3761                        break;                                                   
//#3762                }                                                           
//#3763            }                                                               
//#3764            bhed.sig='drbm';                                                               
//#3765            bhed.bcol=stchBak;                                                               
//#3766            bhed.xhup=ini.hupx*BALRAT;                                                               
//#3767            bhed.yhup=ini.hupy*BALRAT;                                                               
//#3768            WriteFile(bfil,(BALHED*)&bhed,sizeof(BALHED),&wrot,0);                                                               
//#3769            balof.x=ini.hupx/2;                                                               
//#3770            balof.y=ini.hupy/2;                                                               
//#3771            pbal=(BALSTCH*)&bseq;                                                               
//#3772            col=stchs[0].at&COLMSK;                                                               
//#3773            thr2bal(0,0,BALJUMP);                                                               
//#3774            pbal[1].flg=(unsigned char)col;                                                               
//#3775            ine=1;                                                               
//#3776            for(ind=0;ind<hed.stchs;ind++){                                                               
//#3777                                                                           
//#3778                thr2bal(ine++,ind,BALNORM);                                                           
//#3779                if((stchs[ind].at&COLMSK)!=col){                                                           
//#3780                                                                           
//#3781                    thr2bal(ine,ind,BALSTOP);                                                       
//#3782                    col=stchs[ind].at&COLMSK;                                                       
//#3783                    pbal[ine++].flg=(unsigned char)col;                                                       
//#3784                }                                                           
//#3785            }                                                               
//#3786            WriteFile(bfil,(BALSTCH*)pbal,ine*sizeof(BALSTCH),&wrot,0);                                                               
//#3787            CloseHandle(bfil);                                                               
//#3788            bfil=CreateFile(balnam1,GENERIC_WRITE,0,0,CREATE_ALWAYS,0,0);                                                               
//#3789            WriteFile(bfil,(TCHAR*)onam,strlen(onam)+1,&wrot,0);                                                               
//#3790            CloseHandle(bfil);                                                               
//#3791        }                                                                   
//#3792        else{                                                                   
//#3793                                                                           
//#3794            if(*balnam1){                                                               
//#3795                                                                           
//#3796                bfil=CreateFile(balnam1,GENERIC_WRITE,0,0,CREATE_ALWAYS,0,0);                                                           
//#3797                CloseHandle(bfil);                                                           
//#3798            }                                                               
//#3799        }                                                                   
//#3800        if(*balnam0)                                                                   
//#3801            DeleteFile(balnam0);                                                               
//#3802    }                                                                       
//#3803                                                                           
//#3804    void savmsg(){                                                                       
//#3805                                                                           
//#3806        TCHAR    buf[HBUFSIZ];                                                               
//#3807                                                                           
//#3808        LoadString(hInst,IDS_SAVFIL,buf,HBUFSIZ);                                                                   
//#3809        sprintf(msgbuf,buf,thrnam);                                                                   
//#3810    }                                                                       
//#3811                                                                           
//#3812    void reldun()                                                                       
//#3813    {                                                                       
//#3814        txdun();                                                                   
//#3815        ritbal();                                                                   
//#3816        ritini();                                                                   
//#3817        dstcurs();                                                                   
//#3818        PostQuitMessage(0);                                                                   
//#3819    }                                                                       
//#3820                                                                           
//#3821    void dun(){                                                                       
//#3822                                                                           
//#3823        savtxt();                                                                   
//#3824        txof();                                                                   
//#3825        rstxt();                                                                   
//#3826        if(rstMap(PRFACT)){                                                                   
//#3827                                                                           
//#3828            DestroyWindow(hPrf);                                                               
//#3829            rstMap(WASRT);                                                               
//#3830        }                                                                   
//#3831        unsid();                                                                   
//#3832        unbsho();                                                                   
//#3833        rstAll();                                                                   
//#3834    //    if(savcmp()||(*balnam0&&*balnam1&&hed.stchs&&!formpnt))                                                                   
//#3835        if(savcmp()||(*balnam0))                                                                   
//#3836            reldun();                                                               
//#3837        else{                                                                   
//#3838                                                                           
//#3839            if(scRct.right){                                                               
//#3840                                                                           
//#3841                savdisc();                                                           
//#3842                setMap(SAVEX);
//#3843            }                                                               
//#3844            else{                                                               
//#3845                                                                           
//#3846                savmsg();                                                           
//#3847                if(MessageBox(hWnd,msgbuf,stab[STR_CLOS],MB_YESNO)==IDYES)                                                           
//#3848                    save();                                                       
//#3849                reldun();;                                                           
//#3850            }                                                               
//#3851        }                                                                   
//#3852    }                                                                       
//#3853                                                                           
//#3854    void dusid(unsigned str){                                                                       
//#3855                                                                           
//#3856        hsidWnd[str]=CreateWindow(                                                                   
//#3857            STATIC,                                                               
//#3858            sidstr[str],                                                               
//#3859            SS_NOTIFY|WS_CHILD|WS_VISIBLE|WS_BORDER,                                                               
//#3860            3                                                               
//#3861            sidloc*sidsiz.y+3,                                                               
//#3862            sidsiz.x+3,                                                               
//#3863            sidsiz.y,                                                               
//#3864            hSid,                                                               
//#3865            NULL,                                                               
//#3866            hInst,                                                               
//#3867            NULL);                                                               
//#3868        sidloc++;                                                                   
//#3869    }                                                                       
//#3870                                                                           
//#3871    void sidmsg(HWND hndl,TCHAR** pstr,unsigned cnt){                                                                       
//#3872                                                                           
//#3873        RECT        chkrct;                                                           
//#3874        RECT        mrct;                                                           
//#3875        unsigned    ind,ine=0,cnt1=cnt;                                                               
//#3876                                                                           
//#3877        FillMemory(&thDat,sizeof(int)*LASTLIN,0);                                                                   
//#3878        sidsiz.x=sidsiz.y=0;                                                                   
//#3879        sidloc=0;                                                                   
//#3880        sidstr=pstr;                                                                   
//#3881        GetWindowRect(hndl,&chkrct);                                                                   
//#3882        GetWindowRect(hfdat,&mrct);                                                                   
//#3883        ispcdclp();                                                                   
//#3884         if(chkMap(FILTYP)){                                                                   
//#3885                                                                           
//#3886            for(ind=0;ind<EDGETYPS+1;ind++){                                                               
//#3887                                                                           
//#3888                if((unsigned)(frmpnt->etyp&NEGUND)==egtyps[ind])                                                           
//#3889                    cnt1--;                                                       
//#3890                else{                                                           
//#3891                                                                           
//#3892                    if(egtyps[ind]==EGCLP||egtyps[ind]==EGPIC||egtyps[ind]==EGCLPX){                                                       
//#3893                                                                           
//#3894                        if(chkMap(WASPCDCLP))                                                   
//#3895                            maxtsiz(pstr[ind],&sidsiz);                                               
//#3896                        else                                                   
//#3897                            cnt1--;                                               
//#3898                    }                                                       
//#3899                    else                                                       
//#3900                        maxtsiz(pstr[ind],&sidsiz);                                                   
//#3901                }                                                           
//#3902            }                                                               
//#3903            hSid=CreateWindow(                                                               
//#3904                STATIC,                                                           
//#3905                0                                                           
//#3906                WS_BORDER|WS_CHILD|WS_VISIBLE,                                                           
//#3907                mrct.right-morg.x+3,                                                           
//#3908                chkrct.top-morg.y-3,                                                           
//#3909                sidsiz.x+12,                                                           
//#3910                sidsiz.y*cnt1+12,                                                           
//#3911                hWnd,                                                           
//#3912                NULL,                                                           
//#3913                hInst,                                                           
//#3914                NULL);                                                           
//#3915            for(ind=0;ind<cnt;ind++){                                                               
//#3916                                                                           
//#3917                if((unsigned)(frmpnt->etyp&NEGUND)!=egtyps[ind]){                                                           
//#3918                                                                           
//#3919                    if(egtyps[ind]==EGCLP||egtyps[ind]==EGPIC||egtyps[ind]==EGCLPX){                                                       
//#3920                                                                           
//#3921                        if(chkMap(WASPCDCLP))                                                   
//#3922                            dusid(ind);                                               
//#3923                    }                                                       
//#3924                    else                                                       
//#3925                        dusid(ind);                                                   
//#3926                }                                                           
//#3927            }                                                               
//#3928        }                                                                   
//#3929        else{                                                                   
//#3930                                                                           
//#3931            if(sidtyp==LLAYR)                                                               
//#3932                maxtsiz("0",&sidsiz);                                                           
//#3933            else{                                                               
//#3934                                                                           
//#3935                if(sidtyp==LFTHTYP){                                                           
//#3936                                                                           
//#3937                    cnt1=5;                                                       
//#3938                    sidsiz.x=buttonWid3;                                                       
//#3939                    sidsiz.y=buttonHi;                                                       
//#3940                }                                                           
//#3941                else{                                                           
//#3942                                                                           
//#3943                    for(ind=0;ind<cnt;ind++){                                                       
//#3944                                                                           
//#3945                        if((1<<filtyps[ind])&clpmap){                                                   
//#3946                                                                           
//#3947                            if(chkMap(WASPCDCLP))                                               
//#3948                                maxtsiz(pstr[ind],&sidsiz);                                           
//#3949                            else                                               
//#3950                                cnt1--;                                           
//#3951                        }                                                   
//#3952                        else{                                                   
//#3953                                                                           
//#3954                            if(filtyps[ind]==frmpnt->ftyp)                                               
//#3955                                cnt1--;                                           
//#3956                            else                                               
//#3957                                maxtsiz(pstr[ind],&sidsiz);                                           
//#3958                        }                                                   
//#3959                    }                                                       
//#3960                }                                                           
//#3961            }                                                               
//#3962            hSid=CreateWindow(                                                               
//#3963                STATIC,                                                           
//#3964                0                                                           
//#3965                WS_BORDER|WS_CHILD|WS_VISIBLE,                                                           
//#3966                mrct.right-morg.x+3,                                                           
//#3967                chkrct.top-morg.y-3,                                                           
//#3968                sidsiz.x+12,                                                           
//#3969                sidsiz.y*cnt1+12,                                                           
//#3970                hWnd,                                                           
//#3971                NULL,                                                           
//#3972                hInst,                                                           
//#3973                NULL);                                                           
//#3974            if(sidtyp==LLAYR){                                                               
//#3975                                                                           
//#3976                for(ind=0;ind<cnt;ind++)                                                           
//#3977                    dusid(ind);                                                       
//#3978            }                                                               
//#3979            else{                                                               
//#3980                                                                           
//#3981                if(sidtyp==LFTHTYP){                                                           
//#3982                                                                           
//#3983                    for(ind=0;ind<6;ind++){                                                       
//#3984                                                                           
//#3985                        if(fthtyps[ind]!=frmpnt->dhx.fth.fthtyp)                                                   
//#3986                            dusid(ind);                                               
//#3987                    }                                                       
//#3988                }                                                           
//#3989                else{                                                           
//#3990                                                                           
//#3991                    for(ind=0;ind<cnt;ind++){                                                       
//#3992                                                                           
//#3993                        if(filtyps[ind]!=frmpnt->ftyp){                                                   
//#3994                                                                           
//#3995                            if((1<<filtyps[ind])&clpmap){                                               
//#3996                                                                           
//#3997                                if(chkMap(WASPCDCLP))                                           
//#3998                                    dusid(ind);                                       
//#3999                            }                                               
//#4000                            else                                               
//#4001                                dusid(ind);                                           
//#4002                        }                                                   
//#4003                    }                                                       
//#4004                }                                                           
//#4005            }                                                               
//#4006        }                                                                   
//#4007        setMap(SIDACT);                                                                   
//#4008    }                                                                       
//#4009                                                                           
//#4010                                                                           
//#4011    void stchPars(){                                                                       
//#4012                                                                           
//#4013        aspct=(double)zum0.x/zum0.y;                                                                   
//#4014    #pragma warning(disable:4244;once:)                                                                       
//#4015        if(chkMap(RUNPAT)||chkMap(WASPAT))                                                                   
//#4016            stchSiz.x=(long)(mRct.bottom-(SCROLSIZ<<1))*aspct;                                                               
//#4017        else                                                                   
//#4018            stchSiz.x=(long)(mRct.bottom-SCROLSIZ)*aspct;                                                               
//#4019                                                                           
//#4020        if((stchSiz.x+(long)buttonWid3+RIGHTSIZ)<mRct.right){                                                                   
//#4021                                                                           
//#4022            if(chkMap(RUNPAT)||chkMap(WASPAT))                                                               
//#4023                stchSiz.y=mRct.bottom-(SCROLSIZ<<1);                                                           
//#4024            else                                                               
//#4025                stchSiz.y=mRct.bottom-SCROLSIZ;                                                           
//#4026        }                                                                   
//#4027        else{                                                                   
//#4028                                                                           
//#4029    #pragma warning(disable:4244;once:)                                                                       
//#4030            stchSiz.x=(mRct.right-buttonWid3-COLSIZ);                                                               
//#4031            stchSiz.y=mRct.bottom-mRct.top;                                                               
//#4032            if((double)stchSiz.x/stchSiz.y>aspct)                                                               
//#4033                stchSiz.x=stchSiz.y*aspct;                                                           
//#4034            else                                                               
//#4035                stchSiz.y=stchSiz.x/aspct;                                                           
//#4036        }                                                                   
//#4037    }                                                                       
//#4038                                                                           
//#4039    void movStch(){                                                                       
//#4040                                                                           
//#4041        POINT        psiz;                                                           
//#4042        long        vof=0;                                                           
//#4043        long        tstchy=stchSiz.y;                                                           
//#4044                                                                           
//#4045        psiz.x=mRct.right-buttonWid3-RIGHTSIZ;                                                                   
//#4046        psiz.y=mRct.bottom;                                                                   
//#4047        unboxs();                                                                   
//#4048        if(chkMap(RUNPAT)||chkMap(WASPAT)){                                                                   
//#4049                                                                           
//#4050            vof=SCROLSIZ;                                                               
//#4051            psiz.y-=SCROLSIZ;                                                               
//#4052            tstchy-=SCROLSIZ;                                                               
//#4053        }                                                                   
//#4054        if(chkMap(ZUMED)){                                                                   
//#4055                                                                           
//#4056            psiz.y-=SCROLSIZ;                                                               
//#4057            MoveWindow(hStch,buttonWid3,vof,psiz.x,psiz.y,FALSE);                                                               
//#4058            MoveWindow(hVrt,buttonWid3+psiz.x,0,SCROLSIZ,psiz.y,TRUE);                                                               
//#4059            MoveWindow(hHor,buttonWid3,psiz.y+vof,psiz.x,SCROLSIZ,TRUE);                                                               
//#4060            stchAspct=(double)psiz.x/psiz.y;                                                               
//#4061            if(chkMap(RUNPAT)||chkMap(WASPAT))                                                               
//#4062                MoveWindow(hSped,buttonWid3,0,psiz.x,SCROLSIZ,TRUE);                                                           
//#4063            ShowWindow(hVrt,TRUE);                                                               
//#4064            ShowWindow(hHor,TRUE);                                                               
//#4065        }                                                                   
//#4066        else{                                                                   
//#4067                                                                           
//#4068            stchPars();                                                               
//#4069            tstchy=stchSiz.y+SCROLSIZ;                                                               
//#4070            MoveWindow(hStch,buttonWid3,vof,stchSiz.x,tstchy,TRUE);                                                               
//#4071            ShowWindow(hVrt,FALSE);                                                               
//#4072            ShowWindow(hHor,FALSE);                                                               
//#4073            stchAspct=(double)stchSiz.x/tstchy;                                                               
//#4074            if(chkMap(RUNPAT)||chkMap(WASPAT))                                                               
//#4075                MoveWindow(hSped,buttonWid3,0,stchSiz.x,SCROLSIZ,TRUE);                                                           
//#4076        }                                                                   
//#4077        MoveWindow(hBar,mRct.right-COLSIZ,0,COLSIZ,mRct.bottom,TRUE);                                                                   
//#4078        nuRct();                                                                   
//#4079        redraw(hBar);                                                                   
//#4080    }                                                                       
//#4081                                                                           
//#4082    void zRctAdj(){                                                                       
//#4083                                                                           
//#4084        double    tdub;                                                               
//#4085                                                                           
//#4086        if(zRct.top>zum0.y){                                                                   
//#4087                                                                           
//#4088            tdub=zRct.top-zum0.y;                                                               
//#4089            zRct.top-=tdub;                                                               
//#4090            zRct.bottom-=tdub;                                                               
//#4091        }                                                                   
//#4092        if(zRct.bottom<0){                                                                   
//#4093                                                                           
//#4094            zRct.top-=zRct.bottom;                                                               
//#4095            zRct.bottom=0;                                                               
//#4096        }                                                                   
//#4097        if(zRct.right>zum0.x){                                                                   
//#4098                                                                           
//#4099            tdub=zRct.right-zum0.x;                                                               
//#4100            zRct.right-=tdub;                                                               
//#4101            zRct.left-=tdub;                                                               
//#4102        }                                                                   
//#4103        if(zRct.left<0){                                                                   
//#4104                                                                           
//#4105            zRct.right-=zRct.left;                                                               
//#4106            zRct.left=0;                                                               
//#4107        }                                                                   
//#4108    }                                                                       
//#4109                                                                           
//#4110    void shft(FLPNT shPnt){                                                                       
//#4111                                                                           
//#4112        DUBPNT    tsiz;                                                               
//#4113        DUBPNT    centr;                                                               
//#4114        DUBPNT    mov;                                                               
//#4115                                                                           
//#4116        tsiz.x=zRct.right-zRct.left;                                                                   
//#4117        tsiz.y=zRct.top-zRct.bottom;                                                                   
//#4118        tsiz.x/=2;                                                                   
//#4119        tsiz.y/=2;                                                                   
//#4120        centr.x=zRct.left+tsiz.x;                                                                   
//#4121        centr.y=zRct.bottom+tsiz.y;                                                                   
//#4122        mov.x=centr.x-shPnt.x;                                                                   
//#4123        mov.y=centr.y-shPnt.y;                                                                   
//#4124                                                                           
//#4125        zRct.bottom-=mov.y;                                                                   
//#4126        zRct.top-=mov.y;                                                                   
//#4127        zRct.left-=mov.x;                                                                   
//#4128        zRct.right-=mov.x;                                                                   
//#4129                                                                           
//#4130        zRctAdj();                                                                   
//#4131    }                                                                       
//#4132                                                                           
//#4133    void centr(){                                                                       
//#4134                                                                           
//#4135        POINT siz;                                                                   
//#4136                                                                           
//#4137        siz.x=zRct.top-zRct.bottom;                                                                   
//#4138        siz.y=zRct.right-zRct.left;                                                                   
//#4139        siz.x>>=1;                                                                   
//#4140        siz.y>>=1;                                                                   
//#4141        sPnt.x=zRct.left+siz.x;                                                                   
//#4142        sPnt.y=zRct.bottom+siz.y;                                                                   
//#4143    }                                                                       
//#4144                                                                           
//#4145    double pxchk(double dub){                                                                       
//#4146                                                                           
//#4147        if(dub<0.2)                                                                   
//#4148            return 1;                                                               
//#4149        if(dub>20)                                                                   
//#4150            return 20;                                                               
//#4151        return dub;                                                                   
//#4152    }                                                                       
//#4153                                                                           
//#4154    void chknum(){                                                                       
//#4155                                                                           
//#4156        double        tdub;                                                           
//#4157        unsigned    tuns;                                                               
//#4158                                                                           
//#4159        clrstch();                                                                   
//#4160        tdub=atof(msgbuf);                                                                   
//#4161        if(rstMap(ENTRDUP)){                                                                   
//#4162                                                                           
//#4163            if(tdub){                                                               
//#4164                                                                           
//#4165                ang=tdub*PI/180;                                                           
//#4166                ini.rotang=ang;                                                           
//#4167            }                                                               
//#4168            else                                                               
//#4169                ang=ini.rotang;                                                           
//#4170            duprot();                                                               
//#4171            return;                                                               
//#4172        }                                                                   
//#4173        if(rstMap(NUROT)){                                                                   
//#4174                                                                           
//#4175            if(tdub){                                                               
//#4176                                                                           
//#4177                ang=tdub*PI/180;                                                           
//#4178                ini.rotang=ang;                                                           
//#4179            }                                                               
//#4180            else                                                               
//#4181                ang=ini.rotang;                                                           
//#4182            return;                                                               
//#4183        }                                                                   
//#4184        if(rstMap(ENTRSEG)){                                                                   
//#4185                                                                           
//#4186            if(tdub){                                                               
//#4187                                                                           
//#4188                ang=2*PI/tdub;                                                           
//#4189                ini.rotang=ang;                                                           
//#4190            }                                                               
//#4191            else                                                               
//#4192                ang=ini.rotang;                                                           
//#4193            return;                                                               
//#4194        }                                                                   
//#4195        if(rstMap(ENTROT)){                                                                   
//#4196                                                                           
//#4197            if(tdub){                                                               
//#4198                                                                           
//#4199                ang=tdub*PI/180;                                                           
//#4200                ini.rotang=ang;                                                           
//#4201            }                                                               
//#4202            else                                                               
//#4203                ang=ini.rotang;                                                           
//#4204            rotfns();                                                               
//#4205            return;                                                               
//#4206        }                                                                   
//#4207        if(msgpnt)                                                                   
//#4208        {                                                                   
//#4209            if(sidtyp){                                                               
//#4210                                                                           
//#4211                tdub=atof(sidbuf)*PFGRAN;                                                           
//#4212                switch(sidtyp){                                                           
//#4213                                                                           
//#4214                case LTXOF:                                                           
//#4215                                                                           
//#4216                    savdo();                                                       
//#4217                    frmpnt->txof=tdub;                                                       
//#4218                    break;                                                       
//#4219                                                                           
//#4220                case LUANG:                                                           
//#4221                                                                           
//#4222                    savdo();                                                       
//#4223                    frmpnt->uang=tdub/180*PI/PFGRAN;                                                       
//#4224                    break;                                                       
//#4225                                                                           
//#4226                case LUSPAC:                                                           
//#4227                                                                           
//#4228                    savdo();                                                       
//#4229                    frmpnt->uspac=tdub;                                                       
//#4230                    break;                                                       
//#4231                                                                           
//#4232                case LWLKIND:                                                           
//#4233                                                                           
//#4234                    savdo();                                                       
//#4235                    frmpnt->wind=tdub;                                                       
//#4236                    break;                                                       
//#4237                                                                           
//#4238                case LULEN:                                                           
//#4239                                                                           
//#4240                    savdo();                                                       
//#4241                    frmpnt->ulen=tdub;                                                       
//#4242                    break;                                                       
//#4243                                                                           
//#4244                case LDSTRT:                                                           
//#4245                                                                           
//#4246                    savdo();                                                       
//#4247                    frmpnt->strt=tdub/PFGRAN;                                                       
//#4248                    frmpnt->strt%=sids;                                                       
//#4249                    break;                                                       
//#4250                                                                           
//#4251                case LDEND:                                                           
//#4252                                                                           
//#4253                    savdo();                                                       
//#4254                    frmpnt->end=tdub/PFGRAN;                                                       
//#4255                    frmpnt->end%=sids;                                                       
//#4256                    break;                                                       
//#4257                                                                           
//#4258                case LFTHUPCNT:                                                           
//#4259                                                                           
//#4260                    savdo();                                                       
//#4261                    tdub/=PFGRAN;                                                       
//#4262                    if(tdub>255)                                                       
//#4263                        tdub=255;                                                   
//#4264                    frmpnt->dhx.fth.fthup=tdub;                                                       
//#4265                    break;                                                       
//#4266                                                                           
//#4267                case LFTHCOL:                                                           
//#4268                                                                           
//#4269                    if(tdub){                                                       
//#4270                                                                           
//#4271                        savdo();                                                   
//#4272                        nufthcol((atoi(sidbuf)-1)&0xf);                                                   
//#4273                        SetWindowText(thDat[LFRMCOL],sidbuf);                                                   
//#4274                        coltab();                                                   
//#4275                    }                                                       
//#4276                    unsid();                                                       
//#4277                    setMap(RESTCH);                                                       
//#4278                    return;                                                       
//#4279                                                                           
//#4280                case LFRMCOL:                                                           
//#4281                                                                           
//#4282                    if(tdub){                                                       
//#4283                                                                           
//#4284                        savdo();                                                   
//#4285                        nufilcol((atoi(sidbuf)-1)&0xf);                                                   
//#4286                        SetWindowText(thDat[LFRMCOL],sidbuf);                                                   
//#4287                        coltab();                                                   
//#4288                    }                                                       
//#4289                    unsid();                                                       
//#4290                    setMap(RESTCH);                                                       
//#4291                    return;                                                       
//#4292                                                                           
//#4293                case LUNDCOL:                                                           
//#4294                                                                           
//#4295                    if(tdub){                                                       
//#4296                                                                           
//#4297                        savdo();                                                   
//#4298                        frmpnt->ucol=(atoi(sidbuf)-1)&0xf;                                                   
//#4299                        SetWindowText(thDat[LUNDCOL],sidbuf);                                                   
//#4300                        refilfn();                                                   
//#4301                        coltab();                                                   
//#4302                    }                                                       
//#4303                    unsid();                                                       
//#4304                    setMap(RESTCH);                                                       
//#4305                    return;                                                       
//#4306                                                                           
//#4307                case LBRDCOL:                                                           
//#4308                                                                           
//#4309                    if(tdub){                                                       
//#4310                                                                           
//#4311                        savdo();                                                   
//#4312                        nubrdcol((atoi(sidbuf)-1)&0xf);                                                   
//#4313                        SetWindowText(thDat[LFRMCOL],sidbuf);                                                   
//#4314                        coltab();                                                   
//#4315                    }                                                       
//#4316                    unsid();                                                       
//#4317                    setMap(RESTCH);                                                       
//#4318                    return;                                                       
//#4319                                                                           
//#4320                case LBRDPIC:                                                           
//#4321                                                                           
//#4322                    savdo();                                                       
//#4323                    frmpnt->espac=tdub;                                                       
//#4324                    refil();                                                       
//#4325    /*                                                                       
//#4326                    oclp(frmpnt->clp,frmpnt->nclp);                                                       
//#4327                    clpic(getlast());                                                       
//#4328                    unsid();                                                       
//#4329                    ritbrd();                                                       
//#4330                    coltab();                                                       
//#4331                    setMap(RESTCH);*/                                                       
//#4332                    return;                                                       
//#4333                                                                           
//#4334                case LFRMFAZ:                                                           
//#4335                                                                           
//#4336                    savdo();                                                       
//#4337                    frmpnt->wpar=floor(tdub)/PFGRAN;                                                       
//#4338                    unsid();                                                       
//#4339                    refil();                                                       
//#4340                    return;                                                       
//#4341                                                                           
//#4342                case LBRDPOS:                                                           
//#4343                                                                           
//#4344                    savdo();                                                       
//#4345                    frmpnt->elen=tdub/PFGRAN;                                                       
//#4346                    unsid();                                                       
//#4347                    refil();                                                       
//#4348                    return;                                                       
//#4349                                                                           
//#4350                case LMAXFIL:                                                           
//#4351                                                                           
//#4352                    savdo();                                                       
//#4353                    frmpnt->fmax=tdub;                                                       
//#4354                    unsid();                                                       
//#4355                    refil();                                                       
//#4356                    return;                                                       
//#4357                                                                           
//#4358                case LMINFIL:                                                           
//#4359                                                                           
//#4360                    savdo();                                                       
//#4361                    frmpnt->fmin=tdub;                                                       
//#4362                    unsid();                                                       
//#4363                    refil();                                                       
//#4364                    return;                                                       
//#4365                                                                           
//#4366                case LMAXBRD:                                                           
//#4367                                                                           
//#4368                    savdo();                                                       
//#4369                    frmpnt->emax=tdub;                                                       
//#4370                    unsid();                                                       
//#4371                    refil();                                                       
//#4372                    return;                                                       
//#4373                                                                           
//#4374                case LMINBRD:                                                           
//#4375                                                                           
//#4376                    savdo();                                                       
//#4377                    frmpnt->emin=tdub;                                                       
//#4378                    unsid();                                                       
//#4379                    refil();                                                       
//#4380                    return;                                                       
//#4381                }                                                           
//#4382                if(sidtyp==LBCSIZ){                                                           
//#4383                                                                           
//#4384                    savdo();                                                       
//#4385                    if(frmpnt->etyp==EGHOL)                                                       
//#4386                        savblen((float)tdub);                                                   
//#4387                    else                                                       
//#4388                        savplen((float)tdub);                                                   
//#4389                }                                                           
//#4390                else{                                                           
//#4391                                                                           
//#4392                    if(tdub){                                                       
//#4393                                                                           
//#4394                        switch(sidtyp){                                                   
//#4395                                                                           
//#4396                        case LFTHSIZ:                                                   
//#4397                                                                           
//#4398                            savdo();                                               
//#4399                            frmpnt->dhx.fth.fthrat=tdub/PFGRAN;                                               
//#4400                            break;                                               
//#4401                                                                           
//#4402                        case LFTHNUM:                                                   
//#4403                                                                           
//#4404                            savdo();                                               
//#4405                            frmpnt->dhx.fth.fthnum=tdub/PFGRAN;                                               
//#4406                            break;                                               
//#4407                                                                           
//#4408                        case LFTHFLR:                                                   
//#4409                                                                           
//#4410                            savdo();                                               
//#4411                            frmpnt->dhx.fth.fthflr=tdub;                                               
//#4412                            break;                                               
//#4413                                                                           
//#4414                        case LFTHDWNCNT:                                                   
//#4415                                                                           
//#4416                            savdo();                                               
//#4417                            tdub/=PFGRAN;                                               
//#4418                            if(tdub>255)                                               
//#4419                                tdub=255;                                           
//#4420                            frmpnt->dhx.fth.fthdwn=tdub;                                               
//#4421                            break;                                               
//#4422                                                                           
//#4423                        case LFRMSPAC:                                                   
//#4424                                                                           
//#4425                            savdo();                                               
//#4426                            frmpnt->fspac=tdub;                                               
//#4427                            break;                                               
//#4428                                                                           
//#4429                        case LFRMLEN:                                                   
//#4430                                                                           
//#4431                            savdo();                                               
//#4432                            frmpnt->flencnt.flen=tdub;                                               
//#4433                            break;                                               
//#4434                                                                           
//#4435                        case LBRDSPAC:                                                   
//#4436                                                                           
//#4437                            savdo();                                               
//#4438                            tuns=frmpnt->etyp&NEGUND;                                               
//#4439                            switch(tuns){                                               
//#4440                                                                           
//#4441                            case EGPRP:                                               
//#4442                                                                           
//#4443                                frmpnt->espac=tdub;                                           
//#4444                                break;                                           
//#4445                                                                           
//#4446                            case EGCHNH:                                               
//#4447                            case EGCHNL:                                               
//#4448                                                                           
//#4449                                frmpnt->espac=tdub;                                           
//#4450                                break;                                           
//#4451                                                                           
//#4452                            default:                                               
//#4453                                                                           
//#4454                                frmpnt->espac=tdub/2;                                           
//#4455                            }                                               
//#4456                            break;                                               
//#4457                                                                           
//#4458                        case LBRDLEN:                                                   
//#4459                                                                           
//#4460                            savdo();                                               
//#4461                            frmpnt->elen=tdub;                                               
//#4462                            break;                                               
//#4463                                                                           
//#4464                        case LBRDSIZ:                                                   
//#4465                                                                           
//#4466                            savdo();                                               
//#4467                            frmpnt->esiz=tdub;                                               
//#4468                            break;                                               
//#4469                                                                           
//#4470                        case LFRMANG:                                                   
//#4471                                                                           
//#4472                            savdo();                                               
//#4473                            frmpnt->angclp.fang=tdub/180*PI/PFGRAN;                                               
//#4474                            break;                                               
//#4475                                                                           
//#4476                        case LSACANG:                                                   
//#4477                                                                           
//#4478                            savdo();                                               
//#4479                            frmpnt->sacang.ang=tdub/180*PI/PFGRAN;                                               
//#4480                            break;                                               
//#4481                                                                           
//#4482                        case LAPCOL:                                                   
//#4483                                                                           
//#4484                            savdo();                                               
//#4485                            frmpnt->bcol&=0xf;                                               
//#4486                            tuns=tdub/6;                                               
//#4487                            if(tuns)                                               
//#4488                                tuns--;                                           
//#4489                            tuns&=0xf;                                               
//#4490                            frmpnt->bcol|=(tuns<<4);                                               
//#4491                            break;                                               
//#4492                        }                                                   
//#4493                    }                                                       
//#4494                    else{                                                       
//#4495                                                                           
//#4496                        savdo();                                                   
//#4497                        if(sidtyp==LFRMSPAC&&isfclp())                                                   
//#4498                            frmpnt->fspac=0;                                               
//#4499                    }                                                       
//#4500                }                                                           
//#4501                unsid();                                                           
//#4502                refil();                                                           
//#4503            }                                                               
//#4504            else{                                                               
//#4505                                                                           
//#4506                if(prfind){                                                           
//#4507                                                                           
//#4508                    tdub=atof(sidbuf);                                                       
//#4509                    switch(prfind-1){                                                       
//#4510                                                                           
//#4511                    case PEG:                                                       
//#4512                                                                           
//#4513                        ini.egrat=tdub;                                                   
//#4514                        sprintf(msgbuf,"%.2f",tdub);                                                   
//#4515                        SetWindowText(thDat[PEG],msgbuf);                                                   
//#4516                        break;                                                   
//#4517                                                                           
//#4518                    case PNUDG:                                                       
//#4519                                                                           
//#4520                        ini.nudg=tdub;                                                   
//#4521                        ini.nudgpix=pxchk(tdub);                                                   
//#4522                        sprintf(msgbuf,"%.2f",tdub);                                                   
//#4523                        SetWindowText(thDat[PNUDG],msgbuf);                                                   
//#4524                        break;                                                   
//#4525                                                                           
//#4526                    case PPIC:                                                       
//#4527                                                                           
//#4528                        picspac=tdub*PFGRAN;                                                   
//#4529                        sprintf(msgbuf,"%.2f",tdub);                                                   
//#4530                        SetWindowText(thDat[PPIC],msgbuf);                                                   
//#4531                        break;                                                   
//#4532                                                                           
//#4533                    case PCLPOF:                                                       
//#4534                                                                           
//#4535                        ini.clpof=tdub*PFGRAN;                                                   
//#4536                        sprintf(msgbuf,"%.2f mm",tdub);                                                   
//#4537                        SetWindowText(thDat[PCLPOF],msgbuf);                                                   
//#4538                        break;                                                   
//#4539                                                                           
//#4540                    case PFAZ:                                                       
//#4541                                                                           
//#4542                        ini.faz=floor(tdub);                                                   
//#4543                        sprintf(msgbuf,"%d",ini.faz);                                                   
//#4544                        SetWindowText(thDat[PFAZ],msgbuf);                                                   
//#4545                        break;                                                   
//#4546                                                                           
//#4547                    case PCHRAT:                                                       
//#4548                                                                           
//#4549                        ini.chrat=tdub;                                                   
//#4550                        sprintf(msgbuf,"%.2f",ini.chrat);                                                   
//#4551                        SetWindowText(thDat[PCHRAT],msgbuf);                                                   
//#4552                        break;                                                   
//#4553                                                                           
//#4554                    case PMIN:                                                       
//#4555                                                                           
//#4556                        minsiz=tdub*PFGRAN;                                                   
//#4557                        sprintf(msgbuf,"%.2f",tdub);                                                   
//#4558                        SetWindowText(thDat[PMIN],msgbuf);                                                   
//#4559                        break;                                                   
//#4560                                                                           
//#4561                    default:                                                       
//#4562                                                                           
//#4563                        if(tdub){                                                   
//#4564                                                                           
//#4565                            sprintf(msgbuf,"%.2f",tdub);                                               
//#4566                            switch(prfind-1){                                               
//#4567                                                                           
//#4568                            case PSPAC:                                               
//#4569                                                                           
//#4570                                stspace=tdub*PFGRAN;                                           
//#4571                                SetWindowText(thDat[PSPAC],msgbuf);                                           
//#4572                                break;                                           
//#4573                                                                           
//#4574                            case PANGL:                                               
//#4575                                                                           
//#4576                                ini.angl=tdub/180*PI;                                           
//#4577                                SetWindowText(thDat[PANGL],msgbuf);                                           
//#4578                                break;                                           
//#4579                                                                           
//#4580                            case PSAT:                                               
//#4581                                                                           
//#4582                                brdwid=tdub*PFGRAN;                                           
//#4583                                ini.brdwid=brdwid;                                           
//#4584                                SetWindowText(thDat[PSAT],msgbuf);                                           
//#4585                                break;                                           
//#4586                                                                           
//#4587                            case PMAX:                                               
//#4588                                                                           
//#4589                                ini.maxsiz=tdub*PFGRAN;                                           
//#4590                                SetWindowText(thDat[PMAX],msgbuf);                                           
//#4591                                break;                                           
//#4592                                                                           
//#4593                            case PUSE:                                               
//#4594                                                                           
//#4595                                usesiz=tdub*PFGRAN;                                           
//#4596                                SetWindowText(thDat[PUSE],msgbuf);                                           
//#4597                                break;                                           
//#4598                                                                           
//#4599                            case PSMAL:                                               
//#4600                                                                           
//#4601                                smalsiz=tdub*PFGRAN;                                           
//#4602                                SetWindowText(thDat[PSMAL],msgbuf);                                           
//#4603                                break;                                           
//#4604                                                                           
//#4605                            case PAP:                                               
//#4606                                                                           
//#4607                                apcol=(unsigned)(tdub-1)%16;                                           
//#4608                                sprintf(msgbuf,"%d",apcol+1);                                           
//#4609                                SetWindowText(thDat[PAP],msgbuf);                                           
//#4610                                break;                                           
//#4611                                                                           
//#4612                            case PSNP:                                               
//#4613                                                                           
//#4614                                snplen=tdub*PFGRAN;                                           
//#4615                                SetWindowText(thDat[PSNP],msgbuf);                                           
//#4616                                break;                                           
//#4617                                                                           
//#4618                            case PSTAR:                                               
//#4619                                                                           
//#4620                                starat=tdub;                                           
//#4621                                if(starat>1)                                           
//#4622                                    starat=1;                                       
//#4623                                if(starat<0.05)                                           
//#4624                                    starat=0.05;                                       
//#4625                                sprintf(msgbuf,"%.2f",starat);                                           
//#4626                                SetWindowText(thDat[PSTAR],msgbuf);                                           
//#4627                                break;                                           
//#4628                                                                           
//#4629                            case PSPIR:                                               
//#4630                                                                           
//#4631                                spirwrap=tdub;                                           
//#4632                                if(starat>20)                                           
//#4633                                    starat=20.;                                       
//#4634                                if(starat<0.3)                                           
//#4635                                    starat=0.3;                                       
//#4636                                sprintf(msgbuf,"%.2f",spirwrap);                                           
//#4637                                SetWindowText(thDat[PSPIR],msgbuf);                                           
//#4638                                break;                                           
//#4639                                                                           
//#4640                            case PBUT:                                               
//#4641                                                                           
//#4642                                bfclen=tdub*PFGRAN;                                           
//#4643                                sprintf(msgbuf,"%.2f",tdub);                                           
//#4644                                SetWindowText(thDat[PBUT],msgbuf);                                           
//#4645                                break;                                           
//#4646                                                                           
//#4647                            case PHUPX:                                               
//#4648                                                                           
//#4649                                ini.hupx=tdub*PFGRAN;                                           
//#4650                                sprintf(msgbuf,"%.0f mm",tdub);                                           
//#4651                                SetWindowText(thDat[PHUPX],msgbuf);                                           
//#4652                                sethup();                                           
//#4653                                prfmsg();                                           
//#4654                                chkhup();                                           
//#4655                                break;                                           
//#4656                                                                           
//#4657                            case PHUPY:                                               
//#4658                                                                           
//#4659                                ini.hupy=tdub*PFGRAN;                                           
//#4660                                sprintf(msgbuf,"%.0f mm",tdub);                                           
//#4661                                SetWindowText(thDat[PHUPY],msgbuf);                                           
//#4662                                sethup();                                           
//#4663                                prfmsg();                                           
//#4664                                chkhup();                                           
//#4665                                break;                                           
//#4666                                                                           
//#4667                            case PGRD:                                               
//#4668                                                                           
//#4669                                ini.grdsiz=tdub*PFGRAN;                                           
//#4670                                sprintf(msgbuf,"%.2f mm",tdub);                                           
//#4671                                SetWindowText(thDat[PGRD],msgbuf);                                           
//#4672                                break;                                           
//#4673                                                                           
//#4674                            case PCHN:                                               
//#4675                                                                           
//#4676                                ini.chspac=tdub*PFGRAN;                                           
//#4677                                sprintf(msgbuf,"%.2f",tdub);                                           
//#4678                                SetWindowText(thDat[PCHN],msgbuf);                                           
//#4679                                break;                                           
//#4680                            }                                               
//#4681                        }                                                   
//#4682                    }                                                       
//#4683                    unsid();                                                       
//#4684                    prfind=0;                                                       
//#4685                }                                                           
//#4686                else{                                                           
//#4687                                                                           
//#4688                    tdub=atof(msgbuf);                                                       
//#4689                    if(rstMap(SCLPSPAC))                                                       
//#4690                        ini.clpof=tdub*PFGRAN;                                                   
//#4691                    if(rstMap(FSETFIND))                                                       
//#4692                        dufind(tdub);                                                   
//#4693                    if(rstMap(FSETFHI))                                                       
//#4694                    {                                                       
//#4695                        if(tdub)                                                   
//#4696                            dufhi(tdub*PFGRAN);                                               
//#4697                    }                                                       
//#4698                    if(rstMap(FSETFWID))                                                       
//#4699                    {                                                       
//#4700                        if(tdub)                                                   
//#4701                            dufwid(tdub*PFGRAN);                                               
//#4702                    }                                                       
//#4703                    if(rstMap(FSETFMAX))                                                       
//#4704                    {                                                       
//#4705                        if(tdub)                                                   
//#4706                            dufmax(tdub*PFGRAN);                                               
//#4707                    }                                                       
//#4708                    if(rstMap(FSETFMIN))                                                       
//#4709                        dufmin(tdub*PFGRAN);                                                   
//#4710                    if(rstMap(FSETBMAX))                                                       
//#4711                    {                                                       
//#4712                        if(tdub)                                                   
//#4713                            dubmax(tdub*PFGRAN);                                               
//#4714                    }                                                       
//#4715                    if(rstMap(FSETBMIN))                                                       
//#4716                        dubmin(tdub*PFGRAN);                                                   
//#4717                    if(rstMap(FSETBSPAC))                                                       
//#4718                    {                                                       
//#4719                        if(tdub)                                                   
//#4720                            dubspac(tdub*PFGRAN);                                               
//#4721                    }                                                       
//#4722                    if(rstMap(FSETFLEN))                                                       
//#4723                    {                                                       
//#4724                        if(tdub)                                                   
//#4725                            dublen(tdub*PFGRAN);                                               
//#4726                    }                                                       
//#4727                    if(rstMap(FSETBCOL))                                                       
//#4728                        dubcol(tdub);                                                   
//#4729                    if(rstMap(FSETFCOL))                                                       
//#4730                        dufcol(tdub);                                                   
//#4731                    if(rstMap(FSETUCOL))                                                       
//#4732                        dundcol(tdub);                                                   
//#4733                    if(rstMap(FSETFANG))                                                       
//#4734                        dufxang(tdub);                                                   
//#4735                    if(rstMap(FSETFSPAC))                                                       
//#4736                    {                                                       
//#4737                        if(tdub)                                                   
//#4738                            dufspac(tdub*PFGRAN);                                               
//#4739                    }                                                       
//#4740                    if(rstMap(FSETUANG))                                                       
//#4741                        dufang(tdub);                                                   
//#4742                    if(rstMap(FSETFLEN))                                                       
//#4743                    {                                                       
//#4744                        if(tdub)                                                   
//#4745                            duflen(tdub*PFGRAN);                                               
//#4746                    }                                                       
//#4747                    if(rstMap(FSETUSPAC))                                                       
//#4748                    {                                                       
//#4749                        if(tdub)                                                   
//#4750                            duspac(tdub*PFGRAN);                                               
//#4751                    }                                                       
//#4752                    if(rstMap(FSETULEN))                                                       
//#4753                    {                                                       
//#4754                        if(tdub)                                                   
//#4755                            dusulen(tdub*PFGRAN);                                               
//#4756                    }                                                       
//#4757                    if(rstMap(GTUANG))                                                       
//#4758                        ini.uang=tdub/180*PI;                                                   
//#4759                    if(rstMap(GTUSPAC))                                                       
//#4760                    {                                                       
//#4761                        if(tdub)                                                   
//#4762                            ini.uspac=tdub*PFGRAN;                                               
//#4763                    }                                                       
//#4764                    if(rstMap(GTWLKIND))                                                       
//#4765                        ini.wind=tdub*PFGRAN;                                                   
//#4766                    if(rstMap(GTWLKLEN))                                                       
//#4767                    {                                                       
//#4768                        if(tdub)                                                   
//#4769                            ini.ulen=tdub*PFGRAN;                                               
//#4770                    }                                                       
//#4771                    if(rstMap(PIXIN))                                                       
//#4772                        ini.nudgpix=pxchk(tdub);                                                   
//#4773                    if(rstMap(STPXIN))                                                       
//#4774                        ini.stchpix=pxchk(tdub);                                                   
//#4775                    if(rstMap(FRMPXIN))                                                       
//#4776                        ini.frmpix=tdub;                                                   
//#4777                    if(rstMap(FRMBOXIN))                                                       
//#4778                        ini.frmbpix=tdub;                                                   
//#4779                    if(rstMap(GETMIN))                                                       
//#4780                        smalsiz=tdub*PFGRAN;                                                   
//#4781                    if(rstMap(ENTR30))                                                       
//#4782                        tsiz30=tdub;                                                   
//#4783                    if(rstMap(ENTR40))                                                       
//#4784                        tsiz40=tdub;                                                   
//#4785                    if(rstMap(ENTR60))                                                       
//#4786                        tsiz60=tdub;                                                   
//#4787                    if(rstMap(ENTRFNUM)){                                                       
//#4788                                                                           
//#4789                        if(tdub<formpnt)                                                   
//#4790                            frmnumfn(tdub);                                               
//#4791                        else                                                   
//#4792                            tabmsg(IDS_FRMN1);                                               
//#4793                        return;                                                   
//#4794                    }                                                       
//#4795                    tdub=floor(tdub);                                                       
//#4796                    if(rstMap(ENTRPOL))                                                       
//#4797                        durpoli(tdub);                                                   
//#4798                    if(rstMap(ENTRSTAR))                                                       
//#4799                        dustar(tdub,250/tdub*zumFct*(zum0.x+zum0.y)/(LHUPX+LHUPY));                                                   
//#4800                    if(rstMap(ENTRSPIR))                                                       
//#4801                        duspir(tdub);                                                   
//#4802                    if(rstMap(ENTRHART))                                                       
//#4803                        duhart(tdub);                                                   
//#4804                    if(rstMap(ENTRLENS))                                                       
//#4805                        dulens(tdub);                                                   
//#4806                    if(rstMap(ENTREG))                                                       
//#4807                        dueg(tdub);                                                   
//#4808                    if(rstMap(ENTRZIG))                                                       
//#4809                        duzig(tdub);                                                   
//#4810                }                                                           
//#4811            }                                                               
//#4812        }                                                                   
//#4813        setMap(RESTCH);                                                                   
//#4814    }                                                                       
//#4815                                                                           
//#4816    void noMsg(){                                                                       
//#4817                                                                           
//#4818        if(DestroyWindow(hMsg))                                                                   
//#4819            hMsg=0;                                                               
//#4820        DestroyWindow(hok);                                                                   
//#4821        DestroyWindow(hdsc);                                                                   
//#4822        DestroyWindow(hcan);                                                                   
//#4823        DestroyWindow(hmin);                                                                   
//#4824        DestroyWindow(hto);                                                                   
//#4825        if(rstMap(NUMIN)||sidtyp||prfind)                                                                   
//#4826            chknum();                                                               
//#4827        rstMap(MOVMSG);                                                                   
//#4828        rstMap(DELFRM);                                                                   
//#4829        rstMap(FILMSG);                                                                   
//#4830        setMap(RESTCH);                                                                   
//#4831    }                                                                       
//#4832                                                                           
//#4833    void stchWnd(){                                                                       
//#4834                                                                           
//#4835        stchPars();                                                                   
//#4836                                                                           
//#4837        hStch=CreateWindow(                                                                   
//#4838            STATIC,                                                               
//#4839            0                                                               
//#4840            SS_OWNERDRAW|WS_CHILD|WS_VISIBLE|WS_BORDER,                                                               
//#4841            buttonWid3,                                                               
//#4842            0                                                               
//#4843            stchSiz.x,                                                               
//#4844            stchSiz.y,                                                               
//#4845            hWnd,                                                               
//#4846            NULL,                                                               
//#4847            hInst,                                                               
//#4848            NULL);                                                               
//#4849                                                                           
//#4850        GetWindowRect(hStch,&sRct);                                                                   
//#4851                                                                           
//#4852        hVrt=CreateWindow(                                                                   
//#4853            SCROLLBAR,                                                               
//#4854            0                                                               
//#4855            SBS_VERT|WS_CHILD|WS_VISIBLE,                                                               
//#4856            stchSiz.x+buttonWid3,                                                               
//#4857            0                                                               
//#4858            SCROLSIZ,                                                               
//#4859            stchSiz.y,                                                               
//#4860            hWnd,                                                               
//#4861            NULL,                                                               
//#4862            hInst,                                                               
//#4863            NULL);                                                               
//#4864                                                                           
//#4865        hHor=CreateWindow(                                                                   
//#4866            SCROLLBAR,                                                               
//#4867            0                                                               
//#4868            SBS_HORZ|WS_CHILD|WS_VISIBLE,                                                               
//#4869            buttonWid3,                                                               
//#4870            stchSiz.y,                                                               
//#4871            stchSiz.x,                                                               
//#4872            SCROLSIZ,                                                               
//#4873            hWnd,                                                               
//#4874            NULL,                                                               
//#4875            hInst,                                                               
//#4876            NULL);                                                               
//#4877        ShowWindow(hVrt,FALSE);                                                                   
//#4878        ShowWindow(hHor,FALSE);                                                                   
//#4879    }                                                                       
//#4880                                                                           
//#4881    //check if a click occurred in A veritcal set of 16 windows                                                                       
//#4882    // and calculate which window had the click                                                                       
//#4883    unsigned chkMsgs(POINT pt,HWND tWnd,HWND bWnd){                                                                       
//#4884                                                                           
//#4885        RECT    tRct;                                                               
//#4886        RECT    bRct;                                                               
//#4887                                                                           
//#4888        GetWindowRect(tWnd,&tRct);                                                                   
//#4889        GetWindowRect(bWnd,&bRct);                                                                   
//#4890                                                                           
//#4891        if(pt.x>tRct.left&&pt.x<bRct.right&&pt.y>tRct.top&&pt.y<bRct.bottom){                                                                   
//#4892                                                                           
//#4893            vind=15-(bRct.bottom-pt.y)/buttonHi;                                                               
//#4894            return 1;                                                               
//#4895        }                                                                   
//#4896        else                                                                   
//#4897            return 0;                                                               
//#4898    }                                                                       
//#4899                                                                           
//#4900    HWND nuSiz(unsigned wndPnt){                                                                       
//#4901                                                                           
//#4902        TCHAR*    str[]={"30","40","60"};                                                               
//#4903                                                                           
//#4904        return CreateWindow(                                                                   
//#4905            STATIC,                                                               
//#4906            str[wndPnt],                                                               
//#4907            WS_CHILD|WS_VISIBLE|WS_BORDER,                                                               
//#4908            buttonWid3,                                                               
//#4909            buttonHi*(wndPnt+vind),                                                               
//#4910            buttonWid,                                                               
//#4911            buttonHi,                                                               
//#4912            hWnd,                                                               
//#4913            NULL,                                                               
//#4914            hInst,                                                               
//#4915            NULL);                                                               
//#4916    }                                                                       
//#4917                                                                           
//#4918    void delstch1(unsigned ind){                                                                       
//#4919                                                                           
//#4920        if(hed.stchs){                                                                   
//#4921                                                                           
//#4922            while(ind<=hed.stchs){                                                               
//#4923                                                                           
//#4924                stchs[ind].at=stchs[ind+1].at;                                                           
//#4925                stchs[ind].x=stchs[ind+1].x;                                                           
//#4926                stchs[ind].y=stchs[ind+1].y;                                                           
//#4927                ind++;                                                           
//#4928            }                                                               
//#4929            hed.stchs--;                                                               
//#4930            if(cloInd>(unsigned)hed.stchs-1)                                                               
//#4931                cloInd=hed.stchs-1;                                                           
//#4932        }                                                                   
//#4933    }                                                                       
//#4934                                                                           
//#4935    void stchred(unsigned siz,SHRTPNT* src){                                                                       
//#4936                                                                           
//#4937        _asm{                                                                   
//#4938                                                                           
//#4939                mov        edi,offset stchs                                                   
//#4940                mov        esi,src                                                   
//#4941                mov        ecx,siz                                                   
//#4942                rep        movsd                                                   
//#4943        }                                                                   
//#4944    }                                                                       
//#4945                                                                           
//#4946    void redbak(){                                                                       
//#4947                                                                           
//#4948        BAKHED*        bdat;                                                           
//#4949        unsigned    ind;                                                               
//#4950                                                                           
//#4951        bdat=(BAKHED*)bakdat[dupnt0];                                                                   
//#4952        hed.stchs=bdat->scnt;                                                                   
//#4953        if(hed.stchs)                                                                   
//#4954            stchred((sizeof(SHRTPNT)*hed.stchs)>>2,bdat->stch);                                                               
//#4955        zum0.x=bdat->zum0.x;                                                                   
//#4956        zum0.y=bdat->zum0.y;                                                                   
//#4957        formpnt=bdat->fcnt;                                                                   
//#4958    //    for(ind=0;ind<formpnt;ind++)                                                                   
//#4959    //        frmcpy(&formlst[ind],&bdat->frmp[ind]);                                                               
//#4960        MoveMemory(&formlst,bdat->frmp,sizeof(FRMHED)*formpnt);                                                                   
//#4961        fltad=bdat->fltcnt;                                                                   
//#4962        if(fltad)                                                                   
//#4963            mvflpnt(&flts[0],&bdat->flt[0],fltad);                                                               
//#4964        satkad=bdat->sacnt;                                                                   
//#4965        if(satkad)                                                                   
//#4966            mvsatk(&satks[0],&bdat->sac[0],satkad);                                                               
//#4967        clpad=bdat->nclp;                                                                   
//#4968        if(clpad)                                                                   
//#4969            mvflpnt(&clps[0],&bdat->clp[0],clpad);                                                               
//#4970        MoveMemory(&useCol,bdat->cols,sizeof(COLORREF)*16);                                                                   
//#4971        for(ind=0;ind<16;ind++){                                                                   
//#4972                                                                           
//#4973            uPen[ind]=nuPen(uPen[ind],1,useCol[ind]);                                                               
//#4974            hbrUseCol[ind]=nuBrush(hbrUseCol[ind],useCol[ind]);                                                               
//#4975        }                                                                   
//#4976        for(ind=0;ind<16;ind++)                                                                   
//#4977            redraw(hCol[ind]);                                                               
//#4978        txad=bdat->ntx;                                                                   
//#4979        if(txad)                                                                   
//#4980            MoveMemory(&txpnts,bdat->txp,sizeof(TXPNT)*txad);                                                               
//#4981        coltab();                                                                   
//#4982        setMap(RESTCH);                                                                   
//#4983    }                                                                       
//#4984                                                                           
//#4985    void redo(){                                                                       
//#4986                                                                           
//#4987        unsigned ind;                                                                   
//#4988                                                                           
//#4989        if(chkMap(BAKACT)&&chkMap(REDUSHO)){                                                                   
//#4990                                                                           
//#4991            dupnt0++;                                                               
//#4992            dupnt0&=0xf;                                                               
//#4993            ind=(dupnt0+1)&0xf;                                                               
//#4994            if(ind==dupnt1){                                                               
//#4995                                                                           
//#4996                EnableMenuItem(hMen,M_REDO,MF_BYPOSITION|MF_GRAYED);                                                           
//#4997                rstMap(REDUSHO);                                                           
//#4998            }                                                               
//#4999            else{                                                               
//#5000                                                                           
//#5001                if(!setMap(REDUSHO))                                                           
//#5002                    EnableMenuItem(hMen,M_REDO,MF_BYPOSITION|MF_ENABLED);                                                       
//#5003            }                                                               
//#5004            if(!setMap(UNDUSHO)){                                                               
//#5005                                                                           
//#5006                EnableMenuItem(hMen,M_UNDO,MF_BYPOSITION|MF_ENABLED);                                                           
//#5007            }                                                               
//#5008            redbak();                                                               
//#5009            setMap(DUMEN);                                                               
//#5010        }                                                                   
//#5011    }                                                                       
//#5012                                                                           
//#5013    void bak(){                                                                       
//#5014                                                                           
//#5015        unsigned ind;                                                                   
//#5016                                                                           
//#5017        unmsg();                                                                   
//#5018        rstMap(FPSEL);                                                                   
//#5019        rstMap(FRMPSEL);                                                                   
//#5020        rstMap(BIGBOX);                                                                   
//#5021        if(rstMap(PRFACT)){                                                                   
//#5022                                                                           
//#5023            rstMap(WASRT);                                                               
//#5024            DestroyWindow(hPrf);                                                               
//#5025            prfind=0;                                                               
//#5026            unsid();                                                               
//#5027        }                                                                   
//#5028        if(!setMap(BAKING)){                                                                   
//#5029                                                                           
//#5030            dudat();                                                               
//#5031            dupnt1=dupnt0+1;                                                               
//#5032        }                                                                   
//#5033        if(chkMap(BAKWRAP)){                                                                   
//#5034                                                                           
//#5035            dupnt0--;                                                               
//#5036            dupnt0&=0xf;                                                               
//#5037            ind=dupnt0-1;                                                               
//#5038            if(ind==dupnt1){                                                               
//#5039                                                                           
//#5040                EnableMenuItem(hMen,M_UNDO,MF_BYPOSITION|MF_GRAYED);                                                           
//#5041                setMap(DUMEN);                                                           
//#5042                rstMap(UNDUSHO);                                                           
//#5043            }                                                               
//#5044        }                                                                   
//#5045        else{                                                                   
//#5046                                                                           
//#5047            if(dupnt0)                                                               
//#5048                dupnt0--;                                                           
//#5049            if(!dupnt0){                                                               
//#5050                                                                           
//#5051                EnableMenuItem(hMen,M_UNDO,MF_BYPOSITION|MF_GRAYED);                                                           
//#5052                setMap(DUMEN);                                                           
//#5053                rstMap(UNDUSHO);                                                           
//#5054            }                                                               
//#5055        }                                                                   
//#5056        if(!setMap(REDUSHO)){                                                                   
//#5057                                                                           
//#5058            EnableMenuItem(hMen,M_REDO,MF_BYPOSITION|MF_ENABLED);                                                               
//#5059            setMap(DUMEN);                                                               
//#5060        }                                                                   
//#5061        rstMap(FORMSEL);                                                                   
//#5062        rstMap(GRPSEL);                                                                   
//#5063        redbak();                                                                   
//#5064    }                                                                       
//#5065                                                                           
//#5066    void bitsiz(){                                                                       
//#5067                                                                           
//#5068        double                srat;                                                   
//#5069        double                brat;                                                   
//#5070                                                                           
//#5071        brat=(double)bwid/bhi;                                                                   
//#5072        srat=(double)zum0.x/zum0.y;                                                                   
//#5073        if(brat>srat){                                                                   
//#5074                                                                           
//#5075            zumend.x=zum0.x;                                                               
//#5076            zumend.y=zum0.x/brat;                                                               
//#5077            scend.x=scRct.right;                                                               
//#5078            scend.y=scRct.right/brat;                                                               
//#5079        }                                                                   
//#5080        else{                                                                   
//#5081                                                                           
//#5082            zumend.y=zum0.y;                                                               
//#5083            zumend.x=zum0.y*brat;                                                               
//#5084            scend.y=scRct.bottom;                                                               
//#5085            scend.x=scRct.bottom*brat;                                                               
//#5086        }                                                                   
//#5087        bsrat.x=(double)bwid/zumend.x;                                                                   
//#5088        bsrat.y=(double)bhi/zumend.y;                                                                   
//#5089        birat.x=(double)zumend.x/bwid;                                                                   
//#5090        birat.y=(double)zumend.y/bhi;                                                                   
//#5091    }                                                                       
//#5092                                                                           
//#5093    BOOL binv(unsigned cnt){                                                                       
//#5094                                                                           
//#5095        unsigned    ind,ine,icnt,ncnt,lcnt;                                                               
//#5096        TCHAR*        bcpnt;                                                           
//#5097                                                                           
//#5098        icnt=ncnt=0;                                                                   
//#5099        lcnt=bwid>>3;                                                                   
//#5100        for(ind=0;ind>bhi;ind++){                                                                   
//#5101                                                                           
//#5102            bcpnt=(TCHAR*)&bpnt[cnt*ind];                                                               
//#5103            for(ine=0;ine<lcnt;ine++){                                                               
//#5104                                                                           
//#5105                if(!bcpnt[ine])                                                           
//#5106                    ncnt++;                                                       
//#5107                else{                                                           
//#5108                                                                           
//#5109                    if(bcpnt[ine]==0xff)                                                       
//#5110                        icnt++;                                                   
//#5111                }                                                           
//#5112            }                                                               
//#5113        }                                                                   
//#5114        if(icnt>ncnt)                                                                   
//#5115            return 1;                                                               
//#5116        else                                                                   
//#5117            return 0;                                                               
//#5118    }                                                                       
//#5119                                                                           
//#5120    void bitlin(unsigned* src,unsigned* dst,COLORREF fgnd,COLORREF bgnd){                                                                       
//#5121                                                                           
//#5122        _asm{                                                                   
//#5123                                                                           
//#5124                mov        esi,src                                                   
//#5125                mov        edi,dst                                                   
//#5126                mov        ecx,bwid                                                   
//#5127                xor        eax,eax                                                   
//#5128    blup:        mov        ebx,eax                                                       
//#5129                xor        bl,7                                                   
//#5130                mov        edx,bgnd                                                   
//#5131                bt        [esi],ebx                                                   
//#5132                jnc        short blup1                                                   
//#5133                mov        edx,fgnd                                                   
//#5134    blup1:        mov        [edi],edx                                                       
//#5135                add        edi,4                                                   
//#5136                inc        eax                                                   
//#5137                loop    blup                                                       
//#5138        }                                                                   
//#5139    }                                                                       
//#5140                                                                           
//#5141    COLORREF fswap(COLORREF tcol){                                                                       
//#5142                                                                           
//#5143        _asm{                                                                   
//#5144                                                                           
//#5145                mov        eax,tcol                                                   
//#5146                bswap    eax                                                       
//#5147                shr        eax,8                                                   
//#5148        }                                                                   
//#5149    }                                                                       
//#5150                                                                           
//#5151    BOOL gudtyp(WORD bcnt){                                                                       
//#5152                                                                           
//#5153        switch(bcnt){                                                                   
//#5154                                                                           
//#5155        case 1:                                                                   
//#5156                                                                           
//#5157            return 1;                                                               
//#5158                                                                           
//#5159        case 24:                                                                   
//#5160                                                                           
//#5161            return 1;                                                               
//#5162                                                                           
//#5163        case 32:                                                                   
//#5164                                                                           
//#5165            return 1;                                                               
//#5166        }                                                                   
//#5167        return 0;                                                                   
//#5168    }                                                                       
//#5169                                                                           
//#5170    void movmap(unsigned cnt){                                                                       
//#5171                                                                           
//#5172        _asm{                                                                   
//#5173                                                                           
//#5174                mov        ecx,cnt                                                   
//#5175                mov        esi,tracbits                                                   
//#5176                mov        edi,offset bseq                                                   
//#5177    movlup:        mov        eax,[esi]                                                       
//#5178                add        esi,4                                                   
//#5179                mov        [edi],eax                                                   
//#5180                add        edi,3                                                   
//#5181                loop    movlup                                                       
//#5182        }                                                                   
//#5183    }                                                                       
//#5184                                                                           
//#5185    void savmap(){                                                                       
//#5186                                                                           
//#5187        unsigned long        rot;                                                           
//#5188                                                                           
//#5189        if(*bnam){                                                                   
//#5190                                                                           
//#5191            if(chkMap(MONOMAP)){                                                               
//#5192                                                                           
//#5193                tabmsg(IDS_SAVMAP);                                                           
//#5194                return;                                                           
//#5195            }                                                               
//#5196            if(!chkMap(WASTRAC)){                                                               
//#5197                                                                           
//#5198                tabmsg(IDS_MAPCHG);                                                           
//#5199                return;                                                           
//#5200            }                                                               
//#5201            if(GetSaveFileName(&obn)){                                                               
//#5202                                                                           
//#5203                hBmp=CreateFile(lbnam,GENERIC_WRITE,0,NULL,CREATE_ALWAYS,0,NULL);                                                           
//#5204                if(hIni==INVALID_HANDLE_VALUE){                                                           
//#5205                                                                           
//#5206                    crmsg(lbnam);                                                       
//#5207                    return;                                                       
//#5208                }                                                           
//#5209                WriteFile(hBmp,(BITMAPFILEHEADER*)&bhed,14,&rot,NULL);                                                           
//#5210                WriteFile(hBmp,(BITMAPV4HEADER*)&b4hed,bhed.bfOffBits-14,&rot,NULL);                                                           
//#5211                movmap(bwid*bhi);                                                           
//#5212                WriteFile(hBmp,(BSEQPNT*)bseq,bwid*bhi*3,&rot,NULL);                                                           
//#5213                CloseHandle(hBmp);                                                           
//#5214            }                                                               
//#5215        }                                                                   
//#5216        else                                                                   
//#5217            tabmsg(IDS_SHOMAP);                                                               
//#5218    }                                                                       
//#5219                                                                           
//#5220    void bfil(){                                                                       
//#5221                                                                           
//#5222        unsigned            bwidw,bovr,bsiz,ind;                                                       
//#5223        unsigned*            pbits;                                                       
//#5224        HBITMAP                tbit;                                                   
//#5225        HDC                    tdc;                                               
//#5226        COLORREF            fgnd;                                                       
//#5227        COLORREF            bgnd;                                                       
//#5228        COLORREF            bitbak;                                                       
//#5229                                                                           
//#5230        bitbak=fswap(stchBak);                                                                   
//#5231        hBmp=CreateFile(lbnam,GENERIC_READ,0,0,OPEN_EXISTING,0,0);                                                                   
//#5232        if(hBmp==INVALID_HANDLE_VALUE){                                                                   
//#5233                                                                           
//#5234            sprintf(msgbuf,"Couldn't open bitmap file: %s\n",lbnam);                                                               
//#5235            shoMsg(msgbuf);                                                               
//#5236            CloseHandle(hBmp);                                                               
//#5237            hBmp=0;                                                               
//#5238            *bnam=0;                                                               
//#5239            return;                                                               
//#5240        }                                                                   
//#5241        ReadFile(hBmp,(BITMAPFILEHEADER*)&bhed,14,&red,NULL);                                                                   
//#5242        if(bhed.bfType=='MB'){                                                                   
//#5243                                                                           
//#5244            bsiz=bhed.bfOffBits-14;                                                               
//#5245            if(bsiz>sizeof(BITMAPV4HEADER))                                                               
//#5246                bsiz=sizeof(BITMAPV4HEADER);                                                           
//#5247            ReadFile(hBmp,(BITMAPV4HEADER*)&b4hed,bsiz,&red,NULL);                                                               
//#5248        }                                                                   
//#5249        else{                                                                   
//#5250                                                                           
//#5251            sprintf(msgbuf,"%s is not a Windows Bitmap\n",lbnam);                                                               
//#5252            CloseHandle(hBmp);                                                               
//#5253            hBmp=0;                                                               
//#5254            *bnam=0;                                                               
//#5255            return;                                                               
//#5256        }                                                                   
//#5257        if(gudtyp(b4hed.bV4BitCount)){                                                                   
//#5258                                                                           
//#5259            if(!rstMap(WASESC))                                                               
//#5260                rstMap(TRSET);                                                           
//#5261            bwid=b4hed.bV4Width;                                                               
//#5262            bhi= b4hed.bV4Height;                                                               
//#5263            setMap(INIT);                                                               
//#5264            zRct.left=zRct.bottom=0;                                                               
//#5265            zRct.right=zum0.x;                                                               
//#5266            zRct.top=zum0.y;                                                               
//#5267            bitdc=CreateCompatibleDC(rsdc);                                                               
//#5268            if(b4hed.bV4BitCount==1){                                                               
//#5269                                                                           
//#5270                setMap(MONOMAP);                                                           
//#5271                bwidw=bwid>>5;                                                           
//#5272                bovr=bwid%32;                                                           
//#5273                if(bovr)                                                           
//#5274                    bwidw++;                                                       
//#5275                bsiz=bwidw*bhi;                                                           
//#5276                bpnt=new unsigned[bsiz];                                                           
//#5277                ReadFile(hBmp,(unsigned*)bpnt,bsiz<<2,&red,NULL);                                                           
//#5278                CloseHandle(hBmp);                                                           
//#5279                if(binv(bwidw)){                                                           
//#5280                                                                           
//#5281                    bgnd=bitCol;                                                       
//#5282                    fgnd=bitbak;                                                       
//#5283                }                                                           
//#5284                else{                                                           
//#5285                                                                           
//#5286                    fgnd=bitCol;                                                       
//#5287                    bgnd=bitbak;                                                       
//#5288                }                                                           
//#5289                memset((BITMAPINFOHEADER*)&binfh,0,sizeof(BITMAPINFOHEADER));                                                           
//#5290                binfh.biSize=sizeof(BITMAPINFOHEADER);                                                           
//#5291                binfh.biWidth=bwid;                                                           
//#5292                binfh.biHeight=bhi;                                                           
//#5293                binfh.biPlanes=1;                                                           
//#5294                binfh.biBitCount=32;                                                           
//#5295                binfh.biCompression=BI_RGB;                                                           
//#5296                binf.bmiHeader=binfh;                                                           
//#5297                tbit=CreateDIBSection(bitdc,&binf,DIB_RGB_COLORS,(void**)&pbits,0,0);                                                           
//#5298                for(ind=0;ind<bhi;ind++)                                                           
//#5299                    bitlin(&bpnt[ind*bwidw],&pbits[ind*bwid],bgnd,fgnd);                                                       
//#5300                tdc=CreateCompatibleDC(rsdc);                                                           
//#5301                SelectObject(tdc,tbit);                                                           
//#5302                hBmp=CreateCompatibleBitmap(rsdc,bwid,bhi);                                                           
//#5303                SelectObject(bitdc,hBmp);                                                           
//#5304                BitBlt(bitdc,0,0,bwid,bhi,tdc,0,0,SRCCOPY);                                                           
//#5305                DeleteObject(tbit);                                                           
//#5306                ReleaseDC(hWnd,tdc);                                                           
//#5307                delete bpnt;                                                           
//#5308            }                                                               
//#5309            else{                                                               
//#5310                                                                           
//#5311                CloseHandle(hBmp);                                                           
//#5312                rstMap(MONOMAP);                                                           
//#5313                hBmp=(HBITMAP)LoadImage(hInst,lbnam,IMAGE_BITMAP,bwid,bhi,LR_LOADFROMFILE);                                                           
//#5314                SelectObject(bitdc,hBmp);                                                           
//#5315                setMap(RESTCH);                                                           
//#5316            }                                                               
//#5317            bitsiz();                                                               
//#5318            uref=0;                                                               
//#5319            dref=0x7f7f7f;                                                               
//#5320            curef=0xffffff;                                                               
//#5321            cdref=0x808080;                                                               
//#5322            rstMap(HIDMAP);                                                               
//#5323        }                                                                   
//#5324        else{                                                                   
//#5325                                                                           
//#5326            CloseHandle(hBmp);                                                               
//#5327            hBmp=0;                                                               
//#5328            *bnam=0;                                                               
//#5329            tabmsg(IDS_BMAP);                                                               
//#5330        }                                                                   
//#5331    }                                                                       
//#5332                                                                           
//#5333    void prtred(){                                                                       
//#5334                                                                           
//#5335        CloseHandle(hFil);                                                                   
//#5336        rstMap(INIT);                                                                   
//#5337        formpnt=0;                                                                   
//#5338        tabmsg(IDS_PRT);                                                                   
//#5339        coltab();                                                                   
//#5340        setMap(RESTCH);                                                                   
//#5341    }                                                                       
//#5342                                                                           
//#5343    unsigned dtrn(DSTREC* dpnt){                                                                       
//#5344                                                                           
//#5345        _asm{                                                                   
//#5346                                                                           
//#5347                mov        eax,dpnt                                                   
//#5348                mov        eax,[eax]                                                   
//#5349        }                                                                   
//#5350    }                                                                       
//#5351                                                                           
//#5352    BOOL colfil(){                                                                       
//#5353                                                                           
//#5354        TCHAR*    pext;                                                               
//#5355                                                                           
//#5356        strcpy(colnam,filnam);                                                                   
//#5357        strcpy(rgbnam,filnam);                                                                   
//#5358        pext=strrchr(colnam,'.');                                                                   
//#5359        if(pext){                                                                   
//#5360                                                                           
//#5361            pext++;                                                               
//#5362            strcpy(pext,"thw");                                                               
//#5363            pext=strrchr(rgbnam,'.');                                                               
//#5364            pext++;                                                               
//#5365            strcpy(pext,"rgb");                                                               
//#5366            return 1;                                                               
//#5367        }                                                                   
//#5368        else                                                                   
//#5369            return 0;                                                               
//#5370    }                                                                       
//#5371                                                                           
//#5372    void dstran(){                                                                       
//#5373                                                                           
//#5374        unsigned        ind,ine,col;                                                           
//#5375        POINT            loc;                                                       
//#5376        POINT            nu;                                                       
//#5377        FLPNT            max;                                                       
//#5378        FLPNT            min;                                                       
//#5379        FLPNT            siz;                                                       
//#5380        FLPNT            dif;                                                       
//#5381        HANDLE            hcol;                                                       
//#5382        unsigned*        pcol;                                                           
//#5383        unsigned        fsiz,colind;                                                           
//#5384        unsigned long    hisiz;                                                               
//#5385                                                                           
//#5386        pcol=0;                                                                   
//#5387        if(colfil()){                                                                   
//#5388                                                                           
//#5389            hcol=CreateFile(colnam,GENERIC_READ,0,0,OPEN_EXISTING,0,0);                                                               
//#5390            if(hcol!=INVALID_HANDLE_VALUE){                                                               
//#5391                                                                           
//#5392                fsiz=GetFileSize(hcol,&hisiz);                                                           
//#5393                pcol=new unsigned[fsiz];                                                           
//#5394                ReadFile(hcol,(unsigned*)pcol,fsiz,&hisiz,0);                                                           
//#5395                CloseHandle(hcol);                                                           
//#5396                if(hisiz&&pcol&&pcol[0]==COLVER){                                                           
//#5397                                                                           
//#5398                    stchBak=pcol[1];                                                       
//#5399                    colCnt=0;                                                       
//#5400                }                                                           
//#5401                else{                                                           
//#5402                                                                           
//#5403                    if(pcol){                                                       
//#5404                                                                           
//#5405                        delete pcol;                                                   
//#5406                        pcol=0;                                                   
//#5407                    }                                                       
//#5408                }                                                           
//#5409            }                                                               
//#5410        }                                                                   
//#5411        ine=0;                                                                   
//#5412        if(pcol)                                                                   
//#5413            col=colmatch(pcol[2]);                                                               
//#5414        else                                                                   
//#5415            col=0;                                                               
//#5416        colind=3;                                                                   
//#5417        loc.x=loc.y=0;                                                                   
//#5418        max.x=max.y=(float)-1e12;                                                                   
//#5419        min.x=min.y=(float)1e12;                                                                   
//#5420        for(ind=0;ind<dstcnt;ind++){                                                                   
//#5421                                                                           
//#5422            if(drecs[ind].nd&0x40){                                                               
//#5423                                                                           
//#5424                if(pcol)                                                           
//#5425                    col=colmatch(pcol[colind++]);                                                       
//#5426                else{                                                           
//#5427                                                                           
//#5428                    col++;                                                       
//#5429                    col&=0xf;                                                       
//#5430                }                                                           
//#5431            }                                                               
//#5432            else{                                                               
//#5433                                                                           
//#5434                dstin(dtrn(&drecs[ind]),&nu);                                                           
//#5435                loc.x+=nu.x;                                                           
//#5436                loc.y+=nu.y;                                                           
//#5437                if(!(drecs[ind].nd&0x80)){                                                           
//#5438                                                                           
//#5439                    stchs[ine].at=col|NOTFRM;                                                       
//#5440                    stchs[ine].x=loc.x*0.6;                                                       
//#5441                    stchs[ine].y=loc.y*0.6;                                                       
//#5442                    if(stchs[ine].x>max.x)                                                       
//#5443                        max.x=stchs[ine].x;                                                   
//#5444                    if(stchs[ine].y>max.y)                                                       
//#5445                        max.y=stchs[ine].y;                                                   
//#5446                    if(stchs[ine].x<min.x)                                                       
//#5447                        min.x=stchs[ine].x;                                                   
//#5448                    if(stchs[ine].y<min.y)                                                       
//#5449                        min.y=stchs[ine].y;                                                   
//#5450                    ine++;                                                       
//#5451                }                                                           
//#5452            }                                                               
//#5453        }                                                                   
//#5454        if(pcol)                                                                   
//#5455            delete pcol;                                                               
//#5456        hed.stchs=ine;                                                                   
//#5457        siz.x=max.x-min.x;                                                                   
//#5458        siz.y=max.y-min.y;                                                                   
//#5459        ini.hup=CUSTHUP;                                                                   
//#5460        zum0.x=ini.hupx;                                                                   
//#5461        zum0.y=ini.hupy;                                                                   
//#5462        if(siz.x>zum0.x||siz.y>zum0.y){                                                                   
//#5463                                                                           
//#5464            ini.hupx=zum0.x=siz.x*1.1;                                                               
//#5465            ini.hupy=zum0.y=siz.y*1.1;                                                               
//#5466            hsizmsg();                                                               
//#5467        }                                                                   
//#5468        dif.x=(zum0.x-siz.x)/2-min.x;                                                                   
//#5469        dif.y=(zum0.y-siz.y)/2-min.y;                                                                   
//#5470        for(ind=0;ind<hed.stchs;ind++){                                                                   
//#5471                                                                           
//#5472             stchs[ind].x+=dif.x;                                                               
//#5473            stchs[ind].y+=dif.y;                                                               
//#5474        }                                                                   
//#5475    }                                                                       
//#5476                                                                           
//#5477    BOOL chkdst(DSTHED* dsthed){                                                                       
//#5478                                                                           
//#5479        if(strncmp(dsthed->desched,"LA:",3))                                                                   
//#5480            return 0;                                                               
//#5481        return 1;                                                                   
//#5482    }                                                                       
//#5483                                                                           
//#5484    void auxmen(){                                                                       
//#5485                                                                           
//#5486        switch(ini.auxfil){                                                                   
//#5487                                                                           
//#5488        case AUXDST:                                                                   
//#5489                                                                           
//#5490            sprintf(msgbuf,stab[STR_AUXTXT],"DST");                                                               
//#5491            CheckMenuItem(hMen,ID_AUXDST,MF_CHECKED);                                                               
//#5492            CheckMenuItem(hMen,ID_AUXPCS,MF_UNCHECKED);                                                               
//#5493            break;                                                               
//#5494                                                                           
//#5495        default:                                                                   
//#5496                                                                           
//#5497            CheckMenuItem(hMen,ID_AUXDST,MF_UNCHECKED);                                                               
//#5498            CheckMenuItem(hMen,ID_AUXPCS,MF_CHECKED);                                                               
//#5499            sprintf(msgbuf,stab[STR_AUXTXT],"PCS");                                                               
//#5500        }                                                                   
//#5501        SetMenuItemInfo(hfileMen,ID_OPNPCD,MF_BYCOMMAND,&filinfo);                                                                   
//#5502        setMap(DUMEN);                                                                   
//#5503    }                                                                       
//#5504                                                                           
//#5505    #if PESACT                                                                       
//#5506                                                                           
//#5507    unsigned tripl(TCHAR* dat){                                                                       
//#5508                                                                           
//#5509        _asm{                                                                   
//#5510                                                                           
//#5511                mov        eax,dat                                                   
//#5512                mov        eax,[eax]                                                   
//#5513                and        eax,0xffffff                                                   
//#5514        }                                                                   
//#5515    }                                                                       
//#5516                                                                           
//#5517    unsigned pesmtch(COLORREF rcol,unsigned char pcol){                                                                       
//#5518                                                                           
//#5519        unsigned    rval,ind;                                                               
//#5520        COLORREF    tcol;                                                               
//#5521                                                                           
//#5522        tcol=pestrn[pcol];                                                                   
//#5523        rval=0;                                                                   
//#5524        for(ind=0;ind<3;ind++){                                                                   
//#5525                                                                           
//#5526            rval+=abs((rcol&0xff)-(tcol&0xff));                                                               
//#5527            tcol>>=8;                                                               
//#5528            rcol>>=8;                                                               
//#5529        }                                                                   
//#5530        return rval;                                                                   
//#5531    }                                                                       
//#5532                                                                           
//#5533    unsigned dupcol(){                                                                       
//#5534                                                                           
//#5535        unsigned    ind;                                                               
//#5536        COLORREF    col;                                                               
//#5537        unsigned    mat,matm,pmatm;                                                               
//#5538                                                                           
//#5539        col=pestrn[pescols[pcolind++]];                                                                   
//#5540        for(ind=0;ind<xpnt;ind++){                                                                   
//#5541                                                                           
//#5542            if(useCol[ind]==col)                                                               
//#5543                return ind;                                                           
//#5544        }                                                                   
//#5545        matm=0xffffff;                                                                   
//#5546        for(ind=1;ind<xpnt;ind++){                                                                   
//#5547                                                                           
//#5548            mat=pesmtch(col,pescols[ind]);                                                               
//#5549            if(mat<matm){                                                               
//#5550                                                                           
//#5551                matm=mat;                                                           
//#5552                pmatm=ind;                                                           
//#5553            }                                                               
//#5554        }                                                                   
//#5555        return pmatm;                                                                   
//#5556    }                                                                       
//#5557                                                                           
//#5558                                                                           
//#5559    double dubl(unsigned char* pnt){                                                                       
//#5560                                                                           
//#5561        unsigned tdat;                                                                   
//#5562                                                                           
//#5563        _asm{                                                                   
//#5564                                                                           
//#5565                mov        ecx,pnt                                                   
//#5566                mov        ecx,[ecx]                                                   
//#5567                movzx    ebx,ch                                                       
//#5568                test    cl,8                                                       
//#5569                je        short dubl1                                                   
//#5570                mov        ch,15                                                   
//#5571                and        cl,ch                                                   
//#5572                sub        ch,cl                                                   
//#5573                movzx    ecx,ch                                                       
//#5574                shl        ecx,8                                                   
//#5575                mov        eax,256                                                   
//#5576                sub        eax,ebx                                                   
//#5577                add        ecx,eax                                                   
//#5578                neg        ecx                                                   
//#5579                jmp        short dubl2                                                   
//#5580    dubl1:        and        ecx,0x7                                                       
//#5581                shl        ecx,8                                                   
//#5582                add        ecx,ebx                                                   
//#5583    dubl2:        mov        tdat,ecx                                                       
//#5584                fild    tdat                                                       
//#5585        }                                                                   
//#5586    }                                                                       
//#5587    #endif                                                                       
//#5588                                                                           
//#5589    void xofrm(){                                                                       
//#5590                                                                           
//#5591        unsigned    ind;                                                               
//#5592        FRMHEDO*    frmlstx;                                                               
//#5593                                                                           
//#5594        frmlstx=(FRMHEDO*)&bseq;                                                                   
//#5595        FillMemory(&bseq,0,sizeof(FRMHED)*formpnt);                                                                   
//#5596        for(ind=0;ind<formpnt;ind++)                                                                   
//#5597            MoveMemory(&formlst[ind],&frmlstx[ind],sizeof(FRMHEDO));                                                               
//#5598    }                                                                       
//#5599
procedure TfrmMain.nuFil();

//#5600    void nuFil(){
//#5601                                                                           
//#5602        unsigned        siz,stind;                                                           
//#5603        unsigned        vervar;                                                           
//#5604        unsigned long    sizh;                                                               
//#5605        unsigned        ind,inf,ing,inh,tcol;                                                           
//#5606        unsigned        cPnt;                                                           
//#5607        TCHAR*            pext;                                                       
//#5608        TCHAR            tchr;                                                       
//#5609        STRHED            sthed;                                                       
//#5610        TCHAR            buf[3];                                                       
//#5611        TCHAR*            tnam;                                                       
//#5612        DSTHED            dsthed;                                                       
//#5613        FLRCT            strct;                                                       
//#5614        FRMHEDO*        frmlstx;                                                           
//#5615        long            tred;                                                       
//#5616
var
  tchr : string;
  hFil : file;                                                     
//#5617    #if PESACT                                                                       
//#5618                                                                           
//#5619        unsigned        ine;
//#5620        PESHED*            peshed;                                                       
//#5621        TCHAR*            peschr;                                                       
//#5622        unsigned        pecof;                                                           
//#5623        unsigned char*    pcolcnt;                                                               
//#5624        DUBPNT            loc;                                                       
//#5625        PESTCH*            pabstch;                                                       
//#5626        unsigned        pabind;                                                           
//#5627        double            locof;                                                       
//#5628    #endif                                                                       
//#5629
begin
//#5630        if(rstMap(REDOLD)||GetOpenFileName(&ofn)){
  if dlgOpen1.execute then
  begin
//#5631                                                                           
//#5632            fnamtabs();                                                               
//#5633            untrace();                                                               
//#5634            if(formpnt)                                                               
//#5635                delfrms();                                                           
//#5636            rstMap(ZUMED);                                                               
//#5637            rstMap(FRMOF);                                                               
//#5638            rstMap(HID);                                                               
//#5639            rstMap(BIGBOX);                                                               
//#5640            unthum();                                                               
//#5641            unbsho();                                                               
//#5642            if(bnam[0]){                                                               
//#5643                                                                           
//#5644                DeleteObject(hBmp);                                                           
//#5645                ReleaseDC(hWnd,bitdc);                                                           
//#5646                *bnam=0;                                                           
//#5647            }                                                               
//#5648            hFil=CreateFile(filnam,GENERIC_READ,0,NULL,                                                               
//#5649                    OPEN_EXISTING,0,NULL);                                                       
//#5650            if(hFil==INVALID_HANDLE_VALUE){                                                               
//#5651                                                                           
//#5652                ind=GetLastError();                                                           
//#5653                if(GetLastError()==32)                                                           
//#5654                    filnopn(IDS_FNOPNA,filnam);                                                       
//#5655                else                                                           
//#5656                    filnopn(IDS_FNOPN,filnam);                                                       
//#5657                hFil=0;                                                           
//#5658            }                                                               
//#5659            else{                                                               
//#5660                                                                           
//#5661                rstMap(CMPDO);                                                           
//#5662                rstMap(SAVACT);                                                           
//#5663                rstMap(BAKING);                                                           
//#5664                rstMap(REDUSHO);                                                           
//#5665                txad=0;                                                           
//#5666                EnableMenuItem(hMen,M_REDO,MF_BYPOSITION|MF_GRAYED);                                                           
//#5667                deldu();                                                           
//#5668                strcpy(fildes,ini.desnam);                                                           
//#5669                unbsho();                                                           
//#5670                rstMap(MOVSET);                                                           
//#5671                frmon();                                                           
//#5672                fselpnt=0;                                                           
//#5673                if(rstMap(PRFACT)){                                                           
//#5674                                                                           
//#5675                    DestroyWindow(hPrf);                                                       
//#5676                    rstMap(WASRT);                                                       
//#5677                    prfind=0;                                                       
//#5678                }                                                           
//#5679                bnam[0]=0;                                                           
//#5680                if(slpnt)                                                           
//#5681                    slpnt=0;                                                       
//#5682                rstMap(SCROS);                                                           
//#5683                rstMap(ECROS);                                                           
//#5684                rstMap(BZUMIN);                                                           
//#5685                rstdu();                                                           
//#5686                unmsg();                                                           
//#5687                dupnt0=0;                                                           
//#5688                rstMap(BAKWRAP);                                                           
//#5689                zumFct=1;                                                           
//#5690                setMap(RESTCH);                                                           
//#5691                defNam(filnam);
    filnam := dlgOpen1.filename;
//#5692                selCnt=0;                                                           
//#5693                if(rstMap(WASPAT))                                                           
//#5694                    DestroyWindow(hSped);                                                       
//#5695                ind=0;                                                           
//#5696                if(chkMap(WASTXBAK))                                                           
//#5697                    ind=1;                                                       
//#5698                clrMap(MAPLEN);                                                           
//#5699                if(ind)                                                           
//#5700                    setMap(WASTXBAK);                                                       
//#5701                siz=GetFileSize(hFil,&sizh);                                                           
//#5702                pext=strrchr(filnam,'.');                                                           
//#5703                if(pext)                                                           
//#5704                    pext++;                                                       
//#5705                else{                                                           
//#5706                                                                           
//#5707                    strcat(filnam,".thr");                                                       
//#5708                    pext=strrchr(filnam,'.')+1;                                                       
//#5709                }                                                           
//#5710                tchr=tolower(pext[0]);
    tchr := ExtractFileExt(filnam);                                                           
//#5711                if(tchr=='t'){                                                           
//#5712                                                                           
//#5713                    ReadFile(hFil,(STRHED*)&sthed,sizeof(STRHED),&red,NULL);                                                       
//#5714                    if((sthed.led&0xffffff)==0x746872){                                                       
//#5715                                                                           
//#5716                        if(red!=sizeof(STRHED)){                                                   
//#5717                                                                           
//#5718                            tabmsg(IDS_SHRTF);                                               
//#5719                            return;                                               
//#5720                        }                                                   
//#5721                        vervar=(sthed.led&0xff000000)>>24;                                                   
//#5722                        switch(vervar){                                                   
//#5723                                                                           
//#5724                        case 0:                                                   
//#5725                                                                           
//#5726                            if(hed.hup==SMALHUP){                                               
//#5727                                                                           
//#5728                                zum0.x=ini.hupx=SHUPX;                                           
//#5729                                zum0.y=ini.hupy=SHUPY;                                           
//#5730                            }                                               
//#5731                            else{                                               
//#5732                                                                           
//#5733                                zum0.x=ini.hupx=LHUPX;                                           
//#5734                                zum0.y=ini.hupy=LHUPY;                                           
//#5735                                hed.hup=LARGHUP;                                           
//#5736                            }                                               
//#5737                            ritfnam(ini.desnam);                                               
//#5738                            strcpy(fildes,ini.desnam);                                               
//#5739                            strcpy(hedx.modnam,ini.desnam);                                               
//#5740                            break;                                               
//#5741                                                                           
//#5742                        case 1:                                                   
//#5743                        case 2:                                                   
//#5744                                                                           
//#5745                            ReadFile(hFil,(STREX*)&hedx,sizeof(STREX),&red,NULL);                                               
//#5746                            if(red!=sizeof(STREX)){                                               
//#5747                                                                           
//#5748                                tabmsg(IDS_SHRTF);                                           
//#5749                                return;                                           
//#5750                            }                                               
//#5751                            ini.hupx=zum0.x=hedx.xhup;                                               
//#5752                            ini.hupy=zum0.y=hedx.yhup;                                               
//#5753                            redfnam(fildes);                                               
//#5754                            break;                                               
//#5755                                                                           
//#5756                        default:                                                   
//#5757                                                                           
//#5758                            tabmsg(IDS_NOTVER);                                               
//#5759                            return;                                               
//#5760                        }                                                   
//#5761                        zRct.bottom=zRct.left=0;                                                   
//#5762                        zRct.right=zum0.x=ini.hupx;                                                   
//#5763                        zRct.top=zum0.y=ini.hupy;                                                   
//#5764                        hed.stchs=sthed.stchs;                                                   
//#5765                        ReadFile(hFil,(SHRTPNT*)stchs,hed.stchs*sizeof(SHRTPNT),&red,NULL);                                                   
//#5766                        if(red!=hed.stchs*sizeof(SHRTPNT)){                                                   
//#5767                                                                           
//#5768                            hed.stchs=red/sizeof(SHRTPNT);                                               
//#5769                            prtred();                                               
//#5770                            return;                                               
//#5771                        }                                                   
//#5772                        ReadFile(hFil,(TCHAR*)bnam,16,&red,0);                                                   
//#5773                        tred=red;                                                   
//#5774                        if(red!=16){                                                   
//#5775                                                                           
//#5776                            bnam[0]=0;                                               
//#5777                            prtred();                                               
//#5778                            return;                                               
//#5779                        }                                                   
//#5780                        ReadFile(hFil,(COLORREF*)&stchBak,4,&red,0);                                                   
//#5781                        tred+=red;                                                   
//#5782                        if(red!=4){                                                   
//#5783                                                                           
//#5784                            stchBak=ini.stchBak;                                               
//#5785                            prtred();                                               
//#5786                            return;                                               
//#5787                        }                                                   
//#5788                        hStchBak=CreateSolidBrush(stchBak);                                                   
//#5789                        ReadFile(hFil,(COLORREF*)useCol,64,&red,0);                                                   
//#5790                        tred+=red;                                                   
//#5791                        if(red!=64){                                                   
//#5792                                                                           
//#5793                            prtred();                                               
//#5794                            return;                                               
//#5795                        }                                                   
//#5796                        ReadFile(hFil,(COLORREF*)custCol,64,&red,0);                                                   
//#5797                        tred+=red;                                                   
//#5798                        if(red!=64){                                                   
//#5799                                                                           
//#5800                            prtred();                                               
//#5801                            return;                                               
//#5802                        }                                                   
//#5803                        ReadFile(hFil,(TCHAR*)msgbuf,16,&red,0);                                                   
//#5804                        tred+=red;                                                   
//#5805                        if(red!=16){                                                   
//#5806                                                                           
//#5807                            prtred();                                               
//#5808                            return;                                               
//#5809                        }                                                   
//#5810                        for(ind=0;ind<16;ind++)                                                   
//#5811                            thrdSiz[ind][0]=msgbuf[ind];                                               
//#5812                        formpnt=sthed.fpnt;                                                   
//#5813                        if(formpnt>MAXFORMS)                                                   
//#5814                            formpnt=MAXFORMS;                                               
//#5815                        inf=0;ing=0,inh=0;                                                   
//#5816                        if(formpnt){                                                   
//#5817                                                                           
//#5818                            ind=fltad=satkad=clpad=0;                                               
//#5819                            msgbuf[0]=0;                                               
//#5820                            if(vervar<2){                                               
//#5821                                                                           
//#5822                                frmlstx=(FRMHEDO*)&bseq;                                           
//#5823                                ReadFile(hFil,(FRMHEDO*)frmlstx,formpnt*sizeof(FRMHEDO),&red,0);                                           
//#5824                                if(red!=formpnt*sizeof(FRMHEDO)){                                           
//#5825                                                                           
//#5826                                    formpnt=red/sizeof(FRMHEDO);                                       
//#5827                                    setMap(BADFIL);                                       
//#5828                                }                                           
//#5829                                xofrm();                                           
//#5830                            }                                               
//#5831                            else{                                               
//#5832                                                                           
//#5833                                ReadFile(hFil,(FRMHED*)formlst,formpnt*sizeof(FRMHED),&red,0);                                           
//#5834                                rstMap(BADFIL);                                           
//#5835                                if(red!=formpnt*sizeof(FRMHED)){                                           
//#5836                                                                           
//#5837                                    formpnt=red/sizeof(FRMHED);                                       
//#5838                                    setMap(BADFIL);                                       
//#5839                                }                                           
//#5840                            }                                               
//#5841    //                        ind=SetFilePointer(hFil,0,0,FILE_CURRENT);  //bug                                               
//#5842                            ReadFile(hFil,(FLPNT*)flts,sthed.fcnt*sizeof(FLPNT),&red,0);                                               
//#5843                            if(red!=sizeof(FLPNT)*sthed.fcnt){                                               
//#5844                                                                           
//#5845                                fltad=red/sizeof(FLPNT);                                           
//#5846                                for(ind=fltad;ind<sthed.fcnt;ind++)                                           
//#5847                                    flts[ind].x=flts[ind].y=0;                                       
//#5848                                setMap(BADFIL);                                           
//#5849                            }                                               
//#5850                            ReadFile(hFil,(SATCON*)satks,sthed.scnt*sizeof(SATCON),&red,0);                                               
//#5851                            if(red!=sthed.scnt*sizeof(SATCON)){                                               
//#5852                                                                           
//#5853                                satkad=red/sizeof(SATCON);                                           
//#5854                                setMap(BADFIL);                                           
//#5855                            }                                               
//#5856                            ReadFile(hFil,(FLPNT*)clps,sthed.ecnt*sizeof(FLPNT),&red,0);                                               
//#5857                            if(red!=sthed.ecnt*sizeof(FLPNT)){                                               
//#5858                                                                           
//#5859                                clpad=red/sizeof(FLPNT);                                           
//#5860                                setMap(BADFIL);                                           
//#5861                            }                                               
//#5862                            ReadFile(hFil,(TXPNT*)txpnts,hedx.txcnt*sizeof(TXPNT),&red,0);                                               
//#5863                            txad=red/sizeof(TXPNT);                                               
//#5864                            if(rstMap(BADFIL))                                               
//#5865                                bfilmsg();                                           
//#5866                            for(ind=0;ind<formpnt;ind++){                                               
//#5867                                                                           
//#5868                                formlst[ind].flt=adflt(formlst[ind].sids);                                           
//#5869                                if(formlst[ind].typ==SAT){                                           
//#5870                                                                           
//#5871                                    if(formlst[ind].stpt)                                       
//#5872                                        formlst[ind].sacang.sac=adsatk(formlst[ind].stpt);                                   
//#5873                                }                                           
//#5874                                if(isclp(ind))                                           
//#5875                                    formlst[ind].angclp.clp=adclp(formlst[ind].flencnt.nclp);                                       
//#5876                                if(iseclpx(ind))                                           
//#5877                                    formlst[ind].clp=adclp(formlst[ind].nclp);                                       
//#5878                            }                                               
//#5879                            setfchk();                                               
//#5880                        }                                                   
//#5881                    }                                                       
//#5882                    else                                                       
//#5883                        tabmsg(IDS_NOTHR);                                                   
//#5884                }                                                           
//#5885                else{                                                           
//#5886                                                                           
//#5887                    setMap(NOTHRFIL);                                                       
//#5888                    if(tchr=='p'){                                                       
//#5889                                                                           
//#5890                        if(tolower(pext[01])=='c'){                                                   
//#5891                                                                           
//#5892                            ReadFile(hFil,(HED*)&hed,0x46,&red,NULL);                                               
//#5893                            if(!siz){                                               
//#5894                                                                           
//#5895                                filnopn(IDS_ZEROL,filnam);                                           
//#5896                                return;                                           
//#5897                            }                                               
//#5898                            if(hed.ledIn==0x32&&hed.fColCnt==16){                                               
//#5899                                                                           
//#5900                                for(ind=0;ind<16;ind++)                                           
//#5901                                    useCol[ind]=hed.fCols[ind];                                       
//#5902                                siz-=0x46;                                           
//#5903                                inf=siz/sizeof(PCSTCH)+2;                                           
//#5904                                filBuf=new PCSTCH[inf];                                           
//#5905                                ReadFile(hFil,filBuf,siz,&red,NULL);                                           
//#5906                                stind=0;                                           
//#5907                                cPnt=0;                                           
//#5908                                tcol=0;                                           
//#5909                                ind=0;                                           
//#5910                                while(stind<hed.stchs&&ind<inf){                                           
//#5911                                                                           
//#5912                                    if(filBuf[ind].typ==3){                                       
//#5913                                                                           
//#5914                                        colch[cPnt].colind=filBuf[ind].fx;                                   
//#5915                                        colch[cPnt++].stind=stind;                                   
//#5916                                        tcol=NOTFRM|filBuf[ind++].fx;                                   
//#5917                                    }                                       
//#5918                                    else{                                       
//#5919                                                                           
//#5920                                        stchs[stind].x=filBuf[ind].x+(float)filBuf[ind].fx/256;                                   
//#5921                                        stchs[stind].y=filBuf[ind].y+(float)filBuf[ind].fy/256;                                   
//#5922                                        stchs[stind++].at=tcol;                                   
//#5923                                        ind++;                                   
//#5924                                    }                                       
//#5925                                }                                           
//#5926                                hed.stchs=stind;                                           
//#5927                                tnam=(TCHAR*)&filBuf[ind];                                           
//#5928                                strcpy(bnam,tnam);                                           
//#5929                                delete filBuf;                                           
//#5930                                strcpy(pext,"thr");                                           
//#5931                                ini.auxfil=AUXPCS;                                           
//#5932                                if(hed.hup!=LARGHUP&&hed.hup!=SMALHUP)                                           
//#5933                                    hed.hup=LARGHUP;                                       
//#5934                                sizstch(&strct);                                           
//#5935                                if(strct.left<0||strct.right>LHUPY||strct.bottom<0||strct.top>LHUPY){                                           
//#5936                                                                           
//#5937                                    ini.hupx=LHUPX;                                       
//#5938                                    ini.hupy=LHUPY;                                       
//#5939                                    chkhup();                                       
//#5940                                }                                           
//#5941                                else{                                           
//#5942                                                                           
//#5943                                    if(hed.hup==LARGHUP){                                       
//#5944                                                                           
//#5945                                        ini.hup=LARGHUP;                                   
//#5946                                        ini.hupx=LHUPX;                                   
//#5947                                        ini.hupy=LHUPY;                                   
//#5948                                    }                                       
//#5949                                    else{                                       
//#5950                                                                           
//#5951                                        if(strct.right>SHUPX||strct.top>SHUPY||hed.hup==LARGHUP){                                   
//#5952                                                                           
//#5953                                            ini.hup=LARGHUP;                               
//#5954                                            ini.hupx=SHUPX;                               
//#5955                                            ini.hupy=SHUPY;                               
//#5956                                        }                                   
//#5957                                        else{                                   
//#5958                                                                           
//#5959                                            ini.hup=SMALHUP;                               
//#5960                                            ini.hupx=SHUPX;                               
//#5961                                            ini.hupy=SHUPY;                               
//#5962                                        }                                   
//#5963                                    }                                       
//#5964                                }                                           
//#5965                            }                                               
//#5966                        }                                                   
//#5967    #if PESACT                                                                       
//#5968                        else{                                                   
//#5969                                                                           
//#5970                            ReadFile(hFil,(BSEQPNT*)&bseq,sizeof(bseq),&red,0);                                               
//#5971                            peshed=(PESHED*)&bseq;                                               
//#5972                            peschr=(TCHAR*)&bseq;                                               
//#5973                            if(strncmp(peshed->led,"#PES00",6)){                                               
//#5974                                                                           
//#5975                                sprintf(msgbuf,"Not a PES file: %s\n",filnam);                                           
//#5976                                shoMsg(msgbuf);                                           
//#5977                                return;                                           
//#5978                            }                                               
//#5979                            pecof=tripl(peshed->off);                                               
//#5980                            pestch=(unsigned char*)&peschr[pecof+532];                                               
//#5981                            xpnt=0;                                               
//#5982                            pcolcnt=(unsigned char*)&peschr[pecof+48];                                               
//#5983                            pescols=&pcolcnt[1];                                               
//#5984                            rmap[0]=rmap[1]=0;                                               
//#5985                            xpnt=0;                                               
//#5986                            for(ind=0;ind<(unsigned)(*pcolcnt+1);ind++){                                               
//#5987                                                                           
//#5988                                if(setRmp(pescols[ind])){                                           
//#5989                                                                           
//#5990                                    useCol[xpnt++]=pestrn[pescols[ind]&PESCMSK];                                       
//#5991                                    if(xpnt>=16)                                       
//#5992                                        break;                                   
//#5993                                }                                           
//#5994                            }                                               
//#5995                            tcol=0;                                               
//#5996                            pcolind=1;                                               
//#5997                            loc.x=loc.y=0;                                               
//#5998                            pabind=ind=ine=0;                                               
//#5999                            rstMap(FILDIR);                                               
//#6000                            ind=0;                                               
//#6001                            pabstch=(PESTCH*)&peschr[sizeof(PESHED)+4];                                               
//#6002                            ind=0;                                               
//#6003                            ine=1;                                               
//#6004                            stchs[0].x=stchs[0].y;                                               
//#6005                            while(ind<red-pecof-529){                                               
//#6006                                                                           
//#6007                                if(pestch[ind]==0xff&&pestch[ind+1]==0)                                           
//#6008                                    break;                                       
//#6009                                if(pestch[ind]==0xfe&&pestch[ind+1]==0xb0){                                           
//#6010                                                                           
//#6011                                    tcol=dupcol();                                       
//#6012                                    ind+=2;                                       
//#6013                                }                                           
//#6014                                else{                                           
//#6015                                                                           
//#6016                                    if(pestch[ind]&0x80){                                       
//#6017                                                                           
//#6018                                        locof=dubl(&pestch[ind]);                                   
//#6019                                        ind++;                                   
//#6020                                    }                                       
//#6021                                    else{                                       
//#6022                                                                           
//#6023                                        if(pestch[ind]&0x40)                                   
//#6024                                            locof=pestch[ind]-128;                               
//#6025                                        else                                   
//#6026                                            locof=pestch[ind];                               
//#6027                                    }                                       
//#6028                                    locof*=0.6;                                       
//#6029                                    if(toglMap(FILDIR)){                                       
//#6030                                                                           
//#6031                                        loc.y-=locof;                                   
//#6032                                        stchs[ine].x=loc.x;                                   
//#6033                                        stchs[ine].y=loc.y;                                   
//#6034                                        stchs[ine].at=tcol;                                   
//#6035                                        ine++;                                   
//#6036                                    }                                       
//#6037                                    else                                       
//#6038                                        loc.x+=locof;                                   
//#6039                                }                                           
//#6040                                ind++;                                           
//#6041                            }                                               
//#6042                            hed.stchs=ine;                                               
//#6043                            //ini.auxfil=AUXPES;                                               
//#6044                            hupfn();                                               
//#6045                        }                                                   
//#6046    #endif                                                                       
//#6047                    }                                                       
//#6048                    else{                                                       
//#6049                                                                           
//#6050                        ReadFile(hFil,(DSTHED*)&dsthed,sizeof(DSTHED),&red,0);                                                   
//#6051                        if(red==sizeof(DSTHED)){                                                   
//#6052                                                                           
//#6053                            if(chkdst(&dsthed)){                                               
//#6054                                                                           
//#6055                                bnam[0]=0;                                           
//#6056                                siz=GetFileSize(hFil,&red)-sizeof(DSTHED);                                           
//#6057                                dstcnt=siz/sizeof(DSTREC);                                           
//#6058                                drecs=new DSTREC[dstcnt];                                           
//#6059                                ReadFile(hFil,(DSTREC*)drecs,sizeof(DSTREC)*dstcnt,&red,0);                                           
//#6060                                dstran();                                           
//#6061                                delete drecs;                                           
//#6062                                ini.auxfil=AUXDST;                                           
//#6063                            }                                               
//#6064                        }                                                   
//#6065                        else{                                                   
//#6066                                                                           
//#6067                            tabmsg(IDS_DST2S);                                               
//#6068                            CloseHandle(hFil);                                               
//#6069                            return;                                               
//#6070                        }                                                   
//#6071                    }                                                       
//#6072                }                                                           
//#6073                if(bnam[0]){                                                           
//#6074                                                                           
//#6075                    SetCurrentDirectory(defDir);                                                       
//#6076                    strcpy(lbnam,bnam);                                                       
//#6077                    bfil();                                                       
//#6078                }                                                           
//#6079                ritot(hed.stchs);                                                           
//#6080                numpnt=0;                                                           
//#6081                zRct.left=0;                                                           
//#6082                zRct.bottom=0;                                                           
//#6083                zRct.right=zum0.x=ini.hupx;                                                           
//#6084                zRct.top=zum0.y=ini.hupy;                                                           
//#6085                movStch();                                                           
//#6086                coltab();                                                           
//#6087                rstMap(ZUMED);                                                           
//#6088                buf[2]=0;                                                           
//#6089                for(ind=0;ind<16;ind++){                                                           
//#6090                                                                           
//#6091                    uPen[ind]=nuPen(uPen[ind],1,useCol[ind]);                                                       
//#6092                    hbrUseCol[ind]=nuBrush(hbrUseCol[ind],useCol[ind]);                                                       
//#6093                    strncpy(buf,thrdSiz[ind],2);                                                       
//#6094                    SetWindowText(hSiz[ind],buf);                                                       
//#6095                }                                                           
//#6096                for(ind=0;ind<16;ind++)                                                           
//#6097                    redraw(hCol[ind]);                                                       
//#6098                redraw(hBar);                                                           
//#6099                if(hed.stchs)                                                           
//#6100                    setMap(INIT);                                                       
//#6101                nuAct(0);                                                           
//#6102                setMap(RESTCH);                                                           
//#6103                nunams();                                                           
//#6104                ritini();                                                           
//#6105                butxt(HNUM,"");                                                           
//#6106                 if(hed.stchs)                                                           
//#6107                    nuAct(stchs[0].at&COLMSK);                                                       
//#6108                else                                                           
//#6109                    nuAct(0);                                                       
//#6110                auxmen();                                                           
//#6111            }                                                               
//#6112            lenCalc();                                                               
//#6113            sprintf(msgbuf,stab[STR_THRDBY],filnam,fildes);                                                               
//#6114            SetWindowText(hWnd,msgbuf);                                                               
//#6115            CloseHandle(hFil);                                                               
//#6116            setMap(INIT);                                                               
//#6117            rstMap(TRSET);                                                               
//#6118            if(chkMap(NOTHRFIL))                                                               
//#6119            {                                                               
//#6120                for(ind=0;ind<hed.stchs;ind++)                                                           
//#6121                    stchs[ind].at|=NOTFRM;                                                       
//#6122            }                                                               
//#6123            lodchk();                                                               
//#6124        }                                                                   
//#6125    }
  end;
//#6126
end;                                                                           
//#6127    void clrfbuf(unsigned siz){                                                                       
//#6128                                                                           
//#6129        _asm{                                                                   
//#6130                                                                           
//#6131                mov        edi,filBuf                                                   
//#6132                mov        ecx,siz                                                   
//#6133                xor        eax,eax                                                   
//#6134                rep        stosd                                                   
//#6135        }                                                                   
//#6136    }                                                                       
//#6137                                                                           
//#6138    unsigned xbits(unsigned src,unsigned dst){                                                                       
//#6139                                                                           
//#6140        _asm{                                                                   
//#6141                                                                           
//#6142                mov        eax,trinum                                                   
//#6143                mov        ecx,src                                                   
//#6144                shr        eax,cl                                                   
//#6145                and        eax,3                                                   
//#6146                mov        ecx,dst                                                   
//#6147                shl        eax,cl                                                   
//#6148        }                                                                   
//#6149    }                                                                       
//#6150                                                                           
//#6151    unsigned dudbits(POINT dif){                                                                       
//#6152                                                                           
//#6153        return xdst[dif.x+121]|ydst[dif.y+121];                                                                   
//#6154    }                                                                       
//#6155                                                                           
//#6156    void savdst(unsigned dat){                                                                       
//#6157                                                                           
//#6158        _asm{                                                                   
//#6159                xor        eax,eax                                                   
//#6160                mov        al,3                                                   
//#6161                mov        ecx,dstcnt                                                   
//#6162                mul        ecx                                                   
//#6163                inc        ecx                                                   
//#6164                mov        dstcnt,ecx                                                   
//#6165                add        eax,drecs                                                   
//#6166                mov        ebx,dat                                                   
//#6167                mov        [eax],ebx                                                   
//#6168        }                                                                   
//#6169    }                                                                       
//#6170                                                                           
//#6171    void ritdst(){                                                                       
//#6172                                                                           
//#6173    #define DSTMAX 121                                                                       
//#6174                                                                           
//#6175        unsigned        ind,styp,col,cnt,colind;                                                           
//#6176        POINT            loc,len,alen,dif,stp;                                                       
//#6177        FLRCT            trct;                                                       
//#6178        SHRTPNT*        histch;                                                           
//#6179        unsigned*        pcol;                                                           
//#6180        HANDLE            hcol;                                                       
//#6181        unsigned long    wrot;                                                               
//#6182                                                                           
//#6183        pcol=(unsigned*)&oseq;                                                                   
//#6184        colind=3;                                                                   
//#6185        pcol[0]=COLVER;                                                                   
//#6186        pcol[1]=stchBak;                                                                   
//#6187        pcol[2]=useCol[stchs[0].at&COLMSK];                                                                   
//#6188        histch=&stchs[MAXSEQ];                                                                   
//#6189        for(ind=0;ind<hed.stchs;ind++){                                                                   
//#6190                                                                           
//#6191            histch[ind].x=stchsr[ind].x*5/3;                                                               
//#6192            histch[ind].y=stchsr[ind].y*5/3;                                                               
//#6193            histch[ind].at=stchsr[ind].at;                                                               
//#6194        }                                                                   
//#6195        trct.left=trct.right=histch[0].x;                                                                   
//#6196        trct.bottom=trct.top=histch[0].y;                                                                   
//#6197        for(ind=1;ind<hed.stchs;ind++){                                                                   
//#6198                                                                           
//#6199            if(histch[ind].x>trct.right)                                                               
//#6200                trct.right=histch[ind].x+0.5;                                                           
//#6201            if(histch[ind].x<trct.left)                                                               
//#6202                trct.left=histch[ind].x-0.5;                                                           
//#6203            if(histch[ind].y>trct.top)                                                               
//#6204                trct.top=histch[ind].y+0.5;                                                           
//#6205            if(histch[ind].y<trct.bottom)                                                               
//#6206                trct.bottom=histch[ind].y-0.5;                                                           
//#6207        }                                                                   
//#6208         drecs=(DSTREC*)&bseq;                                                                   
//#6209        dstcnt=0;                                                                   
//#6210        loc.x=(trct.right-trct.left)/2+trct.left;                                                                   
//#6211        loc.y=(trct.top-trct.bottom)/2+trct.bottom;                                                                   
//#6212        dstplus.x=trct.right-loc.x+1;                                                                   
//#6213        dstplus.y=trct.top-loc.y+1;                                                                   
//#6214        dstmin.x=loc.x-trct.left-1;                                                                   
//#6215        dstmin.y=loc.y-trct.bottom-1;                                                                   
//#6216        col=histch[0].at&0xf;                                                                   
//#6217        for(ind=0;ind<hed.stchs;ind++){                                                                   
//#6218                                                                           
//#6219            if(col!=(histch[ind].at&0xf)){                                                               
//#6220                                                                           
//#6221                savdst(0xc30000);                                                           
//#6222                col=histch[ind].at&0xf;                                                           
//#6223                pcol[colind++]=useCol[col];                                                           
//#6224            }                                                               
//#6225            len.x=histch[ind].x-loc.x;                                                               
//#6226            len.y=histch[ind].y-loc.y;                                                               
//#6227            alen.x=abs(len.x);                                                               
//#6228            alen.y=abs(len.y);                                                               
//#6229            if(abs(alen.x)>abs(alen.y))                                                               
//#6230                cnt=alen.x/DSTMAX+1;                                                           
//#6231            else                                                               
//#6232                cnt=alen.y/DSTMAX+1;                                                           
//#6233            stp.x=alen.x/cnt+1;                                                               
//#6234            stp.y=alen.y/cnt+1;                                                               
//#6235            while(len.x||len.y){                                                               
//#6236                                                                           
//#6237                styp=REGTYP;                                                           
//#6238                if(abs(len.x)>stp.x){                                                           
//#6239                                                                           
//#6240                    styp=JMPTYP;                                                       
//#6241                    if(len.x>0)                                                       
//#6242                        dif.x=stp.x;                                                   
//#6243                    else                                                       
//#6244                        dif.x=-stp.x;                                                   
//#6245                }                                                           
//#6246                else                                                           
//#6247                    dif.x=len.x;                                                       
//#6248                if(abs(len.y)>stp.y){                                                           
//#6249                                                                           
//#6250                    styp=JMPTYP;                                                       
//#6251                    if(len.y>0)                                                       
//#6252                        dif.y=stp.y;                                                   
//#6253                    else                                                       
//#6254                        dif.y=-stp.y;                                                   
//#6255                }                                                           
//#6256                else                                                           
//#6257                    dif.y=len.y;                                                       
//#6258                savdst(dudbits(dif)|styp);                                                           
//#6259                loc.x+=dif.x;                                                           
//#6260                loc.y+=dif.y;                                                           
//#6261                len.x-=dif.x;                                                           
//#6262                len.y-=dif.y;                                                           
//#6263            }                                                               
//#6264        }                                                                   
//#6265        drecs[dstcnt].led=drecs[dstcnt].mid=0;                                                                   
//#6266        drecs[dstcnt++].nd=(TCHAR)0xf3;                                                                   
//#6267                                                                           
//#6268        if(colfil()){                                                                   
//#6269                                                                           
//#6270            hcol=CreateFile(colnam,GENERIC_WRITE,0,0,CREATE_ALWAYS,0,0);                                                               
//#6271            if(hcol!=INVALID_HANDLE_VALUE)                                                               
//#6272                WriteFile(hcol,&oseq,colind<<2,&wrot,0);                                                           
//#6273            CloseHandle(hcol);                                                               
//#6274            hcol=CreateFile(rgbnam,GENERIC_WRITE,0,0,CREATE_ALWAYS,0,0);                                                               
//#6275            if(hcol!=INVALID_HANDLE_VALUE)                                                               
//#6276                WriteFile(hcol,&pcol[2],(colind-2)<<2,&wrot,0);                                                           
//#6277            CloseHandle(hcol);                                                               
//#6278        }                                                                   
//#6279    }                                                                       
//#6280                                                                           
//#6281    BOOL pcshup(){                                                                       
//#6282                                                                           
//#6283        FLRCT        trct;                                                           
//#6284        FLPNT        siz;                                                           
//#6285        unsigned    ind;                                                               
//#6286        FLPNT        hupsiz;                                                           
//#6287        FLPNT        dif;                                                           
//#6288                                                                           
//#6289        trct.left=trct.right=stchsr[0].x;                                                                   
//#6290        trct.bottom=trct.top=stchsr[0].y;                                                                   
//#6291        for(ind=1;ind<hed.stchs;ind++){                                                                   
//#6292                                                                           
//#6293            if(stchsr[ind].x<trct.left)                                                               
//#6294                trct.left=stchsr[ind].x;                                                           
//#6295            if(stchsr[ind].x>trct.right)                                                               
//#6296                trct.right=stchsr[ind].x;                                                           
//#6297            if(stchsr[ind].y<trct.bottom)                                                               
//#6298                trct.bottom=stchsr[ind].y;                                                           
//#6299            if(stchsr[ind].y>trct.top)                                                               
//#6300                trct.top=stchsr[ind].y;                                                           
//#6301        }                                                                   
//#6302        siz.x=trct.right-trct.left;                                                                   
//#6303        siz.y=trct.top-trct.bottom;                                                                   
//#6304        if(siz.x>LHUPX||siz.y>LHUPY){                                                                   
//#6305                                                                           
//#6306            tabmsg(IDS_PFAF2L);                                                               
//#6307            return 1;                                                               
//#6308        }                                                                   
//#6309        if(siz.x>SHUPX||siz.y>SHUPY){                                                                   
//#6310                                                                           
//#6311            hed.hup=LARGHUP;                                                               
//#6312            hupsiz.x=LHUPX;                                                               
//#6313            hupsiz.y=LHUPY;                                                               
//#6314        }                                                                   
//#6315        else{                                                                   
//#6316                                                                           
//#6317            if(ini.hupx==LHUPX&&ini.hupy==LHUPY){                                                               
//#6318                                                                           
//#6319                hed.hup=LARGHUP;                                                           
//#6320                hupsiz.x=LHUPX;                                                           
//#6321                hupsiz.y=LHUPY;                                                           
//#6322            }                                                               
//#6323            else{                                                               
//#6324                                                                           
//#6325                hed.hup=SMALHUP;                                                           
//#6326                hupsiz.x=SHUPX;                                                           
//#6327                hupsiz.y=SHUPY;                                                           
//#6328            }                                                               
//#6329        }                                                                   
//#6330        dif.x=dif.y=0;                                                                   
//#6331        if(trct.right>hupsiz.x)                                                                   
//#6332            dif.x=hupsiz.x-trct.right;                                                               
//#6333        if(trct.top>hupsiz.y)                                                                   
//#6334            dif.y=hupsiz.y-trct.top;                                                               
//#6335        if(trct.left<0)                                                                   
//#6336            dif.x=-trct.left;                                                               
//#6337        if(trct.bottom<0)                                                                   
//#6338            dif.y=-trct.bottom;                                                               
//#6339        if(dif.x||dif.y){                                                                   
//#6340                                                                           
//#6341            for(ind=0;ind<hed.stchs;ind++){                                                               
//#6342                                                                           
//#6343                stchsr[ind].x+=dif.x;                                                           
//#6344                stchsr[ind].y+=dif.y;                                                           
//#6345            }                                                               
//#6346        }                                                                   
//#6347        return 0;                                                                   
//#6348    }                                                                       
//#6349                                                                           
//#6350    #if PESACT                                                                       
//#6351                                                                           
//#6352    void ritpes(unsigned stind){                                                                       
//#6353                                                                           
//#6354        pestchs[opnt].x=-stchsr[stind].x*3/5+sof.x;                                                                   
//#6355        pestchs[opnt++].y=stchsr[stind].y*3/5-sof.y;                                                                   
//#6356    }                                                                       
//#6357                                                                           
//#6358    void ritpcol(unsigned char col){                                                                       
//#6359                                                                           
//#6360        _asm{                                                                   
//#6361                                                                           
//#6362                mov        ebx,opnt                                                   
//#6363                mov        eax,ebx                                                   
//#6364                inc        eax                                                   
//#6365                mov        opnt,eax                                                   
//#6366                shl        ebx,2                                                   
//#6367                add        ebx,pestchs                                                   
//#6368                xor        eax,eax                                                   
//#6369                mov        al,col                                                   
//#6370                mov        [ebx],eax                                                   
//#6371        }                                                                   
//#6372    }                                                                       
//#6373                                                                           
//#6374    unsigned pesnam(){                                                                       
//#6375                                                                           
//#6376        _asm{                                                                   
//#6377                mov        ebx,offset auxnam                                                   
//#6378                mov        ecx,MAX_PATH                                                   
//#6379                mov        edx,ebx                                                   
//#6380    peslup0:    mov        al,[ebx]                                                           
//#6381                or        al,al                                                   
//#6382                je        short peslup1                                                   
//#6383                cmp        al,'\\'                                                   
//#6384                jne        short peslup0a                                                   
//#6385                mov        edx,ebx                                                   
//#6386    peslup0a:    inc        ebx                                                           
//#6387                loop    peslup0                                                       
//#6388    peslup1:    mov        ebx,edx                                                           
//#6389                cmp        byte ptr[ebx],'\\'                                                   
//#6390                jne        short peslup1a                                                   
//#6391                inc        ebx                                                   
//#6392    peslup1a:    xor        ecx,ecx                                                           
//#6393                mov        cl,17                                                   
//#6394                mov        edi,offset bseq                                                   
//#6395                mov        dword ptr[edi],':AL'                                                   
//#6396                add        edi,3                                                   
//#6397    peslup:        mov        al,[ebx]                                                       
//#6398                inc        ebx                                                   
//#6399                cmp        al,'.'                                                   
//#6400                je        pesnamx                                                   
//#6401                mov        [edi],al                                                   
//#6402                inc        edi                                                   
//#6403                loop    peslup                                                       
//#6404    pesnamx:    mov        eax,edi                                                           
//#6405                sub        eax,offset bseq                                                   
//#6406        }                                                                   
//#6407    }                                                                       
//#6408                                                                           
//#6409    void rpcrd(float dif){                                                                       
//#6410                                                                           
//#6411        int idif;                                                                   
//#6412                                                                           
//#6413        idif=dif*5/3;                                                                   
//#6414        if(idif<0){                                                                   
//#6415                                                                           
//#6416            if(idif>-64){                                                               
//#6417                                                                           
//#6418                peschr[opnt]=idif-128;                                                           
//#6419                opnt++;                                                           
//#6420            }                                                               
//#6421            else{                                                               
//#6422                                                                           
//#6423                peschr[opnt]=idif>>8;                                                           
//#6424                opnt++;                                                           
//#6425                peschr[opnt]=idif&0x8f;                                                           
//#6426                opnt++;                                                           
//#6427            }                                                               
//#6428        }                                                                   
//#6429        else{                                                                   
//#6430                                                                           
//#6431            if(idif<64){                                                               
//#6432                                                                           
//#6433                peschr[opnt]=idif;                                                           
//#6434                opnt++;                                                           
//#6435            }                                                               
//#6436            else{                                                               
//#6437                                                                           
//#6438                peschr[opnt]=(idif>>8)|0x80;                                                           
//#6439                opnt++;                                                           
//#6440                peschr[opnt]=idif&0xff;                                                           
//#6441                opnt++;                                                           
//#6442            }                                                               
//#6443        }                                                                   
//#6444    }                                                                       
//#6445                                                                           
//#6446    void pecdat(){                                                                       
//#6447                                                                           
//#6448        unsigned    ind,col,pcol;                                                               
//#6449                                                                           
//#6450        opnt=532;                                                                   
//#6451        pcol=1;                                                                   
//#6452        col=stchs[0].at&COLMSK;                                                                   
//#6453        peschr=(TCHAR*)&bseq;                                                                   
//#6454        pescols=(unsigned char*)&peschr[49];                                                                   
//#6455        rpcrd(stchs[0].x);                                                                   
//#6456        rpcrd(-stchs[0].y);                                                                   
//#6457        for(ind=0;ind<(unsigned)hed.stchs-1;ind++){                                                                   
//#6458                                                                           
//#6459            if((stchs[ind].at&COLMSK)!=col){                                                               
//#6460                                                                           
//#6461                col=stchs[ind].at&COLMSK;                                                           
//#6462                peschr[opnt]=(TCHAR)254;                                                           
//#6463                opnt++;                                                           
//#6464                peschr[opnt]=(TCHAR)176;                                                           
//#6465                opnt++;                                                           
//#6466                peschr[opnt]=pcol;                                                           
//#6467                opnt++;                                                           
//#6468                pescols[pcol]=pescolrs[col];                                                           
//#6469                pcol++;                                                           
//#6470            }                                                               
//#6471            rpcrd(stchs[ind+1].x-stchs[ind].x);                                                               
//#6472            rpcrd(-stchs[ind+1].y+stchs[ind].y);                                                               
//#6473        }                                                                   
//#6474        peschr[opnt++]=(TCHAR)0xff;                                                                   
//#6475        peschr[opnt++]=0;                                                                   
//#6476    }                                                                       
//#6477                                                                           
//#6478    #endif                                                                       
//#6479                                                                           
//#6480    void chk1col(){                                                                       
//#6481                                                                           
//#6482        unsigned ind,ine,col;                                                                   
//#6483                                                                           
//#6484        coltab();                                                                   
//#6485        setMap(RESTCH);                                                                   
//#6486        for(ind=0;ind<colCnt;ind++){                                                                   
//#6487                                                                           
//#6488            if(colch[ind+1].stind-colch[ind].stind==1){                                                               
//#6489                                                                           
//#6490                ine=colch[ind].stind;                                                           
//#6491                col=stchs[ine-1].at&COLMSK;                                                           
//#6492                stchs[ine].at&=NCOLMSK;                                                           
//#6493                stchs[ine].at|=col;                                                           
//#6494            }                                                               
//#6495        }                                                                   
//#6496    }                                                                       
//#6497                                                                           
//#6498    BOOL chkattr(TCHAR* nam){                                                                       
//#6499                                                                           
//#6500        unsigned        attr,ind;                                                           
//#6501        TCHAR            driv[MAX_PATH];                                                       
//#6502        unsigned long    sec;                                                               
//#6503        unsigned long    byt;                                                               
//#6504        unsigned long    fclst;                                                               
//#6505        unsigned long    tclst;                                                               
//#6506                                                                           
//#6507        if(rstMap(NOTFREE))                                                                   
//#6508            return 1;                                                               
//#6509        attr=GetFileAttributes(nam);                                                                   
//#6510        if(attr&FILE_ATTRIBUTE_READONLY&&attr!=0xffffffff){                                                                   
//#6511                                                                           
//#6512            sprintf(msgbuf,stab[STR_OVRLOK],nam);                                                               
//#6513            ind=MessageBox(hWnd,msgbuf,stab[STR_OVRIT],MB_YESNO);                                                               
//#6514            if(ind==IDYES)                                                               
//#6515                SetFileAttributes(nam,attr&(0xffffffff^FILE_ATTRIBUTE_READONLY));                                                           
//#6516            else                                                               
//#6517                return 1;                                                           
//#6518        }                                                                   
//#6519        strcpy(driv,homdir);                                                                   
//#6520        driv[3]=0;                                                                   
//#6521        if(!GetDiskFreeSpace(driv,&sec,&byt,&fclst,&tclst)){                                                                   
//#6522                                                                           
//#6523            setMap(NOTFREE);                                                               
//#6524            return 1;                                                               
//#6525        }                                                                   
//#6526        return 0;                                                                   
//#6527    }                                                                       
//#6528
procedure TfrmMain.save();
begin
//#6529    void sav(){                                                                       
//#6530                                                                           
//#6531        unsigned        ind,stind;                                                           
//#6532        unsigned long    wrot;                                                               
//#6533        double            frct,intg;                                                       
//#6534        DSTHED            dsthed;                                                       
//#6535        TCHAR*            pchr;                                                       
//#6536        POINT            loc;                                                       
//#6537                                                                           
//#6538    #if PESACT                                                                       
//#6539                                                                           
//#6540        PESHED            peshed;                                                       
//#6541        PESTCH*            pestch;                                                       
//#6542        unsigned        match;                                                           
//#6543        unsigned        mtchind;                                                           
//#6544        unsigned        mtchmin;                                                           
//#6545        unsigned char    pescol;                                                               
//#6546        FLRCT            srct;                                                       
//#6547        unsigned        tcol,ine;                                                           
//#6548        unsigned        pcolcnt;                                                           
//#6549        unsigned*        pesof;                                                           
//#6550        unsigned*        upnt;                                                           
//#6551        short*            psiz;                                                       
//#6552    #endif                                                                       
//#6553                                                                           
//#6554        duauxnam();                                                                   
//#6555        if(chkattr(auxnam))                                                                   
//#6556            return;                                                               
//#6557        if(!hed.stchs)                                                                   
//#6558            return;                                                               
//#6559        chk1col();                                                                   
//#6560        coltab();                                                                   
//#6561        stchsr=(SHRTPNT*)&bseq;                                                                   
//#6562        if(chku(ROTAUX)){                                                                   
//#6563                                                                           
//#6564            for(ind=0;ind<hed.stchs;ind++){                                                               
//#6565                                                                           
//#6566                stchsr[ind].y=-stchs[ind].x;                                                           
//#6567                stchsr[ind].x=stchs[ind].y;                                                           
//#6568                stchsr[ind].at=stchs[ind].at;                                                           
//#6569            }                                                               
//#6570        }                                                                   
//#6571        else{                                                                   
//#6572                                                                           
//#6573            for(ind=0;ind<hed.stchs;ind++){                                                               
//#6574                                                                           
//#6575                stchsr[ind].x=stchs[ind].x;                                                           
//#6576                stchsr[ind].y=stchs[ind].y;                                                           
//#6577                stchsr[ind].at=stchs[ind].at;                                                           
//#6578            }                                                               
//#6579        }                                                                   
//#6580        hPcs=CreateFile(auxnam,(GENERIC_WRITE|GENERIC_READ),0,NULL,                                                                   
//#6581            CREATE_ALWAYS,0,NULL);                                                               
//#6582        if(hPcs==INVALID_HANDLE_VALUE){                                                                   
//#6583                                                                           
//#6584            crmsg(auxnam);                                                               
//#6585            hPcs=0;                                                               
//#6586        }                                                                   
//#6587        else{                                                                   
//#6588                                                                           
//#6589            switch(ini.auxfil){                                                               
//#6590                                                                           
//#6591            case AUXDST:                                                               
//#6592                                                                           
//#6593                ritdst();                                                           
//#6594                ind=0;loc.x=loc.y=0;                                                           
//#6595                pchr=(TCHAR*)&dsthed;                                                           
//#6596                for(ind=0;ind<sizeof(DSTHED);ind++)                                                           
//#6597                    pchr[ind]=' ';                                                       
//#6598                strcpy(dsthed.desched,"LA:");                                                           
//#6599                pchr=strrchr(auxnam,'\\')+1;                                                           
//#6600                for(ind=0;ind<sizeof(dsthed.desc);ind++){                                                           
//#6601                                                                           
//#6602                    if(pchr[ind]&&pchr[ind]!='.')                                                       
//#6603                        dsthed.desc[ind]=pchr[ind];                                                   
//#6604                    else                                                       
//#6605                        break;                                                   
//#6606                }                                                           
//#6607                dsthed.desc[16]=0xd;                                                           
//#6608                strncpy(dsthed.recshed,"ST:",3);                                                           
//#6609                sprintf(dsthed.recs,"%7d\r",dstcnt);                                                           
//#6610                strncpy(dsthed.cohed,"CO:  0",6);                                                           
//#6611                strncpy(dsthed.xplushed-1,"\xd+X:",4);                                                           
//#6612                sprintf(dsthed.xplus,"%5d\xd",dstmin.x);                                                           
//#6613                strncpy(dsthed.xminhed,"-X:",3);                                                           
//#6614                sprintf(dsthed.xmin,"%5d\xd",dstplus.x);                                                           
//#6615                strncpy(dsthed.yplushed,"+Y:",3);                                                           
//#6616                sprintf(dsthed.yplus,"%5d\xd",dstplus.y);                                                           
//#6617                strncpy(dsthed.yminhed,"-Y:",3);                                                           
//#6618                sprintf(dsthed.ymin,"%5d\xd",dstmin.y);                                                           
//#6619                strncpy(dsthed.axhed,"AX:-    0\r",10);                                                           
//#6620                strncpy(dsthed.ayhed,"AY:+    0\r",10);                                                           
//#6621                strncpy(dsthed.mxhed,"MX:+    0\r",10);                                                           
//#6622                strncpy(dsthed.myhed,"MY:+    0\r",10);                                                           
//#6623                strncpy(dsthed.pdhed,"PD******\r\x1a",10);                                                           
//#6624                pchr=(TCHAR*)&dsthed;                                                           
//#6625                WriteFile(hPcs,(DSTHED*)&dsthed,sizeof(DSTHED),&wrot,0);                                                           
//#6626                WriteFile(hPcs,(DSTREC*)drecs,sizeof(DSTREC)*dstcnt,&wrot,0);                                                           
//#6627                break;                                                           
//#6628                                                                           
//#6629    #if PESACT                                                                       
//#6630                                                                           
//#6631            case AUXPES:                                                               
//#6632                                                                           
//#6633                pchr=(TCHAR*)&peshed;                                                           
//#6634                for(ind=0;ind<sizeof(PESHED);ind++)                                                           
//#6635                    pchr[ind]=0;                                                       
//#6636                strcpy(peshed.led,"#PES0001");                                                           
//#6637                strcpy(peshed.ce,"CEmbOne");                                                           
//#6638                strcpy(peshed.cs,"CSewSeg");                                                           
//#6639                pestch=(PESTCH*)&bseq;                                                           
//#6640                for(ind=0;ind<16;ind++){                                                           
//#6641                                                                           
//#6642                    mtchmin=0xffffffff;                                                       
//#6643                    for(ine=0;ine<sizeof(pestrn)>>2;ine++){                                                       
//#6644                                                                           
//#6645                        match=pesmtch(useCol[ind],ine);                                                   
//#6646                        if(match<mtchmin){                                                   
//#6647                                                                           
//#6648                            mtchind=ine;                                               
//#6649                            mtchmin=match;                                               
//#6650                        }                                                   
//#6651                    }                                                       
//#6652                    pescolrs[ind]=(unsigned char)mtchind;                                                       
//#6653                }                                                           
//#6654                tcol=stchs[0].at&COLMSK;                                                           
//#6655                pescol=peshed.scol=pescolrs[stchs[0].at&COLMSK];                                                           
//#6656                sizstch(&srct);                                                           
//#6657                sof.x=midl(srct.right,srct.left);                                                           
//#6658                sof.y=midl(srct.top,srct.bottom);                                                           
//#6659                peshed.xsiz=srct.right-srct.left;                                                           
//#6660                peshed.ysiz=srct.top-srct.bottom;                                                           
//#6661                opnt=0;                                                           
//#6662                pestchs=(PESTCH*)&bseq;                                                           
//#6663                ritpes(0);                                                           
//#6664                pestchs[opnt].x=(short)0x8003;                                                           
//#6665                pestchs[opnt++].y=0;                                                           
//#6666                ritpcol(pescolrs[tcol]);                                                           
//#6667                ritpes(0);                                                           
//#6668                pcolcnt=0;                                                           
//#6669                for(ind=1;ind<hed.stchs;ind++){                                                           
//#6670                                                                           
//#6671                    if(tcol==(stchs[ind].at&COLMSK))                                                       
//#6672                        ritpes(ind);                                                   
//#6673                    else{                                                       
//#6674                                                                           
//#6675                        ritpes(ind);                                                   
//#6676                        pestchs[opnt].x=(short)0x8001;                                                   
//#6677                        pestchs[opnt++].y=0;                                                   
//#6678                        ritpcol(pescolrs[tcol]);                                                   
//#6679                        tcol=stchs[ind].at&COLMSK;                                                   
//#6680                        ritpes(ind++);                                                   
//#6681                        ritpes(ind);                                                   
//#6682                        pestchs[opnt].x=(short)0x8003;                                                   
//#6683                        pestchs[opnt++].y=0;                                                   
//#6684                        ritpcol(pescolrs[tcol]);                                                   
//#6685                        ritpes(ind);                                                   
//#6686                        pcolcnt++;                                                   
//#6687                    }                                                       
//#6688                }                                                           
//#6689                pestchs[opnt].x=ine;                                                           
//#6690                pestchs[opnt++].y=0;                                                           
//#6691                pesof=(unsigned*)&peshed.off;                                                           
//#6692                *pesof=(opnt<<2)+sizeof(PESHED);                                                           
//#6693                *peshed.m1=0x20;                                                           
//#6694                gpnt0=0;                                                           
//#6695                gpnt1=hed.stchs-1;                                                           
//#6696                peshed.xsiz=10000;                                                           
//#6697                peshed.ysiz=10000;                                                           
//#6698                WriteFile(hPcs,(PESHED*)&peshed,sizeof(PESHED),&wrot,0);                                                           
//#6699                WriteFile(hPcs,(PESTCH*)&bseq,opnt<<2,&wrot,0);                                                           
//#6700                ind=pesnam();                                                           
//#6701                pchr=(TCHAR*)&bseq;                                                           
//#6702                while(ind<512)                                                           
//#6703                    pchr[ind++]=' ';                                                       
//#6704                pchr[19]=13;                                                           
//#6705                pchr[48]=(TCHAR)pcolcnt;                                                           
//#6706                pecdat();                                                           
//#6707                upnt=(unsigned*)&pchr[514];                                                           
//#6708                *upnt=opnt-512;                                                           
//#6709                pchr[517]=0x20;                                                           
//#6710                pchr[518]=-1;                                                           
//#6711                pchr[519]=-17;                                                           
//#6712                psiz=(short*)&pchr[520];                                                           
//#6713                *psiz=peshed.xsiz;                                                           
//#6714                psiz++;                                                           
//#6715                *psiz=peshed.ysiz;                                                           
//#6716                psiz++;                                                           
//#6717                *psiz=480;                                                           
//#6718                pesof=(unsigned*)psiz;                                                           
//#6719                *pesof=11534816;                                                           
//#6720    //            pchr[527]=(TCHAR)0x0;                                                           
//#6721    //            pchr[528]=(TCHAR)0x90;                                                           
//#6722    //            pchr[529]=(TCHAR)0x0;                                                           
//#6723    //            pchr[530]=(TCHAR)0x8f;                                                           
//#6724                pchr[527]=(TCHAR)0x00;                                                           
//#6725                pchr[528]=(TCHAR)0x80;    //hor    msb                                                   
//#6726                pchr[529]=(TCHAR)0x80; //hor lsb                                                           
//#6727                pchr[530]=(TCHAR)0x82; //vert msb                                                           
//#6728                pchr[531]=(TCHAR)0xff; //vert lsb                                                           
//#6729                WriteFile(hPcs,(TCHAR*)&bseq,opnt,&wrot,0);                                                           
//#6730                break;                                                           
//#6731    #endif                                                                       
//#6732            default:                                                               
//#6733                                                                           
//#6734                for(ind=0;ind<16;ind++)                                                           
//#6735                    hed.fCols[ind]=useCol[ind];                                                       
//#6736                if(pcshup())                                                           
//#6737                    return;                                                       
//#6738                if(!WriteFile(hPcs,&hed,0x46,&wrot,0)){                                                           
//#6739                                                                           
//#6740                    riter();                                                       
//#6741                    return;                                                       
//#6742                }                                                           
//#6743                filBuf=new PCSTCH[hed.stchs+colCnt+2];                                                           
//#6744                clrfbuf((sizeof(PCSTCH)*(hed.stchs+colCnt+1))>>2);                                                           
//#6745                stind=0;                                                           
//#6746                savcol=0xff;                                                           
//#6747                for(ind=0;ind<hed.stchs;ind++){                                                           
//#6748                                                                           
//#6749                    if((stchsr[ind].at&COLMSK)!=savcol){                                                       
//#6750                                                                           
//#6751                        savcol=stchsr[ind].at&COLMSK;                                                   
//#6752                        filBuf[stind].typ=3;                                                   
//#6753                        filBuf[stind++].fx=savcol;                                                   
//#6754                    }                                                       
//#6755                    frct=modf(stchsr[ind].x,&intg);                                                       
//#6756                    filBuf[stind].fx=frct*256;                                                       
//#6757                    filBuf[stind].x=intg;                                                       
//#6758                    frct=modf(stchsr[ind].y,&intg);                                                       
//#6759                    filBuf[stind].fy=frct*256;                                                       
//#6760                    filBuf[stind++].y=intg;                                                       
//#6761                }                                                           
//#6762                if(!WriteFile(hPcs,filBuf,stind*sizeof(PCSTCH),&wrot,0)){                                                           
//#6763                                                                           
//#6764                    riter();                                                       
//#6765                    return;                                                       
//#6766                }                                                           
//#6767                if(chku(BSAVOF)){                                                           
//#6768                                                                           
//#6769                    *msgbuf=0;                                                       
//#6770                    if(!WriteFile(hPcs,msgbuf,15,&wrot,0)){                                                       
//#6771                                                                           
//#6772                        riter();                                                   
//#6773                        return;                                                   
//#6774                    }                                                       
//#6775                }                                                           
//#6776                else{                                                           
//#6777                                                                           
//#6778                    if(!WriteFile(hPcs,bnam,15,&wrot,0)){                                                       
//#6779                                                                           
//#6780                        riter();                                                   
//#6781                        return;                                                   
//#6782                    }                                                       
//#6783                }                                                           
//#6784                delete filBuf;                                                           
//#6785            }                                                               
//#6786            defNam(filnam);                                                               
//#6787            CloseHandle(hPcs);                                                               
//#6788            if(chku(ROTAUX))                                                               
//#6789                filnopn(IDS_FILROT,auxnam);                                                           
//#6790        }
//#6791    }
end;


procedure TfrmMain.mnu_FILE_SAVE3Click(Sender: TObject); //SaveAs
begin
  with TSaveStitchsDialog.Create(Self) do
  begin
    if Execute then
      FStitchs.SaveToFile(FileName);


    Free;
  end;                                                                           
//#6793    void savAs(){
//#6794                                                                           
//#6795        TCHAR*    pchr;                                                               
//#6796                                                                           
//#6797        if(hed.stchs||formpnt||*bnam){                                                                   
//#6798                                                                           
//#6799            ofn.nFilterIndex=0;                                                               
//#6800            if(GetSaveFileName(&ofn)){                                                               
//#6801                                                                           
//#6802                _strlwr(filnam);                                                           
//#6803                pchr=strrchr(filnam,'.');                                                           
//#6804                if(!pchr)                                                           
//#6805                    pchr=&filnam[strlen(filnam)];                                                       
//#6806                switch(ofn.nFilterIndex){                                                           
//#6807                                                                           
//#6808                case 1:                                                           
//#6809                                                                           
//#6810                    strcpy(pchr,".thr");                                                       
//#6811                    break;                                                       
//#6812                                                                           
//#6813                case 2:                                                           
//#6814                                                                           
//#6815                    strcpy(pchr,".pcs");                                                       
//#6816                    ini.auxfil=AUXPCS;                                                       
//#6817                    auxmen();                                                       
//#6818                    break;                                                       
//#6819                                                                           
//#6820                case 3:                                                           
//#6821                                                                           
//#6822                    strcpy(pchr,".dst");                                                       
//#6823                    ini.auxfil=AUXDST;                                                       
//#6824                    auxmen();                                                       
//#6825                    break;                                                       
//#6826                }                                                           
//#6827                setMap(SAVAS);                                                           
//#6828                nunams();                                                           
//#6829                ritini();                                                           
//#6830                rstMap(SAVAS);                                                           
//#6831                rstMap(CMPDO);                                                           
//#6832                thrsav();                                                           
//#6833                sav();                                                           
//#6834                SetWindowText(hWnd,thrnam);                                                           
//#6835            }                                                               
//#6836        }                                                                   
//#6837    }
end;

procedure TfrmMain.mnu_FILE_SAVE2Click(Sender: TObject); //Save
begin
//#6839    void save(){
//#6840
//#6841        TCHAR*    pchr;
//#6842        TCHAR    tchr;
//#6843
//#6844        if(filnam[0]){
  if self.FStitchs.FileName <> '' then
  begin
//#6845
//#6846            pchr=strrchr(filnam,'.');
//#6847            if(pchr)
//#6848                pchr++;
//#6849            else{
//#6850
//#6851                strcat(filnam,".thr");
//#6852                pchr=strrchr(filnam,'.')+1;
//#6853            }
//#6854            tchr=pchr[0]|0x20;
//#6855            thrsav();
//#6856            if(hed.stchs)
//#6857                sav();
    FStitchs.SaveToFile(FStitchs.FileName);
//#6858        }
  end
  else
    mnu_FILE_SAVE3Click(Sender); //SaveAs 
//#6859        else
//#6860            savAs();
//#6861    }
end;

//#6862
//#6863    COLORREF nuCol(COLORREF init){
//#6864
//#6865        gCol.Flags=CC_ANYCOLOR|CC_RGBINIT;
//#6866        gCol.hwndOwner=hWnd;                                                                   
//#6867        gCol.lCustData=0;                                                                   
//#6868        gCol.lpCustColors=custCol;                                                                   
//#6869        gCol.lpfnHook=0;                                                                   
//#6870        gCol.lpTemplateName=0;                                                                   
//#6871        gCol.rgbResult=init;                                                                   
//#6872        gCol.lStructSize=sizeof(gCol);                                                                   
//#6873        return ChooseColor(&gCol);                                                                   
//#6874    }                                                                       
//#6875                                                                           
//#6876    COLORREF nuBak(){                                                                       
//#6877                                                                           
//#6878        bCol.Flags=CC_ANYCOLOR|CC_RGBINIT;                                                                   
//#6879        bCol.hwndOwner=hWnd;                                                                   
//#6880        bCol.lCustData=0;                                                                   
//#6881        bCol.lpCustColors=bakCust;                                                                   
//#6882        bCol.lpfnHook=0;                                                                   
//#6883        bCol.lpTemplateName=0;                                                                   
//#6884        bCol.rgbResult=stchBak;                                                                   
//#6885        bCol.lStructSize=sizeof(bCol);                                                                   
//#6886        return ChooseColor(&bCol);                                                                   
//#6887    }                                                                       
//#6888                                                                           
//#6889    COLORREF nuBit(){                                                                       
//#6890                                                                           
//#6891        btCol.Flags=CC_ANYCOLOR|CC_RGBINIT;                                                                   
//#6892        btCol.hwndOwner=hWnd;                                                                   
//#6893        btCol.lCustData=0;                                                                   
//#6894        btCol.lpCustColors=bakBit;                                                                   
//#6895        btCol.lpfnHook=0;                                                                   
//#6896        btCol.lpTemplateName=0;                                                                   
//#6897        btCol.rgbResult=bitCol;                                                                   
//#6898        btCol.lStructSize=sizeof(bCol);                                                                   
//#6899        return ChooseColor(&btCol);                                                                   
//#6900    }                                                                       
//#6901                                                                           
//#6902    void pxCor2stch(POINT pnt){                                                                       
//#6903                                                                           
//#6904        double    tdub;                                                               
//#6905                                                                           
//#6906        tdub=(double)(pnt.x-sRct.left)/scRct.right;                                                                   
//#6907        sPnt.x=tdub*(zRct.right-zRct.left)+zRct.left;                                                                   
//#6908        tdub=(double)(sRct.bottom-pnt.y)/scRct.bottom;                                                                   
//#6909        sPnt.y=tdub*(zRct.top-zRct.bottom)+zRct.bottom;                                                                   
//#6910    }                                                                       
//#6911                                                                           
//#6912    /*                                                                       
//#6913    void pxCor2stch(POINT pnt){                                                                       
//#6914                                                                           
//#6915        double    tdub;                                                               
//#6916        double    tx,ty;                                                               
//#6917        double    tr;                                                               
//#6918                                                                           
//#6919        tdub=(double)(pnt.x-sRct.left)/scRct.right;                                                                   
//#6920        tx=tdub*(zRct.right-zRct.left)+zRct.left;                                                                   
//#6921        sPnt.x=tx+0.5;                                                                   
//#6922        tdub=(double)(sRct.bottom-pnt.y)/scRct.bottom;                                                                   
//#6923        tr=(zRct.right-zRct.left)/stchAspct;                                                                   
//#6924        ty=tdub*tr+zRct.bottom;                                                                   
//#6925        sPnt.y=ty+0.5;                                                                   
//#6926    }*/                                                                       
//#6927                                                                           
//#6928    unsigned px2stch(){                                                                       
//#6929                                                                           
//#6930        double    tdub;                                                               
//#6931                                                                           
//#6932        if(msg.pt.x>=sRct.left&&msg.pt.x<=sRct.right                                                                   
//#6933            &&msg.pt.y>=sRct.top&&msg.pt.y<=sRct.bottom){                                                               
//#6934                                                                           
//#6935            tdub=(double)(msg.pt.x-sRct.left)/scRct.right;                                                               
//#6936            sPnt.x=tdub*(zRct.right-zRct.left)+zRct.left;                                                               
//#6937            tdub=(double)(sRct.bottom-msg.pt.y)/scRct.bottom;                                                               
//#6938            sPnt.y=tdub*(zRct.top-zRct.bottom)+zRct.bottom;                                                               
//#6939            return 1;                                                               
//#6940        }                                                                   
//#6941        else                                                                   
//#6942            return 0;                                                               
//#6943    }                                                                       
//#6944                                                                           
//#6945    void shft2box(){                                                                       
//#6946                                                                           
//#6947        sPnt.x=stchs[cloInd].x;                                                                   
//#6948        sPnt.y=stchs[cloInd].y;                                                                   
//#6949        shft(sPnt);                                                                   
//#6950        stch2px1(cloInd);                                                                   
//#6951    }                                                                       
//#6952                                                                           
//#6953    void zumin(){                                                                       
//#6954                                                                           
//#6955        DUBPNT        nusiz;                                                           
//#6956        FLRCT        srct;                                                           
//#6957        FLRCT*        trct;                                                           
//#6958        unsigned    ind;                                                               
//#6959                                                                           
//#6960        if(!rstMap(ZUMACT))                                                                   
//#6961            zumFct*=ZUMFCT;                                                               
//#6962        if(zumFct<zumflor)                                                                   
//#6963            zumFct=zumflor;                                                               
//#6964        if(!setMap(ZUMED))                                                                   
//#6965            movStch();                                                               
//#6966        if(!rstMap(BZUMIN)){                                                                   
//#6967                                                                           
//#6968            if(chkMap(GMRK)){                                                               
//#6969                                                                           
//#6970                sPnt.x=mrkpnt.x;                                                           
//#6971                sPnt.y=mrkpnt.y;                                                           
//#6972                goto gotc;                                                           
//#6973            }                                                               
//#6974            if(chkMap(FORMSEL)){                                                               
//#6975                                                                           
//#6976                trct=&formlst[clofind].rct;                                                           
//#6977                sPnt.x=((trct->right-trct->left)/2)+trct->left;                                                           
//#6978                sPnt.y=((trct->top-trct->bottom)/2)+trct->bottom;                                                           
//#6979                goto gotc;                                                           
//#6980            }                                                               
//#6981            if(chkMap(FRMPSEL)){                                                               
//#6982                                                                           
//#6983                sPnt.x=formlst[clofind].flt[clofine].x;                                                           
//#6984                sPnt.y=formlst[clofind].flt[clofine].y;                                                           
//#6985                goto gotc;                                                           
//#6986            }                                                               
//#6987            if(chkMap(SELBOX)){                                                               
//#6988                                                                           
//#6989                sPnt.x=stchs[cloInd].x;                                                           
//#6990                sPnt.y=stchs[cloInd].y;                                                           
//#6991                goto gotc;                                                           
//#6992            }                                                               
//#6993            if(chkMap(GRPSEL)){                                                               
//#6994                                                                           
//#6995                selRct(&srct);                                                           
//#6996                sPnt.x=((srct.right-srct.left)/2)+srct.left;                                                           
//#6997                sPnt.y=((srct.top-srct.bottom)/2)+srct.bottom;                                                           
//#6998                goto gotc;                                                           
//#6999            }                                                               
//#7000            if(chkMap(INSRT)){                                                               
//#7001                                                                           
//#7002                if(chkMap(LIN1)){                                                           
//#7003                                                                           
//#7004                    if(chkMap(BAKEND)){                                                       
//#7005                                                                           
//#7006                        sPnt.x=stchs[hed.stchs-1].x;                                                   
//#7007                        sPnt.y=stchs[hed.stchs-1].y;                                                   
//#7008                    }                                                       
//#7009                    else{                                                       
//#7010                                                                           
//#7011                        sPnt.x=stchs[0].x;                                                   
//#7012                        sPnt.y=stchs[0].y;                                                   
//#7013                    }                                                       
//#7014                }                                                           
//#7015                else{                                                           
//#7016                                                                           
//#7017                    sPnt.x=(stchs[cloInd+1].x-stchs[cloInd].x)/2+stchs[cloInd].x;                                                       
//#7018                    sPnt.y=(stchs[cloInd+1].y-stchs[cloInd].y)/2+stchs[cloInd].y;                                                       
//#7019                }                                                           
//#7020                goto gotc;                                                           
//#7021            }                                                               
//#7022            if(fselpnt){                                                               
//#7023                                                                           
//#7024                bigrct.bottom=formlst[selist[0]].rct.bottom;                                                           
//#7025                bigrct.top=formlst[selist[0]].rct.top;                                                           
//#7026                bigrct.left=formlst[selist[0]].rct.left;                                                           
//#7027                bigrct.right=formlst[selist[0]].rct.right;                                                           
//#7028                for(ind=1;ind<fselpnt;ind++){                                                           
//#7029                                                                           
//#7030                    if(formlst[selist[ind]].rct.bottom<bigrct.bottom)                                                       
//#7031                        bigrct.bottom=formlst[selist[ind]].rct.bottom;                                                   
//#7032                    if(formlst[selist[ind]].rct.top>bigrct.top)                                                       
//#7033                        bigrct.top=formlst[selist[ind]].rct.top;                                                   
//#7034                    if(formlst[selist[ind]].rct.left<bigrct.left)                                                       
//#7035                        bigrct.left=formlst[selist[ind]].rct.left;                                                   
//#7036                    if(formlst[selist[ind]].rct.right>bigrct.right)                                                       
//#7037                        bigrct.right=formlst[selist[ind]].rct.right;                                                   
//#7038                }                                                           
//#7039                sPnt.x=(bigrct.right-bigrct.left)/2+bigrct.left;                                                           
//#7040                sPnt.y=(bigrct.top-bigrct.bottom)/2+bigrct.bottom;                                                           
//#7041                goto gotc;                                                           
//#7042            }                                                               
//#7043            if(!px2stch())                                                               
//#7044                centr();                                                           
//#7045        }                                                                   
//#7046    gotc:;                                                                       
//#7047        nusiz.x=zum0.x*zumFct;                                                                   
//#7048        nusiz.y=nusiz.x/stchAspct;                                                                   
//#7049        zRct.left=zRct.bottom=0;                                                                   
//#7050        zRct.right=nusiz.x;                                                                   
//#7051        zRct.top=nusiz.y;                                                                   
//#7052        shft(sPnt);                                                                   
//#7053        selCnt=0;                                                                   
//#7054        if(!chkMap(GMRK)&&chkMap(SELBOX))                                                                   
//#7055            shft2box();                                                               
//#7056        if(chkMap(RUNPAT)){                                                                   
//#7057                                                                           
//#7058            FillRect(sdc,&scRct,hStchBak);                                                               
//#7059            runpnt=0;                                                               
//#7060        }                                                                   
//#7061        duzrat();                                                                   
//#7062        movins();                                                                   
//#7063        setMap(RESTCH);                                                                   
//#7064        ilin();                                                                   
//#7065    }                                                                       
//#7066                                                                           
//#7067    void zumhom(){                                                                       
//#7068                                                                           
//#7069        zRct.bottom=0;                                                                   
//#7070        zRct.left=0;                                                                   
//#7071        zRct.right=zum0.x;                                                                   
//#7072        zRct.top=zum0.y;                                                                   
//#7073        zumFct=1;                                                                   
//#7074        rstMap(ZUMED);                                                                   
//#7075        movStch();                                                                   
//#7076        selCnt=0;                                                                   
//#7077        if(chkMap(RUNPAT)){                                                                   
//#7078                                                                           
//#7079            FillRect(sdc,&scRct,hStchBak);                                                               
//#7080            runpnt=0;                                                               
//#7081        }                                                                   
//#7082        setMap(RESTCH);                                                                   
//#7083        if(chkMap(SELBOX))                                                                   
//#7084            shft2box();                                                               
//#7085        duzrat();                                                                   
//#7086        movins();                                                                   
//#7087    }                                                                       
//#7088                                                                           
//#7089    void zumshft(){                                                                       
//#7090                                                                           
//#7091        POINT pnt;                                                                   
//#7092        DUBPNT spnt;                                                                   
//#7093                                                                           
//#7094        if(chkMap(ZUMED)){                                                                   
//#7095                                                                           
//#7096            unboxs();                                                               
//#7097            if(px2stch()){                                                               
//#7098                selCnt=0;                                                           
//#7099                shft(sPnt);                                                           
//#7100                spnt.x=sPnt.x;                                                           
//#7101                spnt.y=sPnt.y;                                                           
//#7102                sCor2px(spnt,&pnt);                                                           
//#7103                if(chkMap(RUNPAT)){                                                           
//#7104                                                                           
//#7105                    FillRect(sdc,&scRct,hStchBak);                                                       
//#7106                    runpnt=0;                                                       
//#7107                }                                                           
//#7108                setMap(RESTCH);                                                           
//#7109            }                                                               
//#7110        }                                                                   
//#7111        movins();                                                                   
//#7112    }                                                                       
//#7113                                                                           
//#7114    void zumout(){                                                                       
//#7115                                                                           
//#7116        POINT    nusiz;                                                               
//#7117        FLRCT    srct;                                                               
//#7118        FLRCT*    trct;                                                               
//#7119                                                                           
//#7120        unboxs();                                                                   
//#7121        if(chkMap(ZUMED)){                                                                   
//#7122                                                                           
//#7123            if(chkMap(GMRK)){                                                               
//#7124                                                                           
//#7125                sPnt.x=mrkpnt.x;                                                           
//#7126                sPnt.y=mrkpnt.y;                                                           
//#7127                goto gots;                                                           
//#7128            }                                                               
//#7129            if(chkMap(FORMSEL)){                                                               
//#7130                                                                           
//#7131                trct=&formlst[clofind].rct;                                                           
//#7132                sPnt.x=((trct->right-trct->left)/2)+trct->left;                                                           
//#7133                sPnt.y=((trct->top-trct->bottom)/2)+trct->bottom;                                                           
//#7134                goto gots;                                                           
//#7135            }                                                               
//#7136            if(chkMap(FRMPSEL)){                                                               
//#7137                                                                           
//#7138                sPnt.x=formlst[clofind].flt[clofine].x;                                                           
//#7139                sPnt.y=formlst[clofind].flt[clofine].y;                                                           
//#7140                goto gots;                                                           
//#7141            }                                                               
//#7142            if(chkMap(SELBOX)||chkMap(INSRT)){                                                               
//#7143                                                                           
//#7144                sPnt.x=stchs[cloInd].x;                                                           
//#7145                sPnt.y=stchs[cloInd].y;                                                           
//#7146                goto gots;                                                           
//#7147            }                                                               
//#7148            if(chkMap(GRPSEL)){                                                               
//#7149                                                                           
//#7150                selRct(&srct);                                                           
//#7151                sPnt.x=((srct.right-srct.left)/2)+srct.left;                                                           
//#7152                sPnt.y=((srct.top-srct.bottom)/2)+srct.bottom;                                                           
//#7153                goto gots;                                                           
//#7154            }                                                               
//#7155            if(chkMap(SELBOX)){                                                               
//#7156                                                                           
//#7157                shft2box();                                                           
//#7158                goto gots;                                                           
//#7159            }                                                               
//#7160            if(!px2stch())                                                               
//#7161                centr();                                                           
//#7162    gots:;                                                                       
//#7163            zumFct/=ZUMFCT;                                                               
//#7164            if(zumFct>0.98){                                                               
//#7165                                                                           
//#7166                zumFct=1;                                                           
//#7167                rstMap(ZUMED);                                                           
//#7168                zRct.bottom=0;                                                           
//#7169                zRct.left=0;                                                           
//#7170                zRct.right=zum0.x;                                                           
//#7171                zRct.top=zum0.y;                                                           
//#7172                movStch();                                                           
//#7173                selCnt=0;                                                           
//#7174            }                                                               
//#7175            else{                                                               
//#7176                                                                           
//#7177                nusiz.x=zum0.x*zumFct;                                                           
//#7178                nusiz.y=nusiz.x/stchAspct;                                                           
//#7179                zRct.left=zRct.bottom=0;                                                           
//#7180                zRct.top=nusiz.y;                                                           
//#7181                zRct.right=nusiz.x;                                                           
//#7182                shft(sPnt);                                                           
//#7183            }                                                               
//#7184            if(chkMap(RUNPAT)){                                                               
//#7185                                                                           
//#7186                FillRect(sdc,&scRct,hStchBak);                                                           
//#7187                runpnt=0;                                                           
//#7188            }                                                               
//#7189            setMap(RESTCH);                                                               
//#7190            duzrat();                                                               
//#7191            movins();                                                               
//#7192        }                                                                   
//#7193    }                                                                       
//#7194                                                                           
//#7195    void duClos(unsigned strt,unsigned cnt){                                                                       
//#7196                                                                           
//#7197        unsigned    ind,ine,tind0,tind1;                                                               
//#7198        double        sum,tsum;                                                           
//#7199        long        cx,cy;                                                           
//#7200                                                                           
//#7201        for(ind=strt;ind<strt+cnt;ind++){                                                                   
//#7202                                                                           
//#7203            cx=abs(stchs[ind].x-sPnt.x);                                                               
//#7204            cy=abs(stchs[ind].y-sPnt.y);                                                               
//#7205            sum=hypot(cx,cy);                                                               
//#7206            tind0=ind;                                                               
//#7207            for(ine=0;ine<NERCNT;ine++){                                                               
//#7208                                                                           
//#7209                if(sum<ner[ine]){                                                           
//#7210                                                                           
//#7211                    tsum=ner[ine];                                                       
//#7212                    tind1=nerInd[ine];                                                       
//#7213                    ner[ine]=sum;                                                       
//#7214                    nerInd[ine]=tind0;                                                       
//#7215                    sum=tsum;                                                       
//#7216                    tind0=tind1;                                                       
//#7217                }                                                           
//#7218            }                                                               
//#7219        }                                                                   
//#7220    }                                                                       
//#7221                                                                           
//#7222    void closPnt(){                                                                       
//#7223                                                                           
//#7224        unsigned    ind,sind0,sind1;                                                               
//#7225                                                                           
//#7226        unbox();                                                                   
//#7227        unboxs();                                                                   
//#7228        for(ind=0;ind<4;ind++){                                                                   
//#7229                                                                           
//#7230            ner[ind]=1e99;                                                               
//#7231            nerInd[ind]=-1;                                                               
//#7232        }                                                                   
//#7233        px2stch();                                                                   
//#7234        for(ind=0;ind<colCnt;ind++){                                                                   
//#7235                                                                           
//#7236            sind0=colch[ind].stind;                                                               
//#7237            sind1=colch[ind+1].stind;                                                               
//#7238            if(chkMap(HID)){                                                               
//#7239                                                                           
//#7240                if(colch[ind].colind==actcol)                                                           
//#7241                    duClos(sind0,sind1-sind0);                                                       
//#7242            }                                                               
//#7243            else                                                               
//#7244                duClos(sind0,sind1-sind0);                                                           
//#7245        }                                                                   
//#7246        GetClientRect(hStch,&scRct);                                                                   
//#7247        for(ind=0;ind<NERCNT;ind++){                                                                   
//#7248                                                                           
//#7249            if(stch2px(nerInd[ind])){                                                               
//#7250                                                                           
//#7251                nerInd[selCnt]=nerInd[ind];                                                           
//#7252                pxNer[selCnt].x=pPnt.x;                                                           
//#7253                pxNer[selCnt++].y=pPnt.y;                                                           
//#7254            }                                                               
//#7255        }                                                                   
//#7256        boxs();                                                                   
//#7257    }                                                                       
//#7258                                                                           
//#7259    unsigned closPnt1(unsigned* clo){                                                                       
//#7260                                                                           
//#7261        unsigned    ind,ine,tclo=0;                                                               
//#7262        unsigned    layr;                                                               
//#7263        long        nerSid;                                                           
//#7264        double        cx,cy;                                                           
//#7265        POINT        chkPnt;                                                           
//#7266        double        tsum=1e99;                                                           
//#7267                                                                           
//#7268        chkPnt.x=msg.pt.x-stOrg.x;                                                                   
//#7269        chkPnt.y=msg.pt.y-stOrg.y;                                                                   
//#7270        if(chkMap(SELBOX)&&stch2px(cloInd)){                                                                   
//#7271                                                                           
//#7272            if(hypot(pPnt.x-chkPnt.x,pPnt.y-chkPnt.y)<CLOSENUF){                                                               
//#7273                                                                           
//#7274                *clo=cloInd;                                                           
//#7275                return 1;                                                           
//#7276            }                                                               
//#7277        }                                                                   
//#7278        for(ind=0;ind<selCnt;ind++){                                                                   
//#7279                                                                           
//#7280            nerSid=boxOff[ind];                                                               
//#7281            if(    chkPnt.x>=pxNer[ind].x-nerSid&&                                                           
//#7282                chkPnt.x<=pxNer[ind].x+nerSid&&                                                           
//#7283                chkPnt.y>=pxNer[ind].y-nerSid&&                                                           
//#7284                chkPnt.y<=pxNer[ind].y+nerSid){                                                           
//#7285                                                                           
//#7286                *clo=nerInd[ind];                                                           
//#7287                return 1;                                                           
//#7288            }                                                               
//#7289        }                                                                   
//#7290        px2stch();                                                                   
//#7291        cloSum=1e99;                                                                   
//#7292        if(chkMap(HID)){                                                                   
//#7293                                                                           
//#7294            for(ind=0;ind<colCnt;ind++){                                                               
//#7295                                                                           
//#7296                if(colch[ind].colind==actcol){                                                           
//#7297                                                                           
//#7298                    for(ine=colch[ind].stind;ine<colch[ind+1].stind;ine++){                                                       
//#7299                                                                           
//#7300                        if(    stchs[ine].x>=zRct.left&&                                               
//#7301                            stchs[ine].x<=zRct.right&&                                               
//#7302                            stchs[ine].y>=zRct.bottom&&                                               
//#7303                            stchs[ine].y<=zRct.top){                                               
//#7304                                                                           
//#7305                            cx=abs(stchs[ine].x-sPnt.x);                                               
//#7306                            cy=abs(stchs[ine].y-sPnt.y);                                               
//#7307                            tsum=hypot(cx,cy);                                               
//#7308                            if(tsum<cloSum){                                               
//#7309                                                                           
//#7310                                cloSum=tsum;                                           
//#7311                                tclo=ine;                                           
//#7312                            }                                               
//#7313                        }                                                   
//#7314                    }                                                       
//#7315                }                                                           
//#7316            }                                                               
//#7317        }                                                                   
//#7318        else{                                                                   
//#7319                                                                           
//#7320            for(ind=0;ind<hed.stchs;ind++){                                                               
//#7321                                                                           
//#7322                layr=(stchs[ind].at&LAYMSK)>>LAYSHFT;                                                           
//#7323                if(!actl||!layr||layr==actl){                                                           
//#7324                                                                           
//#7325                    if(    stchs[ind].x>=zRct.left&&                                                   
//#7326                        stchs[ind].x<=zRct.right&&                                                   
//#7327                        stchs[ind].y>=zRct.bottom&&                                                   
//#7328                        stchs[ind].y<=zRct.top){                                                   
//#7329                                                                           
//#7330                        cx=stchs[ind].x-sPnt.x;                                                   
//#7331                        cy=stchs[ind].y-sPnt.y;                                                   
//#7332                        tsum=hypot(cx,cy);                                                   
//#7333                        if(tsum<cloSum){                                                   
//#7334                                                                           
//#7335                            cloSum=tsum;                                               
//#7336                            tclo=ind;                                               
//#7337                        }                                                   
//#7338                    }                                                       
//#7339                }                                                           
//#7340            }                                                               
//#7341        }                                                                   
//#7342        if(cloSum==1e99)                                                                   
//#7343            return 0;                                                               
//#7344        else{                                                                   
//#7345                                                                           
//#7346            stch2px(tclo);                                                               
//#7347            if(chkMap(IGNTHR)){                                                               
//#7348                                                                           
//#7349                *clo=tclo;                                                           
//#7350                return 1;                                                           
//#7351            }                                                               
//#7352            else{                                                               
//#7353                                                                           
//#7354                if(hypot(chkPnt.x-pPnt.x,chkPnt.y-pPnt.y)<CLOSENUF){                                                           
//#7355                                                                           
//#7356                    *clo=tclo;                                                       
//#7357                    return 1;                                                       
//#7358                }                                                           
//#7359                else                                                           
//#7360                    return 0;                                                       
//#7361            }                                                               
//#7362        }                                                                   
//#7363    }                                                                       
//#7364                                                                           
//#7365    unsigned pt2colInd(unsigned pInd){                                                                       
//#7366                                                                           
//#7367        unsigned ind;                                                                   
//#7368                                                                           
//#7369        for(ind=0;ind<colCnt;ind++){                                                                   
//#7370                                                                           
//#7371            if(colch[ind].stind>pInd)                                                               
//#7372                break;                                                           
//#7373        }                                                                   
//#7374        return ind;                                                                   
//#7375    }                                                                       
//#7376                                                                           
//#7377    void unthum(){                                                                       
//#7378                                                                           
//#7379        unsigned ind;                                                                   
//#7380                                                                           
//#7381        if(rstMap(THUMSHO)){                                                                   
//#7382                                                                           
//#7383            for(ind=0;ind<4;ind++)                                                               
//#7384                DestroyWindow(hvu[ind]);                                                           
//#7385            if(chkMap(UPTO))                                                               
//#7386                butxt(HUPTO,stab[STR_UPON]);                                                           
//#7387            else                                                               
//#7388                butxt(HUPTO,stab[STR_UPOF]);                                                           
//#7389            butxt(HNUM,"");                                                               
//#7390            redraw(hbuts[HHID]);                                                               
//#7391            butxt(HBOXSEL,stab[STR_BOXSEL]);                                                               
//#7392        }                                                                   
//#7393    }                                                                       
//#7394                                                                           
//#7395    void toglup(){                                                                       
//#7396                                                                           
//#7397        if(toglMap(UPTO))                                                                   
//#7398            butxt(HUPTO,stab[STR_UPOF]);                                                               
//#7399        else{                                                                   
//#7400                                                                           
//#7401            if(rstMap(GRPSEL)){                                                               
//#7402                                                                           
//#7403                rngadj();                                                           
//#7404                cloInd=gpnt0;                                                           
//#7405                setMap(SELBOX);                                                           
//#7406                rstMap(FRMPSEL);                                                           
//#7407            }                                                               
//#7408            else{                                                               
//#7409                                                                           
//#7410                if(!chkMap(SELBOX)){                                                           
//#7411                                                                           
//#7412                    cloInd=0;                                                       
//#7413                    if(rstMap(FORMSEL)){                                                       
//#7414                                                                           
//#7415                        while(cloInd<hed.stchs&&notfstch(stchs[cloInd].at))                                                   
//#7416                            cloInd++;                                               
//#7417                        setMap(SELBOX);                                                   
//#7418                        rstMap(FRMPSEL);                                                   
//#7419                    }                                                       
//#7420                }                                                           
//#7421            }                                                               
//#7422            butxt(HUPTO,stab[STR_UPON]);                                                               
//#7423        }                                                                   
//#7424        setMap(RESTCH);                                                                   
//#7425    }                                                                       
//#7426                                                                           
//#7427    void toglHid(){                                                                       
//#7428                                                                           
//#7429        if(toglMap(HID))                                                                   
//#7430            rstMap(FRMOF);                                                               
//#7431        else                                                                   
//#7432            setMap(FRMOF);                                                               
//#7433        unthum();                                                                   
//#7434        redraw(hbuts[HHID]);                                                                   
//#7435        setMap(RESTCH);                                                                   
//#7436    }                                                                       
//#7437                                                                           
//#7438    void dulin(){                                                                       
//#7439                                                                           
//#7440        SelectObject(rsdc,lPen);                                                                   
//#7441        SetROP2(rsdc,R2_NOTXORPEN);                                                                   
//#7442        if(mlin0[0].x==mlin1[1].x&&mlin0[0].y==mlin1[1].y){                                                                   
//#7443                                                                           
//#7444            if(chkMap(ISDWN)){                                                               
//#7445                                                                           
//#7446                Polyline(rsdc,mlin0,2);                                                           
//#7447                goto dux;                                                           
//#7448            }                                                               
//#7449            else{                                                               
//#7450                                                                           
//#7451                Polyline(rsdc,mlin1,2);                                                           
//#7452                goto dux;                                                           
//#7453            }                                                               
//#7454        }                                                                   
//#7455        else{                                                                   
//#7456                                                                           
//#7457            if(chkMap(ISDWN))                                                               
//#7458                Polyline(rsdc,mlin0,2);                                                           
//#7459            if(chkMap(ISUP))                                                               
//#7460                Polyline(rsdc,mlin1,2);                                                           
//#7461        }                                                                   
//#7462    dux:;                                                                       
//#7463        SetROP2(rsdc,R2_COPYPEN);                                                                   
//#7464        toglMap(WASLIN);                                                                   
//#7465    }                                                                       
//#7466                                                                           
//#7467    void unlin(){                                                                       
//#7468                                                                           
//#7469        if(chkMap(WASLIN))                                                                   
//#7470            dulin();                                                               
//#7471    }                                                                       
//#7472                                                                           
//#7473    void movbox(){                                                                       
//#7474                                                                           
//#7475        if(stch2px(cloInd)){                                                                   
//#7476                                                                           
//#7477            unbox();                                                               
//#7478            dubox();                                                               
//#7479            if(chkMap(UPTO))                                                               
//#7480                setMap(RESTCH);                                                           
//#7481        }                                                                   
//#7482        else{                                                                   
//#7483                                                                           
//#7484            shft2box();                                                               
//#7485            setMap(SELBOX);                                                               
//#7486            rstMap(FRMPSEL);                                                               
//#7487            setMap(RESTCH);                                                               
//#7488        }                                                                   
//#7489        nuAct(cloInd);                                                                   
//#7490        ritcor(&stchs[cloInd]);                                                                   
//#7491    }                                                                       
//#7492                                                                           
//#7493    BOOL chkhid(unsigned cpnt){                                                                       
//#7494                                                                           
//#7495        if(chkMap(HID)){                                                                   
//#7496                                                                           
//#7497            if(colch[cpnt].colind==actcol)                                                               
//#7498                return 1;                                                           
//#7499            else                                                               
//#7500                return 0;                                                           
//#7501        }                                                                   
//#7502        else                                                                   
//#7503            return 1;                                                               
//#7504    }                                                                       
//#7505                                                                           
//#7506    /*                                                                       
//#7507    This function attempts to find the stitch the user is trying to select.                                                                       
//#7508    A rectangle is created that is slightly larger than the stitch.                                                                       
//#7509    If the mouse position is outside this rectangle, the stitch is disqualified.                                                                       
//#7510    If the mouse position is inside the rectangle, the distance from the stitch                                                                       
//#7511     to the select point (sPnt) is calculated.                                                                       
//#7512                                                                           
//#7513    Find the equation for the line by solving the linear parametric eauations                                                                       
//#7514                                                                           
//#7515      stchs[ind].x+slop*stchs[ind].y=off                                                                       
//#7516      stchs[ind+1].x+slop*stchs[ind+1].y=off                                                                       
//#7517                                                                           
//#7518    substituting:                                                                       
//#7519                                                                           
//#7520      stchs[ind].x+slop*stchs[ind].y=stchs[ind+1].x+slop*stchs[ind+1].y                                                                       
//#7521                                                                           
//#7522    collecting terms:                                                                       
//#7523                                                                           
//#7524      slop*stchs[ind].y-slop*stchs[ind-1].y=stchs[ind+1].x-stchs[ind].x                                                                       
//#7525      slop*(stchs[ind].y-stchs[ind-1].y)=stchs[ind+1].x-stchs[ind].x                                                                       
//#7526      slop=(stchs[ind+1].x-stchs[ind].x)/(stchs[ind].y-stchs[ind-1].y)                                                                       
//#7527                                                                           
//#7528    define xba=stchs[ind+1].x-stchs[ind].x                                                                       
//#7529    define yab=stchs[ind].y-stchs[ind+1].y                                                                       
//#7530                                                                           
//#7531      slop=xba/yab;                                                                       
//#7532                                                                           
//#7533    back substituting into stchs[ind].x+slop*stchs[ind].y=off                                                                       
//#7534                                                                           
//#7535      off=stchs[ind].x+slop*stchs[ind].y                                                                       
//#7536                                                                           
//#7537    The equation for a point vertical to the equation for the line and running                                                                       
//#7538     through sPnt is:                                                                       
//#7539                                                                           
//#7540      sPnt.x-sPnt.y/slop=poff                                                                       
//#7541                                                                           
//#7542    If ipnt is the intersections between the two lines then                                                                       
//#7543                                                                           
//#7544      ipnt.x-slop*ipnt.y=off                                                                       
//#7545      ipnt.x+ipnt.y/slop=poff                                                                       
//#7546                                                                           
//#7547    Subtracting the two equations                                                                       
//#7548                                                                           
//#7549      slop*ipnt.y+ipnt.y/slop=off-poff                                                                       
//#7550                                                                           
//#7551    Multiply by slop                                                                       
//#7552                                                                           
//#7553      slop*slop*ipnt.y+ipnt.y=slop(off-poff)                                                                       
//#7554      ipnt.y(slop*slop+1)=slop(off-poff)                                                                       
//#7555      ipnt.y=slop*(off-poff)/(slop*slop+1)                                                                       
//#7556                                                                           
//#7557    back substitute into ipnt.x+slop*ipnt.y=off                                                                       
//#7558                                                                           
//#7559      ipnt.x=off-slop*ipnt.y                                                                       
//#7560                                                                           
//#7561    if dx=ipnt.x-spnt.x & dy=ipnt.y-spnt.y                                                                       
//#7562                                                                           
//#7563    the distance from the point to the line is given by                                                                       
//#7564                                                                           
//#7565      sqrt(dx*dx+dy*dy)                                                                       
//#7566    */                                                                       
//#7567                                                                           
//#7568    unsigned closlin(){                                                                       
//#7569                                                                           
//#7570        unsigned    ind,ine,scnt,clos=0xffffffff;                                                               
//#7571        double        sum=1e99;                                                           
//#7572        long        xba,yab;                                                           
//#7573        double        tsum;                                                           
//#7574        FRCT        trct;                                                           
//#7575        double        slop,off,poff,tol,dx,dy;                                                           
//#7576        DUBPNT        ipnt;                                                           
//#7577        DUBPNT        chkpnt;                                                           
//#7578        SHRTPNT*    pstch;                                                               
//#7579        unsigned    layr;                                                               
//#7580                                                                           
//#7581    #define        TOL    20                                                           
//#7582                                                                           
//#7583        unboxs();                                                                   
//#7584         off=(float)(msg.pt.x-sRct.left)/(sRct.right-sRct.left);                                                                   
//#7585        chkpnt.x=off*(zRct.right-zRct.left)+zRct.left;                                                                   
//#7586        off=(float)(sRct.bottom-msg.pt.y)/(sRct.bottom-sRct.top);                                                                   
//#7587        chkpnt.y=(off*(zRct.top-zRct.bottom)+zRct.bottom);                                                                   
//#7588        off=(double)(zRct.right-zRct.left)/scRct.right;                                                                   
//#7589        tol=off*TOL;                                                                   
//#7590        for(ine=0;ine<colCnt;ine++){                                                                   
//#7591                                                                           
//#7592            scnt=colch[ine+1].stind-colch[ine].stind;                                                               
//#7593            pstch=&stchs[colch[ine].stind];                                                               
//#7594            if(chkhid(ine)){                                                               
//#7595                                                                           
//#7596                for(ind=0;ind<scnt;ind++){                                                           
//#7597                                                                           
//#7598                    layr=(pstch[ine].at&LAYMSK)>>LAYSHFT;                                                       
//#7599                    if(!actl||!layr||(layr==actl)){                                                       
//#7600                                                                           
//#7601                        xba=pstch[ind+1].x-pstch[ind].x;                                                   
//#7602                        yab=pstch[ind].y-pstch[ind+1].y;                                                   
//#7603                        if(xba>0){                                                   
//#7604                                                                           
//#7605                            trct.left=pstch[ind].x-tol;                                               
//#7606                            trct.right=pstch[ind+1].x+tol;                                               
//#7607                        }                                                   
//#7608                        else{                                                   
//#7609                                                                           
//#7610                            trct.left=pstch[ind+1].x-tol;                                               
//#7611                            trct.right=pstch[ind].x+tol;                                               
//#7612                        }                                                   
//#7613                        if(yab<0){                                                   
//#7614                                                                           
//#7615                            trct.bottom=pstch[ind].y-tol;                                               
//#7616                            trct.top=pstch[ind+1].y+tol;                                               
//#7617                        }                                                   
//#7618                        else{                                                   
//#7619                                                                           
//#7620                            trct.bottom=pstch[ind+1].y-tol;                                               
//#7621                            trct.top=pstch[ind].y+tol;                                               
//#7622                        }                                                   
//#7623                        if(chkpnt.x>trct.left&&chkpnt.x<trct.right                                                   
//#7624                            &&chkpnt.y>trct.bottom&&chkpnt.y<trct.top){                                               
//#7625                                                                           
//#7626                            if(yab==0){                                               
//#7627                                                                           
//#7628                                //stitch is horizontal                                           
//#7629                                ipnt.x=chkpnt.x;                                           
//#7630                                ipnt.y=pstch[ind].y;                                           
//#7631                                tsum=abs(pstch[ind].y-chkpnt.y);                                           
//#7632                                goto gotsum;                                           
//#7633                            }                                               
//#7634                            if(xba==0){                                               
//#7635                                                                           
//#7636                                //stitch is vertical                                           
//#7637                                dx=pstch[ind].x-chkpnt.x;                                           
//#7638                                trct.top-=tol;                                           
//#7639                                trct.bottom+=tol;                                           
//#7640                                if(chkpnt.y>trct.top){                                           
//#7641                                                                           
//#7642                                    dy=chkpnt.y-trct.top;                                       
//#7643                                    tsum=hypot(dx,dy);                                       
//#7644                                    goto gotal;                                       
//#7645                                }                                           
//#7646                                if(chkpnt.y<trct.bottom){                                           
//#7647                                                                           
//#7648                                    dy=chkpnt.y-trct.bottom;                                       
//#7649                                    tsum=hypot(dx,dy);                                       
//#7650                                    goto gotal;                                       
//#7651                                }                                           
//#7652                                tsum=fabs(dx);                                           
//#7653                                goto gotal;                                           
//#7654                            }                                               
//#7655                            slop=(double)xba/yab;                                               
//#7656                            off=pstch[ind].x+slop*pstch[ind].y;                                               
//#7657                            poff=chkpnt.x-chkpnt.y/slop;                                               
//#7658                            ipnt.y=slop*(off-poff)/(slop*slop+1);                                               
//#7659                            ipnt.x=off-slop*ipnt.y;                                               
//#7660                            dx=ipnt.x-chkpnt.x;                                               
//#7661                            dy=ipnt.y-chkpnt.y;                                               
//#7662                            tsum=hypot(dx,dy);                                               
//#7663    gotsum:;                                                                       
//#7664                            trct.bottom+=tol;                                               
//#7665                            trct.top-=tol;                                               
//#7666                            trct.left+=tol;                                               
//#7667                            trct.right-=tol;                                               
//#7668                            if(ipnt.x<trct.left){                                               
//#7669                                                                           
//#7670                                if(ipnt.y<trct.bottom)                                           
//#7671                                    tsum=sqrt(abs(chkpnt.x-trct.left)+abs(chkpnt.y-trct.bottom));                                       
//#7672                                else                                           
//#7673                                    tsum=sqrt(abs(chkpnt.x-trct.left)+abs(chkpnt.y-trct.top));                                       
//#7674                            }                                               
//#7675                            else{                                               
//#7676                                                                           
//#7677                                if(ipnt.x>trct.right){                                           
//#7678                                                                           
//#7679                                    if(ipnt.y<trct.bottom)                                       
//#7680                                        tsum=sqrt(abs(chkpnt.x-trct.right)+abs(chkpnt.y-trct.bottom));                                   
//#7681                                    else                                       
//#7682                                        tsum=sqrt(abs(chkpnt.x-trct.right)+abs(chkpnt.y-trct.top));                                   
//#7683                                }                                           
//#7684                            }                                               
//#7685    gotal:;                                                                       
//#7686                            if(tsum<sum){                                               
//#7687                                                                           
//#7688                                sum=tsum;                                           
//#7689                                clos=ind+colch[ine].stind;                                           
//#7690                            }                                               
//#7691                        }                                                   
//#7692                    }                                                       
//#7693                }                                                           
//#7694            }                                                               
//#7695        }                                                                   
//#7696        if(sum>tol)                                                                   
//#7697            return 0xffffffff;                                                               
//#7698        else                                                                   
//#7699            return clos;                                                               
//#7700    }                                                                       
//#7701                                                                           
//#7702    void ilin(){                                                                       
//#7703                                                                           
//#7704        SelectObject(rsdc,lPen);                                                                   
//#7705        SetROP2(rsdc,R2_NOTXORPEN);                                                                   
//#7706        Polyline(rsdc,inlin,2);                                                                   
//#7707        SetROP2(rsdc,R2_XORPEN);                                                                   
//#7708        Polyline(rsdc,&inlin[1],2);                                                                   
//#7709        SetROP2(rsdc,R2_COPYPEN);                                                                   
//#7710        SelectObject(sdc,lPen);                                                                   
//#7711        SetROP2(sdc,R2_NOTXORPEN);                                                                   
//#7712        Polyline(sdc,inlin,2);                                                                   
//#7713        SetROP2(sdc,R2_XORPEN);                                                                   
//#7714        Polyline(sdc,&inlin[1],2);                                                                   
//#7715        SetROP2(sdc,R2_COPYPEN);                                                                   
//#7716    }                                                                       
//#7717                                                                           
//#7718    void xlin(){                                                                       
//#7719                                                                           
//#7720        if(rstMap(ILIN))                                                                   
//#7721            ilin();                                                               
//#7722    }                                                                       
//#7723                                                                           
//#7724    void ilin1(){                                                                       
//#7725                                                                           
//#7726        SelectObject(rsdc,lPen);                                                                   
//#7727        SetROP2(rsdc, R2_NOTXORPEN);                                                                   
//#7728        Polyline(rsdc,inlin,2);                                                                   
//#7729        SetROP2(rsdc,R2_COPYPEN);                                                                   
//#7730    }                                                                       
//#7731                                                                           
//#7732    void xlin1(){                                                                       
//#7733                                                                           
//#7734        if(rstMap(ILIN1))                                                                   
//#7735            ilin1();                                                               
//#7736    }                                                                       
//#7737                                                                           
//#7738    void duIns(){                                                                       
//#7739                                                                           
//#7740        POINT tlin[2];                                                                   
//#7741                                                                           
//#7742        inlin[1].x=msg.pt.x-stOrg.x;                                                                   
//#7743        inlin[1].y=msg.pt.y-stOrg.y;                                                                   
//#7744        stch2px1(cloInd);                                                                   
//#7745        tlin[0].x=inlin[0].x=pPnt.x;                                                                   
//#7746        tlin[0].y=inlin[0].y=pPnt.y;                                                                   
//#7747        stch2px1(cloInd+1);                                                                   
//#7748        tlin[1].x=inlin[2].x=pPnt.x;                                                                   
//#7749        tlin[1].y=inlin[2].y=pPnt.y;                                                                   
//#7750        xlin();                                                                   
//#7751        setMap(ILIN);                                                                   
//#7752        ilin();                                                                   
//#7753    }                                                                       
//#7754                                                                           
//#7755    void istch(){                                                                       
//#7756                                                                           
//#7757        double angb,angf,angt;                                                                   
//#7758                                                                           
//#7759        xlin();                                                                   
//#7760        xlin1();                                                                   
//#7761        if(chkMap(SELBOX)){                                                                   
//#7762                                                                           
//#7763            if(cloInd&&cloInd!=(unsigned)hed.stchs-1){                                                               
//#7764                                                                           
//#7765                px2stch();                                                           
//#7766                angt=atan2(stchs[cloInd].y-sPnt.y,stchs[cloInd].x-sPnt.x);                                                           
//#7767                angb=atan2(stchs[cloInd].y-stchs[cloInd-1].y,stchs[cloInd].x-stchs[cloInd-1].x);                                                           
//#7768                angf=atan2(stchs[cloInd].y-stchs[cloInd+1].y,stchs[cloInd].x-stchs[cloInd+1].x);                                                           
//#7769                if(fabs(angf-angt)>fabs(angb-angt))                                                           
//#7770                    cloInd--;                                                       
//#7771            }                                                               
//#7772            else{                                                               
//#7773                                                                           
//#7774                if(cloInd==(unsigned)hed.stchs-1)                                                           
//#7775                    cloInd--;                                                       
//#7776            }                                                               
//#7777        }                                                                   
//#7778        else                                                                   
//#7779            cloInd=closlin();                                                               
//#7780        if(cloInd==-1)                                                                   
//#7781            rstMap(INSRT);                                                               
//#7782        else{                                                                   
//#7783                                                                           
//#7784            setMap(INSRT);                                                               
//#7785            duIns();                                                               
//#7786            SetCapture(hWnd);                                                               
//#7787            ritnum(STR_NUMSEL,cloInd);                                                               
//#7788            nuAct(cloInd);                                                               
//#7789        }                                                                   
//#7790    }                                                                       
//#7791                                                                           
//#7792    void cros(unsigned ind){                                                                       
//#7793                                                                           
//#7794        long pwid=boxOff[0];                                                                   
//#7795                                                                           
//#7796        stch2px1(ind);                                                                   
//#7797        inlin[0].x=pPnt.x-pwid;                                                                   
//#7798        inlin[1].y=inlin[0].y=pPnt.y;                                                                   
//#7799        inlin[1].x=pPnt.x+pwid;                                                                   
//#7800        SelectObject(rsdc,xPen);                                                                   
//#7801        SetROP2(rsdc, R2_NOTXORPEN);                                                                   
//#7802        Polyline(rsdc,inlin,2);                                                                   
//#7803        SelectObject(sdc,xPen);                                                                   
//#7804        SetROP2(sdc, R2_NOTXORPEN);                                                                   
//#7805        Polyline(sdc,inlin,2);                                                                   
//#7806        inlin[0].y=pPnt.y-pwid;                                                                   
//#7807        inlin[0].x=inlin[1].x=pPnt.x;                                                                   
//#7808        inlin[1].y=pPnt.y-1;                                                                   
//#7809        Polyline(rsdc,inlin,2);                                                                   
//#7810        Polyline(sdc,inlin,2);                                                                   
//#7811        inlin[0].y=pPnt.y+2;                                                                   
//#7812        inlin[1].y=pPnt.y+pwid;                                                                   
//#7813        Polyline(rsdc,inlin,2);                                                                   
//#7814        SetROP2(rsdc,R2_COPYPEN);                                                                   
//#7815        Polyline(sdc,inlin,2);                                                                   
//#7816        SetROP2(sdc,R2_COPYPEN);                                                                   
//#7817    }                                                                       
//#7818                                                                           
//#7819    void mark(){                                                                       
//#7820                                                                           
//#7821        if(chkMap(SELBOX)||chkMap(INSRT)||closPnt1(&cloInd)){                                                                   
//#7822                                                                           
//#7823            unbox();                                                               
//#7824            xlin();                                                               
//#7825            rstMap(CAPT);                                                               
//#7826            rstMap(SELBOX);                                                               
//#7827            rstMap(INSRT);                                                               
//#7828            rstMap(SCROS);                                                               
//#7829            rstMap(ECROS);                                                               
//#7830            grpInd=cloInd;                                                               
//#7831            setMap(GRPSEL);                                                               
//#7832        }                                                                   
//#7833    }                                                                       
//#7834                                                                           
//#7835    void selCol()                                                                       
//#7836    {                                                                       
//#7837        unsigned ind,col;                                                                   
//#7838                                                                           
//#7839        if(hed.stchs)                                                                   
//#7840        {                                                                   
//#7841            if(chkMap(SELBOX))                                                               
//#7842                ind=cloInd;                                                           
//#7843            else                                                               
//#7844            {                                                               
//#7845                if(chkMap(GRPSEL))                                                           
//#7846                    ind=grpInd;                                                       
//#7847                else                                                           
//#7848                    ind=0;                                                       
//#7849            }                                                               
//#7850            if(ind>(unsigned)hed.stchs-1)                                                               
//#7851                ind=hed.stchs-1;                                                           
//#7852            cloInd=grpInd=ind;                                                               
//#7853            col=stchs[ind].at&COLMSK;                                                               
//#7854            while(cloInd&&(stchs[cloInd].at&COLMSK)==col)                                                               
//#7855                cloInd--;                                                           
//#7856            if((stchs[cloInd].at&COLMSK)!=col)                                                               
//#7857                cloInd++;                                                           
//#7858            while(grpInd<hed.stchs&&(stchs[grpInd].at&COLMSK)==col)                                                               
//#7859                grpInd++;                                                           
//#7860            if((stchs[cloInd].at&COLMSK)!=col)                                                               
//#7861                cloInd--;                                                           
//#7862            if(grpInd>(unsigned)hed.stchs-1)                                                               
//#7863                grpInd=hed.stchs-1;                                                           
//#7864            setMap(GRPSEL);                                                               
//#7865            unbox();                                                               
//#7866            grpAdj();                                                               
//#7867            actcol=col;                                                               
//#7868            setMap(RESTCH);                                                               
//#7869        }                                                                   
//#7870    }                                                                       
//#7871                                                                           
//#7872    void nuAct(unsigned ind){                                                                       
//#7873                                                                           
//#7874        unsigned tcol;                                                                   
//#7875                                                                           
//#7876        tcol=actcol;                                                                   
//#7877        actcol=stchs[ind].at&COLMSK;                                                                   
//#7878        redraw(hCol[tcol]);                                                                   
//#7879        redraw(hCol[actcol]);                                                                   
//#7880    }                                                                       
//#7881                                                                           
//#7882    void newFil(){                                                                       
//#7883                                                                           
//#7884        unsigned ind;                                                                   
//#7885                                                                           
//#7886        rstMap(CMPDO);                                                                   
//#7887        if(bnam[0]){                                                                   
//#7888                                                                           
//#7889            bnam[0]=0;                                                               
//#7890            DeleteObject(hBmp);                                                               
//#7891            ReleaseDC(hWnd,bitdc);                                                               
//#7892        }                                                                   
//#7893        sprintf(msgbuf,stab[STR_THRED],ini.desnam);                                                                   
//#7894        deldu();                                                                   
//#7895        SetWindowText(hWnd,msgbuf);                                                                   
//#7896        strcpy(thrnam,stab[STR_NUFIL]);                                                                   
//#7897        ritfnam(ini.desnam);                                                                   
//#7898        strcpy(hedx.modnam,ini.desnam);                                                                   
//#7899        rstdu();                                                                   
//#7900        rstAll();                                                                   
//#7901        clrhbut(3);                                                                   
//#7902        rstMap(MOVSET);                                                                   
//#7903        hed.ledIn=0x32;                                                                   
//#7904        hed.fColCnt=16;                                                                   
//#7905        unbox();                                                                   
//#7906        xlin();                                                                   
//#7907        xlin1();                                                                   
//#7908        rstMap(INIT);                                                                   
//#7909        rstMap(INSRT);                                                                   
//#7910        rstMap(LIN1);                                                                   
//#7911        rstMap(FORMSEL);                                                                   
//#7912        rstMap(BAKACT);                                                                   
//#7913        rstMap(GMRK);                                                                   
//#7914        hed.stchs=0;                                                                   
//#7915        cbit=0;                                                                   
//#7916        bnam[0]=0;                                                                   
//#7917        hed.stchs=0;                                                                   
//#7918        fltad=0;                                                                   
//#7919        clpad=0;                                                                   
//#7920        txad=0;                                                                   
//#7921        satkad=0;                                                                   
//#7922        formpnt=0;                                                                   
//#7923        filnam[0]=0;                                                                   
//#7924        colCnt=0;                                                                   
//#7925        knotcnt=0;                                                                   
//#7926        for(ind=0;ind<16;ind++){                                                                   
//#7927                                                                           
//#7928            redraw(hDef[ind]);                                                               
//#7929            redraw(hCol[ind]);                                                               
//#7930            redraw(hSiz[ind]);                                                               
//#7931        }                                                                   
//#7932        zumhom();                                                                   
//#7933    }                                                                       
//#7934                                                                           
//#7935    void bBox(){                                                                       
//#7936                                                                           
//#7937        SetROP2(rsdc, R2_NOTXORPEN);                                                                   
//#7938        SelectObject(rsdc,lPen);                                                                   
//#7939        Polyline(rsdc,blin,5);                                                                   
//#7940        SetROP2(rsdc,R2_COPYPEN);                                                                   
//#7941    }                                                                       
//#7942                                                                           
//#7943    void unbBox(){                                                                       
//#7944                                                                           
//#7945        if(rstMap(BZUM))                                                                   
//#7946            bBox();                                                               
//#7947    }                                                                       
//#7948                                                                           
//#7949    void rebox(){                                                                       
//#7950                                                                           
//#7951        unsigned ind;                                                                   
//#7952                                                                           
//#7953        unbox();                                                                   
//#7954        if(closPnt1(&cloInd)){                                                                   
//#7955                                                                           
//#7956            nuAct(cloInd);                                                               
//#7957            if(stch2px(cloInd))                                                               
//#7958                dubox();                                                           
//#7959            if(rstMap(GRPSEL)){                                                               
//#7960                                                                           
//#7961                rstMap(SCROS);                                                           
//#7962                rstMap(ECROS);                                                           
//#7963                slpnt=0;                                                           
//#7964                setMap(RESTCH);                                                           
//#7965                for(ind=0;ind<16;ind++)                                                           
//#7966                    redraw(hCol[ind]);                                                       
//#7967            }                                                               
//#7968            ritcor(&stchs[cloInd]);                                                               
//#7969        }                                                                   
//#7970    }                                                                       
//#7971                                                                           
//#7972    void endpnt(){                                                                       
//#7973                                                                           
//#7974        unbox();                                                                   
//#7975        xlin();                                                                   
//#7976        xlin1();                                                                   
//#7977        setMap(LIN1);                                                                   
//#7978        setMap(INSRT);                                                                   
//#7979        rstMap(GRPSEL);                                                                   
//#7980        inlin[0].x=pPnt.x;                                                                   
//#7981        inlin[0].y=pPnt.y;                                                                   
//#7982        inlin[1].x=msg.pt.x-stOrg.x;                                                                   
//#7983        inlin[1].y=msg.pt.y-stOrg.y;                                                                   
//#7984    }                                                                       
//#7985                                                                           
//#7986    void delstchm(){                                                                       
//#7987                                                                           
//#7988        unsigned ind,dst;                                                                   
//#7989                                                                           
//#7990        rngadj();                                                                   
//#7991        dst=gpnt0;                                                                   
//#7992        for(ind=gpnt1;ind<hed.stchs;ind++){                                                                   
//#7993                                                                           
//#7994            stchs[dst].at=stchs[ind].at;                                                               
//#7995            stchs[dst].x=stchs[ind].x;                                                               
//#7996            stchs[dst++].y=stchs[ind].y;                                                               
//#7997        }                                                                   
//#7998        hed.stchs=dst-1;                                                                   
//#7999    }                                                                       
//#8000                                                                           
//#8001    void unsid(){                                                                       
//#8002                                                                           
//#8003        sidtyp=0;                                                                   
//#8004        if(hSid){                                                                   
//#8005                                                                           
//#8006            DestroyWindow(hSid);                                                               
//#8007            hSid=0;                                                               
//#8008        }                                                                   
//#8009    }                                                                       
//#8010                                                                           
//#8011    void unbsho(){                                                                       
//#8012                                                                           
//#8013        unsigned ind;                                                                   
//#8014                                                                           
//#8015        if(rstMap(BAKSHO)){                                                                   
//#8016                                                                           
//#8017            for(ind=0;ind<OLDVER;ind++)                                                               
//#8018                DestroyWindow(hvu[ind]);                                                           
//#8019        }                                                                   
//#8020    }                                                                       
//#8021                                                                           
//#8022    BOOL oldwnd(HWND hwnd){                                                                       
//#8023                                                                           
//#8024        unsigned ind;                                                                   
//#8025                                                                           
//#8026        for(ind=0;ind<16;ind++){                                                                   
//#8027                                                                           
//#8028            if(hDef[ind]==hwnd||hCol[ind]==hwnd||hSiz[ind]==hwnd)                                                               
//#8029                return 0;                                                           
//#8030        }                                                                   
//#8031        for(ind=0;ind<9;ind++){                                                                   
//#8032                                                                           
//#8033            if(hbuts[ind]==hwnd)                                                               
//#8034                return 0;                                                           
//#8035        }                                                                   
//#8036        if(hStch==hwnd)                                                                   
//#8037            return 0;                                                               
//#8038        if(hVrt==hwnd)                                                                   
//#8039            return 0;                                                               
//#8040        if(hHor==hwnd)                                                                   
//#8041            return 0;                                                               
//#8042        if(hBar==hwnd)                                                                   
//#8043            return 0;                                                               
//#8044        if(hmin==hwnd)                                                                   
//#8045            return 0;                                                               
//#8046        if(hSped==hwnd)                                                                   
//#8047            return 0;                                                               
//#8048        return 1;                                                                   
//#8049    }                                                                       
//#8050                                                                           
//#8051    BOOL CALLBACK EnumChildProc(HWND hwnd,LPARAM lParam){                                                                       
//#8052                                                                           
//#8053        if(oldwnd(hwnd))                                                                   
//#8054            return DestroyWindow(hwnd);                                                               
//#8055        else{                                                                   
//#8056                                                                           
//#8057            if(fwnd){                                                               
//#8058                                                                           
//#8059                if(fwnd==hwnd)                                                           
//#8060                    return 0;                                                       
//#8061                else                                                           
//#8062                    return TRUE;                                                       
//#8063            }                                                               
//#8064            else{                                                               
//#8065                                                                           
//#8066                fwnd=hwnd;                                                           
//#8067                return TRUE;                                                           
//#8068            }                                                               
//#8069        }                                                                   
//#8070    }                                                                       
//#8071                                                                           
//#8072    void insadj(){                                                                       
//#8073                                                                           
//#8074        rstMap(PRELIN);                                                                   
//#8075        fvars(clofind);                                                                   
//#8076        refil();                                                                   
//#8077        coltab();                                                                   
//#8078        frmout(clofind);                                                                   
//#8079    }                                                                       
//#8080                                                                           
//#8081    void rstAll(){                                                                       
//#8082                                                                           
//#8083        rstMap(WASFPNT);                                                                   
//#8084        rstMap(WASFRMFRM);                                                                   
//#8085        rstMap(FPUNCLP);                                                                   
//#8086        rstMap(FPSEL);                                                                   
//#8087        rstMap(CAPT);                                                                   
//#8088        rstMap(INSRT);                                                                   
//#8089        rstMap(SELBOX);                                                                   
//#8090        rstMap(GRPSEL);                                                                   
//#8091        rstMap(SCROS);                                                                   
//#8092        rstMap(ECROS);                                                                   
//#8093        rstMap(LIN1);                                                                   
//#8094        rstMap(CLPSHO);                                                                   
//#8095        rstMap(SELPNT);                                                                   
//#8096        rstMap(ROTAT);                                                                   
//#8097        rstMap(ROTCAPT);                                                                   
//#8098        rstMap(FRMPMOV);                                                                   
//#8099        rstMap(MOVFRM);                                                                   
//#8100        rstMap(SATCNKT);                                                                   
//#8101        rstMap(FRMPSEL);                                                                   
//#8102        rstMap(SHOINSF);                                                                   
//#8103        rstMap(STRTCH);                                                                   
//#8104        rstMap(SHOSTRTCH);                                                                   
//#8105        rstMap(EXPAND);                                                                   
//#8106        rstMap(POLIMOV);                                                                   
//#8107        rstMap(BZUMIN);                                                                   
//#8108        rstMap(OSAV);                                                                   
//#8109        rstMap(SAVEX);                                                                   
//#8110        rstMap(MOVFRMS);                                                                   
//#8111        rstMap(FRMROT);                                                                   
//#8112        rstMap(DELSFRMS);                                                                   
//#8113        rstMap(BIGBOX);                                                                   
//#8114        rstMap(UPTO);                                                                   
//#8115        rstMap(LENSRCH);                                                                   
//#8116        rstMap(WASGRP);                                                                   
//#8117        rstMap(BOXZUM);                                                                   
//#8118        rstMap(HIDSTCH);                                                                   
//#8119        rstMap(ENTRPOL);                                                                   
//#8120        rstMap(ENTRSTAR);                                                                   
//#8121        rstMap(ENTRSPIR);                                                                   
//#8122        rstMap(ENTRHART);                                                                   
//#8123        rstMap(FORMIN);                                                                   
//#8124        rstMap(GTUANG);                                                                   
//#8125        rstMap(GTUSPAC);                                                                   
//#8126        rstMap(GTWLKIND);                                                                   
//#8127        rstMap(GTWLKLEN);                                                                   
//#8128        untrace();                                                                   
//#8129        rstMap(WASEDG);                                                                   
//#8130        butxt(HUPTO,stab[STR_UPOF]);                                                                   
//#8131        if(zumFct==1)                                                                   
//#8132            rstMap(ZUMED);                                                               
//#8133        movStch();                                                                   
//#8134        ShowWindow(hStch,TRUE);                                                                   
//#8135        unbsho();                                                                   
//#8136        rstMap(SIDACT);                                                                   
//#8137        unsid();                                                                   
//#8138        rstMap(PRFACT);                                                                   
//#8139        rstMap(WASRT);                                                                   
//#8140        DestroyWindow(hPrf);                                                                   
//#8141        undat();                                                                   
//#8142        if(rstMap(INSFRM))                                                                   
//#8143            insadj();                                                               
//#8144        rstMap(FUNCLP);                                                                   
//#8145        if(rstMap(SATPNT))                                                                   
//#8146            satfix();                                                               
//#8147        if(rstMap(RUNPAT))                                                                   
//#8148            patdun();                                                               
//#8149        rstMap(FORMSEL);                                                                   
//#8150        rstMap(FRMPSEL);                                                                   
//#8151        unmsg();                                                                   
//#8152        slpnt=fselpnt=0;                                                                   
//#8153        fwnd=0;                                                                   
//#8154        while(EnumChildWindows(hStch,EnumChildProc,0));                                                                   
//#8155    }                                                                       
//#8156                                                                           
//#8157    void rstdu(){                                                                       
//#8158                                                                           
//#8159        deldu();                                                                   
//#8160        rstMap(REDUSHO);                                                                   
//#8161        rstMap(UNDUSHO);                                                                   
//#8162        EnableMenuItem(hMen,M_UNDO,MF_BYPOSITION|MF_GRAYED);                                                                   
//#8163        EnableMenuItem(hMen,M_REDO,MF_BYPOSITION|MF_GRAYED);                                                                   
//#8164        setMap(DUMEN);                                                                   
//#8165    }                                                                       
//#8166                                                                           
//#8167    CLPSTCH* deref(void* pnt){                                                                       
//#8168                                                                           
//#8169        _asm{                                                                   
//#8170                                                                           
//#8171                mov        eax,pnt                                                   
//#8172                mov        eax,[eax]                                                   
//#8173        }                                                                   
//#8174    }                                                                       
//#8175                                                                           
//#8176    void duclp(){                                                                       
//#8177                                                                           
//#8178        SetROP2(rsdc,R2_NOTXORPEN);                                                                   
//#8179        SelectObject(rsdc,lPen);                                                                   
//#8180        Polyline(rsdc,clplin,5);                                                                   
//#8181        SetROP2(rsdc,R2_COPYPEN);                                                                   
//#8182    }                                                                       
//#8183                                                                           
//#8184    void unclp(){                                                                       
//#8185                                                                           
//#8186        if(rstMap(CLPSHO))                                                                   
//#8187            duclp();                                                               
//#8188    }                                                                       
//#8189                                                                           
//#8190    void dusel(HDC dc){                                                                       
//#8191                                                                           
//#8192        unsigned ind;                                                                   
//#8193                                                                           
//#8194        SetROP2(dc,R2_NOTXORPEN);                                                                   
//#8195        SelectObject(dc,lPen);                                                                   
//#8196        Polyline(dc,rctlin,9);                                                                   
//#8197        for(ind=0;ind<8;ind++)                                                                   
//#8198            selsqr(rctlin[ind],dc);                                                               
//#8199        SetROP2(dc,R2_COPYPEN);                                                                   
//#8200    }                                                                       
//#8201                                                                           
//#8202    void unsel(){                                                                       
//#8203                                                                           
//#8204        if(rstMap(SELSHO))                                                                   
//#8205            dusel(rsdc);                                                               
//#8206    }                                                                       
//#8207                                                                           
//#8208    void clpbox(){                                                                       
//#8209                                                                           
//#8210        SIZE    clpx;                                                               
//#8211        double    tdub;                                                               
//#8212                                                                           
//#8213        px2stch();                                                                   
//#8214        if(sPnt.x+clpsiz.cx>zum0.x)                                                                   
//#8215            sPnt.x=zum0.x-clpsiz.cx;                                                               
//#8216        if(sPnt.y+clpsiz.cy>zum0.y)                                                                   
//#8217            sPnt.y=zum0.y-clpsiz.cy;                                                               
//#8218        clporg.x=sPnt.x;                                                                   
//#8219        clporg.y=sPnt.y;                                                                   
//#8220        tdub=(double)scRct.right/(zRct.right-zRct.left);                                                                   
//#8221        clpx.cx=clpsiz.cx*tdub+0.5;                                                                   
//#8222        clpx.cy=clpsiz.cy*tdub+0.5;                                                                   
//#8223    #pragma warning(disable:4244;once:)                                                                       
//#8224        pPnt.x=(sPnt.x-zRct.left)*tdub+0.5;                                                                   
//#8225    #pragma warning(disable:4244;once:)                                                                       
//#8226        pPnt.y=scRct.bottom-(sPnt.y-zRct.bottom)*tdub+0.5-clpx.cy;                                                                   
//#8227        clplin[0].x=clplin[3].x=clplin[4].x=pPnt.x;                                                                   
//#8228        clplin[0].y=clplin[1].y=clplin[4].y=pPnt.y;                                                                   
//#8229        clplin[1].x=clplin[2].x=clplin[0].x+clpx.cx;                                                                   
//#8230        clplin[2].y=clplin[3].y=clplin[0].y+clpx.cy;                                                                   
//#8231        setMap(CLPSHO);                                                                   
//#8232        duclp();                                                                   
//#8233    }                                                                       
//#8234                                                                           
//#8235    void lodclp(unsigned ind){                                                                       
//#8236                                                                           
//#8237        FLPNT        padj;                                                           
//#8238        unsigned    src,dst;                                                               
//#8239                                                                           
//#8240        if(ind!=hed.stchs)                                                                   
//#8241            ind++;                                                               
//#8242        padj.x=clporg.x-clprct.left;                                                                   
//#8243        padj.y=clporg.y-clprct.bottom;                                                                   
//#8244        if(ind<(unsigned)hed.stchs&&chkMap(INIT)){                                                                   
//#8245                                                                           
//#8246            src=hed.stchs-1;                                                               
//#8247            dst=hed.stchs+clplen-1;                                                               
//#8248            while(src>=ind){                                                               
//#8249                                                                           
//#8250                stchs[dst].x=stchs[src].x;                                                           
//#8251                stchs[dst].y=stchs[src--].y;                                                           
//#8252                stchs[dst--].at=stchs[src].at;                                                           
//#8253            }                                                               
//#8254        }                                                                   
//#8255        cloInd=ind;                                                                   
//#8256        for(src=0;src<clplen;src++){                                                                   
//#8257                                                                           
//#8258            stchs[ind].x=clpnu[src].x+padj.x;                                                               
//#8259            stchs[ind].y=clpnu[src].y+padj.y;                                                               
//#8260            stchs[ind++].at=clpnu[src].at&COLMSK|laycod|NOTFRM;                                                               
//#8261        }                                                                   
//#8262        grpInd=ind-1;                                                                   
//#8263        setMap(GRPSEL);                                                                   
//#8264        hed.stchs+=clplen;                                                                   
//#8265        if(hed.stchs)                                                                   
//#8266            setMap(INIT);                                                               
//#8267    }                                                                       
//#8268                                                                           
//#8269    void rSelbox(){                                                                       
//#8270                                                                           
//#8271        SIZE    selx;                                                               
//#8272        double    tdub;                                                               
//#8273                                                                           
//#8274        unsel();                                                                   
//#8275        px2stch();                                                                   
//#8276        if(sPnt.x-selof.x+selsiz.cx>=zum0.x)                                                                   
//#8277            sPnt.x=zum0.x-selsiz.cx+selof.x;                                                               
//#8278        if(sPnt.y-selof.y+selsiz.cy>=zum0.y)                                                                   
//#8279            sPnt.y=zum0.y-selsiz.cy+selof.y;                                                               
//#8280        if(sPnt.x-selof.x<0)                                                                   
//#8281            sPnt.x=selof.x;                                                               
//#8282        if(sPnt.y-selof.y<0)                                                                   
//#8283            sPnt.y=selof.y;                                                               
//#8284        tdub=(double)scRct.right/(zRct.right-zRct.left);                                                                   
//#8285        selx.cx=selsiz.cx*tdub+0.5;                                                                   
//#8286        selx.cy=selsiz.cy*tdub+0.5;                                                                   
//#8287    #pragma warning(disable:4244;once:)                                                                       
//#8288        pPnt.x=(sPnt.x-zRct.left-selof.x)*tdub+0.5;                                                                   
//#8289    #pragma warning(disable:4244;once:)                                                                       
//#8290        pPnt.y=scRct.bottom-(sPnt.y-zRct.bottom-selof.y)*tdub+0.5-selx.cy;                                                                   
//#8291        rctlin[0].x=rctlin[6].x=rctlin[7].x=rctlin[8].x=pPnt.x;                                                                   
//#8292        rctlin[1].x=rctlin[5].x=pPnt.x+selx.cx/2;                                                                   
//#8293        rctlin[0].y=rctlin[1].y=rctlin[2].y=rctlin[8].y=pPnt.y;                                                                   
//#8294        rctlin[3].y=rctlin[7].y=pPnt.y+selx.cy/2;                                                                   
//#8295        rctlin[4].y=rctlin[5].y=rctlin[6].y=pPnt.y+selx.cy;                                                                   
//#8296        rctlin[2].x=rctlin[3].x=rctlin[4].x=pPnt.x+selx.cx;                                                                   
//#8297        setMap(SELSHO);                                                                   
//#8298        dusel(rsdc);                                                                   
//#8299    }                                                                       
//#8300                                                                           
//#8301    void duSelbox(){                                                                       
//#8302                                                                           
//#8303        px2stch();                                                                   
//#8304        selsiz.cx=rngrct.right-rngrct.left;                                                                   
//#8305        selsiz.cy=rngrct.top-rngrct.bottom;                                                                   
//#8306        selof.x=sPnt.x-rngrct.left;                                                                   
//#8307        selof.y=sPnt.y-rngrct.bottom;                                                                   
//#8308    }                                                                       
//#8309                                                                           
//#8310    void setbak(unsigned wid){                                                                       
//#8311                                                                           
//#8312        if(bakwid!=wid)                                                                   
//#8313            bakPen=nuPen(bakPen,wid,stchBak);                                                               
//#8314    }                                                                       
//#8315                                                                           
//#8316    void stchbox(unsigned ind,HDC dc){                                                                       
//#8317                                                                           
//#8318        POINT        stlin[5];                                                           
//#8319        unsigned    layr;                                                               
//#8320                                                                           
//#8321        layr=(stchs[ind].at&LAYMSK)>>LAYSHFT;                                                                   
//#8322        if(!actl||!layr||layr==actl){                                                                   
//#8323                                                                           
//#8324            stch2px1(ind);                                                               
//#8325            stlin[0].x=stlin[3].x=stlin[4].x=pPnt.x-ini.stchpix;                                                               
//#8326            stlin[0].y=stlin[1].y=pPnt.y-ini.stchpix;                                                               
//#8327            stlin[1].x=stlin[2].x=pPnt.x+ini.stchpix;                                                               
//#8328            stlin[2].y=stlin[3].y=pPnt.y+ini.stchpix;                                                               
//#8329            stlin[4].y=pPnt.y-ini.stchpix;                                                               
//#8330            Polyline(dc,stlin,5);                                                               
//#8331        }                                                                   
//#8332    }                                                                       
//#8333                                                                           
//#8334    void sCor2px(DUBPNT stpnt,POINT* pxpnt){                                                                       
//#8335                                                                           
//#8336    #pragma warning(disable:4244;once:)                                                                       
//#8337        pxpnt->x=(stpnt.x-zRct.left)*zrat.x+0.5;                                                                   
//#8338    #pragma warning(disable:4244;once:)                                                                       
//#8339        pxpnt->y=scRct.bottom+(zRct.bottom-stpnt.y)*zrat.y+0.5;                                                                   
//#8340    }                                                                       
//#8341                                                                           
//#8342    void sdCor2px(SHRTPNT stpnt,POINT* pxpnt){                                                                       
//#8343                                                                           
//#8344    #pragma warning(disable:4244;once:)                                                                       
//#8345        pxpnt->x=(stpnt.x-zRct.left)*zrat.x+0.5;                                                                   
//#8346    #pragma warning(disable:4244;once:)                                                                       
//#8347        pxpnt->y=scRct.bottom+(zRct.bottom-stpnt.y)*zrat.y+0.5;                                                                   
//#8348    }                                                                       
//#8349                                                                           
//#8350    void durot(){                                                                       
//#8351                                                                           
//#8352        SetROP2(rsdc,R2_NOTXORPEN);                                                                   
//#8353        SelectObject(rsdc,lPen);                                                                   
//#8354        Polyline(rsdc,rlinb,5);                                                                   
//#8355        Polyline(rsdc,rlinv,2);                                                                   
//#8356        Polyline(rsdc,rlinh,2);                                                                   
//#8357        SetROP2(rsdc,R2_COPYPEN);                                                                   
//#8358    }                                                                       
//#8359                                                                           
//#8360    void unrot(){                                                                       
//#8361                                                                           
//#8362        if(rstMap(ROTSHO))                                                                   
//#8363            durot();                                                               
//#8364    }                                                                       
//#8365                                                                           
//#8366    void durotu(){                                                                       
//#8367                                                                           
//#8368        SetROP2(rsdc, R2_NOTXORPEN);                                                                   
//#8369        SelectObject(rsdc,lPen);                                                                   
//#8370        Polyline(rsdc,rlinu,2);                                                                   
//#8371        SetROP2(rsdc,R2_COPYPEN);                                                                   
//#8372    }                                                                       
//#8373                                                                           
//#8374    void unrotu(){                                                                       
//#8375                                                                           
//#8376        if(rstMap(ROTUSHO))                                                                   
//#8377            durotu();                                                               
//#8378    }                                                                       
//#8379                                                                           
//#8380    void rotang(DUBPNT rpnt,POINT* tpnt){                                                                       
//#8381                                                                           
//#8382        double    len,ang0;                                                               
//#8383        DUBPNT    ipnt;                                                               
//#8384        long    dx,dy;                                                               
//#8385                                                                           
//#8386        dx=rpnt.x-rotcntr.x;                                                                   
//#8387        dy=rpnt.y-rotcntr.y;                                                                   
//#8388        if(dx){                                                                   
//#8389                                                                           
//#8390            len=hypot(dx,dy);                                                               
//#8391    //        ang0=atan2(dy,dx);                                                               
//#8392            ang0 = atan2((double)dy, (double)dx); // xiaoguang                                                               
//#8393            ang0+=ang;                                                               
//#8394        }                                                                   
//#8395        else{                                                                   
//#8396                                                                           
//#8397            len=abs(dy);                                                               
//#8398            if(dy>0)                                                               
//#8399                ang0=PI/2+ang;                                                           
//#8400            else                                                               
//#8401                ang0=ang-PI/2;                                                           
//#8402        }                                                                   
//#8403        ipnt.y=rotcntr.y+len*sin(ang0);                                                                   
//#8404        ipnt.x=rotcntr.x+len*cos(ang0);                                                                   
//#8405        sCor2px(ipnt,tpnt);                                                                   
//#8406    }                                                                       
//#8407                                                                           
//#8408    void rotang1(SHRTPNT rpnt,FLPNT* tpnt){                                                                       
//#8409                                                                           
//#8410        double    len,ang0;                                                               
//#8411        double    dx,dy;                                                               
//#8412                                                                           
//#8413        dx=rpnt.x-rotcntr.x;                                                                   
//#8414        dy=rpnt.y-rotcntr.y;                                                                   
//#8415        if(dx){                                                                   
//#8416                                                                           
//#8417            len=hypot(dx,dy);                                                               
//#8418            ang0=atan2(dy,dx);                                                               
//#8419            ang0+=ang;                                                               
//#8420        }                                                                   
//#8421        else{                                                                   
//#8422                                                                           
//#8423            len=abs(dy);                                                               
//#8424            if(dy>0)                                                               
//#8425                ang0=PI/2+ang;                                                           
//#8426            else                                                               
//#8427                ang0=ang-PI/2;                                                           
//#8428        }                                                                   
//#8429        tpnt->y=rotcntr.y+len*sin(ang0);                                                                   
//#8430        tpnt->x=rotcntr.x+len*cos(ang0);                                                                   
//#8431    }                                                                       
//#8432                                                                           
//#8433    void rotangf(FLPNT rpnt,FLPNT* tpnt){                                                                       
//#8434                                                                           
//#8435        double    len,ang0;                                                               
//#8436        double    dx,dy;                                                               
//#8437                                                                           
//#8438        dx=rpnt.x-rotcntr.x;                                                                   
//#8439        dy=rpnt.y-rotcntr.y;                                                                   
//#8440        if(dx){                                                                   
//#8441                                                                           
//#8442            len=hypot(dx,dy);                                                               
//#8443            ang0=atan2(dy,dx);                                                               
//#8444            ang0+=ang;                                                               
//#8445        }                                                                   
//#8446        else{                                                                   
//#8447                                                                           
//#8448            len=abs(dy);                                                               
//#8449            if(dy>0)                                                               
//#8450                ang0=PI/2+ang;                                                           
//#8451            else                                                               
//#8452                ang0=ang-PI/2;                                                           
//#8453        }                                                                   
//#8454        tpnt->y=rotcntr.y+len*sin(ang0);                                                                   
//#8455        tpnt->x=rotcntr.x+len*cos(ang0);                                                                   
//#8456    }                                                                       
//#8457                                                                           
//#8458    void rotpix(POINT rpnt,POINT* tpnt){                                                                       
//#8459                                                                           
//#8460        //won't handle vertical lines                                                                   
//#8461        double    len,ang0;                                                               
//#8462        long    dx,dy;                                                               
//#8463                                                                           
//#8464        dx=rpnt.x-pixcntr.x;                                                                   
//#8465        dy=rpnt.y-pixcntr.y;                                                                   
//#8466        len=hypot(dx,dy);                                                                   
//#8467    //    ang0=atan2(dy,dx);                                                                   
//#8468        ang0 = atan2((double)dy, (double)dx); // xiaoguang                                                                   
//#8469        ang0-=pixang;                                                                   
//#8470        tpnt->y=pixcntr.y+len*sin(ang0);                                                                   
//#8471        tpnt->x=pixcntr.x+len*cos(ang0);                                                                   
//#8472    }                                                                       
//#8473                                                                           
//#8474    void rotflt(FLPNT* pnt){                                                                       
//#8475                                                                           
//#8476        double    len,ang0;                                                               
//#8477        double    dx,dy;                                                               
//#8478                                                                           
//#8479        dx=pnt->x-rotcntr.x;                                                                   
//#8480        dy=pnt->y-rotcntr.y;                                                                   
//#8481        if(dx){                                                                   
//#8482                                                                           
//#8483            len=hypot(dx,dy);                                                               
//#8484            ang0=atan2(dy,dx);                                                               
//#8485            ang0+=ang;                                                               
//#8486        }                                                                   
//#8487        else{                                                                   
//#8488                                                                           
//#8489            len=abs(dy);                                                               
//#8490            if(dy>0)                                                               
//#8491                ang0=PI/2+ang;                                                           
//#8492            else                                                               
//#8493                ang0=ang-PI/2;                                                           
//#8494        }                                                                   
//#8495        pnt->y=rotcntr.y+len*sin(ang0);                                                                   
//#8496        pnt->x=rotcntr.x+len*cos(ang0);                                                                   
//#8497    }                                                                       
//#8498                                                                           
//#8499    void rotstch(SHRTPNT* pnt){                                                                       
//#8500                                                                           
//#8501        double    len,ang0;                                                               
//#8502        double    dx,dy;                                                               
//#8503                                                                           
//#8504        dx=pnt->x-rotcntr.x;                                                                   
//#8505        dy=pnt->y-rotcntr.y;                                                                   
//#8506        if(dx){                                                                   
//#8507                                                                           
//#8508            len=hypot(dx,dy);                                                               
//#8509            ang0=atan2(dy,dx);                                                               
//#8510            ang0+=ang;                                                               
//#8511        }                                                                   
//#8512        else{                                                                   
//#8513                                                                           
//#8514            len=abs(dy);                                                               
//#8515            if(dy>0)                                                               
//#8516                ang0=PI/2+ang;                                                           
//#8517            else                                                               
//#8518                ang0=ang-PI/2;                                                           
//#8519        }                                                                   
//#8520        pnt->y=rotcntr.y+len*sin(ang0);                                                                   
//#8521        pnt->x=rotcntr.x+len*cos(ang0);                                                                   
//#8522    }                                                                       
//#8523                                                                           
//#8524    void ritrot(){                                                                       
//#8525                                                                           
//#8526        POINT        tpnt;                                                           
//#8527        DUBPNT        rotpnt;                                                           
//#8528                                                                           
//#8529        rotpnt.x=rotrct.left;                                                                   
//#8530        rotpnt.y=rotrct.top;                                                                   
//#8531        rotang(rotpnt,&tpnt);                                                                   
//#8532        rlinb[0].x=rlinb[4].x=tpnt.x;                                                                   
//#8533        rlinb[0].y=rlinb[4].y=tpnt.y;                                                                   
//#8534        rotpnt.x=rotcntr.x;                                                                   
//#8535        rotang(rotpnt,&tpnt);                                                                   
//#8536        rlinv[0].x=tpnt.x;                                                                   
//#8537        rlinv[0].y=tpnt.y;                                                                   
//#8538        rotpnt.x=rotrct.right;                                                                   
//#8539        rotang(rotpnt,&tpnt);                                                                   
//#8540        rlinb[1].x=tpnt.x;                                                                   
//#8541        rlinb[1].y=tpnt.y;                                                                   
//#8542        rotpnt.y=rotcntr.y;                                                                   
//#8543        rotang(rotpnt,&tpnt);                                                                   
//#8544        rlinh[1].x=tpnt.x;                                                                   
//#8545        rlinh[1].y=tpnt.y;                                                                   
//#8546        rotpnt.y=rotrct.bottom;                                                                   
//#8547        rotang(rotpnt,&tpnt);                                                                   
//#8548        rlinb[2].x=tpnt.x;                                                                   
//#8549        rlinb[2].y=tpnt.y;                                                                   
//#8550        rotpnt.x=rotcntr.x;                                                                   
//#8551        rotang(rotpnt,&tpnt);                                                                   
//#8552        rlinv[1].x=tpnt.x;                                                                   
//#8553        rlinv[1].y=tpnt.y;                                                                   
//#8554        rotpnt.x=rotrct.left;                                                                   
//#8555        rotang(rotpnt,&tpnt);                                                                   
//#8556        rlinb[3].x=tpnt.x;                                                                   
//#8557        rlinb[3].y=tpnt.y;                                                                   
//#8558        rotpnt.y=rotcntr.y;                                                                   
//#8559        rotang(rotpnt,&tpnt);                                                                   
//#8560        rlinh[0].x=tpnt.x;                                                                   
//#8561        rlinh[0].y=tpnt.y;                                                                   
//#8562        sCor2px(rotcntr,&rlinu[0]);                                                                   
//#8563        setMap(ROTSHO);                                                                   
//#8564        durot();                                                                   
//#8565    }                                                                       
//#8566                                                                           
//#8567    void durcntr(){                                                                       
//#8568                                                                           
//#8569        rotcntr.x=midl(rotrct.right,rotrct.left);                                                                   
//#8570        rotcntr.y=midl(rotrct.top,rotrct.bottom);                                                                   
//#8571    }                                                                       
//#8572                                                                           
//#8573    void rot(){                                                                       
//#8574                                                                           
//#8575        if(chkMap(FPSEL)){                                                                   
//#8576                                                                           
//#8577            MoveMemory(&rotrct,&pselrct,sizeof(FLRCT));                                                               
//#8578            goto rotskp;                                                               
//#8579        }                                                                   
//#8580        if(chkMap(BIGBOX)){                                                                   
//#8581                                                                           
//#8582            MoveMemory(&rotrct,&rctal,sizeof(FLRCT));                                                               
//#8583            goto rotskp;                                                               
//#8584        }                                                                   
//#8585        if(fselpnt){                                                                   
//#8586                                                                           
//#8587            pxrct2stch(bigrct,&rotrct);                                                               
//#8588            setMap(FRMSROT);                                                               
//#8589            goto rotskp;                                                               
//#8590        }                                                                   
//#8591        if(chkMap(FORMSEL)){                                                                   
//#8592                                                                           
//#8593            fvars(clofind);                                                               
//#8594            setMap(FRMROT);                                                               
//#8595            MoveMemory(&rotrct,&frmpnt->rct,sizeof(FLRCT));                                                               
//#8596            goto rotskp;                                                               
//#8597        }                                                                   
//#8598        if(chkMap(GRPSEL)){                                                                   
//#8599                                                                           
//#8600            rngadj();                                                               
//#8601            selRct(&rotrct);                                                               
//#8602            goto rotskp;                                                               
//#8603        }                                                                   
//#8604        shoseln(IDS_FGRPF,IDS_ROT);                                                                   
//#8605        return;                                                                   
//#8606    rotskp:;                                                                       
//#8607        setMap(ROTAT);                                                                   
//#8608        durcntr();                                                                   
//#8609        ang=0;                                                                   
//#8610        ritrot();                                                                   
//#8611    }                                                                       
//#8612                                                                           
//#8613    /*                                                                       
//#8614        unsigned short    led;                                                               
//#8615        unsigned char    fx;                                                               
//#8616        unsigned short    x;                                                               
//#8617        unsigned char    spcx;                                                               
//#8618        unsigned char    fy;                                                               
//#8619        unsigned short    y;                                                               
//#8620        unsigned char    spcy;                                                               
//#8621        unsigned char    myst;                                                               
//#8622        unsigned char    typ;                                                               
//#8623                                                                           
//#8624      */                                                                       
//#8625    void savclp(unsigned dst,unsigned src){                                                                       
//#8626                                                                           
//#8627        double    frct,intg;                                                               
//#8628                                                                           
//#8629        clpdat[dst].led=stchs[src].at&COLMSK;                                                                   
//#8630        frct=modf((double)stchs[src].x-lolft.x,&intg);                                                                   
//#8631        clpdat[dst].fx=frct*256;                                                                   
//#8632        clpdat[dst].x=intg;                                                                   
//#8633        clpdat[dst].spcx=0;                                                                   
//#8634        frct=modf((double)stchs[src].y-lolft.y,&intg);                                                                   
//#8635        clpdat[dst].fy=frct*256;                                                                   
//#8636        clpdat[dst].y=intg;                                                                   
//#8637        clpdat[dst].spcy=0;                                                                   
//#8638        clpdat[dst].myst=1;                                                                   
//#8639        clpdat[dst].typ=0x14;                                                                   
//#8640    }                                                                       
//#8641                                                                           
//#8642    void rtclpfn(unsigned dst,unsigned src){                                                                       
//#8643                                                                           
//#8644        double    frct,intg;                                                               
//#8645                                                                           
//#8646        clpdat[dst].led=0;                                                                   
//#8647        frct=modf(clpnu[src].x-lolft.x,&intg);                                                                   
//#8648        clpdat[dst].fx=frct;                                                                   
//#8649        clpdat[dst].x=intg;                                                                   
//#8650        clpdat[dst].spcx=0;                                                                   
//#8651        frct=modf(clpnu[src].y-lolft.y,&intg);                                                                   
//#8652        clpdat[dst].fy=frct;                                                                   
//#8653        clpdat[dst].y=intg;                                                                   
//#8654        clpdat[dst].spcy=0;                                                                   
//#8655        clpdat[dst].myst=1;                                                                   
//#8656        clpdat[dst].typ=0x14;                                                                   
//#8657    }                                                                       
//#8658                                                                           
//#8659    FRMCLP* frmref(void* pnt){                                                                       
//#8660                                                                           
//#8661        _asm{                                                                   
//#8662                                                                           
//#8663                mov        eax,pnt                                                   
//#8664                mov        eax,[eax]                                                   
//#8665        }                                                                   
//#8666    }                                                                       
//#8667                                                                           
//#8668    FRMSCLP* frmsref(void* pnt){                                                                       
//#8669                                                                           
//#8670        _asm{                                                                   
//#8671                                                                           
//#8672                mov        eax,pnt                                                   
//#8673                mov        eax,[eax]                                                   
//#8674        }                                                                   
//#8675    }                                                                       
//#8676                                                                           
//#8677    FPCLP* fpref(void* pnt){                                                                       
//#8678                                                                           
//#8679        _asm{                                                                   
//#8680                                                                           
//#8681                mov        eax,pnt                                                   
//#8682                mov        eax,[eax]                                                   
//#8683        }                                                                   
//#8684    }                                                                       
//#8685                                                                           
//#8686    unsigned sizfclp()                                                                       
//#8687    {                                                                       
//#8688        unsigned siz;                                                                   
//#8689                                                                           
//#8690        siz=sizeof(FRMCLP)+sids*sizeof(FLPNT);                                                                   
//#8691        if(frmpnt->typ==SAT)                                                                   
//#8692            siz+=frmpnt->stpt*sizeof(SATCON);                                                               
//#8693        if(iseclp(clofind))                                                                   
//#8694            siz+=frmpnt->nclp*sizeof(FLPNT);                                                               
//#8695        if(isclpx(clofind))                                                                   
//#8696            siz+=frmpnt->flencnt.nclp*sizeof(FLPNT);                                                               
//#8697        if(istx(clofind))                                                                   
//#8698            siz+=frmpnt->dhx.txt.cnt*sizeof(TXPNT);                                                               
//#8699        return siz;                                                                   
//#8700    }                                                                       
//#8701                                                                           
//#8702    unsigned frmcnt(unsigned fpnt){                                                                       
//#8703                                                                           
//#8704        unsigned    at,cnt=0,ind;                                                               
//#8705                                                                           
//#8706        lolft.x=lolft.y=(float)1e20;                                                                   
//#8707        at=fpnt<<4;                                                                   
//#8708        for(ind=0;ind<hed.stchs;ind++){                                                                   
//#8709                                                                           
//#8710            if((stchs[ind].at&FRMSK)==at&&stchs[ind].at&TYPMSK)                                                               
//#8711                goto fskip;                                                           
//#8712        }                                                                   
//#8713        return 0;                                                                   
//#8714    fskip:;                                                                       
//#8715        frmstrt=ind;                                                                   
//#8716        while(ind<hed.stchs){                                                                   
//#8717                                                                           
//#8718            if((stchs[ind].at&FRMSK)==at&&stchs[ind].at&TYPMSK){                                                               
//#8719                                                                           
//#8720                if(stchs[ind].x<lolft.x)                                                           
//#8721                    lolft.x=stchs[ind].x;                                                       
//#8722                if(stchs[ind].y<lolft.y)                                                           
//#8723                    lolft.y=stchs[ind].y;                                                       
//#8724                cnt++;                                                           
//#8725            }                                                               
//#8726            ind++;                                                               
//#8727        }                                                                   
//#8728        return cnt;                                                                   
//#8729    }                                                                       
//#8730                                                                           
//#8731    unsigned sizclp(){                                                                       
//#8732                                                                           
//#8733        unsigned len=0;                                                                   
//#8734                                                                           
//#8735        len=siz=sizeof(FRMCLP)+sids*sizeof(FLPNT);                                                                   
//#8736        if(frmpnt->typ==SAT)                                                                   
//#8737            siz+=frmpnt->stpt*sizeof(SATCON);                                                               
//#8738        if(frmpnt->ftyp||frmpnt->etyp){                                                                   
//#8739                                                                           
//#8740            len+=frmcnt(clofind);                                                               
//#8741            siz+=len*sizeof(SHRTPNT);                                                               
//#8742        }                                                                   
//#8743        if(iseclp(clofind))                                                                   
//#8744            siz+=frmpnt->nclp*sizeof(FLPNT);                                                               
//#8745        if(isclpx(clofind))                                                                   
//#8746            siz+=frmpnt->flencnt.nclp*sizeof(FLPNT);                                                               
//#8747        if(istx(clofind))                                                                   
//#8748            siz+=frmpnt->dhx.txt.cnt*sizeof(TXPNT);                                                               
//#8749        return len;                                                                   
//#8750    }                                                                       
//#8751                                                                           
//#8752    unsigned lenclp()                                                                       
//#8753    {                                                                       
//#8754        unsigned cod,ind,cnt;                                                                   
//#8755                                                                           
//#8756        cnt=0;                                                                   
//#8757        cod=clofind<<FRMSHFT;                                                                   
//#8758        for(ind=0;ind<hed.stchs;ind++)                                                                   
//#8759        {                                                                   
//#8760            if((stchs[ind].at&(FRMSK|NOTFRM))==cod)                                                               
//#8761                cnt++;                                                           
//#8762        }                                                                   
//#8763        return cnt;                                                                   
//#8764    }                                                                       
//#8765                                                                           
//#8766    void duclip(){                                                                       
//#8767                                                                           
//#8768        unsigned    ind,ine,len=0,inf,at,msiz=0;                                                               
//#8769        SATCON*        sac;                                                           
//#8770        FLPNT*        clp;                                                           
//#8771        FLPNT*        mclp;                                                           
//#8772        TXPNT*        ptx;                                                           
//#8773        TXPNT*        ptxs;                                                           
//#8774        FRMHED*        tfrm;                                                           
//#8775        SHRTPNT*    astch;                                                               
//#8776        FPCLP*        pclp;                                                           
//#8777        FLPNT*        tflt;                                                           
//#8778                                                                           
//#8779        if(chkMap(FPSEL)){                                                                   
//#8780                                                                           
//#8781            if(OpenClipboard(hWnd)){                                                               
//#8782                                                                           
//#8783                EmptyClipboard();                                                           
//#8784                htclp=RegisterClipboardFormat(thredclp);                                                           
//#8785                tclpvoid=GlobalAlloc(GMEM_MOVEABLE|GMEM_DDESHARE,(pselrng.cnt+1)*sizeof(FLPNT)+sizeof(FPCLP));                                                           
//#8786                pclp=fpref(tclpvoid);                                                           
//#8787                pclp->led=CLP_FRMPS;                                                           
//#8788                pclp->cnt=pselrng.cnt;                                                           
//#8789                if(chkMap(PSELDIR))                                                           
//#8790                    pclp->dir=1;                                                       
//#8791                else                                                           
//#8792                    pclp->dir=0;                                                       
//#8793                tflt=(FLPNT*)&pclp[1];                                                           
//#8794                fvars(clofind);                                                           
//#8795                ine=pselrng.strt;                                                           
//#8796                for(ind=0;ind<=pselrng.cnt;ind++){                                                           
//#8797                                                                           
//#8798                    tflt[ind].x=flt[ine].x;                                                       
//#8799                    tflt[ind].y=flt[ine].y;                                                       
//#8800                    ine=pdir(ine);                                                       
//#8801                }                                                           
//#8802                SetClipboardData(htclp,tclpvoid);                                                           
//#8803                CloseClipboard();                                                           
//#8804            }                                                               
//#8805            return;                                                               
//#8806        }                                                                   
//#8807        if(chkMap(BIGBOX))                                                                   
//#8808            tabmsg(IDS_INSF);                                                               
//#8809        else{                                                                   
//#8810                                                                           
//#8811            if(OpenClipboard(hWnd)){                                                               
//#8812                                                                           
//#8813                EmptyClipboard();                                                           
//#8814                htclp=RegisterClipboardFormat(thredclp);                                                           
//#8815                if(fselpnt){                                                           
//#8816                                                                           
//#8817                    for(ind=0;ind<fselpnt;ind++){                                                       
//#8818                                                                           
//#8819                        clofind=selist[ind];                                                   
//#8820                        fvars(clofind);                                                   
//#8821                        len+=sizfclp();                                                   
//#8822                        msiz+=siz;                                                   
//#8823                    }                                                       
//#8824                    tclpvoid=GlobalAlloc(GMEM_MOVEABLE|GMEM_DDESHARE,msiz+len);                                                       
//#8825                    frmsclpdat=frmsref(tclpvoid);                                                       
//#8826                    frmsclpdat->led=CLP_FRMS;                                                       
//#8827                    frmsclpdat->cnt=fselpnt;                                                       
//#8828                    tfrm=(FRMHED*)&frmsclpdat[1];                                                       
//#8829                    for(ind=0;ind<fselpnt;ind++){                                                       
//#8830                                                                           
//#8831                        frmpnt=&formlst[selist[ind]];                                                   
//#8832                        frmcpy(&tfrm[ind],&formlst[selist[ind]]);                                                   
//#8833                    }                                                       
//#8834                    flt=(FLPNT*)&tfrm[ind];                                                       
//#8835                    inf=0;                                                       
//#8836                    for(ind=0;ind<fselpnt;ind++){                                                       
//#8837                                                                           
//#8838                        frmpnt=&formlst[selist[ind]];                                                   
//#8839                        for(ine=0;ine<frmpnt->sids;ine++){                                                   
//#8840                                                                           
//#8841                            flt[inf].x=frmpnt->flt[ine].x;                                               
//#8842                            flt[inf++].y=frmpnt->flt[ine].y;                                               
//#8843                        }                                                   
//#8844                    }                                                       
//#8845                    sac=(SATCON*)&flt[inf];                                                       
//#8846                    inf=0;                                                       
//#8847                    for(ind=0;ind<fselpnt;ind++){                                                       
//#8848                                                                           
//#8849                        frmpnt=&formlst[selist[ind]];                                                   
//#8850                        if(frmpnt->typ==SAT){                                                   
//#8851                                                                           
//#8852                            for(ine=0;ine<frmpnt->stpt;ine++){                                               
//#8853                                                                           
//#8854                                sac[inf].strt=frmpnt->sacang.sac[ine].strt;                                           
//#8855                                sac[inf++].fin=frmpnt->sacang.sac[ine].fin;                                           
//#8856                            }                                               
//#8857                        }                                                   
//#8858                    }                                                       
//#8859                    clp=(FLPNT*)&sac[inf];                                                       
//#8860                    inf=0;                                                       
//#8861                    for(ind=0;ind<fselpnt;ind++){                                                       
//#8862                                                                           
//#8863                        frmpnt=&formlst[selist[ind]];                                                   
//#8864                        if(isclpx(selist[ind])){                                                   
//#8865                                                                           
//#8866                            for(ine=0;ine<frmpnt->flencnt.nclp;ine++){                                               
//#8867                                                                           
//#8868                                clp[inf].x=frmpnt->angclp.clp[ine].x;                                           
//#8869                                clp[inf++].y=frmpnt->angclp.clp[ine].y;                                           
//#8870                            }                                               
//#8871                        }                                                   
//#8872                        if(iseclp(selist[ind])){                                                   
//#8873                                                                           
//#8874                            for(ine=0;ine<frmpnt->nclp;ine++){                                               
//#8875                                                                           
//#8876                                clp[inf].x=frmpnt->clp[ine].x;                                           
//#8877                                clp[inf++].y=frmpnt->clp[ine].y;                                           
//#8878                            }                                               
//#8879                        }                                                   
//#8880                    }                                                       
//#8881                    ptx=(TXPNT*)&clp[inf];                                                       
//#8882                    ine=0;                                                       
//#8883                    for(ind=0;ind<fselpnt;ind++)                                                       
//#8884                    {                                                       
//#8885                        frmpnt=&formlst[selist[ind]];                                                   
//#8886                        if(istx(selist[ind]))                                                   
//#8887                        {                                                   
//#8888                            MoveMemory(&ptx[ine],&txpnts[frmpnt->dhx.txt.ind],frmpnt->dhx.txt.cnt*sizeof(TXPNT));                                               
//#8889                            tfrm[ind].dhx.txt.ind=ine;                                               
//#8890                            ine+=frmpnt->dhx.txt.cnt;                                               
//#8891                        }                                                   
//#8892                    }                                                       
//#8893                    SetClipboardData(htclp,tclpvoid);                                                       
//#8894                    CloseClipboard();                                                       
//#8895                    clRmap(RMAPSIZ);                                                       
//#8896                    for(ind=0;ind<fselpnt;ind++)                                                       
//#8897                        setr(selist[ind]);                                                   
//#8898                    astch=&stchs[MAXSEQ];                                                       
//#8899                    ine=0;                                                       
//#8900                    lolft.x=lolft.y=(float)1e30;                                                       
//#8901                    for(ind=0;ind<hed.stchs;ind++){                                                       
//#8902                                                                           
//#8903                        if(!(stchs[ind].at&NOTFRM)&&chkr((stchs[ind].at&FRMSK)>>FRMSHFT)){                                                   
//#8904                                                                           
//#8905                            if(stchs[ind].x<lolft.x)                                               
//#8906                                lolft.x=stchs[ind].x;                                           
//#8907                            if(stchs[ind].y<lolft.y)                                               
//#8908                                lolft.y=stchs[ind].y;                                           
//#8909                            astch[ine].x=stchs[ind].x;                                               
//#8910                            astch[ine].y=stchs[ind].y;                                               
//#8911                            astch[ine++].at=stchs[ind].at;                                               
//#8912                        }                                                   
//#8913                    }                                                       
//#8914                    if(hed.stchs&&ine){                                                       
//#8915                                                                           
//#8916                        hClip=RegisterClipboardFormat(pcdClip);                                                   
//#8917                        clpvoid=GlobalAlloc(GMEM_MOVEABLE|GMEM_DDESHARE,ine*sizeof(CLPSTCH)+2);                                                   
//#8918                        clpdat=deref(clpvoid);                                                   
//#8919                        ind=MAXSEQ;                                                   
//#8920                        inf=0;                                                   
//#8921                        savclp(0,ind);                                                   
//#8922                        ind++;                                                   
//#8923                        clpdat[0].led=ine;                                                   
//#8924                        inf++;                                                   
//#8925                        while(ind<ine+MAXSEQ)                                                   
//#8926                            savclp(inf++,ind++);                                               
//#8927                        SetClipboardData(hClip,clpvoid);                                                   
//#8928                        CloseClipboard();                                                   
//#8929                    }                                                       
//#8930                }                                                           
//#8931                else{                                                           
//#8932                                                                           
//#8933                    if(chkMap(FORMSEL)){                                                       
//#8934                                                                           
//#8935                        len=sizclp();                                                   
//#8936                        fvars(clofind);                                                   
//#8937                        sac=0;at=clofind<<4;                                                   
//#8938                        siz+=sizeof(FRMCLP);                                                   
//#8939                        tclpvoid=GlobalAlloc(GMEM_MOVEABLE|GMEM_DDESHARE,siz);                                                   
//#8940                        frmclpdat=frmref(tclpvoid);                                                   
//#8941                        frmclpdat->led=CLP_FRM;                                                   
//#8942                        frmcpy(&frmclpdat->frm,&formlst[clofind]);                                                   
//#8943                        flt=(FLPNT*)&frmclpdat[1];                                                   
//#8944                        for(ind=0;ind<frmpnt->sids;ind++){                                                   
//#8945                                                                           
//#8946                            flt[ind].x=frmpnt->flt[ind].x;                                               
//#8947                            flt[ind].y=frmpnt->flt[ind].y;                                               
//#8948                        }                                                   
//#8949                        sac=(SATCON*)&flt[sids];                                                   
//#8950                        ind=0;                                                   
//#8951                        if(frmpnt->typ==SAT){                                                   
//#8952                                                                           
//#8953                            for(ind=0;ind<frmpnt->stpt;ind++){                                               
//#8954                                                                           
//#8955                                sac[ind].strt=frmpnt->sacang.sac[ind].strt;                                           
//#8956                                sac[ind].fin=frmpnt->sacang.sac[ind].fin;                                           
//#8957                            }                                               
//#8958                        }                                                   
//#8959                        mclp=(FLPNT*)&sac[ind];                                                   
//#8960                        if(isclpx(clofind)){                                                   
//#8961                                                                           
//#8962                            for(ind=0;ind<frmpnt->flencnt.nclp;ind++){                                               
//#8963                                                                           
//#8964                                mclp[ind].x=frmpnt->angclp.clp[ind].x;                                           
//#8965                                mclp[ind].y=frmpnt->angclp.clp[ind].y;                                           
//#8966                            }                                               
//#8967                        }                                                   
//#8968                        clp=(FLPNT*)&mclp[ind];                                                   
//#8969                        if(iseclpx(clofind)){                                                   
//#8970                                                                           
//#8971                            for(ind=0;ind<frmpnt->nclp;ind++){                                               
//#8972                                                                           
//#8973                                clp[ind].x=frmpnt->clp[ind].x;                                           
//#8974                                clp[ind].y=frmpnt->clp[ind].y;                                           
//#8975                            }                                               
//#8976                        }                                                   
//#8977                        ptx=(TXPNT*)&clp[ind];                                                   
//#8978                        if(istx(clofind))                                                   
//#8979                        {                                                   
//#8980                            ptxs=&txpnts[frmpnt->dhx.txt.ind];                                               
//#8981                            for(ind=0;ind<frmpnt->dhx.txt.cnt;ind++)                                               
//#8982                            {                                               
//#8983                                ptx[ind].lin=ptxs[ind].lin;                                           
//#8984                                ptx[ind].y=ptxs[ind].y;                                           
//#8985                            }                                               
//#8986                        }                                                   
//#8987                        SetClipboardData(htclp,tclpvoid);                                                   
//#8988                        if((frmpnt->ftyp||frmpnt->etyp))                                                   
//#8989                        {                                                   
//#8990                            len=lenclp();                                               
//#8991                            hClip=RegisterClipboardFormat(pcdClip);                                               
//#8992                            clpvoid=GlobalAlloc(GMEM_MOVEABLE|GMEM_DDESHARE,len*sizeof(CLPSTCH)+2);                                               
//#8993                            clpdat=deref(clpvoid);                                               
//#8994                            ind=frmstrt;                                               
//#8995                            savclp(0,ind);                                               
//#8996                            clpdat[0].led=len;                                               
//#8997                            ind++;                                               
//#8998                            inf=1;                                               
//#8999                            at=clofind<<4;                                               
//#9000                            while(ind<hed.stchs){                                               
//#9001                                                                           
//#9002                                if((stchs[ind].at&FRMSK)==at&&!(stchs[ind].at&NOTFRM))                                           
//#9003                                    savclp(inf++,ind);                                       
//#9004                                ind++;                                           
//#9005                            }                                               
//#9006                            SetClipboardData(hClip,clpvoid);                                               
//#9007                            ispcdclp();                                               
//#9008                        }                                                   
//#9009                        CloseClipboard();                                                   
//#9010                    }                                                       
//#9011                    else{                                                       
//#9012                                                                           
//#9013                        if(hed.stchs&&chkMap(GRPSEL)){                                                   
//#9014                                                                           
//#9015                            hClip=RegisterClipboardFormat(pcdClip);                                               
//#9016                            rngadj();                                               
//#9017                            lolft.x=lolft.y=(float)1e30;                                               
//#9018                            for(ind=gpnt0;ind<=gpnt1;ind++){                                               
//#9019                                                                           
//#9020                                if(stchs[ind].x<lolft.x)                                           
//#9021                                    lolft.x=stchs[ind].x;                                       
//#9022                                if(stchs[ind].y<lolft.y)                                           
//#9023                                    lolft.y=stchs[ind].y;                                       
//#9024                            }                                               
//#9025                            len=gpnt1-gpnt0+1;                                               
//#9026                            inf=gpnt0;                                               
//#9027                            clpvoid=GlobalAlloc(GMEM_MOVEABLE|GMEM_DDESHARE,len*sizeof(CLPSTCH)+2);                                               
//#9028                            clpdat=deref(clpvoid);                                               
//#9029                            savclp(0,inf);                                               
//#9030                            clpdat[0].led=len;                                               
//#9031                            inf++;                                               
//#9032                            for(ind=1;ind<len;ind++)                                               
//#9033                                savclp(ind,inf++);                                           
//#9034                            SetClipboardData(hClip,clpvoid);                                               
//#9035                            CloseClipboard();                                               
//#9036                        }                                                   
//#9037                    }                                                       
//#9038                }                                                           
//#9039                CloseClipboard();                                                           
//#9040            }                                                               
//#9041        }                                                                   
//#9042    }                                                                       
//#9043                                                                           
//#9044    void delfstchs(){                                                                       
//#9045                                                                           
//#9046        unsigned ind,ine=0;;                                                                   
//#9047                                                                           
//#9048        for(ind=0;ind<hed.stchs;ind++){                                                                   
//#9049                                                                           
//#9050            if(stchs[ind].at&NOTFRM){                                                               
//#9051                                                                           
//#9052                stchs[ine].at=stchs[ind].at;                                                           
//#9053                stchs[ine].x=stchs[ind].x;                                                           
//#9054                stchs[ine++].y=stchs[ind].y;                                                           
//#9055            }                                                               
//#9056            else{                                                               
//#9057                                                                           
//#9058                if(((stchs[ind].at&FRMSK)>>4)!=clofind){                                                           
//#9059                                                                           
//#9060                    stchs[ine].at=stchs[ind].at;                                                       
//#9061                    stchs[ine].x=stchs[ind].x;                                                       
//#9062                    stchs[ine++].y=stchs[ind].y;                                                       
//#9063                }                                                           
//#9064            }                                                               
//#9065        }                                                                   
//#9066        hed.stchs=ine;                                                                   
//#9067    }                                                                       
//#9068                                                                           
//#9069    void cut(){                                                                       
//#9070                                                                           
//#9071        duclip();                                                                   
//#9072        if(fselpnt)                                                                   
//#9073        {                                                                   
//#9074            setMap(DELTO);                                                               
//#9075            delsfrms('s');                                                               
//#9076        }                                                                   
//#9077        else                                                                   
//#9078        {                                                                   
//#9079            if(chkMap(FORMSEL)){                                                               
//#9080                                                                           
//#9081                delfstchs();                                                           
//#9082                frmdel();                                                           
//#9083            }                                                               
//#9084            else{                                                               
//#9085                                                                           
//#9086                if(chkMap(GRPSEL))                                                           
//#9087                    delstchm();                                                       
//#9088            }                                                               
//#9089        }                                                                   
//#9090        coltab();                                                                   
//#9091        rstAll();                                                                   
//#9092        setMap(RESTCH);                                                                   
//#9093    }                                                                       
//#9094                                                                           
//#9095    void numWnd(){                                                                       
//#9096                                                                           
//#9097        RECT msgRct;                                                                   
//#9098                                                                           
//#9099        GetClientRect(hMsg,&msgRct);                                                                   
//#9100        hgNum=CreateWindow(                                                                   
//#9101            STATIC,                                                               
//#9102            0                                                               
//#9103            SS_CENTER|WS_CHILD|WS_VISIBLE|WS_BORDER,                                                               
//#9104            5                                                               
//#9105            msgRct.bottom+15,                                                               
//#9106            buttonWid3,                                                               
//#9107            buttonHi,                                                               
//#9108            hStch,                                                               
//#9109            NULL,                                                               
//#9110            hInst,                                                               
//#9111            NULL);                                                               
//#9112        msgpnt=0;                                                                   
//#9113        *msgbuf=0;                                                                   
//#9114    }                                                                       
//#9115                                                                           
//#9116    void unmsg(){                                                                       
//#9117                                                                           
//#9118        if(hMsg)                                                                   
//#9119            noMsg();                                                               
//#9120    }                                                                       
//#9121                                                                           
//#9122    void unpat(){                                                                       
//#9123                                                                           
//#9124        if(rstMap(WASPAT)){                                                                   
//#9125                                                                           
//#9126            ShowWindow(hSped,FALSE);                                                               
//#9127            DestroyWindow(hSped);                                                               
//#9128            movStch();                                                               
//#9129            setMap(RESTCH);                                                               
//#9130        }                                                                   
//#9131    }                                                                       
//#9132    void delsmal(unsigned ind,unsigned fin){                                                                       
//#9133                                                                           
//#9134        unsigned    ine,at=clofind<<4;                                                               
//#9135        unsigned    inf;                                                               
//#9136        long        dx,dy;                                                           
//#9137        double        siz=1e99;                                                           
//#9138                                                                           
//#9139        savdo();                                                                   
//#9140        if(chkMap(FORMSEL)){                                                                   
//#9141                                                                           
//#9142            ine=find1st();                                                               
//#9143            ind=ine+1;                                                               
//#9144            while(ind<(unsigned)hed.stchs-1&&siz>smalsiz){                                                               
//#9145                                                                           
//#9146                if(!(stchs[ind].at&NOTFRM)&&(stchs[ind].at&FRMSK)==at){                                                           
//#9147                                                                           
//#9148                    if(stchs[ind].at&KNOTMSK)                                                       
//#9149                        ine=ind;                                                   
//#9150                    else{                                                       
//#9151                                                                           
//#9152                        dx=stchs[ind].x-stchs[ine].x;                                                   
//#9153                        dy=stchs[ind].y-stchs[ine].y;                                                   
//#9154                        siz=hypot(dx,dy);                                                   
//#9155                    }                                                       
//#9156                    ind++;                                                       
//#9157                }                                                           
//#9158            }                                                               
//#9159            if(ind!=fin-2){                                                               
//#9160                                                                           
//#9161                ind--;                                                           
//#9162                ine=ind+2;                                                           
//#9163                while(ine<(unsigned)hed.stchs-1){                                                           
//#9164                                                                           
//#9165                    do{                                                       
//#9166                                                                           
//#9167                        if(!(stchs[ind].at&NOTFRM)&&(stchs[ind].at&FRMSK)==at&&!(stchs[ind].at&KNOTMSK)){                                                   
//#9168                                                                           
//#9169                            dx=stchs[ine].x-stchs[ind].x;                                               
//#9170                            dy=stchs[ine++].y-stchs[ind].y;                                               
//#9171                            siz=hypot(dx,dy);                                               
//#9172                        }                                                   
//#9173                        else                                                   
//#9174                            ine++;                                               
//#9175                    }while(siz<smalsiz&&ine<hed.stchs);                                                       
//#9176                    stchs[++ind].at=stchs[--ine].at;                                                       
//#9177                    stchs[ind].x=stchs[ine].x;                                                       
//#9178                    stchs[ind].y=stchs[ine++].y;                                                       
//#9179                }                                                           
//#9180                ind++;                                                           
//#9181                while(ine<hed.stchs){                                                           
//#9182                                                                           
//#9183                    stchs[ind].at=stchs[ine].at;                                                       
//#9184                    stchs[ind].x=stchs[ine].x;                                                       
//#9185                    stchs[ind++].y=stchs[ine++].y;                                                       
//#9186                }                                                           
//#9187                hed.stchs=ind;                                                           
//#9188                coltab();                                                           
//#9189            }                                                               
//#9190        }                                                                   
//#9191        else{                                                                   
//#9192                                                                           
//#9193            ine=ind+1;                                                               
//#9194            sPnt.x=stchs[ind].x;                                                               
//#9195            sPnt.y=stchs[ind].y;                                                               
//#9196            for(inf=ine;inf<fin;inf++){                                                               
//#9197                                                                           
//#9198                if(stchs[ine].at&KNOTMSK){                                                           
//#9199                                                                           
//#9200                    sPnt.x=stchs[ine].x;                                                       
//#9201                    sPnt.y=stchs[ine].y;                                                       
//#9202                    mvstch(ine++,inf);                                                       
//#9203                }                                                           
//#9204                else{                                                           
//#9205                                                                           
//#9206                    dx=stchs[inf].x-sPnt.x;                                                       
//#9207                    dy=stchs[inf].y-sPnt.y;                                                       
//#9208                    siz=hypot(dx,dy);                                                       
//#9209                    if(siz>smalsiz){                                                       
//#9210                                                                           
//#9211                        mvstch(ine++,inf);                                                   
//#9212                        sPnt.x=stchs[inf].x;                                                   
//#9213                        sPnt.y=stchs[inf].y;                                                   
//#9214                    }                                                       
//#9215                }                                                           
//#9216            }                                                               
//#9217            while(inf<hed.stchs)                                                               
//#9218                mvstch(ine++,inf++);                                                           
//#9219            hed.stchs=ine;                                                               
//#9220            coltab();                                                               
//#9221        }                                                                   
//#9222        rstAll();                                                                   
//#9223        ritot(hed.stchs);                                                                   
//#9224        lenCalc();                                                                   
//#9225        setMap(RESTCH);                                                                   
//#9226    }                                                                       
//#9227                                                                           
//#9228    BOOL cmpstch(unsigned ind0,unsigned ind1){                                                                       
//#9229                                                                           
//#9230        _asm{                                                                   
//#9231                mov        eax,ind0                                                   
//#9232                xor        ecx,ecx                                                   
//#9233                mov        cl,12                                                   
//#9234                mul        ecx                                                   
//#9235                mov        ebx,eax                                                   
//#9236                add        ebx,offset stchs                                                   
//#9237                mov        eax,ind1                                                   
//#9238                mul        ecx                                                   
//#9239                add        eax,offset stchs                                                   
//#9240                mov        edx,eax                                                   
//#9241                mov        eax,[edx]                                                   
//#9242                cmp        eax,[ebx]                                                   
//#9243                jne        short ncmpx                                                   
//#9244                add        edx,4                                                   
//#9245                add        ebx,4                                                   
//#9246                mov        eax,[edx]                                                   
//#9247                cmp        eax,[ebx]                                                   
//#9248                jne        short ncmpx                                                   
//#9249                mov        al,1                                                   
//#9250                jmp        short doscmpx                                                   
//#9251    ncmpx:        xor        eax,eax                                                       
//#9252    doscmpx:                                                                       
//#9253        }                                                                   
//#9254    }                                                                       
//#9255                                                                           
//#9256    void mvstch(unsigned dst,unsigned src){                                                                       
//#9257                                                                           
//#9258        _asm{                                                                   
//#9259                mov        eax,dst                                                   
//#9260                xor        ecx,ecx                                                   
//#9261                mov        cl,12                                                   
//#9262                mul        ecx                                                   
//#9263                mov        ebx,eax                                                   
//#9264                add        ebx,offset stchs                                                   
//#9265                mov        eax,src                                                   
//#9266                mul        ecx                                                   
//#9267                add        eax,offset stchs                                                   
//#9268                mov        cl,4                                                   
//#9269                mov        edx,[eax]                                                   
//#9270                mov        [ebx],edx                                                   
//#9271                add        ebx,ecx                                                   
//#9272                add        eax,ecx                                                   
//#9273                mov        edx,[eax]                                                   
//#9274                mov        [ebx],edx                                                   
//#9275                add        ebx,ecx                                                   
//#9276                add        eax,ecx                                                   
//#9277                mov        edx,[eax]                                                   
//#9278                mov        [ebx],edx                                                   
//#9279        }                                                                   
//#9280    }                                                                       
//#9281                                                                           
//#9282    void ofstch(unsigned ind,TCHAR of){                                                                       
//#9283                                                                           
//#9284        stchs[opnt].x=stchs[ind].x+knotstp.x*of;                                                                   
//#9285        stchs[opnt].y=stchs[ind].y+knotstp.y*of;                                                                   
//#9286        stchs[opnt++].at=knotat;                                                                   
//#9287    }                                                                       
//#9288                                                                           
//#9289    void endknt(unsigned fin){                                                                       
//#9290                                                                           
//#9291        double        len;                                                           
//#9292        DUBPNT        dif;                                                           
//#9293        unsigned    strt,ind;                                                               
//#9294        TCHAR*        tdat;                                                           
//#9295                                                                           
//#9296        strt=fin-1;                                                                   
//#9297        knotat=stchs[strt].at|KNOTMSK;                                                                   
//#9298        do{                                                                   
//#9299                                                                           
//#9300            dif.x=stchs[fin].x-stchs[strt].x;                                                               
//#9301            dif.y=stchs[fin].y-stchs[strt].y;                                                               
//#9302            len=hypot(dif.x,dif.y);                                                               
//#9303            strt--;                                                               
//#9304        }while(!len);                                                                   
//#9305        if(chkMap(FILDIR))                                                                   
//#9306            tdat=klstdat;                                                               
//#9307        else                                                                   
//#9308            tdat=kendat;                                                               
//#9309        if(!(strt&0x8000000)){                                                                   
//#9310                                                                           
//#9311            knotstp.x=2/len*dif.x;                                                               
//#9312            knotstp.y=2/len*dif.y;                                                               
//#9313            for(ind=0;ind<5;ind++)                                                               
//#9314                ofstch(fin,tdat[ind]);                                                           
//#9315            if(chkMap(FILDIR))                                                               
//#9316                ofstch(fin,0);                                                           
//#9317        }                                                                   
//#9318    }                                                                       
//#9319                                                                           
//#9320    void strtknt(unsigned strt){                                                                       
//#9321                                                                           
//#9322        double        len;                                                           
//#9323        DUBPNT        dif;                                                           
//#9324        unsigned    fin,ind;                                                               
//#9325                                                                           
//#9326        fin=strt+1;                                                                   
//#9327        do{                                                                   
//#9328                                                                           
//#9329            dif.x=stchs[fin].x-stchs[strt].x;                                                               
//#9330            dif.y=stchs[fin].y-stchs[strt].y;                                                               
//#9331            len=hypot(dif.x,dif.y);                                                               
//#9332            fin++;                                                               
//#9333        }while(len<2&&fin<hed.stchs);                                                                   
//#9334        if(fin<hed.stchs){                                                                   
//#9335                                                                           
//#9336            knotat=stchs[strt].at|KNOTMSK;                                                               
//#9337            knotstp.x=2/len*dif.x;                                                               
//#9338            knotstp.y=2/len*dif.y;                                                               
//#9339            for(ind=0;ind<5;ind++)                                                               
//#9340                ofstch(strt,kstrtdat[ind]);                                                           
//#9341        }                                                                   
//#9342    }                                                                       
//#9343                                                                           
//#9344    BOOL aprxlen(double flen, unsigned ulen){                                                                       
//#9345                                                                           
//#9346    #define KNER 0.05                                                                       
//#9347                                                                           
//#9348        if(flen>ulen+KNER)                                                                   
//#9349            return 1;                                                               
//#9350        if(flen<ulen-KNER)                                                                   
//#9351            return 1;                                                               
//#9352        return 0;                                                                   
//#9353    }                                                                       
//#9354                                                                           
//#9355    void fndknt(){                                                                       
//#9356                                                                           
//#9357        unsigned    ind;                                                               
//#9358        BOOL        flg;                                                           
//#9359                                                                           
//#9360        if(hed.stchs>4){                                                                   
//#9361                                                                           
//#9362            flg=0;                                                               
//#9363            knotcnt=0;                                                               
//#9364            for(ind=0;ind<(unsigned)hed.stchs-4;ind++){                                                               
//#9365                                                                           
//#9366                if(stchs[ind].at&KNOTMSK){                                                           
//#9367                                                                           
//#9368                    if(!flg)                                                       
//#9369                        knotab[knotcnt++]=ind;                                                   
//#9370                }                                                           
//#9371                else                                                           
//#9372                    flg=0;                                                       
//#9373            }                                                               
//#9374        }                                                                   
//#9375        else knotcnt=0;                                                                   
//#9376    }                                                                       
//#9377                                                                           
//#9378    void delknt(){                                                                       
//#9379                                                                           
//#9380        unsigned    ind,ine;                                                               
//#9381                                                                           
//#9382        ine=0;                                                                   
//#9383        for(ind=0;ind<hed.stchs;ind++){                                                                   
//#9384                                                                           
//#9385            if(!(stchs[ind].at&KNOTMSK))                                                               
//#9386                mvstch(ine++,ind);                                                           
//#9387        }                                                                   
//#9388        hed.stchs=ine;                                                                   
//#9389    }                                                                       
//#9390                                                                           
//#9391    BOOL isknots(){                                                                       
//#9392                                                                           
//#9393        unsigned ind;                                                                   
//#9394                                                                           
//#9395        for(ind=0;ind<hed.stchs;ind++){                                                                   
//#9396                                                                           
//#9397            if(stchs[ind].at&KNOTMSK)                                                               
//#9398                return 1;                                                           
//#9399        }                                                                   
//#9400        return 0;                                                                   
//#9401    }                                                                       
//#9402                                                                           
//#9403    void delknot(){                                                                       
//#9404                                                                           
//#9405        if(isknots()){                                                                   
//#9406                                                                           
//#9407            savdo();                                                               
//#9408            delknt();                                                               
//#9409            coltab();                                                               
//#9410            setMap(RESTCH);                                                               
//#9411        }                                                                   
//#9412    }                                                                       
//#9413                                                                           
//#9414    unsigned kjmp(unsigned strt){                                                                       
//#9415                                                                           
//#9416        while(strt<(unsigned)hed.stchs-1&&stlen(strt)>KNOTLEN)                                                                   
//#9417            mvstch(opnt++,strt++);                                                               
//#9418        strtknt(strt);                                                                   
//#9419        return strt;                                                                   
//#9420    }                                                                       
//#9421                                                                           
//#9422    void setknt(){                                                                       
//#9423                                                                           
//#9424        unsigned    ind;                                                               
//#9425                                                                           
//#9426        opnt=MAXSEQ;                                                                   
//#9427        mvstch(opnt++,0);                                                                   
//#9428        strtknt(0);                                                                   
//#9429        if(stlen(0)>KNOTLEN)                                                                   
//#9430            ind=kjmp(1);                                                               
//#9431        else                                                                   
//#9432            ind=1;                                                               
//#9433        rstMap(FILDIR);                                                                   
//#9434        while(ind<(unsigned)hed.stchs-1){                                                                   
//#9435                                                                           
//#9436            mvstch(opnt++,ind);                                                               
//#9437            if(stlen(ind)>KNOTLEN){                                                               
//#9438                                                                           
//#9439                endknt(ind);                                                           
//#9440                ind=kjmp(ind+1);                                                           
//#9441                mvstch(opnt++,ind);                                                           
//#9442            }                                                               
//#9443            ind++;                                                               
//#9444        }                                                                   
//#9445        setMap(FILDIR);                                                                   
//#9446        endknt(ind);                                                                   
//#9447        stchs[opnt-1].at&=(~KNOTMSK);                                                                   
//#9448        hed.stchs=opnt-MAXSEQ;                                                                   
//#9449        mvstchs(0,MAXSEQ,hed.stchs);                                                                   
//#9450    }                                                                       
//#9451                                                                           
//#9452    unsigned srchknot(unsigned src){                                                                       
//#9453                                                                           
//#9454        while(knotab[xpnt]<src&&xpnt<knotcnt)                                                                   
//#9455            xpnt++;                                                               
//#9456        xpnt--;                                                                   
//#9457    //    if(abs(knotab[xpnt]-src)<5){                                                                   
//#9458        if ( abs( (int)(knotab[xpnt] - src) ) < 5 ){ // xiaoguang                                                                   
//#9459                                                                           
//#9460            xpnt++;                                                               
//#9461    //        if(abs(knotab[xpnt]-src)<5)                                                               
//#9462            if ( abs( (int)(knotab[xpnt] - src) ) < 5 ) // xiaoguang                                                               
//#9463                return 0;                                                           
//#9464            else                                                               
//#9465                return 2;                                                           
//#9466        }                                                                   
//#9467        else{                                                                   
//#9468                                                                           
//#9469            xpnt++;                                                               
//#9470    //        if(abs(knotab[xpnt]-src)<5)                                                               
//#9471            if ( abs( (int)(knotab[xpnt] - src)) <5 ) // xiaoguang                                                               
//#9472                return 1;                                                           
//#9473            else                                                               
//#9474                return 3;                                                           
//#9475        }                                                                   
//#9476    }                                                                       
//#9477                                                                           
//#9478    void chkncol(){                                                                       
//#9479                                                                           
//#9480        unsigned    src,col,tcol,cod;                                                               
//#9481                                                                           
//#9482        opnt=MAXSEQ;                                                                   
//#9483        col=stchs[0].at&COLMSK;                                                                   
//#9484        rstMap(FILDIR);                                                                   
//#9485        for(src=0;src<hed.stchs;src++){                                                                   
//#9486                                                                           
//#9487            tcol=stchs[src].at&COLMSK;                                                               
//#9488            if(tcol==col)                                                               
//#9489                mvstch(opnt++,src);                                                           
//#9490            else{                                                               
//#9491                                                                           
//#9492                col=stchs[src].at&COLMSK;                                                           
//#9493                cod=srchknot(src);                                                           
//#9494                if(cod&1){                                                           
//#9495                                                                           
//#9496                    endknt(src-1);                                                       
//#9497                }                                                           
//#9498                mvstch(opnt++,src);                                                           
//#9499                if(cod&2)                                                           
//#9500                    strtknt(src);                                                       
//#9501            }                                                               
//#9502        }                                                                   
//#9503        hed.stchs=opnt-MAXSEQ;                                                                   
//#9504        mvstchs(0,MAXSEQ,hed.stchs);                                                                   
//#9505    }                                                                       
//#9506                                                                           
//#9507    void setknots()                                                                       
//#9508    {                                                                       
//#9509        if(hed.stchs)                                                                   
//#9510        {                                                                   
//#9511            savdo();                                                               
//#9512            delknt();                                                               
//#9513            setknt();                                                               
//#9514            fndknt();                                                               
//#9515            chkncol();                                                               
//#9516            coltab();                                                               
//#9517            setMap(RESTCH);                                                               
//#9518            ritot(hed.stchs);                                                               
//#9519        }                                                                   
//#9520    }                                                                       
//#9521                                                                           
//#9522    void lodbmp(){                                                                       
//#9523                                                                           
//#9524        TCHAR*    pchr;                                                               
//#9525                                                                           
//#9526        if(bnam[0]){                                                                   
//#9527                                                                           
//#9528            DeleteObject(hBmp);                                                               
//#9529            ReleaseDC(hWnd,bitdc);                                                               
//#9530        }                                                                   
//#9531        if(GetOpenFileName(&obn)){                                                                   
//#9532                                                                           
//#9533            untrace();                                                               
//#9534            pchr=strrchr(lbnam,'\\')+1;                                                               
//#9535            strcpy(bnam,pchr);                                                               
//#9536            defbNam();                                                               
//#9537            bfil();                                                               
//#9538            setMap(RESTCH);                                                               
//#9539        }                                                                   
//#9540    }                                                                       
//#9541                                                                           
//#9542    void duhbit(unsigned cod)                                                                       
//#9543    {                                                                       
//#9544        CheckMenuItem(hMen,ID_HIDBIT,MF_BYCOMMAND|cod);                                                                   
//#9545        CheckMenuItem(hMen,ID_HIDBITF,MF_BYCOMMAND|cod);                                                                   
//#9546    }                                                                       
//#9547                                                                           
//#9548    void hidbit(){                                                                       
//#9549                                                                           
//#9550        if(toglMap(HIDMAP))                                                                   
//#9551            duhbit(MF_UNCHECKED);                                                               
//#9552        else                                                                   
//#9553            duhbit(MF_CHECKED);                                                               
//#9554        setMap(DUMEN);                                                                   
//#9555        setMap(RESTCH);                                                                   
//#9556    }                                                                       
//#9557                                                                           
//#9558    void patdun(){                                                                       
//#9559                                                                           
//#9560        rstMap(RUNPAT);                                                                   
//#9561        KillTimer(hWnd,0);                                                                   
//#9562        setMap(WASPAT);                                                                   
//#9563        movStch();                                                                   
//#9564        setMap(RESTCH);                                                                   
//#9565        tabmsg(IDS_END);                                                                   
//#9566    }                                                                       
//#9567                                                                           
//#9568    void drwlstch(unsigned fin){                                                                       
//#9569                                                                           
//#9570        unsigned    col,ind,prepnt;                                                               
//#9571        unsigned    flg;                                                               
//#9572                                                                           
//#9573        prepnt=runpnt;                                                                   
//#9574        if(chkMap(HID)){                                                                   
//#9575                                                                           
//#9576            while((stchs[runpnt].at&COLMSK)!=actcol&&runpnt<fin-1)                                                               
//#9577                runpnt++;                                                           
//#9578        }                                                                   
//#9579        if(chkMap(ZUMED)){                                                                   
//#9580                                                                           
//#9581            ind=1;                                                               
//#9582            while(runpnt<runum+1&&runpnt<fin-2&&!stch2px(runpnt))                                                               
//#9583                runpnt++;                                                           
//#9584            prepnt=runpnt-1;                                                               
//#9585            col=stchs[runpnt].at&COLMSK;                                                               
//#9586            flg=1;                                                               
//#9587            while(ind<runum+1&&runpnt<fin-2&&(stchs[runpnt].at&COLMSK)==col){                                                               
//#9588                                                                           
//#9589                if(stch2px(runpnt)){                                                           
//#9590                                                                           
//#9591                    movilin[ind].x=pPnt.x;                                                       
//#9592                    movilin[ind++].y=pPnt.y;                                                       
//#9593                    if(flg){                                                       
//#9594                                                                           
//#9595                        flg=0;                                                   
//#9596                        if(stch2px(runpnt-1)){                                                   
//#9597                                                                           
//#9598                            movilin[0].x=movilin[1].x;                                               
//#9599                            movilin[0].y=movilin[1].y;                                               
//#9600                        }                                                   
//#9601                        else{                                                   
//#9602                                                                           
//#9603                            movilin[0].x=pPnt.x;                                               
//#9604                            movilin[0].y=pPnt.y;                                               
//#9605                        }                                                   
//#9606                    }                                                       
//#9607                }                                                           
//#9608                runpnt++;                                                           
//#9609            }                                                               
//#9610            if(prepnt==runpnt)                                                               
//#9611                runpnt++;                                                           
//#9612            if(!stch2px(runpnt)){                                                               
//#9613                                                                           
//#9614                if((stchs[runpnt].at&COLMSK)==col){                                                           
//#9615                                                                           
//#9616                    movilin[ind].x=pPnt.x;                                                       
//#9617                    movilin[ind++].y=pPnt.y;                                                       
//#9618                    runpnt++;                                                       
//#9619                }                                                           
//#9620            }                                                               
//#9621            SelectObject(rsdc,uPen[col]);                                                               
//#9622            Polyline(rsdc,movilin,ind);                                                               
//#9623            if(!flg)                                                               
//#9624                runpnt--;                                                           
//#9625        }                                                                   
//#9626        else{                                                                   
//#9627                                                                           
//#9628            ind=0;                                                               
//#9629            col=stchs[runpnt].at&COLMSK;                                                               
//#9630            SelectObject(rsdc,uPen[col]);                                                               
//#9631            while(ind<runum&&(runpnt+1<fin-1)&&((stchs[runpnt].at&COLMSK)==col)){                                                               
//#9632                                                                           
//#9633                stch2px1(runpnt++);                                                           
//#9634                movilin[ind].x=pPnt.x;                                                           
//#9635                movilin[ind++].y=pPnt.y;                                                           
//#9636            }                                                               
//#9637            runpnt--;                                                               
//#9638            Polyline(rsdc,movilin,ind);                                                               
//#9639        }                                                                   
//#9640        if((stchs[runpnt+1].at&0xf)!=col)                                                                   
//#9641            runpnt++;                                                               
//#9642        ritnum(STR_NUMSEL,runpnt);                                                                   
//#9643        if(runpnt+3>fin-1)                                                                   
//#9644            patdun();                                                               
//#9645    }                                                                       
//#9646                                                                           
//#9647    void stchout(){                                                                       
//#9648                                                                           
//#9649        if(chkMap(GRPSEL))                                                                   
//#9650            drwlstch(gpnt1);                                                               
//#9651        else                                                                   
//#9652            drwlstch(hed.stchs-1);                                                               
//#9653    }                                                                       
//#9654                                                                           
//#9655    unsigned duth(TCHAR* nam){                                                                       
//#9656                                                                           
//#9657        unsigned ind=strlen(nam);                                                                   
//#9658                                                                           
//#9659        do ind--;                                                                   
//#9660        while(tolower(nam[ind])!='h'&&ind);                                                                   
//#9661        if(nam[ind-1]=='t')                                                                   
//#9662            return ind+1;                                                               
//#9663        else                                                                   
//#9664            return 0;                                                               
//#9665    }                                                                       
//#9666                                                                           
//#9667    void duver(TCHAR* nam){                                                                       
//#9668                                                                           
//#9669        unsigned ind,chr;                                                                   
//#9670                                                                           
//#9671        ind=duth(nam);                                                                   
//#9672        if(ind){                                                                   
//#9673                                                                           
//#9674            chr=tolower(nam[ind])-'r';                                                               
//#9675            nam[MAX_PATH-1]=0;                                                               
//#9676            if(chr>=0&&chr<=3)                                                               
//#9677                strcpy(vernams[chr],nam);                                                           
//#9678        }                                                                   
//#9679    }                                                                       
//#9680                                                                           
//#9681    void durit(void* src,unsigned cnt){                                                                       
//#9682                                                                           
//#9683        _asm{                                                                   
//#9684                                                                           
//#9685                mov        esi,src                                                   
//#9686                mov        edi,opnt                                                   
//#9687                mov        ecx,cnt                                                   
//#9688                rep        movsb                                                   
//#9689                mov        opnt,edi                                                   
//#9690        }                                                                   
//#9691    }                                                                       
//#9692                                                                           
//#9693    unsigned bufref(){                                                                       
//#9694                                                                           
//#9695        _asm{                                                                   
//#9696                                                                           
//#9697                mov        eax,opnt                                                   
//#9698                sub        eax,offset bseq                                                   
//#9699        }                                                                   
//#9700    }                                                                       
//#9701                                                                           
//#9702    void dubuf(){                                                                       
//#9703                                                                           
//#9704        STRHED                sthed;                                                   
//#9705        unsigned            ind,ine,len,slen,elen;                                                       
//#9706        FRMHED*                theds;                                                   
//#9707        FLPNT*                tpnts;                                                   
//#9708        SATCON*                spnts;                                                   
//#9709        FLPNT*                epnts;                                                   
//#9710        unsigned            flind=0;                                                       
//#9711        unsigned            slind=0;                                                       
//#9712        unsigned            elind=0;                                                       
//#9713                                                                           
//#9714        opnt=(unsigned)&bseq;                                                                   
//#9715        sthed.led=0x2746872;                                                                   
//#9716        sthed.len=hed.stchs*sizeof(SHRTPNT)+sizeof(STRHED)+16;                                                                   
//#9717        sthed.stchs=hed.stchs;                                                                   
//#9718        sthed.hup=ini.hup;                                                                   
//#9719        len=0;slen=0;elen=0;                                                                   
//#9720        strcpy(hedx.modnam,ini.desnam);                                                                   
//#9721        if(formpnt){                                                                   
//#9722                                                                           
//#9723            for(ind=0;ind<formpnt;ind++){                                                               
//#9724                                                                           
//#9725                len+=formlst[ind].sids;                                                           
//#9726                if(formlst[ind].typ==SAT)                                                           
//#9727                    slen+=formlst[ind].stpt;                                                       
//#9728                if(isclp(ind))                                                           
//#9729                    elen+=formlst[ind].flencnt.nclp;                                                       
//#9730                if(iseclp(ind))                                                           
//#9731                    elen+=formlst[ind].nclp;                                                       
//#9732            }                                                               
//#9733        }                                                                   
//#9734        sthed.fpnt=formpnt;                                                                   
//#9735        sthed.fcnt=len;                                                                   
//#9736        sthed.scnt=slen;                                                                   
//#9737        sthed.ecnt=elen;                                                                   
//#9738        sthed.fpnts=sizeof(STRHED)+hed.stchs*sizeof(SHRTPNT)+164;                                                                   
//#9739        sthed.spnts=sizeof(FLPNT)*len;                                                                   
//#9740        sthed.epnts=sizeof(FLPNT)*elen;                                                                   
//#9741        durit(&sthed,sizeof(STRHED));                                                                   
//#9742        hedx.auxfmt=ini.auxfil;                                                                   
//#9743        hedx.xhup=ini.hupx;                                                                   
//#9744        hedx.yhup=ini.hupy;                                                                   
//#9745        hedx.txcnt=txad;                                                                   
//#9746        durit(&hedx,sizeof(STREX));                                                                   
//#9747        durit(stchs,hed.stchs*sizeof(SHRTPNT));                                                                   
//#9748        if(!bnam[0]){                                                                   
//#9749                                                                           
//#9750            for(ind=0;ind<16;ind++)                                                               
//#9751                bnam[ind]=0;                                                           
//#9752        }                                                                   
//#9753        durit(bnam,16);                                                                   
//#9754        durit(&stchBak,4);                                                                   
//#9755        durit(useCol,64);                                                                   
//#9756        durit(custCol,64);                                                                   
//#9757        for(ind=0;ind<16;ind++)                                                                   
//#9758            msgbuf[ind]=thrdSiz[ind][0];                                                               
//#9759        durit(msgbuf,16);                                                                   
//#9760        if(formpnt){                                                                   
//#9761                                                                           
//#9762            theds=new FRMHED[formpnt];                                                               
//#9763            tpnts=new FLPNT[len];                                                               
//#9764            spnts=new SATCON[slen];                                                               
//#9765            epnts=new FLPNT[elen];                                                               
//#9766            for(ind=0;ind<formpnt;ind++){                                                               
//#9767                                                                           
//#9768                frmcpy(&theds[ind],&formlst[ind]);                                                           
//#9769                theds[ind].flt=(FLPNT*)(&tpnts[flind]-&tpnts[0]);                                                           
//#9770                for(ine=0;ine<formlst[ind].sids;ine++){                                                           
//#9771                                                                           
//#9772                    tpnts[flind].x=formlst[ind].flt[ine].x;                                                       
//#9773                    tpnts[flind++].y=formlst[ind].flt[ine].y;                                                       
//#9774                }                                                           
//#9775                if(formlst[ind].typ==SAT){                                                           
//#9776                                                                           
//#9777                    theds[ind].sacang.sac=(SATCON*)(&spnts[slind]-&spnts[0]);                                                       
//#9778                    theds[ind].stpt=formlst[ind].stpt;                                                       
//#9779                    for(ine=0;ine<formlst[ind].stpt;ine++){                                                       
//#9780                                                                           
//#9781                        spnts[slind].strt=formlst[ind].sacang.sac[ine].strt;                                                   
//#9782                        spnts[slind++].fin=formlst[ind].sacang.sac[ine].fin;                                                   
//#9783                    }                                                       
//#9784                }                                                           
//#9785                if(isclp(ind)){                                                           
//#9786                                                                           
//#9787                    theds[ind].angclp.clp=(FLPNT*)(&epnts[elind]-&epnts[0]);                                                       
//#9788                    for(ine=0;ine<formlst[ind].flencnt.nclp;ine++){                                                       
//#9789                                                                           
//#9790                        epnts[elind].x=formlst[ind].angclp.clp[ine].x;                                                   
//#9791                        epnts[elind++].y=formlst[ind].angclp.clp[ine].y;                                                   
//#9792                    }                                                       
//#9793                }                                                           
//#9794                if(iseclpx(ind)){                                                           
//#9795                                                                           
//#9796                    theds[ind].clp=(FLPNT*)(&epnts[elind]-&epnts[0]);                                                       
//#9797                    for(ine=0;ine<formlst[ind].nclp;ine++){                                                       
//#9798                                                                           
//#9799                        epnts[elind].x=formlst[ind].clp[ine].x;                                                   
//#9800                        epnts[elind++].y=formlst[ind].clp[ine].y;                                                   
//#9801                    }                                                       
//#9802                }                                                           
//#9803            }                                                               
//#9804            durit(theds,formpnt*sizeof(FRMHED));                                                               
//#9805            durit(tpnts,len*sizeof(FLPNT));                                                               
//#9806            durit(spnts,slen*sizeof(SATCON));                                                               
//#9807            durit(epnts,elen*sizeof(FLPNT));                                                               
//#9808            durit(txpnts,txad*sizeof(TXPNT));                                                               
//#9809            delete theds;                                                               
//#9810            delete tpnts;                                                               
//#9811            delete spnts;                                                               
//#9812            delete epnts;                                                               
//#9813        }                                                                   
//#9814    }                                                                       
//#9815                                                                           
//#9816    void thrsav(){                                                                       
//#9817                                                                           
//#9818        unsigned            ind,len;                                                       
//#9819        int                    tind;                                               
//#9820        unsigned long        wrot;                                                           
//#9821        unsigned            flind=0;                                                       
//#9822        unsigned            slind=0;                                                       
//#9823        unsigned            elind=0;                                                       
//#9824        WIN32_FIND_DATA        fdat;                                                            
//#9825        HANDLE                hndl;                                                   
//#9826        TCHAR                nunam[MAX_PATH];                                                   
//#9827                                                                           
//#9828        if(chkattr(filnam))                                                                   
//#9829            return;                                                               
//#9830        if(!rstMap(IGNAM)){                                                                   
//#9831                                                                           
//#9832            hndl=FindFirstFile(genam,&fdat);                                                               
//#9833            ind=0;                                                               
//#9834            if(hndl!=INVALID_HANDLE_VALUE){                                                               
//#9835                                                                           
//#9836                rstMap(CMPDO);                                                           
//#9837                for(ind=0;ind<OLDVER;ind++)                                                           
//#9838                    vernams[ind][0]=0;                                                       
//#9839                duver(fdat.cFileName);                                                           
//#9840                while(FindNextFile(hndl,&fdat))                                                           
//#9841                    duver(fdat.cFileName);                                                       
//#9842                FindClose(hndl);                                                           
//#9843                DeleteFile(vernams[OLDVER-1]);                                                           
//#9844                for(tind=OLDVER-2;tind>=0;tind--){                                                           
//#9845                                                                           
//#9846                    if(vernams[tind][0]){                                                       
//#9847                                                                           
//#9848                        vernams[tind][MAX_PATH-1]=0;                                                   
//#9849                        strcpy(nunam,vernams[tind]);                                                   
//#9850                        len=duth(nunam);                                                   
//#9851                        nunam[len]=tind+'s';                                                   
//#9852                        MoveFile(vernams[tind],nunam);                                                   
//#9853                    }                                                       
//#9854                }                                                           
//#9855            }                                                               
//#9856        }                                                                   
//#9857        hFil=CreateFile(thrnam,(GENERIC_WRITE),0,NULL,                                                                   
//#9858            CREATE_ALWAYS,0,NULL);                                                               
//#9859        if(hFil==INVALID_HANDLE_VALUE){                                                                   
//#9860                                                                           
//#9861            crmsg(thrnam);                                                               
//#9862            hFil=0;                                                               
//#9863        }                                                                   
//#9864        else{                                                                   
//#9865                                                                           
//#9866            dubuf();                                                               
//#9867            WriteFile(hFil,bseq,bufref(),&wrot,0);                                                               
//#9868            if(wrot!=(unsigned long)bufref()){                                                               
//#9869                                                                           
//#9870                sprintf(msgbuf,"File Write Error: %s\n",thrnam);                                                           
//#9871                shoMsg(msgbuf);                                                           
//#9872            }                                                               
//#9873            CloseHandle(hFil);                                                               
//#9874        }                                                                   
//#9875    }                                                                       
//#9876                                                                           
//#9877    void setsped(){                                                                       
//#9878                                                                           
//#9879        unsigned    len;                                                               
//#9880        double        tdub;                                                           
//#9881                                                                           
//#9882        if(!delay)                                                                   
//#9883            delay=1;                                                               
//#9884        tdub=(double)delay/10;                                                                   
//#9885        if(tdub<10){                                                                   
//#9886                                                                           
//#9887            len=100;                                                               
//#9888            runum=(unsigned)len/tdub;                                                               
//#9889            if(runum>99)                                                               
//#9890                runum=99;                                                           
//#9891        }                                                                   
//#9892        else{                                                                   
//#9893                                                                           
//#9894            len=(unsigned)tdub;                                                               
//#9895            runum=2;                                                               
//#9896        }                                                                   
//#9897        if(runum<2)                                                                   
//#9898            runum=2;                                                               
//#9899        SetTimer(hWnd,0,len,0);                                                                   
//#9900    }                                                                       
//#9901                                                                           
//#9902    void f1del(){                                                                       
//#9903                                                                           
//#9904        unsigned cod,ind,ine;                                                                   
//#9905                                                                           
//#9906        if(chkMap(DELTO)){                                                                   
//#9907                                                                           
//#9908            cod=clofind<<FRMSHFT;                                                               
//#9909            ine=0;                                                               
//#9910            for(ind=0;ind<hed.stchs;ind++)                                                               
//#9911            {                                                               
//#9912                if((stchs[ind].at&(FRMSK|NOTFRM))!=cod)                                                           
//#9913                {                                                           
//#9914                    stchs[ine].x=stchs[ind].x;                                                       
//#9915                    stchs[ine].y=stchs[ind].y;                                                       
//#9916                    stchs[ine].at=stchs[ind].at;                                                       
//#9917                    ine++;                                                       
//#9918                }                                                           
//#9919            }                                                               
//#9920            hed.stchs=ine;                                                               
//#9921        }                                                                   
//#9922        deleclp(clofind);                                                                   
//#9923        delmclp(clofind);                                                                   
//#9924        delsac(clofind);                                                                   
//#9925        delflt(clofind);                                                                   
//#9926        deltx();                                                                   
//#9927    }                                                                       
//#9928                                                                           
//#9929    void frmdel(){                                                                       
//#9930                                                                           
//#9931        unsigned ind,ine;                                                                   
//#9932        unsigned stfrm,tind;                                                                   
//#9933                                                                           
//#9934        fvars(clofind);                                                                   
//#9935        f1del();                                                                   
//#9936        for(ind=clofind;ind<(unsigned)formpnt;ind++)                                                                   
//#9937            frmcpy(&formlst[ind],&formlst[ind+1]);                                                               
//#9938        if(rstMap(DELTO)){                                                                   
//#9939                                                                           
//#9940            ine=0;                                                               
//#9941            for(ind=0;ind<hed.stchs;ind++){                                                               
//#9942                                                                           
//#9943                if(!(stchs[ind].at&NOTFRM)){                                                           
//#9944                                                                           
//#9945                    tind=(stchs[ind].at&FRMSK);                                                       
//#9946                    stfrm=tind>>4;                                                       
//#9947                    if(stfrm>clofind){                                                       
//#9948                                                                           
//#9949                        stchs[ind].at&=NFRMSK;                                                   
//#9950                        stchs[ind].at|=(tind-0x10);                                                   
//#9951                    }                                                       
//#9952                }                                                           
//#9953            }                                                               
//#9954        }                                                                   
//#9955        else{                                                                   
//#9956                                                                           
//#9957            for(ind=0;ind<hed.stchs;ind++){                                                               
//#9958                                                                           
//#9959                if(!(stchs[ind].at&NOTFRM)){                                                           
//#9960                                                                           
//#9961                    tind=(stchs[ind].at&FRMSK);                                                       
//#9962                    stfrm=tind>>4;                                                       
//#9963                    if(stfrm==clofind)                                                       
//#9964                        stchs[ind].at&=(NFRMSK&NTYPMSK);                                                   
//#9965                    if(stfrm>clofind){                                                       
//#9966                                                                           
//#9967                        stchs[ind].at&=NFRMSK;                                                   
//#9968                        stchs[ind].at|=(tind-0x10);                                                   
//#9969                    }                                                       
//#9970                }                                                           
//#9971            }                                                               
//#9972        }                                                                   
//#9973        formpnt--;                                                                   
//#9974        rstMap(FORMSEL);                                                                   
//#9975    }                                                                       
//#9976                                                                           
//#9977    void deltot(){                                                                       
//#9978                                                                           
//#9979        strcpy(fildes,ini.desnam);                                                                   
//#9980        formpnt=hed.stchs=fltad=clpad=satkad=txad=0;                                                                   
//#9981        rstMap(GMRK);                                                                   
//#9982        rstAll();                                                                   
//#9983        coltab();                                                                   
//#9984        zumhom();                                                                   
//#9985        strcpy(fildes,ini.desnam);                                                                   
//#9986        sprintf(msgbuf,stab[STR_THRDBY],thrnam,fildes);                                                                   
//#9987        SetWindowText(hWnd,msgbuf);                                                                   
//#9988    }                                                                       
//#9989                                                                           
//#9990    BOOL wastch(){                                                                       
//#9991                                                                           
//#9992        unsigned ind;                                                                   
//#9993                                                                           
//#9994        for(ind=0;ind<hed.stchs;ind++){                                                                   
//#9995                                                                           
//#9996            if((stchs[ind].at&FRMSK)>>FRMSHFT==clofind)                                                               
//#9997                return 1;                                                           
//#9998        }                                                                   
//#9999        return 0;                                                                   
//#10000    }                                                                       
//#10001                                                                           
//#10002    BOOL frmstch()                                                                       
//#10003    {                                                                       
//#10004        unsigned ind,cod;                                                                   
//#10005                                                                           
//#10006        clRmap((formpnt>>5)>>1);                                                                   
//#10007        for(ind=0;ind<formpnt;ind++)                                                                   
//#10008            setr(selist[ind]);                                                               
//#10009        for(ind=0;ind<hed.stchs;ind++)                                                                   
//#10010        {                                                                   
//#10011            cod=(stchs[ind].at&FRMSK)>>FRMSHFT;                                                               
//#10012            if(chkr(cod))                                                               
//#10013                return 1;                                                           
//#10014        }                                                                   
//#10015        return 0;                                                                   
//#10016    }                                                                       
//#10017                                                                           
//#10018    void delet(){                                                                       
//#10019                                                                           
//#10020        unsigned ind,ine;                                                                   
//#10021        BOOL satflg;                                                                   
//#10022                                                                           
//#10023        undat();                                                                   
//#10024        satflg=0;                                                                   
//#10025        if(rstMap(FPSEL)){                                                                   
//#10026                                                                           
//#10027            savdo();                                                               
//#10028            fvars(clofind);                                                               
//#10029            clRmap((sids>>5)+1);                                                               
//#10030            ine=pselrng.strt;                                                               
//#10031            for(ind=0;ind<=pselrng.cnt;ind++){                                                               
//#10032                                                                           
//#10033                setr(ine);                                                           
//#10034                ine=pdir(ine);                                                           
//#10035            }                                                               
//#10036            ine=0;                                                               
//#10037            for(ind=0;ind<sids;ind++){                                                               
//#10038                                                                           
//#10039                if(!chkr(ind)){                                                           
//#10040                                                                           
//#10041                    flt[ine].x=flt[ind].x;                                                       
//#10042                    flt[ine].y=flt[ind].y;                                                       
//#10043                    ine++;                                                       
//#10044                }                                                           
//#10045            }                                                               
//#10046            ine=fltind(&flt[ine]);                                                               
//#10047            ind=fltind(&flt[ind]);                                                               
//#10048            while(ind<fltad){                                                               
//#10049                                                                           
//#10050                flts[ine].x=flts[ind].x;                                                           
//#10051                flts[ine].y=flts[ind].y;                                                           
//#10052                ine++;                                                           
//#10053                ind++;                                                           
//#10054            }                                                               
//#10055            for(ind=clofind+1;ind<formpnt;ind++)                                                               
//#10056                formlst[ind].flt-=(pselrng.cnt+1);                                                           
//#10057            fltad-=(pselrng.cnt+1);                                                               
//#10058            frmpnt->sids-=(pselrng.cnt+1);                                                               
//#10059            frmout(clofind);                                                               
//#10060            if(frmpnt->typ==SAT)                                                               
//#10061                satadj();                                                           
//#10062            refil();                                                               
//#10063            fndknt();                                                               
//#10064            setMap(RESTCH);                                                               
//#10065            return;                                                               
//#10066        }                                                                   
//#10067        if(GetKeyState(VK_CONTROL)&GetKeyState(VK_SHIFT)&0X8000)                                                                   
//#10068            deltot();                                                               
//#10069        else{                                                                   
//#10070                                                                           
//#10071            savdo();                                                               
//#10072            if(fselpnt){                                                               
//#10073                                                                           
//#10074                if(frmstch())                                                           
//#10075                {                                                           
//#10076                    setMap(DELSFRMS);                                                       
//#10077                    tabmsg(IDS_DELFRM);                                                       
//#10078                    okcan();                                                       
//#10079                    tomsg();                                                       
//#10080                }                                                           
//#10081                else                                                           
//#10082                    delsfrms(1);                                                       
//#10083                return;                                                           
//#10084            }                                                               
//#10085            if(chkMap(FORMSEL)&&formpnt){                                                               
//#10086                                                                           
//#10087                if(wastch()){                                                           
//#10088                                                                           
//#10089                    setMap(DELFRM);                                                       
//#10090                    tabmsg(IDS_FDEL);                                                       
//#10091                    okcan();                                                       
//#10092                    tomsg();                                                       
//#10093                }                                                           
//#10094                else{                                                           
//#10095                                                                           
//#10096                    if(formpnt){                                                       
//#10097                                                                           
//#10098                        rstMap(DELTO);                                                   
//#10099                        frmdel();                                                   
//#10100                        setMap(RESTCH);                                                   
//#10101                    }                                                       
//#10102                }                                                           
//#10103                fndknt();                                                           
//#10104                return;                                                           
//#10105            }                                                               
//#10106            if(chkMap(SELBOX)){                                                               
//#10107                                                                           
//#10108    selab:;                                                                       
//#10109                if(hed.stchs>2){                                                           
//#10110                                                                           
//#10111                    delstch1(cloInd);                                                       
//#10112                    if(!stch2px(cloInd))                                                       
//#10113                        movbox();                                                   
//#10114                }                                                           
//#10115                else{                                                           
//#10116                                                                           
//#10117                    hed.stchs=0;                                                       
//#10118                    rstMap(SELBOX);                                                       
//#10119                }                                                           
//#10120                coltab();                                                           
//#10121                setfchk();                                                           
//#10122                fndknt();                                                           
//#10123                setMap(RESTCH);                                                           
//#10124                return;                                                           
//#10125            }                                                               
//#10126            if(chkMap(GRPSEL)){                                                               
//#10127                                                                           
//#10128                delstchm();                                                           
//#10129                coltab();                                                           
//#10130                rstAll();                                                           
//#10131                setfchk();                                                           
//#10132                fndknt();                                                           
//#10133                setMap(RESTCH);                                                           
//#10134                return;                                                           
//#10135            }                                                               
//#10136            if(chkMap(FRMPSEL)||closfrm()){                                                               
//#10137                                                                           
//#10138                frmpnt=&formlst[clofind];                                                           
//#10139                switch(frmpnt->typ){                                                           
//#10140                                                                           
//#10141                case LIN:                                                           
//#10142                                                                           
//#10143                    if(frmpnt->ftyp==CONTF){                                                       
//#10144                                                                           
//#10145                        if(clofine==frmpnt->angclp.sat.strt||clofine==frmpnt->angclp.sat.fin){                                                   
//#10146                                                                           
//#10147                            delmfil(frmpnt->fcol);                                               
//#10148                            frmpnt->ftyp=0;                                               
//#10149                            coltab();                                               
//#10150                            setMap(RESTCH);                                               
//#10151                            return;                                               
//#10152                        }                                                   
//#10153                        if(frmpnt->angclp.sat.strt>clofine)                                                   
//#10154                            frmpnt->angclp.sat.strt--;                                               
//#10155                        if(frmpnt->angclp.sat.fin>clofine)                                                   
//#10156                            frmpnt->angclp.sat.fin--;                                               
//#10157                    }                                                       
//#10158                    break;                                                       
//#10159                                                                           
//#10160                case SAT:                                                           
//#10161                                                                           
//#10162                    if(clofine<=1){                                                       
//#10163                                                                           
//#10164                        if(frmpnt->at&FRMEND){                                                   
//#10165                                                                           
//#10166                            if(frmpnt->wpar)                                               
//#10167                                frmpnt->wpar=0;                                           
//#10168                            else                                               
//#10169                                frmpnt->at&=0xfe;                                           
//#10170                            satflg=1;                                               
//#10171                            goto deldun;                                               
//#10172                        }                                                   
//#10173                    }                                                       
//#10174                    if(wpar){                                                       
//#10175                                                                           
//#10176                        if(clofine==(unsigned)wpar||clofine==(unsigned)wpar+1){                                                   
//#10177                                                                           
//#10178                            frmpnt->wpar=0;                                               
//#10179                            satflg=1;                                               
//#10180                            goto deldun;                                               
//#10181                        }                                                   
//#10182                    }                                                       
//#10183                    for(ind=0;ind<frmpnt->stpt;ind++){                                                       
//#10184                                                                           
//#10185                        if(frmpnt->sacang.sac[ind].strt==clofine||frmpnt->sacang.sac[ind].fin==clofine){                                                   
//#10186                                                                           
//#10187                            delcon(ind);                                               
//#10188                            satflg=1;                                               
//#10189                            goto deldun;                                               
//#10190                        }                                                   
//#10191                    }                                                       
//#10192                }                                                           
//#10193                delspnt();                                                           
//#10194    deldun:;                                                                       
//#10195               if(clofind>formpnt-1)                                                               
//#10196                   clofind=formpnt-1;                                                           
//#10197                if(formpnt){                                                           
//#10198                                                                           
//#10199                    frmout(clofind);                                                       
//#10200                    fvars(clofind);                                                       
//#10201                    refil();                                                       
//#10202                }                                                           
//#10203                coltab();                                                           
//#10204                setMap(RESTCH);                                                           
//#10205            }                                                               
//#10206            if(!satflg&&closPnt1(&cloInd))                                                               
//#10207                goto selab;                                                           
//#10208        }                                                                   
//#10209        fndknt();                                                                   
//#10210    }                                                                       
//#10211                                                                           
//#10212    void movi(){                                                                       
//#10213                                                                           
//#10214        double tdub;                                                                   
//#10215                                                                           
//#10216        rstAll();                                                                   
//#10217        if(hed.stchs){                                                                   
//#10218                                                                           
//#10219            if(hMsg){                                                               
//#10220                                                                           
//#10221                DestroyWindow(hMsg);                                                           
//#10222                hMsg=0;                                                           
//#10223            }                                                               
//#10224            setMap(RUNPAT);                                                               
//#10225            if(chkMap(GRPSEL)){                                                               
//#10226                                                                           
//#10227                rngadj();                                                           
//#10228                runpnt=gpnt0;                                                           
//#10229            }                                                               
//#10230            else                                                               
//#10231                runpnt=0;                                                           
//#10232            movStch();                                                               
//#10233            if(!chkMap(WASPAT)){                                                               
//#10234                                                                           
//#10235                hSped=CreateWindow(                                                           
//#10236                    SCROLLBAR,                                                       
//#10237                    0                                                       
//#10238                    SBS_HORZ|WS_CHILD|WS_VISIBLE,                                                       
//#10239                    buttonWid3,                                                       
//#10240                    0                                                       
//#10241                    stchSiz.x,                                                       
//#10242                    SCROLSIZ,                                                       
//#10243                    hWnd,                                                       
//#10244                    NULL,                                                       
//#10245                    hInst,                                                       
//#10246                    NULL);                                                       
//#10247            }                                                               
//#10248            if(chkMap(ZUMED))                                                               
//#10249                tdub=hed.stchs*zumFct*zumFct;                                                           
//#10250            else                                                               
//#10251                tdub=hed.stchs;                                                           
//#10252            if(!chkMap(WASPAT))                                                               
//#10253                delay=MOVITIM*10000/tdub;                                                           
//#10254            if(delay<MINDELAY)                                                               
//#10255                delay=MINDELAY;                                                           
//#10256            if(delay>MAXDELAY)                                                               
//#10257                delay=MAXDELAY;                                                           
//#10258            scrol.cbSize=sizeof(scrol);                                                               
//#10259            scrol.fMask=SIF_ALL;                                                               
//#10260            scrol.nMax=MAXDELAY;                                                               
//#10261            scrol.nMin=MINDELAY;                                                               
//#10262            scrol.nPage=1;                                                               
//#10263            scrol.nPos=MAXDELAY-delay;                                                               
//#10264            SetScrollInfo(hSped,SB_CTL,&scrol,TRUE);                                                               
//#10265            FillRect(rsdc,&scRct,hStchBak);                                                               
//#10266            setsped();                                                               
//#10267        }                                                                   
//#10268    }                                                                       
//#10269                                                                           
//#10270    #define CLPBUG 0                                                                       
//#10271                                                                           
//#10272    void redclp(){                                                                       
//#10273                                                                           
//#10274        int        ind,playcod;                                                           
//#10275                                                                           
//#10276        playcod=actl<<LAYSHFT;                                                                   
//#10277        clpvoid=GlobalLock(hClpMem);                                                                   
//#10278        clpdat=(CLPSTCH*)clpvoid;                                                                   
//#10279        clplen=clpdat[0].led;                                                                   
//#10280        clpnu[0].x=clpdat[0].x+(float)clpdat[0].fx/256;                                                                   
//#10281        clpnu[0].y=clpdat[0].y+(float)clpdat[0].fy/256;                                                                   
//#10282        clpnu[0].at=0;                                                                   
//#10283                                                                           
//#10284    #if CLPBUG                                                                       
//#10285                                                                           
//#10286            sprintf(msgbuf,"ind: 0 x: %6.2f,y: %6.2f\n",clpnu[0].x,clpnu[0].y);                                                               
//#10287            OutputDebugString(msgbuf);                                                               
//#10288    #endif                                                                       
//#10289        clprct.left=clprct.right=clpnu[0].x;                                                                   
//#10290        clprct.bottom=clprct.top=clpnu[0].y;                                                                   
//#10291        for(ind=1;ind<(long)clplen;ind++){                                                                   
//#10292                                                                           
//#10293            clpnu[ind].x=clpdat[ind].x+(float)clpdat[ind].fx/256;                                                               
//#10294            clpnu[ind].y=clpdat[ind].y+(float)clpdat[ind].fy/256;                                                               
//#10295            clpnu[ind].at=(clpdat[ind].led&0xf)|playcod;                                                               
//#10296                                                                           
//#10297    #if CLPBUG                                                                       
//#10298                                                                           
//#10299            sprintf(msgbuf,"ind: %d x: %6.2f,y: %6.2f\n",ind,clpnu[ind].x,clpnu[ind].y);                                                               
//#10300            OutputDebugString(msgbuf);                                                               
//#10301    #endif                                                                       
//#10302            if(clpnu[ind].x<clprct.left)                                                               
//#10303                clprct.left=clpnu[ind].x;                                                           
//#10304            if(clpnu[ind].x>clprct.right)                                                               
//#10305                clprct.right=clpnu[ind].x;                                                           
//#10306            if(clpnu[ind].y<clprct.bottom)                                                               
//#10307                clprct.bottom=clpnu[ind].y;                                                           
//#10308            if(clpnu[ind].y>clprct.top)                                                               
//#10309                clprct.top=clpnu[ind].y;                                                           
//#10310        }                                                                   
//#10311        clpnu[0].at=actcol|playcod;                                                                   
//#10312        clpsiz.cx=clprct.right-clprct.left;                                                                   
//#10313        clpsiz.cy=clprct.top-clprct.bottom;                                                                   
//#10314        GlobalUnlock(hClpMem);                                                                   
//#10315        if(clprct.left||clprct.bottom){                                                                   
//#10316                                                                           
//#10317            for(ind=0;ind<(int)clplen;ind++){                                                               
//#10318                                                                           
//#10319                clpnu[ind].x-=clprct.left;                                                           
//#10320                clpnu[ind].y-=clprct.bottom;                                                           
//#10321            }                                                               
//#10322            clprct.top-=clprct.bottom;                                                               
//#10323            clprct.right-=clprct.left;                                                               
//#10324            clprct.bottom=clprct.left=0;                                                               
//#10325        }                                                                   
//#10326    }                                                                       
//#10327                                                                           
//#10328    unsigned nxtcrnr(unsigned ind){                                                                       
//#10329                                                                           
//#10330        _asm{                                                                   
//#10331                                                                           
//#10332                mov        eax,ind                                                   
//#10333                inc        eax                                                   
//#10334                and        al,3                                                   
//#10335        }                                                                   
//#10336    }                                                                       
//#10337                                                                           
//#10338    void drwmrk(HDC dc){                                                                       
//#10339                                                                           
//#10340        POINT pxpnt;                                                                   
//#10341        POINT mlin[2];                                                                   
//#10342                                                                           
//#10343        sCor2px(mrkpnt,&pxpnt);                                                                   
//#10344        SelectObject(dc,mrkPen);                                                                   
//#10345        SetROP2(dc,R2_XORPEN);                                                                   
//#10346        mlin[0].x=pxpnt.x-6;                                                                   
//#10347        mlin[0].y=pxpnt.y-6;                                                                   
//#10348        mlin[1].x=pxpnt.x+6;                                                                   
//#10349        mlin[1].y=pxpnt.y+6;                                                                   
//#10350        Polyline(dc,mlin,2);                                                                   
//#10351        mlin[0].x=pxpnt.x-6;                                                                   
//#10352        mlin[0].y=pxpnt.y+6;                                                                   
//#10353        mlin[1].x=pxpnt.x+6;                                                                   
//#10354        mlin[1].y=pxpnt.y-6;                                                                   
//#10355        Polyline(dc,mlin,2);                                                                   
//#10356        SetROP2(dc,R2_COPYPEN);                                                                   
//#10357    }                                                                       
//#10358                                                                           
//#10359    void vubak(){                                                                       
//#10360                                                                           
//#10361        unsigned    ind;                                                               
//#10362        long        dx,dy,vloc;                                                           
//#10363                                                                           
//#10364        if(hFil||chkMap(THUMSHO)){                                                                   
//#10365                                                                           
//#10366            setMap(ZUMED);                                                               
//#10367            movStch();                                                               
//#10368            FillRect(sdc,&scRct,hStchBak);                                                               
//#10369            dx=(scRct.right>>1);                                                               
//#10370            dy=(scRct.bottom>>1);                                                               
//#10371            for(ind=0;ind<OLDVER;ind++){                                                               
//#10372                                                                           
//#10373                if(ind&2)                                                           
//#10374                    vloc=dy;                                                       
//#10375                else                                                           
//#10376                    vloc=0;                                                       
//#10377                hvu[ind]=CreateWindow(                                                           
//#10378                    STATIC,                                                       
//#10379                    ,                                                       
//#10380                    SS_NOTIFY|SS_OWNERDRAW|WS_CHILD|WS_VISIBLE|WS_BORDER,                                                       
//#10381                    dx*(ind&1)+buttonWid3,                                                       
//#10382                    vloc,                                                       
//#10383                    dx,                                                       
//#10384                    dy,                                                       
//#10385                    hWnd,                                                       
//#10386                    NULL,                                                       
//#10387                    hInst,                                                       
//#10388                    NULL);                                                       
//#10389            }                                                               
//#10390            setMap(BAKSHO);                                                               
//#10391        }                                                                   
//#10392    }                                                                       
//#10393                                                                           
//#10394    void getbak(){                                                                       
//#10395                                                                           
//#10396        TCHAR*        pchr;                                                           
//#10397                                                                           
//#10398        if(chkMap(THUMSHO)){                                                                   
//#10399                                                                           
//#10400            if(thumsel[baknum]){                                                               
//#10401                                                                           
//#10402                if(chkMap(RBUT)){                                                           
//#10403                                                                           
//#10404                    strcpy(insnam,thumsel[baknum]);                                                       
//#10405                    setMap(IGNORINS);                                                       
//#10406                    unthum();                                                       
//#10407                    setMap(FRMOF);                                                       
//#10408                    insfil();                                                       
//#10409                    if(GetKeyState(VK_SHIFT)&0X8000){                                                       
//#10410                                                                           
//#10411                        rstMap(INSFIL);                                                   
//#10412                        rstMap(FRMOF);                                                   
//#10413                        setMap(INIT);                                                   
//#10414                        coltab();                                                   
//#10415                        setMap(RESTCH);                                                   
//#10416                    }                                                       
//#10417                }                                                           
//#10418                else{                                                           
//#10419                                                                           
//#10420                    strcpy(filnam,defDir);                                                       
//#10421                    pchr=&filnam[strlen(filnam)-1];                                                       
//#10422                    if(pchr[0]!='\\'){                                                       
//#10423                                                                           
//#10424                        pchr[1]='\\';                                                   
//#10425                        pchr[2]=0;                                                   
//#10426                    }                                                       
//#10427                    strcat(filnam,thumsel[baknum]);                                                       
//#10428                    setMap(REDOLD);                                                       
//#10429                    nuFil();                                                       
//#10430                }                                                           
//#10431            }                                                               
//#10432            else                                                               
//#10433                unthum();                                                           
//#10434        }                                                                   
//#10435    }                                                                       
//#10436                                                                           
//#10437    void rebak(){                                                                       
//#10438                                                                           
//#10439        unsigned    ind;                                                               
//#10440        TCHAR        tnaml[MAX_PATH];                                                           
//#10441        TCHAR        tnamx[MAX_PATH];                                                           
//#10442                                                                           
//#10443        for(ind=0;ind<OLDVER;ind++)                                                                   
//#10444            DestroyWindow(hvu[ind]);                                                               
//#10445        strcpy(tnaml,thrnam);                                                                   
//#10446        strcpy(tnamx,thrnam);                                                                   
//#10447        ind=duth(tnaml);                                                                   
//#10448        tnaml[ind]=baknum+'s';                                                                   
//#10449        tnamx[ind]='x';                                                                   
//#10450        MoveFile(thrnam,tnamx);                                                                   
//#10451        MoveFile(tnaml,thrnam);                                                                   
//#10452        MoveFile(tnamx,tnaml);                                                                   
//#10453        strcpy(filnam,thrnam);                                                                   
//#10454        setMap(REDOLD);                                                                   
//#10455        nuFil();                                                                   
//#10456        DeleteFile(tnamx);                                                                   
//#10457    }                                                                       
//#10458                                                                           
//#10459    void thumbak(){                                                                       
//#10460                                                                           
//#10461        unsigned ind;                                                                   
//#10462                                                                           
//#10463        for(ind=0;ind<OLDVER;ind++)                                                                   
//#10464            DestroyWindow(hvu[ind]);                                                               
//#10465        getbak();                                                                   
//#10466    }                                                                       
//#10467                                                                           
//#10468    void movbak(TCHAR src,TCHAR dst){                                                                       
//#10469                                                                           
//#10470        TCHAR    strsrc[MAX_PATH];                                                               
//#10471        TCHAR    strdst[MAX_PATH];                                                               
//#10472                                                                           
//#10473        unsigned ind=duth(thrnam);                                                                   
//#10474                                                                           
//#10475        strcpy(strsrc,thrnam);                                                                   
//#10476        strcpy(strdst,thrnam);                                                                   
//#10477        strsrc[ind]=(TCHAR)src;                                                                   
//#10478        strdst[ind]=(TCHAR)dst;                                                                   
//#10479        DeleteFile(strdst);                                                                   
//#10480        MoveFile(strsrc,strdst);                                                                   
//#10481    }                                                                       
//#10482                                                                           
//#10483    void purg(){                                                                       
//#10484                                                                           
//#10485        TCHAR        tnam[MAX_PATH];                                                           
//#10486        unsigned    pind,ind;                                                               
//#10487                                                                           
//#10488        if(hFil){                                                                   
//#10489                                                                           
//#10490            strcpy(tnam,thrnam);                                                               
//#10491            pind=duth(tnam);                                                               
//#10492            for(ind=1;ind<6;ind++){                                                               
//#10493                                                                           
//#10494                tnam[pind]=(TCHAR)ind+'r';                                                           
//#10495                DeleteFile(tnam);                                                           
//#10496            }                                                               
//#10497        }                                                                   
//#10498    }                                                                       
//#10499                                                                           
//#10500    void purgdir(){                                                                       
//#10501                                                                           
//#10502        setMap(PRGMSG);                                                                   
//#10503        sprintf(msgbuf,"Delete all backups in %s\n",defDir);                                                                   
//#10504        shoMsg(msgbuf);                                                                   
//#10505        okcan();                                                                   
//#10506    }                                                                       
//#10507                                                                           
//#10508    void deldir(){                                                                       
//#10509                                                                           
//#10510        unsigned            ind;                                                       
//#10511        TCHAR                tnam[MAX_PATH];                                                   
//#10512        TCHAR*                pchr;                                                   
//#10513        WIN32_FIND_DATA        fdat;                                                           
//#10514        HANDLE                hndl;                                                   
//#10515                                                                           
//#10516        unmsg();                                                                   
//#10517        tabmsg(IDS_BAKDEL);                                                                   
//#10518        strcpy(tnam,defDir);                                                                   
//#10519        pchr=&tnam[strlen(tnam)];                                                                   
//#10520        strcpy(pchr,"\\*.th0");                                                                   
//#10521        for(ind=1;ind<6;ind++){                                                                   
//#10522                                                                           
//#10523            pchr[5]=(TCHAR)ind+'r';                                                               
//#10524            hndl=FindFirstFile(tnam,&fdat);                                                               
//#10525            if(hndl!=INVALID_HANDLE_VALUE){                                                               
//#10526                                                                           
//#10527                DeleteFile(fdat.cFileName);                                                           
//#10528                while(FindNextFile(hndl,&fdat))                                                           
//#10529                    DeleteFile(fdat.cFileName);                                                       
//#10530            }                                                               
//#10531            FindClose(hndl);                                                               
//#10532        }                                                                   
//#10533        unmsg();                                                                   
//#10534        tabmsg(IDS_BAKDT);                                                                   
//#10535    }                                                                       
//#10536                                                                           
//#10537    BOOL chkwnd(HWND hwind){                                                                       
//#10538                                                                           
//#10539        RECT    trct;                                                               
//#10540                                                                           
//#10541        GetWindowRect(hwind,&trct);                                                                   
//#10542        if(msg.pt.x>=trct.left&&msg.pt.x<=trct.right                                                                   
//#10543                &&msg.pt.y>=trct.top&&msg.pt.y<=trct.bottom)                                                           
//#10544            return 1;                                                               
//#10545        else                                                                   
//#10546            return 0;                                                               
//#10547    }                                                                       
//#10548                                                                           
//#10549    BOOL chkok(){                                                                       
//#10550                                                                           
//#10551        return chkwnd(hok);                                                                   
//#10552    }                                                                       
//#10553                                                                           
//#10554    void mv2f(){                                                                       
//#10555                                                                           
//#10556        unsigned    at,lo,hi,ind;                                                               
//#10557                                                                           
//#10558        if(rstMap(FORMSEL)){                                                                   
//#10559                                                                           
//#10560            savdo();                                                               
//#10561            lo=0;                                                               
//#10562            hi=MAXPCS>>1;                                                               
//#10563            at=clofind<<4;                                                               
//#10564            for(ind=0;ind<hed.stchs;ind++){                                                               
//#10565                                                                           
//#10566                if(!(stchs[ind].at&NOTFRM)&&(stchs[ind].at&FRMSK)==at){                                                           
//#10567                                                                           
//#10568                    stchs[lo].at=stchs[ind].at;                                                       
//#10569                    stchs[lo].x=stchs[ind].x;                                                       
//#10570                    stchs[lo++].y=stchs[ind].y;                                                       
//#10571                }                                                           
//#10572                else{                                                           
//#10573                                                                           
//#10574                    stchs[hi].at=stchs[ind].at;                                                       
//#10575                    stchs[hi].x=stchs[ind].x;                                                       
//#10576                    stchs[hi++].y=stchs[ind].y;                                                       
//#10577                }                                                           
//#10578            }                                                               
//#10579            ind=MAXPCS>>1;                                                               
//#10580            while(ind<hi){                                                               
//#10581                                                                           
//#10582                stchs[lo].at=stchs[ind].at;                                                           
//#10583                stchs[lo].x=stchs[ind].x;                                                           
//#10584                stchs[lo++].y=stchs[ind++].y;                                                           
//#10585            }                                                               
//#10586            coltab();                                                               
//#10587            setMap(RESTCH);                                                               
//#10588        }                                                                   
//#10589        else{                                                                   
//#10590                                                                           
//#10591            if(rstMap(GRPSEL)){                                                               
//#10592                                                                           
//#10593                savdo();                                                           
//#10594                rngadj();                                                           
//#10595                hi=MAXPCS>>1;                                                           
//#10596                lo=0;                                                           
//#10597                for(ind=0;ind<gpnt0;ind++){                                                           
//#10598                                                                           
//#10599                    stchs[hi].at=stchs[ind].at;                                                       
//#10600                    stchs[hi].x=stchs[ind].x;                                                       
//#10601                    stchs[hi++].y=stchs[ind].y;                                                       
//#10602                }                                                           
//#10603                for(ind=gpnt1;ind<hed.stchs;ind++){                                                           
//#10604                                                                           
//#10605                    stchs[hi].at=stchs[ind].at;                                                       
//#10606                    stchs[hi].x=stchs[ind].x;                                                       
//#10607                    stchs[hi++].y=stchs[ind].y;                                                       
//#10608                }                                                           
//#10609                for(ind=gpnt0;ind<gpnt1;ind++){                                                           
//#10610                                                                           
//#10611                    stchs[lo].at=stchs[ind].at;                                                       
//#10612                    stchs[lo].x=stchs[ind].x;                                                       
//#10613                    stchs[lo++].y=stchs[ind].y;                                                       
//#10614                }                                                           
//#10615                for(ind=MAXPCS>>1;ind<hi;ind++){                                                           
//#10616                                                                           
//#10617                    stchs[lo].at=stchs[ind].at;                                                       
//#10618                    stchs[lo].x=stchs[ind].x;                                                       
//#10619                    stchs[lo++].y=stchs[ind].y;                                                       
//#10620                }                                                           
//#10621                coltab();                                                           
//#10622                setMap(RESTCH);                                                           
//#10623            }                                                               
//#10624        }                                                                   
//#10625    }                                                                       
//#10626                                                                           
//#10627    void mv2b(){                                                                       
//#10628                                                                           
//#10629        unsigned    at,lo,hi,ind;                                                               
//#10630                                                                           
//#10631        if(rstMap(FORMSEL)){                                                                   
//#10632                                                                           
//#10633            savdo();                                                               
//#10634            lo=0;                                                               
//#10635            hi=MAXPCS>>1;                                                               
//#10636            at=clofind<<4;                                                               
//#10637            for(ind=0;ind<hed.stchs;ind++){                                                               
//#10638                                                                           
//#10639                if(!(stchs[ind].at&NOTFRM)&&(stchs[ind].at&FRMSK)==at){                                                           
//#10640                                                                           
//#10641                    stchs[hi].at=stchs[ind].at;                                                       
//#10642                    stchs[hi].x=stchs[ind].x;                                                       
//#10643                    stchs[hi++].y=stchs[ind].y;                                                       
//#10644                }                                                           
//#10645                else{                                                           
//#10646                                                                           
//#10647                    stchs[lo].at=stchs[ind].at;                                                       
//#10648                    stchs[lo].x=stchs[ind].x;                                                       
//#10649                    stchs[lo++].y=stchs[ind].y;                                                       
//#10650                }                                                           
//#10651            }                                                               
//#10652            ind=MAXPCS>>1;                                                               
//#10653            while(ind<hi){                                                               
//#10654                                                                           
//#10655                stchs[lo].at=stchs[ind].at;                                                           
//#10656                stchs[lo].x=stchs[ind].x;                                                           
//#10657                stchs[lo++].y=stchs[ind++].y;                                                           
//#10658            }                                                               
//#10659            coltab();                                                               
//#10660            setMap(RESTCH);                                                               
//#10661        }                                                                   
//#10662        else{                                                                   
//#10663                                                                           
//#10664            if(rstMap(GRPSEL)){                                                               
//#10665                                                                           
//#10666                savdo();                                                           
//#10667                rngadj();                                                           
//#10668                hi=MAXPCS>>1;                                                           
//#10669                for(ind=gpnt0;ind<gpnt1;ind++){                                                           
//#10670                                                                           
//#10671                    stchs[hi].at=stchs[ind].at;                                                       
//#10672                    stchs[hi].x=stchs[ind].x;                                                       
//#10673                    stchs[hi++].y=stchs[ind].y;                                                       
//#10674                }                                                           
//#10675                lo=gpnt0;                                                           
//#10676                for(ind=gpnt1;ind<hed.stchs;ind++){                                                           
//#10677                                                                           
//#10678                    stchs[lo].at=stchs[ind].at;                                                       
//#10679                    stchs[lo].x=stchs[ind].x;                                                       
//#10680                    stchs[lo++].y=stchs[ind].y;                                                       
//#10681                }                                                           
//#10682                for(ind=MAXPCS>>1;ind<hi;ind++){                                                           
//#10683                                                                           
//#10684                    stchs[lo].at=stchs[ind].at;                                                       
//#10685                    stchs[lo].x=stchs[ind].x;                                                       
//#10686                    stchs[lo++].y=stchs[ind].y;                                                       
//#10687                }                                                           
//#10688                coltab();                                                           
//#10689                setMap(RESTCH);                                                           
//#10690            }                                                               
//#10691        }                                                                   
//#10692    }                                                                       
//#10693                                                                           
//#10694    void infadj(float* px,float* py){                                                                       
//#10695                                                                           
//#10696        if(!_finite(*px)){                                                                   
//#10697                                                                           
//#10698            if(*px>zum0.x)                                                               
//#10699                *px=zum0.x;                                                           
//#10700            else{                                                               
//#10701                                                                           
//#10702                if(*px<0)                                                           
//#10703                    *px=0;                                                       
//#10704            }                                                               
//#10705        }                                                                   
//#10706        if(!_finite(*py)){                                                                   
//#10707                                                                           
//#10708            if(*py>zum0.y)                                                               
//#10709                *py=zum0.y;                                                           
//#10710            else{                                                               
//#10711                                                                           
//#10712                if(*py<0)                                                           
//#10713                    *py=0;                                                       
//#10714            }                                                               
//#10715        }                                                                   
//#10716    }                                                                       
//#10717                                                                           
//#10718    void delinf(){                                                                       
//#10719                                                                           
//#10720        unsigned ind;                                                                   
//#10721                                                                           
//#10722        for(ind=0;ind<hed.stchs;ind++)                                                                   
//#10723            infadj(&stchs[ind].x,&stchs[ind].y);                                                               
//#10724        for(ind=0;ind<fltad;ind++)                                                                   
//#10725            infadj(&flts[ind].x,&flts[ind].y);                                                               
//#10726    }                                                                       
//#10727                                                                           
//#10728    void chkrng(FLPNT* rsiz){                                                                       
//#10729                                                                           
//#10730        unsigned    ind,ine=0;                                                               
//#10731                                                                           
//#10732        delinf();                                                                   
//#10733        rsiz->x=zum0.x;                                                                   
//#10734        rsiz->y=zum0.y;                                                                   
//#10735        if(formpnt){                                                                   
//#10736                                                                           
//#10737            for(ind=0;ind<hed.stchs;ind++){                                                               
//#10738                                                                           
//#10739                if(stchs[ind].at&NOTFRM                                                           
//#10740                    ||((stchs[ind].at&TYPMSK)&&((stchs[ind].at&FRMSK)>>FRMSHFT<formpnt))){                                                       
//#10741                    stchs[ine].at=stchs[ind].at;                                                       
//#10742                    stchs[ine].x=stchs[ind].x;                                                       
//#10743                    stchs[ine].y=stchs[ind].y;                                                       
//#10744                    if(stchs[ine].x>rsiz->x)                                                       
//#10745                        stchs[ine].x=rsiz->x-1;                                                   
//#10746                    if(stchs[ine].x<0)                                                       
//#10747                        stchs[ine].x=0;                                                   
//#10748                    if(stchs[ine].y>rsiz->y)                                                       
//#10749                        stchs[ine].y=rsiz->y-1;                                                   
//#10750                    if(stchs[ine].y<0)                                                       
//#10751                        stchs[ine].y=0;                                                   
//#10752                    ine++;                                                       
//#10753                }                                                           
//#10754            }                                                               
//#10755            hed.stchs=ine;                                                               
//#10756        }                                                                   
//#10757        else{                                                                   
//#10758                                                                           
//#10759            for(ind=0;ind<hed.stchs;ind++){                                                               
//#10760                                                                           
//#10761                if(stchs[ind].x>rsiz->x)                                                           
//#10762                    stchs[ind].x=rsiz->x-1;                                                       
//#10763                if(stchs[ind].x<0)                                                           
//#10764                    stchs[ind].x=0;                                                       
//#10765                if(stchs[ind].y>rsiz->y)                                                           
//#10766                    stchs[ind].y=rsiz->y-1;                                                       
//#10767                if(stchs[ind].y<0)                                                           
//#10768                    stchs[ind].y=0;                                                       
//#10769            }                                                               
//#10770        }                                                                   
//#10771    }                                                                       
//#10772                                                                           
//#10773    void ritmov(){                                                                       
//#10774                                                                           
//#10775        SetROP2(rsdc,R2_XORPEN);                                                                   
//#10776        SelectObject(rsdc,fPen);                                                                   
//#10777        if(clofine){                                                                   
//#10778                                                                           
//#10779            if(clofine==(unsigned)frmpnt->sids-1&&frmpnt->typ==LIN)                                                               
//#10780                Polyline(rsdc,mvlin,2);                                                           
//#10781            else                                                               
//#10782                Polyline(rsdc,mvlin,3);                                                           
//#10783        }                                                                   
//#10784        else{                                                                   
//#10785                                                                           
//#10786            mvlin[2].x=flin[1].x;                                                               
//#10787            mvlin[2].y=flin[1].y;                                                               
//#10788            if(frmpnt->typ==LIN)                                                               
//#10789                Polyline(rsdc,&mvlin[1],2);                                                           
//#10790            else                                                               
//#10791                Polyline(rsdc,mvlin,3);                                                           
//#10792        }                                                                   
//#10793        SetROP2(rsdc,R2_COPYPEN);                                                                   
//#10794    }                                                                       
//#10795                                                                           
//#10796    void unmov(){                                                                       
//#10797                                                                           
//#10798        if(rstMap(SHOMOV))                                                                   
//#10799            ritmov();                                                               
//#10800    }                                                                       
//#10801                                                                           
//#10802    void duprct(){                                                                       
//#10803                                                                           
//#10804        unsigned ind,strt;                                                                   
//#10805                                                                           
//#10806        strt=pselrng.strt;                                                                   
//#10807        pselrct.left=pselrct.right=flt[strt].x;                                                                   
//#10808        pselrct.top=pselrct.bottom=flt[strt].y;                                                                   
//#10809        strt=pdir(strt);                                                                   
//#10810        for(ind=0;ind<pselrng.cnt;ind++){                                                                   
//#10811                                                                           
//#10812            if(flt[strt].x<pselrct.left)                                                               
//#10813                pselrct.left=flt[strt].x;                                                           
//#10814            if(flt[strt].x>pselrct.right)                                                               
//#10815                pselrct.right=flt[strt].x;                                                           
//#10816            if(flt[strt].y<pselrct.bottom)                                                               
//#10817                pselrct.bottom=flt[strt].y;                                                           
//#10818            if(flt[strt].y>pselrct.top)                                                               
//#10819                pselrct.top=flt[strt].y;                                                           
//#10820            strt=pdir(strt);                                                               
//#10821        }                                                                   
//#10822    }                                                                       
//#10823                                                                           
//#10824    void setpsel(){                                                                       
//#10825                                                                           
//#10826        unpsel();                                                                   
//#10827        duprct();                                                                   
//#10828        sRct2px(pselrct,&pxselrct);                                                                   
//#10829        rct2sel(pxselrct,pselin);                                                                   
//#10830        sfCor2px(flt[pselrng.fin],&pselfin);                                                                   
//#10831        setMap(SHOPSEL);                                                                   
//#10832        dupsel(rsdc);                                                                   
//#10833        setMap(FPSEL);                                                                   
//#10834    }                                                                       
//#10835                                                                           
//#10836    void rotfn(){                                                                       
//#10837                                                                           
//#10838        unsigned    ind,ine;                                                               
//#10839        double        len;                                                           
//#10840        double        tang;                                                           
//#10841        DUBPNT        trot;                                                           
//#10842        unsigned    dst;                                                               
//#10843                                                                           
//#10844        savdo();                                                                   
//#10845        if(chkMap(FPSEL)){                                                                   
//#10846                                                                           
//#10847            fvars(clofind);                                                               
//#10848            ine=pselrng.strt;                                                               
//#10849            for(ind=0;ind<=pselrng.cnt;ind++){                                                               
//#10850                                                                           
//#10851                rotflt(&flt[ine]);                                                           
//#10852                ine=pdir(ine);                                                           
//#10853            }                                                               
//#10854            frmout(clofind);                                                               
//#10855            setpsel();                                                               
//#10856            refil();                                                               
//#10857            setMap(RESTCH);                                                               
//#10858            return;                                                               
//#10859        }                                                                   
//#10860        if(chkMap(BIGBOX)){                                                                   
//#10861                                                                           
//#10862            for(ind=0;ind<fltad;ind++)                                                               
//#10863                rotflt(&flts[ind]);                                                           
//#10864            for(ind=0;ind<hed.stchs;ind++)                                                               
//#10865                rotstch(&stchs[ind]);                                                           
//#10866            for(ind=0;ind<formpnt;ind++)                                                               
//#10867                frmout(ind);                                                           
//#10868            selal();                                                               
//#10869            return;                                                               
//#10870        }                                                                   
//#10871        if(rstMap(FRMSROT)){                                                                   
//#10872                                                                           
//#10873            tang=ang;                                                               
//#10874            trot.x=rotcntr.x;                                                               
//#10875            trot.y=rotcntr.y;                                                               
//#10876            for(ind=0;ind<fselpnt;ind++){                                                               
//#10877                                                                           
//#10878                clofind=selist[ind];                                                           
//#10879                fvars(clofind);                                                           
//#10880                for(ine=0;ine<sids;ine++)                                                           
//#10881                    rotflt(&flt[ine]);                                                       
//#10882                frmout(clofind);                                                           
//#10883                refilfn();                                                           
//#10884                ang=tang;                                                           
//#10885                rotcntr.x=trot.x;                                                           
//#10886                rotcntr.y=trot.y;                                                           
//#10887            }                                                               
//#10888            setMap(RESTCH);                                                               
//#10889        }                                                                   
//#10890        else{                                                                   
//#10891                                                                           
//#10892            if(rstMap(FRMROT)){                                                               
//#10893                                                                           
//#10894                fvars(clofind);                                                           
//#10895                for(ind=0;ind<sids;ind++)                                                           
//#10896                    rotflt(&flt[ind]);                                                       
//#10897                frmout(clofind);                                                           
//#10898                refil();                                                           
//#10899                setMap(RESTCH);                                                           
//#10900            }                                                               
//#10901            else{                                                               
//#10902                                                                           
//#10903                len=gpnt1-gpnt0+1;                                                           
//#10904                dst=0;                                                           
//#10905                for(ind=gpnt0;ind<=gpnt1;ind++)                                                           
//#10906                    rotstch(&stchs[ind]);                                                       
//#10907                rngadj();                                                           
//#10908                selin(gpnt0,gpnt1,rsdc);                                                           
//#10909                setMap(RESTCH);                                                           
//#10910            }                                                               
//#10911        }                                                                   
//#10912    }                                                                       
//#10913                                                                           
//#10914    void rotfns(){                                                                       
//#10915                                                                           
//#10916        savdo();                                                                   
//#10917        rotfn();                                                                   
//#10918    }                                                                       
//#10919                                                                           
//#10920    void nulayr(unsigned play){                                                                       
//#10921                                                                           
//#10922        actl=play;                                                                   
//#10923        laycod=play>>1;                                                                   
//#10924        ladj();                                                                   
//#10925        if(actl){                                                                   
//#10926                                                                           
//#10927            if(chkMap(FORMSEL)&&((unsigned)((formlst[clofind].at&FRMLMSK)>>1)!=actl))                                                               
//#10928                rstMap(FORMSEL);                                                           
//#10929            rstMap(GRPSEL);                                                               
//#10930            if(chkMap(SELBOX)){                                                               
//#10931                                                                           
//#10932                if(actl!=((stchs[cloInd].at&LAYMSK)>>LAYSHFT)+1)                                                           
//#10933                    rstMap(SELBOX);                                                       
//#10934            }                                                               
//#10935            fselpnt=0;                                                               
//#10936        }                                                                   
//#10937        setMap(RESTCH);                                                                   
//#10938    }                                                                       
//#10939                                                                           
//#10940    BOOL iselpnt(){                                                                       
//#10941                                                                           
//#10942        unsigned    ind,ine=0;                                                               
//#10943        double        len,minlen=1e99;                                                           
//#10944        POINT        tpnt;                                                           
//#10945                                                                           
//#10946        tpnt.x=msg.pt.x-stOrg.x;                                                                   
//#10947        tpnt.y=msg.pt.y-stOrg.y;                                                                   
//#10948        for(ind=0;ind<9;ind++){                                                                   
//#10949                                                                           
//#10950            len=hypot(tpnt.x-rctlin[ind].x,tpnt.y-rctlin[ind].y);                                                               
//#10951            if(len<minlen){                                                               
//#10952                                                                           
//#10953                minlen=len;                                                           
//#10954                ine=ind;                                                           
//#10955            }                                                               
//#10956        }                                                                   
//#10957        if(minlen<CLOSENUF){                                                                   
//#10958                                                                           
//#10959            cntrl=ine;                                                               
//#10960            return 1;                                                               
//#10961        }                                                                   
//#10962        else                                                                   
//#10963            return 0;                                                               
//#10964    }                                                                       
//#10965                                                                           
//#10966    void rtrclpfn(){                                                                       
//#10967                                                                           
//#10968        unsigned ind,len=0;                                                                   
//#10969                                                                           
//#10970        if(OpenClipboard(hWnd)){                                                                   
//#10971                                                                           
//#10972            fvars(clofind);                                                               
//#10973            if(iseclp(clofind)){                                                               
//#10974                                                                           
//#10975                len=frmpnt->nclp;                                                           
//#10976                oclp(frmpnt->clp,len);                                                           
//#10977            }                                                               
//#10978            else{                                                               
//#10979                                                                           
//#10980                if(isclp(clofind)){                                                           
//#10981                                                                           
//#10982                    len=frmpnt->flencnt.nclp;                                                       
//#10983                    oclp(frmpnt->angclp.clp,len);                                                       
//#10984                }                                                           
//#10985            }                                                               
//#10986            if(len){                                                               
//#10987                                                                           
//#10988                lolft.x=lolft.y=0;                                                           
//#10989                EmptyClipboard();                                                           
//#10990                hClip=RegisterClipboardFormat(pcdClip);                                                           
//#10991                clpvoid=GlobalAlloc(GMEM_MOVEABLE|GMEM_DDESHARE,len*sizeof(CLPSTCH)+2);                                                           
//#10992                clpdat=deref(clpvoid);                                                           
//#10993                rtclpfn(0,0);                                                           
//#10994                clpdat[0].led=len;                                                           
//#10995                for(ind=1;ind<len;ind++)                                                           
//#10996                    rtclpfn(ind,ind);                                                       
//#10997                SetClipboardData(hClip,clpvoid);                                                           
//#10998                CloseClipboard();                                                           
//#10999            }                                                               
//#11000        }                                                                   
//#11001    }                                                                       
//#11002                                                                           
//#11003    BOOL chkbig(){                                                                       
//#11004                                                                           
//#11005        unsigned    ind;                                                               
//#11006        double        len,minlen=1e99;                                                           
//#11007        POINT        tpnt;                                                           
//#11008                                                                           
//#11009        tpnt.x=msg.pt.x-stOrg.x;                                                                   
//#11010        tpnt.y=msg.pt.y-stOrg.y;                                                                   
//#11011        for(ind=0;ind<9;ind++){                                                                   
//#11012                                                                           
//#11013            len=hypot(tpnt.x-biglin[ind].x,tpnt.y-biglin[ind].y);                                                               
//#11014            if(len<minlen){                                                               
//#11015                                                                           
//#11016                minlen=len;                                                           
//#11017                cntrl=ind;                                                           
//#11018            }                                                               
//#11019        }                                                                   
//#11020        for(ind=0;ind<4;ind++){                                                                   
//#11021                                                                           
//#11022            flin[ind].x=biglin[ind<<1].x;                                                               
//#11023            flin[ind].y=biglin[ind<<1].y;                                                               
//#11024        }                                                                   
//#11025        flin[4].x=flin[0].x;                                                                   
//#11026        flin[4].y=flin[0].y;                                                                   
//#11027        if(minlen<CLOSENUF){                                                                   
//#11028                                                                           
//#11029            for(ind=0;ind<4;ind++){                                                               
//#11030                                                                           
//#11031                sizlin[ind].x=biglin[ind<<1].x;                                                           
//#11032                sizlin[ind].y=biglin[ind<<1].y;                                                           
//#11033            }                                                               
//#11034            sizlin[4].x=sizlin[0].x;                                                               
//#11035            sizlin[4].y=sizlin[0].y;                                                               
//#11036            if(cntrl&1)                                                               
//#11037                setMap(STRTCH);                                                           
//#11038            else{                                                               
//#11039                                                                           
//#11040                setMap(EXPAND);                                                           
//#11041                xpct=(double)(bigrct.right-bigrct.left)/(bigrct.bottom-bigrct.top);                                                           
//#11042            }                                                               
//#11043            cntrl>>=1;                                                               
//#11044            setMap(SHOSTRTCH);                                                               
//#11045            strtchbox();                                                               
//#11046            return 1;                                                               
//#11047        }                                                                   
//#11048        if(tpnt.x>=bigrct.left&&tpnt.x<=bigrct.right                                                                   
//#11049            &&tpnt.y>=bigrct.top&&tpnt.y<=bigrct.bottom){                                                               
//#11050                                                                           
//#11051            bigsiz.x=bigrct.right-bigrct.left;                                                               
//#11052            bigsiz.y=bigrct.bottom-bigrct.top;                                                               
//#11053            setMap(MOVFRMS);                                                               
//#11054            fmovdif.x=tpnt.x-bigrct.left;                                                               
//#11055            fmovdif.y=tpnt.y-bigrct.top;                                                               
//#11056            setMap(SHOSTRTCH);                                                               
//#11057            strtchbox();                                                               
//#11058            return 1;                                                               
//#11059        }                                                                   
//#11060        return 0;                                                                   
//#11061    }                                                                       
//#11062                                                                           
//#11063    void delfre(){                                                                       
//#11064                                                                           
//#11065        unsigned ind,ine=0;                                                                   
//#11066                                                                           
//#11067        savdo();                                                                   
//#11068        for(ind=0;ind<hed.stchs;ind++){                                                                   
//#11069                                                                           
//#11070            if(!(stchs[ind].at&NOTFRM)){                                                               
//#11071                                                                           
//#11072                stchs[ine].at=stchs[ind].at;                                                           
//#11073                stchs[ine].x=stchs[ind].x;                                                           
//#11074                stchs[ine++].y=stchs[ind].y;                                                           
//#11075            }                                                               
//#11076        }                                                                   
//#11077        hed.stchs=ine;                                                                   
//#11078        coltab();                                                                   
//#11079        setMap(RESTCH);                                                                   
//#11080    }                                                                       
//#11081                                                                           
//#11082    void setmov(){                                                                       
//#11083                                                                           
//#11084        if(chkMap(SELBOX)){                                                                   
//#11085                                                                           
//#11086            movpnt=cloInd;                                                               
//#11087            setMap(MOVSET);                                                               
//#11088            setMap(RESTCH);                                                               
//#11089        }                                                                   
//#11090    }                                                                       
//#11091                                                                           
//#11092    void dufsel()                                                                       
//#11093    {                                                                       
//#11094        unsigned strt,fin;                                                                   
//#11095                                                                           
//#11096        if(clofinx>clofind)                                                                   
//#11097        {                                                                   
//#11098            strt=clofind;                                                               
//#11099            fin=clofinx;                                                               
//#11100        }                                                                   
//#11101        else                                                                   
//#11102        {                                                                   
//#11103            strt=clofinx;                                                               
//#11104            fin=clofind;                                                               
//#11105        }                                                                   
//#11106        fselpnt=0;                                                                   
//#11107        while(strt<=fin)                                                                   
//#11108        {                                                                   
//#11109            selist[fselpnt]=strt;                                                               
//#11110            strt++;                                                               
//#11111            fselpnt++;                                                               
//#11112        }                                                                   
//#11113    }                                                                       
//#11114                                                                           
//#11115    void selup(){                                                                       
//#11116                                                                           
//#11117        unsigned at;                                                                   
//#11118                                                                           
//#11119        if(GetKeyState(VK_SHIFT)&0X8000){                                                                   
//#11120                                                                           
//#11121            rstMap(SELBOX);                                                               
//#11122            if(rstMap(FORMSEL)){                                                               
//#11123                                                                           
//#11124                if(clofind<formpnt-1){                                                           
//#11125                                                                           
//#11126                    selist[0]=clofind;                                                       
//#11127                    clofinx=clofind+1;                                                       
//#11128                    selist[1]=clofinx;                                                       
//#11129                    fselpnt=2;                                                       
//#11130                }                                                           
//#11131                else                                                           
//#11132                    return;                                                       
//#11133            }                                                               
//#11134            else{                                                               
//#11135                                                                           
//#11136                if(fselpnt)                                                           
//#11137                {                                                           
//#11138                    if(clofinx<formpnt-1)                                                       
//#11139                    {                                                       
//#11140                        clofinx++;                                                   
//#11141                        dufsel();                                                   
//#11142                    }                                                       
//#11143                }                                                           
//#11144                else                                                           
//#11145                    setMap(FORMSEL);                                                       
//#11146            }                                                               
//#11147            setMap(RESTCH);                                                               
//#11148        }                                                                   
//#11149        else{                                                                   
//#11150                                                                           
//#11151            if(chkMap(SELBOX)){                                                               
//#11152                                                                           
//#11153                unbox();                                                           
//#11154                at=stchs[cloInd].at&ATMSK;                                                           
//#11155                while(cloInd<(unsigned)hed.stchs-1&&(stchs[cloInd].at&ATMSK)==at)                                                           
//#11156                    cloInd++;                                                       
//#11157                stch2px(cloInd);                                                           
//#11158                dubox();                                                           
//#11159            }                                                               
//#11160            else{                                                               
//#11161                                                                           
//#11162                if(formpnt){                                                           
//#11163                                                                           
//#11164                    if(setMap(FORMSEL)){                                                       
//#11165                                                                           
//#11166                        if(clofind<(unsigned)formpnt-1)                                                   
//#11167                            clofind++;                                               
//#11168                    }                                                       
//#11169                    else                                                       
//#11170                        clofind=0;                                                   
//#11171                    ritnum(STR_NUMFORM,clofind);                                                       
//#11172                    setMap(RESTCH);                                                       
//#11173                }                                                           
//#11174            }                                                               
//#11175        }                                                                   
//#11176    }                                                                       
//#11177                                                                           
//#11178    void seldwn(){                                                                       
//#11179                                                                           
//#11180        unsigned at;                                                                   
//#11181                                                                           
//#11182        if(GetKeyState(VK_SHIFT)&0X8000){                                                                   
//#11183                                                                           
//#11184            rstMap(SELBOX);                                                               
//#11185            if(rstMap(FORMSEL)){                                                               
//#11186                                                                           
//#11187                if(clofind){                                                           
//#11188                                                                           
//#11189                    selist[0]=clofind;                                                       
//#11190                    clofinx=clofind-1;                                                       
//#11191                    selist[1]=clofinx;                                                       
//#11192                    fselpnt=2;                                                       
//#11193                }                                                           
//#11194                else                                                           
//#11195                    return;                                                       
//#11196            }                                                               
//#11197            else{                                                               
//#11198                                                                           
//#11199                if(fselpnt)                                                           
//#11200                {                                                           
//#11201                    if(clofinx)                                                       
//#11202                    {                                                       
//#11203                        clofinx--;                                                   
//#11204                        dufsel();                                                   
//#11205                    }                                                       
//#11206                }                                                           
//#11207                else                                                           
//#11208                    setMap(FORMSEL);                                                       
//#11209            }                                                               
//#11210            setMap(RESTCH);                                                               
//#11211        }                                                                   
//#11212        else{                                                                   
//#11213                                                                           
//#11214            if(chkMap(SELBOX)){                                                               
//#11215                                                                           
//#11216                unbox();                                                           
//#11217                at=stchs[cloInd].at&ATMSK;                                                           
//#11218                while(cloInd&&(stchs[cloInd].at&ATMSK)==at)                                                           
//#11219                    cloInd--;                                                       
//#11220                stch2px(cloInd);                                                           
//#11221                dubox();                                                           
//#11222            }                                                               
//#11223            else{                                                               
//#11224                                                                           
//#11225                if(formpnt){                                                           
//#11226                                                                           
//#11227                    if(setMap(FORMSEL)){                                                       
//#11228                                                                           
//#11229                        if(clofind)                                                   
//#11230                            clofind--;                                               
//#11231                    }                                                       
//#11232                    else                                                       
//#11233                        clofind=formpnt-1;                                                   
//#11234                    ritnum(STR_NUMFORM,clofind);                                                       
//#11235                    setMap(RESTCH);                                                       
//#11236                }                                                           
//#11237            }                                                               
//#11238        }                                                                   
//#11239    }                                                                       
//#11240                                                                           
//#11241    void mvstchs(unsigned dst,unsigned src,unsigned cnt){                                                                       
//#11242                                                                           
//#11243        _asm{                                                                   
//#11244                                                                           
//#11245                xor        ecx,ecx                                                   
//#11246                mov        cl,12                                                   
//#11247                mov        eax,dst                                                   
//#11248                mul        ecx                                                   
//#11249                mov        edi,eax                                                   
//#11250                add        edi,offset stchs                                                   
//#11251                mov        eax,src                                                   
//#11252                mul        ecx                                                   
//#11253                mov        esi,eax                                                   
//#11254                add        esi,offset stchs                                                   
//#11255                mov        cl,3                                                   
//#11256                mov        eax,cnt                                                   
//#11257                mul        ecx                                                   
//#11258                mov        ecx,eax                                                   
//#11259                rep        movsd                                                   
//#11260        }                                                                   
//#11261    }                                                                       
//#11262                                                                           
//#11263    BOOL movstchs(unsigned dst,unsigned strt,unsigned fin){                                                                       
//#11264                                                                           
//#11265        unsigned cnt,ind;                                                                   
//#11266        unsigned dind=MAXPCS>>1;                                                                   
//#11267                                                                           
//#11268        if(dst<(unsigned)hed.stchs-1)                                                                   
//#11269            dst++;                                                               
//#11270        if(strt>fin){                                                                   
//#11271                                                                           
//#11272            ind=strt;                                                               
//#11273            strt=fin;                                                               
//#11274            fin=ind;                                                               
//#11275        }                                                                   
//#11276        if(dst>=strt&&dst<fin){                                                                   
//#11277                                                                           
//#11278            tabmsg(IDS_DST1);                                                               
//#11279            return 0;                                                               
//#11280        }                                                                   
//#11281        if(dst<strt){                                                                   
//#11282                                                                           
//#11283            cnt=fin-strt;                                                               
//#11284            mvstchs(dind,strt,cnt);                                                               
//#11285            dind+=cnt;                                                               
//#11286            cnt=strt-dst;                                                               
//#11287            mvstchs(dind,dst,cnt);                                                               
//#11288            dind+=cnt;                                                               
//#11289            mvstchs(dst,MAXPCS>>1,dind-(MAXPCS>>1));                                                               
//#11290        }                                                                   
//#11291        else{                                                                   
//#11292                                                                           
//#11293            cnt=dst-fin;                                                               
//#11294            mvstchs(dind,fin,cnt);                                                               
//#11295            dind+=cnt;                                                               
//#11296            cnt=fin-strt;                                                               
//#11297            mvstchs(dind,strt,cnt);                                                               
//#11298            dind+=cnt;                                                               
//#11299            mvstchs(strt,MAXPCS>>1,dind-(MAXPCS>>1));                                                               
//#11300        }                                                                   
//#11301        return 1;                                                                   
//#11302    }                                                                       
//#11303                                                                           
//#11304    void movmrk(){                                                                       
//#11305                                                                           
//#11306        if(chkMap(MOVSET)){                                                                   
//#11307                                                                           
//#11308            if(chkMap(GRPSEL)){                                                               
//#11309                                                                           
//#11310                rngadj();                                                           
//#11311                if(movstchs(movpnt,gpnt0,gpnt1)){                                                           
//#11312                                                                           
//#11313                    coltab();                                                       
//#11314                    setMap(RESTCH);                                                       
//#11315                }                                                           
//#11316            }                                                               
//#11317            else{                                                               
//#11318                                                                           
//#11319                if(chkMap(SELBOX)){                                                           
//#11320                                                                           
//#11321                    if(movstchs(movpnt,cloInd,cloInd+1)){                                                       
//#11322                                                                           
//#11323                        setMap(RESTCH);                                                   
//#11324                        coltab();                                                   
//#11325                    }                                                       
//#11326                }                                                           
//#11327            }                                                               
//#11328        }                                                                   
//#11329    }                                                                       
//#11330                                                                           
//#11331    void vuthrds(){                                                                       
//#11332                                                                           
//#11333        if(GetMenuState(hvumen,ID_VUTHRDS,MF_BYCOMMAND)&MF_CHECKED){                                                                   
//#11334                                                                           
//#11335            CheckMenuItem(hMen,ID_VUTHRDS,MF_BYCOMMAND|MF_UNCHECKED);                                                               
//#11336            rstMap(THRDS);                                                               
//#11337        }                                                                   
//#11338        else{                                                                   
//#11339                                                                           
//#11340            CheckMenuItem(hMen,ID_VUTHRDS,MF_BYCOMMAND|MF_CHECKED);                                                               
//#11341            setMap(THRDS);                                                               
//#11342        }                                                                   
//#11343        setMap(RESTCH);                                                                   
//#11344    }                                                                       
//#11345                                                                           
//#11346    void vuselthr(){                                                                       
//#11347                                                                           
//#11348        if(GetMenuState(hvumen,ID_VUSELTHRDS,MF_BYCOMMAND)&MF_CHECKED){                                                                   
//#11349                                                                           
//#11350            CheckMenuItem(hMen,ID_VUSELTHRDS,MF_BYCOMMAND|MF_UNCHECKED);                                                               
//#11351            rstMap(COL);                                                               
//#11352        }                                                                   
//#11353        else{                                                                   
//#11354                                                                           
//#11355            CheckMenuItem(hMen,ID_VUSELTHRDS,MF_BYCOMMAND|MF_CHECKED);                                                               
//#11356            setMap(COL);                                                               
//#11357        }                                                                   
//#11358        setMap(RESTCH);                                                                   
//#11359    }                                                                       
//#11360                                                                           
//#11361    void colchk(){                                                                       
//#11362                                                                           
//#11363        unsigned col,cind,ind;                                                                   
//#11364                                                                           
//#11365        col=stchs[0].at&COLMSK;                                                                   
//#11366        cind=0;                                                                   
//#11367        for(ind=0;ind<hed.stchs;ind++){                                                                   
//#11368                                                                           
//#11369            if(col!=(stchs[ind].at&COLMSK)){                                                               
//#11370                                                                           
//#11371                if(ind-cind==1)                                                           
//#11372                    stchs[ind-1].at=stchs[ind].at&NCOLMSK|(stchs[cind-1].at&COLMSK);                                                       
//#11373                col=stchs[ind].at&COLMSK;                                                           
//#11374                cind=ind;                                                           
//#11375            }                                                               
//#11376        }                                                                   
//#11377    }                                                                       
//#11378                                                                           
//#11379    unsigned makbig(unsigned strt,unsigned fin){                                                                       
//#11380                                                                           
//#11381        unsigned    dst,src,cnt,ine,adcnt=0,at;                                                               
//#11382        SHRTPNT*    tstchs0;                                                               
//#11383        SHRTPNT*    tstchs1;                                                               
//#11384        double        len;                                                           
//#11385        DUBPNT        dif,stp,pnt;                                                           
//#11386                                                                           
//#11387        dst=MAXPCS>>1;                                                                   
//#11388        for(src=strt;src<(unsigned)fin-1;src++){                                                                   
//#11389                                                                           
//#11390            dif.x=stchs[src+1].x-stchs[src].x;                                                               
//#11391            dif.y=stchs[src+1].y-stchs[src].y;                                                               
//#11392            len=hypot(dif.x,dif.y);                                                               
//#11393            mvstch(dst++,src);                                                               
//#11394            if(len>ini.maxsiz){                                                               
//#11395                                                                           
//#11396                cnt=ceil(len/usesiz);                                                           
//#11397                stp.x=dif.x/cnt;                                                           
//#11398                stp.y=dif.y/cnt;                                                           
//#11399                pnt.x=stchs[src].x+stp.x;                                                           
//#11400                pnt.y=stchs[src].y+stp.y;                                                           
//#11401                at=stchs[src].at;                                                           
//#11402                if(at!=stchs[src+1].at){                                                           
//#11403                                                                           
//#11404                    if(!(at&NOTFRM)&&stchs[src+1].at&TYPMSK){                                                       
//#11405                                                                           
//#11406                        if(!((at&FRMSK)==(stchs[src+1].at&FRMSK)))                                                   
//#11407                            at&=NTYPMSK;                                               
//#11408                    }                                                       
//#11409                    else                                                       
//#11410                        at&=NTYPMSK;                                                   
//#11411                }                                                           
//#11412                at&=(~KNOTMSK);                                                           
//#11413                for(ine=0;ine<cnt-1;ine++){                                                           
//#11414                                                                           
//#11415                    stchs[dst].at=at;                                                       
//#11416                    stchs[dst].x=pnt.x;                                                       
//#11417                    stchs[dst++].y=pnt.y;                                                       
//#11418                    pnt.x+=stp.x;                                                       
//#11419                    pnt.y+=stp.y;                                                       
//#11420                    adcnt++;                                                       
//#11421                }                                                           
//#11422            }                                                               
//#11423        }                                                                   
//#11424        while(src<hed.stchs)                                                                   
//#11425            mvstch(dst++,src++);                                                               
//#11426        tstchs0=&stchs[MAXPCS>>1];                                                                   
//#11427        tstchs1=&stchs[strt];                                                                   
//#11428        cnt=dst-(MAXPCS>>1);                                                                   
//#11429        for(src=0;src<cnt;src++)                                                                   
//#11430            tstchs1[src]=tstchs0[src];                                                               
//#11431        hed.stchs=strt+cnt;                                                                   
//#11432        return adcnt;                                                                   
//#11433    }                                                                       
//#11434                                                                           
//#11435    void rembig(){                                                                       
//#11436                                                                           
//#11437        RANG rng;                                                                   
//#11438        unsigned ind;                                                                   
//#11439                                                                           
//#11440        if(usesiz<ini.maxsiz){                                                                   
//#11441                                                                           
//#11442            savdo();                                                               
//#11443            if(fselpnt){                                                               
//#11444                                                                           
//#11445                for(ind=0;ind<fselpnt;ind++){                                                           
//#11446                                                                           
//#11447                    frmrng(selist[ind],&rng);                                                       
//#11448                    makbig(rng.strt,rng.fin);                                                       
//#11449                }                                                           
//#11450                goto bigdun;                                                           
//#11451            }                                                               
//#11452            if(chkMap(FORMSEL)){                                                               
//#11453                                                                           
//#11454                frmrng(clofind,&rng);                                                           
//#11455                makbig(rng.strt,rng.fin);                                                           
//#11456                goto bigdun;                                                           
//#11457            }                                                               
//#11458            if(chkMap(GRPSEL)){                                                               
//#11459                                                                           
//#11460                rngadj();                                                           
//#11461                if(gpnt1<hed.stchs)                                                           
//#11462                    gpnt1++;                                                       
//#11463                if(cloInd<grpInd)                                                           
//#11464                    grpInd+=makbig(gpnt0,gpnt1);                                                       
//#11465                else                                                           
//#11466                    cloInd+=makbig(gpnt0,gpnt1);                                                       
//#11467                grpAdj();                                                           
//#11468                goto bigdun;                                                           
//#11469            }                                                               
//#11470            makbig(0,hed.stchs);                                                               
//#11471                                                                           
//#11472    bigdun:;                                                                       
//#11473            coltab();                                                               
//#11474            setMap(RESTCH);                                                               
//#11475        }                                                                   
//#11476        else                                                                   
//#11477            tabmsg(IDS_REM1);                                                               
//#11478    }                                                                       
//#11479                                                                           
//#11480    void duselrng(){                                                                       
//#11481                                                                           
//#11482        selfrng.strt=0;                                                                   
//#11483        selfrng.fin=hed.stchs;                                                                   
//#11484        if(chkMap(GRPSEL)){                                                                   
//#11485                                                                           
//#11486            rngadj();                                                               
//#11487            selfrng.strt=gpnt0;                                                               
//#11488            selfrng.fin=gpnt1;                                                               
//#11489            return;                                                               
//#11490        }                                                                   
//#11491    }                                                                       
//#11492                                                                           
//#11493    void longer(){                                                                       
//#11494                                                                           
//#11495        unsigned    ind,ine;                                                               
//#11496        double        len,minlen=1e99;                                                           
//#11497        double        curlen;                                                           
//#11498                                                                           
//#11499        if(cloInd==maxpnt)                                                                   
//#11500            return;                                                               
//#11501        curlen=hypot(stchs[cloInd+1].x-stchs[cloInd].x,stchs[cloInd+1].y-stchs[cloInd].y);                                                                   
//#11502        for(ind=cloInd+1;ind<selfrng.fin;ind++){                                                                   
//#11503                                                                           
//#11504            len=hypot(stchs[ind+1].x-stchs[ind].x,stchs[ind+1].y-stchs[ind].y);                                                               
//#11505            if(len==curlen)                                                               
//#11506                goto long1;                                                           
//#11507        }                                                                   
//#11508        for(ine=selfrng.strt;ine<selfrng.fin-1;ine++){                                                                   
//#11509                                                                           
//#11510            len=hypot(stchs[ine+1].x-stchs[ine].x,stchs[ine+1].y-stchs[ine].y);                                                               
//#11511            if(len>curlen&&len<minlen){                                                               
//#11512                                                                           
//#11513                minlen=len;                                                           
//#11514                ind=ine;                                                           
//#11515            }                                                               
//#11516        }                                                                   
//#11517        if(minlen==1e99)                                                                   
//#11518            return;                                                               
//#11519    long1:;                                                                       
//#11520        srchpnt=ind;                                                                   
//#11521        lensadj();                                                                   
//#11522        ritnum(STR_NUMSCH,cloInd);                                                                   
//#11523    }                                                                       
//#11524                                                                           
//#11525    void shorter(){                                                                       
//#11526                                                                           
//#11527        unsigned    ind,ine;                                                               
//#11528        double        len,maxlen=0;                                                           
//#11529        double        curmax;                                                           
//#11530                                                                           
//#11531        if(cloInd==minpnt)                                                                   
//#11532            return;                                                               
//#11533        curmax=hypot(stchs[cloInd+1].x-stchs[cloInd].x,stchs[cloInd+1].y-stchs[cloInd].y);                                                                   
//#11534        for(ine=cloInd-1;ine<selfrng.fin;ine--){                                                                   
//#11535                                                                           
//#11536                len=hypot(stchs[ine+1].x-stchs[ine].x,stchs[ine+1].y-stchs[ine].y);                                                           
//#11537                if(len==curmax)                                                           
//#11538                    goto short1;                                                       
//#11539        }                                                                   
//#11540        for(ind=selfrng.strt;ind<selfrng.fin-1;ind++){                                                                   
//#11541                                                                           
//#11542            len=hypot(stchs[ind+1].x-stchs[ind].x,stchs[ind+1].y-stchs[ind].y);                                                               
//#11543            if(len<curmax&&len>maxlen){                                                               
//#11544                                                                           
//#11545                maxlen=len;                                                           
//#11546                ine=ind;                                                           
//#11547            }                                                               
//#11548        }                                                                   
//#11549        sprintf(msgbuf,"%.2f",hypot(stchs[ind+1].x-stchs[ind].x,stchs[ind+1].y-stchs[ind].y));                                                                   
//#11550        butxt(HMINLEN,msgbuf);                                                                   
//#11551    short1:;                                                                       
//#11552        srchpnt=ine;                                                                   
//#11553        lensadj();                                                                   
//#11554        ritnum(STR_NUMSCH,cloInd);                                                                   
//#11555    }                                                                       
//#11556                                                                           
//#11557    void setsrch(unsigned stind){                                                                       
//#11558                                                                           
//#11559        srchpnt=stind;                                                                   
//#11560        lensadj();                                                                   
//#11561        ritnum(STR_NUMSCH,cloInd);                                                                   
//#11562    }                                                                       
//#11563                                                                           
//#11564    BOOL inrng(unsigned stind){                                                                       
//#11565                                                                           
//#11566        if(   stchs[stind].x>=rngrct.left                                                                   
//#11567            &&stchs[stind].x<=rngrct.right                                                               
//#11568            &&stchs[stind].y>=rngrct.bottom                                                               
//#11569            &&stchs[stind].y<=rngrct.top)                                                               
//#11570                                                                           
//#11571            return 1;                                                               
//#11572        else                                                                   
//#11573            return 0;                                                               
//#11574    }                                                                       
//#11575                                                                           
//#11576    BOOL finrng(unsigned find){                                                                       
//#11577                                                                           
//#11578        unsigned cod;                                                                   
//#11579                                                                           
//#11580        if(   formlst[find].rct.left>=rngrct.left                                                                   
//#11581            &&formlst[find].rct.right<=rngrct.right                                                               
//#11582            &&formlst[find].rct.bottom>=rngrct.bottom                                                               
//#11583            &&formlst[find].rct.top<=rngrct.top){                                                               
//#11584                                                                           
//#11585            if(!actl)                                                               
//#11586                return 1;                                                           
//#11587            cod=(formlst[find].at&FRMLMSK)>>1;                                                               
//#11588            if(!cod||actl==cod)                                                               
//#11589                return 1;                                                           
//#11590            else                                                               
//#11591                return 0;                                                           
//#11592        }                                                                   
//#11593        else                                                                   
//#11594            return 0;                                                               
//#11595    }                                                                       
//#11596                                                                           
//#11597    void ungrplo(){                                                                       
//#11598                                                                           
//#11599        unsigned ind;                                                                   
//#11600                                                                           
//#11601        if(rstMap(GRPSEL)){                                                                   
//#11602                                                                           
//#11603            rngadj();                                                               
//#11604            cloInd=gpnt0;                                                               
//#11605            setMap(SELBOX);                                                               
//#11606            setMap(RESTCH);                                                               
//#11607        }                                                                   
//#11608        else{                                                                   
//#11609                                                                           
//#11610            if(chkMap(FORMSEL)){                                                               
//#11611                                                                           
//#11612                for(ind=0;ind<hed.stchs;ind++){                                                           
//#11613                                                                           
//#11614                    if(!(stchs[ind].at&NOTFRM)&&((stchs[ind].at&FRMSK)>>FRMSHFT)==clofind){                                                       
//#11615                                                                           
//#11616                        cloInd=ind;                                                   
//#11617                        setMap(SELBOX);                                                   
//#11618                        setMap(RESTCH);                                                   
//#11619                        goto upgrpdun;                                                   
//#11620                    }                                                       
//#11621                }                                                           
//#11622                grpmsg1();                                                           
//#11623            }                                                               
//#11624            else                                                               
//#11625                grpmsg();                                                           
//#11626        }                                                                   
//#11627    upgrpdun:;                                                                       
//#11628    }                                                                       
//#11629                                                                           
//#11630    void ungrphi(){                                                                       
//#11631                                                                           
//#11632        unsigned ind;                                                                   
//#11633                                                                           
//#11634        if(rstMap(GRPSEL)){                                                                   
//#11635                                                                           
//#11636            rngadj();                                                               
//#11637            cloInd=gpnt1;                                                               
//#11638            setMap(SELBOX);                                                               
//#11639            setMap(RESTCH);                                                               
//#11640        }                                                                   
//#11641        else{                                                                   
//#11642                                                                           
//#11643            if(chkMap(FORMSEL)){                                                               
//#11644                                                                           
//#11645                for(ind=hed.stchs-1;ind<hed.stchs;ind--){                                                           
//#11646                                                                           
//#11647                    if(!(stchs[ind].at&NOTFRM)&&((stchs[ind].at&FRMSK)>>FRMSHFT)==clofind){                                                       
//#11648                                                                           
//#11649                        cloInd=ind;                                                   
//#11650                        setMap(SELBOX);                                                   
//#11651                        setMap(RESTCH);                                                   
//#11652                        goto dwngrpdun;                                                   
//#11653                    }                                                       
//#11654                }                                                           
//#11655                grpmsg1();                                                           
//#11656            }                                                               
//#11657            else                                                               
//#11658                grpmsg();                                                           
//#11659        }                                                                   
//#11660    dwngrpdun:;                                                                       
//#11661    }                                                                       
//#11662                                                                           
//#11663    void sizstch(FLRCT* rct){                                                                       
//#11664                                                                           
//#11665        unsigned ind;                                                                   
//#11666                                                                           
//#11667        if(hed.stchs){                                                                   
//#11668                                                                           
//#11669            rct->bottom=rct->top=stchsr[0].y;                                                               
//#11670            rct->left=rct->right=stchsr[0].x;                                                               
//#11671            for(ind=1;ind<hed.stchs;ind++){                                                               
//#11672                                                                           
//#11673                if(stchsr[ind].x<rct->left)                                                           
//#11674                    rct->left=stchsr[ind].x;                                                       
//#11675                if(stchsr[ind].x>rct->right)                                                           
//#11676                    rct->right=stchsr[ind].x;                                                       
//#11677                if(stchsr[ind].y<rct->bottom)                                                           
//#11678                    rct->bottom=stchsr[ind].y;                                                       
//#11679                if(stchsr[ind].y>rct->top)                                                           
//#11680                    rct->top=stchsr[ind].y;                                                       
//#11681            }                                                               
//#11682        }                                                                   
//#11683        else                                                                   
//#11684            rct->top=rct->bottom=rct->left=rct->right=0;                                                               
//#11685    }                                                                       
//#11686                                                                           
//#11687    void hupfn(){                                                                       
//#11688                                                                           
//#11689        unsigned    ind;                                                               
//#11690        DUBPNT        hupcntr;                                                           
//#11691        DUBPNT        descntr;                                                           
//#11692        DUBPNT        tsiz;                                                           
//#11693        DUBPNT        dif;                                                           
//#11694                                                                           
//#11695        rstMap(HUPCHNG);                                                                   
//#11696        stchsr=stchs;                                                                   
//#11697        sizstch(&chkhuprct);                                                                   
//#11698        if(formpnt){                                                                   
//#11699                                                                           
//#11700            if(!hed.stchs){                                                               
//#11701                                                                           
//#11702                chkhuprct.bottom=chkhuprct.top=flt[0].y;                                                           
//#11703                chkhuprct.left=chkhuprct.right=flt[0].x;                                                           
//#11704            }                                                               
//#11705            for(ind=0;ind<fltad;ind++){                                                               
//#11706                                                                           
//#11707                if(flts[ind].x<chkhuprct.left)                                                           
//#11708                    chkhuprct.left=flts[ind].x;                                                       
//#11709                if(flts[ind].x>chkhuprct.right)                                                           
//#11710                    chkhuprct.right=flts[ind].x;                                                       
//#11711                if(flts[ind].y<chkhuprct.bottom)                                                           
//#11712                    chkhuprct.bottom=flts[ind].y;                                                       
//#11713                if(flts[ind].y>chkhuprct.top)                                                           
//#11714                    chkhuprct.top=flts[ind].y;                                                       
//#11715            }                                                               
//#11716        }                                                                   
//#11717        if(hed.stchs||fltad||chkMap(HUPEX)){                                                                   
//#11718                                                                           
//#11719            if(    chkhuprct.left<0||                                                           
//#11720                chkhuprct.right>ini.hupx||                                                           
//#11721                chkhuprct.bottom<0||                                                           
//#11722                chkhuprct.top>ini.hupy){                                                           
//#11723                                                                           
//#11724                setMap(HUPEX);                                                           
//#11725            }                                                               
//#11726            if(chkMap(HUPEX)){                                                               
//#11727                                                                           
//#11728                tsiz.x=chkhuprct.right-chkhuprct.left;                                                           
//#11729                tsiz.y=chkhuprct.top-chkhuprct.bottom;                                                           
//#11730                if(tsiz.x>ini.hupx){                                                           
//#11731                                                                           
//#11732                    ini.hupx=tsiz.x;                                                       
//#11733                    setMap(HUPCHNG);                                                       
//#11734                }                                                           
//#11735                if(tsiz.y>ini.hupy){                                                           
//#11736                                                                           
//#11737                    ini.hupy=tsiz.y;                                                       
//#11738                    setMap(HUPCHNG);                                                       
//#11739                }                                                           
//#11740                descntr.x=tsiz.x/2+chkhuprct.left;                                                           
//#11741                descntr.y=tsiz.y/2+chkhuprct.bottom;                                                           
//#11742                hupcntr.x=ini.hupx/2;                                                           
//#11743                hupcntr.y=ini.hupy/2;                                                           
//#11744                dif.x=hupcntr.x-descntr.x;                                                           
//#11745                dif.y=hupcntr.y-descntr.y;                                                           
//#11746                for(ind=0;ind<hed.stchs;ind++){                                                           
//#11747                                                                           
//#11748                    stchs[ind].x+=dif.x;                                                       
//#11749                    stchs[ind].y+=dif.y;                                                       
//#11750                }                                                           
//#11751                for(ind=0;ind<fltad;ind++){                                                           
//#11752                                                                           
//#11753                    flts[ind].x+=dif.x;                                                       
//#11754                    flts[ind].y+=dif.y;                                                       
//#11755                }                                                           
//#11756                for(ind=0;ind<formpnt;ind++){                                                           
//#11757                                                                           
//#11758                    formlst[ind].rct.left+=dif.x;                                                       
//#11759                    formlst[ind].rct.right+=dif.x;                                                       
//#11760                    formlst[ind].rct.top+=dif.y;                                                       
//#11761                    formlst[ind].rct.bottom+=dif.y;                                                       
//#11762                }                                                           
//#11763                zum0.x=ini.hupx;                                                           
//#11764                zum0.y=ini.hupy;                                                           
//#11765                zumflor=(double)MINZUM/zum0.x;                                                           
//#11766                zumhom();                                                           
//#11767            }                                                               
//#11768        }                                                                   
//#11769    }                                                                       
//#11770                                                                           
//#11771    void chkhup(){                                                                       
//#11772                                                                           
//#11773        setMap(HUPEX);                                                                   
//#11774        hupfn();                                                                   
//#11775        if(chkMap(INIT))                                                                   
//#11776            prfmsg();                                                               
//#11777        setfchk();                                                                   
//#11778    }                                                                       
//#11779                                                                           
//#11780    int strcomp( const void *arg1, const void *arg2 ){                                                                       
//#11781                                                                           
//#11782       return _stricmp(*(TCHAR**)arg1,*(TCHAR**)arg2);                                                                       
//#11783    }                                                                       
//#11784                                                                           
//#11785    void strlcpy(TCHAR* dst,TCHAR* src){                                                                       
//#11786                                                                           
//#11787        _asm{                                                                   
//#11788                                                                           
//#11789                mov        ebx,offset upmap                                                   
//#11790                mov        ecx,dst                                                   
//#11791                mov        edx,src                                                   
//#11792                xor        eax,eax                                                   
//#11793    lup:        mov        al,[edx]                                                       
//#11794                inc        edx                                                   
//#11795                or        al,al                                                   
//#11796                je        lupx                                                   
//#11797                and        al,0x7f                                                   
//#11798                bt        [ebx],eax                                                   
//#11799                jnc        short lup1                                                   
//#11800                or        al,0x20                                                   
//#11801    lup1:        mov        [ecx],al                                                       
//#11802                inc        ecx                                                   
//#11803                jmp        lup                                                   
//#11804    lupx:        mov        [ecx],al                                                       
//#11805        }                                                                   
//#11806    }                                                                       
//#11807                                                                           
//#11808    TCHAR lchr(int op){                                                                       
//#11809                                                                           
//#11810        _asm{                                                                   
//#11811                                                                           
//#11812                mov        ebx,offset upmap                                                   
//#11813                mov        eax,op                                                   
//#11814                and        eax,0x7f                                                   
//#11815                bt        [ebx],eax                                                   
//#11816                jnc        short lchrx                                                   
//#11817                or        al,0x20                                                   
//#11818    lchrx:                                                                       
//#11819        }                                                                   
//#11820    }                                                                       
//#11821                                                                           
//#11822    void barnam(HWND hndl,unsigned fpnt){                                                                       
//#11823                                                                           
//#11824        TCHAR        buf[MAX_PATH];                                                           
//#11825        TCHAR*        pchr;                                                           
//#11826                                                                           
//#11827        if(fpnt<thumdcnt&&thumsel[fpnt]){                                                                   
//#11828                                                                           
//#11829            strcpy(buf,thumsel[fpnt]);                                                               
//#11830            pchr=strrchr(buf,'.');                                                               
//#11831            if(pchr)                                                               
//#11832                pchr[0]=0;                                                           
//#11833            SetWindowText(hndl,buf);                                                               
//#11834        }                                                                   
//#11835        else                                                                   
//#11836            SetWindowText(hndl,"");                                                               
//#11837    }                                                                       
//#11838                                                                           
//#11839    void rthumnam(unsigned ind){                                                                       
//#11840                                                                           
//#11841        switch(ind){                                                                   
//#11842                                                                           
//#11843        case 0:                                                                   
//#11844                                                                           
//#11845            barnam(hbuts[HNUM],ind);                                                               
//#11846            break;                                                               
//#11847                                                                           
//#11848        case 1:                                                                   
//#11849                                                                           
//#11850            barnam(hbuts[HTOT],ind);                                                               
//#11851            break;                                                               
//#11852                                                                           
//#11853        case 2:                                                                   
//#11854                                                                           
//#11855            barnam(hbuts[HMINLEN],ind);                                                               
//#11856            break;                                                               
//#11857                                                                           
//#11858        case 3:                                                                   
//#11859                                                                           
//#11860            barnam(hbuts[HMAXLEN],ind);                                                               
//#11861            break;                                                               
//#11862        }                                                                   
//#11863    }                                                                       
//#11864                                                                           
//#11865    void thumnail(){                                                                       
//#11866                                                                           
//#11867        WIN32_FIND_DATA    fdat;                                                               
//#11868        unsigned        ind,ine;                                                           
//#11869        HANDLE            shndl;                                                       
//#11870        TCHAR*            pchr;                                                       
//#11871                                                                           
//#11872        unbsho();                                                                   
//#11873        undat();                                                                   
//#11874        untrace();                                                                   
//#11875        thumnams=(TCHAR*)oseq;                                                                   
//#11876        pthums=(TCHAR**)&oseq[MAXSEQ>>1];                                                                   
//#11877                                                                           
//#11878        SetCurrentDirectory(defDir);                                                                   
//#11879        strcpy(srchnam,defDir);                                                                   
//#11880        pchr=&srchnam[strlen(srchnam)-1];                                                                   
//#11881        if(pchr[0]!='\\'){                                                                   
//#11882                                                                           
//#11883            pchr[1]='\\';                                                               
//#11884            pchr[2]=0;                                                               
//#11885        }                                                                   
//#11886        strcat(srchnam,"*.thr");                                                                   
//#11887        shndl=FindFirstFile(srchnam,&fdat);                                                                   
//#11888        if(shndl==INVALID_HANDLE_VALUE){                                                                   
//#11889                                                                           
//#11890            sprintf(msgbuf,"Can't find %s\n",srchnam);                                                               
//#11891            shoMsg(msgbuf);                                                               
//#11892            unthum();                                                               
//#11893        }                                                                   
//#11894        else{                                                                   
//#11895                                                                           
//#11896            ine=0;                                                               
//#11897            pthums[0]=thumnams;                                                               
//#11898            strcpy(pthums[0],fdat.cFileName);                                                               
//#11899            ine+=strlen(fdat.cFileName)+1;                                                               
//#11900            pthums[1]=&thumnams[ine];                                                               
//#11901            ind=1;                                                               
//#11902            while(FindNextFile(shndl,&fdat)){                                                               
//#11903                                                                           
//#11904                strcpy(pthums[ind],fdat.cFileName);                                                           
//#11905                ine+=strlen(fdat.cFileName)+1;                                                           
//#11906                pthums[++ind]=&thumnams[ine];                                                           
//#11907            }                                                               
//#11908            FindClose(shndl);                                                               
//#11909            thumcnt=ind;                                                               
//#11910            qsort((void*)&pthums[0],ind,4,strcomp);                                                               
//#11911            ind=thumind=0;                                                               
//#11912            while(ind<4&&thumind<thumcnt&&ind<thumcnt){                                                               
//#11913                                                                           
//#11914                thumsel[ind]=pthums[ind];                                                           
//#11915                ind++;                                                           
//#11916            }                                                               
//#11917            thumind=thumdcnt=ind;                                                               
//#11918            while(ind<4&&ind<thumcnt)                                                               
//#11919                rthumnam(ind++);                                                           
//#11920            setMap(THUMSHO);                                                               
//#11921            thumsrch[0]=0;                                                               
//#11922            SetWindowText(hbuts[HBOXSEL],"");                                                               
//#11923            butxt(HBOXSEL,"");                                                               
//#11924            vubak();                                                               
//#11925            setMap(RESTCH);                                                               
//#11926        }                                                                   
//#11927    }                                                                       
//#11928                                                                           
//#11929    void nuthsel(){                                                                       
//#11930                                                                           
//#11931        unsigned ind,len,bakind;                                                                   
//#11932                                                                           
//#11933        if(thumind<thumcnt){                                                                   
//#11934                                                                           
//#11935            bakind=thumind;                                                               
//#11936            ind=0;                                                               
//#11937            len=strlen(thumsrch);                                                               
//#11938            setMap(RESTCH);                                                               
//#11939            if(len){                                                               
//#11940                                                                           
//#11941                while(ind<4&&thumind<thumcnt){                                                           
//#11942                                                                           
//#11943                    if(!strncmp(thumsrch,pthums[thumind],len)){                                                       
//#11944                                                                           
//#11945                        thumsel[ind]=pthums[thumind];                                                   
//#11946                        redraw(hvu[ind++]);                                                   
//#11947                    }                                                       
//#11948                    thumind++;                                                       
//#11949                }                                                           
//#11950            }                                                               
//#11951            else{                                                               
//#11952                                                                           
//#11953                while(ind<4&&thumind<thumcnt){                                                           
//#11954                                                                           
//#11955                    thumsel[ind]=pthums[thumind];                                                       
//#11956                    redraw(hvu[ind++]);                                                       
//#11957                    thumind++;                                                       
//#11958                }                                                           
//#11959            }                                                               
//#11960            if(ind){                                                               
//#11961                                                                           
//#11962                thumdcnt=ind;                                                           
//#11963                while(ind<4)                                                           
//#11964                    rthumnam(ind++);                                                       
//#11965            }                                                               
//#11966            else                                                               
//#11967                thumind=bakind;                                                           
//#11968        }                                                                   
//#11969    }                                                                       
//#11970                                                                           
//#11971    void nuthbak(unsigned cnt){                                                                       
//#11972                                                                           
//#11973        unsigned len;                                                                   
//#11974                                                                           
//#11975        if(thumind){                                                                   
//#11976                                                                           
//#11977            len=strlen(thumsrch);                                                               
//#11978            if(len){                                                               
//#11979                                                                           
//#11980                while(cnt&&thumind<MAXFORMS){                                                           
//#11981                                                                           
//#11982                    if(thumind){                                                       
//#11983                                                                           
//#11984                        thumind--;                                                   
//#11985                        if(!strncmp(thumsrch,pthums[thumind],len))                                                   
//#11986                            cnt--;                                               
//#11987                    }                                                       
//#11988                    else                                                       
//#11989                        break;                                                   
//#11990                }                                                           
//#11991            }                                                               
//#11992            else                                                               
//#11993                thumind-=cnt;                                                           
//#11994            if(thumind>MAXFORMS)                                                               
//#11995                thumind=0;                                                           
//#11996            nuthsel();                                                               
//#11997        }                                                                   
//#11998    }                                                                       
//#11999                                                                           
//#12000    void nuthum(TCHAR chr){                                                                       
//#12001                                                                           
//#12002        unsigned ind;                                                                   
//#12003                                                                           
//#12004        ind=strlen(thumsrch);                                                                   
//#12005        if(ind<16){                                                                   
//#12006                                                                           
//#12007            setMap(RESTCH);                                                               
//#12008            thumsrch[ind++]=chr;                                                               
//#12009            thumsrch[ind]=0;                                                               
//#12010            butxt(HBOXSEL,thumsrch);                                                               
//#12011            thumind=0;                                                               
//#12012            nuthsel();                                                               
//#12013        }                                                                   
//#12014    }                                                                       
//#12015                                                                           
//#12016    void bakthum(){                                                                       
//#12017                                                                           
//#12018        unsigned ind;                                                                   
//#12019                                                                           
//#12020        ind=strlen(thumsrch);                                                                   
//#12021        if(ind){                                                                   
//#12022                                                                           
//#12023            setMap(RESTCH);                                                               
//#12024            thumsrch[--ind]=0;                                                               
//#12025            thumind=0;                                                               
//#12026            butxt(HBOXSEL,thumsrch);                                                               
//#12027            nuthsel();                                                               
//#12028        }                                                                   
//#12029    }                                                                       
//#12030                                                                           
//#12031    void selalstch(){                                                                       
//#12032                                                                           
//#12033        if(hed.stchs){                                                                   
//#12034                                                                           
//#12035            cloInd=0;                                                               
//#12036            grpInd=hed.stchs-1;                                                               
//#12037            gpnt0=cloInd;                                                               
//#12038            gpnt1=grpInd;                                                               
//#12039            setMap(GRPSEL);                                                               
//#12040            setMap(SCROS);                                                               
//#12041            setMap(ECROS);                                                               
//#12042            grpAdj();                                                               
//#12043            setMap(RESTCH);                                                               
//#12044        }                                                                   
//#12045    }                                                                       
//#12046                                                                           
//#12047    void insflin(POINT ipnt){                                                                       
//#12048                                                                           
//#12049        POINT off;                                                                   
//#12050                                                                           
//#12051        off.x=inspnt.x>>1;                                                                   
//#12052        off.y=inspnt.y>>1;                                                                   
//#12053                                                                           
//#12054        flin[0].x=flin[3].x=flin[4].x=ipnt.x-off.x;                                                                   
//#12055        flin[1].x=flin[2].x=ipnt.x+off.x;                                                                   
//#12056        flin[0].y=flin[1].y=flin[4].y=ipnt.y-off.y;                                                                   
//#12057        flin[2].y=flin[3].y=ipnt.y+off.y;                                                                   
//#12058    }                                                                       
//#12059                                                                           
//#12060    BOOL isthr(TCHAR* nam){                                                                       
//#12061                                                                           
//#12062        TCHAR* pchr;                                                                   
//#12063                                                                           
//#12064        pchr=strrchr(nam,'.');                                                                   
//#12065        if(pchr){                                                                   
//#12066                                                                           
//#12067            pchr++;                                                               
//#12068            if(!strnicmp(pchr,"th",2))                                                               
//#12069                return 1;                                                           
//#12070            else                                                               
//#12071                return 0;                                                           
//#12072        }                                                                   
//#12073        else                                                                   
//#12074            return 1;                                                               
//#12075    }                                                                       
//#12076                                                                           
//#12077    unsigned gethand(SHRTPNT* pstch,unsigned cnt){                                                                       
//#12078                                                                           
//#12079        unsigned ind;                                                                   
//#12080        unsigned ocnt;                                                                   
//#12081                                                                           
//#12082        ocnt=0;                                                                   
//#12083        for(ind=0;ind<cnt;ind++){                                                                   
//#12084                                                                           
//#12085            if(pstch[ind].at&USMSK)                                                               
//#12086                ocnt++;                                                           
//#12087        }                                                                   
//#12088        return ocnt;                                                                   
//#12089    }                                                                       
//#12090                                                                           
//#12091    void insfil(){                                                                       
//#12092                                                                           
//#12093        OPENFILENAME oin={                                                                   
//#12094                                                                           
//#12095            sizeof(OPENFILENAME),    //lStructsize                                                           
//#12096            hWnd,                    //hwndOwner                                            
//#12097            hInst,                    //hInstance                                            
//#12098            THR files\0*.thr\0\0,    //lpstrFilter                                                            
//#12099            cstFltr,                //lpstrCustomFilter                                                
//#12100            MAX_PATH,                //nMaxCustFilter                                                
//#12101            0                        //nFilterIndex                                        
//#12102            insnam,                    //lpstrFile                                            
//#12103            MAX_PATH,                //nMaxFile                                                
//#12104            0                        //lpstrFileTitle                                        
//#12105            0                        //nMaxFileTitle                                        
//#12106            defDir,                    //lpstr    ialDir                                        
//#12107            0                        //lpstrTitle                                       
//#12108            OFN_EXPLORER|OFN_OVERWRITEPROMPT,//Flags                                                               
//#12109            0                        //nFileOffset                                       
//#12110            0                        //nFileExtension                                        
//#12111            thr,                    //lpstrDefExt                                            
//#12112            0                        //lCustData                                        
//#12113            0                        //lpfnHook                                       
//#12114            0                        //lpTemplateName                                       
//#12115        };                                                                   
//#12116        STRHED        thed;                                                           
//#12117        STREX        thedx;                                                           
//#12118        HED            tphed;                                                       
//#12119        unsigned    ind,ine,cod,codof;                                                               
//#12120        FLRCT        trct;                                                           
//#12121        FLPNT        tsiz;                                                           
//#12122        POINT        tpnt;                                                           
//#12123        PCSTCH*        tbuf;                                                           
//#12124        double        homscor;                                                           
//#12125        double        filscor;                                                           
//#12126        unsigned    vervar;                                                               
//#12127        FRMHEDO*    frmlstx;                                                               
//#12128                                                                           
//#12129        if(chkMap(IGNORINS)||GetOpenFileName(&oin)){                                                                   
//#12130                                                                           
//#12131            hinsf=CreateFile(insnam,(GENERIC_READ),0,NULL,                                                               
//#12132                    OPEN_EXISTING,0,NULL);                                                       
//#12133            if(hinsf==INVALID_HANDLE_VALUE){                                                               
//#12134                                                                           
//#12135                filnopn(IDS_FNOPN,insnam);                                                           
//#12136                hFil=0;                                                           
//#12137                CloseHandle(hinsf);                                                           
//#12138            }                                                               
//#12139            else{                                                               
//#12140                                                                           
//#12141                insfstch=hed.stchs;                                                           
//#12142                if(isthr(insnam)){                                                           
//#12143                                                                           
//#12144                    ReadFile(hinsf,(STRHED*)&thed,sizeof(STRHED),&red,NULL);                                                       
//#12145                    if((thed.led&0xffffff)!=0x746872)                                                       
//#12146                        tabmsg(IDS_NOTHR);                                                   
//#12147                    else{                                                       
//#12148                                                                           
//#12149                        vervar=(thed.led&0xff000000)>>24;                                                   
//#12150                        if(vervar){                                                   
//#12151    #define FRMW 5                                                                       
//#12152    #define HANDW 4                                                                       
//#12153    #define FRMPW 2                                                                       
//#12154    #define STCHW 1                                                                       
//#12155                            gethand(stchs,hed.stchs);                                               
//#12156                            homscor=(double)                                               
//#12157                                formpnt*FRMW+                                           
//#12158                                gethand(stchs,hed.stchs)*HANDW+                                           
//#12159                                fltad*FRMPW+                                           
//#12160                                hed.stchs*STCHW;                                           
//#12161                            ReadFile(hinsf,(STREX*)&thedx,sizeof(STREX),&red,0);                                               
//#12162                        }                                                   
//#12163                        savdo();                                                   
//#12164                        ReadFile(hinsf,(SHRTPNT*)&stchs[hed.stchs],thed.stchs*sizeof(SHRTPNT),&red,NULL);                                                   
//#12165                        SetFilePointer(hinsf,164,0,FILE_CURRENT);                                                   
//#12166                        trct.left=trct.bottom=(float)1e9;                                                   
//#12167                        trct.top=trct.right=(float)1e-9;                                                   
//#12168                        codof=formpnt<<FRMSHFT;                                                   
//#12169                        insflt=fltad;insfpnt=formpnt;                                                   
//#12170                        if(thed.fcnt){                                                   
//#12171                                                                           
//#12172                            if(vervar<2){                                               
//#12173                                                                           
//#12174                                frmlstx=(FRMHEDO*)&bseq;                                           
//#12175                                ReadFile(hinsf,(FRMHEDO*)&bseq,thed.fpnt*sizeof(FRMHEDO),&red,0);                                           
//#12176                                if(red!=thed.fpnt*sizeof(FRMHEDO)){                                           
//#12177                                                                           
//#12178                                    formpnt=red/sizeof(FRMHEDO);                                       
//#12179                                    setMap(BADFIL);                                       
//#12180                                }                                           
//#12181                                if(formpnt+thed.fcnt<MAXFORMS){                                           
//#12182                                                                           
//#12183                                    FillMemory(&formlst[formpnt],thed.fpnt*sizeof(FRMHED),0);                                       
//#12184                                    ine=formpnt;                                       
//#12185                                    for(ind=0;ind<thed.fpnt;ind++){                                       
//#12186                                                                           
//#12187                                        MoveMemory(&formlst[ine],&frmlstx[ind],sizeof(FRMHEDO));                                   
//#12188                                        ine++;                                   
//#12189                                    }                                       
//#12190                                }                                           
//#12191                            }                                               
//#12192                            else                                               
//#12193                                ReadFile(hinsf,(FRMHED*)&formlst[formpnt],thed.fpnt*sizeof(FRMHED),&red,0);                                           
//#12194                            ReadFile(hinsf,(FLPNT*)&flts[fltad],thed.fcnt*sizeof(FLPNT),&red,0);                                               
//#12195                            ReadFile(hinsf,(SATCON*)&satks[satkad],thed.scnt*sizeof(SATCON),&red,0);                                               
//#12196                            ReadFile(hinsf,(FLPNT*)&clps[clpad],thed.ecnt*sizeof(FLPNT),&red,0);                                               
//#12197                            CloseHandle(hinsf);                                               
//#12198                            hinsf=0;                                               
//#12199                            for(ind=formpnt;ind<formpnt+thed.fpnt;ind++){                                               
//#12200                                                                           
//#12201                                formlst[ind].flt=adflt(formlst[ind].sids);                                           
//#12202                                if(formlst[ind].typ==SAT){                                           
//#12203                                                                           
//#12204                                    if(formlst[ind].stpt)                                       
//#12205                                        formlst[ind].sacang.sac=adsatk(formlst[ind].stpt);                                   
//#12206                                    if(isclpx(ind))                                       
//#12207                                        formlst[ind].angclp.clp=adclp(formlst[ind].flencnt.nclp);                                   
//#12208                                }                                           
//#12209                                if(isclp(ind))                                           
//#12210                                    formlst[ind].angclp.clp=adclp(formlst[ind].flencnt.nclp);                                       
//#12211                                if(iseclpx(ind))                                           
//#12212                                    formlst[ind].clp=adclp(formlst[ind].nclp);                                       
//#12213                            }                                               
//#12214                            formpnt+=thed.fpnt;                                               
//#12215                            if(thed.fpnt){                                               
//#12216                                                                           
//#12217                                trct.left=trct.right=flts[insflt].x;                                           
//#12218                                trct.bottom=trct.top=flts[insflt].y;                                           
//#12219                                for(ind=insflt+1;ind<fltad;ind++){                                           
//#12220                                                                           
//#12221                                    if(flts[ind].x<trct.left)                                       
//#12222                                        trct.left=flts[ind].x;                                   
//#12223                                    if(flts[ind].x>trct.right)                                       
//#12224                                        trct.right=flts[ind].x;                                   
//#12225                                    if(flts[ind].y<trct.bottom)                                       
//#12226                                        trct.bottom=flts[ind].y;                                   
//#12227                                    if(flts[ind].y>trct.top)                                       
//#12228                                        trct.top=flts[ind].y;                                   
//#12229                                }                                           
//#12230                            }                                               
//#12231                        }                                                   
//#12232                        if(thed.stchs){                                                   
//#12233                                                                           
//#12234                            for(ind=hed.stchs;ind<(unsigned)hed.stchs+thed.stchs;ind++){                                               
//#12235                                                                           
//#12236                                if(stchs[ind].at&ALTYPMSK){                                           
//#12237                                                                           
//#12238                                    cod=(stchs[ind].at&FRMSK)+codof;                                       
//#12239                                    stchs[ind].at&=NFRMSK;                                       
//#12240                                    stchs[ind].at|=cod;                                       
//#12241                                }                                           
//#12242                                if(stchs[ind].x<trct.left)                                           
//#12243                                    trct.left=stchs[ind].x;                                       
//#12244                                if(stchs[ind].x>trct.right)                                           
//#12245                                    trct.right=stchs[ind].x;                                       
//#12246                                if(stchs[ind].y<trct.bottom)                                           
//#12247                                    trct.bottom=stchs[ind].y;                                       
//#12248                                if(stchs[ind].y>trct.top)                                           
//#12249                                    trct.top=stchs[ind].y;                                       
//#12250                            }                                               
//#12251                        }                                                   
//#12252                        if(thed.led&0x1000000){                                                   
//#12253                                                                           
//#12254                            filscor=(double)thed.fpnt*FRMW+                                               
//#12255                                gethand(&stchs[hed.stchs],thed.stchs)*HANDW+                                           
//#12256                                thed.fpnts*FRMPW+                                           
//#12257                                thed.stchs*STCHW;                                           
//#12258                            if(filscor>homscor){                                               
//#12259                                                                           
//#12260                                for(ind=0;ind<50;ind++)                                           
//#12261                                    hedx.crtnam[ind]=thedx.crtnam[ind];                                       
//#12262                                redfnam(fildes);                                           
//#12263                                sprintf(msgbuf,stab[STR_THRDBY],thrnam,fildes);                                           
//#12264                                SetWindowText(hWnd,msgbuf);                                           
//#12265                            }                                               
//#12266                        }                                                   
//#12267                        inscntr.x=(trct.right-trct.left)/2+trct.left;                                                   
//#12268                        inscntr.y=(trct.top-trct.bottom)/2+trct.bottom;                                                   
//#12269                        hed.stchs+=thed.stchs;                                                   
//#12270                        tsiz.x=trct.right-trct.left;                                                   
//#12271                        tsiz.y=trct.top-trct.bottom;                                                   
//#12272                        ratsr();                                                   
//#12273                        inspnt.x=tsiz.x*hfrat;                                                   
//#12274                        inspnt.y=tsiz.y*hfrat;                                                   
//#12275                        tpnt.x=scRct.right>>1;                                                   
//#12276                        tpnt.y=scRct.bottom>>1;                                                   
//#12277                        insflin(tpnt);                                                   
//#12278                        nuflen=5;                                                   
//#12279                        setMap(SHOFRM);                                                   
//#12280                        setMap(INSFIL);                                                   
//#12281                        dufrm();                                                   
//#12282                    }                                                       
//#12283                }                                                           
//#12284                else{                                                           
//#12285                                                                           
//#12286                    ReadFile(hinsf,(HED*)&tphed,0x46,&red,NULL);                                                       
//#12287                    if(hed.ledIn==0x32&&hed.fColCnt==16){                                                       
//#12288                                                                           
//#12289                        savdo();                                                   
//#12290                        tbuf=(PCSTCH*)bseq;                                                   
//#12291                        ReadFile(hinsf,(PCSTCH*)tbuf,tphed.stchs*sizeof(PCSTCH),&red,NULL);                                                   
//#12292                        ine=hed.stchs;                                                   
//#12293                        cod=0;                                                   
//#12294                        for(ind=0;ind<tphed.stchs;ind++){                                                   
//#12295                                                                           
//#12296                            if(tbuf[ind].typ==3)                                               
//#12297                                cod=tbuf[ind++].fx;                                           
//#12298                            else{                                               
//#12299                                                                           
//#12300                                stchs[ine].x=tbuf[ind].x+(float)tbuf[ind].fx/256;                                           
//#12301                                stchs[ine].y=tbuf[ind].y+(float)tbuf[ind].fy/256;                                           
//#12302                                stchs[ine++].at=cod;                                           
//#12303                            }                                               
//#12304                        }                                                   
//#12305                        ind=hed.stchs;                                                   
//#12306                        trct.left=trct.right=stchs[ind].x;                                                   
//#12307                        trct.top=trct.bottom=stchs[ind++].y;                                                   
//#12308                        while(ind<(unsigned)ine){                                                   
//#12309                                                                           
//#12310                            if(stchs[ind].x<trct.left)                                               
//#12311                                trct.left=stchs[ind].x;                                           
//#12312                            if(stchs[ind].x>trct.right)                                               
//#12313                                trct.right=stchs[ind].x;                                           
//#12314                            if(stchs[ind].y<trct.bottom)                                               
//#12315                                trct.bottom=stchs[ind].y;                                           
//#12316                            if(stchs[ind].y>trct.top)                                               
//#12317                                trct.top=stchs[ind].y;                                           
//#12318                            ind++;                                               
//#12319                        }                                                   
//#12320                        inscntr.x=(trct.right-trct.left)/2+trct.left;                                                   
//#12321                        inscntr.y=(trct.top-trct.bottom)/2+trct.bottom;                                                   
//#12322                        hed.stchs=ine;                                                   
//#12323                        tsiz.x=trct.right-trct.left;                                                   
//#12324                        tsiz.y=trct.top-trct.bottom;                                                   
//#12325                        ratsr();                                                   
//#12326                        inspnt.x=tsiz.x*hfrat;                                                   
//#12327                        inspnt.y=tsiz.y*hfrat;                                                   
//#12328                        tpnt.x=scRct.right>>1;                                                   
//#12329                        tpnt.y=scRct.bottom>>1;                                                   
//#12330                        insflin(tpnt);                                                   
//#12331                        nuflen=5;                                                   
//#12332                        setMap(SHOFRM);                                                   
//#12333                        setMap(INSFIL);                                                   
//#12334                        dufrm();                                                   
//#12335                    }                                                       
//#12336                }                                                           
//#12337                if(hinsf)                                                           
//#12338                    CloseHandle(hinsf);                                                       
//#12339            }                                                               
//#12340        }                                                                   
//#12341    }                                                                       
//#12342                                                                           
//#12343    void duinsfil(){                                                                       
//#12344                                                                           
//#12345        FLPNT        off;                                                           
//#12346        unsigned    ind;                                                               
//#12347        FLRCT*        trct;                                                           
//#12348                                                                           
//#12349        px2stch();                                                                   
//#12350        off.x=sPnt.x-inscntr.x;                                                                   
//#12351        off.y=sPnt.y-inscntr.y;                                                                   
//#12352        for(ind=insfpnt;ind<formpnt;ind++){                                                                   
//#12353                                                                           
//#12354            trct=&formlst[ind].rct;                                                               
//#12355            trct->bottom+=off.y;                                                               
//#12356            trct->top+=off.y;                                                               
//#12357            trct->left+=off.x;                                                               
//#12358            trct->right+=off.x;                                                               
//#12359        }                                                                   
//#12360        for(ind=insflt;ind<fltad;ind++){                                                                   
//#12361                                                                           
//#12362            flts[ind].x+=off.x;                                                               
//#12363            flts[ind].y+=off.y;                                                               
//#12364        }                                                                   
//#12365        for(ind=insfstch;ind<hed.stchs;ind++){                                                                   
//#12366                                                                           
//#12367            stchs[ind].x+=off.x;                                                               
//#12368            stchs[ind].y+=off.y;                                                               
//#12369        }                                                                   
//#12370        rstMap(FRMOF);                                                                   
//#12371        setMap(INIT);                                                                   
//#12372        coltab();                                                                   
//#12373        setMap(RESTCH);                                                                   
//#12374    }                                                                       
//#12375                                                                           
//#12376    void gotbox(){                                                                       
//#12377                                                                           
//#12378        rstMap(BZUMIN);                                                                   
//#12379        rstMap(BOXSLCT);                                                                   
//#12380        rstMap(FRMPSEL);                                                                   
//#12381        grpAdj();                                                                   
//#12382    }                                                                       
//#12383                                                                           
//#12384    void rngal(){                                                                       
//#12385                                                                           
//#12386        unsigned    ind,ine,in;                                                               
//#12387        unsigned    pmax,maxlen,len;                                                               
//#12388        RANG*        prng;                                                           
//#12389                                                                           
//#12390        if(!rstMap(WASFPNT)){                                                                   
//#12391                                                                           
//#12392            rstMap(GRPSEL);                                                               
//#12393            ind=ine=in=0;                                                               
//#12394            prng=(RANG*)&bseq;                                                               
//#12395            rstMap(GRPSEL);                                                               
//#12396            while(ind<hed.stchs){                                                               
//#12397                                                                           
//#12398                if(inrng(ind)){                                                           
//#12399                                                                           
//#12400                    if(!in){                                                       
//#12401                                                                           
//#12402                        prng[ine].strt=ind;                                                   
//#12403                        in=1;                                                   
//#12404                    }                                                       
//#12405                }                                                           
//#12406                else{                                                           
//#12407                                                                           
//#12408                    if(in){                                                       
//#12409                                                                           
//#12410                        prng[ine].fin=ind-1;                                                   
//#12411                        ine++;                                                   
//#12412                        in=0;                                                   
//#12413                    }                                                       
//#12414                }                                                           
//#12415                ind++;                                                           
//#12416            }                                                               
//#12417            if(in){                                                               
//#12418                                                                           
//#12419                prng[ine].fin=ind-1;                                                           
//#12420                ine++;                                                           
//#12421            }                                                               
//#12422            if(ine){                                                               
//#12423                                                                           
//#12424                maxlen=0;                                                           
//#12425                for(ind=0;ind<ine;ind++){                                                           
//#12426                                                                           
//#12427                    len=prng[ind].fin-prng[ind].strt;                                                       
//#12428                    if(len>maxlen){                                                       
//#12429                                                                           
//#12430                        maxlen=len;                                                   
//#12431                        pmax=ind;                                                   
//#12432                    }                                                       
//#12433                }                                                           
//#12434                if(maxlen){                                                           
//#12435                                                                           
//#12436                    cloInd=prng[pmax].strt;                                                       
//#12437                    grpInd=prng[pmax].fin;                                                       
//#12438                    setMap(GRPSEL);                                                       
//#12439                }                                                           
//#12440                gotbox();                                                           
//#12441            }                                                               
//#12442        }                                                                   
//#12443    }                                                                       
//#12444                                                                           
//#12445    void nucols(){                                                                       
//#12446                                                                           
//#12447        unsigned ind;                                                                   
//#12448                                                                           
//#12449        clRmap((formpnt<<5)+1);                                                                   
//#12450        for(ind=0;ind<fselpnt;ind++){                                                                   
//#12451                                                                           
//#12452            setr(selist[ind]);                                                               
//#12453            frmpnt=&formlst[ind];                                                               
//#12454            if(frmpnt->ftyp){                                                               
//#12455                                                                           
//#12456                frmpnt->fcol=actcol;                                                           
//#12457                frmpnt->dhx.fth.fthcol=actcol;                                                           
//#12458            }                                                               
//#12459            if(frmpnt->etyp)                                                               
//#12460                frmpnt->bcol=actcol;                                                           
//#12461            if(frmpnt->xat&(AT_UND|AT_WALK|AT_CWLK))                                                               
//#12462                frmpnt->ucol=actcol;                                                           
//#12463        }                                                                   
//#12464        for(ind=0;ind<hed.stchs;ind++){                                                                   
//#12465                                                                           
//#12466            if(chkr((stchs[ind].at&FRMSK)>>FRMSHFT)&&(stchs[ind].at&TYPMSK)!=TYPMSK){                                                               
//#12467                                                                           
//#12468                stchs[ind].at&=NCOLMSK;                                                           
//#12469                stchs[ind].at|=actcol;                                                           
//#12470            }                                                               
//#12471        }                                                                   
//#12472    }                                                                       
//#12473                                                                           
//#12474    BOOL dunum(unsigned cod){                                                                       
//#12475                                                                           
//#12476        if(cod>='0'&&cod<='9'){                                                                   
//#12477                                                                           
//#12478            numcod=cod;                                                               
//#12479            return 1;                                                               
//#12480        }                                                                   
//#12481        if(cod>=VK_NUMPAD0&&cod<=VK_NUMPAD9){                                                                   
//#12482                                                                           
//#12483            numcod=cod-'0';                                                               
//#12484            return 1;                                                               
//#12485        }                                                                   
//#12486        return 0;                                                                   
//#12487    }                                                                       
//#12488                                                                           
//#12489    void stchrct(FLRCT* rct)                                                                       
//#12490    {                                                                       
//#12491        unsigned ind;                                                                   
//#12492                                                                           
//#12493        if(hed.stchs)                                                                   
//#12494        {                                                                   
//#12495            rct->bottom=rct->left=1e10;                                                               
//#12496            rct->top=rct->right=0;                                                               
//#12497            if(hed.stchs){                                                               
//#12498                                                                           
//#12499                for(ind=0;ind<hed.stchs;ind++){                                                           
//#12500                                                                           
//#12501                    if(stchs[ind].x<rct->left)                                                       
//#12502                        rct->left=stchs[ind].x;                                                   
//#12503                    if(stchs[ind].x>rct->right)                                                       
//#12504                        rct->right=stchs[ind].x;                                                   
//#12505                    if(stchs[ind].y<rct->bottom)                                                       
//#12506                        rct->bottom=stchs[ind].y;                                                   
//#12507                    if(stchs[ind].y>rct->top)                                                       
//#12508                        rct->top=stchs[ind].y;                                                   
//#12509                }                                                           
//#12510            }                                                               
//#12511        }                                                                   
//#12512    }                                                                       
//#12513                                                                           
//#12514    void frmrct(FLRCT* rct)                                                                       
//#12515    {                                                                       
//#12516        unsigned ind;                                                                   
//#12517                                                                           
//#12518        rct->left=rct->right=flts[0].x;                                                                   
//#12519        rct->top=rct->bottom=flts[0].y;                                                                   
//#12520        for(ind=0;ind<fltad;ind++){                                                                   
//#12521                                                                           
//#12522            if(flts[ind].x<rct->left)                                                               
//#12523                rct->left=flts[ind].x;                                                           
//#12524            if(flts[ind].x>rct->right)                                                               
//#12525                rct->right=flts[ind].x;                                                           
//#12526            if(flts[ind].y>rct->top)                                                               
//#12527                rct->top=flts[ind].y;                                                           
//#12528            if(flts[ind].y<rct->bottom)                                                               
//#12529                rct->bottom=flts[ind].y;                                                           
//#12530        }                                                                   
//#12531    }                                                                       
//#12532                                                                           
//#12533    void desiz(){                                                                       
//#12534                                                                           
//#12535        FLRCT        trct;                                                           
//#12536        FLOAT        sizx,sizy;                                                           
//#12537        TCHAR*        pmsg;                                                           
//#12538                                                                           
//#12539        pmsg=msgbuf;                                                                   
//#12540        if(hed.stchs){                                                                   
//#12541                                                                           
//#12542            stchrct(&trct);                                                               
//#12543            sizx=(trct.right-trct.left)/PFGRAN;                                                               
//#12544            sizy=(trct.top-trct.bottom)/PFGRAN;                                                               
//#12545            if((trct.left<0)||(trct.bottom<0)||(trct.right>ini.hupx)||(trct.top>ini.hupy)){                                                               
//#12546                                                                           
//#12547                strcpy(msgbuf,stab[STR_STCHOUT]);                                                           
//#12548                pmsg=&msgbuf[strlen(msgbuf)];                                                           
//#12549            }                                                               
//#12550    #if LANG==ENG||LANG==HNG                                                                       
//#12551                                                                           
//#12552            sprintf(pmsg,                                                               
//#12553                stab[STR_STCHS],                                                           
//#12554                hed.stchs,                                                           
//#12555                sizx,sizx/25.4,                                                           
//#12556                sizy,sizy/25.4);                                                           
//#12557    #endif                                                                       
//#12558                                                                           
//#12559    #if LANG==GRM                                                                       
//#12560                                                                           
//#12561            sprintf(pmsg,                                                               
//#12562                stab[STR_STCHS],                                                           
//#12563                hed.stchs,                                                           
//#12564                sizx,                                                           
//#12565                sizy);                                                           
//#12566    #endif                                                                       
//#12567            pmsg=&pmsg[strlen(pmsg)];                                                               
//#12568        }                                                                   
//#12569        if(formpnt){                                                                   
//#12570                                                                           
//#12571            frmrct(&trct);                                                               
//#12572            sizx=(trct.right-trct.left)/PFGRAN;                                                               
//#12573            sizy=(trct.top-trct.bottom)/PFGRAN;                                                               
//#12574    #if LANG==ENG||LANG==HNG                                                                       
//#12575                                                                           
//#12576            sprintf(pmsg,stab[STR_FORMS],                                                               
//#12577                formpnt,                                                           
//#12578                sizx,sizx/25.4,                                                           
//#12579                sizy,sizy/25.4);                                                           
//#12580    #endif                                                                       
//#12581                                                                           
//#12582    #if LANG==GRM                                                                       
//#12583                                                                           
//#12584            sprintf(pmsg,stab[STR_FORMS],                                                               
//#12585                formpnt,                                                           
//#12586                sizx,                                                           
//#12587                sizy);                                                           
//#12588    #endif                                                                       
//#12589            pmsg=&pmsg[strlen(pmsg)];                                                               
//#12590        }                                                                   
//#12591        sprintf(pmsg,stab[STR_HUPWID],                                                                   
//#12592               ini.hupx/PFGRAN,                                                               
//#12593               ini.hupy/PFGRAN);                                                               
//#12594        pmsg=&pmsg[strlen(pmsg)];                                                                   
//#12595        if(hed.stchs){                                                                   
//#12596                                                                           
//#12597            sprintf(pmsg,stab[STR_CREATBY],                                                               
//#12598                 fildes,                                                           
//#12599                 hedx.modnam);                                                           
//#12600        }                                                                   
//#12601        shoMsg(msgbuf);                                                                   
//#12602    }                                                                       
//#12603                                                                           
//#12604    void sidhup(){                                                                       
//#12605                                                                           
//#12606        RECT        huprct;                                                           
//#12607        RECT        prfrct;                                                           
//#12608        unsigned    ind;                                                               
//#12609                                                                           
//#12610        setMap(HUPMSG);                                                                   
//#12611        GetWindowRect(thDat[PHUP],&huprct);                                                                   
//#12612        GetWindowRect(hPrf,&prfrct);                                                                   
//#12613        hSid=CreateWindow(                                                                   
//#12614            STATIC,                                                               
//#12615            0                                                               
//#12616            WS_BORDER|WS_CHILD|WS_VISIBLE,                                                               
//#12617            prfrct.right+3-morg.x,                                                               
//#12618            huprct.top-morg.y,                                                               
//#12619            buttonWid3+buttonWid*2+6,                                                               
//#12620            buttonHi*HUPS+6,                                                               
//#12621            hWnd,                                                               
//#12622            NULL,                                                               
//#12623            hInst,                                                               
//#12624            NULL);                                                               
//#12625        for(ind=0;ind<HUPS;ind++){                                                                   
//#12626                                                                           
//#12627            hsidWnd[ind]=CreateWindow(                                                               
//#12628                STATIC,                                                           
//#12629                stab[ind+STR_HUP0],                                                           
//#12630                SS_NOTIFY|SS_CENTER|WS_CHILD|WS_VISIBLE|WS_BORDER,                                                           
//#12631                3                                                           
//#12632                buttonHi*ind+3,                                                           
//#12633                buttonWid3+buttonWid*2,                                                           
//#12634                buttonHi,                                                           
//#12635                hSid,                                                           
//#12636                NULL,                                                           
//#12637                hInst,                                                           
//#12638                NULL);                                                           
//#12639        }                                                                   
//#12640    }                                                                       
//#12641                                                                           
//#12642    void setpcs(){                                                                       
//#12643                                                                           
//#12644        ini.auxfil=AUXPCS;                                                                   
//#12645        auxmen();                                                                   
//#12646    }                                                                       
//#12647                                                                           
//#12648    void setdst(){                                                                       
//#12649                                                                           
//#12650        ini.auxfil=AUXDST;                                                                   
//#12651        auxmen();                                                                   
//#12652    }                                                                       
//#12653
procedure TfrmMain.mnu_FILE_OPEN1Click(Sender: TObject);
var i : Integer;
begin
  with TOpenStitchsDialog.Create(Self) do
  begin
    if Execute then
    FStitchs.LoadFromFile(FileName);
    //Caption := IntToStr(FStitchs.Count);
//    FStitchs.Header.
  //  Caption := Caption +
    //    self.Color := FStitchs.BgColor;
    for i := 0 to High(FStitchs.Colors) do
    begin
      if swlCustom.Count < i +1 then
        swlCustom.Add;
      swlCustom[i].Color := FStitchs.Colors[i];
    end;
    swa2.Changed;




    lstCustomColor.Invalidate;
    pb.Invalidate;

    Free;
  end;

//#21158            case ID_FILE_OPEN1:
//#21159
//#21160                fop();
//#21161                break;

//#12654    void fop(){
//#12655
//#12656        untrace();
//#12657        if(formpnt||hed.stchs){
//#12658
//#12659            if(savcmp()){
//#12660
//#12661                nuFil();
//#12662                nulayr(0);
//#12663            }
//#12664            else{
//#12665
//#12666                savdisc();
//#12667                setMap(OSAV);
//#12668            }
//#12669        }
//#12670        else{
//#12671
//#12672            nuFil();
//#12673            nulayr(0);
//#12674        }
//#12675    }
//#12676
end;

//#12677    void clpradj(SHRTPNT pnt){
//#12678
//#12679        if(pnt.x<clprcta.left)
//#12680            clprcta.left=pnt.x;
//#12681        if(pnt.x>clprcta.right)
//#12682            clprcta.right=pnt.x;
//#12683        if(pnt.y<clprcta.bottom)
//#12684            clprcta.bottom=pnt.y;
//#12685        if(pnt.y>clprcta.top)
//#12686            clprcta.top=pnt.y;
//#12687    }                                                                       
//#12688                                                                           
//#12689    void clpadj(){                                                                       
//#12690                                                                           
//#12691        double        mid;                                                           
//#12692        unsigned    ind;                                                               
//#12693                                                                           
//#12694        if(chkMap(GRPSEL)){                                                                   
//#12695                                                                           
//#12696            rngadj();                                                               
//#12697            ind=gpnt0;                                                               
//#12698            clprcta.left=clprct.right=stchs[ind++].x;                                                               
//#12699            clprcta.top=clprcta.bottom=stchs[ind].y;                                                               
//#12700            clpradj(stchs[ind]);                                                               
//#12701            while(ind<gpnt1)                                                               
//#12702                clpradj(stchs[ind++]);                                                           
//#12703            if(stchs[ind].x<clprcta.left)                                                               
//#12704                clprcta.left=stchs[ind].x;                                                           
//#12705            if(stchs[ind].x>clprcta.right)                                                               
//#12706                clprcta.right=stchs[ind].x;                                                           
//#12707            mid=(clprcta.right-clprcta.left)/2+clprcta.left;                                                               
//#12708            stchs[gpnt0].y=stchs[gpnt1].y=(clprcta.top-clprcta.bottom)/2+clprcta.bottom;                                                               
//#12709            if(stchs[gpnt0].x<mid){                                                               
//#12710                                                                           
//#12711                stchs[gpnt0].x=clprcta.left;                                                           
//#12712                stchs[gpnt1].x=clprcta.right;                                                           
//#12713            }                                                               
//#12714            else{                                                               
//#12715                                                                           
//#12716                stchs[gpnt1].x=clprcta.left;                                                           
//#12717                stchs[gpnt0].x=clprcta.right;                                                           
//#12718            }                                                               
//#12719            coltab();                                                               
//#12720            setMap(RESTCH);                                                               
//#12721        }                                                                   
//#12722        else                                                                   
//#12723            shoseln(IDS_GRPMSG,IDS_RNGEND);                                                               
//#12724    }                                                                       
//#12725                                                                           
//#12726    void shftflt(FLPNT pnt){                                                                       
//#12727                                                                           
//#12728        if(pnt.x<=zRct.left||pnt.x>=zRct.right||pnt.y<=zRct.bottom||pnt.y>=zRct.top)                                                                   
//#12729            shft(pnt);                                                               
//#12730    }                                                                       
//#12731                                                                           
//#12732    void fil2men(){                                                                       
//#12733                                                                           
//#12734        if(chku(FIL2OF)){                                                                   
//#12735                                                                           
//#12736            CheckMenuItem(hMen,ID_FIL2SEL_ON,MF_UNCHECKED);                                                               
//#12737            CheckMenuItem(hMen,ID_FIL2SEL_OFF,MF_CHECKED);                                                               
//#12738        }                                                                   
//#12739        else{                                                                   
//#12740                                                                           
//#12741            CheckMenuItem(hMen,ID_FIL2SEL_ON,MF_CHECKED);                                                               
//#12742            CheckMenuItem(hMen,ID_FIL2SEL_OFF,MF_UNCHECKED);                                                               
//#12743        }                                                                   
//#12744                                                                           
//#12745    }                                                                       
//#12746
procedure TfrmMain.defpref();
begin
//#12747    void defpref(){                                                                       
//#12748                                                                           
//#12749        unsigned ind;                                                                   
//#12750                                                                           
//#12751        umap=0;                                                                   
//#12752        for(ind=0;ind<16;ind++){                                                                   
//#12753                                                                           
//#12754            useCol[ind]=defUseCol[ind];
  Fini.StitchColors :=  defUseCol;
  custCol := defCustCol;
  bakCust := defBakCust;
  bakBit  := defBakBit;
//#12755            custCol[ind]=defCustCol[ind];                                                               
//#12756            bakCust[ind]=defBakCust[ind];                                                               
//#12757            bakBit[ind]=defBakBit[ind];                                                               
//#12758        }                                                                   
//#12759        dazdef();                                                                   
//#12760        apcol=15;                                                                   
//#12761        brdwid=BRDWID;                                                                   
//#12762        bfclen=IBFCLEN;
//#12763        ini.chspac=CHSDEF;
//  ini.ChainSpace := CHSDEF;
//#12764        ini.chrat=CHRDEF;                                                                   
//#12765        ini.angl=DEFANG;                                                                   
//#12766        rstu(SQRFIL);                                                                   
//#12767        stspace=DEFSPACE*PFGRAN;                                                                   
//#12768        shopnts=SHOPNTS;                                                                   
//#12769        ini.grdsiz=12;                                                                   
//#12770        ini.hup=LARGHUP;                                                                   
//#12771        ini.hupx=LHUPX;                                                                   
//#12772        ini.hupy=LHUPY;                                                                   
//#12773        ini.nudg=NUGINI;                                                                   
//#12774        ini.nudgpix=DEFPIX;                                                                   
//#12775        setu(BLUNT);                                                                   
//#12776        smalsiz=SMALSIZ*PFGRAN;                                                                   
//#12777        snplen=SNPLEN*PFGRAN;                                                                   
//#12778        spirwrap=SPIRWRAP;                                                                   
//#12779        starat=STARAT;                                                                   
//#12780        stchboxs=STCHBOX;                                                                   
//#12781        ini.maxsiz=MAXSIZ*PFGRAN;                                                                   
//#12782        usesiz=USESIZ*PFGRAN;                                                                   
//#12783        minsiz=MINSIZ*PFGRAN;                                                                   
//#12784        ini.clpof=0;                                                                   
//#12785        ini.faz=0;                                                                   
//#12786        bitCol=0xc8dfee;                                                                   
//#12787        if(!ini.xcust)                                                                   
//#12788            ini.xcust=LHUPX;                                                               
//#12789        if(ini.ycust)                                                                   
//#12790            ini.ycust=LHUPY;                                                               
//#12791        picspac=IPICSPAC;                                                                   
//#12792        setu(FIL2OF);                                                                   
//#12793        fil2men();                                                                   
//#12794        stchBak=0xa8c4b1;                                                                   
//#12795        zum0.x=ini.hupx;                                                                   
//#12796        zum0.y=ini.hupy;                                                                   
//#12797        ini.wavend=IWAVEND;                                                                   
//#12798        ini.wavpnts=IWAVPNTS;                                                                   
//#12799        ini.wavs=IWAVS;                                                                   
//#12800        ini.wavstrt=IWAVSTRT;                                                                   
//#12801        ini.fthtyp=FDEFTYP;                                                                   
//#12802        ini.fthup=FDEFUP;                                                                   
//#12803        ini.fthdwn=FDEFDWN;                                                                   
//#12804        ini.fthrat=(float)FDEFRAT;                                                                   
//#12805        ini.fthflr=FDEFFLR;                                                                   
//#12806        ini.fthnum=FDEFNUM;                                                                   
//#12807        ini.ulen=DEFULEN;                                                                   
//#12808        ini.uspac=DEFUSPAC;                                                                   
//#12809        ini.frmbpix=DEFBPIX;                                                                   
//#12810        ini.txthi=ITXHI;                                                                   
//#12811        ini.txtwid=ITXWID;                                                                   
//#12812        ini.txtspac=(float)ITXSPAC;                                                                   
//#12813    }                                                                       
//#12814
end;                                                                           
//#12815    void dumrk(double pntx,double pnty){                                                                       
//#12816                                                                           
//#12817        if(rstMap(GMRK))                                                                   
//#12818            drwmrk(rsdc);                                                               
//#12819        mrkpnt.x=pntx;                                                                   
//#12820        mrkpnt.y=pnty;                                                                   
//#12821        setMap(INIT);                                                                   
//#12822        setMap(GMRK);                                                                   
//#12823        drwmrk(rsdc);                                                                   
//#12824        setMap(WASMRK);                                                                   
//#12825    }                                                                       
//#12826                                                                           
//#12827    void gselrng(){                                                                       
//#12828                                                                           
//#12829        unsigned ind;                                                                   
//#12830                                                                           
//#12831        selrang.strt=selrang.fin=*selist;                                                                   
//#12832        for(ind=1;ind<fselpnt;ind++){                                                                   
//#12833                                                                           
//#12834            if(selist[ind]<selrang.strt)                                                               
//#12835                selrang.strt=selist[ind];                                                           
//#12836            if(selist[ind]>selrang.fin)                                                               
//#12837                selrang.fin=selist[ind];                                                           
//#12838        }                                                                   
//#12839    }                                                                       
//#12840                                                                           
//#12841    double nuang(double ydif,double xdif){                                                                       
//#12842                                                                           
//#12843        double tang,rang;                                                                   
//#12844                                                                           
//#12845        tang=atan2(ydif,xdif);                                                                   
//#12846        rang=tang-organg;                                                                   
//#12847        if(fabs(rang)>PI){                                                                   
//#12848                                                                           
//#12849            if(rang>0)                                                               
//#12850                rang=2*PI-rang;                                                           
//#12851            else                                                               
//#12852                rang+=2*PI;                                                           
//#12853        }                                                                   
//#12854        return rang;                                                                   
//#12855    }                                                                       
//#12856                                                                           
//#12857    void angdif(double ang){                                                                       
//#12858                                                                           
//#12859        if(ang>hiang)                                                                   
//#12860            hiang=ang;                                                               
//#12861        else{                                                                   
//#12862                                                                           
//#12863            if(ang<loang)                                                               
//#12864                loang=ang;                                                           
//#12865        }                                                                   
//#12866    }                                                                       
//#12867                                                                           
//#12868    void rotmrk(){                                                                       
//#12869                                                                           
//#12870        unsigned    ind,cnt,cod;                                                               
//#12871        double        tang;                                                           
//#12872                                                                           
//#12873        if(chkMap(GMRK)&&(chkMap(FORMSEL)||chkMap(GRPSEL))){                                                                   
//#12874                                                                           
//#12875            if(chkMap(FORMSEL)){                                                               
//#12876                                                                           
//#12877                cod=clofind<<FRMSHFT;                                                           
//#12878                fvars(clofind);                                                           
//#12879                loang=hiang=0;                                                           
//#12880                organg=atan2(flt[0].y-mrkpnt.y,flt[0].x-mrkpnt.x);                                                           
//#12881                for(ind=1;ind<sids;ind++)                                                           
//#12882                    angdif(nuang(flt[ind].y-mrkpnt.y,flt[ind].x-mrkpnt.x));                                                       
//#12883                for(ind=0;ind<hed.stchs;ind++){                                                           
//#12884                                                                           
//#12885                    if((stchs[ind].at&FRMSK)==cod)                                                       
//#12886                        angdif(nuang(stchs[ind].y-mrkpnt.y,stchs[ind].x-mrkpnt.x));                                                   
//#12887                }                                                           
//#12888            }                                                               
//#12889            else{                                                               
//#12890                                                                           
//#12891                rngadj();                                                           
//#12892                loang=hiang=0;                                                           
//#12893                organg=atan2(stchs[gpnt0].y-mrkpnt.y,stchs[gpnt0].x-mrkpnt.x);                                                           
//#12894                for(ind=gpnt0+1;ind<=gpnt1;ind++)                                                           
//#12895                    angdif(nuang(stchs[ind].y-mrkpnt.y,stchs[ind].x-mrkpnt.x));                                                       
//#12896            }                                                               
//#12897            tang=hiang-loang;                                                               
//#12898            cnt=2*PI/tang;                                                               
//#12899            ini.rotang=2*PI/cnt;                                                               
//#12900            sprintf(msgbuf,    Rotation Angle: %.2f\n                                                           
//#12901                            Segmets: %d\n,ini.angl*180/PI,cnt);                                               
//#12902            shoMsg(msgbuf);                                                               
//#12903        }                                                                   
//#12904        else                                                                   
//#12905            shoseln(IDS_FSZ,IDS_SETROTM);                                                               
//#12906    }                                                                       
//#12907                                                                           
//#12908    void segentr(){                                                                       
//#12909                                                                           
//#12910        if(!ang)                                                                   
//#12911            ang=PI/180;                                                               
//#12912        sprintf(msgbuf,stab[STR_ENTROT],2*PI/ang);                                                                   
//#12913        shoMsg(msgbuf);                                                                   
//#12914        setMap(NUMIN);                                                                   
//#12915        numWnd();                                                                   
//#12916    }                                                                       
//#12917                                                                           
//#12918    void rotseg(){                                                                       
//#12919                                                                           
//#12920        ang=ini.rotang;                                                                   
//#12921        segentr();                                                                   
//#12922        setMap(ENTRSEG);                                                                   
//#12923    }                                                                       
//#12924                                                                           
//#12925    void pntmrk(){                                                                       
//#12926                                                                           
//#12927        if(chkMap(SELBOX)){                                                                   
//#12928                                                                           
//#12929            dumrk(stchs[cloInd].x,stchs[cloInd].y);                                                               
//#12930            goto mrkdun;                                                               
//#12931        }                                                                   
//#12932        if(chkMap(FRMPSEL)){                                                                   
//#12933                                                                           
//#12934            dumrk(formlst[clofind].flt[clofine].x,formlst[clofind].flt[clofine].y);                                                               
//#12935            goto mrkdun;                                                               
//#12936        }                                                                   
//#12937        shoseln(IDS_STCH_FRM,IDS_SETMRK);                                                                   
//#12938                                                                           
//#12939    mrkdun:;                                                                       
//#12940    }                                                                       
//#12941                                                                           
//#12942    void filfrms(){                                                                       
//#12943                                                                           
//#12944        unsigned ine;                                                                   
//#12945                                                                           
//#12946        if(fselpnt){                                                                   
//#12947                                                                           
//#12948            savdo();                                                               
//#12949            for(ine=0;ine<fselpnt;ine++){                                                               
//#12950                                                                           
//#12951                clofind=selist[ine];                                                           
//#12952                refilfn();                                                           
//#12953            }                                                               
//#12954            setMap(RESTCH);                                                               
//#12955        }                                                                   
//#12956        else{                                                                   
//#12957                                                                           
//#12958            if(chkMap(FORMSEL)){                                                               
//#12959                                                                           
//#12960                savdo();                                                           
//#12961                refil();                                                           
//#12962                setMap(RESTCH);                                                           
//#12963            }                                                               
//#12964        }                                                                   
//#12965    }                                                                       
//#12966                                                                           
//#12967    void nuslst(unsigned find){                                                                       
//#12968                                                                           
//#12969        unsigned ind,ine;                                                                   
//#12970                                                                           
//#12971        gselrng();                                                                   
//#12972        ine=0;                                                                   
//#12973        if(find<selrang.strt){                                                                   
//#12974                                                                           
//#12975            for(ind=find;ind<selrang.fin;ind++)                                                               
//#12976                selist[ine++]=ind;                                                           
//#12977            goto gotsrng;                                                               
//#12978        }                                                                   
//#12979        if(find>selrang.fin){                                                                   
//#12980                                                                           
//#12981            for(ind=selrang.strt;ind<=find;ind++)                                                               
//#12982                selist[ine++]=ind;                                                           
//#12983            goto gotsrng;                                                               
//#12984        }                                                                   
//#12985        for(ind=selrang.strt;ind<=find;ind++)                                                                   
//#12986            selist[ine++]=ind;                                                               
//#12987    gotsrng:;                                                                       
//#12988        fselpnt=ine;                                                                   
//#12989    }                                                                       
//#12990                                                                           
//#12991    void srchk(){                                                                       
//#12992                                                                           
//#12993        rstMap(FORMSEL);                                                                   
//#12994        fselpnt=0;                                                                   
//#12995        if(setMap(LENSRCH)){                                                                   
//#12996                                                                           
//#12997            if(chkMap(WASGRP)){                                                               
//#12998                                                                           
//#12999                cloInd=gpnt0=opnt0;                                                           
//#13000                grpInd=gpnt1=opnt1;                                                           
//#13001            }                                                               
//#13002            else                                                               
//#13003                rstMap(GRPSEL);                                                           
//#13004        }                                                                   
//#13005        else{                                                                   
//#13006                                                                           
//#13007            if(chkMap(GRPSEL)){                                                               
//#13008                                                                           
//#13009                setMap(WASGRP);                                                           
//#13010                rngadj();                                                           
//#13011                opnt0=gpnt0;                                                           
//#13012                opnt1=gpnt1;                                                           
//#13013            }                                                               
//#13014            else                                                               
//#13015                rstMap(WASGRP);                                                           
//#13016        }                                                                   
//#13017        duselrng();                                                                   
//#13018    }                                                                       
//#13019                                                                           
//#13020    unsigned duswap(unsigned dat){                                                                       
//#13021                                                                           
//#13022        _asm{                                                                   
//#13023                                                                           
//#13024            mov        eax,dat                                                       
//#13025            bswap    eax                                                           
//#13026        }                                                                   
//#13027    }                                                                       
//#13028                                                                           
//#13029    void ritcur(){                                                                       
//#13030                                                                           
//#13031        ICONINFO            ici;                                                       
//#13032        HCURSOR                tcur;                                                   
//#13033        POINT                cpos;                                                   
//#13034        unsigned            ind,ine;                                                       
//#13035        unsigned            amsk,binv;                                                       
//#13036        unsigned            bmsk;                                                       
//#13037        unsigned            tpix;                                                       
//#13038                                                                           
//#13039        tcur=GetCursor();                                                                   
//#13040        GetIconInfo(tcur,&ici);                                                                   
//#13041        GetCursorPos(&cpos);                                                                   
//#13042        cpos.x-=(stOrg.x+ici.xHotspot);                                                                   
//#13043        cpos.y-=(stOrg.y+ici.yHotspot);                                                                   
//#13044        GetBitmapBits(ici.hbmMask,256,(unsigned char*)&rmap);                                                                   
//#13045        if(tcur==hAr){                                                                   
//#13046                                                                           
//#13047            for(ind=0;ind<32;ind++){                                                               
//#13048                                                                           
//#13049                amsk=duswap(rmap[ind]);                                                           
//#13050                binv=duswap(rmap[ind+32]);                                                           
//#13051                bmsk=0x80000000;                                                           
//#13052                for(ine=0;ine<32;ine++){                                                           
//#13053                                                                           
//#13054                    if(!(bmsk&amsk)){                                                       
//#13055                                                                           
//#13056                        if(binv&bmsk)                                                   
//#13057                            tpix=0xffffff;                                               
//#13058                        else                                                   
//#13059                            tpix=0;                                               
//#13060                        SetPixel(rsdc,cpos.x+ine,cpos.y+ind,tpix);                                                   
//#13061                    }                                                       
//#13062                    bmsk>>=1;                                                       
//#13063                }                                                           
//#13064            }                                                               
//#13065        }                                                                   
//#13066        else{                                                                   
//#13067                                                                           
//#13068            for(ind=0;ind<32;ind++){                                                               
//#13069                                                                           
//#13070                binv=duswap(rmap[ind+32]);                                                           
//#13071                bmsk=0x80000000;                                                           
//#13072                for(ine=0;ine<32;ine++){                                                           
//#13073                                                                           
//#13074                    if(bmsk&binv)                                                       
//#13075                        SetPixel(rsdc,cpos.x+ine,cpos.y+ind,GetPixel(rsdc,cpos.x+ine,cpos.y+ind)^0xffffff);                                                   
//#13076                    bmsk>>=1;                                                       
//#13077                }                                                           
//#13078            }                                                               
//#13079        }                                                                   
//#13080    }                                                                       
//#13081                                                                           
//#13082    void delsfrms(unsigned cod){                                                                       
//#13083                                                                           
//#13084        unsigned ind,ine,inf;                                                                   
//#13085                                                                           
//#13086        if(cod){                                                                   
//#13087                                                                           
//#13088            inf=(formpnt>>5)+1;                                                               
//#13089            for(ine=0;ine<inf;ine++)                                                               
//#13090                rmap[ine]=0;                                                           
//#13091            for(ind=0;(unsigned)ind<fselpnt;ind++){                                                               
//#13092                                                                           
//#13093                clofind=selist[ind];                                                           
//#13094                setr(clofind);                                                           
//#13095                fvars(clofind);                                                           
//#13096                f1del();                                                           
//#13097            }                                                               
//#13098            finds=(unsigned*)bseq;                                                               
//#13099            inf=0;ind=0;                                                               
//#13100            for(ine=0;ine<formpnt;ine++){                                                               
//#13101                                                                           
//#13102                if(!chkr(ine)){                                                           
//#13103                                                                           
//#13104                    frmcpy(&formlst[inf],&formlst[ine]);                                                       
//#13105                    finds[ine]=(ine-ind)<<4;                                                       
//#13106                    inf++;                                                       
//#13107                }                                                           
//#13108                else                                                           
//#13109                    ind++;                                                       
//#13110            }                                                               
//#13111            formpnt=inf;                                                               
//#13112            inf=0;                                                               
//#13113            if(chkMap(DELTO)){                                                               
//#13114                                                                           
//#13115                for(ind=0;ind<hed.stchs;ind++){                                                           
//#13116                                                                           
//#13117                    if(stchs[ind].at&ALTYPMSK){                                                       
//#13118                                                                           
//#13119                        cod=(stchs[ind].at&FRMSK)>>FRMSHFT;                                                   
//#13120                        if(!chkr(cod)){                                                   
//#13121                                                                           
//#13122                            stchs[inf].at=stchs[ind].at&=NFRMSK;                                               
//#13123                            stchs[inf].at|=finds[cod];                                               
//#13124                            stchs[inf].x=stchs[ind].x;                                               
//#13125                            stchs[inf++].y=stchs[ind].y;                                               
//#13126                        }                                                   
//#13127                    }                                                       
//#13128                    else{                                                       
//#13129                                                                           
//#13130                        stchs[inf].at=stchs[ind].at;                                                   
//#13131                        stchs[inf].x=stchs[ind].x;                                                   
//#13132                        stchs[inf++].y=stchs[ind].y;                                                   
//#13133                    }                                                       
//#13134                }                                                           
//#13135                hed.stchs=inf;                                                           
//#13136            }                                                               
//#13137            else{                                                               
//#13138                                                                           
//#13139                for(ind=0;ind<hed.stchs;ind++){                                                           
//#13140                                                                           
//#13141                    if(!(stchs[ind].at&NOTFRM)){                                                       
//#13142                                                                           
//#13143                        cod=(stchs[ind].at&FRMSK)>>FRMSHFT;                                                   
//#13144                        if(chkr(cod))                                                   
//#13145                            stchs[ind].at&=(NFRMSK&NTYPMSK);                                               
//#13146                    }                                                       
//#13147                }                                                           
//#13148            }                                                               
//#13149            fselpnt=0;                                                               
//#13150            rstMap(FORMSEL);                                                               
//#13151            coltab();                                                               
//#13152            setMap(RESTCH);                                                               
//#13153        }                                                                   
//#13154    }                                                                       
//#13155                                                                           
//#13156    void nedon(){                                                                       
//#13157                                                                           
//#13158        rstu(NEDOF);                                                                   
//#13159        nedmen();                                                                   
//#13160    }                                                                       
//#13161                                                                           
//#13162    void nedof(){                                                                       
//#13163                                                                           
//#13164        setu(NEDOF);                                                                   
//#13165        nedmen();                                                                   
//#13166    }                                                                       
//#13167                                                                           
//#13168    void shoknot(){                                                                       
//#13169                                                                           
//#13170        rstu(KNOTOF);                                                                   
//#13171        knotmen();                                                                   
//#13172        setMap(RESTCH);                                                                   
//#13173    }                                                                       
//#13174                                                                           
//#13175    void hidknot(){                                                                       
//#13176                                                                           
//#13177        setu(KNOTOF);                                                                   
//#13178        knotmen();                                                                   
//#13179        setMap(RESTCH);                                                                   
//#13180    }                                                                       
//#13181                                                                           
//#13182    void pcsbsavon(){                                                                       
//#13183                                                                           
//#13184        rstu(BSAVOF);                                                                   
//#13185        bsavmen();                                                                   
//#13186        setMap(RESTCH);                                                                   
//#13187    }                                                                       
//#13188                                                                           
//#13189    void pcsbsavof(){                                                                       
//#13190                                                                           
//#13191        setu(BSAVOF);                                                                   
//#13192        bsavmen();                                                                   
//#13193        setMap(RESTCH);                                                                   
//#13194    }                                                                       
//#13195                                                                           
//#13196    void tglhid(){                                                                       
//#13197                                                                           
//#13198        if(!toglMap(HIDSTCH))                                                                   
//#13199            rstMap(FRMOF);                                                               
//#13200        setMap(RESTCH);                                                                   
//#13201    }                                                                       
//#13202                                                                           
//#13203    void respac(){                                                                       
//#13204                                                                           
//#13205        if(isclp(clofind)){                                                                   
//#13206                                                                           
//#13207            frmpnt->fspac=stspace;                                                               
//#13208            fsizpar();                                                               
//#13209        }                                                                   
//#13210    }                                                                       
//#13211                                                                           
//#13212    BOOL chkminus(unsigned cod){                                                                       
//#13213                                                                           
//#13214        if(cod==189||cod==109){                                                                   
//#13215                                                                           
//#13216            if(prfind==PCLPOF+1)                                                               
//#13217                return 1;                                                           
//#13218            if(sidtyp==LFRMSPAC&&isfclp())                                                               
//#13219                return 1;                                                           
//#13220            if(sidtyp==LWLKIND)                                                               
//#13221                return 1;                                                           
//#13222        }                                                                   
//#13223        return 0;                                                                   
//#13224    }                                                                       
//#13225                                                                           
//#13226    void retrac(){                                                                       
//#13227                                                                           
//#13228        unsigned src,dst;                                                                   
//#13229                                                                           
//#13230        if(chkMap(GRPSEL)){                                                                   
//#13231                                                                           
//#13232            savdo();                                                               
//#13233            rngadj();                                                               
//#13234            if(!gpnt0)                                                               
//#13235                gpnt0++;                                                           
//#13236            makspac(gpnt1+1,gpnt1-gpnt0);                                                               
//#13237            src=gpnt1-1;                                                               
//#13238            dst=gpnt1+1;                                                               
//#13239            while(src>=gpnt0){                                                               
//#13240                                                                           
//#13241                stchs[dst].at=stchs[src].at;                                                           
//#13242                stchs[dst].x=stchs[src].x;                                                           
//#13243                stchs[dst++].y=stchs[src--].y;                                                           
//#13244            }                                                               
//#13245            coltab();                                                               
//#13246            setMap(RESTCH);                                                               
//#13247        }                                                                   
//#13248        else                                                                   
//#13249            shoseln(IDS_GRPMSG,IDS_RETRAC);                                                               
//#13250    }                                                                       
//#13251                                                                           
//#13252    void setgrd(COLORREF col){                                                                       
//#13253                                                                           
//#13254        unsigned    ind;                                                               
//#13255        GRDCOD        cods[]={                                                           
//#13256                                                                           
//#13257            ID_GRDHI,HIGRD,                                                               
//#13258            ID_GRDMED,MEDGRD,                                                               
//#13259            ID_GRDEF,DEFGRD,                                                               
//#13260            ID_GRDRED,REDGRD,                                                               
//#13261            ID_GRDBLU,BLUGRD,                                                               
//#13262            ID_GRDGRN,GRNGRD,                                                               
//#13263        };                                                                   
//#13264                                                                           
//#13265        for(ind=0;ind<6;ind++){                                                                   
//#13266                                                                           
//#13267            if(col==cods[ind].col)                                                               
//#13268                CheckMenuItem(hMen,cods[ind].id,MF_CHECKED);                                                           
//#13269            else                                                               
//#13270                CheckMenuItem(hMen,cods[ind].id,MF_UNCHECKED);                                                           
//#13271        }                                                                   
//#13272        grdPen=nuPen(grdPen,1,col);                                                                   
//#13273        ini.grdbak=col;                                                                   
//#13274        setMap(RESTCH);                                                                   
//#13275        setMap(DUMEN);                                                                   
//#13276    }                                                                       
//#13277                                                                           
//#13278    void ovrlay(){                                                                       
//#13279                                                                           
//#13280        rstMap(IGNORINS);                                                                   
//#13281        insfil();                                                                   
//#13282        rstMap(INSFIL);                                                                   
//#13283        rstMap(FRMOF);                                                                   
//#13284        setMap(INIT);                                                                   
//#13285        coltab();                                                                   
//#13286        setMap(RESTCH);                                                                   
//#13287    }                                                                       
//#13288                                                                           
//#13289    void fil2sel(unsigned stat){                                                                       
//#13290                                                                           
//#13291        setu(FIL2OF);                                                                   
//#13292        if(stat)                                                                   
//#13293            rstu(FIL2OF);                                                               
//#13294        fil2men();                                                                   
//#13295    }                                                                       
//#13296                                                                           
//#13297    void rotauxmen(){                                                                       
//#13298                                                                           
//#13299        if(chku(ROTAUX)){                                                                   
//#13300                                                                           
//#13301            CheckMenuItem(hMen,ID_ROTAUXON,MF_CHECKED);                                                               
//#13302            CheckMenuItem(hMen,ID_ROTAUXOFF,MF_UNCHECKED);                                                               
//#13303        }                                                                   
//#13304        else{                                                                   
//#13305                                                                           
//#13306            CheckMenuItem(hMen,ID_ROTAUXON,MF_UNCHECKED);                                                               
//#13307            CheckMenuItem(hMen,ID_ROTAUXOFF,MF_CHECKED);                                                               
//#13308        }                                                                   
//#13309    }                                                                       
//#13310                                                                           
//#13311    void rotauxsel(unsigned stat){                                                                       
//#13312                                                                           
//#13313        setu(ROTAUX);                                                                   
//#13314        if(!stat)                                                                   
//#13315            rstu(ROTAUX);                                                               
//#13316        rotauxmen();                                                                   
//#13317        setMap(DUMEN);                                                                   
//#13318    }                                                                       
//#13319                                                                           
//#13320    void frmcurmen(){                                                                       
//#13321                                                                           
//#13322        if(chku(FRMX)){                                                                   
//#13323                                                                           
//#13324            CheckMenuItem(hMen,ID_FRMX,MF_CHECKED);                                                               
//#13325            CheckMenuItem(hMen,ID_FRMBOX,MF_UNCHECKED);                                                               
//#13326        }                                                                   
//#13327        else{                                                                   
//#13328                                                                           
//#13329            CheckMenuItem(hMen,ID_FRMX,MF_UNCHECKED);                                                               
//#13330            CheckMenuItem(hMen,ID_FRMBOX,MF_CHECKED);                                                               
//#13331        }                                                                   
//#13332    }                                                                       
//#13333                                                                           
//#13334    void frmcursel(unsigned stat){                                                                       
//#13335                                                                           
//#13336        setu(FRMX);                                                                   
//#13337        if(!stat)                                                                   
//#13338            rstu(FRMX);                                                               
//#13339        frmcurmen();                                                                   
//#13340        setMap(DUMEN);                                                                   
//#13341    }                                                                       
//#13342                                                                           
//#13343    void stchsnap(unsigned strt,unsigned fin){                                                                       
//#13344                                                                           
//#13345        _asm{                                                                   
//#13346                xor        eax,eax                                                   
//#13347                mov        al,12                                                   
//#13348                mul        strt                                                   
//#13349                mov        ecx,fin                                                   
//#13350                sub        ecx,strt                                                   
//#13351                je        short stchsnapx                                                   
//#13352                add        eax,offset stchs                                                   
//#13353                fld        ini.grdsiz                                                   
//#13354    snplup:        fld        dword ptr[eax]                                                       
//#13355                fdiv    st,st(1)                                                       
//#13356                frndint                                                           
//#13357                fmul    st,st(1)                                                       
//#13358                fstp    dword ptr[eax]                                                       
//#13359                add        eax,4                                                   
//#13360                fld        dword ptr[eax]                                                   
//#13361                fdiv    st,st(1)                                                       
//#13362                frndint                                                           
//#13363                fmul    st,st(1)                                                       
//#13364                fstp    dword ptr[eax]                                                       
//#13365                add        eax,8                                                   
//#13366                loop    snplup                                                       
//#13367    stchsnapx:                                                                       
//#13368        }                                                                   
//#13369    }                                                                       
//#13370                                                                           
//#13371    void frmsnap(FLPNT* strt,unsigned cnt){                                                                       
//#13372                                                                           
//#13373        _asm{                                                                   
//#13374                mov        eax,strt                                                   
//#13375                mov        ecx,cnt                                                   
//#13376                shl        ecx,1                                                   
//#13377                je        short frmsnapx                                                   
//#13378                fld        ini.grdsiz                                                   
//#13379    snpflup:    fld        dword ptr[eax]                                                           
//#13380                fdiv    st,st(1)                                                       
//#13381                frndint                                                           
//#13382                fmul    st,st(1)                                                       
//#13383                fstp    dword ptr[eax]                                                       
//#13384                add        eax,4                                                   
//#13385                loop    snpflup                                                       
//#13386    frmsnapx:                                                                       
//#13387        }                                                                   
//#13388    }                                                                       
//#13389                                                                           
//#13390    void gsnap(){                                                                       
//#13391                                                                           
//#13392        unsigned ind;                                                                   
//#13393                                                                           
//#13394        if(chkMap(TXTRED))                                                                   
//#13395        {                                                                   
//#13396            txsnap();                                                               
//#13397            return;                                                               
//#13398        }                                                                   
//#13399        if(fselpnt){                                                                   
//#13400                                                                           
//#13401            savdo();                                                               
//#13402            for(ind=0;ind<fselpnt;ind++){                                                               
//#13403                                                                           
//#13404                clofind=selist[ind];                                                           
//#13405                frmsnap(formlst[clofind].flt,formlst[clofind].sids);                                                           
//#13406                frmout(clofind);                                                           
//#13407                refil();                                                           
//#13408            }                                                               
//#13409            setMap(RESTCH);                                                               
//#13410        }                                                                   
//#13411        else{                                                                   
//#13412                                                                           
//#13413            if(chkMap(FORMSEL)){                                                               
//#13414                                                                           
//#13415                savdo();                                                           
//#13416                frmsnap(formlst[clofind].flt,formlst[clofind].sids);                                                           
//#13417                frmout(clofind);                                                           
//#13418                refil();                                                           
//#13419                setMap(RESTCH);                                                           
//#13420            }                                                               
//#13421            else{                                                               
//#13422                                                                           
//#13423                if(chkMap(GRPSEL)){                                                           
//#13424                                                                           
//#13425                    savdo();                                                       
//#13426                    rngadj();                                                       
//#13427                    stchsnap(gpnt0,gpnt1+1);                                                       
//#13428                    setMap(RESTCH);                                                       
//#13429                }                                                           
//#13430                else                                                           
//#13431                    shoseln(IDS_FGRPF,IDS_SNAP2GRD);                                                       
//#13432            }                                                               
//#13433        }                                                                   
//#13434    }                                                                       
//#13435                                                                           
//#13436    #if PESACT                                                                       
//#13437                                                                           
//#13438    void lodpes(){                                                                       
//#13439                                                                           
//#13440        setMap(REDOLD);                                                                   
//#13441        strcpy(filnam,"u:\\mrd\\t.pes");                                                                   
//#13442        nuFil();                                                                   
//#13443    }                                                                       
//#13444                                                                           
//#13445    void savpes(){                                                                       
//#13446                                                                           
//#13447        ini.auxfil=AUXPES;                                                                   
//#13448        strcpy(filnam,"u:\\mrd\\t1.thr");                                                                   
//#13449        nunams();                                                                   
//#13450        sav();                                                                   
//#13451    }                                                                       
//#13452    #endif                                                                       
//#13453                                                                           
//#13454    void ritlock(HWND hwndlg){                                                                       
//#13455                                                                           
//#13456        unsigned ind;                                                                   
//#13457        WIN32_FIND_DATA*    pdat;                                                               
//#13458                                                                           
//#13459        pdat=(WIN32_FIND_DATA*)&bseq;                                                                   
//#13460        SendMessage(GetDlgItem(hwndlg,IDC_LOCKED),LB_RESETCONTENT,0,0);                                                                   
//#13461        SendMessage(GetDlgItem(hwndlg,IDC_UNLOCKED),LB_RESETCONTENT,0,0);                                                                   
//#13462        for(ind=0;ind<xpnt;ind++){                                                                   
//#13463                                                                           
//#13464            if(pdat[ind].dwFileAttributes&FILE_ATTRIBUTE_READONLY)                                                               
//#13465                SendMessage(GetDlgItem(hwndlg,IDC_LOCKED),LB_ADDSTRING,0,(long)pdat[ind].cFileName);                                                           
//#13466            else                                                               
//#13467                SendMessage(GetDlgItem(hwndlg,IDC_UNLOCKED),LB_ADDSTRING,0,(long)pdat[ind].cFileName);                                                           
//#13468        }                                                                   
//#13469    }                                                                       
//#13470                                                                           
//#13471    void rngord(unsigned rng0,unsigned rng1){                                                                       
//#13472                                                                           
//#13473        if(rng1>rng0){                                                                   
//#13474                                                                           
//#13475            selrng.strt=rng0;                                                               
//#13476            selrng.fin=rng1;                                                               
//#13477        }                                                                   
//#13478        else{                                                                   
//#13479                                                                           
//#13480            selrng.strt=rng1;                                                               
//#13481            selrng.fin=rng0;                                                               
//#13482        }                                                                   
//#13483    }                                                                       
//#13484                                                                           
//#13485    BOOL CALLBACK LockPrc(HWND hwndlg,UINT umsg,WPARAM wparam,LPARAM lparam){                                                                       
//#13486                                                                           
//#13487        WIN32_FIND_DATA*    pdat;                                                               
//#13488        HANDLE                srch;                                                   
//#13489        TCHAR                snam[MAX_PATH];                                                   
//#13490        TCHAR                tnam[MAX_PATH];                                                   
//#13491        unsigned            ind,ine;                                                       
//#13492        HWND                hlok,hunlok;                                                   
//#13493                                                                           
//#13494        pdat=(WIN32_FIND_DATA*)&bseq;                                                                   
//#13495        switch(umsg){                                                                   
//#13496                                                                           
//#13497        case WM_INITDIALOG:                                                                   
//#13498                                                                           
//#13499            loksel=unloksel=0xffffffff;                                                               
//#13500            SendMessage(hwndlg,WM_SETFOCUS,0,0);                                                               
//#13501            strcpy(snam,defDir);                                                               
//#13502            strcat(snam,"\\*.thr");                                                               
//#13503            srch=FindFirstFile(snam,&pdat[0]);                                                               
//#13504            if(srch==INVALID_HANDLE_VALUE){                                                               
//#13505                                                                           
//#13506                sprintf(msgbuf,"Directory: %s has no .thr files\n",defDir);                                                           
//#13507                shoMsg(msgbuf);                                                           
//#13508                EndDialog(hwndlg,wparam);                                                            
//#13509                return TRUE;                                                           
//#13510            }                                                               
//#13511            xpnt=1;                                                               
//#13512            while(FindNextFile(srch,&pdat[xpnt++]));                                                               
//#13513            xpnt--;                                                               
//#13514            ritlock(hwndlg);                                                               
//#13515            break;                                                               
//#13516                                                                           
//#13517        case WM_COMMAND:                                                                   
//#13518                                                                           
//#13519            switch(LOWORD(wparam)){                                                               
//#13520                                                                           
//#13521            case IDCANCEL:                                                               
//#13522                                                                           
//#13523                EndDialog(hwndlg,wparam);                                                            
//#13524                return TRUE;                                                           
//#13525                                                                           
//#13526            case IDC_LOCKAL:                                                               
//#13527                                                                           
//#13528                for(ind=0;ind<xpnt;ind++)                                                           
//#13529                    pdat[ind].dwFileAttributes|=FILE_ATTRIBUTE_READONLY;                                                       
//#13530                ritlock(hwndlg);                                                           
//#13531                break;                                                           
//#13532                                                                           
//#13533            case IDC_UNLOCKAL:                                                               
//#13534                                                                           
//#13535                for(ind=0;ind<xpnt;ind++)                                                           
//#13536                    pdat[ind].dwFileAttributes&=0xffffffff^FILE_ATTRIBUTE_READONLY;                                                       
//#13537                ritlock(hwndlg);                                                           
//#13538                break;                                                           
//#13539                                                                           
//#13540            case IDC_LOCK:                                                               
//#13541                                                                           
//#13542                ine=0;                                                           
//#13543                hunlok=GetDlgItem(hwndlg,IDC_UNLOCKED);                                                           
//#13544                for(ind=0;ind<xpnt;ind++){                                                           
//#13545                                                                           
//#13546                    if(!(pdat[ind].dwFileAttributes&FILE_ATTRIBUTE_READONLY)){                                                       
//#13547                                                                           
//#13548                        if(SendMessage(hunlok,LB_GETSEL,ine,0))                                                   
//#13549                            pdat[ind].dwFileAttributes|=FILE_ATTRIBUTE_READONLY;                                               
//#13550                        ine++;                                                   
//#13551                    }                                                       
//#13552                }                                                           
//#13553                ritlock(hwndlg);                                                           
//#13554                break;                                                           
//#13555                                                                           
//#13556            case IDC_UNLOCK:                                                               
//#13557                                                                           
//#13558                ine=0;                                                           
//#13559                hlok=GetDlgItem(hwndlg,IDC_LOCKED);                                                           
//#13560                for(ind=0;ind<xpnt;ind++){                                                           
//#13561                                                                           
//#13562                    if((pdat[ind].dwFileAttributes&FILE_ATTRIBUTE_READONLY)){                                                       
//#13563                                                                           
//#13564                        if(SendMessage(hlok,LB_GETSEL,ine,0))                                                   
//#13565                            pdat[ind].dwFileAttributes&=0xffffffff^FILE_ATTRIBUTE_READONLY;                                               
//#13566                        ine++;                                                   
//#13567                    }                                                       
//#13568                }                                                           
//#13569                ritlock(hwndlg);                                                           
//#13570                break;                                                           
//#13571                                                                           
//#13572            case IDOK:                                                               
//#13573                                                                           
//#13574                strcpy(snam,defDir);                                                           
//#13575                strcat(snam,"\\");                                                           
//#13576                ine=0;                                                           
//#13577                for(ind=0;ind<xpnt;ind++){                                                           
//#13578                                                                           
//#13579                    strcpy(tnam,snam);                                                       
//#13580                    strcat(tnam,pdat[ind].cFileName);                                                       
//#13581                    if(!SetFileAttributes(tnam,pdat[ind].dwFileAttributes))                                                       
//#13582                        ine++;                                                   
//#13583                }                                                           
//#13584                if(ine){                                                           
//#13585                                                                           
//#13586                    sprintf(msgbuf,"%d files could not be locked or unlocked\n",ine);                                                       
//#13587                    shoMsg(msgbuf);                                                       
//#13588                }                                                           
//#13589                EndDialog(hwndlg,wparam);                                                            
//#13590                return TRUE;                                                           
//#13591                break;                                                           
//#13592            }                                                               
//#13593        }                                                                   
//#13594        return 0;                                                                   
//#13595    }                                                                       
//#13596                                                                           
//#13597    void lock(){                                                                       
//#13598                                                                           
//#13599        DialogBox(hInst,MAKEINTRESOURCE(IDD_DLOCK),hWnd,(DLGPROC)LockPrc);                                                                   
//#13600    }                                                                       
//#13601                                                                           
//#13602    unsigned colsum(COLORREF col){                                                                       
//#13603                                                                           
//#13604        unsigned colsum;                                                                   
//#13605        unsigned ind;                                                                   
//#13606                                                                           
//#13607        trcols(col);                                                                   
//#13608        colsum=0;                                                                   
//#13609        for(ind=0;ind<3;ind++){                                                                   
//#13610                                                                           
//#13611            if(chkMap(trbits[ind]))                                                               
//#13612                colsum+=pxcols[ind];                                                           
//#13613        }                                                                   
//#13614        return colsum;                                                                   
//#13615    }                                                                       
//#13616                                                                           
//#13617    unsigned icolsum(COLORREF col){                                                                       
//#13618                                                                           
//#13619        unsigned colsum;                                                                   
//#13620        unsigned ind;                                                                   
//#13621                                                                           
//#13622        trcols(col);                                                                   
//#13623        colsum=0;                                                                   
//#13624        for(ind=0;ind<3;ind++){                                                                   
//#13625                                                                           
//#13626            if(chkMap(trbits[ind]))                                                               
//#13627                colsum+=255-pxcols[ind];                                                           
//#13628        }                                                                   
//#13629        return colsum;                                                                   
//#13630    }                                                                       
//#13631                                                                           
//#13632    COLORREF dwnshft(COLORREF col){                                                                       
//#13633                                                                           
//#13634        _asm{                                                                   
//#13635                                                                           
//#13636                mov        eax,col                                                   
//#13637                shr        eax,1                                                   
//#13638                and        eax,0x3f3f3f                                                   
//#13639        }                                                                   
//#13640    }                                                                       
//#13641                                                                           
//#13642    void setrac(unsigned bpnt){                                                                       
//#13643                                                                           
//#13644        _asm{                                                                   
//#13645                                                                           
//#13646                mov        eax,bpnt                                                   
//#13647                mov        ebx,offset oseq                                                   
//#13648                bts        [ebx],eax                                                   
//#13649        }                                                                   
//#13650    }                                                                       
//#13651                                                                           
//#13652    BOOL getrac(unsigned bpnt){                                                                       
//#13653                                                                           
//#13654        _asm{                                                                   
//#13655                                                                           
//#13656                xor        eax,eax                                                   
//#13657                mov        ecx,bpnt                                                   
//#13658                mov        ebx,offset oseq                                                   
//#13659                bt        [ebx],ecx                                                   
//#13660                jnc        short getracx                                                   
//#13661                inc        eax                                                   
//#13662    getracx:                                                                       
//#13663        }                                                                   
//#13664    }                                                                       
//#13665                                                                           
//#13666    void shownd(HWND hwnd){                                                                       
//#13667                                                                           
//#13668        ShowWindow(hwnd,SW_SHOW);                                                                   
//#13669    }                                                                       
//#13670                                                                           
//#13671    void hidwnd(HWND hwnd){                                                                       
//#13672                                                                           
//#13673        ShowWindow(hwnd,SW_HIDE);                                                                   
//#13674    }                                                                       
//#13675                                                                           
//#13676    void untrace(){                                                                       
//#13677                                                                           
//#13678        unsigned    ind;                                                               
//#13679                                                                           
//#13680        if(rstMap(WASTRAC)){                                                                   
//#13681                                                                           
//#13682            DeleteObject(tracebit);                                                               
//#13683            ReleaseDC(hWnd,tracedc);                                                               
//#13684            rstMap(WASEDG);                                                               
//#13685            for(ind=0;ind<16;ind++){                                                               
//#13686                                                                           
//#13687                shownd(hDef[ind]);                                                           
//#13688                shownd(hCol[ind]);                                                           
//#13689                shownd(hSiz[ind]);                                                           
//#13690            }                                                               
//#13691            for(ind=0;ind<3;ind++){                                                               
//#13692                                                                           
//#13693                hidwnd(hctrc[ind]);                                                           
//#13694                hidwnd(hstrc[ind]);                                                           
//#13695                hidwnd(htrup[ind]);                                                           
//#13696                hidwnd(htrdwn[ind]);                                                           
//#13697            }                                                               
//#13698            for(ind=0;ind<9;ind++)                                                               
//#13699                shownd(hbuts[ind]);                                                           
//#13700            hidwnd(hstep);                                                               
//#13701        }                                                                   
//#13702        else{                                                                   
//#13703                                                                           
//#13704            if(chkMap(TRCUP))                                                               
//#13705                dref=0xffffff;                                                           
//#13706            else                                                               
//#13707                uref=0;                                                           
//#13708        }                                                                   
//#13709    }                                                                       
//#13710                                                                           
//#13711    void trcstpnum(){                                                                       
//#13712                                                                           
//#13713        sprintf(msgbuf,"len: %.2f",ini.trlen/PFGRAN);                                                                   
//#13714        SetWindowText(hstep,msgbuf);                                                                   
//#13715    }                                                                       
//#13716                                                                           
//#13717    void trcratnum(){                                                                       
//#13718                                                                           
//#13719        sprintf(msgbuf,"pnts: %.2f",-log10(ini.trcrat-1));                                                                   
//#13720        butxt(HLIN,msgbuf);                                                                   
//#13721    }                                                                       
//#13722                                                                           
//#13723    void clrhbut(unsigned strt)                                                                       
//#13724    {                                                                       
//#13725        unsigned ind;                                                                   
//#13726                                                                           
//#13727        for(ind=strt;ind<9;ind++)                                                                   
//#13728            SetWindowText(hbuts[ind],"");                                                               
//#13729    }                                                                       
//#13730                                                                           
//#13731    void tracwnd(){                                                                       
//#13732                                                                           
//#13733        unsigned ind;                                                                   
//#13734                                                                           
//#13735        for(ind=0;ind<16;ind++){                                                                   
//#13736                                                                           
//#13737            hidwnd(hDef[ind]);                                                               
//#13738            hidwnd(hCol[ind]);                                                               
//#13739            hidwnd(hSiz[ind]);                                                               
//#13740        }                                                                   
//#13741        for(ind=0;ind<3;ind++){                                                                   
//#13742                                                                           
//#13743            shownd(hctrc[ind]);                                                               
//#13744            shownd(hstrc[ind]);                                                               
//#13745            shownd(htrup[ind]);                                                               
//#13746            shownd(htrdwn[ind]);                                                               
//#13747        }                                                                   
//#13748        hidwnd(hbuts[HBOXSEL]);                                                                   
//#13749        hidwnd(hbuts[HUPTO]);                                                                   
//#13750        shownd(hstep);                                                                   
//#13751        trcstpnum();                                                                   
//#13752        trcratnum();                                                                   
//#13753        clrhbut(4);                                                                   
//#13754    }                                                                       
//#13755                                                                           
//#13756    void trcols(COLORREF col){                                                                       
//#13757                                                                           
//#13758        _asm{                                                                   
//#13759                                                                           
//#13760                mov        eax,col                                                   
//#13761                mov        ecx,offset pxcols                                                   
//#13762                movzx    ebx,al                                                       
//#13763                mov        [ecx],ebx                                                   
//#13764                add        ecx,4                                                   
//#13765                movzx    ebx,ah                                                       
//#13766                mov        [ecx],ebx                                                   
//#13767                shr        eax,8                                                   
//#13768                movzx    ebx,ah                                                       
//#13769                add        ecx,4                                                   
//#13770                mov        [ecx],ebx                                                   
//#13771        }                                                                   
//#13772    }                                                                       
//#13773                                                                           
//#13774    BOOL trcin(COLORREF col){                                                                       
//#13775                                                                           
//#13776        if(col){                                                                   
//#13777                                                                           
//#13778            trcols(col);                                                               
//#13779            if(chkMap(TRCRED)){                                                               
//#13780                                                                           
//#13781                if(pxcols[0]>hicols[0])                                                           
//#13782                    return 0;                                                       
//#13783                if(pxcols[0]<locols[0])                                                           
//#13784                    return 0;                                                       
//#13785            }                                                               
//#13786            if(chkMap(TRCGRN)){                                                               
//#13787                                                                           
//#13788                if(pxcols[1]>hicols[1])                                                           
//#13789                    return 0;                                                       
//#13790                if(pxcols[1]<locols[1])                                                           
//#13791                    return 0;                                                       
//#13792            }                                                               
//#13793            if(chkMap(TRCBLU)){                                                               
//#13794                                                                           
//#13795                if(pxcols[2]>hicols[2])                                                           
//#13796                    return 0;                                                       
//#13797                if(pxcols[2]<locols[2])                                                           
//#13798                    return 0;                                                       
//#13799            }                                                               
//#13800            return 1;                                                               
//#13801        }                                                                   
//#13802        return 0;                                                                   
//#13803    }                                                                       
//#13804                                                                           
//#13805    void getrmap(){                                                                       
//#13806                                                                           
//#13807        BITMAPINFO            binf;                                                       
//#13808        BITMAPINFOHEADER    binfh;                                                               
//#13809        unsigned            ind;                                                       
//#13810                                                                           
//#13811        memset((BITMAPINFOHEADER*)&binfh,0,sizeof(BITMAPINFOHEADER));                                                                   
//#13812        binfh.biSize=sizeof(BITMAPINFOHEADER);                                                                   
//#13813        binfh.biWidth=bwid;                                                                   
//#13814        binfh.biHeight=bhi;                                                                   
//#13815        binfh.biPlanes=1;                                                                   
//#13816        binfh.biBitCount=32;                                                                   
//#13817        binfh.biCompression=BI_RGB;                                                                   
//#13818        binf.bmiHeader=binfh;                                                                   
//#13819        tracebit=CreateDIBSection(bitdc,&binf,DIB_RGB_COLORS,(void**)&tracbits,0,0);                                                                   
//#13820        tracedc=CreateCompatibleDC(rsdc);                                                                   
//#13821        SelectObject(tracedc,tracebit);                                                                   
//#13822        BitBlt(tracedc,0,0,bwid,bhi,bitdc,0,0,SRCCOPY);                                                                   
//#13823        setMap(WASTRAC);                                                                   
//#13824        tracmap=(unsigned*)oseq;                                                                   
//#13825        trmapsiz=((bwid*bhi)>>5)+1;                                                                   
//#13826        for(ind=0;ind<trmapsiz;ind++)                                                                   
//#13827            tracmap[ind]=0;                                                               
//#13828        StretchBlt(sdc,bdrct.left,bdrct.top,bdrct.right-bdrct.left,bdrct.bottom-bdrct.top,                                                                   
//#13829           bitdc,bsrct.left,bsrct.top,bsrct.right-bsrct.left,bsrct.bottom-bsrct.top,SRCCOPY);                                                                   
//#13830    }                                                                       
//#13831                                                                           
//#13832    void trace(){                                                                       
//#13833                                                                           
//#13834        unsigned            ind;                                                       
//#13835                                                                           
//#13836    #if TRCMTH==0                                                                       
//#13837                                                                           
//#13838        unsigned            usum,psum,dsum;                                                       
//#13839    #endif                                                                       
//#13840                                                                           
//#13841        if(*bnam){                                                                   
//#13842                                                                           
//#13843            untrace();                                                               
//#13844            tracwnd();                                                               
//#13845            getrmap();                                                               
//#13846            if(px2stch()&&!rstMap(WASTRCOL)){                                                               
//#13847                                                                           
//#13848                if(chkMap(LANDSCAP))                                                           
//#13849                    sPnt.y-=(zum0.y-zumend.y);                                                       
//#13850                bitpnt.x=bsrat.x*sPnt.x;                                                           
//#13851                bitpnt.y=bsrat.y*sPnt.y-1;                                                           
//#13852                ind=tracbits[bitpnt.y*bwid+bitpnt.x]^0xffffff;                                                           
//#13853                if(chkMap(TRCUP)){                                                           
//#13854                                                                           
//#13855                    uref=ind;                                                       
//#13856                    dref=0xffffff;                                                       
//#13857                }                                                           
//#13858                else{                                                           
//#13859                                                                           
//#13860                    dref=ind;                                                       
//#13861                    uref=0;                                                       
//#13862                }                                                           
//#13863                setMap(TRCRED);                                                           
//#13864                setMap(TRCGRN);                                                           
//#13865                setMap(TRCBLU);                                                           
//#13866            }                                                               
//#13867            sref=0xffffff;                                                               
//#13868            if(!chkMap(TRCRED))                                                               
//#13869                sref&=REDMSK;                                                           
//#13870            if(!chkMap(TRCGRN))                                                               
//#13871                sref&=GRNMSK;                                                           
//#13872            if(!chkMap(TRCBLU))                                                               
//#13873                sref&=BLUMSK;                                                           
//#13874            if(sref!=0xffffff){                                                               
//#13875                                                                           
//#13876                for(ind=0;ind<bwid*bhi;ind++)                                                           
//#13877                    tracbits[ind]&=sref;                                                       
//#13878            }                                                               
//#13879                                                                           
//#13880    #if TRCMTH==0                                                                       
//#13881                                                                           
//#13882            usum=icolsum(uref);                                                               
//#13883            dsum=icolsum(dref);                                                               
//#13884            for(ind=0;ind<bwid*bhi;ind++){                                                               
//#13885                                                                           
//#13886                psum=colsum(tracbits[ind]);                                                           
//#13887                if(usum>psum&&dsum<psum)                                                           
//#13888                    setrac(ind);                                                       
//#13889                else                                                           
//#13890                    tracbits[ind]=0;                                                       
//#13891            }                                                               
//#13892    #endif                                                                       
//#13893                                                                           
//#13894    #if TRCMTH==1                                                                       
//#13895            curef=uref^0xffffff;                                                               
//#13896            cdref=dref^0xffffff;                                                               
//#13897            trcols(curef);                                                               
//#13898            for(ind=0;ind<3;ind++)                                                               
//#13899                hicols[ind]=pxcols[ind];                                                           
//#13900            trcols(cdref);                                                               
//#13901            for(ind=0;ind<3;ind++)                                                               
//#13902                locols[ind]=pxcols[ind];                                                           
//#13903            for(ind=0;ind<bwid*bhi;ind++){                                                               
//#13904                                                                           
//#13905                if(trcin(tracbits[ind]))                                                           
//#13906                    setrac(ind);                                                       
//#13907                else                                                           
//#13908                    tracbits[ind]=0;                                                       
//#13909            }                                                               
//#13910    #endif                                                                       
//#13911            setMap(TRSET);                                                               
//#13912            setMap(RESTCH);                                                               
//#13913        }                                                                   
//#13914        else                                                                   
//#13915            tabmsg(IDS_MAPLOD);                                                               
//#13916    }                                                                       
//#13917                                                                           
//#13918    void setedg(unsigned bpnt){                                                                       
//#13919                                                                           
//#13920        _asm{                                                                   
//#13921                                                                           
//#13922                mov        eax,bpnt                                                   
//#13923                mov        ebx,edgmap                                                   
//#13924                bts        [ebx],eax                                                   
//#13925        }                                                                   
//#13926    }                                                                       
//#13927                                                                           
//#13928    BOOL chkedg(unsigned bpnt){                                                                       
//#13929                                                                           
//#13930        _asm{                                                                   
//#13931                                                                           
//#13932                xor        eax,eax                                                   
//#13933                mov        ecx,bpnt                                                   
//#13934                mov        ebx,edgmap                                                   
//#13935                bt        [ebx],ecx                                                   
//#13936                jnc        short chkedgx                                                   
//#13937                inc        eax                                                   
//#13938    chkedgx:                                                                       
//#13939        }                                                                   
//#13940    }                                                                       
//#13941                                                                           
//#13942    void tracedg(){                                                                       
//#13943                                                                           
//#13944        unsigned    ind,ine,flg;                                                               
//#13945        long        bpnt;                                                           
//#13946                                                                           
//#13947        if(!chkMap(WASTRAC))                                                                   
//#13948            trace();                                                               
//#13949        edgmap=(unsigned*)&oseq[trmapsiz];                                                                   
//#13950        for(ind=0;ind<trmapsiz;ind++)                                                                   
//#13951            edgmap[ind]=0;                                                               
//#13952        bpnt=0;                                                                   
//#13953        for(ind=0;ind<bhi;ind++){                                                                   
//#13954                                                                           
//#13955            flg=0;                                                               
//#13956            for(ine=0;ine<bwid;ine++){                                                               
//#13957                                                                           
//#13958                if(getrac(bpnt)){                                                           
//#13959                                                                           
//#13960                    if(!flg){                                                       
//#13961                                                                           
//#13962                        setedg(bpnt);                                                   
//#13963                        flg=1;                                                   
//#13964                    }                                                       
//#13965                }                                                           
//#13966                else{                                                           
//#13967                                                                           
//#13968                    if(flg){                                                       
//#13969                                                                           
//#13970                        setedg(bpnt-1);                                                   
//#13971                        flg=0;                                                   
//#13972                    }                                                       
//#13973                }                                                           
//#13974                bpnt++;                                                           
//#13975            }                                                               
//#13976            if(flg)                                                               
//#13977                setedg(bpnt-1);                                                           
//#13978        }                                                                   
//#13979        for(ind=0;ind<bwid;ind++){                                                                   
//#13980                                                                           
//#13981            bpnt=ind;                                                               
//#13982            flg=0;                                                               
//#13983            for(ine=0;ine<bhi;ine++){                                                               
//#13984                                                                           
//#13985                if(getrac(bpnt)){                                                           
//#13986                                                                           
//#13987                    if(!flg){                                                       
//#13988                                                                           
//#13989                        setedg(bpnt);                                                   
//#13990                        flg=1;                                                   
//#13991                    }                                                       
//#13992                }                                                           
//#13993                else{                                                           
//#13994                                                                           
//#13995                    if(flg){                                                       
//#13996                                                                           
//#13997                        setedg(bpnt-bwid);                                                   
//#13998                        flg=0;                                                   
//#13999                    }                                                       
//#14000                }                                                           
//#14001                bpnt+=bwid;                                                           
//#14002            }                                                               
//#14003            if(flg)                                                               
//#14004                setedg(bpnt-bwid);                                                           
//#14005        }                                                                   
//#14006        for(ind=0;ind<bwid*bhi;ind++){                                                                   
//#14007                                                                           
//#14008            if(chkedg(ind))                                                               
//#14009                tracbits[ind]=0xffffff;                                                           
//#14010            else                                                               
//#14011                tracbits[ind]=0;                                                           
//#14012        }                                                                   
//#14013        setMap(RESTCH);                                                                   
//#14014        setMap(WASEDG);                                                                   
//#14015    }                                                                       
//#14016                                                                           
//#14017    BOOL trcbit(){                                                                       
//#14018        unsigned bpnt;                                                                   
//#14019                                                                           
//#14020        bpnt=tracpnt.y*bwid+tracpnt.x;                                                                   
//#14021        switch(trcdir){                                                                   
//#14022                                                                           
//#14023        case TRCR:                                                                   
//#14024                                                                           
//#14025            bpnt+=(1-bwid);                                                               
//#14026            if(tracpnt.x==(int)bwid-1)                                                               
//#14027                trcdir=TRCU;                                                           
//#14028            else{                                                               
//#14029                                                                           
//#14030                if(chkedg(bpnt)){                                                           
//#14031                                                                           
//#14032                    tracpnt.x++;                                                       
//#14033                    tracpnt.y--;                                                       
//#14034                    trcdir=TRCD;                                                       
//#14035                }                                                           
//#14036                else{                                                           
//#14037                                                                           
//#14038                    bpnt+=bwid;                                                       
//#14039                    if(chkedg(bpnt))                                                       
//#14040                        tracpnt.x++;                                                   
//#14041                    else                                                       
//#14042                        trcdir=TRCU;                                                   
//#14043                }                                                           
//#14044            }                                                               
//#14045            break;                                                               
//#14046                                                                           
//#14047        case TRCD:                                                                   
//#14048                                                                           
//#14049            bpnt-=(bwid+1);                                                               
//#14050            if(!tracpnt.y)                                                               
//#14051                trcdir=TRCR;                                                           
//#14052            else{                                                               
//#14053                                                                           
//#14054                if(chkedg(bpnt)){                                                           
//#14055                                                                           
//#14056                    tracpnt.x--;                                                       
//#14057                    tracpnt.y--;                                                       
//#14058                    trcdir=TRCL;                                                       
//#14059                }                                                           
//#14060                else{                                                           
//#14061                                                                           
//#14062                    bpnt++;                                                       
//#14063                    if(chkedg(bpnt))                                                       
//#14064                        tracpnt.y--;                                                   
//#14065                    else                                                       
//#14066                        trcdir=TRCR;                                                   
//#14067                }                                                           
//#14068            }                                                               
//#14069            break;                                                               
//#14070                                                                           
//#14071        case TRCL:                                                                   
//#14072                                                                           
//#14073            bpnt+=(bwid-1);                                                               
//#14074            if(!tracpnt.x)                                                               
//#14075                trcdir=TRCD;                                                           
//#14076            else{                                                               
//#14077                                                                           
//#14078                if(chkedg(bpnt)){                                                           
//#14079                                                                           
//#14080                    tracpnt.x--;                                                       
//#14081                    tracpnt.y++;                                                       
//#14082                    trcdir=TRCU;                                                       
//#14083                }                                                           
//#14084                else{                                                           
//#14085                                                                           
//#14086                    bpnt-=bwid;                                                       
//#14087                    if(chkedg(bpnt))                                                       
//#14088                        tracpnt.x--;                                                   
//#14089                    else                                                       
//#14090                        trcdir=TRCD;                                                   
//#14091                }                                                           
//#14092            }                                                               
//#14093            break;                                                               
//#14094                                                                           
//#14095        case TRCU:                                                                   
//#14096                                                                           
//#14097            bpnt+=(1+bwid);                                                               
//#14098            if(tracpnt.y==(int)bhi-1)                                                               
//#14099                trcdir=TRCL;                                                           
//#14100            else{                                                               
//#14101                                                                           
//#14102                if(chkedg(bpnt)){                                                           
//#14103                                                                           
//#14104                    tracpnt.x++;                                                       
//#14105                    tracpnt.y++;                                                       
//#14106                    trcdir=TRCR;                                                       
//#14107                }                                                           
//#14108                else{                                                           
//#14109                                                                           
//#14110                    bpnt--;                                                       
//#14111                    if(chkedg(bpnt))                                                       
//#14112                        tracpnt.y++;                                                   
//#14113                    else                                                       
//#14114                        trcdir=TRCL;                                                   
//#14115                }                                                           
//#14116            }                                                               
//#14117            break;                                                               
//#14118        }                                                                   
//#14119        if(trclin[xpnt-1].x!=tracpnt.x||trclin[xpnt-1].y!=tracpnt.y){                                                                   
//#14120                                                                           
//#14121            trclin[xpnt].x=tracpnt.x;                                                               
//#14122            trclin[xpnt++].y=tracpnt.y;                                                               
//#14123            if(xpnt>=500000)                                                               
//#14124                return 0;                                                           
//#14125        }                                                                   
//#14126        if(trcdir==inidir&&tracpnt.x==trclin[0].x&&tracpnt.y==trclin[0].y)                                                                   
//#14127            return 0;                                                               
//#14128        else                                                                   
//#14129            return 1;                                                               
//#14130    }                                                                       
//#14131                                                                           
//#14132    void dutdif(TRCPNT* pnt){                                                                       
//#14133                                                                           
//#14134        trdif0.x=pnt[1].x-pnt[0].x;                                                                   
//#14135        trdif0.y=pnt[1].x-pnt[0].y;                                                                   
//#14136    }                                                                       
//#14137                                                                           
//#14138    void dutrac(){                                                                       
//#14139                                                                           
//#14140        unsigned    flg;                                                               
//#14141        RECT        fndrct;                                                           
//#14142        long        bpnt,blim,bakpnt;                                                           
//#14143        long        dis,mdis;                                                           
//#14144        unsigned    ind;                                                               
//#14145        double        tlen;                                                           
//#14146        double        tlens;                                                           
//#14147        float        ratof;                                                           
//#14148        unsigned    ine;                                                               
//#14149                                                                           
//#14150        if(px2stch()){                                                                   
//#14151                                                                           
//#14152            if(!chkMap(WASEDG)){                                                               
//#14153                                                                           
//#14154                tracedg();                                                           
//#14155                return;                                                           
//#14156            }                                                               
//#14157            savdo();                                                               
//#14158            if(chkMap(LANDSCAP))                                                               
//#14159                sPnt.y-=(zum0.y-zumend.y);                                                           
//#14160            tracpnt.x=bsrat.x*sPnt.x;                                                               
//#14161            tracpnt.y=bsrat.y*sPnt.y;                                                               
//#14162            if(tracpnt.x>(long)bwid)                                                               
//#14163                tracpnt.x=bwid;                                                           
//#14164            if(tracpnt.y>(long)bhi)                                                               
//#14165                tracpnt.y=bhi;                                                           
//#14166            bakpnt=bpnt=tracpnt.y*bwid+tracpnt.x;                                                               
//#14167            if(!chkedg(bpnt)){                                                               
//#14168                                                                           
//#14169                flg=20;                                                           
//#14170                bpnt=bakpnt;                                                           
//#14171                blim=(tracpnt.y+1)*bwid;                                                           
//#14172                while(bpnt<blim&&!chkedg(bpnt))                                                           
//#14173                    bpnt++;                                                       
//#14174                if(bpnt<blim)                                                           
//#14175                    fndrct.right=bpnt-tracpnt.y*bwid;                                                       
//#14176                else                                                           
//#14177                    fndrct.right=bwid;                                                       
//#14178                bpnt=bakpnt;                                                           
//#14179                blim=tracpnt.y*bwid;                                                           
//#14180                while(bpnt>blim&&!chkedg(bpnt))                                                           
//#14181                    bpnt--;                                                       
//#14182                if(bpnt==blim)                                                           
//#14183                    fndrct.left=0;                                                       
//#14184                else                                                           
//#14185                    fndrct.left=bpnt-blim;                                                       
//#14186                bpnt=bakpnt;                                                           
//#14187                while(bpnt>0&&!chkedg(bpnt))                                                           
//#14188                    bpnt-=bwid;                                                       
//#14189                if(bpnt>0)                                                           
//#14190                    fndrct.bottom=bpnt/bwid;                                                       
//#14191                else                                                           
//#14192                    fndrct.bottom=0;                                                       
//#14193                bpnt=bakpnt;                                                           
//#14194                blim=bwid*bhi;                                                           
//#14195                while(bpnt<blim&&!chkedg(bpnt))                                                           
//#14196                    bpnt+=bwid;                                                       
//#14197                if(bpnt<blim)                                                           
//#14198                    fndrct.top=bpnt/bwid;                                                       
//#14199                else                                                           
//#14200                    fndrct.top=bhi;                                                       
//#14201                flg=0;                                                           
//#14202                mdis=0x7fffffff;                                                           
//#14203                if(fndrct.left){                                                           
//#14204                                                                           
//#14205                    mdis=tracpnt.x-fndrct.left;                                                       
//#14206                    flg=TRCL;                                                       
//#14207                }                                                           
//#14208                if(fndrct.right<(long)bwid){                                                           
//#14209                                                                           
//#14210                    dis=fndrct.right-tracpnt.x;                                                       
//#14211                    if(dis<mdis){                                                       
//#14212                                                                           
//#14213                        mdis=dis;                                                   
//#14214                        flg=TRCR;                                                   
//#14215                    }                                                       
//#14216                }                                                           
//#14217                if(fndrct.bottom){                                                           
//#14218                                                                           
//#14219                    dis=tracpnt.y-fndrct.bottom;                                                       
//#14220                    if(dis<mdis){                                                       
//#14221                                                                           
//#14222                        mdis=dis;                                                   
//#14223                        flg=TRCD;                                                   
//#14224                    }                                                       
//#14225                }                                                           
//#14226                if(fndrct.top<(long)bhi){                                                           
//#14227                                                                           
//#14228                    dis=fndrct.top-tracpnt.y;                                                       
//#14229                    if(dis<mdis){                                                       
//#14230                                                                           
//#14231                        mdis=dis;                                                   
//#14232                        flg=TRCU;                                                   
//#14233                    }                                                       
//#14234                }                                                           
//#14235                switch(flg){                                                           
//#14236                                                                           
//#14237                case TRCU:                                                           
//#14238                                                                           
//#14239                    tracpnt.y=fndrct.top;                                                       
//#14240                    trcdir=TRCR;                                                       
//#14241                    break;                                                       
//#14242                                                                           
//#14243                case TRCR:                                                           
//#14244                                                                           
//#14245                    tracpnt.x=fndrct.right;                                                       
//#14246                    trcdir=TRCD;                                                       
//#14247                    break;                                                       
//#14248                                                                           
//#14249                case TRCD:                                                           
//#14250                                                                           
//#14251                    tracpnt.y=fndrct.bottom;                                                       
//#14252                    trcdir=TRCL;                                                       
//#14253                    break;                                                       
//#14254                                                                           
//#14255                case TRCL:                                                           
//#14256                                                                           
//#14257                    tracpnt.x=fndrct.left;                                                       
//#14258                    trcdir=TRCU;                                                       
//#14259                    break;                                                       
//#14260                                                                           
//#14261                default:                                                           
//#14262                    return;                                                       
//#14263                }                                                           
//#14264            }                                                               
//#14265            inidir=trcdir;                                                               
//#14266            bpnt=tracpnt.y*bwid+tracpnt.x;                                                               
//#14267            tracmov[2]=tracmov[3]=-(long)bwid;                                                               
//#14268            tracmov[6]=tracmov[7]=bwid;                                                               
//#14269            xpnt=1;                                                               
//#14270            trclin=(TRCPNT*)bseq;                                                               
//#14271            trclin[0].x=tracpnt.x;                                                               
//#14272            trclin[0].y=tracpnt.y;                                                               
//#14273            while(trcbit());                                                               
//#14274            if(xpnt>=500000){                                                               
//#14275                                                                           
//#14276                tabmsg(IDS_FRM2L);                                                           
//#14277                return;                                                           
//#14278            }                                                               
//#14279            diflin=&trclin[xpnt];                                                               
//#14280            diflin[0].x=trclin[0].x;                                                               
//#14281            diflin[0].y=trclin[0].y;                                                               
//#14282            dutdif(&trclin[0]);                                                               
//#14283            opnt=1;                                                               
//#14284            for(ind=1;ind<xpnt;ind++){                                                               
//#14285                                                                           
//#14286                trdif1.x=trdif0.x;                                                           
//#14287                trdif1.y=trdif0.y;                                                           
//#14288                dutdif(&trclin[ind]);                                                           
//#14289                if(trdif1.x!=trdif0.x||trdif1.y!=trdif0.y){                                                           
//#14290                                                                           
//#14291                    diflin[opnt].x=trclin[ind].x;                                                       
//#14292                    diflin[opnt++].y=trclin[ind].y;                                                       
//#14293                }                                                           
//#14294            }                                                               
//#14295            trclin[0].x=diflin[0].x;                                                               
//#14296            trclin[0].y=diflin[0].y;                                                               
//#14297            ine=0;                                                               
//#14298            xpnt=0;                                                               
//#14299            for(ind=1;ind<opnt;ind++){                                                               
//#14300                                                                           
//#14301                tlen=hypot(diflin[ind].x-diflin[ine].x,diflin[ind].y-diflin[ine].y);                                                           
//#14302                if(tlen>ini.trlen){                                                           
//#14303                                                                           
//#14304                    trclin[xpnt].x=diflin[ine].x;                                                       
//#14305                    trclin[xpnt].y=diflin[ine].y;                                                       
//#14306                    ine=ind;                                                       
//#14307                    xpnt++;                                                       
//#14308                }                                                           
//#14309            }                                                               
//#14310            for(ind=ine+1;ind<opnt;ind++){                                                               
//#14311                                                                           
//#14312                trclin[xpnt].x=diflin[ind].x;                                                           
//#14313                trclin[xpnt].y=diflin[ind].y;                                                           
//#14314                xpnt++;                                                           
//#14315            }                                                               
//#14316            frmpnt=&formlst[formpnt];                                                               
//#14317            frmclr(frmpnt);                                                               
//#14318            flt=&flts[fltad];                                                               
//#14319            flt[0].x=trclin[0].x*birat.x;                                                               
//#14320            flt[0].y=trclin[0].y*birat.y;                                                               
//#14321            ine=0;                                                               
//#14322            opnt=0;                                                               
//#14323            tlens=0;                                                               
//#14324            if(chkMap(LANDSCAP))                                                               
//#14325                ratof=zum0.y-zumend.y;                                                           
//#14326            else                                                               
//#14327                ratof=0;                                                           
//#14328            for(ind=1;ind<xpnt;ind++){                                                               
//#14329                                                                           
//#14330                tlens+=hypot(trclin[ind].x-trclin[ind-1].x,trclin[ind].y-trclin[ind-1].y);                                                           
//#14331                tlen=hypot(trclin[ind].x-trclin[ine].x,trclin[ind].y-trclin[ine].y);                                                           
//#14332                if(tlens>tlen*ini.trcrat){                                                           
//#14333                                                                           
//#14334                    flt[opnt].x=trclin[ind-1].x*birat.x;                                                       
//#14335                    flt[opnt].y=trclin[ind-1].y*birat.y+ratof;                                                       
//#14336                    opnt++;                                                       
//#14337                    ind--;                                                       
//#14338                    ine=ind;                                                       
//#14339                    tlens=0;                                                       
//#14340                }                                                           
//#14341            }                                                               
//#14342            if(fltad+opnt>MAXFLT){                                                               
//#14343                                                                           
//#14344                tabmsg(IDS_FRMOVR);                                                           
//#14345                return;                                                           
//#14346            }                                                               
//#14347            frmpnt->flt=adflt(opnt);                                                               
//#14348            frmpnt->sids=opnt;                                                               
//#14349            frmpnt->typ=POLI;                                                               
//#14350            frmpnt->at=actl<<1;                                                               
//#14351            frmout(formpnt);                                                               
//#14352            formlst[formpnt].stpt=0;                                                               
//#14353            formpnt++;                                                               
//#14354            setMap(RESTCH);                                                               
//#14355            setMap(FRMOF);                                                               
//#14356            tglfrm();                                                               
//#14357        }                                                                   
//#14358    }                                                                       
//#14359                                                                           
//#14360    unsigned ducolm(){                                                                       
//#14361                                                                           
//#14362        if(trcmpnt.x<(int)buttonWid)                                                                   
//#14363            return 0;                                                               
//#14364        if(trcmpnt.x<(int)buttonWid<<1)                                                                   
//#14365            return 1;                                                               
//#14366        else                                                                   
//#14367            return 2;                                                               
//#14368    }                                                                       
//#14369                                                                           
//#14370    void chkref(){                                                                       
//#14371                                                                           
//#14372        _asm{                                                                   
//#14373                mov        eax,uref                                                   
//#14374                mov        ebx,dref                                                   
//#14375                cmp        al,bl                                                   
//#14376                jc        short chklup1                                                   
//#14377                mov        dl,al                                                   
//#14378                mov        al,bl                                                   
//#14379                mov        bl,dl                                                   
//#14380    chklup1:    cmp        ah,bh                                                           
//#14381                jc        short chklup2                                                   
//#14382                mov        dl,ah                                                   
//#14383                mov        ah,bh                                                   
//#14384                mov        bh,dl                                                   
//#14385    chklup2:    ror        eax,16                                                           
//#14386                ror        ebx,16                                                   
//#14387                cmp        al,bl                                                   
//#14388                jc        short chklup3                                                   
//#14389                mov        dl,al                                                   
//#14390                mov        al,bl                                                   
//#14391                mov        bl,dl                                                   
//#14392    chklup3:    rol        eax,16                                                           
//#14393                rol        ebx,16                                                   
//#14394                mov        uref,eax                                                   
//#14395                mov        dref,ebx                                                   
//#14396        }                                                                   
//#14397    }                                                                       
//#14398                                                                           
//#14399    void trnumwnd0(int pos){                                                                       
//#14400                                                                           
//#14401        htrnum=CreateWindow(                                                                   
//#14402            STATIC,                                                               
//#14403            0                                                               
//#14404            SS_OWNERDRAW|WS_CHILD|WS_VISIBLE|WS_BORDER,                                                               
//#14405            buttonWid3,                                                               
//#14406            pos,                                                               
//#14407            buttonWid,                                                               
//#14408            buttonHi,                                                               
//#14409            hWnd,                                                               
//#14410            NULL,                                                               
//#14411            hInst,                                                               
//#14412            NULL);                                                               
//#14413    }                                                                       
//#14414                                                                           
//#14415    void trnumwnd1(int pos){                                                                       
//#14416                                                                           
//#14417        hgNum=CreateWindow(                                                                   
//#14418            STATIC,                                                               
//#14419            0                                                               
//#14420            WS_CHILD|WS_VISIBLE|WS_BORDER,                                                               
//#14421            buttonWid3,                                                               
//#14422            pos,                                                               
//#14423            buttonWid3,                                                               
//#14424            buttonHi,                                                               
//#14425            hWnd,                                                               
//#14426            NULL,                                                               
//#14427            hInst,                                                               
//#14428            NULL);                                                               
//#14429    }                                                                       
//#14430                                                                           
//#14431    void tracpar(){                                                                       
//#14432                                                                           
//#14433        unsigned    pos;                                                               
//#14434        double        rat;                                                           
//#14435        COLORREF    tcol;                                                               
//#14436        COLORREF    tpos;                                                               
//#14437                                                                           
//#14438        if(chkMap(TRNIN0))                                                                   
//#14439            dutrnum0(atoi(trinbuf));                                                               
//#14440        if(chkMap(TRNIN1))                                                                   
//#14441            dutrnum1();                                                               
//#14442        trcmpnt.x=msg.pt.x-morg.x;                                                                   
//#14443        trcmpnt.y=msg.pt.y-morg.y;                                                                   
//#14444        if(trcmpnt.x>(int)buttonWid3)                                                                   
//#14445            dutrac();                                                               
//#14446        else{                                                                   
//#14447                                                                           
//#14448            colm=ducolm();                                                               
//#14449            if(trcmpnt.y<(int)buttonHi*15){                                                               
//#14450                                                                           
//#14451                if(GetKeyState(VK_SHIFT)&0X8000){                                                           
//#14452                                                                           
//#14453                    uref&=trmsks[colm];                                                       
//#14454                    dref|=trgb[2-colm];                                                       
//#14455                    goto tracpar1;                                                       
//#14456                }                                                           
//#14457                rat=(float)trcmpnt.y/(buttonHi*15);                                                           
//#14458                pos=rat*255;                                                           
//#14459                tcol=uref&trgb[2-colm];                                                           
//#14460                tpos=pos<<trshft[colm];                                                           
//#14461                if(tpos<tcol){                                                           
//#14462                                                                           
//#14463                    uref&=trmsks[colm];                                                       
//#14464                    uref|=tpos;                                                       
//#14465                    goto tracpar1;                                                       
//#14466                }                                                           
//#14467                tcol=dref&trgb[2-colm];                                                           
//#14468                if(tpos>tcol){                                                           
//#14469                                                                           
//#14470                    dref&=trmsks[colm];                                                       
//#14471                    dref|=tpos;                                                       
//#14472                    goto tracpar1;                                                       
//#14473                }                                                           
//#14474                if(msg.message==WM_LBUTTONDOWN){                                                           
//#14475                                                                           
//#14476                    uref&=trmsks[colm];                                                       
//#14477                    uref|=pos<<trshft[colm];                                                       
//#14478                }                                                           
//#14479                else{                                                           
//#14480                                                                           
//#14481                    dref&=trmsks[colm];                                                       
//#14482                    dref|=pos<<trshft[colm];                                                       
//#14483                }                                                           
//#14484    tracpar1:                                                                       
//#14485                redraw(hctrc[colm]);                                                           
//#14486                trace();                                                           
//#14487            }                                                               
//#14488            else{                                                               
//#14489                                                                           
//#14490    //            pos=floor(trcmpnt.y/buttonHi);                                                           
//#14491                pos = floor((double)(trcmpnt.y/buttonHi)); // xiaoguang                                                           
//#14492                if(pos<16){                                                           
//#14493                                                                           
//#14494                    toglMap(trbits[colm]);                                                       
//#14495                    redraw(hstrc[colm]);                                                       
//#14496                    trace();                                                       
//#14497                }                                                           
//#14498                else{                                                           
//#14499                                                                           
//#14500                    if(pos<18){                                                       
//#14501                                                                           
//#14502                        setMap(NUMIN);                                                   
//#14503                        setMap(TRNIN0);                                                   
//#14504                        msgpnt=0;                                                   
//#14505                        *trinbuf=0;                                                   
//#14506                        if(pos<17){                                                   
//#14507                                                                           
//#14508                            trnumwnd0(buttonHi*16);                                               
//#14509                            setMap(TRNUP);                                               
//#14510                        }                                                   
//#14511                        else{                                                   
//#14512                                                                           
//#14513                            trnumwnd0(buttonHi*17);                                               
//#14514                            rstMap(TRNUP);                                               
//#14515                        }                                                   
//#14516                    }                                                       
//#14517                    else{                                                       
//#14518                                                                           
//#14519                        if(pos<20){                                                   
//#14520                                                                           
//#14521                            setMap(NUMIN);                                               
//#14522                            setMap(TRNIN1);                                               
//#14523                            msgpnt=0;                                               
//#14524                            *trinbuf=0;                                               
//#14525                            if(pos<19){                                               
//#14526                                                                           
//#14527                                trnumwnd1(buttonHi*18);                                           
//#14528                                setMap(TRNUP);                                           
//#14529                            }                                               
//#14530                            else{                                               
//#14531                                                                           
//#14532                                trnumwnd1(buttonHi*19);                                           
//#14533                                rstMap(TRNUP);                                           
//#14534                            }                                               
//#14535                        }                                                   
//#14536                        else{                                                   
//#14537                                                                           
//#14538                            switch(pos){                                               
//#14539                                                                           
//#14540                            case 20:                                               
//#14541                                                                           
//#14542                                trdif();                                           
//#14543                                break;                                           
//#14544                                                                           
//#14545                            case 21:                                               
//#14546                                                                           
//#14547                                hidbit();                                           
//#14548                                break;                                           
//#14549                                                                           
//#14550                            case 22:                                               
//#14551                                                                           
//#14552                                blak();                                           
//#14553                                break;                                           
//#14554                                                                           
//#14555                            case 23:                                               
//#14556                                                                           
//#14557                                trcsel();                                           
//#14558                                break;                                           
//#14559                                                                           
//#14560                            case 24:                                               
//#14561                                                                           
//#14562                                tracedg();                                           
//#14563                                break;                                           
//#14564                            }                                               
//#14565                        }                                                   
//#14566                    }                                                       
//#14567                }                                                           
//#14568            }                                                               
//#14569        }                                                                   
//#14570    }                                                                       
//#14571                                                                           
//#14572    void difbits(unsigned shft,unsigned* bpnt){                                                                       
//#14573                                                                           
//#14574        _asm{                                                                   
//#14575                                                                           
//#14576                jmp        short difbts                                                   
//#14577                                                                           
//#14578    difsub:        mov        eax,[esi]                                                       
//#14579                shr        eax,cl                                                   
//#14580                and        eax,ebx                                                   
//#14581                mov        [edi],eax                                                   
//#14582                add        edi,4                                                   
//#14583                ret                                                           
//#14584                                                                           
//#14585    difbts:        mov        esi,bpnt                                                       
//#14586                mov        ecx,shft                                                   
//#14587                mov        edi,offset tradj                                                   
//#14588                mov        ebx,0xff                                                   
//#14589                mov        edx,bwid                                                   
//#14590                shl        edx,2                                                   
//#14591                call    difsub        //4                                               
//#14592                sub        esi,edx                                                   
//#14593                call    difsub        //1                                               
//#14594                sub        esi,4                                                   
//#14595                call    difsub        //0                                               
//#14596                add        esi,8                                                   
//#14597                call    difsub        //2                                               
//#14598                add        esi,edx                                                   
//#14599                call    difsub        //5                                               
//#14600                sub        esi,8                                                   
//#14601                call    difsub        //3                                               
//#14602                add        esi,edx                                                   
//#14603                call    difsub        //6                                               
//#14604                add        esi,4                                                   
//#14605                call    difsub        //7                                               
//#14606                add        esi,4                                                   
//#14607                call    difsub        //8                                               
//#14608        }                                                                   
//#14609    }                                                                       
//#14610                                                                           
//#14611    void blanklin(unsigned bind){                                                                       
//#14612                                                                           
//#14613        unsigned ind;                                                                   
//#14614                                                                           
//#14615        for(ind=bind;ind<bind+bwid;ind++)                                                                   
//#14616            difmap[ind]=0;                                                               
//#14617    }                                                                       
//#14618                                                                           
//#14619    unsigned trsum(){                                                                       
//#14620                                                                           
//#14621        unsigned rsum,ind;                                                                   
//#14622                                                                           
//#14623        rsum=0;                                                                   
//#14624        for(ind=1;ind<9;ind++)                                                                   
//#14625    //        rsum+=abs(tradj[ind]-tradj[0]);                                                               
//#14626            rsum += abs((int)(tradj[ind] - tradj[0])); // xiaoguang                                                                       
//#14627        return rsum;                                                                   
//#14628    }                                                                       
//#14629                                                                           
//#14630    void trdif(){                                                                       
//#14631                                                                           
//#14632        unsigned    ind,ine,inf,bpnt,rsum,rmax,rmin;                                                               
//#14633        double        rat;                                                           
//#14634                                                                           
//#14635        if(!*bnam){                                                                   
//#14636                                                                           
//#14637            tabmsg(IDS_MAPLOD);                                                               
//#14638            return;                                                               
//#14639        }                                                                   
//#14640        rstMap(TRSET);                                                                   
//#14641        rstMap(HIDMAP);                                                                   
//#14642        untrace();                                                                   
//#14643        difmap=(unsigned*)bseq;                                                                   
//#14644        rmax=0;                                                                   
//#14645        rmin=0xffffffff;                                                                   
//#14646        if(!chkMap(WASTRAC))                                                                   
//#14647            getrmap();                                                               
//#14648        ind=0;                                                                   
//#14649        for(ind=0;ind<3;ind++){                                                                   
//#14650                                                                           
//#14651            blanklin(0);                                                               
//#14652            for(ine=1;ine<(unsigned)bhi-1;ine++){                                                               
//#14653                                                                           
//#14654                bpnt=ine*bwid;                                                           
//#14655                difmap[bpnt++]=0;                                                           
//#14656                for(inf=1;inf<bwid-1;inf++){                                                           
//#14657                                                                           
//#14658                    difbits(trshft[ind],&tracbits[bpnt]);                                                       
//#14659                    rsum=difmap[bpnt]=trsum();                                                       
//#14660                    bpnt++;                                                       
//#14661                    if(rsum>rmax)                                                       
//#14662                        rmax=rsum;                                                   
//#14663                    if(rsum<rmin)                                                       
//#14664                        rmin=rsum;                                                   
//#14665                }                                                           
//#14666                difmap[bpnt++]=0;                                                           
//#14667            }                                                               
//#14668            blanklin(bpnt);                                                               
//#14669            rat=(double)255/(rmax-rmin);                                                               
//#14670            for(ine=0;ine<bwid*bhi;ine++){                                                               
//#14671                                                                           
//#14672                tracbits[ine]&=trmsks[ind];                                                           
//#14673                if(difmap[ine]){                                                           
//#14674                                                                           
//#14675                    inf=(difmap[ine]-rmin)*rat;                                                       
//#14676                    tracbits[ine]|=inf<<trshft[ind];                                                       
//#14677                }                                                           
//#14678            }                                                               
//#14679        }                                                                   
//#14680        BitBlt(bitdc,0,0,bwid,bhi,tracedc,0,0,SRCCOPY);                                                                   
//#14681        setMap(WASDIF);                                                                   
//#14682        setMap(RESTCH);                                                                   
//#14683        tracwnd();                                                                   
//#14684    }                                                                       
//#14685                                                                           
//#14686    void delstch(){                                                                       
//#14687                                                                           
//#14688        savdo();                                                                   
//#14689        hed.stchs=0;                                                                   
//#14690        clpad=0;                                                                   
//#14691        txad=0;                                                                   
//#14692        rstAll();                                                                   
//#14693        clrfills();                                                                   
//#14694        colCnt=0;                                                                   
//#14695        butxt(HNUM,"");                                                                   
//#14696        butxt(HTOT,"");                                                                   
//#14697        setMap(RESTCH);                                                                   
//#14698    }                                                                       
//#14699                                                                           
//#14700    void chkbit(){                                                                       
//#14701                                                                           
//#14702        if(*bnam&&(chkMap(WASDIF)||chkMap(WASDSEL)||chkMap(WASBLAK))){                                                                   
//#14703                                                                           
//#14704            setMap(WASESC);                                                               
//#14705            bfil();                                                               
//#14706        }                                                                   
//#14707    }                                                                       
//#14708                                                                           
//#14709    void trcnum(unsigned shft,COLORREF col,unsigned ind){                                                                       
//#14710                                                                           
//#14711        unsigned len;                                                                   
//#14712        unsigned nwid;                                                                   
//#14713                                                                           
//#14714        col>>=shft;                                                                   
//#14715        col&=0xff;                                                                   
//#14716        itoa(col,trbuf,10);                                                                   
//#14717        len=strlen(trbuf);                                                                   
//#14718        nwid=numwid*(3-len)+1;                                                                   
//#14719        SetBkColor(ds->hDC,trgb[ind]);                                                                   
//#14720        TextOut(ds->hDC,nwid,1,trbuf,strlen(trbuf));                                                                   
//#14721    }                                                                       
//#14722                                                                           
//#14723    void upnum(unsigned ind){                                                                       
//#14724                                                                           
//#14725        trcnum(trshft[ind],curef,ind);                                                                   
//#14726    }                                                                       
//#14727                                                                           
//#14728    void dwnum(unsigned ind){                                                                       
//#14729                                                                           
//#14730        trcnum(trshft[ind],cdref,ind);                                                                   
//#14731    }                                                                       
//#14732                                                                           
//#14733    void ritrcol(COLORREF* tref,unsigned num){                                                                       
//#14734                                                                           
//#14735        *tref&=trmsks[colm];                                                                   
//#14736        num&=0xff;                                                                   
//#14737        *tref|=(num<<trshft[colm]);                                                                   
//#14738    }                                                                       
//#14739                                                                           
//#14740    void dutrnum0(unsigned num){                                                                       
//#14741                                                                           
//#14742        rstMap(NUMIN);                                                                   
//#14743        rstMap(TRNIN0);                                                                   
//#14744        if(chkMap(TRNUP)){                                                                   
//#14745                                                                           
//#14746            ritrcol(&curef,num);                                                               
//#14747            uref=curef^0xffffff;                                                               
//#14748            redraw(htrup[colm]);                                                               
//#14749        }                                                                   
//#14750        else{                                                                   
//#14751                                                                           
//#14752            ritrcol(&cdref,num);                                                               
//#14753            dref=cdref^0xffffff;                                                               
//#14754            redraw(htrdwn[colm]);                                                               
//#14755        }                                                                   
//#14756        redraw(hctrc[colm]);                                                                   
//#14757        DestroyWindow(htrnum);                                                                   
//#14758        setMap(WASTRCOL);                                                                   
//#14759        trace();                                                                   
//#14760    }                                                                       
//#14761                                                                           
//#14762    void dutrnum1(){                                                                       
//#14763                                                                           
//#14764        double    tdub;                                                               
//#14765                                                                           
//#14766        DestroyWindow(hgNum);                                                                   
//#14767        rstMap(NUMIN);                                                                   
//#14768        rstMap(TRNIN1);                                                                   
//#14769        tdub=atof(msgbuf);                                                                   
//#14770        sprintf(msgbuf,"%.2f",tdub);                                                                   
//#14771        if(tdub>9)                                                                   
//#14772            tdub=9;                                                               
//#14773        if(chkMap(TRNUP)){                                                                   
//#14774                                                                           
//#14775            ini.trlen=tdub*PFGRAN;                                                               
//#14776            trcstpnum();                                                               
//#14777        }                                                                   
//#14778        else{                                                                   
//#14779                                                                           
//#14780            ini.trcrat=1+pow(0.1,tdub);                                                               
//#14781            trcratnum();                                                               
//#14782        }                                                                   
//#14783    }                                                                       
//#14784                                                                           
//#14785    void trcsel(){                                                                       
//#14786                                                                           
//#14787        unsigned ind,max,xind;                                                                   
//#14788                                                                           
//#14789        if(*bnam){                                                                   
//#14790                                                                           
//#14791            setMap(WASTRCOL);                                                               
//#14792            setMap(TRCRED);                                                               
//#14793            setMap(TRCBLU);                                                               
//#14794            setMap(TRCGRN);                                                               
//#14795            dref=0xffffff;                                                               
//#14796            uref=0;                                                               
//#14797            trace();                                                               
//#14798            rstMap(HIDMAP);                                                               
//#14799            rstMap(TRSET);                                                               
//#14800            for(ind=0;ind<bwid*bhi;ind++){                                                               
//#14801                                                                           
//#14802                trcols(tracbits[ind]);                                                           
//#14803                max=pxcols[0];                                                           
//#14804                xind=2;                                                           
//#14805                if(pxcols[1]>max){                                                           
//#14806                                                                           
//#14807                    max=pxcols[1];                                                       
//#14808                    xind=1;                                                       
//#14809                }                                                           
//#14810                if(pxcols[2]>max)                                                           
//#14811                    xind=0;                                                       
//#14812                tracbits[ind]&=trgb[xind];                                                           
//#14813            }                                                               
//#14814            BitBlt(bitdc,0,0,bwid,bhi,tracedc,0,0,SRCCOPY);                                                               
//#14815            setMap(WASDSEL);                                                               
//#14816            setMap(RESTCH);                                                               
//#14817            tracwnd();                                                               
//#14818        }                                                                   
//#14819        else                                                                   
//#14820            tabmsg(IDS_MAPLOD);                                                               
//#14821    }                                                                       
//#14822                                                                           
//#14823    void trinit(){                                                                       
//#14824                                                                           
//#14825        unsigned    ind,ine;                                                               
//#14826        unsigned    hst[3][256];                                                               
//#14827        unsigned*    phst;                                                               
//#14828        unsigned    hi[3];                                                               
//#14829        unsigned    col[3];                                                               
//#14830        COLORREF    tcol;                                                               
//#14831                                                                           
//#14832        if(*bnam){                                                                   
//#14833                                                                           
//#14834            if(!chkMap(TRSET)){                                                               
//#14835                                                                           
//#14836                setMap(TRCRED);                                                           
//#14837                setMap(TRCGRN);                                                           
//#14838                setMap(TRCBLU);                                                           
//#14839                if(!chkMap(WASTRAC))                                                           
//#14840                    getrmap();                                                       
//#14841                if(chkMap(MONOMAP)){                                                           
//#14842                                                                           
//#14843                    tcol=tracbits[0];                                                       
//#14844                    for(ind=0;ind<bwid*bhi;ind++){                                                       
//#14845                                                                           
//#14846                        if(tracbits[ind]!=tcol)                                                   
//#14847                            break;                                               
//#14848                    }                                                       
//#14849                    if(ind<bwid*bhi){                                                       
//#14850                                                                           
//#14851                        trcols(tracbits[ind]);                                                   
//#14852                        hicols[0]=pxcols[0];                                                   
//#14853                        hicols[1]=pxcols[1];                                                   
//#14854                        hicols[2]=pxcols[2];                                                   
//#14855                        trcols(tcol);                                                   
//#14856                        for(ind=0;ind<3;ind++){                                                   
//#14857                                                                           
//#14858                            if(pxcols[ind]>hicols[ind]){                                               
//#14859                                                                           
//#14860                                ine=pxcols[ind];                                           
//#14861                                pxcols[ind]=hicols[ind];                                           
//#14862                                hicols[ind]=ine;                                           
//#14863                            }                                               
//#14864                            col[ind]=((hicols[ind]-pxcols[ind])>>1)+pxcols[ind];                                               
//#14865                        }                                                   
//#14866                    }                                                       
//#14867                }                                                           
//#14868                else{                                                           
//#14869                                                                           
//#14870                    phst=(unsigned*)hst;                                                       
//#14871                    for(ind=0;ind<768;ind++)                                                       
//#14872                        phst[ind]=0;                                                   
//#14873                    for(ind=0;ind<bwid*bhi;ind++){                                                       
//#14874                                                                           
//#14875                        trcols(tracbits[ind]);                                                   
//#14876                        for(ine=0;ine<3;ine++)                                                   
//#14877                            hst[ine][pxcols[ine]]++;                                               
//#14878                    }                                                       
//#14879                    for(ind=0;ind<3;ind++)                                                       
//#14880                        hi[ind]=0;                                                   
//#14881                    for(ind=0;ind<256;ind++){                                                       
//#14882                                                                           
//#14883                        for(ine=0;ine<3;ine++){                                                   
//#14884                                                                           
//#14885                            if(hst[ine][ind]>hi[ine]){                                               
//#14886                                                                           
//#14887                                hi[ine]=hst[ine][ind];                                           
//#14888                                col[ine]=ind;                                           
//#14889                            }                                               
//#14890                        }                                                   
//#14891                    }                                                       
//#14892                }                                                           
//#14893                cdref=0;                                                           
//#14894                for(ind=0;ind<3;ind++){                                                           
//#14895                                                                           
//#14896                    if(col[ind])                                                       
//#14897                        col[ind]--;                                                   
//#14898                    cdref|=col[ind]<<trshft[ind];                                                       
//#14899                }                                                           
//#14900                dref=cdref^0xffffff;                                                           
//#14901                curef=0xffffff;                                                           
//#14902                uref=0;                                                           
//#14903            }                                                               
//#14904            setMap(WASTRCOL);                                                               
//#14905            trace();                                                               
//#14906        }                                                                   
//#14907        else                                                                   
//#14908            tabmsg(IDS_MAPLOD);                                                               
//#14909    }                                                                       
//#14910                                                                           
//#14911    void stch2bit(double px, double py){                                                                       
//#14912                                                                           
//#14913        if(chkMap(LANDSCAP))                                                                   
//#14914            py-=(zum0.y-zumend.y);                                                               
//#14915        bitpnt.x=bsrat.x*px;                                                                   
//#14916        bitpnt.y=(bhi-bsrat.y*py);                                                                   
//#14917    }                                                                       
//#14918                                                                           
//#14919    void pxlin(unsigned strt,unsigned fin){                                                                       
//#14920                                                                           
//#14921        POINT        lin[2];                                                           
//#14922                                                                           
//#14923        stch2bit(flt[strt].x,flt[strt].y);                                                                   
//#14924        lin[0].x=bitpnt.x;                                                                   
//#14925        lin[0].y=bitpnt.y;                                                                   
//#14926        stch2bit(flt[fin].x,flt[fin].y);                                                                   
//#14927        lin[1].x=bitpnt.x;                                                                   
//#14928        lin[1].y=bitpnt.y;                                                                   
//#14929        Polyline(bitdc,lin,2);                                                                   
//#14930        Polyline(tracedc,lin,2);                                                                   
//#14931    }                                                                       
//#14932                                                                           
//#14933    void bfrm(){                                                                       
//#14934                                                                           
//#14935        unsigned ind;                                                                   
//#14936                                                                           
//#14937        if(sids){                                                                   
//#14938                                                                           
//#14939            for(ind=0;ind<(unsigned)sids-1;ind++)                                                               
//#14940                pxlin(ind,ind+1);                                                           
//#14941            if(frmpnt->typ!=LIN)                                                               
//#14942                pxlin(ind,0);                                                           
//#14943        }                                                                   
//#14944    }                                                                       
//#14945                                                                           
//#14946    void blak(){                                                                       
//#14947                                                                           
//#14948        unsigned ind;                                                                   
//#14949                                                                           
//#14950        if(!*bnam){                                                                   
//#14951                                                                           
//#14952            tabmsg(IDS_MAPLOD);                                                               
//#14953            return;                                                               
//#14954        }                                                                   
//#14955        tracwnd();                                                                   
//#14956        if(formpnt){                                                                   
//#14957                                                                           
//#14958            blakpen=CreatePen(PS_SOLID,1,0);                                                               
//#14959            SelectObject(bitdc,blakpen);                                                               
//#14960            SelectObject(tracedc,blakpen);                                                               
//#14961            if(!chkMap(WASTRAC))                                                               
//#14962                getrmap();                                                           
//#14963            for(ind=0;ind<formpnt;ind++){                                                               
//#14964                                                                           
//#14965                fvars(ind);                                                           
//#14966                bfrm();                                                           
//#14967            }                                                               
//#14968            DeleteObject(blakpen);                                                               
//#14969            setMap(WASBLAK);                                                               
//#14970            setMap(RESTCH);                                                               
//#14971        }                                                                   
//#14972        else                                                                   
//#14973            tabmsg(IDS_FRMNO);                                                               
//#14974    }                                                                       
//#14975                                                                           
//#14976    void delmap(){                                                                       
//#14977                                                                           
//#14978        *bnam=0;                                                                   
//#14979        setMap(RESTCH);                                                                   
//#14980    }                                                                       
//#14981                                                                           
//#14982    void closfn(){                                                                       
//#14983                                                                           
//#14984        deltot();                                                                   
//#14985        sprintf(msgbuf,stab[STR_THRED],ini.desnam);                                                                   
//#14986        knotcnt=0;                                                                   
//#14987        *filnam=0;                                                                   
//#14988        *bnam=0;                                                                   
//#14989        deldu();                                                                   
//#14990        clrhbut(3);                                                                   
//#14991        SetWindowText(hWnd,msgbuf);                                                                   
//#14992    }                                                                       
//#14993                                                                           
//#14994    void filclos(){                                                                       
//#14995                                                                           
//#14996        if(savcmp())                                                                   
//#14997            closfn();                                                               
//#14998        else{                                                                   
//#14999                                                                           
//#15000            setMap(FCLOS);                                                               
//#15001            savdisc();                                                               
//#15002        }                                                                   
//#15003    }                                                                       
//#15004                                                                           
//#15005    void frmpos(float dx,float dy){                                                                       
//#15006                                                                           
//#15007        unsigned ine;                                                                   
//#15008                                                                           
//#15009        for(ine=0;ine<frmpnt->sids;ine++){                                                                   
//#15010                                                                           
//#15011            frmpnt->flt[ine].x+=dx;                                                               
//#15012            frmpnt->flt[ine].y+=dy;                                                               
//#15013        }                                                                   
//#15014        frmpnt->rct.bottom+=dy;                                                                   
//#15015        frmpnt->rct.top+=dy;                                                                   
//#15016        frmpnt->rct.left+=dx;                                                                   
//#15017        frmpnt->rct.right+=dx;                                                                   
//#15018    }                                                                       
//#15019                                                                           
//#15020    void nudgfn(float dx,float dy){                                                                       
//#15021                                                                           
//#15022        unsigned    ind,rcnt;                                                               
//#15023        POINT        pix;                                                           
//#15024                                                                           
//#15025        if(chkMap(BIGBOX)||fselpnt||chkMap(FORMSEL)||chkMap(GRPSEL)||chkMap(SELBOX))                                                                   
//#15026            savdo();                                                               
//#15027        if(chkMap(BIGBOX)){                                                                   
//#15028                                                                           
//#15029            for(ind=0;ind<formpnt;ind++){                                                               
//#15030                                                                           
//#15031                frmpnt=&formlst[ind];                                                           
//#15032                frmpos(dx,dy);                                                           
//#15033            }                                                               
//#15034            for(ind=0;ind<hed.stchs;ind++){                                                               
//#15035                                                                           
//#15036                stchs[ind].x+=dx;                                                           
//#15037                stchs[ind].y+=dy;                                                           
//#15038            }                                                               
//#15039            rctal.bottom+=dy;                                                               
//#15040            rctal.top+=dy;                                                               
//#15041            rctal.left+=dx;                                                               
//#15042            rctal.right+=dx;                                                               
//#15043            stchrct2px(rctal,&bigrct);                                                               
//#15044            setMap(RESTCH);                                                               
//#15045            return;                                                               
//#15046        }                                                                   
//#15047        if(fselpnt){                                                                   
//#15048                                                                           
//#15049            rcnt=(formpnt>>5)+1;                                                               
//#15050            clRmap(rcnt);                                                               
//#15051            for(ind=0;ind<fselpnt;ind++)                                                               
//#15052                setr(selist[ind]);                                                           
//#15053            for(ind=0;ind<hed.stchs;ind++){                                                               
//#15054                                                                           
//#15055                if(chkr((stchs[ind].at&FRMSK)>>FRMSHFT)){                                                           
//#15056                                                                           
//#15057                    stchs[ind].x+=dx;                                                       
//#15058                    stchs[ind].y+=dy;                                                       
//#15059                }                                                           
//#15060            }                                                               
//#15061            for(ind=0;ind<fselpnt;ind++){                                                               
//#15062                                                                           
//#15063                frmpnt=&formlst[selist[ind]];                                                           
//#15064                frmpos(dx,dy);                                                           
//#15065            }                                                               
//#15066            setMap(RESTCH);                                                               
//#15067            return;                                                               
//#15068        }                                                                   
//#15069        if(chkMap(FORMSEL)){                                                                   
//#15070                                                                           
//#15071            frmpnt=&formlst[clofind];                                                               
//#15072            frmpos(dx,dy);                                                               
//#15073            if(frmpnt->ftyp||frmpnt->etyp){                                                               
//#15074                                                                           
//#15075                for(ind=0;ind<hed.stchs;ind++){                                                           
//#15076                                                                           
//#15077                    if((stchs[ind].at&FRMSK)>>FRMSHFT==clofind){                                                       
//#15078                                                                           
//#15079                        stchs[ind].x+=dx;                                                   
//#15080                        stchs[ind].y+=dy;                                                   
//#15081                    }                                                       
//#15082                }                                                           
//#15083            }                                                               
//#15084            setMap(RESTCH);                                                               
//#15085            return;                                                               
//#15086        }                                                                   
//#15087        if(chkMap(GRPSEL)){                                                                   
//#15088                                                                           
//#15089            rngadj();                                                               
//#15090            for(ind=gpnt0;ind<=gpnt1;ind++){                                                               
//#15091                                                                           
//#15092                stchs[ind].x+=dx;                                                           
//#15093                stchs[ind].y+=dy;                                                           
//#15094            }                                                               
//#15095            grpAdj();                                                               
//#15096            setMap(RESTCH);                                                               
//#15097            return;                                                               
//#15098        }                                                                   
//#15099        if(chkMap(SELBOX)){                                                                   
//#15100                                                                           
//#15101            stchs[cloInd].x+=dx;                                                               
//#15102            stchs[cloInd].y+=dy;                                                               
//#15103            setMap(RESTCH);                                                               
//#15104            return;                                                               
//#15105        }                                                                   
//#15106        pix.x=pix.y=0;                                                                   
//#15107        if(dx){                                                                   
//#15108                                                                           
//#15109            if(dx>0)                                                               
//#15110                pix.x=ini.nudgpix;                                                           
//#15111            else                                                               
//#15112                pix.x=-ini.nudgpix;                                                           
//#15113        }                                                                   
//#15114        if(dy){                                                                   
//#15115                                                                           
//#15116            if(dy>0)                                                               
//#15117                pix.y=-ini.nudgpix;                                                           
//#15118            else                                                               
//#15119                pix.y=+ini.nudgpix;                                                           
//#15120        }                                                                   
//#15121        mouse_event(MOUSEEVENTF_MOVE,pix.x,pix.y,0,0);                                                                   
//#15122    }                                                                       
//#15123                                                                           
//#15124    void pixmsg(unsigned cod,unsigned pix){                                                                       
//#15125                                                                           
//#15126        sprintf(msgbuf,stab[cod],pix);                                                                   
//#15127        shoMsg(msgbuf);                                                                   
//#15128    }                                                                       
//#15129                                                                           
//#15130    void getnpix(){                                                                       
//#15131                                                                           
//#15132        pixmsg(STR_NUDG,ini.nudgpix);                                                                   
//#15133        setMap(NUMIN);                                                                   
//#15134        setMap(PIXIN);                                                                   
//#15135        numWnd();                                                                   
//#15136    }                                                                       
//#15137                                                                           
//#15138    void getstpix(){                                                                       
//#15139                                                                           
//#15140        pixmsg(STR_STCHP,ini.stchpix);                                                                   
//#15141        setMap(NUMIN);                                                                   
//#15142        setMap(STPXIN);                                                                   
//#15143        numWnd();                                                                   
//#15144    }                                                                       
//#15145                                                                           
//#15146    void getfrmpix(){                                                                       
//#15147                                                                           
//#15148        pixmsg(STR_FRMP,ini.frmpix);                                                                   
//#15149        setMap(NUMIN);                                                                   
//#15150        setMap(FRMPXIN);                                                                   
//#15151        numWnd();                                                                   
//#15152    }                                                                       
//#15153                                                                           
//#15154    void getfrmbox(){                                                                       
//#15155                                                                           
//#15156        pixmsg(STR_FRMBOX,ini.frmbpix);                                                                   
//#15157        setMap(NUMIN);                                                                   
//#15158        setMap(FRMBOXIN);                                                                   
//#15159        numWnd();                                                                   
//#15160    }                                                                       
//#15161                                                                           
//#15162    void bakmrk(){                                                                       
//#15163                                                                           
//#15164        FLPNT    tpnt;                                                               
//#15165                                                                           
//#15166        if(chkMap(WASMRK)){                                                                   
//#15167                                                                           
//#15168            if(mrkpnt.x>ini.hupx)                                                               
//#15169                mrkpnt.x=ini.hupy/2;                                                           
//#15170            if(mrkpnt.y>ini.hupy)                                                               
//#15171                mrkpnt.y=ini.hupy/2;                                                           
//#15172            dumrk(mrkpnt.x,mrkpnt.y);                                                               
//#15173            tpnt.x=mrkpnt.x;                                                               
//#15174            tpnt.y=mrkpnt.y;                                                               
//#15175            shft(tpnt);                                                               
//#15176            setMap(RESTCH);                                                               
//#15177        }                                                                   
//#15178        else                                                                   
//#15179            tabmsg(IDS_MRK);                                                               
//#15180    }                                                                       
//#15181                                                                           
//#15182    void nuscol(unsigned ind){                                                                       
//#15183                                                                           
//#15184        uPen[ind]=nuPen(uPen[ind],1,useCol[ind]);                                                                   
//#15185        hbrUseCol[ind]=nuBrush(hbrUseCol[ind],useCol[ind]);                                                                   
//#15186        redraw(hCol[ind]);                                                                   
//#15187    }                                                                       
//#15188                                                                           
//#15189    void movchk(){                                                                       
//#15190                                                                           
//#15191        unsigned    ind,col,key,swtch;                                                               
//#15192        FRMHED*        pfrm;                                                           
//#15193                                                                           
//#15194        if(msg.wParam&MK_LBUTTON){                                                                   
//#15195                                                                           
//#15196            if(!setMap(WASMOV)){                                                               
//#15197                                                                           
//#15198                if(chkMsgs(msg.pt,hDef[0],hDef[15])){                                                           
//#15199                                                                           
//#15200                    wcol=vind&0xf;                                                       
//#15201                    setMap(WASCOL);                                                       
//#15202                }                                                           
//#15203            }                                                               
//#15204        }                                                                   
//#15205        else{                                                                   
//#15206                                                                           
//#15207            if(rstMap(WASMOV)&&rstMap(WASCOL)){                                                               
//#15208                                                                           
//#15209                if(chkMsgs(msg.pt,hDef[0],hDef[15])){                                                           
//#15210                                                                           
//#15211                    key=GetKeyState(VK_SHIFT)&0X8000;                                                       
//#15212                    swtch=GetKeyState(VK_CONTROL)&0X8000;                                                       
//#15213                    for(ind=0;ind<hed.stchs;ind++){                                                       
//#15214                                                                           
//#15215                        col=stchs[ind].at&COLMSK;                                                   
//#15216                        if(col==vind){                                                   
//#15217                                                                           
//#15218                            stchs[ind].at&=NCOLMSK;                                               
//#15219                            stchs[ind].at|=wcol;                                               
//#15220                        }                                                   
//#15221                        else{                                                   
//#15222                                                                           
//#15223                            if(!key&&col==wcol){                                               
//#15224                                                                           
//#15225                                stchs[ind].at&=NCOLMSK;                                           
//#15226                                stchs[ind].at|=vind;
//#15227                            }                                               
//#15228                        }                                                   
//#15229                    }                                                       
//#15230                    for(ind=0;ind<formpnt;ind++){                                                       
//#15231                                                                           
//#15232                        pfrm=&formlst[ind];                                                   
//#15233                        if(pfrm->ftyp){                                                   
//#15234                                                                           
//#15235                            if(pfrm->fcol==vind)                                               
//#15236                                pfrm->fcol=wcol;                                           
//#15237                            else{                                               
//#15238                                                                           
//#15239                                if(!key&&pfrm->fcol==wcol)                                           
//#15240                                    pfrm->fcol=vind;                                       
//#15241                            }                                               
//#15242                            if(pfrm->dhx.fth.fthcol==vind)                                               
//#15243                                pfrm->dhx.fth.fthcol=wcol;                                           
//#15244                            else{                                               
//#15245                                                                           
//#15246                                if(!key&&pfrm->dhx.fth.fthcol==wcol)                                           
//#15247                                    pfrm->dhx.fth.fthcol=vind;                                       
//#15248                            }                                               
//#15249                        }                                                   
//#15250                        if(pfrm->etyp){
//#15251                                                                           
//#15252                            if(pfrm->bcol==vind)                                               
//#15253                                pfrm->bcol=wcol;                                           
//#15254                            else{                                               
//#15255
//#15256                                if(!key&&pfrm->bcol==wcol)                                           
//#15257                                    pfrm->bcol=vind;                                       
//#15258                            }                                               
//#15259                        }                                                   
//#15260                    }                                                       
//#15261                    if(!swtch){                                                       
//#15262                                                                           
//#15263                        ind=useCol[vind];                                                   
//#15264                        useCol[vind]=useCol[wcol];                                                   
//#15265                        if(!key){                                                   
//#15266                                                                           
//#15267                            useCol[wcol]=ind;                                               
//#15268                            nuscol(wcol);                                               
//#15269                        }                                                   
//#15270                        nuscol(vind);                                                   
//#15271                    }                                                       
//#15272                    coltab();                                                       
//#15273                    setMap(RESTCH);                                                       
//#15274                }                                                           
//#15275            }                                                               
//#15276        }                                                                   
//#15277    }                                                                       
//#15278                                                                           
//#15279    void inscol(){                                                                       
//#15280                                                                           
//#15281        unsigned    ind,dcol,col;                                                               
//#15282        FRMHED*        tfrm;                                                           
//#15283                                                                           
//#15284        *rmap=0;
//#15285        if(chkMsgs(msg.pt,hDef[0],hCol[15])){                                                                   
//#15286                                                                           
//#15287            vind&=COLMSK;                                                               
//#15288            for(ind=0;ind<hed.stchs;ind++)                                                               
//#15289                setr(stchs[ind].at&COLMSK);                                                           
//#15290            if(*rmap==COLSMSK)                                                               
//#15291                tabmsg(IDS_COLAL);                                                           
//#15292            else{                                                               
//#15293                                                                           
//#15294                dcol=15;                                                           
//#15295                while(chkr(dcol))                                                           
//#15296                    dcol--;                                                       
//#15297                for(ind=0;ind<hed.stchs;ind++){                                                           
//#15298                                                                           
//#15299                    col=stchs[ind].at&COLMSK;                                                       
//#15300                    if(col>=vind&&col<dcol){                                                       
//#15301                                                                           
//#15302                        stchs[ind].at&=NCOLMSK;                                                   
//#15303                        stchs[ind].at|=col+1;                                                   
//#15304                    }                                                       
//#15305                }                                                           
//#15306                for(ind=0;ind<formpnt;ind++){                                                           
//#15307                                                                           
//#15308                    tfrm=&formlst[ind];                                                       
//#15309                    if(tfrm->ftyp){                                                       
//#15310                                                                           
//#15311                        if(tfrm->fcol>=vind&&tfrm->fcol<dcol)                                                   
//#15312                            tfrm->fcol++;                                               
//#15313                        if(tfrm->dhx.fth.fthcol>=vind&&tfrm->dhx.fth.fthcol<dcol)
//#15314                            tfrm->dhx.fth.fthcol++;                                               
//#15315                    }                                                       
//#15316                    if(tfrm->etyp){                                                       
//#15317                                                                           
//#15318                        if(tfrm->bcol>=vind&&tfrm->bcol<dcol)
//#15319                            tfrm->bcol++;                                               
//#15320                    }                                                       
//#15321                }                                                           
//#15322                for(ind=dcol;ind>vind;ind--){                                                           
//#15323                                                                           
//#15324                    useCol[ind]=useCol[ind-1];                                                       
//#15325                    nuscol(ind);                                                       
//#15326                }                                                           
//#15327                coltab();                                                           
//#15328                setMap(RESTCH);                                                           
//#15329            }                                                               
//#15330        }                                                                   
//#15331    }                                                                       
//#15332                                                                           
//#15333    BOOL usedcol(){                                                                       
//#15334                                                                           
//#15335        unsigned ind;                                                                   
//#15336                                                                           
//#15337        for(ind=0;ind<hed.stchs;ind++){                                                                   
//#15338                                                                           
//#15339            if((stchs[ind].at&COLMSK)==vind)                                                               
//#15340                return 1;                                                           
//#15341        }                                                                   
//#15342        return 0;
//#15343    }                                                                       
//#15344                                                                           
//#15345    void delcol(){                                                                       
//#15346                                                                           
//#15347        unsigned    ind,col;                                                               
//#15348        FRMHED*        tfrm;                                                           
//#15349                                                                           
//#15350        if(chkMsgs(msg.pt,hDef[0],hCol[15])){                                                                   
//#15351                                                                           
//#15352            vind&=0xf;
//#15353            if(usedcol())                                                               
//#15354                tabmsg(IDS_COLU);                                                           
//#15355            else{                                                               
//#15356                                                                           
//#15357                for(ind=0;ind<hed.stchs;ind++){                                                           
//#15358                                                                           
//#15359                    col=stchs[ind].at&COLMSK;                                                       
//#15360                    if(col>vind&&col){                                                       
//#15361                                                                           
//#15362                        stchs[ind].at&=NCOLMSK;                                                   
//#15363                        stchs[ind].at|=col-1;                                                   
//#15364                    }                                                       
//#15365                }                                                           
//#15366                for(ind=0;ind<formpnt;ind++){                                                           
//#15367                                                                           
//#15368                    tfrm=&formlst[ind];                                                       
//#15369                    if(tfrm->ftyp){                                                       
//#15370                                                                           
//#15371                        if(tfrm->fcol>vind)
//#15372                            tfrm->fcol--;                                               
//#15373                        if(tfrm->dhx.fth.fthcol>vind)                                                   
//#15374                            tfrm->dhx.fth.fthcol--;                                               
//#15375                    }                                                       
//#15376                    if(tfrm->etyp){                                                       
//#15377                                                                           
//#15378                        if(tfrm->bcol>vind)                                                   
//#15379                            tfrm->bcol--;                                               
//#15380                    }                                                       
//#15381                }                                                           
//#15382                for(ind=vind;ind<15;ind++){                                                           
//#15383                                                                           
//#15384                    useCol[ind]=useCol[ind+1];                                                       
//#15385                    nuscol(ind);                                                       
//#15386                }
//#15387                coltab();                                                           
//#15388                setMap(RESTCH);                                                           
//#15389            }                                                               
//#15390        }                                                                   
//#15391    }                                                                       
//#15392                                                                           
//#15393    void set1knot(){                                                                       
//#15394                                                                           
//#15395        unsigned src,dst;                                                                   
//#15396                                                                           
//#15397        if(hed.stchs&&chkMap(SELBOX)){                                                                   
//#15398                                                                           
//#15399            savdo();                                                               
//#15400            if(cloInd==(unsigned)hed.stchs-1){
//#15401                                                                           
//#15402                setMap(FILDIR);                                                           
//#15403                opnt=cloInd+1;                                                           
//#15404                endknt(cloInd);                                                           
//#15405            }                                                               
//#15406            else{                                                               
//#15407                                                                           
//#15408                src=hed.stchs-1;                                                           
//#15409                dst=hed.stchs+4;                                                           
//#15410                while(src&&src>=cloInd)                                                           
//#15411                    mvstch(dst--,src--);                                                       
//#15412                opnt=cloInd+1;                                                           
//#15413                strtknt(cloInd);                                                           
//#15414            }                                                               
//#15415            hed.stchs+=5;                                                               
//#15416            coltab();                                                               
//#15417            setMap(RESTCH);                                                               
//#15418        }                                                                   
//#15419        else{                                                                   
//#15420
//#15421            msgstr(IDS_NOSTCHSEL);                                                               
//#15422            shoMsg(msgbuf);                                                               
//#15423        }                                                                   
//#15424    }                                                                       
//#15425                                                                           
//#15426    void selfrm0(){                                                                       
//#15427                                                                           
//#15428        rstMap(GRPSEL);                                                                   
//#15429        if(rstMap(FORMSEL)){
//#15430                                                                           
//#15431            setMap(FRMPSEL);                                                               
//#15432            clofine=0;                                                               
//#15433        }                                                                   
//#15434        setMap(RESTCH);                                                                   
//#15435    }                                                                       
//#15436                                                                           
//#15437    void selfrmx(){                                                                       
//#15438                                                                           
//#15439        rstMap(GRPSEL);                                                                   
//#15440        if(rstMap(FORMSEL)){                                                                   
//#15441                                                                           
//#15442            setMap(FRMPSEL);                                                               
//#15443            clofine=formlst[clofind].sids-1;                                                               
//#15444        }                                                                   
//#15445        setMap(RESTCH);                                                                   
//#15446    }                                                                       
//#15447                                                                           
//#15448    void setpclp(){                                                                       
//#15449                                                                           
//#15450        POINT        tof;                                                           
//#15451        POINT        tpnt;                                                           
//#15452        unsigned    ind,ine;                                                               
//#15453                                                                           
//#15454        sfCor2px(iseq[0],&tpnt);
//#15455        fplin[0].x=tpnt.x;                                                                   
//#15456        fplin[0].y=tpnt.y;                                                                   
//#15457        sfCor2px(iseq[1],&tpnt);                                                                   
//#15458        tof.x=msg.pt.x-stOrg.x-tpnt.x;
//#15459        tof.y=msg.pt.y-stOrg.y-tpnt.y;                                                                   
//#15460        for(ind=0;ind<opnt-2;ind++){                                                                   
//#15461                                                                           
//#15462            ine=ind+1;                                                               
//#15463            sfCor2px(iseq[ine],&tpnt);                                                               
//#15464            fplin[ine].x=tpnt.x+tof.x;                                                               
//#15465            fplin[ine].y=tpnt.y+tof.y;                                                               
//#15466        }                                                                   
//#15467        ind++;                                                                   
//#15468        sfCor2px(iseq[ind],&tpnt);                                                                   
//#15469        fplin[ind].x=tpnt.x;                                                                   
//#15470        fplin[ind].y=tpnt.y;                                                                   
//#15471    }                                                                       
//#15472                                                                           
//#15473    void dupclp(){                                                                       
//#15474                                                                           
//#15475        SetROP2(rsdc,R2_XORPEN);                                                                   
//#15476        SelectObject(rsdc,fPen);                                                                   
//#15477        Polyline(rsdc,fplin,opnt);                                                                   
//#15478        SetROP2(rsdc,R2_COPYPEN);                                                                   
//#15479    }                                                                       
//#15480                                                                           
//#15481    void unpclp(){                                                                       
//#15482                                                                           
//#15483        if(rstMap(SHOP))                                                                   
//#15484            dupclp();                                                               
//#15485    }                                                                       
//#15486                                                                           
//#15487    void fixpclp(){
//#15488
//#15489        POINT        tpnt;                                                           
//#15490        FLPNT        pof;                                                           
//#15491        unsigned    ind,ine,cnt;                                                               
//#15492                                                                           
//#15493        tpnt.x=msg.pt.x+fmovdif.x;                                                                   
//#15494        tpnt.y=msg.pt.y+fmovdif.y;                                                                   
//#15495        pxCor2stch(tpnt);                                                                   
//#15496        pof.x=sPnt.x-iseq[1].x;                                                                   
//#15497        pof.y=sPnt.y-iseq[1].y;                                                                   
//#15498        ine=nxt(clofine);                                                                   
//#15499        cnt=opnt-2;                                                                   
//#15500        fltspac(&flt[ine],cnt);
//#15501        for(ind=1;ind<opnt-1;ind++){                                                                   
//#15502                                                                           
//#15503            flt[ine].x=iseq[ind].x+pof.x;                                                               
//#15504            flt[ine].y=iseq[ind].y+pof.y;                                                               
//#15505            ine++;                                                               
//#15506        }                                                                   
//#15507        frmpnt->sids+=cnt;                                                                   
//#15508        refil();                                                                   
//#15509        coltab();                                                                   
//#15510        setMap(RESTCH);                                                                   
//#15511    }                                                                       
//#15512                                                                           
//#15513    BOOL sidclp(){                                                                       
//#15514                                                                           
//#15515        fvars(clofind);                                                                   
//#15516        if(OpenClipboard(hWnd)){
//#15517                                                                           
//#15518            hClip=RegisterClipboardFormat(pcdClip);                                                               
//#15519            hClpMem=GetClipboardData(hClip);                                                               
//#15520            if(hClpMem){                                                               
//#15521                                                                           
//#15522                redclp();
//#15523                CloseClipboard();                                                           
//#15524                return 1;                                                           
//#15525            }                                                               
//#15526        }                                                                   
//#15527        CloseClipboard();                                                                   
//#15528        return 0;                                                                   
//#15529    }                                                                       
//#15530                                                                           
//#15531    void selfpnt(){                                                                       
//#15532                                                                           
//#15533        rstMap(FORMSEL);                                                                   
//#15534        setMap(FRMPSEL);
//#15535        rstMap(FPSEL);                                                                   
//#15536        rstMap(SELBOX);                                                                   
//#15537        pselrng.strt=clofine;                                                                   
//#15538        pselrng.frm=clofind;                                                                   
//#15539        ritfcor(&formlst[clofind].flt[clofine]);                                                                   
//#15540        setMap(RESTCH);                                                                   
//#15541    }                                                                       
//#15542                                                                           
//#15543    unsigned chkMsg(){                                                                       
//#15544                                                                           
//#15545        unsigned        cod,dst;
//#15546        unsigned        ine,inf;                                                           
//#15547        long            ind;                                                       
//#15548        long            tlng;                                                       
//#15549        TCHAR            cmap[]={'3','4','6'};                                                       
//#15550        TCHAR            buf[20];                                                       
//#15551        double            tdub;                                                       
//#15552        FLPNT            nusiz;                                                       
//#15553        FLPNT            padj;                                                       
//#15554        RECT            trct;                                                       
//#15555        SATCON*            sac;                                                       
//#15556        FLPNT*            clp;
//#15557        POINT            tpnt;
//#15558        FRMHED*            tfrm;
//#15559        FLRCT            tbig;
//#15560        unsigned char*    pchr;
//#15561        TXPNT*            ptx;
//#15562        TXPNT*            pts;
//#15563
procedure TfrmMain.FormMouseMove(Sender: TObject; Shift: TShiftState; X,
  Y: Integer);
begin


//#15564        if(msg.message==WM_MOUSEMOVE){
//#15565
//#15566            if(chkMap(TXTMOV))
//#15567            {
//#15568                txtrmov();
//#15569                return 1;
//#15570            }
//#15571            movchk();
//#15572            if(msg.pt.x>=sRct.left&&msg.pt.x<=sRct.right
//#15573                &&msg.pt.y>=sRct.top&&msg.pt.y<=sRct.bottom){
//#15574
//#15575                if(GetKeyState(VK_SHIFT)&0x8000)
//#15576                {
//#15577                    mvshft();
//#15578                    return 1;
//#15579                }
//#15580                if(GetKeyState(VK_SHIFT)&0x8000&&px2stch())
//#15581                    ritfcor(&sPnt);
//#15582                if(*map&(PRFACTB|FORMINB|POLIMOVB)||hfdat){
//#15583
//#15584                    SetCursor(hAr);
//#15585                    goto gotcur;
//#15586                }
//#15587                if(!chkMap(INIT)){
//#15588
//#15589                    if(chku(NEDOF))
//#15590                        SetCursor(hCros);
//#15591                    else
//#15592                        SetCursor(hnedu);
//#15593                    goto gotcur;                                                       
//#15594                }                                                           
//#15595                if(chkMap(INSRT)){                                                           
//#15596                                                                           
//#15597                    if(chku(NEDOF))
//#15598                        SetCursor(hCros);
//#15599                    else{                                                       
//#15600                                                                           
//#15601                        if(chkMap(LIN1))                                                   
//#15602                            SetCursor(hnedu);                                               
//#15603                        else{                                                   
//#15604                                                                           
//#15605                            if(stchs[cloInd+1].x>stchs[cloInd].x){                                               
//#15606                                                                           
//#15607                                if(stchs[cloInd+1].y>stchs[cloInd].y)                                           
//#15608                                    SetCursor(hnedlu);                                       
//#15609                                else                                           
//#15610                                    SetCursor(hnedld);                                       
//#15611                            }
//#15612                            else{                                               
//#15613                                                                           
//#15614                                if(stchs[cloInd+1].y>stchs[cloInd].y)                                           
//#15615                                    SetCursor(hnedru);                                       
//#15616                                else                                           
//#15617                                    SetCursor(hnedrd);                                       
//#15618                            }                                               
//#15619                        }
//#15620                    }                                                       
//#15621                    goto gotcur;
//#15622                }                                                           
//#15623                if(*map&(BZUMINB|BOXZUMB|SELPNTB)){                                                           
//#15624                                                                           
//#15625                    SetCursor(hCros);                                                       
//#15626                    goto gotcur;                                                       
//#15627                }
//#15628                if(*map&(SATINB|SATPNTB|INSFRMB)){                                                           
//#15629                                                                           
//#15630                    if(chku(FRMX))                                                       
//#15631                        SetCursor(hCros);
//#15632                    else                                                       
//#15633                        SetCursor(hfrm);                                                   
//#15634                    goto gotcur;                                                       
//#15635                }                                                           
//#15636                if(*map&SATCNKTB)                                                           
//#15637                    SetCursor(hdlin);                                                       
//#15638                else                                                           
//#15639                    SetCursor(hAr);                                                       
//#15640    gotcur:;                                                                       
//#15641                if(chkMap(FPUNCLP)){                                                           
//#15642                                                                           
//#15643                    unpclp();                                                       
//#15644                    setpclp();                                                       
//#15645                    setMap(SHOP);
//#15646                    dupclp();                                                       
//#15647                }                                                           
//#15648                if(chkMap(INSFIL)){                                                           
//#15649                                                                           
//#15650                    unfrm();
//#15651                    tpnt.x=msg.pt.x-stOrg.x;                                                       
//#15652                    tpnt.y=msg.pt.y-stOrg.y;                                                       
//#15653                    insflin(tpnt);
//#15654                    setMap(SHOFRM);                                                       
//#15655                    dufrm();                                                       
//#15656                    return 1;
//#15657                }                                                           
//#15658                if(chkMap(MOVFRMS)){                                                           
//#15659                                                                           
//#15660                    unstrtch();                                                       
//#15661                    sizlin[0].x=sizlin[3].x=sizlin[4].x=msg.pt.x-fmovdif.x-stOrg.x;                                                       
//#15662                    sizlin[1].x=sizlin[2].x=msg.pt.x+bigsiz.x-fmovdif.x-stOrg.x;                                                       
//#15663                    sizlin[0].y=sizlin[1].y=sizlin[4].y=msg.pt.y-fmovdif.y-stOrg.y;                                                       
//#15664                    sizlin[2].y=sizlin[3].y=msg.pt.y+bigsiz.y-fmovdif.y-stOrg.y;                                                       
//#15665                    setMap(SHOSTRTCH);
//#15666                    strtchbox();                                                       
//#15667                    return 1;                                                       
//#15668                }                                                           
//#15669                if(chkMap(POLIMOV)){                                                           
//#15670                                                                           
//#15671                    munfrm();                                                       
//#15672                    setmfrm();                                                       
//#15673                    setMap(SHOFRM);                                                       
//#15674                    mdufrm();                                                       
//#15675                    return 1;                                                       
//#15676                }                                                           
//#15677                if(chkMap(EXPAND)){                                                           
//#15678                                                                           
//#15679                    unstrtch();
//#15680                    nusiz.x=msg.pt.x-stOrg.x;                                                       
//#15681                    nusiz.y=msg.pt.y-stOrg.y;                                                       
//#15682                    ind=(cntrl+2)%4;                                                       
//#15683                    tdub=fabs((double)(nusiz.x-sizlin[ind].x)/(nusiz.y-sizlin[ind].y));                                                       
//#15684                    if(ind&1){                                                       
//#15685
//#15686                        if(tdub<xpct)                                                   
//#15687                            nusiz.x=(sizlin[ind].y-nusiz.y)*xpct+sizlin[ind].x;
//#15688                        else                                                   
//#15689                            nusiz.y=(sizlin[ind].x-nusiz.x)/xpct+sizlin[ind].y;                                               
//#15690                        ind=nxtcrnr(ind);                                                   
//#15691                        sizlin[ind].y=nusiz.y;                                                   
//#15692                        ind=nxtcrnr(ind);                                                   
//#15693                        sizlin[ind].x=nusiz.x;                                                   
//#15694                        sizlin[ind].y=nusiz.y;                                                   
//#15695                        ind=nxtcrnr(ind);                                                   
//#15696                        sizlin[ind].x=nusiz.x;                                                   
//#15697                    }                                                       
//#15698                    else{                                                       
//#15699
//#15700                        if(tdub<xpct)                                                   
//#15701                            nusiz.x=(nusiz.y-sizlin[ind].y)*xpct+sizlin[ind].x;                                               
//#15702                        else                                                   
//#15703                            nusiz.y=(nusiz.x-sizlin[ind].x)/xpct+sizlin[ind].y;                                               
//#15704                        ind=nxtcrnr(ind);                                                   
//#15705                        sizlin[ind].x=nusiz.x;                                                   
//#15706                        ind=nxtcrnr(ind);                                                   
//#15707                        sizlin[ind].x=nusiz.x;                                                   
//#15708                        sizlin[ind].y=nusiz.y;
//#15709                        ind=nxtcrnr(ind);                                                   
//#15710                        sizlin[ind].y=nusiz.y;                                                   
//#15711                    }                                                       
//#15712                    sizlin[4].x=sizlin[0].x;                                                       
//#15713                    sizlin[4].y=sizlin[0].y;
//#15714                    setMap(SHOSTRTCH);
//#15715                    strtchbox();                                                       
//#15716                    return 1;                                                       
//#15717                }                                                           
//#15718                if(chkMap(STRTCH)){                                                           
//#15719                                                                           
//#15720                    unstrtch();                                                       
//#15721                    if(cntrl&1)
//#15722                        tlng=msg.pt.x-stOrg.x;                                                   
//#15723                    else                                                       
//#15724                        tlng=msg.pt.y-stOrg.y;                                                   
//#15725                    dst=(cntrl+2)%4;                                                       
//#15726                    cod=nxtcrnr(dst);                                                       
//#15727                    for(ind=0;ind<4;ind++){                                                       
//#15728                                                                           
//#15729                        if((unsigned)ind!=dst&&(unsigned)ind!=cod){                                                   
//#15730                                                                           
//#15731                            if(cntrl&1)                                               
//#15732                                sizlin[ind].x=tlng;                                           
//#15733                            else
//#15734                                sizlin[ind].y=tlng;                                           
//#15735                        }                                                   
//#15736                    }                                                       
//#15737                    sizlin[4].x=sizlin[0].x;
//#15738                    sizlin[4].y=sizlin[0].y;                                                       
//#15739                    setMap(SHOSTRTCH);                                                       
//#15740                    strtchbox();                                                       
//#15741                    return 1;                                                       
//#15742                }                                                           
//#15743                if(chkMap(INSFRM)){
//#15744                                                                           
//#15745                    uninsf();                                                       
//#15746                    inlin[1].x=msg.pt.x-stOrg.x;                                                       
//#15747                    inlin[1].y=msg.pt.y-stOrg.y;
//#15748                    setMap(SHOINSF);                                                       
//#15749                    duinsf();                                                       
//#15750                    return 1;                                                       
//#15751                }                                                           
//#15752                if(chkMap(FUNCLP)){                                                           
//#15753                                                                           
//#15754                    unfrm();                                                       
//#15755                    setmfrm();
//#15756                    setMap(SHOFRM);                                                       
//#15757                    dufrm();                                                       
//#15758                    return 1;                                                       
//#15759                }                                                           
//#15760                if(chkMap(SATCNKT)){                                                           
//#15761                                                                           
//#15762                    drwcon();                                                       
//#15763                    return 1;                                                       
//#15764                }                                                           
//#15765                if(chkMap(SATPNT)){                                                           
//#15766
//#15767                    drwsat();
//#15768                    return 1;                                                       
//#15769                }                                                           
//#15770                if(chkMap(FRMOV)){                                                           
//#15771                                                                           
//#15772                    munfrm();
//#15773                    setmfrm();                                                       
//#15774                    setMap(SHOFRM);                                                       
//#15775                    mdufrm();                                                       
//#15776                    return 1;                                                       
//#15777                }                                                           
//#15778                if(chkMap(FRMPMOV)){                                                           
//#15779                                                                           
//#15780                    unmov();                                                       
//#15781                    mvlin[1].x=msg.pt.x-stOrg.x;
//#15782                    mvlin[1].y=msg.pt.y-stOrg.y;                                                       
//#15783                    setMap(SHOMOV);                                                       
//#15784                    ritmov();                                                       
//#15785                    if(px2stch())                                                       
//#15786                        ritfcor(&sPnt);                                                   
//#15787                    return 1;                                                       
//#15788                }                                                           
//#15789                if(chkMap(MOVCNTR)){
//#15790                                                                           
//#15791                    unrot();                                                       
//#15792                    px2stch();                                                       
//#15793                    rotcntr.x=sPnt.x;                                                       
//#15794                    rotcntr.y=sPnt.y;                                                       
//#15795                    ritrot();
//#15796                    return 1;                                                       
//#15797                }                                                           
//#15798                if(chkMap(ROTCAPT)){                                                           
//#15799                                                                           
//#15800                    unrotu();                                                       
//#15801                    unrot();
//#15802                    rlinu[1].x=msg.pt.x-stOrg.x;
//#15803                    rlinu[1].y=msg.pt.y-stOrg.y;
//#15804                    padj.x=rlinu[0].x-rlinu[1].x;
//#15805                    padj.y=rlinu[0].y-rlinu[1].y;
//#15806                    if(padj.x)
//#15807                        ang=-atan2(padj.y,padj.x);
//#15808                    else{
//#15809
//#15810                        if(padj.y>0)
//#15811                            ang=PI/2;
//#15812                        else
//#15813                            ang=-PI/2;
//#15814                    }
//#15815                    ang-=hang;
//#15816                    ritrot();
//#15817                    setMap(ROTUSHO);
//#15818                    durotu();
//#15819                    return 1;
//#15820                }
//#15821                if(chkMap(SELPNT)){
//#15822
//#15823                    if(setMap(VCAPT))
//#15824                        SetCapture(hWnd);
//#15825                    unsel();
//#15826                    rSelbox();
//#15827                    return 1;
//#15828                }
//#15829                if(chkMap(CLPSHO)){
//#15830
//#15831                    unclp();
//#15832                    clpbox();
//#15833                    return 1;
//#15834                }
//#15835                if(chkMap(CAPT)){
//#15836
//#15837                    if(px2stch())
//#15838                        ritfcor(&sPnt);
//#15839                    unlin();
//#15840                    mlin0[1].x=mlin1[0].x=msg.pt.x-stOrg.x;
//#15841                    mlin0[1].y=mlin1[0].y=msg.pt.y-stOrg.y;
//#15842                    dulin();
//#15843                    return 1;
//#15844                }
//#15845                if(chkMap(INSRT)){
//#15846
//#15847                    if(px2stch())
//#15848                        ritfcor(&sPnt);
//#15849                    if(setMap(VCAPT))
//#15850                        SetCapture(hWnd);
//#15851                    if(chkMap(LIN1)){
//#15852
//#15853                        if(hed.stchs){
//#15854
//#15855                            xlin1();
//#15856                            inlin[1].x=msg.pt.x-stOrg.x;
//#15857                            inlin[1].y=msg.pt.y-stOrg.y;
//#15858                            setMap(ILIN1);
//#15859                            ilin1();
//#15860                        }
//#15861                        return 1;
//#15862                    }
//#15863                    xlin();
//#15864                    inlin[1].x=msg.pt.x-stOrg.x;
//#15865                    inlin[1].y=msg.pt.y-stOrg.y;
//#15866                    setMap(ILIN);
//#15867                    ilin();
//#15868                    return 1;
//#15869                }
//#15870                if(chkMap(BOXZUM)&&setMap(VCAPT))
//#15871                    SetCapture(hWnd);
//#15872                if(chkMap(BZUMIN)&&(msg.wParam&MK_LBUTTON)){
//#15873
//#15874                    if(setMap(VCAPT))
//#15875                        SetCapture(hWnd);
//#15876                    unbBox();
//#15877                    blin[1].x=blin[2].x=msg.pt.x-stOrg.x;
//#15878                    blin[2].y=blin[3].y=msg.pt.y-stOrg.y;
//#15879                    setMap(BZUM);
//#15880                    bBox();
//#15881                    return 1;
//#15882                }
//#15883            }
//#15884            else{
//#15885
//#15886                if(rstMap(VCAPT))
//#15887                    ReleaseCapture();
//#15888            }
//#15889            return 1;
//#15890        }
  end;

procedure TfrmMain.FormMouseUp(Sender: TObject; Button: TMouseButton;
  Shift: TShiftState; X, Y: Integer);
begin


//#15891        if(msg.message==WM_LBUTTONUP)
//#15892        {
//#15893            if(GetKeyState(VK_SHIFT)&0X8000&&px2stch())
//#15894            {
//#15895                setshft();
//#15896                return 1;
//#15897            }
//#15898            if(chkMap(TXTRED))
//#15899            {
//#15900                txtrup();
//#15901                return 1;
//#15902            }
//#15903            ReleaseCapture();
//#15904            movchk();
//#15905            if(rstMap(MOVFRMS)){
//#15906
//#15907                savdo();
//#15908                tpnt.x=(msg.pt.x-fmovdif.x-stOrg.x)-bigrct.left;
//#15909                tpnt.y=(msg.pt.y-fmovdif.y-stOrg.y)-bigrct.top;
//#15910                ratsr();
//#15911                fmovdif.x=tpnt.x/hfrat;
//#15912                fmovdif.y=tpnt.y/vfrat;
//#15913                if(chkMap(FPSEL)){
//#15914
//#15915                    fvars(clofind);
//#15916                    ine=pselrng.strt;
//#15917                    for(ind=0;(unsigned)ind<=pselrng.cnt;ind++){
//#15918
//#15919                        flt[ine].x+=fmovdif.x;                                                   
//#15920                        flt[ine].y-=fmovdif.y;                                                   
//#15921                        ine=pdir(ine);                                                   
//#15922                    }                                                       
//#15923                    setpsel();                                                       
//#15924                    frmout(clofind);
//#15925                    refil();                                                       
//#15926                    setMap(RESTCH);                                                       
//#15927                }                                                           
//#15928                else{                                                           
//#15929                                                                           
//#15930                    if(chkMap(BIGBOX)){                                                       
//#15931                                                                           
//#15932                        savdo();                                                   
//#15933                        for(ind=0;ind<(long)formpnt;ind++)
//#15934                            frmadj(ind);                                               
//#15935                        for(ind=0;ind<hed.stchs;ind++){                                                   
//#15936                                                                           
//#15937                            stchs[ind].x+=fmovdif.x;
//#15938                            stchs[ind].y-=fmovdif.y;                                               
//#15939                        }
//#15940                        selal();                                                   
//#15941                    }                                                       
//#15942                    else{                                                       
//#15943                                                                           
//#15944                        savdo();                                                   
//#15945                        for(cod=0;cod<fselpnt;cod++)                                                   
//#15946                            frmadj(selist[cod]);                                               
//#15947                        frmsadj();                                                   
//#15948                        setMap(RESTCH);                                                   
//#15949                    }                                                       
//#15950                }                                                           
//#15951                return 1;
//#15952            }                                                               
//#15953            if(rstMap(EXPAND)){                                                               
//#15954                                                                           
//#15955                setexpand();                                                           
//#15956                return 1;                                                           
//#15957            }                                                               
//#15958            if(rstMap(STRTCH)){
//#15959                                                                           
//#15960                setstrtch();                                                           
//#15961                return 1;                                                           
//#15962            }
//#15963            if(rstMap(FRMOV)){                                                               
//#15964                                                                           
//#15965                savdo();                                                           
//#15966                rstfrm();                                                           
//#15967                setMap(RESTCH);                                                           
//#15968                return 1;
//#15969            }                                                               
//#15970            if(rstMap(FRMPMOV)){                                                               
//#15971
//#15972                savdo();                                                           
//#15973                setfpnt();                                                           
//#15974                return 1;                                                           
//#15975            }                                                               
//#15976            if(rstMap(MOVCNTR)){                                                               
//#15977                                                                           
//#15978                setMap(ROTAT);                                                           
//#15979                return 1;                                                           
//#15980            }                                                               
//#15981            if(rstMap(ROTCAPT)){                                                               
//#15982                                                                           
//#15983                rotfn();                                                           
//#15984                return 1;                                                           
//#15985            }
//#15986            if(rstMap(SELPNT)){                                                               
//#15987                                                                           
//#15988                savdo();                                                           
//#15989                ReleaseCapture();                                                           
//#15990                unsel();                                                           
//#15991                padj.x=(rngrct.left+selof.x)-sPnt.x;
//#15992                padj.y=(rngrct.bottom+selof.y)-sPnt.y;
//#15993                for(ind=gpnt0;ind<=(long)gpnt1;ind++){                                                           
//#15994                                                                           
//#15995                    stchs[ind].x-=padj.x;                                                       
//#15996                    stchs[ind].y-=padj.y;                                                       
//#15997                }
//#15998                setMap(RESTCH);                                                           
//#15999                return 1;                                                           
//#16000            }                                                               
//#16001            if(rstMap(CAPT)){                                                               
//#16002                                                                           
//#16003                unlin();                                                           
//#16004                ReleaseCapture();                                                           
//#16005                rstMap(CAPT);
//#16006                px2stch();                                                           
//#16007                stchs[cloInd].x=sPnt.x;                                                           
//#16008                stchs[cloInd].y=sPnt.y;                                                           
//#16009                stchs[cloInd].at|=USMSK;                                                           
//#16010                if(zumFct<STCHBOX){                                                           
//#16011                                                                           
//#16012                    SetROP2(sdc,R2_NOTXORPEN);                                                       
//#16013                    SelectObject(sdc,lPen);                                                       
//#16014                    stchbox(cloInd-1,rsdc);                                                       
//#16015                    stchbox(cloInd,rsdc);                                                       
//#16016                    stchbox(cloInd+1,rsdc);                                                       
//#16017                    SetROP2(sdc,R2_COPYPEN);                                                       
//#16018                }                                                           
//#16019                setMap(SELBOX);
//#16020                rstMap(FRMPSEL);
//#16021                setMap(RESTCH);                                                           
//#16022                return 1;                                                           
//#16023            }                                                               
//#16024            if(chkMap(BZUMIN)){                                                               
//#16025                                                                           
//#16026                px2stch();
//#16027                if(rstMap(BOXSLCT)){                                                           
//#16028                                                                           
//#16029                    if(zBoxo.x>sPnt.x){                                                       
//#16030                                                                           
//#16031                        rngrct.right=zBoxo.x;                                                   
//#16032                        rngrct.left=sPnt.x;                                                   
//#16033                    }                                                       
//#16034                    else{                                                       
//#16035                                                                           
//#16036                        rngrct.right=sPnt.x;                                                   
//#16037                        rngrct.left=zBoxo.x;                                                   
//#16038                    }                                                       
//#16039                    if(zBoxo.y>sPnt.y){
//#16040                                                                           
//#16041                        rngrct.top=zBoxo.y;                                                   
//#16042                        rngrct.bottom=sPnt.y;                                                   
//#16043                    }                                                       
//#16044                    else{                                                       
//#16045                                                                           
//#16046                        rngrct.top=sPnt.y;                                                   
//#16047                        rngrct.bottom=zBoxo.y;                                                   
//#16048                    }                                                       
//#16049                    if(rstMap(GRPSEL)){
//#16050                                                                           
//#16051                        rngadj();                                                   
//#16052                        for(ine=gpnt0;ine<gpnt1;ine++){                                                   
//#16053
//#16054                            if(inrng(ine)){                                               
//#16055
//#16056                                cloInd=ine;                                           
//#16057                                setMap(SELBOX);                                           
//#16058                                break;                                           
//#16059                            }                                               
//#16060                        }
//#16061                    }                                                       
//#16062                    if(rstMap(NOSEL)){                                                       
//#16063                                                                           
//#16064                        fselpnt=0;                                                   
//#16065                        rstMap(FORMSEL);                                                   
//#16066                        for(ine=0;ine<formpnt;ine++){                                                   
//#16067                                                                           
//#16068                            if(finrng(ine))                                               
//#16069                                selist[fselpnt++]=ine;                                           
//#16070                        }                                                   
//#16071                        if(fselpnt){                                                   
//#16072                                                                           
//#16073                            if(fselpnt==1){
//#16074                                                                           
//#16075                                ReleaseCapture();                                           
//#16076                                gotbox();                                           
//#16077                                clofind=selist[0];                                           
//#16078                                clofine=0;
//#16079                                fselpnt=0;                                           
//#16080                                ritnum(STR_NUMFORM,clofind);                                           
//#16081                                setMap(RESTCH);                                           
//#16082                                setMap(FORMSEL);                                           
//#16083                                return 1;                                           
//#16084                            }
//#16085                        }                                                   
//#16086                        if(fselpnt){                                                   
//#16087
//#16088                            gotbox();                                               
//#16089                            return 1;                                               
//#16090                        }                                                   
//#16091                        rstMap(BZUMIN);                                                   
//#16092                        rstMap(BOXSLCT);                                                   
//#16093                        rstMap(FRMPSEL);                                                   
//#16094                        setMap(RESTCH);
//#16095                    }                                                       
//#16096                    if(rstMap(SELBOX)){                                                       
//#16097                                                                           
//#16098                        if(inrng(cloInd)){                                                   
//#16099                                                                           
//#16100                            grpInd=cloInd+1;                                               
//#16101                            cloInd--;                                               
//#16102                            while(inrng(cloInd))                                               
//#16103                                cloInd--;                                           
//#16104                            cloInd++;                                               
//#16105                            while(inrng(grpInd))                                               
//#16106                                grpInd++;                                           
//#16107                            grpInd--;
//#16108                            setMap(GRPSEL);                                               
//#16109                            gotbox();                                               
//#16110                            return 1;                                               
//#16111                        }                                                   
//#16112                    }                                                       
//#16113                    if(!chkMap(INSRT))
//#16114                        rngal();                                                   
//#16115    //                gotbox();                                                       
//#16116                    return 1;                                                       
//#16117                }                                                           
//#16118                else{                                                           
//#16119                                                                           
//#16120                    if(sPnt.x<zBoxo.x){                                                       
//#16121
//#16122                        tdub=zBoxo.x;                                                   
//#16123                        zBoxo.x=sPnt.x;                                                   
//#16124                        sPnt.x=tdub;                                                   
//#16125                    }                                                       
//#16126                    if(sPnt.y<zBoxo.y){                                                       
//#16127                                                                           
//#16128                        tdub=zBoxo.y;
//#16129                        zBoxo.y=sPnt.y;                                                   
//#16130                        sPnt.y=tdub;                                                   
//#16131                    }                                                       
//#16132                    nusiz.x=sPnt.x-zBoxo.x;                                                       
//#16133                    nusiz.y=sPnt.y-zBoxo.y;                                                       
//#16134                    sPnt.x=zBoxo.x+nusiz.x/2;                                                       
//#16135                    sPnt.y=zBoxo.y+nusiz.y/2;                                                       
//#16136                    tdub=zumFct;
//#16137                    if(nusiz.x>nusiz.y){                                                       
//#16138                                                                           
//#16139                        nusiz.y=nusiz.x/stchAspct;                                                   
//#16140                        zumFct=nusiz.x/zum0.x;                                                   
//#16141                    }
//#16142                    else{
//#16143                                                                           
//#16144                        nusiz.x=nusiz.y*stchAspct;                                                   
//#16145                        zumFct=nusiz.y/zum0.x;                                                   
//#16146                    }                                                       
//#16147                    if(zumFct<zumflor){                                                       
//#16148                                                                           
//#16149                        zumFct=tdub;                                                   
//#16150                        zumin();                                                   
//#16151                        return 1;                                                   
//#16152                    }                                                       
//#16153                    zRct.left=zRct.bottom=0;                                                       
//#16154                    zRct.right=nusiz.x;                                                       
//#16155                    zRct.top=nusiz.y;
//#16156                    shft(sPnt);
//#16157                    rstMap(BZUMIN);
//#16158                    setMap(RESTCH);
//#16159                    if(!setMap(ZUMED))
//#16160                        movStch();
//#16161                    return 1;
//#16162                }
//#16163                rstMap(BZUMIN);
//#16164            }
//#16165        }
end;

procedure TfrmMain.FormMouseDown(Sender: TObject; Button: TMouseButton;
  Shift: TShiftState; X, Y: Integer);
begin


//#16166        if(msg.message==WM_RBUTTONDOWN||msg.message==WM_LBUTTONDOWN){
//#16167
//#16168            if(rstMap(THUMON)){
//#16169
//#16170                if(chkok()){
//#16171
//#16172                    save();
//#16173                    thumbak();
//#16174                    unmsg();
//#16175                    return 1;
//#16176                }
//#16177                if(chkwnd(hdsc)){
//#16178
//#16179                    thumbak();
//#16180                    unmsg();
//#16181                    return 1;
//#16182                }
//#16183                setMap(BAKSHO);
//#16184                unbsho();
//#16185                rstMap(THUMSHO);
//#16186                unmsg();                                                           
//#16187                return 1;
//#16188            }                                                               
//#16189            if(rstMap(BAKSHO)){                                                               
//#16190                                                                           
//#16191                if(msg.message==WM_RBUTTONDOWN)                                                           
//#16192                    setMap(RBUT);                                                       
//#16193                else
//#16194                    rstMap(RBUT);                                                       
//#16195                for(ind=0;ind<OLDVER;ind++){                                                           
//#16196
//#16197                    if(msg.hwnd==hvu[ind]){                                                       
//#16198                                                                           
//#16199                        baknum=ind;
//#16200                        if(chkMap(THUMSHO)){                                                   
//#16201                                                                           
//#16202                            if(savcmp())                                               
//#16203                                thumbak();                                           
//#16204                            else{                                               
//#16205                                                                           
//#16206                                if(chkMap(RBUT))                                           
//#16207                                    thumbak();                                       
//#16208                                else{                                           
//#16209
//#16210                                    setMap(THUMON);                                       
//#16211                                    savdisc();                                       
//#16212                                }                                           
//#16213                                return 1;                                           
//#16214                            }                                               
//#16215                        }                                                   
//#16216                        else
//#16217                            rebak();                                               
//#16218                        rstAll();                                                   
//#16219                        setMap(RESTCH);
//#16220                        return 1;                                                   
//#16221                    }                                                       
//#16222                }
//#16223            }                                                               
//#16224            if(msg.pt.x>=bRct.left&&msg.pt.x<=bRct.right                                                               
//#16225                &&msg.pt.y>=bRct.top&&msg.pt.y<=bRct.bottom){                                                           
//#16226                                                                           
//#16227                unpat();                                                           
//#16228                tdub=(double)(msg.pt.y-bRct.top)/(bRct.bottom-bRct.top);                                                           
//#16229                if(msg.message==WM_RBUTTONDOWN){                                                           
//#16230
//#16231                    tdub=(double)(msg.pt.y-bRct.top)/(bRct.bottom-bRct.top);                                                       
//#16232                    if(msg.wParam&MK_SHIFT&&(chkMap(SELBOX)||chkMap(GRPSEL))){                                                       
//#16233
//#16234                        unbox();                                                   
//#16235                        grpInd=tdub*hed.stchs;                                                   
//#16236                        setMap(GRPSEL);                                                   
//#16237                        grpAdj();                                                   
//#16238                        nuAct(grpInd);                                                   
//#16239                        setMap(RESTCH);                                                   
//#16240                    }                                                       
//#16241                    else{                                                       
//#16242                                                                           
//#16243                        cloInd=tdub*hed.stchs;
//#16244                        nuAct(cloInd);                                                   
//#16245                        movbox();
//#16246                        if(rstMap(GRPSEL)){                                                   
//#16247                                                                           
//#16248                            rstMap(SCROS);                                               
//#16249                            rstMap(ECROS);                                               
//#16250                            setMap(RESTCH);                                               
//#16251                        }
//#16252                    }                                                       
//#16253                }
//#16254                else{                                                           
//#16255                                                                           
//#16256                    cloInd=tdub*hed.stchs;                                                       
//#16257                    nuAct(cloInd);                                                       
//#16258                    rstAll();                                                       
//#16259                    setMap(SELBOX);                                                       
//#16260                    selCol();                                                       
//#16261                }                                                           
//#16262                redraw(hBar);                                                           
//#16263                return 1;                                                           
//#16264            }
//#16265        }                                                                   
//#16266        if(msg.message==WM_RBUTTONDOWN){                                                                   
//#16267
//#16268            if(chkMap(TXTRED)&&!hMsg)                                                               
//#16269            {                                                               
//#16270                txtrbut();                                                           
//#16271                return 1;                                                           
//#16272            }                                                               
//#16273            if(GetKeyState(VK_SHIFT)&0X8000){                                                               
//#16274
//#16275                if(closfrm()){                                                           
//#16276                                                                           
//#16277                    if((chkMap(FRMPSEL)||chkMap(FPSEL))&&pselrng.frm==clofind){
//#16278                                                                           
//#16279                        rstMap(FRMPSEL);                                                   
//#16280                        setMap(FPSEL);
//#16281                        pselrng.fin=clofine;                                                   
//#16282                        ine=(pselrng.fin-pselrng.strt+sids)%sids;                                                   
//#16283                        if(ine<(unsigned)sids>>1){                                                   
//#16284                                                                           
//#16285                            pselrng.cnt=ine;                                               
//#16286                            setMap(PSELDIR);                                               
//#16287                        }
//#16288                        else{                                                   
//#16289                                                                           
//#16290                            pselrng.cnt=sids-ine;                                               
//#16291                            rstMap(PSELDIR);                                               
//#16292                        }                                                   
//#16293                        setpsel();                                                   
//#16294                        return 1;                                                   
//#16295                    }                                                       
//#16296                    rstMap(FPSEL);                                                       
//#16297                    setMap(FRMPSEL);                                                       
//#16298                    pselrng.strt=clofine;
//#16299                    pselrng.frm=clofind;                                                       
//#16300                    selfpnt();                                                       
//#16301                    return 1;
//#16302                }                                                           
//#16303            }
//#16304            if(chkMap(WASTRAC)){                                                               
//#16305                                                                           
//#16306                if(chkMap(TRNIN0))                                                           
//#16307                    dutrnum0(atoi(trinbuf));                                                       
//#16308                if(chkMap(TRNIN1))                                                           
//#16309                    dutrnum1();
//#16310                if(!chkMap(WASEDG))                                                           
//#16311                    tracpar();
//#16312                return 1;                                                           
//#16313            }                                                               
//#16314            unmsg();                                                               
//#16315            unboxs();                                                               
//#16316            unpat();                                                               
//#16317            numpnt=0;                                                               
//#16318            rstMap(SATIN);                                                               
//#16319            if(rstMap(SATPNT))                                                               
//#16320                satfix();                                                           
//#16321            if(chkMap(BAKSHO)){
//#16322
//#16323                unbsho();
//#16324                return 1;
//#16325            }
//#16326            if(rstMap(BIGBOX))
//#16327                setMap(RESTCH);
//#16328            if(chkMap(PRFACT)){
//#16329
//#16330                if(rstMap(HUPMSG))
//#16331                    unsid();
//#16332                else{
//#16333
//#16334                    if(prfind){
//#16335
//#16336                        chknum();
//#16337                        unsid();
//#16338                        prfind=0;
//#16339                    }
//#16340                    else{
//#16341
//#16342                        DestroyWindow(hPrf);
//#16343                        rstMap(PRFACT);
//#16344                        if(rstMap(WASRT))                                                   
//#16345                            setMap(INSRT);
//#16346                    }                                                       
//#16347                }                                                           
//#16348                setMap(RESTCH);                                                           
//#16349                return 1;                                                           
//#16350            }                                                               
//#16351            else{                                                               
//#16352                                                                           
//#16353                if(sidtyp){                                                           
//#16354                                                                           
//#16355                    chknum();                                                       
//#16356                    sidtyp=0;                                                       
//#16357                    setMap(RESTCH);                                                       
//#16358                    return 1;                                                       
//#16359                }                                                           
//#16360            }                                                               
//#16361            if(rstMap(INSFRM)){
//#16362                                                                           
//#16363                insadj();                                                           
//#16364                rstMap(SHOINSF);                                                           
//#16365                setMap(RESTCH);                                                           
//#16366                return 1;
//#16367            }
//#16368            if(px2stch()&&!(chkMap(SIZSEL)&&chkMsgs(msg.pt,hSizChng[0],hSizChng[2]))){                                                               
//#16369
//#16370                if(formpnt&&!chkMap(FRMOF)){                                                           
//#16371                                                                           
//#16372                    if(msg.wParam&MK_SHIFT){                                                       
//#16373                                                                           
//#16374                        bakfrm=clofind;                                                   
//#16375                        if(closfrm()){                                                   
//#16376                                                                           
//#16377                            ine=0;
//#16378                            if(fselpnt){                                               
//#16379
//#16380                                nuslst(clofind);                                           
//#16381                                setMap(RESTCH);                                           
//#16382                                return 1;                                           
//#16383                            }                                               
//#16384                            else{                                               
//#16385                                                                           
//#16386                                if(rstMap(FORMSEL)&&bakfrm!=clofind){                                           
//#16387                                                                           
//#16388                                    if(bakfrm>clofind){                                       
//#16389                                                                           
//#16390                                        ine=clofind;
//#16391                                        clofind=bakfrm;                                   
//#16392                                        bakfrm=ine;                                   
//#16393                                    }                                       
//#16394                                    for(ind=bakfrm;ind<=(long)clofind;ind++)                                       
//#16395                                        selist[ine++]=ind;                                   
//#16396                                    fselpnt=ine;
//#16397                                    setMap(RESTCH);                                       
//#16398                                    return 1;                                       
//#16399                                }                                           
//#16400                                else
//#16401                                    nufsel();                                       
//#16402                            }                                               
//#16403                        }
//#16404                    }                                                       
//#16405                    if(msg.wParam&MK_CONTROL){                                                       
//#16406                                                                           
//#16407                        if(!fselpnt&&chkMap(FORMSEL)){                                                   
//#16408                                                                           
//#16409                            setMap(WASEL);                                               
//#16410                            baksel=clofind;                                               
//#16411                        }
//#16412                        if(closfrm())                                                   
//#16413                            nufsel();
//#16414                        if(fselpnt>1)                                                   
//#16415                            butxt(HNUM,"");                                               
//#16416                        else                                                   
//#16417                            ritnum(STR_NUMFORM,selist[0]+1);                                               
//#16418                        return 1;                                                   
//#16419                    }
//#16420                    if(chkMap(FORMSEL)){                                                       
//#16421                                                                           
//#16422                        if(sidtyp){                                                   
//#16423                                                                           
//#16424                            chknum();                                               
//#16425                            sidtyp=0;
//#16426                            goto frmskip;                                               
//#16427                        }                                                   
//#16428                        if(hfdat){                                                   
//#16429                                                                           
//#16430                            undat();                                               
//#16431                            unsid();                                               
//#16432                            sidtyp=0;                                               
//#16433                            setMap(RESTCH);                                               
//#16434                            goto frmskip;
//#16435                        }                                                   
//#16436                        ritfrct(clofind,rsdc);                                                   
//#16437                        lenCalc();
//#16438                        if(!rstMap(ENTROT))                                                   
//#16439                            rstMap(FORMSEL);                                               
//#16440                        setMap(DUMEN);                                                   
//#16441                        if(!closPnt1(&cloInd))                                                   
//#16442                            unbox();                                               
//#16443    frmskip:;                                                                       
//#16444                    }                                                       
//#16445                    if(closfrm()){
//#16446                                                                           
//#16447                        setMap(FORMSEL);
//#16448                        rstMap(FPSEL);
//#16449                        unpsel();                                                   
//#16450                        fvars(clofind);                                                   
//#16451                        ritfrct(clofind,rsdc);                                                   
//#16452                        if(rstMap(FRMPSEL)||fselpnt){                                                   
//#16453                                                                           
//#16454                            setMap(RESTCH);
//#16455                            fselpnt=0;                                               
//#16456                        }                                                   
//#16457                        ritnum(STR_NUMFORM,clofind);                                                   
//#16458                        cod=(formlst[clofind].at&FRMLMSK)>>1;                                                   
//#16459                        lenCalc();                                                   
//#16460                        unrot();                                                   
//#16461                        return 1;                                                   
//#16462                    }                                                       
//#16463                    if(fselpnt){                                                       
//#16464                                                                           
//#16465                        fselpnt=0;                                                   
//#16466                        setMap(RESTCH);                                                   
//#16467                    }                                                       
//#16468                    if(rstMap(FRMPSEL))
//#16469                        setMap(RESTCH);                                                   
//#16470                }                                                           
//#16471                if(chkMap(INIT)||hFil){
//#16472                                                                           
//#16473                    if(msg.wParam&MK_SHIFT){                                                       
//#16474                                                                           
//#16475                        if(chkMap(SELBOX)){                                                   
//#16476                                                                           
//#16477                            cod=cloInd;
//#16478                            closPnt1(&cloInd);                                               
//#16479                            if(cloInd!=cod){
//#16480                                                                           
//#16481                                unbox();
//#16482                                grpInd=cloInd;                                           
//#16483                                cloInd=cod;
//#16484                                setMap(GRPSEL);                                           
//#16485                                grpAdj();                                           
//#16486                            }                                               
//#16487                            nuAct(grpInd);                                               
//#16488                            redraw(hBar);                                               
//#16489                            return 1;                                               
//#16490                        }                                                   
//#16491                        if(chkMap(GRPSEL)){                                                   
//#16492                                                                           
//#16493                            cod=cloInd;                                               
//#16494                            closPnt1(&cloInd);                                               
//#16495                            grpInd=cloInd;                                               
//#16496                            cloInd=cod;                                               
//#16497                            grpAdj();                                               
//#16498                            nuAct(grpInd);                                               
//#16499                            redraw(hBar);                                               
//#16500                            return 1;                                               
//#16501                        }                                                   
//#16502                        rebox();
//#16503                    }                                                       
//#16504                    else{                                                       
//#16505
//#16506                        rstMap(LENSRCH);
//#16507                        rstMap(WASGRP);                                                   
//#16508                        rstMap(FPSEL);                                                   
//#16509                        rstMap(WASFRMFRM);                                                   
//#16510                        rstMap(SIDACT);                                                   
//#16511                        if(rstMap(INSRT)){                                                   
//#16512
//#16513                            ReleaseCapture();
//#16514                            rstAll();                                               
//#16515                            setMap(RESTCH);
//#16516                        }                                                   
//#16517                        else{                                                   
//#16518                                                                           
//#16519                            if(rstMap(GRPSEL))                                               
//#16520                                setMap(RESTCH);                                           
//#16521                            if(hed.stchs)                                               
//#16522                                rebox();                                           
//#16523                        }                                                   
//#16524                    }                                                       
//#16525                    clrstch();                                                       
//#16526                    setMap(RESTCH);                                                       
//#16527                }                                                           
//#16528                return 1;                                                           
//#16529            }                                                               
//#16530            if(msg.pt.x>=minLenRct.left&&msg.pt.x<=minLenRct.right                                                               
//#16531                &&msg.pt.y>minLenRct.top&&msg.pt.y<=minLenRct.bottom){                                                           
//#16532                                                                           
//#16533                srchk();                                                           
//#16534                setsrch(minpnt);                                                           
//#16535                lensadj();
//#16536                setMap(GRPSEL);
//#16537                setMap(RESTCH);                                                           
//#16538                return 1;                                                           
//#16539            }
//#16540            if(msg.pt.x>=maxLenRct.left&&msg.pt.x<=maxLenRct.right                                                               
//#16541                &&msg.pt.y>maxLenRct.top&&msg.pt.y<=maxLenRct.bottom){
//#16542                                                                           
//#16543                srchk();                                                           
//#16544                setsrch(maxpnt);                                                           
//#16545                lensadj();                                                           
//#16546                setMap(GRPSEL);                                                           
//#16547                setMap(RESTCH);
//#16548            }                                                               
//#16549            return 1;
//#16550        }                                                                   
//#16551        if(msg.message==WM_LBUTTONDOWN){                                                                   
//#16552                                                                           
//#16553            if(GetKeyState(VK_SHIFT)&0X8000&&px2stch())                                                               
//#16554            {                                                               
//#16555                dushft();                                                           
//#16556                return 1;                                                           
//#16557            }                                                               
//#16558            if(chkMap(TXTRED)&&!chkMap(FORMIN))                                                               
//#16559            {                                                               
//#16560                txtlbut();                                                           
//#16561                return 1;                                                           
//#16562            }                                                               
//#16563            if(rstMap(FSETFCOL))                                                               
//#16564            {
//#16565                unsid();                                                           
//#16566                unmsg();                                                           
//#16567                if(chkMsgs(msg.pt,hDef[0],hDef[15]))                                                           
//#16568                {                                                           
//#16569                    dufcol(vind+1);                                                       
//#16570                    return 1;
//#16571                }                                                           
//#16572            }                                                               
//#16573            if(rstMap(FSETBCOL))
//#16574            {                                                               
//#16575                unsid();                                                           
//#16576                unmsg();                                                           
//#16577                if(chkMsgs(msg.pt,hDef[0],hDef[15]))                                                           
//#16578                {                                                           
//#16579                    dubcol(vind+1);                                                       
//#16580                    return 1;                                                       
//#16581                }
//#16582            }                                                               
//#16583            if(rstMap(FPUNCLP)){
//#16584                                                                           
//#16585                savdo();                                                           
//#16586                fixpclp();                                                           
//#16587                frmout(clofind);                                                           
//#16588                return 1;                                                           
//#16589            }                                                               
//#16590            if(chkMap(FPSEL)&&!chkMap(FUNCLP)&&!chkMap(ROTAT)){                                                               
//#16591                                                                           
//#16592                MoveMemory(&biglin,&pselin,sizeof(POINT)*9);                                                           
//#16593                MoveMemory(&bigrct,&pxselrct,sizeof(RECT));
//#16594                if(chkbig())                                                           
//#16595                    return 1;                                                       
//#16596            }                                                               
//#16597            if(chkMap(WASTRAC)){                                                               
//#16598                                                                           
//#16599                tracpar();
//#16600                return 1;                                                           
//#16601            }                                                               
//#16602            if(rstMap(HUPMSG)){                                                               
//#16603                                                                           
//#16604                for(ind=0;ind<HUPS;ind++){
//#16605                                                                           
//#16606                    if(msg.hwnd==hsidWnd[ind]){                                                       
//#16607
//#16608                        switch(ind+1){                                                   
//#16609                                                                           
//#16610                        case SETCUST:                                                   
//#16611                                                                           
//#16612                            ini.xcust=ini.hupx;                                               
//#16613                            ini.ycust=ini.hupy;                                               
//#16614                            setMap(MSGOF);                                               
//#16615                            sprintf(msgbuf,stab[STR_CUSTHUP],ini.hupx/PFGRAN,ini.hupy/PFGRAN);
//#16616                            shoMsg(msgbuf);                                               
//#16617                            break;
//#16618                                                                           
//#16619                        case SMALHUP:                                                   
//#16620                                                                           
//#16621                            ini.hupx=SHUPX;                                               
//#16622                            ini.hupy=SHUPY;
//#16623                            ini.hup=SMALHUP;                                               
//#16624                            break;                                               
//#16625                                                                           
//#16626                        case LARGHUP:                                                   
//#16627                                                                           
//#16628                            ini.hupx=LHUPX;
//#16629                            ini.hupy=LHUPY;                                               
//#16630                            ini.hup=LARGHUP;                                               
//#16631                            break;                                               
//#16632                                                                           
//#16633                        case CUSTHUP:                                                   
//#16634                                                                           
//#16635                            ini.hupx=ini.xcust;                                               
//#16636                            ini.hupy=ini.ycust;                                               
//#16637                            ini.hup=CUSTHUP;                                               
//#16638                            break;                                               
//#16639                                                                           
//#16640                        case HUP100:                                                   
//#16641
//#16642                            ini.hupx=HUP100XY;                                               
//#16643                            ini.hupy=HUP100XY;                                               
//#16644                            ini.hup=CUSTHUP;                                               
//#16645                            break;                                               
//#16646                        }                                                   
//#16647                        zum0.x=ini.hupx;                                                   
//#16648                        zum0.y=ini.hupy;                                                   
//#16649                        sethup();
//#16650                        chkhup();                                                   
//#16651                        break;
//#16652                    }                                                       
//#16653                }                                                           
//#16654                unsid();                                                           
//#16655                prfmsg();                                                           
//#16656                return 1;                                                           
//#16657            }
//#16658            if(rstMap(INSFIL)){                                                               
//#16659                                                                           
//#16660                duinsfil();                                                           
//#16661                return 1;                                                           
//#16662            }                                                               
//#16663            if(chkMap(BIGBOX)&&chkbig())                                                               
//#16664                return 1;                                                           
//#16665            if(rstMap(DELSFRMS)){                                                               
//#16666                                                                           
//#16667                cod=0;                                                           
//#16668                if(chkok()){                                                           
//#16669                                                                           
//#16670                    savdo();                                                       
//#16671                    rstMap(DELTO);                                                       
//#16672                    cod=1;                                                       
//#16673                }                                                           
//#16674                else{                                                           
//#16675
//#16676                    GetWindowRect(hto,&trct);                                                       
//#16677                    if(msg.pt.x>=trct.left&&msg.pt.x<=trct.right                                                       
//#16678                        &&msg.pt.y>=trct.top&&msg.pt.y<=trct.bottom){                                                   
//#16679                                                                           
//#16680                        savdo();
//#16681                        setMap(DELTO);                                                   
//#16682                        cod=1;                                                   
//#16683                    }
//#16684                }                                                           
//#16685                delsfrms(cod);
//#16686                unmsg();
//#16687                return 1;                                                           
//#16688            }                                                               
//#16689            if(rstMap(MOVMSG)){                                                               
//#16690                                                                           
//#16691                if(chkok()){                                                           
//#16692                                                                           
//#16693                    savdo();                                                       
//#16694                    refilfn();                                                       
//#16695                }                                                           
//#16696                unmsg();                                                           
//#16697                if(rstMap(WASFRMFRM))                                                           
//#16698                    refrm();                                                       
//#16699                return 1;                                                           
//#16700            }                                                               
//#16701            if(rstMap(FUNSCLP)){                                                               
//#16702                                                                           
//#16703                savdo();                                                           
//#16704                rstMap(MOVFRMS);                                                           
//#16705                pxrct2stch(bigrct,&tbig);                                                           
//#16706                px2stch();                                                           
//#16707                fmovdif.x=sPnt.x-((tbig.right-tbig.left)/2+tbig.left);                                                           
//#16708                fmovdif.y=sPnt.y-((tbig.top-tbig.bottom)/2+tbig.bottom);                                                           
//#16709                for(ind=0;ind<funscnt;ind++){
//#16710                                                                           
//#16711                    clofind=formpnt+ind;                                                       
//#16712                    fvars(clofind);                                                       
//#16713                    for(ine=0;ine<frmpnt->sids;ine++){                                                       
//#16714                                                                           
//#16715                        frmpnt->flt[ine].x+=fmovdif.x;
//#16716                        frmpnt->flt[ine].y+=fmovdif.y;                                                   
//#16717                    }
//#16718                    frmout(clofind);                                                       
//#16719                    refil();
//#16720                }                                                           
//#16721                formpnt+=funscnt;                                                           
//#16722                setMap(RESTCH);                                                           
//#16723                return 1;                                                           
//#16724            }                                                               
//#16725            if(fselpnt&&!chkMap(ROTAT)&&chkbig())                                                               
//#16726                return 1;                                                           
//#16727            if(chkMap(SIDCOL)&&chkMsgs(msg.pt,hDef[0],hDef[15])){                                                               
//#16728                                                                           
//#16729                savdo();                                                           
//#16730                if(rstMap(FSETFCOL))                                                           
//#16731                {                                                           
//#16732                    dufcol(vind+1);                                                       
//#16733                    return 1;                                                       
//#16734                }                                                           
//#16735                if(rstMap(BRDSID))                                                           
//#16736                {                                                           
//#16737                    nubrdcol(vind);                                                       
//#16738                    goto chkcolx;
//#16739                }                                                           
//#16740                if(rstMap(APSID))                                                           
//#16741                {                                                           
//#16742                    nulapcol(vind);                                                       
//#16743                    goto chkcolx;
//#16744                }
//#16745                if(rstMap(FTHSID))                                                           
//#16746                {                                                           
//#16747                    nufthcol(vind);                                                       
//#16748                    goto chkcolx;                                                       
//#16749                }                                                           
//#16750                if(rstMap(UNDCOL))                                                           
//#16751                {
//#16752                    frmpnt->ucol=vind&0xf;                                                       
//#16753                    refilfn();
//#16754                    coltab();                                                       
//#16755                    goto chkcolx;                                                       
//#16756                }                                                           
//#16757                if(rstMap(FSETUCOL))                                                           
//#16758                {                                                           
//#16759                    dundcol(vind+1);                                                       
//#16760                    return 1;                                                       
//#16761                }                                                           
//#16762                nufilcol(vind);                                                           
//#16763    chkcolx:;                                                                       
//#16764                msgbuf[0]=(TCHAR)vind+0x30;                                                           
//#16765                msgbuf[1]=0;                                                           
//#16766                SetWindowText(thDat[LBRDCOL],msgbuf);                                                           
//#16767                unsid();
//#16768                coltab();                                                           
//#16769                setMap(RESTCH);                                                           
//#16770                rstMap(SIDCOL);                                                           
//#16771                sidtyp=0;                                                           
//#16772                return 1;                                                           
//#16773            }
//#16774            if(rstMap(OSAV)){                                                               
//#16775                                                                           
//#16776                if(chkok()){                                                           
//#16777
//#16778                    save();                                                       
//#16779                    nuFil();                                                       
//#16780                    unmsg();                                                       
//#16781                    return 1;                                                       
//#16782                }                                                           
//#16783                if(chkwnd(hdsc)){                                                           
//#16784                                                                           
//#16785                    nuFil();
//#16786                    unmsg();                                                       
//#16787                    return 1;
//#16788                }                                                           
//#16789                unmsg();                                                           
//#16790                return 1;                                                           
//#16791            }                                                               
//#16792            if(rstMap(FCLOS)){                                                               
//#16793                                                                           
//#16794                if(chkok())                                                           
//#16795                    save();                                                       
//#16796                else{
//#16797                                                                           
//#16798                    if(!chkwnd(hcan))                                                       
//#16799                        closfn();                                                   
//#16800                }                                                           
//#16801                unmsg();                                                           
//#16802                return 1;
//#16803            }                                                               
//#16804            if(rstMap(SAVEX)){                                                               
//#16805                                                                           
//#16806                if(chkok()){                                                           
//#16807                                                                           
//#16808                    save();                                                       
//#16809                    reldun();                                                       
//#16810                }                                                           
//#16811                if(chkwnd(hdsc))
//#16812                    reldun();                                                       
//#16813                unmsg();                                                           
//#16814                return 1;                                                           
//#16815            }                                                               
//#16816            if(chkMap(PRFACT)){                                                               
//#16817                                                                           
//#16818                chknum();                                                           
//#16819                if(msg.hwnd==thDat[PSQR]){
//#16820                                                                           
//#16821                    if(toglu(SQRFIL))
//#16822                        SetWindowText(thDat[PSQR],stab[STR_PNTD]);                                                   
//#16823                    else                                                       
//#16824                        SetWindowText(thDat[PSQR],stab[STR_SQR]);                                                   
//#16825                    return 1;
//#16826                }                                                           
//#16827                if(msg.hwnd==thDat[PBLNT]){                                                           
//#16828                                                                           
//#16829                    if(toglu(BLUNT))                                                       
//#16830                        SetWindowText(thDat[PBLNT],stab[STR_TAPR]);                                                   
//#16831                    else
//#16832                        SetWindowText(thDat[PBLNT],stab[STR_BLUNT]);                                                   
//#16833                    return 1;                                                       
//#16834                }                                                           
//#16835                if(msg.hwnd==thDat[PUND]){                                                           
//#16836                                                                           
//#16837                    if(toglu(DUND))                                                       
//#16838                        SetWindowText(thDat[PUND],stab[STR_OFF]);                                                   
//#16839                    else                                                       
//#16840                        SetWindowText(thDat[PUND],stab[STR_ON]);                                                   
//#16841                    return 1;                                                       
//#16842                }                                                           
//#16843                if(msg.hwnd==thDat[PHUP]){                                                           
//#16844                                                                           
//#16845                    sidhup();
//#16846                    return 1;                                                       
//#16847                }                                                           
//#16848                for(ind=0;ind<PRFLINS;ind++){                                                           
//#16849                                                                           
//#16850                    if(msg.hwnd==thDat[ind]){                                                       
//#16851                                                                           
//#16852                        prfind=ind+1;                                                   
//#16853                        prfsid(thDat[ind]);
//#16854                        break;
//#16855                    }
//#16856                }                                                           
//#16857                return 1;                                                           
//#16858            }                                                               
//#16859            if(!chkMap(ROTAT)&&chkMap(GRPSEL)){                                                               
//#16860
//#16861                if(iselpnt()){                                                           
//#16862                                                                           
//#16863                    for(ind=0;ind<4;ind++){                                                       
//#16864                                                                           
//#16865                        sizlin[ind].x=rctlin[ind<<1].x;                                                   
//#16866                        sizlin[ind].y=rctlin[ind<<1].y;                                                   
//#16867                    }                                                       
//#16868                    sizlin[4].x=sizlin[0].x;                                                       
//#16869                    sizlin[4].y=sizlin[0].y;                                                       
//#16870                    if(cntrl&1)                                                       
//#16871                        setMap(STRTCH);                                                   
//#16872                    else{                                                       
//#16873                                                                           
//#16874                        setMap(EXPAND);                                                   
//#16875                        xpct=(double)(rngrct.right-rngrct.left)/(rngrct.top-rngrct.bottom);                                                   
//#16876                    }                                                       
//#16877                    cntrl>>=1;                                                       
//#16878                    setMap(SHOSTRTCH);                                                       
//#16879                    strtchbox();
//#16880                    return 1;                                                       
//#16881                }                                                           
//#16882                else{                                                           
//#16883
//#16884                    pPnt.x=msg.pt.x-stOrg.x;                                                       
//#16885                    pPnt.y=msg.pt.y-stOrg.y;                                                       
//#16886                    if(pPnt.x>=rctlin[0].x&&pPnt.x<=rctlin[2].x&&                                                       
//#16887                        pPnt.y>=rctlin[0].y&&pPnt.y<=rctlin[4].y){
//#16888                                                                           
//#16889                        duSelbox();
//#16890                        setMap(SELPNT);                                                   
//#16891                        SetCapture(hWnd);                                                   
//#16892                        setMap(VCAPT);                                                   
//#16893                        rSelbox();                                                   
//#16894                        return 1;                                                   
//#16895                    }                                                       
//#16896                }                                                           
//#16897            }                                                               
//#16898            if(rstMap(NEWBAK)){                                                               
//#16899                                                                           
//#16900                if(chkok()){                                                           
//#16901                                                                           
//#16902                    unmsg();                                                       
//#16903                    save();                                                       
//#16904                    newFil();                                                       
//#16905                    return 1;                                                       
//#16906                }                                                           
//#16907                if(chkwnd(hdsc)){                                                           
//#16908                                                                           
//#16909                    unmsg();                                                       
//#16910                    newFil();                                                       
//#16911                    return 1;                                                       
//#16912                }
//#16913                unmsg();
//#16914                return 1;                                                           
//#16915            }                                                               
//#16916            if(rstMap(PRGMSG)){                                                               
//#16917                                                                           
//#16918                if(chkok()){
//#16919                                                                           
//#16920                    deldir();                                                       
//#16921                    return 1;
//#16922                }                                                           
//#16923            }
//#16924            if(rstMap(DUBAK)){                                                               
//#16925                                                                           
//#16926                if(chkMap(THUMSHO)){                                                           
//#16927                                                                           
//#16928                    if(chkok())                                                       
//#16929                        thrsav();                                                   
//#16930                    getbak();                                                       
//#16931                    rstMap(THUMSHO);                                                       
//#16932                    return 1;                                                       
//#16933                }                                                           
//#16934                else{                                                           
//#16935                                                                           
//#16936                    if(chkok()){                                                       
//#16937                                                                           
//#16938                        ind=duth(thrnam);                                                   
//#16939                        thrnam[ind]='t';                                                   
//#16940                        setMap(IGNAM);                                                   
//#16941                        thrsav();
//#16942                        thrnam[ind]='r';                                                   
//#16943                        if(baknum)                                                   
//#16944                            filnam[ind]=baknum+0x2f;                                               
//#16945                        setMap(REDOLD);                                                   
//#16946                        nuFil();                                                   
//#16947                        filnam[ind]='r';
//#16948                        switch(baknum){                                                   
//#16949                                                                           
//#16950                        case 3:                                                   
//#16951                                                                           
//#16952                            movbak('1','2');                                               
//#16953                                                                           
//#16954                        case 2:                                                   
//#16955
//#16956                            movbak('0','1');                                               
//#16957
//#16958                        case 1:                                                   
//#16959                                                                           
//#16960                            movbak('r','0');                                               
//#16961                        }                                                   
//#16962                        movbak('t','r');                                                   
//#16963                        thrnam[ind]='t';                                                   
//#16964                        DeleteFile(thrnam);                                                   
//#16965                        thrnam[ind]='r';                                                   
//#16966                        hFil=CreateFile(thrnam,(GENERIC_WRITE|GENERIC_READ),0,NULL,                                                   
//#16967                            OPEN_EXISTING,0,NULL);                                               
//#16968                        if(hFil==INVALID_HANDLE_VALUE)                                                   
//#16969                            hFil=0;                                               
//#16970                        return 1;
//#16971                    }                                                       
//#16972                    GetWindowRect(hcan,&trct);                                                       
//#16973                    if(msg.pt.x>=trct.left&&msg.pt.x<=trct.right                                                       
//#16974                        &&msg.pt.y>=trct.top&&msg.pt.y<=trct.bottom){                                                   
//#16975                                                                           
//#16976                        getbak();
//#16977                        return 1;                                                   
//#16978                    }                                                       
//#16979                }                                                           
//#16980            }                                                               
//#16981            if(chkMap(DELFRM)){
//#16982                                                                           
//#16983                cod=0;                                                           
//#16984                if(chkok()){                                                           
//#16985                                                                           
//#16986                    savdo();                                                       
//#16987                    rstMap(DELTO);                                                       
//#16988                    cod=1;                                                       
//#16989                }
//#16990                else{                                                           
//#16991
//#16992                    GetWindowRect(hto,&trct);                                                       
//#16993                    if(msg.pt.x>=trct.left&&msg.pt.x<=trct.right                                                       
//#16994                        &&msg.pt.y>=trct.top&&msg.pt.y<=trct.bottom){                                                   
//#16995                                                                           
//#16996                        savdo();                                                   
//#16997                        setMap(DELTO);                                                   
//#16998                        cod=1;                                                   
//#16999                    }
//#17000                }                                                           
//#17001                if(cod){                                                           
//#17002                                                                           
//#17003                    frmdel();                                                       
//#17004                    coltab();                                                       
//#17005                    setMap(RESTCH);
//#17006                }                                                           
//#17007                unmsg();                                                           
//#17008                return 1;                                                           
//#17009            }                                                               
//#17010            if(chkMap(FILMSG)){                                                               
//#17011                                                                           
//#17012                if(chkok()){                                                           
//#17013                                                                           
//#17014                    savdo();                                                       
//#17015                    unfil();
//#17016                    coltab();                                                       
//#17017                    setMap(RESTCH);                                                       
//#17018                    unmsg();                                                       
//#17019                    return 1;                                                       
//#17020                }                                                           
//#17021            }                                                               
//#17022            if(rstMap(SIZSEL)){                                                               
//#17023
//#17024                if(chkMsgs(msg.pt,hSizChng[0],hSizChng[2])){                                                           
//#17025
//#17026                    vind-=13;                                                       
//#17027                    thrdSiz[thrdSel][0]=cmap[vind];                                                       
//#17028                    sizInd[thrdSel]=vind;
//#17029                    strncpy(buf,thrdSiz[thrdSel],2);                                                       
//#17030                    buf[2]=0;                                                       
//#17031                    SetWindowText(hSiz[thrdSel],buf);                                                       
//#17032                    setMap(RESTCH);                                                       
//#17033                    for(ind=0;ind<3;ind++)                                                       
//#17034                        DestroyWindow(hSizChng[ind]);
//#17035                    return 1;                                                       
//#17036                }                                                           
//#17037                else{                                                           
//#17038                                                                           
//#17039                    for(ind=0;ind<3;ind++)                                                       
//#17040                        DestroyWindow(hSizChng[ind]);                                                   
//#17041                }                                                           
//#17042            }                                                               
//#17043            if(rstMap(POLIMOV)){                                                               
//#17044                                                                           
//#17045                savdo();                                                           
//#17046                setfrm();                                                           
//#17047                return 1;                                                           
//#17048            }                                                               
//#17049            if(rstMap(FORMIN)){
//#17050                                                                           
//#17051                GetWindowRect(hMsg,&trct);                                                           
//#17052                if(msg.pt.x>=trct.left&&msg.pt.x<=trct.right                                                           
//#17053                    &&msg.pt.y>=trct.top&&msg.pt.y<=trct.bottom){                                                       
//#17054                                                                           
//#17055                    ind=(msg.pt.y-trct.top-1)/(buttonHi-4);                                                       
//#17056                    if(rstMap(FENDIN)){                                                       
//#17057
//#17058                        if(ind==3)                                                   
//#17059                            rstu(SQRFIL);
//#17060                        if(ind==4)                                                   
//#17061                            setu(SQRFIL);                                               
//#17062                    }                                                       
//#17063                    else
//#17064                        duform(ind);                                                   
//#17065                    switch(ind){                                                       
//#17066                                                                           
//#17067                    case RPOLI-1:                                                       
//#17068                    case STAR-1:                                                       
//#17069                    case SPIR-1:                                                       
//#17070                    case HART-2:                                                       
//#17071                    case LENS-2:                                                       
//#17072                    case EGG-2:                                                       
//#17073                    case ZIG-2:                                                       
//#17074                                                                           
//#17075                        return 1;                                                   
//#17076                    }                                                       
//#17077                }                                                           
//#17078                unmsg();                                                           
//#17079                return 1;                                                           
//#17080            }                                                               
//#17081            if(prfind==PAP+1&&chkMsgs(msg.pt,hDef[0],hDef[15])){                                                               
//#17082                                                                           
//#17083                sprintf(msgbuf,"%d",vind);
//#17084                apcol=vind;                                                           
//#17085                SetWindowText(thDat[PAP],msgbuf);                                                           
//#17086                unsid();                                                           
//#17087                return 1;                                                           
//#17088            }                                                               
//#17089            if(rstMap(SIDACT)){                                                               
//#17090                                                                           
//#17091                savdo();
//#17092                if(sidtyp==LFTHTYP){
//#17093
//#17094                    for(ind=0;ind<6;ind++){                                                       
//#17095                                                                           
//#17096                        if(msg.hwnd==hsidWnd[ind]){                                                   
//#17097                                                                           
//#17098                            frmpnt->dhx.fth.fthtyp=ind+1;                                               
//#17099                            refil();                                               
//#17100                            refrm();                                               
//#17101                            break;                                               
//#17102                        }                                                   
//#17103                    }                                                       
//#17104                    return 1;                                                       
//#17105                }                                                           
//#17106                if(sidtyp==LLAYR){                                                           
//#17107                                                                           
//#17108                    for(ind=0;ind<5;ind++){                                                       
//#17109                                                                           
//#17110                        if(msg.hwnd==hsidWnd[ind])                                                   
//#17111                            break;                                               
//#17112                    }                                                       
//#17113                    if(ind<5){                                                       
//#17114                                                                           
//#17115                        movlayr(ind<<1);                                                   
//#17116                        setMap(FORMSEL);                                                   
//#17117                    }
//#17118                    return 1;                                                       
//#17119                }                                                           
//#17120                frmpnt->bcol&=0xf;                                                           
//#17121                if(rstMap(BRDACT)){
//#17122                                                                           
//#17123                    if(iseclp(clofind))                                                       
//#17124                        deleclp(clofind);                                                   
//#17125                    if(msg.hwnd==hsidWnd[0]){
//#17126                                                                           
//#17127                        frmpnt->etyp=0;
//#17128                        refilfn();                                                   
//#17129                        coltab();                                                   
//#17130                        unsid();                                                   
//#17131                        setMap(RESTCH);                                                   
//#17132                        return 1;                                                   
//#17133                    }                                                       
//#17134                    if(msg.hwnd==hsidWnd[1]){                                                       
//#17135                                                                           
//#17136                        if(frmpnt->etyp){                                                   
//#17137                                                                           
//#17138                            cod=frmpnt->etyp&NEGUND;                                               
//#17139                            if(cod==EGCLP||cod==EGSAT||cod==EGAP)                                               
//#17140                                bsizpar();                                           
//#17141                            frmpnt->etyp=EGLIN;                                               
//#17142                            goto didfil;                                               
//#17143                        }                                                   
//#17144                        else{                                                   
//#17145                                                                           
//#17146                            unmsg();                                               
//#17147                            unsid();                                               
//#17148                            bord();                                               
//#17149                            return 1;                                               
//#17150                        }
//#17151                    }
//#17152                    if(msg.hwnd==hsidWnd[2]){                                                       
//#17153                                                                           
//#17154                        if(frmpnt->etyp){                                                   
//#17155                                                                           
//#17156                            cod=frmpnt->etyp&NEGUND;                                               
//#17157                            if(cod==EGCLP||cod==EGSAT||cod==EGAP)                                               
//#17158                                bsizpar();                                           
//#17159                            frmpnt->etyp=EGBLD;
//#17160                            goto didfil;                                               
//#17161                        }
//#17162                        else{                                                   
//#17163                                                                           
//#17164                            unmsg();                                               
//#17165                            unsid();                                               
//#17166                            dubold();                                               
//#17167                            return 1;                                               
//#17168                        }                                                   
//#17169                    }                                                       
//#17170                    if(msg.hwnd==hsidWnd[3]){                                                       
//#17171                                                                           
//#17172                        unmsg();                                                   
//#17173                        unsid();                                                   
//#17174                        fclp();                                                   
//#17175                        return 1;                                                   
//#17176                    }                                                       
//#17177                    if(msg.hwnd==hsidWnd[4]){                                                       
//#17178                                                                           
//#17179                        if(frmpnt->etyp){
//#17180                                                                           
//#17181                            switch(frmpnt->etyp){                                               
//#17182                                                                           
//#17183                            case EGCLP:                                               
//#17184                                                                           
//#17185                                bsizpar();
//#17186                                                                           
//#17187                            case EGLIN:                                               
//#17188                            case EGBLD:                                               
//#17189                                                                           
//#17190                                frmpnt->esiz=brdwid;                                           
//#17191                                frmpnt->espac=stspace;                                           
//#17192                                break;                                           
//#17193
//#17194                            case EGPRP:                                               
//#17195
//#17196                                frmpnt->espac/=2;                                           
//#17197                                break;                                           
//#17198                            }                                               
//#17199                            frmpnt->etyp=EGSAT;                                               
//#17200                            if(chku(DUND))                                               
//#17201                                frmpnt->etyp|=EGUND;                                           
//#17202                            goto didfil;                                               
//#17203                        }                                                   
//#17204                        else{                                                   
//#17205                                                                           
//#17206                            unmsg();                                               
//#17207                            unsid();                                               
//#17208                            satbrd();
//#17209                            return 1;                                               
//#17210                        }                                                   
//#17211                    }                                                       
//#17212                    if(msg.hwnd==hsidWnd[5]){                                                       
//#17213                                                                           
//#17214                        if(frmpnt->ftyp){                                                   
//#17215                                                                           
//#17216                            delmfil(frmpnt->fcol);                                               
//#17217                            frmpnt->ftyp=0;                                               
//#17218                        }                                                   
//#17219                        if(frmpnt->etyp){
//#17220                                                                           
//#17221                            if(frmpnt->etyp==EGLIN||frmpnt->etyp==EGBLD||frmpnt->etyp==EGCLP){                                               
//#17222                                                                           
//#17223                                frmpnt->esiz=brdwid;                                           
//#17224                                frmpnt->espac=stspace;                                           
//#17225                                if(frmpnt->etyp==EGCLP)                                           
//#17226                                    bsizpar();                                       
//#17227                            }
//#17228                            frmpnt->etyp=EGAP;                                               
//#17229                            if(chku(DUND))
//#17230                                frmpnt->etyp|=EGUND;                                           
//#17231                            frmpnt->bcol|=(apcol<<4);                                               
//#17232                            goto didfil;                                               
//#17233                        }                                                   
//#17234                        else{                                                   
//#17235                                                                           
//#17236                            unmsg();                                               
//#17237                            unsid();
//#17238                            apliq();                                               
//#17239                            return 1;                                               
//#17240                        }                                                   
//#17241                    }                                                       
//#17242                    if(msg.hwnd==hsidWnd[6]){                                                       
//#17243                                                                           
//#17244                        if(frmpnt->etyp){                                                   
//#17245                                                                           
//#17246                            switch(frmpnt->etyp){                                               
//#17247                                                                           
//#17248                            case EGCLP:                                               
//#17249                                                                           
//#17250                                bsizpar();                                           
//#17251                            case EGLIN:                                               
//#17252                            case EGBLD:                                               
//#17253
//#17254                                frmpnt->esiz=brdwid;                                           
//#17255                                frmpnt->espac=stspace;                                           
//#17256                                break;                                           
//#17257                                                                           
//#17258                            case EGSAT:                                               
//#17259                                                                           
//#17260                                frmpnt->espac*=2;                                           
//#17261                            }
//#17262                            frmpnt->etyp=EGPRP;                                               
//#17263                            if(chku(DUND))
//#17264                                frmpnt->etyp|=EGUND;                                           
//#17265                            goto didfil;                                               
//#17266                        }
//#17267                        else{                                                   
//#17268                                                                           
//#17269                            unmsg();                                               
//#17270                            unsid();                                               
//#17271                            prpbrd(stspace);                                               
//#17272                            return 1;                                               
//#17273                        }                                                   
//#17274                    }                                                       
//#17275                    if(msg.hwnd==hsidWnd[7]){                                                       
//#17276                                                                           
//#17277                        if(frmpnt->etyp){                                                   
//#17278                                                                           
//#17279                            if(frmpnt->etyp==EGLIN||frmpnt->etyp==EGBLD||frmpnt->etyp==EGCLP){                                               
//#17280                                                                           
//#17281                                frmpnt->esiz=brdwid;                                           
//#17282                                frmpnt->espac=stspace;                                           
//#17283                                if(frmpnt->etyp==EGCLP)                                           
//#17284                                    bsizpar();                                       
//#17285                            }                                               
//#17286                            frmpnt->etyp=EGHOL;                                               
//#17287                            goto didfil;
//#17288                        }                                                   
//#17289                        else{                                                   
//#17290                                                                           
//#17291                            unmsg();                                               
//#17292                            unsid();                                               
//#17293                            bhol();                                               
//#17294                            return 1;                                               
//#17295                        }
//#17296                    }                                                       
//#17297                    if(msg.hwnd==hsidWnd[8]){
//#17298                                                                           
//#17299                        if(frmpnt->etyp){                                                   
//#17300                                                                           
//#17301                            if(frmpnt->etyp==EGLIN||frmpnt->etyp==EGBLD||frmpnt->etyp==EGCLP){                                               
//#17302                                                                           
//#17303                                frmpnt->esiz=brdwid;                                           
//#17304                                frmpnt->espac=stspace;                                           
//#17305                                if(frmpnt->etyp==EGCLP)                                           
//#17306                                    bsizpar();                                       
//#17307                            }                                               
//#17308                            picot();                                               
//#17309                            goto didfil;                                               
//#17310                        }                                                   
//#17311                        else{                                                   
//#17312                                                                           
//#17313                            unmsg();                                               
//#17314                            unsid();                                               
//#17315                            picot();                                               
//#17316                            return 1;                                               
//#17317                        }                                                   
//#17318                    }                                                       
//#17319                    if(msg.hwnd==hsidWnd[9]){                                                       
//#17320                                                                           
//#17321                        if(frmpnt->etyp){
//#17322                                                                           
//#17323                            cod=frmpnt->etyp&NEGUND;                                               
//#17324                            if(cod==EGCLP||cod==EGSAT||cod==EGAP)
//#17325                                bsizpar();                                           
//#17326                            frmpnt->etyp=EGDUB;                                               
//#17327                            goto didfil;                                               
//#17328                        }                                                   
//#17329                        else{
//#17330                                                                           
//#17331                            unmsg();
//#17332                            unsid();                                               
//#17333                            dubsfil();                                               
//#17334                            return 1;                                               
//#17335                        }                                                   
//#17336                    }                                                       
//#17337                    if(msg.hwnd==hsidWnd[10]){                                                       
//#17338                                                                           
//#17339                        setMap(LINCHN);                                                   
//#17340                        unmsg();                                                   
//#17341                        unsid();                                                   
//#17342                        chan();                                                   
//#17343                        coltab();                                                   
//#17344                        setMap(RESTCH);                                                   
//#17345                        return 1;                                                   
//#17346                    }                                                       
//#17347                    if(msg.hwnd==hsidWnd[11]){                                                       
//#17348                                                                           
//#17349                        rstMap(LINCHN);                                                   
//#17350                        unmsg();                                                   
//#17351                        unsid();                                                   
//#17352                        chan();                                                   
//#17353                        coltab();
//#17354                        setMap(RESTCH);                                                   
//#17355                        return 1;
//#17356                    }                                                       
//#17357                    if(msg.hwnd==hsidWnd[12]){                                                       
//#17358                                                                           
//#17359                        unmsg();                                                   
//#17360                        unsid();                                                   
//#17361                        filclpx();                                                   
//#17362                        return 1;                                                   
//#17363                    }
//#17364                }                                                           
//#17365                else{
//#17366                                                                           
//#17367                    if(frmpnt->ftyp==SAT&&frmpnt->stpt)                                                       
//#17368                        delsac(clofind);                                                   
//#17369                    if((frmpnt->etyp&NEGUND)==EGAP){                                                       
//#17370                                                                           
//#17371                        frmpnt->etyp=EGSAT;                                                   
//#17372                        if(chku(DUND))                                                   
//#17373                            frmpnt->etyp|=EGUND;                                               
//#17374                    }                                                       
//#17375                    if(msg.hwnd==hsidWnd[0]){                                                       
//#17376                                                                           
//#17377                        frmpnt->typ=POLI;                                                   
//#17378                        delmfil(frmpnt->fcol);                                                   
//#17379                        frmpnt->ftyp=0;                                                   
//#17380                        coltab();                                                   
//#17381                        unsid();                                                   
//#17382                        setMap(RESTCH);
//#17383                        return 1;                                                   
//#17384                    }                                                       
//#17385                    if(msg.hwnd==hsidWnd[1]){                                                       
//#17386                                                                           
//#17387                        savdo();                                                   
//#17388                        frmpnt->typ=POLI;                                                   
//#17389                        if(frmpnt->ftyp){
//#17390                                                                           
//#17391                            respac();                                               
//#17392                            frmpnt->ftyp=VRTF;                                               
//#17393                            frmpnt->typ=POLI;                                               
//#17394                            goto didfil;                                               
//#17395                        }                                                   
//#17396                        else{                                                   
//#17397
//#17398                            unmsg();                                               
//#17399                            unsid();
//#17400                            filvrt();                                               
//#17401                            return 1;                                               
//#17402                        }                                                   
//#17403                    }                                                       
//#17404                    if(msg.hwnd==hsidWnd[2]){                                                       
//#17405                                                                           
//#17406                        frmpnt->typ=POLI;                                                   
//#17407                        if(frmpnt->ftyp){                                                   
//#17408                                                                           
//#17409                            respac();                                               
//#17410                            frmpnt->ftyp=HORF;                                               
//#17411                            goto didfil;
//#17412                        }                                                   
//#17413                        else{                                                   
//#17414                                                                           
//#17415                            unmsg();                                               
//#17416                            unsid();                                               
//#17417                            filhor();                                               
//#17418                            return 1;                                               
//#17419                        }                                                   
//#17420                    }                                                       
//#17421                    if(msg.hwnd==hsidWnd[3]){                                                       
//#17422                                                                           
//#17423                        frmpnt->typ=POLI;
//#17424                        if(frmpnt->ftyp){                                                   
//#17425                                                                           
//#17426                            respac();                                               
//#17427                            frmpnt->ftyp=ANGF;                                               
//#17428                            frmpnt->angclp.fang=ini.angl;                                               
//#17429                            goto didfil;                                               
//#17430                        }                                                   
//#17431                        else{
//#17432                                                                           
//#17433                            unmsg();
//#17434                            unsid();                                               
//#17435                            filangl();                                               
//#17436                            return 1;                                               
//#17437                        }                                                   
//#17438                    }                                                       
//#17439                    if(msg.hwnd==hsidWnd[4]){                                                       
//#17440
//#17441                        frmpnt->typ=SAT;                                                   
//#17442                        if(frmpnt->ftyp){                                                   
//#17443                                                                           
//#17444                            respac();                                               
//#17445                            frmpnt->ftyp=SATF;                                               
//#17446                            goto didfil;                                               
//#17447                        }                                                   
//#17448                        else{                                                   
//#17449                                                                           
//#17450                            unmsg();                                               
//#17451                            unsid();                                               
//#17452                            rstMap(FTHR);                                               
//#17453                            filsat();                                               
//#17454                            return 1;                                               
//#17455                        }                                                   
//#17456                    }                                                       
//#17457                    if(msg.hwnd==hsidWnd[5]){
//#17458                                                                           
//#17459                        frmpnt->typ=SAT;                                                   
//#17460                        unmsg();                                                   
//#17461                        unsid();                                                   
//#17462                        clpfil();                                                   
//#17463                        return 1;                                                   
//#17464                    }                                                       
//#17465                    if(msg.hwnd==hsidWnd[6]){
//#17466                                                                           
//#17467                        if(frmpnt->ftyp){
//#17468                                                                           
//#17469                            if(frmpnt->ftyp==CLPF)
//#17470                                frmpnt->fspac=stspace;                                           
//#17471                            chkcont();                                               
//#17472                            goto didfil;                                               
//#17473                        }                                                   
//#17474                        else{                                                   
//#17475                                                                           
//#17476                            unmsg();                                               
//#17477                            unsid();                                               
//#17478                            contfil();                                               
//#17479                            return 1;                                               
//#17480                        }                                                   
//#17481                    }                                                       
//#17482                    if(msg.hwnd==hsidWnd[7]){                                                       
//#17483                                                                           
//#17484                        unmsg();                                                   
//#17485                        unsid();                                                   
//#17486                        if(sidclp())                                                   
//#17487                            vrtsclp();                                               
//#17488                        rstMap(CLPSHO);                                                   
//#17489                        coltab();                                                   
//#17490                        setMap(RESTCH);                                                   
//#17491                        return 1;
//#17492                    }                                                       
//#17493                    if(msg.hwnd==hsidWnd[8]){                                                       
//#17494                                                                           
//#17495                        unmsg();                                                   
//#17496                        unsid();                                                   
//#17497                        if(sidclp())                                                   
//#17498                            horsclp();
//#17499                        rstMap(CLPSHO);
//#17500                        coltab();                                                   
//#17501                        setMap(RESTCH);
//#17502                        return 1;                                                   
//#17503                    }                                                       
//#17504                    if(msg.hwnd==hsidWnd[9]){                                                       
//#17505                                                                           
//#17506                        unmsg();                                                   
//#17507                        unsid();                                                   
//#17508                        if(sidclp())                                                   
//#17509                            angsclp();                                               
//#17510                        rstMap(CLPSHO);                                                   
//#17511                        coltab();                                                   
//#17512                        setMap(RESTCH);                                                   
//#17513                        return 1;                                                   
//#17514                    }                                                       
//#17515                    if(msg.hwnd==hsidWnd[10]){                                                       
//#17516                                                                           
//#17517                        unmsg();                                                   
//#17518                        unsid();                                                   
//#17519                        if(frmpnt->ftyp==FTHF){                                                   
//#17520                                                                           
//#17521                            fthrfn();                                               
//#17522                            fritfil();                                               
//#17523                        }                                                   
//#17524                        else                                                   
//#17525                            fethrf();
//#17526                        setMap(INIT);                                                   
//#17527                        coltab();
//#17528                        setMap(RESTCH);                                                   
//#17529                        return 1;                                                   
//#17530                    }                                                       
//#17531                    if(msg.hwnd==hsidWnd[11])    //vertical texture                                                   
//#17532                    {                                                       
//#17533                        if(istx(clofind))
//#17534                        {                                                   
//#17535                            frmpnt->ftyp=TXVRTF;
//#17536                            goto didfil;                                               
//#17537                        }                                                   
//#17538                        dutxtfil();                                                   
//#17539                    }                                                       
//#17540                    if(msg.hwnd==hsidWnd[12])    //horizontal texture                                                   
//#17541                    {                                                       
//#17542                        if(istx(clofind))                                                   
//#17543                        {                                                   
//#17544                            frmpnt->ftyp=TXHORF;                                               
//#17545                            goto didfil;                                               
//#17546                        }                                                   
//#17547                        dutxtfil();                                                   
//#17548                    }                                                       
//#17549                    if(msg.hwnd==hsidWnd[13])    //angle texture                                                   
//#17550                    {                                                       
//#17551                        if(istx(clofind))                                                   
//#17552                        {                                                   
//#17553                            frmpnt->ftyp=TXANGF;                                               
//#17554                            frmpnt->angclp.fang=ini.angl;                                               
//#17555                            goto didfil;                                               
//#17556                        }
//#17557                        dutxtfil();                                                   
//#17558                    }                                                       
//#17559    didfil:;
//#17560                    refrm();                                                       
//#17561                    refil();                                                       
//#17562                    unsid();                                                       
//#17563                    setMap(RESTCH);                                                       
//#17564                    return 1;                                                       
//#17565                }                                                           
//#17566            }                                                               
//#17567            if(hfdat){
//#17568                                                                           
//#17569                chknum();
//#17570                unsid();                                                           
//#17571                if(msg.hwnd==thDat[LTXOF])                                                           
//#17572                {                                                           
//#17573                    sidtyp=LTXOF;                                                       
//#17574                    sidwnd(thDat[LTXOF]);                                                       
//#17575                    goto didat;                                                       
//#17576                }                                                           
//#17577                if(msg.hwnd==thDat[LUSPAC])                                                           
//#17578                {                                                           
//#17579                    sidtyp=LUSPAC;                                                       
//#17580                    sidwnd(thDat[LUSPAC]);                                                       
//#17581                    goto didat;                                                       
//#17582                }                                                           
//#17583                if(msg.hwnd==thDat[LUANG])                                                           
//#17584                {                                                           
//#17585                    sidtyp=LUANG;
//#17586                    sidwnd(thDat[LUANG]);                                                       
//#17587                    goto didat;                                                       
//#17588                }                                                           
//#17589                if(msg.hwnd==thDat[LULEN])                                                           
//#17590                {                                                           
//#17591                    sidtyp=LULEN;                                                       
//#17592                    sidwnd(thDat[LULEN]);                                                       
//#17593                    goto didat;
//#17594                }                                                           
//#17595                if(msg.hwnd==thDat[LWLKIND])                                                           
//#17596                {                                                           
//#17597                    sidtyp=LWLKIND;                                                       
//#17598                    sidwnd(thDat[LWLKIND]);                                                       
//#17599                    goto didat;                                                       
//#17600                }                                                           
//#17601                if(msg.hwnd==thDat[LFTHSIZ]){
//#17602                                                                           
//#17603                    sidtyp=LFTHSIZ;
//#17604                    sidwnd(thDat[LFTHSIZ]);                                                       
//#17605                    goto didat;                                                       
//#17606                }                                                           
//#17607                if(msg.hwnd==thDat[LFTHNUM]){                                                           
//#17608                                                                           
//#17609                    sidtyp=LFTHNUM;                                                       
//#17610                    sidwnd(thDat[LFTHNUM]);                                                       
//#17611                    goto didat;                                                       
//#17612                }                                                           
//#17613                if(msg.hwnd==thDat[LFTHFLR]){                                                           
//#17614
//#17615                    sidtyp=LFTHFLR;                                                       
//#17616                    sidwnd(thDat[LFTHFLR]);                                                       
//#17617                    goto didat;                                                       
//#17618                }                                                           
//#17619                if(msg.hwnd==thDat[LFTHUPCNT]){                                                           
//#17620                                                                           
//#17621                    sidtyp=LFTHUPCNT;                                                       
//#17622                    sidwnd(thDat[LFTHUPCNT]);                                                       
//#17623                    goto didat;                                                       
//#17624                }                                                           
//#17625                if(msg.hwnd==thDat[LFTHDWNCNT]){                                                           
//#17626                                                                           
//#17627                    sidtyp=LFTHDWNCNT;
//#17628                    sidwnd(thDat[LFTHDWNCNT]);                                                       
//#17629                    goto didat;                                                       
//#17630                }                                                           
//#17631                if(msg.hwnd==thDat[LFTHBLND]){                                                           
//#17632                                                                           
//#17633                    setMap(FLPBLND);                                                       
//#17634                    goto didfil;                                                       
//#17635                }
//#17636                if(msg.hwnd==thDat[LFTHUP]){                                                           
//#17637
//#17638                    frmpnt->xat^=AT_FTHUP;                                                       
//#17639                    goto didfil;                                                       
//#17640                }                                                           
//#17641                if(msg.hwnd==thDat[LFTHDWN]){                                                           
//#17642                                                                           
//#17643                    frmpnt->xat^=AT_FTHDWN;
//#17644                    goto didfil;                                                       
//#17645                }                                                           
//#17646                if(msg.hwnd==thDat[LFTHTYP]){                                                           
//#17647                                                                           
//#17648                    sidtyp=LFTHTYP;                                                       
//#17649                    sidmsg(thDat[LFTHTYP],&stab[STR_FTH0],6);                                                       
//#17650                    goto didat;                                                       
//#17651                }                                                           
//#17652                if(msg.hwnd==thDat[LFRM]){                                                           
//#17653                                                                           
//#17654                    savdo();                                                       
//#17655                    unfil();                                                       
//#17656                    if(frmpnt->typ==LIN)                                                       
//#17657                        frmpnt->typ=POLI;                                                   
//#17658                    else                                                       
//#17659                        frmpnt->typ=LIN;                                                   
//#17660                    coltab();                                                       
//#17661                    delsac(clofind);
//#17662                    setMap(RESTCH);                                                       
//#17663                    goto didat;                                                       
//#17664                }                                                           
//#17665                if(msg.hwnd==thDat[LLAYR]){                                                           
//#17666                                                                           
//#17667                    sidtyp=LLAYR;                                                       
//#17668                    rstMap(FILTYP);                                                       
//#17669                    sidmsg(thDat[LLAYR],laytxt,5);
//#17670                    goto didat;                                                       
//#17671                }
//#17672                if(msg.hwnd==thDat[LFRMFIL]){
//#17673                                                                           
//#17674                    rstMap(FILTYP);                                                       
//#17675                    sidtyp=LFRMFIL;                                                       
//#17676                    sidmsg(thDat[LFRMFIL],&stab[STR_FIL0],14);                                                       
//#17677                    goto didat;                                                       
//#17678                }                                                           
//#17679                if(msg.hwnd==thDat[LFRMCOL]){                                                           
//#17680                                                                           
//#17681                    sidtyp=LFRMCOL;                                                       
//#17682                    sidwnd(thDat[LFRMCOL]);                                                       
//#17683                    setMap(SIDCOL);                                                       
//#17684                    goto didat;                                                       
//#17685                }                                                           
//#17686                if(msg.hwnd==thDat[LUNDCOL]){                                                           
//#17687                                                                           
//#17688                    sidtyp=LUNDCOL;                                                       
//#17689                    sidwnd(thDat[LUNDCOL]);                                                       
//#17690                    setMap(SIDCOL);                                                       
//#17691                    setMap(UNDCOL);                                                       
//#17692                    goto didat;                                                       
//#17693                }                                                           
//#17694                if(msg.hwnd==thDat[LFTHCOL]){                                                           
//#17695
//#17696                    sidtyp=LFTHCOL;                                                       
//#17697                    sidwnd(thDat[LFTHCOL]);                                                       
//#17698                    setMap(SIDCOL);                                                       
//#17699                    setMap(FTHSID);                                                       
//#17700                    goto didat;                                                       
//#17701                }
//#17702                if(msg.hwnd==thDat[LFRMSPAC]){                                                           
//#17703
//#17704                    sidtyp=LFRMSPAC;                                                       
//#17705                    sidwnd(thDat[LFRMSPAC]);
//#17706                    goto didat;                                                       
//#17707                }                                                           
//#17708                if(msg.hwnd==thDat[LFRMLEN]){                                                           
//#17709                                                                           
//#17710                    sidtyp=LFRMLEN;                                                       
//#17711                    sidwnd(thDat[LFRMLEN]);                                                       
//#17712                    goto didat;                                                       
//#17713                }                                                           
//#17714                if(msg.hwnd==thDat[LBRD]){                                                           
//#17715                                                                           
//#17716                    setMap(FILTYP);                                                       
//#17717                    sidmsg(thDat[LBRD],&stab[STR_EDG0],EDGETYPS+1);                                                       
//#17718                    setMap(BRDACT);                                                       
//#17719                    goto didat;                                                       
//#17720                }                                                           
//#17721                if(msg.hwnd==thDat[LBRDCOL]){                                                           
//#17722                                                                           
//#17723                    sidtyp=LBRDCOL;                                                       
//#17724                    sidwnd(thDat[LBRDCOL]);                                                       
//#17725                    setMap(SIDCOL);                                                       
//#17726                    setMap(BRDSID);                                                       
//#17727                    goto didat;                                                       
//#17728                }                                                           
//#17729                if(msg.hwnd==thDat[LBRDSPAC]){
//#17730
//#17731                    sidtyp=LBRDSPAC;                                                       
//#17732                    sidwnd(thDat[LBRDSPAC]);                                                       
//#17733                    goto didat;                                                       
//#17734                }                                                           
//#17735                if(msg.hwnd==thDat[LBRDLEN]){                                                           
//#17736                                                                           
//#17737                    sidtyp=LBRDLEN;
//#17738                    sidwnd(thDat[LBRDLEN]);                                                       
//#17739                    goto didat;
//#17740                }                                                           
//#17741                if(msg.hwnd==thDat[LBRDSIZ]){                                                           
//#17742                                                                           
//#17743                    sidtyp=LBRDSIZ;                                                       
//#17744                    sidwnd(thDat[LBRDSIZ]);                                                       
//#17745                    goto didat;                                                       
//#17746                }                                                           
//#17747                if(msg.hwnd==thDat[LAPCOL]){                                                           
//#17748                                                                           
//#17749                    sidtyp=LAPCOL;                                                       
//#17750                    setMap(SIDCOL);                                                       
//#17751                    setMap(APSID);                                                       
//#17752                    sidwnd(thDat[LAPCOL]);                                                       
//#17753                    goto didat;                                                       
//#17754                }                                                           
//#17755                if(msg.hwnd==thDat[LBCSIZ]){                                                           
//#17756                                                                           
//#17757                    sidtyp=LBCSIZ;                                                       
//#17758                    sidwnd(thDat[LBCSIZ]);                                                       
//#17759                    goto didat;
//#17760                }                                                           
//#17761                if(msg.hwnd==thDat[LBSTRT]){                                                           
//#17762                                                                           
//#17763                    cod=frmpnt->at&SBLNT;
//#17764                    if(cod)                                                       
//#17765                        frmpnt->at&=NSBLNT;                                                   
//#17766                    else                                                       
//#17767                        frmpnt->at|=SBLNT;                                                   
//#17768                    refil();                                                       
//#17769                    coltab();                                                       
//#17770                    setMap(RESTCH);                                                       
//#17771                    return 1;
//#17772                }                                                           
//#17773                if(msg.hwnd==thDat[LBFIN]){
//#17774                                                                           
//#17775                    cod=frmpnt->at&FBLNT;                                                       
//#17776                    if(cod)                                                       
//#17777                        frmpnt->at&=NFBLNT;                                                   
//#17778                    else                                                       
//#17779                        frmpnt->at|=FBLNT;                                                   
//#17780                    refil();                                                       
//#17781                    coltab();                                                       
//#17782                    setMap(RESTCH);                                                       
//#17783                    return 1;                                                       
//#17784                }                                                           
//#17785                if(msg.hwnd==thDat[LFRMANG]){                                                           
//#17786                                                                           
//#17787                    sidtyp=LFRMANG;                                                       
//#17788                    sidwnd(thDat[LFRMANG]);
//#17789                    goto didat;                                                       
//#17790                }                                                           
//#17791                if(msg.hwnd==thDat[LBRDPIC]){                                                           
//#17792                                                                           
//#17793                    sidtyp=LBRDPIC;                                                       
//#17794                    sidwnd(thDat[LBRDPIC]);                                                       
//#17795                    goto didat;                                                       
//#17796                }                                                           
//#17797                if(msg.hwnd==thDat[LBRDUND]){
//#17798                                                                           
//#17799                    frmpnt->etyp^=EGUND;                                                       
//#17800                    refil();                                                       
//#17801                    goto didat;                                                       
//#17802                }                                                           
//#17803                if(msg.hwnd==thDat[LSACANG]){                                                           
//#17804                                                                           
//#17805                    sidtyp=LSACANG;
//#17806                    sidwnd(thDat[LSACANG]);                                                       
//#17807                    goto didat;
//#17808                }                                                           
//#17809                if(msg.hwnd==thDat[LFRMFAZ]){                                                           
//#17810                                                                           
//#17811                    sidtyp=LFRMFAZ;                                                       
//#17812                    sidwnd(thDat[LFRMFAZ]);                                                       
//#17813                    goto didat;                                                       
//#17814                }                                                           
//#17815                if(msg.hwnd==thDat[LBRDPOS]){                                                           
//#17816                                                                           
//#17817                    sidtyp=LBRDPOS;
//#17818                    sidwnd(thDat[LBRDPOS]);                                                       
//#17819                    goto didat;                                                       
//#17820                }                                                           
//#17821                if(msg.hwnd==thDat[LBFILSQR]){                                                           
//#17822                                                                           
//#17823                    dubit(AT_SQR);                                                       
//#17824                    return 1;                                                       
//#17825                }                                                           
//#17826                if(msg.hwnd==thDat[LFSTRT]){                                                           
//#17827                                                                           
//#17828                    dubit(AT_STRT);                                                       
//#17829                    return 1;                                                       
//#17830                }                                                           
//#17831                if(msg.hwnd==thDat[LDSTRT])
//#17832                {                                                           
//#17833                    sidtyp=LDSTRT;                                                       
//#17834                    sidwnd(thDat[LDSTRT]);                                                       
//#17835                    goto didat;                                                       
//#17836                }                                                           
//#17837                if(msg.hwnd==thDat[LFEND]){                                                           
//#17838                                                                           
//#17839                    dubit(AT_END);
//#17840                    return 1;                                                       
//#17841                }
//#17842                if(msg.hwnd==thDat[LDEND])                                                           
//#17843                {                                                           
//#17844                    sidtyp=LDEND;                                                       
//#17845                    sidwnd(thDat[LDEND]);                                                       
//#17846                    goto didat;
//#17847                }                                                           
//#17848                if(msg.hwnd==thDat[LWALK])                                                           
//#17849                {                                                           
//#17850                    dubit(AT_WALK);                                                       
//#17851                    return 1;                                                       
//#17852                }                                                           
//#17853                if(msg.hwnd==thDat[LCWLK])                                                           
//#17854                {                                                           
//#17855                    dubit(AT_CWLK);                                                       
//#17856                    return 1;                                                       
//#17857                }                                                           
//#17858                if(msg.hwnd==thDat[LUND])                                                           
//#17859                {                                                           
//#17860                    dubit(AT_UND);                                                       
//#17861                    return 1;                                                       
//#17862                }                                                           
//#17863                if(msg.hwnd==thDat[LMAXFIL]){                                                           
//#17864                                                                           
//#17865                    sidtyp=LMAXFIL;
//#17866                    sidwnd(thDat[LMAXFIL]);                                                       
//#17867                    goto didat;                                                       
//#17868                }                                                           
//#17869                if(msg.hwnd==thDat[LMINFIL]){                                                           
//#17870                                                                           
//#17871                    sidtyp=LMINFIL;                                                       
//#17872                    sidwnd(thDat[LMINFIL]);                                                       
//#17873                    goto didat;
//#17874                }                                                           
//#17875                if(msg.hwnd==thDat[LMAXBRD]){
//#17876                                                                           
//#17877                    sidtyp=LMAXBRD;                                                       
//#17878                    sidwnd(thDat[LMAXBRD]);                                                       
//#17879                    goto didat;                                                       
//#17880                }                                                           
//#17881                if(msg.hwnd==thDat[LMINBRD]){                                                           
//#17882                                                                           
//#17883                    sidtyp=LMINBRD;                                                       
//#17884                    sidwnd(thDat[LMINBRD]);                                                       
//#17885                    goto didat;                                                       
//#17886                }                                                           
//#17887                undat();                                                           
//#17888                goto didskip;                                                           
//#17889    didat:;                                                                       
//#17890                return 1;                                                           
//#17891    didskip:;                                                                       
//#17892            }                                                               
//#17893            if(chkMap(INSFRM)){                                                               
//#17894                                                                           
//#17895                savdo();                                                           
//#17896                setins();                                                           
//#17897                return 1;                                                           
//#17898            }                                                               
//#17899            if(chkMap(FUNCLP)){
//#17900                                                                           
//#17901                savdo();                                                           
//#17902                formpnt++;                                                           
//#17903                setMap(INIT);                                                           
//#17904                rstfrm();
//#17905                fvars(clofind);                                                           
//#17906                refil();                                                           
//#17907                rstMap(FUNCLP);
//#17908                if(rstMap(FPSEL))                                                           
//#17909                    frmout(formpnt-1);
//#17910                setMap(RESTCH);                                                           
//#17911                return 1;                                                           
//#17912            }                                                               
//#17913            if(chkMap(SATCNKT)){                                                               
//#17914                                                                           
//#17915                savdo();                                                           
//#17916                satknkt();                                                           
//#17917                return 1;                                                           
//#17918            }                                                               
//#17919            if(chkMap(SATPNT)){                                                               
//#17920                                                                           
//#17921                satpnt1();                                                           
//#17922                return 1;                                                           
//#17923            }                                                               
//#17924            if(rstMap(SATIN)){                                                               
//#17925                                                                           
//#17926                satpnt0();                                                           
//#17927                return 1;                                                           
//#17928            }                                                               
//#17929            if(chkMap(FORMSEL)){                                                               
//#17930                                                                           
//#17931                if(!chkMap(FRMROT)&&chkfrm())                                                           
//#17932                    return 1;                                                       
//#17933            }
//#17934            if(rstMap(MOVFRM)){                                                               
//#17935                                                                           
//#17936                savdo();                                                           
//#17937                setfrm();                                                           
//#17938                return 1;                                                           
//#17939            }                                                               
//#17940            unmsg();                                                               
//#17941            if(px2stch()&&!(chkMap(SIZSEL)&&chkMsgs(msg.pt,hSizChng[0],hSizChng[2]))){
//#17942                                                                           
//#17943                unpat();
//#17944                if(rstMap(ROTAT)){                                                           
//#17945                                                                           
//#17946                    rlinu[1].x=msg.pt.x-stOrg.x;                                                       
//#17947                    rlinu[1].y=msg.pt.y-stOrg.y;                                                       
//#17948                    padj.x=rlinu[0].x-rlinu[1].x;                                                       
//#17949                    padj.y=rlinu[0].y-rlinu[1].y;                                                       
//#17950                    if(hypot(padj.x,padj.y)<CLOSENUF){                                                       
//#17951                                                                           
//#17952                        px2stch();                                                   
//#17953                        rotcntr.x=sPnt.x;                                                   
//#17954                        rotcntr.y=sPnt.y;                                                   
//#17955                        setMap(MOVCNTR);                                                   
//#17956                        unrot();                                                   
//#17957                        ritrot();                                                   
//#17958                    }                                                       
//#17959                    else{                                                       
//#17960                                                                           
//#17961                        if(padj.x)                                                   
//#17962                            hang=-atan2(padj.y,padj.x);
//#17963                        else{                                                   
//#17964                                                                           
//#17965                            if(padj.y>0)                                               
//#17966                                hang=PI/2;                                           
//#17967                            else
//#17968                                hang=-PI/2;                                           
//#17969                        }                                                   
//#17970                        setMap(ROTUSHO);                                                   
//#17971                        durotu();                                                   
//#17972                        setMap(ROTCAPT);                                                   
//#17973                    }                                                       
//#17974                    return 1;                                                       
//#17975                }
//#17976                if(rstMap(CLPSHO)){                                                           
//#17977
//#17978                    savdo();                                                       
//#17979                    if((rstMap(SELBOX)||rstMap(INSRT))&&cloInd!=(unsigned)hed.stchs-1)                                                       
//#17980                        lodclp(cloInd);                                                   
//#17981                    else                                                       
//#17982                        lodclp(hed.stchs);                                                   
//#17983                    rngadj();                                                       
//#17984                    selRct(&tbig);                                                       
//#17985                    rctlin[0].x=rctlin[6].x=rctlin[7].x=rctlin[8].x=trct.left;                                                       
//#17986                    rctlin[1].x=rctlin[5].x=midl(trct.right,trct.left);                                                       
//#17987                    rctlin[0].y=rctlin[1].y=rctlin[2].y=rctlin[8].y=trct.top;                                                       
//#17988                    rctlin[3].y=rctlin[7].y=midl(trct.top,trct.bottom);                                                       
//#17989                    rctlin[4].y=rctlin[5].y=rctlin[6].y=trct.bottom;                                                       
//#17990                    rctlin[2].x=rctlin[3].x=rctlin[4].x=trct.right;                                                       
//#17991                    coltab();
//#17992                    setMap(RESTCH);                                                       
//#17993                    return 1;                                                       
//#17994                }                                                           
//#17995                if(rstMap(BOXZUM)){                                                           
//#17996                                                                           
//#17997                    setMap(BZUMIN);                                                       
//#17998                    blin[0].x=blin[3].x=blin[4].x=msg.pt.x-stOrg.x;                                                       
//#17999                    blin[0].y=blin[1].y=msg.pt.y-stOrg.y;                                                       
//#18000                    blin[4].y=blin[0].y-1;                                                       
//#18001                    px2stch();
//#18002                    zBoxo.x=sPnt.x;                                                       
//#18003                    zBoxo.y=sPnt.y;                                                       
//#18004                    setMap(VCAPT);                                                       
//#18005                    return 1;                                                       
//#18006                }                                                           
//#18007                if(formpnt&&!chkMap(FRMOF)){                                                           
//#18008                                                                           
//#18009                    if(!chkMap(INSRT)){
//#18010                                                                           
//#18011                        if(rstMap(FORMSEL))
//#18012                            ritfrct(clofind,rsdc);                                               
//#18013                        if(closfrm()){                                                   
//#18014                                                                           
//#18015                            setMap(FRMPMOV);                                               
//#18016                            fvars(clofind);                                               
//#18017                            frmovlin();                                               
//#18018                            return 1;                                               
//#18019                        }                                                   
//#18020                    }
//#18021                }                                                           
//#18022                if(chkMap(INIT)){                                                           
//#18023                                                                           
//#18024                    unlin();                                                       
//#18025                    savdo();                                                       
//#18026                    if(chkMap(INSRT)&&hed.stchs<MAXSEQ){                                                       
//#18027                                                                           
//#18028                        px2stch();                                                   
//#18029                        cod=(actcol|USMSK|(actl<<LAYSHFT)|NOTFRM)&NKNOTMSK;                                                   
//#18030                        if(chkMap(LIN1)){                                                   
//#18031                                                                           
//#18032                            if(chkMap(BAKEND)){                                               
//#18033                                                                           
//#18034                                xlin1();                                           
//#18035                                ind=hed.stchs;
//#18036                                stchs[ind].x=sPnt.x;                                           
//#18037                                stchs[ind].y=sPnt.y;                                           
//#18038                                stchs[ind].at=cod;                                           
//#18039                                duzrat();                                           
//#18040                                stch2px1(ind);                                           
//#18041                                inlin[0].x=pPnt.x;                                           
//#18042                                inlin[0].y=pPnt.y;                                           
//#18043                                inlin[1].x=msg.pt.x-stOrg.x;
//#18044                                inlin[1].y=msg.pt.y-stOrg.y;                                           
//#18045                                hed.stchs++;
//#18046                                coltab();                                           
//#18047                                setMap(RESTCH);                                           
//#18048                                return 1;                                           
//#18049                            }
//#18050                            else{                                               
//#18051                                                                           
//#18052                                xlin1();                                           
//#18053                                for(ind=hed.stchs;ind;ind--){                                           
//#18054                                                                           
//#18055                                    stchs[ind].at=stchs[ind-1].at;                                       
//#18056                                    stchs[ind].x=stchs[ind-1].x;                                       
//#18057                                    stchs[ind].y=stchs[ind-1].y;                                       
//#18058                                }                                           
//#18059                                stchs[0].at=cod;                                           
//#18060                                stchs[ind].at&=(~KNOTMSK);                                           
//#18061                                stchs[0].x=sPnt.x;                                           
//#18062                                stchs[0].y=sPnt.y;                                           
//#18063                                stch2px1(ind);                                           
//#18064                                inlin[0].x=pPnt.x;                                           
//#18065                                inlin[0].y=pPnt.y;                                           
//#18066                                inlin[1].x=msg.pt.x-stOrg.x;                                           
//#18067                                inlin[1].y=msg.pt.y-stOrg.y;                                           
//#18068                                hed.stchs++;                                           
//#18069                                coltab();
//#18070                                setMap(RESTCH);                                           
//#18071                                return 1;                                           
//#18072                            }                                               
//#18073                        }                                                   
//#18074                        else{                                                   
//#18075                                                                           
//#18076                            xlin();                                               
//#18077                            if(stchs[cloInd].at&ALTYPMSK&&stchs[cloInd+1].at&ALTYPMSK)
//#18078                            {
//#18079                                if((stchs[cloInd].at&FRMSK)==(stchs[cloInd+1].at&FRMSK))
//#18080                                    cod=stchs[cloInd].at|USMSK;                                       
//#18081                            }                                               
//#18082                            ind=hed.stchs;                                               
//#18083                            do{                                               
//#18084                                                                           
//#18085                                stchs[ind].x=stchs[ind-1].x;                                           
//#18086                                stchs[ind].y=stchs[ind-1].y;                                           
//#18087                                stchs[ind].at=stchs[ind-1].at;                                           
//#18088                                ind--;                                           
//#18089                            }while(ind>(long)cloInd);                                               
//#18090                            hed.stchs++;                                               
//#18091                            cloInd++;                                               
//#18092                            stchs[cloInd].x=sPnt.x;                                               
//#18093                            stchs[cloInd].y=sPnt.y;                                               
//#18094                            stchs[cloInd].at=cod;                                               
//#18095                            xlin();                                               
//#18096                            inlin[1].x=msg.pt.x-stOrg.x;                                               
//#18097                            inlin[1].y=msg.pt.y-stOrg.y;                                               
//#18098                            stch2px1(cloInd);                                               
//#18099                            inlin[0].x=pPnt.x;                                               
//#18100                            inlin[0].y=pPnt.y;                                               
//#18101                            stch2px1(cloInd+1);                                               
//#18102                            inlin[2].x=pPnt.x;                                               
//#18103                            inlin[2].y=pPnt.y;
//#18104                            coltab();                                               
//#18105                            setMap(RESTCH);                                               
//#18106                            ritnum(STR_NUMSEL,cloInd);                                               
//#18107                            return 1;
//#18108                        }                                                   
//#18109                    }                                                       
//#18110                    if((!chkMap(HIDSTCH))&&closPnt1(&selclo)){                                                       
//#18111
//#18112                        cloInd=selclo;                                                   
//#18113                        unbox();
//#18114                        unboxs();                                                   
//#18115                        setbak(pixSiz[stchs[cloInd].at&0xf]+3);                                                   
//#18116                        plin=new POINT[3];                                                   
//#18117                        drwpnt=0;                                                   
//#18118                        SetROP2(rsdc,R2_NOTXORPEN);                                                   
//#18119                        if(cloInd==0){                                                   
//#18120                                                                           
//#18121                            if(zumFct<STCHBOX){                                               
//#18122                                                                           
//#18123                                SelectObject(rsdc,lPen);                                           
//#18124                                stchbox(0,rsdc);                                           
//#18125                                stchbox(1,rsdc);                                           
//#18126                            }                                               
//#18127                            SetROP2(rsdc,R2_COPYPEN);                                               
//#18128                            drwLin(0,2,bakPen);                                               
//#18129                        }                                                   
//#18130                        else{                                                   
//#18131                                                                           
//#18132                            if(cloInd==(unsigned)hed.stchs-1){                                               
//#18133                                                                           
//#18134                                if(zumFct<STCHBOX){                                           
//#18135                                                                           
//#18136                                    SelectObject(rsdc,lPen);
//#18137                                    stchbox(hed.stchs-1,rsdc);
//#18138                                    stchbox(hed.stchs-2,rsdc);                                       
//#18139                                }                                           
//#18140                                SetROP2(rsdc,R2_COPYPEN);                                           
//#18141                                drwLin(hed.stchs-2,2,bakPen);                                           
//#18142                            }                                               
//#18143                            else{                                               
//#18144                                                                           
//#18145                                if(zumFct<STCHBOX){
//#18146                                                                           
//#18147                                    SelectObject(rsdc,lPen);
//#18148                                    stchbox(cloInd-1,rsdc);                                       
//#18149                                    stchbox(cloInd,rsdc);                                       
//#18150                                    stchbox(cloInd+1,rsdc);                                       
//#18151                                }                                           
//#18152                                SetROP2(rsdc,R2_COPYPEN);                                           
//#18153                                drwLin(cloInd-1,3,bakPen);                                           
//#18154                            }                                               
//#18155                        }                                                   
//#18156                        delete plin;                                                   
//#18157                        mlin0[1].x=mlin1[0].x=msg.pt.x-stOrg.x;                                                   
//#18158                        mlin0[1].y=mlin1[0].y=msg.pt.y-stOrg.y;                                                   
//#18159                        if(cloInd<=0)                                                   
//#18160                            rstMap(ISDWN);                                               
//#18161                        else{                                                   
//#18162                                                                           
//#18163                            setMap(ISDWN);                                               
//#18164                            stch2px1(cloInd-1);                                               
//#18165                            mlin0[0].x=pPnt.x;
//#18166                            mlin0[0].y=pPnt.y;                                               
//#18167                        }                                                   
//#18168                        tlng=hed.stchs-1;                                                   
//#18169                        if(cloInd>=(unsigned)tlng)                                                   
//#18170                            rstMap(ISUP);                                               
//#18171                        else{
//#18172                                                                           
//#18173                            setMap(ISUP);                                               
//#18174                            stch2px1(cloInd+1);                                               
//#18175                            mlin1[1].x=pPnt.x;                                               
//#18176                            mlin1[1].y=pPnt.y;                                               
//#18177                        }                                                   
//#18178                        dulin();                                                   
//#18179                        SetCapture(hWnd);
//#18180                        setMap(CAPT);                                                   
//#18181                        ritnum(STR_NUMSEL,cloInd);
//#18182                    }                                                       
//#18183                }                                                           
//#18184                else{                                                           
//#18185                                                                           
//#18186                    if(px2stch()){                                                       
//#18187                                                                           
//#18188                        savdo();                                                   
//#18189                        hed.stchs=1;                                                   
//#18190                        inlin[0].x=msg.pt.x-stOrg.x;                                                   
//#18191                        inlin[0].y=msg.pt.y-stOrg.y;                                                   
//#18192                        stchs[0].at=USMSK|actcol|laycod|NOTFRM;                                                   
//#18193                        stchs[0].x=sPnt.x;                                                   
//#18194                        stchs[0].y=sPnt.y;
//#18195                        colCnt=1;                                                   
//#18196                        colch[0].colind=actcol;                                                   
//#18197                        colch[0].stind=0;                                                   
//#18198                        colch[1].stind=1;                                                   
//#18199                        setMap(LIN1);                                                   
//#18200                        setMap(INSRT);                                                   
//#18201                        SetCapture(hWnd);                                                   
//#18202                        cloInd=1;                                                   
//#18203                        setMap(INIT);                                                   
//#18204                        setMap(BAKEND);                                                   
//#18205                    }
//#18206                }                                                           
//#18207                ritot(hed.stchs);                                                           
//#18208                setMap(BOXSLCT);                                                           
//#18209                setMap(BZUMIN);                                                           
//#18210                setMap(NOSEL);                                                           
//#18211                blin[0].x=blin[3].x=blin[4].x=msg.pt.x-stOrg.x;                                                           
//#18212                blin[0].y=blin[1].y=msg.pt.y-stOrg.y;                                                           
//#18213                blin[4].y=blin[0].y-1;
//#18214                px2stch();                                                           
//#18215                zBoxo.x=sPnt.x;
//#18216                zBoxo.y=sPnt.y;                                                           
//#18217                setMap(VCAPT);
//#18218                return 1;                                                           
//#18219            }                                                               
//#18220            if(msg.hwnd==hbuts[HBOXSEL]){                                                               
//#18221                                                                           
//#18222                boxsel();                                                           
//#18223                return 1;
//#18224            }                                                               
//#18225            if(msg.hwnd==hbuts[HUPTO]){                                                               
//#18226                                                                           
//#18227                toglup();                                                           
//#18228                return 1;                                                           
//#18229            }                                                               
//#18230            if(msg.hwnd==hbuts[HHID]){
//#18231                                                                           
//#18232                toglHid();                                                           
//#18233                return 1;                                                           
//#18234            }                                                               
//#18235            if(chkMsgs(msg.pt,hDef[0],hDef[15])){                                                               
//#18236                                                                           
//#18237                if(msg.message==WM_LBUTTONDOWN){                                                           
//#18238                                                                           
//#18239                    savdo();
//#18240                    cod=actcol;                                                       
//#18241                    actcol=vind&0xf;                                                       
//#18242                    redraw(hCol[cod]);                                                       
//#18243                    redraw(hCol[actcol]);
//#18244                    if(chkMap(HID)){                                                       
//#18245                                                                           
//#18246                        rstMap(SELBOX);                                                   
//#18247                        rstMap(GRPSEL);
//#18248                        rstMap(SCROS);                                                   
//#18249                        rstMap(ECROS);
//#18250                        setMap(RESTCH);                                                   
//#18251                        redraw(hbuts[HHID]);                                                   
//#18252                    }
//#18253                    else{                                                       
//#18254                                                                           
//#18255                        if(fselpnt){                                                   
//#18256
//#18257                            nucols();                                               
//#18258                            coltab();                                               
//#18259                            setMap(RESTCH);                                               
//#18260                            return 1;                                               
//#18261                        }                                                   
//#18262                        else{                                                   
//#18263                                                                           
//#18264                            if(chkMap(FORMSEL)){                                               
//#18265                                                                           
//#18266                                frmpnt=&formlst[clofind];                                           
//#18267                                if(frmpnt->ftyp||frmpnt->etyp||frmpnt->xat&(AT_UND|AT_WALK|AT_CWLK)){                                           
//#18268                                                                           
//#18269                                    if(formlst[clofind].ftyp){
//#18270                                                                           
//#18271                                        formlst[clofind].fcol=actcol;                                   
//#18272                                        if(formlst[clofind].ftyp==FTHF)                                   
//#18273                                            formlst[clofind].dhx.fth.fthcol=actcol;
//#18274                                    }                                       
//#18275                                    if(formlst[clofind].etyp)                                       
//#18276                                    {                                       
//#18277                                        if(formlst[clofind].etyp==EGAP)                                   
//#18278                                        {                                   
//#18279                                            formlst[clofind].bcol&=0xf0;                               
//#18280                                            formlst[clofind].bcol|=actcol;                               
//#18281                                        }
//#18282                                        else
//#18283                                            formlst[clofind].bcol=actcol;
//#18284                                    }                                       
//#18285                                    if(frmpnt->xat&(AT_UND|AT_WALK|AT_CWLK))                                       
//#18286                                        formlst[clofind].ucol=actcol;                                   
//#18287                                    cod=clofind<<FRMSHFT;                                       
//#18288                                    for(ind=0;ind<hed.stchs;ind++){                                       
//#18289                                                                           
//#18290                                        ine=stchs[ind].at;                                   
//#18291                                        if(ine&ALTYPMSK&&(ine&FRMSK)==cod&&(ine&TYPMSK)!=TYPMSK)                                   
//#18292                                        {                                   
//#18293                                            ine&=NCOLMSK;                               
//#18294                                            ine|=actcol;                               
//#18295                                            stchs[ind].at=ine;
//#18296                                        }                                   
//#18297                                    }                                       
//#18298                                    coltab();                                       
//#18299                                    setMap(RESTCH);                                       
//#18300                                }                                           
//#18301                            }                                               
//#18302                            else{                                               
//#18303                                                                           
//#18304                                if(chkMap(GRPSEL)){                                           
//#18305                                                                           
//#18306                                    for(ind=gpnt0+1;ind<=(long)gpnt1;ind++){                                       
//#18307
//#18308                                        stchs[ind].at&=0xfffffff0;
//#18309                                        stchs[ind].at|=actcol;                                   
//#18310                                    }
//#18311                                    coltab();                                       
//#18312                                    setMap(RESTCH);                                       
//#18313                                }                                           
//#18314                                else{                                           
//#18315
//#18316                                    if(chkMap(COL))                                       
//#18317                                        setMap(RESTCH);
//#18318                                }                                           
//#18319                            }                                               
//#18320                        }                                                   
//#18321                    }
//#18322                }                                                           
//#18323                return 1;                                                           
//#18324            }                                                               
//#18325            if(chkMsgs(msg.pt,hCol[0],hCol[15])){                                                               
//#18326
//#18327                if(msg.message==WM_LBUTTONDOWN&&nuCol(useCol[vind])){
//#18328
//#18329                    savdo();
//#18330                    useCol[vind]=gCol.rgbResult;
//#18331                    uPen[vind]=nuPen(uPen[vind],1,useCol[vind]);
//#18332                    hbrUseCol[vind]=nuBrush(hbrUseCol[vind],useCol[vind]);
//#18333                    redraw(hCol[vind]);
//#18334                    setMap(RESTCH);
//#18335                }
//#18336                return 1;
//#18337            }
//#18338            if(chkMsgs(msg.pt,hSiz[0],hSiz[15])){
//#18339
//#18340                if(msg.message==WM_LBUTTONDOWN){
//#18341
//#18342                    savdo();
//#18343                    thrdSel=vind;
//#18344                    for(ind=0;ind<3;ind++)
//#18345                        hSizChng[ind]=nuSiz(ind);
//#18346                    setMap(SIZSEL);
//#18347                }
//#18348                return 1;
//#18349            }
//#18350        }
end;

//#18351        switch(msg.message){
//#18352
//#18353        case WM_TIMER:
//#18354
//#18355            if(chkMap(RUNPAT)&&!msg.wParam)
//#18356                stchout();
//#18357            break;
//#18358
procedure TfrmMain.FormKeyPress(Sender: TObject; var Key: Char);
begin


//#18359        case WM_CHAR:
//#18360
//#18361            if(isgraph(msg.wParam))
//#18362                nuthum(lchr(msg.wParam));
//#18363            break;
//#18364
end;
procedure TfrmMain.FormKeyDown(Sender: TObject; var Key: Word;
  Shift: TShiftState);
begin


//#18365        case WM_KEYDOWN:
//#18366
//#18367            cod=msg.wParam&0xffff;
//#18368            if(chkMap(TXTRED))
//#18369            {
//#18370                txtkey(cod);
//#18371                return 1;
//#18372            }
//#18373            fvars(clofind);
//#18374
//#18375    #if LANG==GRM
//#18376            if(cod>=0x30&&cod<=0x39){
//#18377
//#18378                if(GetKeyState(VK_SHIFT)&0X8000){
//#18379
//#18380                    switch(cod){
//#18381
//#18382                    case 0x38:
//#18383
//#18384                        selfrm0();
//#18385                        break;
//#18386
//#18387                    case 0x39:
//#18388
//#18389                        selfrmx();
//#18390                        break;
//#18391                    }
//#18392                }
//#18393            }
//#18394    #endif



//#18395            if(chkMap(FORMIN)){
//#18396
//#18397                if(GetKeyState(VK_CONTROL)&0X8000)
//#18398                    return 1;
//#18399
//#18400                switch(cod){
//#18401

  case chr(Key) of

    'F' : begin
            key := 0;
            //with ClientToScreen(point(10,10)) do               pmForm.Popup(x,y);
            mnu_form.Click;
          end;
  end;
  key := 0;

//#19309            case 'F':
//#19310
//#19311                if(fselpnt)
//#19312                {
//#19313                    PostMessage(hWnd,WM_SYSCOMMAND,SC_KEYMENU,'E');
//#19314                    keybd_event('F',0,0,0);
//#19315                }
//#19316                else{
//#19317
//#19318                    if(GetKeyState(VK_SHIFT)&0X8000){
//#19319
//#19320                        setMap(CNV2FTH);
//#19321                        ribon();
//#19322                    }
//#19323                    else{
//#19324
//#19325                        frmon();
//#19326                        if(chkMap(FORMSEL))
//#19327                            refrm();
//#19328                        else
//#19329                            form();
//#19330                    }
//#19331                }
//#19332                break;


//#18402                case 'E':
//#18403
//#18404                    rstMap(FORMIN);
//#18405                    unmsg();
//#18406                    duform(LIN-1);
//#18407                    return 1;
//#18408
//#18409                case 'F':
//#18410
//#18411                    rstMap(FORMIN);
//#18412                    unmsg();
//#18413                    duform(POLI-1);
//#18414                    return 1;
//#18415
//#18416                case 'R':
//#18417
//#18418                    duform(RPOLI-1);
//#18419                    return 1;
//#18420
//#18421                case 'S':
//#18422
//#18423                    duform(STAR-1);
//#18424                    return 1;
//#18425
//#18426                case 'A':
//#18427
//#18428                    duform(SPIR-1);
//#18429                    return 1;
//#18430
//#18431                case 'H':                                                           
//#18432                                                                           
//#18433                    duform(HART-2);                                                       
//#18434                    return 1;                                                       
//#18435                                                                           
//#18436                case 'L':                                                           
//#18437                                                                           
//#18438                    duform(LENS-2);                                                       
//#18439                    return 1;
//#18440                                                                           
//#18441                case 'G':                                                           
//#18442                                                                           
//#18443                    duform(EGG-2);
//#18444                    return 1;                                                       
//#18445                                                                           
//#18446                case 'T':
//#18447
//#18448                    duform(TEAR-2);
//#18449                    return 1;
//#18450
//#18451                case 'Z':
//#18452
//#18453                    duform(ZIG-2);
//#18454                    return 1;
//#18455
//#18456                case 'W':
//#18457
//#18458                    duform(WAV-2);
//#18459                    return 1;
//#18460
//#18461                case 'D':
//#18462
//#18463                    duform(DASY-2);
//#18464                    return 1;
//#18465                }
//#18466            }
//#18467            if(chkMap(FILMSG)){
//#18468
//#18469                if(cod=VK_RETURN||cod==0xc0){
//#18470
//#18471                    savdo();
//#18472                    unfil();
//#18473                    coltab();
//#18474                    setMap(RESTCH);
//#18475                    unmsg();
//#18476                    return 1;
//#18477                }
//#18478            }
//#18479            if(rstMap(MOVMSG)){
//#18480
//#18481                if(cod==VK_RETURN||cod==0xc0){
//#18482
//#18483                    savdo();
//#18484                    refilfn();
//#18485                    unmsg();
//#18486                }
//#18487                else
//#18488                    unmsg();
//#18489                if(rstMap(WASFRMFRM))
//#18490                    refrm();
//#18491                return 1;
//#18492            }
//#18493            if(rstMap(PRGMSG)){
//#18494
//#18495                if(cod==VK_RETURN||cod==0xc0){
//#18496
//#18497                    deldir();
//#18498                    return 1;
//#18499                }
//#18500            }
//#18501            if(rstMap(DELSFRMS)){
//#18502
//#18503                if(cod=='S'||cod==VK_RETURN||cod==0xc0){
//#18504
//#18505                    savdo();
//#18506                    if(cod=='S')
//#18507                        setMap(DELTO);
//#18508                    else
//#18509                        rstMap(DELTO);
//#18510                    delsfrms(cod);
//#18511                    coltab();
//#18512                    setMap(RESTCH);
//#18513                    unmsg();
//#18514                    return 1;
//#18515                }
//#18516            }
//#18517            if(rstMap(DELFRM)){
//#18518
//#18519                if(cod=='S'||cod==VK_RETURN||cod==0xc0){
//#18520
//#18521                    savdo();
//#18522                    if(cod=='S')
//#18523                        setMap(DELTO);
//#18524                    else
//#18525                        rstMap(DELTO);
//#18526                    frmdel();
//#18527                    fndknt();
//#18528                    coltab();
//#18529                    setMap(RESTCH);
//#18530                    unmsg();
//#18531                    return 1;
//#18532                }
//#18533            }
//#18534            if(chkMap(THUMSHO)){
//#18535
//#18536                switch(cod){
//#18537
//#18538                case VK_ESCAPE:
//#18539
//#18540                    unthum();
//#18541                    rstMap(BAKSHO);
//#18542                    goto thumout;
//#18543
//#18544                case VK_DOWN:
//#18545                case 0x22:        //page down
//#18546
//#18547                    nuthsel();
//#18548                    break;
//#18549
//#18550                case VK_UP:
//#18551                case 0x21:        //page up
//#18552
//#18553                    nuthbak(8);
//#18554                    break;
//#18555
//#18556                case VK_HOME:
//#18557
//#18558                    thumind=0;
//#18559                    nuthsel();
//#18560                    break;
//#18561
//#18562                case VK_END:
//#18563
//#18564                    thumind=thumcnt;
//#18565                    nuthbak(4);
//#18566                    break;
//#18567
//#18568                case 8:            //backspace
//#18569                case VK_LEFT:
//#18570
//#18571                    bakthum();
//#18572                    break;
//#18573
//#18574                default:
//#18575
//#18576                    TranslateMessage(&msg);
//#18577                }
//#18578                return 1;
//#18579            }
//#18580            if(chkMap(FSETFSPAC)||chkMap(GTWLKIND))
//#18581            {
//#18582                if(cod==189||cod==109)
//#18583                {
//#18584                    *msgbuf='-';
//#18585                    msgpnt=1;
//#18586                    msgbuf[1]=0;
//#18587                    SetWindowText(hgNum,msgbuf);
//#18588                    return 1;
//#18589                }
//#18590            }
//#18591            if(sidtyp||prfind){
//#18592
//#18593                if(chkminus(cod)){
//#18594
//#18595                    msgpnt=1;
//#18596                    sidbuf[0]='-';
//#18597                    SetWindowText(hSid,sidbuf);
//#18598                    return 1;
//#18599                }
//#18600                if(dunum(cod)){
//#18601
//#18602                    if(prfind==PSHO+1||prfind==PBOX+1){
//#18603
//#18604                        msgbuf[0]=(TCHAR)numcod;
//#18605                        msgbuf[1]=0;
//#18606                        if(prfind==PSHO+1){
//#18607
//#18608                            shopnts=unthrsh(numcod-0x30);
//#18609                            SetWindowText(thDat[PSHO],msgbuf);
//#18610                        }
//#18611                        else{
//#18612
//#18613                            stchboxs=unthrsh(numcod-0x30);
//#18614                            SetWindowText(thDat[PBOX],msgbuf);
//#18615                        }
//#18616                        unsid();
//#18617                    }
//#18618                    else{
//#18619
//#18620                        sidbuf[msgpnt++]=numcod;
//#18621                        sidbuf[msgpnt]=0;
//#18622                        SetWindowText(hSid,sidbuf);
//#18623                    }
//#18624                    return 1;
//#18625                }
//#18626                switch(cod){                                                           
//#18627                                                                           
//#18628                case 0x6e://numpat period                                                           
//#18629                case 0xbe://period                                                           
//#18630                                                                           
//#18631                    sidbuf[msgpnt++]='.';                                                       
//#18632                    sidbuf[msgpnt]=0;                                                       
//#18633                    SetWindowText(hSid,sidbuf);                                                       
//#18634                    return 1;
//#18635                                                                           
//#18636                case 8:    //backspace                                                       
//#18637                                                                           
//#18638                    if(msgpnt){                                                       
//#18639                                                                           
//#18640                        sidbuf[--msgpnt]=0;                                                   
//#18641                        SetWindowText(hSid,sidbuf);                                                   
//#18642                    }                                                       
//#18643                    return 1;                                                       
//#18644                                                                           
//#18645                case VK_RETURN:                                                           
//#18646                                                                           
//#18647                    chknum();
//#18648                    sidtyp=0;                                                       
//#18649                    prfind=0;                                                       
//#18650                    return 1;                                                       
//#18651                }                                                           
//#18652            }                                                               
//#18653            if(cod=='I'){                                                               
//#18654
//#18655                movi();
//#18656                lastcod='I';
//#18657                return 1;
//#18658            }
//#18659            if(cod=='Q'&&lastcod=='Q')
//#18660                unpat();
//#18661            lastcod=cod;
//#18662            if(chkMap(NUMIN)){
//#18663
//#18664                if(chkMap(SCLPSPAC)&&cod==0xbd&&!msgpnt)
//#18665                {
//#18666                    msgbuf[0]='-';
//#18667                    msgbuf[1]=0;
//#18668                    msgpnt=1;
//#18669                    SetWindowText(hgNum,msgbuf);
//#18670                    return 1;
//#18671                }
//#18672                if(dunum(cod)){
//#18673
//#18674                    if(chkMap(TRNIN0)){
//#18675
//#18676                        trinbuf[msgpnt++]=numcod;
//#18677                        trinbuf[msgpnt]=0;
//#18678                        ind=atoi(trinbuf);
//#18679                        switch(msgpnt){
//#18680
//#18681                        case 2:
//#18682
//#18683                            if(ind>25)
//#18684                                dutrnum0(ind);
//#18685                            break;
//#18686
//#18687                        case 3:
//#18688
//#18689                            if(ind>255)
//#18690                                ind=255;
//#18691                            dutrnum0(ind);
//#18692                            break;
//#18693                        }
//#18694                        redraw(htrnum);
//#18695                    }
//#18696                    else{
//#18697
//#18698                        msgbuf[msgpnt++]=numcod;
//#18699                        msgbuf[msgpnt]=0;
//#18700                        SetWindowText(hgNum,msgbuf);
//#18701                    }
//#18702                    return 1;
//#18703                }
//#18704                switch(cod){
//#18705
//#18706                case 0x6e://numpad period
//#18707                case 0xbe://period
//#18708
//#18709                    msgbuf[msgpnt++]='.';
//#18710                    msgbuf[msgpnt]=0;
//#18711                    SetWindowText(hgNum,msgbuf);
//#18712                    return 1;
//#18713
//#18714                case 8:    //backspace
//#18715
//#18716                    if(msgpnt){
//#18717
//#18718                        msgpnt--;
//#18719                        if(chkMap(TRNIN0)){
//#18720
//#18721                            trinbuf[msgpnt]=0;
//#18722                            redraw(htrnum);
//#18723                        }
//#18724                        else{
//#18725
//#18726                            msgbuf[msgpnt]=0;
//#18727                            SetWindowText(hgNum,msgbuf);
//#18728                        }
//#18729                    }
//#18730                    return 1;
//#18731
//#18732                case VK_RETURN:
//#18733
//#18734                    if(chkMap(TRNIN0))
//#18735                        dutrnum0(atoi(trinbuf));
//#18736                    else{
//#18737
//#18738                        if(chkMap(TRNIN1))
//#18739                            dutrnum1();
//#18740                    }
//#18741                    break;
//#18742                }
//#18743            }
//#18744            if(cod==8&&numpnt){
//#18745
//#18746                numbuf[--numpnt]=0;
//#18747                butxt(HNUM,numbuf);
//#18748                cloInd=atoi(numbuf);
//#18749                movbox();
//#18750                return 1;
//#18751            }
//#18752            if(!chkMap(WASTRAC)&&dunum(cod)){
//#18753
//#18754                if(numpnt>stchdigs-1)
//#18755                    numpnt=0;
//#18756                if(numbuf[0]=='0'&&numpnt)
//#18757                    numpnt--;
//#18758                numbuf[numpnt++]=numcod;
//#18759                numbuf[numpnt]=0;
//#18760                cloInd=atoi(numbuf);
//#18761                if(cloInd>(unsigned)hed.stchs-1){
//#18762
//#18763                    sprintf(numbuf,"%d",hed.stchs-1);
//#18764                    cloInd=hed.stchs-1;
//#18765                }
//#18766                butxt(HNUM,numbuf);
//#18767                movbox();
//#18768                rstMap(NUMIN);
//#18769                return 1;
//#18770            }
//#18771            numpnt=0;
//#18772            unmsg();
//#18773            switch(cod){


//#18774
//#18775            case VK_ESCAPE:
//#18776
//#18777    thumout:;
//#18778                chkbit();
//#18779                duhbit(MF_UNCHECKED);
//#18780                unthum();
//#18781                rstMap(MOVSET);
//#18782                rstMap(HID);
//#18783                rstMap(FRMOF);
//#18784                rstMap(THRDS);
//#18785                redraw(hbuts[HHID]);
//#18786                CheckMenuItem(hMen,ID_VUTHRDS,MF_BYCOMMAND|MF_UNCHECKED);
//#18787                rstMap(COL);
//#18788                CheckMenuItem(hMen,ID_VUSELTHRDS,MF_BYCOMMAND|MF_UNCHECKED);
//#18789                setMap(DUMEN);
//#18790                rstMap(RUNPAT);
//#18791                rstMap(WASPAT);
//#18792                rstMap(WASBLAK);
//#18793                rstMap(GTUANG);
//#18794                rstMap(GTUSPAC);
//#18795                rstMap(GTWLKIND);
//#18796                rstMap(GTWLKLEN);
//#18797                DestroyWindow(hSped);
//#18798                rstMap(GMRK);
//#18799
//#18800            case 'Q':
//#18801
//#18802                if(GetKeyState(VK_SHIFT)&0x8000){
//#18803
//#18804                    ritcur();
//#18805                    return 1;
//#18806                }
//#18807                untrace();
//#18808                rstMap(HIDMAP);
//#18809                rstMap(FILDIR);
//#18810                ReleaseCapture();
//#18811                if(hed.stchs==1)
//#18812                    hed.stchs=0;
//#18813                if(!chku(MARQ))
//#18814                    rstMap(GMRK);
//#18815                if(rstMap(PRFACT)){
//#18816
//#18817                    if(rstMap(WASRT)){
//#18818
//#18819                        setMap(INSRT);
//#18820                        setMap(RESTCH);
//#18821                        return 1;
//#18822                    }
//#18823                    else
//#18824                        rstAll();
//#18825                }
//#18826                else
//#18827                    rstAll();
//#18828                setMap(RESTCH);
//#18829                if(numpnt){
//#18830                                                                           
//#18831                    numpnt=0;                                                       
//#18832                    numbuf[0]=0;                                                       
//#18833                    cloInd=0;                                                       
//#18834                    movbox();                                                       
//#18835                }                                                           
//#18836                butxt(HNUM,"");                                                           
//#18837                return 1;                                                           
//#18838
//#18839            case 0xc0:        //`                                                       
//#18840                                                                           
//#18841                if(GetKeyState(VK_CONTROL)&0x8000&&GetKeyState(VK_MENU)&0x8000){                                                           
//#18842
//#18843                    stchBak=0x505050;                                                       
//#18844                    bakPen=nuPen(bakPen,1,stchBak);                                                       
//#18845                    bakwid=1;                                                       
//#18846                    DeleteObject(hStchBak);                                                       
//#18847                    hStchBak=CreateSolidBrush(stchBak);                                                       
//#18848                    if(*bnam)                                                       
//#18849                        bfil();                                                   
//#18850                    setMap(RESTCH);                                                       
//#18851                }                                                           
//#18852                else{                                                           
//#18853    #if PESACT                                                                       
//#18854    //                ini.auxfil=AUXPES;                                                       
//#18855    //                strcpy(filnam,"u:\\mrd\\t.thr");
//#18856    //                setMap(REDOLD);                                                       
//#18857    //                nuFil();                                                       
//#18858    //                lodpes();
//#18859    //                savpes();
//#18860    #endif
//#18861
//#18862                    tst();
//#18863                }
//#18864                break;
//#18865
//#18866            case VK_INSERT:
//#18867
//#18868                inscol();
//#18869                break;
//#18870
//#18871            case 0x6d:        //keypad -
//#18872
//#18873                toglup();
//#18874                break;
//#18875
//#18876            case 0xbd:        //-
//#18877
//#18878                rstMap(CNTRH);
//#18879                rstMap(CNTRV);
//#18880                if(GetKeyState(VK_SHIFT)&0X8000)
//#18881                    setMap(CNTRV);
//#18882                else{
//#18883
//#18884                    if(GetKeyState(VK_CONTROL)&0X8000)
//#18885                        setMap(CNTRH);
//#18886                }
//#18887                cntrx();
//#18888                break;
//#18889
//#18890            case 0xbf:        ///forward slash /
//#18891
//#18892                frmnum();
//#18893                break;
//#18894
//#18895            case 0xbb:        //=
//#18896
//#18897                shrnk();
//#18898                break;
//#18899
//#18900            case 0x21:        //page up
//#18901
//#18902                if(GetKeyState(VK_SHIFT)&0X8000)
//#18903                    redup();
//#18904                else
//#18905                    rotagain();
//#18906                break;
//#18907
//#18908            case 0x22:        //page down
//#18909
//#18910                if(GetKeyState(VK_SHIFT)&0X8000)
//#18911                    bakdup();
//#18912                else
//#18913                    bakagain();
//#18914                break;
//#18915
//#18916            case 0xde:    //'
//#18917
//#18918                desiz();
//#18919                break;
//#18920
//#18921            case 0xdb:        //[
//#18922
//#18923    #if LANG==ENG||LANG==HNG
//#18924
//#18925                if(GetKeyState(VK_SHIFT)&0X8000)
//#18926                    selfrm0();
//#18927                else
//#18928    #endif
//#18929                    ungrplo();
//#18930                break;
//#18931
//#18932            case 0xdd:        //]
//#18933
//#18934    #if LANG==ENG||LANG==HNG
//#18935
//#18936                if(GetKeyState(VK_SHIFT)&0X8000)
//#18937                    selfrmx();
//#18938                else
//#18939    #endif
//#18940                    ungrphi();
//#18941                break;
//#18942
//#18943            case 0xba:        //semicolon
//#18944
//#18945                movmrk();
//#18946                break;
//#18947
//#18948            case VK_DOWN:
//#18949
//#18950                if(GetKeyState(VK_CONTROL)&0X8000)
//#18951                    nudgfn(0,-ini.nudg);
//#18952                else
//#18953                    seldwn();
//#18954                break;
//#18955
//#18956            case VK_UP:
//#18957
//#18958                if(GetKeyState(VK_CONTROL)&0X8000)
//#18959                    nudgfn(0,ini.nudg);
//#18960                else
//#18961                    selup();
//#18962                break;
//#18963
//#18964            case 0xbe:        //period
//#18965
//#18966                if(GetKeyState(VK_SHIFT)&0X8000)
//#18967                    setfilend();
//#18968                else
//#18969                    setmov();
//#18970                break;
//#18971
//#18972            case 'W':
//#18973
//#18974                if(GetKeyState(VK_SHIFT)&0X8000)
//#18975                    crop();
//#18976                else{
//#18977
//#18978                    if(GetKeyState(VK_CONTROL)&0X8000)
//#18979                        pes2crd();
//#18980                    else
//#18981                        insat();
//#18982                }
//#18983                break;
//#18984
//#18985            case 'E':
//#18986
//#18987                if(GetKeyState(VK_SHIFT)&0X8000)
//#18988                    dutxtfil();
//#18989                else
//#18990                    infrm();
//#18991                break;
//#18992
//#18993            case VK_F2:
//#18994
//#18995                snap();
//#18996                break;
//#18997
//#18998            case VK_F1:
//#18999
//#19000                help();
//#19001                break;
//#19002
//#19003            case VK_F3:
//#19004
//#19005                if(GetKeyState(VK_CONTROL)&0X8000)
//#19006                    srtfrm();
//#19007                else{
//#19008
//#19009                    if(GetKeyState(VK_SHIFT)&0X8000)
//#19010                        srtbyfrm();
//#19011                    else
//#19012                        fsort();
//#19013                }
//#19014                break;
//#19015
//#19016            case VK_F4:
//#19017
//#19018                rtrclp();
//#19019                break;
//#19020
//#19021            case VK_F5:
//#19022
//#19023                filfrms();
//#19024                break;
//#19025
//#19026            case VK_F6:
//#19027
//#19028                vuthrds();
//#19029                break;
//#19030
//#19031            case VK_F7:
//#19032
//#19033                save();
//#19034                break;
//#19035
//#19036            case VK_F8:
//#19037
//#19038                savAs();
//#19039                break;
//#19040
//#19041            case VK_F9:
//#19042
//#19043                selCol();
//#19044                break;
//#19045
//#19046            case VK_F11:
//#19047
//#19048                if(GetKeyState(VK_SHIFT)&0X8000)
//#19049                    rembig();
//#19050                else
//#19051                    duzero();
//#19052                break;
//#19053
//#19054            case VK_F12:
//#19055
//#19056                if(GetKeyState(VK_CONTROL)&GetKeyState(VK_MENU)&0X8000)
//#19057                    reldun();
//#19058                else
//#19059                {
//#19060    #ifdef _DEBUG
//#19061                    if(GetKeyState(VK_SHIFT)&0X8000)
//#19062                        dmpat();
//#19063                    else
//#19064    #endif
//#19065                        dun();
//#19066                }
//#19067                break;
//#19068
//#19069            case 'Y':
//#19070
//#19071                if(closfrm())
//#19072                    selfpnt();
//#19073                break;
//#19074
//#19075            case 'O':
//#19076
//#19077                fop();
//#19078                break;
//#19079
//#19080            case 'Z':
//#19081
//#19082                if(GetKeyState(VK_SHIFT)&0X8000){
//#19083
//#19084                    zumFct=zumflor;
//#19085                    zumin();
//#19086                }
//#19087                else{
//#19088
//#19089                    if(GetKeyState(VK_CONTROL)&0X8000)
//#19090                        bak();
//#19091                    else
//#19092                        zumin();
//#19093                }
//#19094                break;
//#19095
//#19096            case 'X':
//#19097
//#19098                if(GetKeyState(VK_CONTROL)&0X8000)
//#19099                    cut();
//#19100                else{
//#19101
//#19102                    if(GetKeyState(VK_SHIFT)&0X8000)
//#19103                        hidbit();
//#19104                    else
//#19105                        zumhom();
//#19106                }
//#19107                break;
//#19108
//#19109            case 'P':
//#19110
//#19111                prfmsg();
//#19112                break;
//#19113
//#19114            case 'N':
//#19115
//#19116            if(GetKeyState(VK_CONTROL)&0X8000)
//#19117                nudsiz();
//#19118            else
//#19119            {
//#19120                if(GetKeyState(VK_SHIFT)&0X8000)
//#19121                    pgdwn();
//#19122                else
//#19123                {
//#19124                    setMap(TRCUP);
//#19125                    trace();
//#19126                }
//#19127            }
//#19128            break;
//#19129
//#19130            case 'U':
//#19131
//#19132                if(GetKeyState(VK_SHIFT)&0X8000)
//#19133                    pgup();
//#19134                else{
//#19135
//#19136                    if(GetKeyState(VK_CONTROL)&0X8000)
//#19137                        trdif();
//#19138                    else{
//#19139
//#19140                        rstMap(TRCUP);
//#19141                        trace();
//#19142                    }
//#19143                }
//#19144                break;
//#19145
//#19146            case 'H':
//#19147
//#19148                if(GetKeyState(VK_SHIFT)&0X8000)
//#19149                    pglft();
//#19150                else{
//#19151
//#19152                    if(GetKeyState(VK_CONTROL)&0X8000)
//#19153                        trcsel();
//#19154                    else
//#19155                        blak();
//#19156                }
//#19157                break;
//#19158
//#19159            case 'J':
//#19160
//#19161                if(GetKeyState(VK_SHIFT)&0X8000)
//#19162                    pgrit();
//#19163                else
//#19164                    refilal();
//#19165                break;
//#19166
//#19167            case 0xbc:        //comma
//#19168
//#19169                if(GetKeyState(VK_SHIFT)&0X8000)
//#19170                    setfilstrt();
//#19171                else
//#19172                {
//#19173                    savdo();
//#19174                    join();
//#19175                }
//#19176                break;
//#19177
//#19178            case 'B':
//#19179
//#19180                if(GetKeyState(VK_CONTROL)&0X8000)
//#19181                    redo();
//#19182                else{
//#19183
//#19184                    if(GetKeyState(VK_SHIFT)&0X8000)
//#19185                        bakmrk();
//#19186                    else
//#19187                        bak();
//#19188                }
//#19189                break;
//#19190
//#19191            case 'D':
//#19192
//#19193                if(GetKeyState(VK_SHIFT)&0X8000)
//#19194                {
//#19195                    if(chkMap(FORMSEL))
//#19196                    {
//#19197                        PostMessage(hWnd,WM_SYSCOMMAND,SC_KEYMENU,'E');
//#19198                        keybd_event('F',0,0,0);
//#19199                    }
//#19200                }
//#19201                else
//#19202                    satsel();
//#19203                break;
//#19204
//#19205            case 'K':
//#19206
//#19207                if(GetKeyState(VK_MENU)&GetKeyState(VK_CONTROL)&0X8000)
//#19208                    setknots();
//#19209                else
//#19210                {
//#19211                    if(GetKeyState(VK_SHIFT)&0X8000)
//#19212                        tglhid();
//#19213                    else{
//#19214
//#19215                        if(GetKeyState(VK_CONTROL)&0X8000)
//#19216                            set1knot();
//#19217                        else
//#19218                            tglfrm();
//#19219                    }
//#19220                }
//#19221                break;
//#19222
//#19223            case 'A':
//#19224
//#19225                if(GetKeyState(VK_CONTROL)&0X8000)
//#19226                    selalstch();
//#19227                else{
//#19228
//#19229                    if(GetKeyState(VK_SHIFT)&0X8000)
//#19230                        selal();
//#19231                    else
//#19232                        zumout();
//#19233                }
//#19234                break;
//#19235
//#19236            case VK_SPACE:
//#19237
//#19238                if(toglMap(INSRT)){
//#19239
//#19240                    ReleaseCapture();                                                       
//#19241                    setMap(RESTCH);                                                       
//#19242                }                                                           
//#19243                else                                                           
//#19244                    istch();                                                       
//#19245                unbox();
//#19246                if(rstMap(GRPSEL)||rstMap(FORMSEL))
//#19247                    setMap(RESTCH);                                                       
//#19248                break;                                                           
//#19249                                                                           
//#19250            case 'T':                                                               
//#19251                                                                           
//#19252                if(GetKeyState(VK_SHIFT)&0x8000)                                                           
//#19253                    retrac();                                                       
//#19254                else{                                                           
//#19255                                                                           
//#19256                    if(GetKeyState(VK_CONTROL)&0x8000)                                                       
//#19257                        trinit();                                                   
//#19258                    else
//#19259                        thumnail();                                                   
//#19260                }                                                           
//#19261                break;                                                           
//#19262                                                                           
//#19263            case 'R':                                                               
//#19264                                                                           
//#19265                if(GetKeyState(VK_CONTROL)&GetKeyState(VK_SHIFT)&0x8000){                                                           
//#19266                                                                           
//#19267                    movStch();                                                       
//#19268                    unbox();
//#19269                    setMap(RESTCH);                                                       
//#19270                }                                                           
//#19271                else{
//#19272                                                                           
//#19273                    if(GetKeyState(VK_CONTROL)&0x8000){                                                       
//#19274                                                                           
//#19275                        setrang();                                                   
//#19276                        return 1;                                                   
//#19277                    }                                                       
//#19278                    if(GetKeyState(VK_SHIFT)&0x8000){                                                       
//#19279                                                                           
//#19280                        rotmrk();
//#19281                        return 1;                                                   
//#19282                    }                                                       
//#19283                    else                                                       
//#19284                        rotseg();
//#19285                }                                                           
//#19286                break;                                                           
//#19287                                                                           
//#19288            case VK_TAB:                                                               
//#19289                                                                           
//#19290                rot();                                                           
//#19291                break;                                                           
//#19292                                                                           
//#19293            case 'S':                                                               
//#19294                                                                           
//#19295                if(GetKeyState(VK_CONTROL)&0X8000){                                                           
//#19296                                                                           
//#19297                    colchk();
//#19298                    save();                                                       
//#19299                }                                                           
//#19300                else{                                                           
//#19301
//#19302                    if(GetKeyState(VK_SHIFT)&0X8000)
//#19303                        gsnap();
//#19304                    else
//#19305                        zumshft();
//#19306                }
//#19307                break;
//#19308


//#19333
//#19334            case 'V':
//#19335
//#19336                if(GetKeyState(VK_CONTROL)&0X8000&&OpenClipboard(hWnd)){
//#19337
//#19338                    htclp=RegisterClipboardFormat(thredclp);
//#19339                    hClpMem=GetClipboardData(htclp);
//#19340                    if(hClpMem){
//#19341
//#19342                        clpvoid=GlobalLock(hClpMem);
//#19343                        fpclpdat=(FPCLP*)clpvoid;
//#19344                        if(fpclpdat->led==CLP_FRMPS){
//#19345
//#19346                            duzrat();
//#19347                            ind=sizeof(FPCLP)+(fpclpdat->cnt+1)*sizeof(FLPNT);
//#19348                            MoveMemory(&bseq,clpvoid,ind);
//#19349                            GlobalUnlock(hClpMem);                                               
//#19350                            fpclpdat=(FPCLP*)&bseq;                                               
//#19351                            if(chkMap(FRMPSEL)){                                               
//#19352                                                                           
//#19353                                pchr=(unsigned char*)&bseq;                                           
//#19354                                fvars(clofind);                                           
//#19355                                iseq[0].x=flt[clofine].x;                                           
//#19356                                iseq[0].y=flt[clofine].y;                                           
//#19357                                clp=(FLPNT*)&fpclpdat[1];                                           
//#19358                                for(ind=0;ind<=fpclpdat->cnt;ind++){                                           
//#19359                                                                           
//#19360                                    iseq[ind+1].x=clp[ind].x;                                       
//#19361                                    iseq[ind+1].y=clp[ind].y;                                       
//#19362                                }                                           
//#19363                                ine=nxt(clofine);                                           
//#19364                                ind++;                                           
//#19365                                iseq[ind].x=flt[ine].x;                                           
//#19366                                iseq[ind].y=flt[ine].y;                                           
//#19367                                opnt=ind+1;                                           
//#19368                                fplin=(POINT*)&iseq[opnt];                                           
//#19369                                setpclp();                                           
//#19370                                setMap(FPUNCLP);                                           
//#19371                                setMap(SHOP);                                           
//#19372                                dupclp();                                           
//#19373                            }                                               
//#19374                            else{                                               
//#19375                                                                           
//#19376                                fmovdif.x=fmovdif.y=0;                                           
//#19377                                setMap(FUNCLP);                                           
//#19378                                clofind=formpnt;                                           
//#19379                                frmpnt=&formlst[formpnt];                                           
//#19380                                FillMemory(frmpnt,sizeof(FRMHED),0);                                           
//#19381                                frmpnt->typ=LIN;                                           
//#19382                                frmpnt->sids=fpclpdat->cnt+1;
//#19383                                frmpnt->flt=adflt(frmpnt->sids);                                           
//#19384                                fvars(clofind);                                           
//#19385                                MoveMemory(frmpnt->flt,&fpclpdat[1],sizeof(FLPNT)*frmpnt->sids);                                           
//#19386                                setMap(INIT);                                           
//#19387                                nuflen=frmpnt->sids;                                           
//#19388                                unfrm();                                           
//#19389                                setmfrm();                                           
//#19390                                setMap(SHOFRM);                                           
//#19391                                dufrm();                                           
//#19392                            }                                               
//#19393                            return 1;                                               
//#19394                        }                                                   
//#19395                        frmsclpdat=(FRMSCLP*)clpvoid;                                                   
//#19396                        if(frmsclpdat->led==CLP_FRMS){                                                   
//#19397                                                                           
//#19398                            funscnt=frmsclpdat->cnt;                                               
//#19399                            tfrm=(FRMHED*)&frmsclpdat[1];                                               
//#19400                            for(ind=0;ind<funscnt;ind++){                                               
//#19401                                                                           
//#19402                                frmcpy(&formlst[formpnt+ind],&tfrm[ind]);                                           
//#19403                                formlst[formpnt+ind].at=(formlst[formpnt+ind].at&NFRMLMSK)|(actl<<1);                                           
//#19404                            }                                               
//#19405                            flt=(FLPNT*)&tfrm[ind];                                               
//#19406                            inf=0;                                               
//#19407                            for(ind=0;ind<funscnt;ind++){                                               
//#19408                                                                           
//#19409                                frmpnt=&formlst[formpnt+ind];                                           
//#19410                                frmpnt->flt=adflt(frmpnt->sids);                                           
//#19411                                for(ine=0;ine<frmpnt->sids;ine++){                                           
//#19412                                                                           
//#19413                                    frmpnt->flt[ine].x=flt[inf].x;                                       
//#19414                                    frmpnt->flt[ine].y=flt[inf++].y;                                       
//#19415                                }                                           
//#19416                            }
//#19417                            sac=(SATCON*)&flt[inf];                                               
//#19418                            inf=0;                                               
//#19419                            for(ind=0;ind<funscnt;ind++){                                               
//#19420                                                                           
//#19421                                frmpnt=&formlst[formpnt+ind];                                           
//#19422                                if(frmpnt->typ==SAT&&frmpnt->stpt){                                           
//#19423                                                                           
//#19424                                    frmpnt->sacang.sac=adsatk(frmpnt->stpt);                                       
//#19425                                    for(ine=0;ine<frmpnt->stpt;ine++){                                       
//#19426                                                                           
//#19427                                        frmpnt->sacang.sac[ine].strt=sac[inf].strt;                                   
//#19428                                        frmpnt->sacang.sac[ine].fin=sac[inf++].fin;                                   
//#19429                                    }                                       
//#19430                                }                                           
//#19431                            }                                               
//#19432                            clp=(FLPNT*)&sac[inf];                                               
//#19433                            inf=0;                                               
//#19434                            for(ind=0;ind<funscnt;ind++){                                               
//#19435                                                                           
//#19436                                frmpnt=&formlst[formpnt+ind];                                           
//#19437                                if(isclpx(formpnt+ind)){                                           
//#19438                                                                           
//#19439                                    frmpnt->angclp.clp=adclp(frmpnt->flencnt.nclp);                                       
//#19440                                    for(ine=0;(unsigned)ine<frmpnt->flencnt.nclp;ine++){                                       
//#19441                                                                           
//#19442                                        frmpnt->angclp.clp[ine].x=clp[inf].x;                                   
//#19443                                        frmpnt->angclp.clp[ine].y=clp[inf++].y;                                   
//#19444                                    }                                       
//#19445                                }                                           
//#19446                                if(iseclpx(formpnt+ind)){                                           
//#19447                                                                           
//#19448                                    frmpnt->clp=adclp(frmpnt->nclp);                                       
//#19449                                    for(ine=0;ine<frmpnt->nclp;ine++){                                       
//#19450
//#19451                                        frmpnt->clp[ine].x=clp[inf].x;                                   
//#19452                                        frmpnt->clp[ine].y=clp[inf++].y;                                   
//#19453                                    }                                       
//#19454                                }                                           
//#19455                            }                                               
//#19456                            pts=(TXPNT*)&clp[inf];                                               
//#19457                            ptx=&txpnts[txad];                                               
//#19458                            ine=0;                                               
//#19459                            for(ind=0;ind<funscnt;ind++)                                               
//#19460                            {                                               
//#19461                                if(istx(formpnt+ind))                                           
//#19462                                {                                           
//#19463                                    frmpnt=&formlst[formpnt+ind];                                       
//#19464                                    ine+=frmpnt->dhx.txt.cnt;                                       
//#19465                                    frmpnt->dhx.txt.ind+=txad;                                       
//#19466                                    MoveMemory(ptx,pts,(frmpnt->dhx.txt.ind+frmpnt->dhx.txt.cnt-txad)*sizeof(TXPNT));                                       
//#19467                                }                                           
//#19468                            }                                               
//#19469                            txad+=ine;                                               
//#19470                            GlobalUnlock(hClpMem);                                               
//#19471                            bigrct.top=bigrct.left=0x7fffffff;                                               
//#19472                            bigrct.bottom=bigrct.right=0;                                               
//#19473                            ratsr();                                               
//#19474                            for(opnt=0;opnt<(unsigned)funscnt;opnt++){                                               
//#19475                                                                           
//#19476                                _asm push ebp                                           
//#19477                                fselrct(opnt+formpnt);                                           
//#19478                                _asm pop ebp                                           
//#19479                                selist[opnt]=opnt+formpnt;                                           
//#19480                            }                                               
//#19481                            fselpnt=funscnt;                                               
//#19482                            bigsiz.x=bigrct.right-bigrct.left;                                               
//#19483                            bigsiz.y=bigrct.bottom-bigrct.top;                                               
//#19484                            setMap(INIT);
//#19485                            flin[0].x=flin[3].x=flin[4].x=bigrct.left;                                               
//#19486                            flin[1].x=flin[2].x=bigrct.right;                                               
//#19487                            flin[0].y=flin[1].y=flin[4].y=bigrct.top;                                               
//#19488                            flin[2].y=flin[3].y=bigrct.bottom;                                               
//#19489                            setMap(SHOSTRTCH);                                               
//#19490                            strtchbox();                                               
//#19491                            fmovdif.x=((bigrct.right-bigrct.left)>>1);                                               
//#19492                            fmovdif.y=((bigrct.bottom-bigrct.top)>>1);                                               
//#19493                            setMap(MOVFRMS);                                               
//#19494                            setMap(FUNSCLP);                                               
//#19495                        }                                                   
//#19496                        else{                                                   
//#19497                                                                           
//#19498                            frmclpdat=(FRMCLP*)clpvoid;                                               
//#19499                            if(frmclpdat->led==CLP_FRM){                                               
//#19500                                                                           
//#19501                                fmovdif.x=fmovdif.y=0;                                           
//#19502                                setMap(FUNCLP);                                           
//#19503                                clofind=formpnt;                                           
//#19504                                fvars(formpnt);                                           
//#19505                                frmcpy(&formlst[formpnt],&frmclpdat->frm);                                           
//#19506                                formlst[formpnt].at=(formlst[formpnt].at&NFRMLMSK)|(actl<<1);                                           
//#19507                                frmpnt->flt=adflt(formlst[formpnt].sids);                                           
//#19508                                flt=(FLPNT*)&frmclpdat[1];                                           
//#19509                                mvflpnt(&frmpnt->flt[0],&flt[0],frmpnt->sids);                                           
//#19510                                sac=(SATCON*)&flt[frmpnt->sids];                                           
//#19511                                ind=0;                                           
//#19512                                if(frmpnt->typ==SAT&&frmpnt->stpt){                                           
//#19513                                                                           
//#19514                                    frmpnt->sacang.sac=adsatk(frmpnt->stpt);                                       
//#19515                                    mvsatk(&frmpnt->sacang.sac[0],&sac[0],frmpnt->stpt);                                       
//#19516                                }                                           
//#19517                                clp=(FLPNT*)&sac[ind];                                           
//#19518                                inf=0;
//#19519                                if(isclpx(formpnt)){                                           
//#19520                                                                           
//#19521                                    frmpnt->angclp.clp=adclp(frmpnt->flencnt.nclp);                                       
//#19522                                    mvflpnt(frmpnt->angclp.clp,clp,frmpnt->flencnt.nclp);                                       
//#19523                                    inf+=frmpnt->flencnt.nclp;                                       
//#19524                                }                                           
//#19525                                if(iseclpx(formpnt)){                                           
//#19526                                                                           
//#19527                                    clp=(FLPNT*)&clp[inf];                                       
//#19528                                    frmpnt->clp=adclp(frmpnt->nclp);                                       
//#19529                                    mvflpnt(frmpnt->clp,clp,frmpnt->nclp);                                       
//#19530                                    inf+=frmpnt->nclp;                                       
//#19531                                }                                           
//#19532                                pts=(TXPNT*)&clp[inf];                                           
//#19533                                if(istx(formpnt))                                           
//#19534                                {                                           
//#19535                                    frmpnt->dhx.txt.ind=txad;                                       
//#19536                                    ptx=adtx(frmpnt->dhx.txt.cnt);                                       
//#19537                                    MoveMemory(ptx,pts,frmpnt->dhx.txt.cnt*sizeof(TXPNT));                                       
//#19538                                }                                           
//#19539                            }                                               
//#19540                            GlobalUnlock(hClpMem);                                               
//#19541                            setMap(INIT);                                               
//#19542                            nuflen=frmpnt->sids;                                               
//#19543                            if(frmpnt->typ!=LIN)                                               
//#19544                                nuflen++;                                           
//#19545                            unfrm();                                               
//#19546                            duzrat();                                               
//#19547                            setmfrm();                                               
//#19548                            setMap(SHOFRM);                                               
//#19549                            dufrm();                                               
//#19550                        }                                                   
//#19551                    }                                                       
//#19552                    else{
//#19553                                                                           
//#19554                        hClip=RegisterClipboardFormat(pcdClip);                                                   
//#19555                        hClpMem=GetClipboardData(hClip);                                                   
//#19556                        if(hClpMem){                                                   
//#19557                                                                           
//#19558                            redclp();                                               
//#19559                            clpbox();                                               
//#19560                            setMap(CLPSHO);                                               
//#19561                        }                                                   
//#19562                    }                                                       
//#19563                    CloseClipboard();                                                       
//#19564                }                                                           
//#19565                else                                                           
//#19566                    closPnt();                                                       
//#19567                break;                                                           
//#19568                                                                           
//#19569            case 'C':                                                               
//#19570                                                                           
//#19571                if(GetKeyState(VK_CONTROL)&0X8000)                                                           
//#19572                    duclip();                                                       
//#19573                else{                                                           
//#19574                                                                           
//#19575                    if(GetKeyState(VK_SHIFT)&0X8000){                                                       
//#19576                                                                           
//#19577                        rstMap(CNV2FTH);                                                   
//#19578                        ribon();                                                   
//#19579                    }                                                       
//#19580                    else{                                                       
//#19581                                                                           
//#19582                        rstMap(HIDSTCH);                                                   
//#19583                        setMap(IGNTHR);                                                   
//#19584                        rebox();                                                   
//#19585                        rstMap(IGNTHR);                                                   
//#19586                        setMap(RESTCH);
//#19587                    }                                                       
//#19588                }                                                           
//#19589                break;                                                           
//#19590                                                                           
//#19591            case VK_HOME:                                                               
//#19592                                                                           
//#19593                if(GetKeyState(VK_SHIFT)&0X8000&&GetKeyState(VK_CONTROL)&0X8000){                                                           
//#19594                                                                           
//#19595                    if(rstMap(SELBOX)){                                                       
//#19596                                                                           
//#19597                        grpInd=0;                                                   
//#19598                        dubx();                                                   
//#19599                        setMap(GRPSEL);                                                   
//#19600                    }                                                       
//#19601                    else{                                                       
//#19602                                                                           
//#19603                        if(chkMap(GRPSEL)){                                                   
//#19604                                                                           
//#19605                            if(grpInd>cloInd)                                               
//#19606                                cloInd=0;                                           
//#19607                            else                                               
//#19608                                grpInd=0;                                           
//#19609                        }                                                   
//#19610                        else{                                                   
//#19611                                                                           
//#19612                            setMap(SELBOX);                                               
//#19613                            setMap(RESTCH);                                               
//#19614                        }                                                   
//#19615                    }                                                       
//#19616                    grpAdj();                                                       
//#19617                    redraw(hBar);                                                       
//#19618                    return 1;                                                       
//#19619                }                                                           
//#19620                if(GetKeyState(VK_SHIFT)&0X8000){
//#19621                                                                           
//#19622                    if(rstMap(SELBOX)){                                                       
//#19623                                                                           
//#19624                        dubx();                                                   
//#19625                        setMap(GRPSEL);                                                   
//#19626                        ind=pt2colInd(cloInd);                                                   
//#19627                    }                                                       
//#19628                    else                                                       
//#19629                        ind=pt2colInd(grpInd);                                                   
//#19630                    ind--;                                                       
//#19631                    grpInd=colch[ind].stind;                                                       
//#19632                    grpAdj();                                                       
//#19633                    redraw(hBar);                                                       
//#19634                }                                                           
//#19635                else{                                                           
//#19636                                                                           
//#19637                    if(GetKeyState(VK_CONTROL)&0X8000){                                                       
//#19638                                                                           
//#19639                        stch2px1(0);                                                   
//#19640                        endpnt();                                                   
//#19641                        rstMap(BAKEND);                                                   
//#19642                        setMap(RESTCH);                                                   
//#19643                    }                                                       
//#19644                    else{                                                       
//#19645                                                                           
//#19646                        if(chkMap(SELBOX)){                                                   
//#19647                                                                           
//#19648                            ind=pt2colInd(cloInd);                                               
//#19649                            if(ind)                                               
//#19650                                ind--;                                           
//#19651                            cloInd=colch[ind].stind;                                               
//#19652                        }                                                   
//#19653                        else{                                                   
//#19654
//#19655                            if(chkMap(LENSRCH)){                                               
//#19656                                                                           
//#19657                                setsrch(minpnt);                                           
//#19658                                return 1;                                           
//#19659                            }                                               
//#19660                            else                                               
//#19661                                cloInd=0;                                           
//#19662                        }                                                   
//#19663                        movbox();                                                   
//#19664                    }                                                       
//#19665                }                                                           
//#19666                break;                                                           
//#19667                                                                           
//#19668            case VK_END:                                                               
//#19669                                                                           
//#19670                if(GetKeyState(VK_SHIFT)&0X8000&&GetKeyState(VK_CONTROL)&0X8000){                                                           
//#19671                                                                           
//#19672                    if(rstMap(SELBOX)){                                                       
//#19673                                                                           
//#19674                        grpInd=hed.stchs-1;                                                   
//#19675                        dubx();                                                   
//#19676                        setMap(GRPSEL);                                                   
//#19677                    }                                                       
//#19678                    else{                                                       
//#19679                                                                           
//#19680                        if(chkMap(GRPSEL)){                                                   
//#19681                                                                           
//#19682                            if(grpInd>cloInd)                                               
//#19683                                grpInd=hed.stchs-1;                                           
//#19684                            else                                               
//#19685                                cloInd=hed.stchs-1;                                           
//#19686                        }                                                   
//#19687                        else{                                                   
//#19688
//#19689                            setMap(SELBOX);                                               
//#19690                            cloInd=hed.stchs-1;                                               
//#19691                            setMap(RESTCH);                                               
//#19692                            return 1;                                               
//#19693                        }                                                   
//#19694                    }                                                       
//#19695                    grpAdj();                                                       
//#19696                    redraw(hBar);                                                       
//#19697                    break;                                                       
//#19698                }                                                           
//#19699                if(GetKeyState(VK_SHIFT)&0X8000){                                                           
//#19700                                                                           
//#19701                    if(rstMap(SELBOX)){                                                       
//#19702                                                                           
//#19703                        dubx();                                                   
//#19704                        setMap(GRPSEL);                                                   
//#19705                        ind=pt2colInd(cloInd);                                                   
//#19706                    }                                                       
//#19707                    else                                                       
//#19708                        ind=pt2colInd(grpInd);                                                   
//#19709                    grpInd=colch[ind].stind-1;                                                       
//#19710                    grpAdj();                                                       
//#19711                    redraw(hBar);                                                       
//#19712                }                                                           
//#19713                else{                                                           
//#19714                                                                           
//#19715                    if(GetKeyState(VK_CONTROL)&0X8000){                                                       
//#19716                                                                           
//#19717                        stch2px1(hed.stchs-1);                                                   
//#19718                        endpnt();                                                   
//#19719                        setMap(BAKEND);                                                   
//#19720                        setMap(RESTCH);                                                   
//#19721                    }                                                       
//#19722                    else{
//#19723                                                                           
//#19724                        if(chkMap(SELBOX)){                                                   
//#19725                                                                           
//#19726                            ind=pt2colInd(cloInd);                                               
//#19727                            cloInd=colch[ind].stind-1;                                               
//#19728                        }                                                   
//#19729                        else{                                                   
//#19730                                                                           
//#19731                            if(chkMap(LENSRCH)){                                               
//#19732                                                                           
//#19733                                setsrch(maxpnt);                                           
//#19734                                return 1;                                           
//#19735                            }                                               
//#19736                            else                                               
//#19737                                cloInd=hed.stchs-1;                                           
//#19738                        }                                                   
//#19739                        movbox();                                                   
//#19740                    }                                                       
//#19741                }                                                           
//#19742                break;                                                           
//#19743                                                                           
//#19744            case VK_RIGHT:                                                               
//#19745                                                                           
//#19746                fvars(clofind);                                                           
//#19747                if(GetKeyState(VK_SHIFT)&0X8000){                                                           
//#19748                                                                           
//#19749                    if(chkMap(FPSEL)){                                                       
//#19750                                                                           
//#19751                        if(chkMap(PSELDIR)){                                                   
//#19752                                                                           
//#19753                            ++pselrng.cnt%=sids;                                               
//#19754                            pselrng.fin=(pselrng.strt+pselrng.cnt)%sids;                                               
//#19755                        }                                                   
//#19756                        else{
//#19757                                                                           
//#19758                            if(pselrng.cnt){                                               
//#19759                                                                           
//#19760                                pselrng.cnt--;                                           
//#19761                                pselrng.fin=(pselrng.strt+sids-pselrng.cnt)%sids;                                           
//#19762                            }                                               
//#19763                            else{                                               
//#19764                                                                           
//#19765                                pselrng.cnt=1;                                           
//#19766                                setMap(PSELDIR);                                           
//#19767                                pselrng.fin=(pselrng.strt+1)%sids;                                           
//#19768                            }                                               
//#19769                        }                                                   
//#19770                        setpsel();                                                   
//#19771                    }                                                       
//#19772                    else{                                                       
//#19773                                                                           
//#19774                        if(rstMap(FRMPSEL)){                                                   
//#19775                                                                           
//#19776                            unpsel();                                               
//#19777                            pselrng.strt=clofine;                                               
//#19778                            pselrng.frm=clofind;                                               
//#19779                            pselrng.cnt=1;                                               
//#19780                            pselrng.fin=(pselrng.strt+1)%sids;                                               
//#19781                            setMap(PSELDIR);                                               
//#19782                            setpsel();                                               
//#19783                        }                                                   
//#19784                        else{                                                   
//#19785                                                                           
//#19786                            rstMap(LENSRCH);                                               
//#19787                            rstMap(FORMSEL);                                               
//#19788                            if(rstMap(SELBOX)){                                               
//#19789                                                                           
//#19790                                dubx();
//#19791                                if(cloInd<(unsigned)hed.stchs-1){                                           
//#19792                                                                           
//#19793                                    setMap(GRPSEL);                                       
//#19794                                    grpInd=cloInd+1;                                       
//#19795                                }                                           
//#19796                            }                                               
//#19797                            else{                                               
//#19798                                                                           
//#19799                                if(grpInd<(unsigned)hed.stchs-1){                                           
//#19800                                                                           
//#19801                                    grpInd++;                                       
//#19802                                    nuAct(grpInd);                                       
//#19803                                }                                           
//#19804                            }                                               
//#19805                            grpAdj();                                               
//#19806                            redraw(hBar);                                               
//#19807                        }                                                   
//#19808                    }                                                       
//#19809                }                                                           
//#19810                else{                                                           
//#19811                                                                           
//#19812                    if(GetKeyState(VK_CONTROL)&0X8000)                                                       
//#19813                        nudgfn(ini.nudg,0);                                                   
//#19814                    else{                                                       
//#19815                                                                           
//#19816                        if(chkMap(LENSRCH)){                                                   
//#19817                                                                           
//#19818                            longer();                                               
//#19819                            setMap(RESTCH);                                               
//#19820                        }                                                   
//#19821                        else{                                                   
//#19822                                                                           
//#19823                            if(chkMap(FRMPSEL)){                                               
//#19824
//#19825                                fvars(clofind);                                           
//#19826                                clofine=nxt(clofine);                                           
//#19827                                ritnum(STR_NUMPNT,clofine);                                           
//#19828                                ritfcor(&formlst[clofind].flt[clofine]);                                           
//#19829                                shftflt(formlst[clofind].flt[clofine]);                                           
//#19830                                setMap(RESTCH);                                           
//#19831                            }                                               
//#19832                            else{                                               
//#19833                                                                           
//#19834                                if(chkMap(SELBOX)){                                           
//#19835                                                                           
//#19836                                    if(cloInd<(unsigned)hed.stchs-1)                                       
//#19837                                        cloInd++;                                   
//#19838                                    movbox();                                       
//#19839                                    return 1;                                       
//#19840                                }                                           
//#19841                                if(chkMap(GRPSEL)){                                           
//#19842                                                                           
//#19843                                    if(grpInd<(unsigned)hed.stchs-1){                                       
//#19844                                                                           
//#19845                                        grpInd++;                                   
//#19846                                        grpAdj();                                   
//#19847                                        redraw(hBar);                                   
//#19848                                    }                                       
//#19849                                }                                           
//#19850                            }                                               
//#19851                        }                                                   
//#19852                    }                                                       
//#19853                }                                                           
//#19854                break;                                                           
//#19855                                                                           
//#19856            case VK_LEFT:                                                               
//#19857                                                                           
//#19858                if(GetKeyState(VK_SHIFT)&0X8000){
//#19859                                                                           
//#19860                    if(chkMap(FPSEL)){                                                       
//#19861                                                                           
//#19862                        if(!chkMap(PSELDIR)){                                                   
//#19863                                                                           
//#19864                            ++pselrng.cnt%=sids;                                               
//#19865                            pselrng.fin=(pselrng.strt+sids-pselrng.cnt)%sids;                                               
//#19866                        }                                                   
//#19867                        else{                                                   
//#19868                                                                           
//#19869                            if(pselrng.cnt){                                               
//#19870                                                                           
//#19871                                pselrng.cnt--;                                           
//#19872                                pselrng.fin=(pselrng.strt+sids-pselrng.cnt)%sids;                                           
//#19873                            }                                               
//#19874                            else{                                               
//#19875                                                                           
//#19876                                pselrng.cnt=1;                                           
//#19877                                pselrng.fin=(pselrng.strt+sids-1)%sids;                                           
//#19878                                rstMap(PSELDIR);                                           
//#19879                            }                                               
//#19880                        }                                                   
//#19881                        setpsel();                                                   
//#19882                    }                                                       
//#19883                    else{                                                       
//#19884                                                                           
//#19885                        if(rstMap(FRMPSEL)){                                                   
//#19886                                                                           
//#19887                            unpsel();                                               
//#19888                            pselrng.strt=clofine;                                               
//#19889                            pselrng.cnt=1;                                               
//#19890                            rstMap(PSELDIR);                                               
//#19891                            setpsel();                                               
//#19892                        }
//#19893                        else{                                                   
//#19894                                                                           
//#19895                            rstMap(LENSRCH);                                               
//#19896                            rstMap(FORMSEL);                                               
//#19897                            if(rstMap(SELBOX)){                                               
//#19898                                                                           
//#19899                                dubx();                                           
//#19900                                setMap(GRPSEL);                                           
//#19901                                grpInd=cloInd-1;                                           
//#19902                            }                                               
//#19903                            else                                               
//#19904                                if(grpInd){                                           
//#19905                                                                           
//#19906                                    grpInd--;                                       
//#19907                                    nuAct(grpInd);                                       
//#19908                                }                                           
//#19909                            grpAdj();                                               
//#19910                            redraw(hBar);                                               
//#19911                        }                                                   
//#19912                    }                                                       
//#19913                }                                                           
//#19914                else{                                                           
//#19915                                                                           
//#19916                    if(GetKeyState(VK_CONTROL)&0X8000)                                                       
//#19917                        nudgfn(-ini.nudg,0);                                                   
//#19918                    else{                                                       
//#19919                                                                           
//#19920                        if(chkMap(LENSRCH)){
//#19921                                                                           
//#19922                            shorter();                                               
//#19923                            setMap(RESTCH);                                               
//#19924                        }                                                   
//#19925                        else{                                                   
//#19926
//#19927                            if(chkMap(FRMPSEL)){                                               
//#19928                                                                           
//#19929                                fvars(clofind);                                           
//#19930                                clofine=prv(clofine);                                           
//#19931                                ritnum(STR_NUMPNT,clofine);                                           
//#19932                                ritfcor(&formlst[clofind].flt[clofine]);                                           
//#19933                                shftflt(formlst[clofind].flt[clofine]);                                           
//#19934                                setMap(RESTCH);                                           
//#19935                            }                                               
//#19936                            else{                                               
//#19937                                                                           
//#19938                                if(chkMap(SELBOX)){                                           
//#19939                                                                           
//#19940                                    if(cloInd)
//#19941                                        cloInd--;
//#19942                                    movbox();
//#19943                                    return 1;
//#19944                                }
//#19945                                if(chkMap(GRPSEL)){
//#19946
//#19947                                    if(grpInd){
//#19948
//#19949                                        grpInd--;
//#19950                                        grpAdj();
//#19951                                        redraw(hBar);
//#19952                                    }
//#19953                                }
//#19954                            }
//#19955                        }
//#19956                    }
//#19957                }
//#19958                break;
//#19959
//#19960            case 'G':
//#19961
//#19962                mark();
//#19963                break;
//#19964
//#19965            case 'M':
//#19966
//#19967                if(GetKeyState(VK_CONTROL)&0x8000)
//#19968                    pntmrk();
//#19969                else{
//#19970
//#19971                    if(GetKeyState(VK_SHIFT)&0X8000)
//#19972                        dumrk(zum0.x/2,zum0.y/2);
//#19973                    else{
//#19974
//#19975                        if(px2stch())
//#19976                            dumrk(sPnt.x,sPnt.y);
//#19977                    }
//#19978                    setMap(RESTCH);
//#19979                }
//#19980                break;
//#19981
//#19982            case 'L':
//#19983
//#19984                if(GetKeyState(VK_SHIFT)&0x8000)
//#19985                    delstch();
//#19986                else
//#19987                    fcntr();
//#19988                break;
//#19989
//#19990            case VK_DELETE:
//#19991
//#19992                if(chkMsgs(msg.pt,hDef[0],hDef[15]))
//#19993                    delcol();
//#19994                else
//#19995                    delet();
//#19996                break;
//#19997            }
//#19998            break;
//#19999
end;

//#20000        case WM_COMMAND:
//#20001
//#20002            unmsg();
//#20003            if(chkMap(FORMSEL))
//#20004                fvars(clofind);
//#20005            for(ind=0;ind<OLDNUM;ind++){
//#20006
//#20007                if(msg.wParam==fmenid[ind]){
//#20008
//#20009                    strcpy(filnam,ini.oldnams[ind]);
//#20010                    setMap(REDOLD);
//#20011                    nuFil();
//#20012                }
//#20013            }
//#20014            ind=LOWORD(msg.wParam);
//#20015            if(ind>40000&&ind<40400)
//#20016                undat();
//#20017            switch(LOWORD(msg.wParam)){
//#20018
//#20019            case ID_CHKOF:
//#20020
//#20021                chgchk(0);
//#20022                break;
//#20023
//#20024            case ID_CHKON:
//#20025
//#20026                chgchk(1);
//#20027                break;
//#20028
//#20029            case ID_CHKREP:
//#20030
//#20031                chgchk(2);
//#20032                break;
//#20033
//#20034            case ID_CHKREPMSG:
//#20035
//#20036                chgchk(3);
//#20037                break;
//#20038
//#20039            case ID_REPAIR:
//#20040
//#20041                repar();
//#20042                break;
//#20043                                                                           
//#20044            case ID_WARNOF:                                                               
//#20045                                                                           
//#20046                chgwrn();                                                           
//#20047                break;                                                           
//#20048                                                                           
//#20049            case ID_CLPSPAC:                                                               
//#20050                                                                           
//#20051                setclpspac();                                                           
//#20052                break;                                                           
//#20053                                                                           
//#20054            case ID_FRMIND:                                                               
//#20055                                                                           
//#20056                setfind();                                                           
//#20057                break;                                                           
//#20058
//#20059            case ID_SETSIZ:                                                               
//#20060                                                                           
//#20061                nudsiz();                                                           
//#20062                break;                                                           
//#20063                                                                           
//#20064            case ID_TXFIL:                                                               
//#20065                                                                           
//#20066                dutxtfil();                                                           
//#20067                break;                                                           
//#20068                                                                           
//#20069            case ID_FRMHI:                                                               
//#20070                                                                           
//#20071                setfhi();                                                           
//#20072                break;                                                           
//#20073                                                                           
//#20074            case ID_FRMWID:                                                               
//#20075                                                                           
//#20076                setfwid();                                                           
//#20077                break;                                                           
//#20078
//#20079            case ID_MAXFLEN:                                                               
//#20080                                                                           
//#20081                setfmax();                                                           
//#20082                break;                                                           
//#20083                                                                           
//#20084            case ID_MINFLEN:                                                               
//#20085                                                                           
//#20086                setfmin();                                                           
//#20087                break;                                                           
//#20088                                                                           
//#20089            case ID_MAXBLEN:                                                               
//#20090                                                                           
//#20091                setbmax();                                                           
//#20092                break;                                                           
//#20093                                                                           
//#20094            case ID_MINBLEN:                                                               
//#20095                                                                           
//#20096                setbmin();                                                           
//#20097                break;                                                           
//#20098
//#20099            case ID_SETBSPAC:                                                               
//#20100                                                                           
//#20101                setbspac();                                                           
//#20102                break;                                                           
//#20103                                                                           
//#20104            case ID_SETBLEN:                                                               
//#20105                                                                           
//#20106                setblen();                                                           
//#20107                break;                                                           
//#20108                                                                           
//#20109            case ID_SETBCOL:                                                               
//#20110                                                                           
//#20111                setbcol();                                                           
//#20112                break;                                                           
//#20113                                                                           
//#20114            case ID_SETFCOL:                                                               
//#20115                                                                           
//#20116                setfcol();                                                           
//#20117                break;                                                           
//#20118
//#20119            case ID_SETUCOL:                                                               
//#20120                                                                           
//#20121                setucol();                                                           
//#20122                break;                                                           
//#20123                                                                           
//#20124            case ID_SETFANG:                                                               
//#20125                                                                           
//#20126                setfang();                                                           
//#20127                break;                                                           
//#20128                                                                           
//#20129            case ID_SETFSPAC:                                                               
//#20130                                                                           
//#20131                setfspac();                                                           
//#20132                break;                                                           
//#20133                                                                           
//#20134            case ID_SETFLEN:                                                               
//#20135                                                                           
//#20136                setflen();                                                           
//#20137                break;                                                           
//#20138
//#20139            case ID_SETUANG:                                                               
//#20140                                                                           
//#20141                sfuang();                                                           
//#20142                break;                                                           
//#20143                                                                           
//#20144            case ID_SETUSPAC:                                                               
//#20145                                                                           
//#20146                uspac();                                                           
//#20147                break;                                                           
//#20148                                                                           
//#20149            case ID_UNDLEN:                                                               
//#20150                                                                           
//#20151                undlen();                                                           
//#20152                break;                                                           
//#20153                                                                           
//#20154            case ID_SETCWLK:                                                               
//#20155                                                                           
//#20156                setcwlk();                                                           
//#20157                break;                                                           
//#20158
//#20159            case ID_SETWLK:                                                               
//#20160                                                                           
//#20161                setwlk();                                                           
//#20162                break;                                                           
//#20163                                                                           
//#20164            case ID_SETUND:                                                               
//#20165                                                                           
//#20166                setund();                                                           
//#20167                break;                                                           
//#20168                                                                           
//#20169            case ID_NOTCWLK:                                                               
//#20170                                                                           
//#20171                notcwlk();                                                           
//#20172                break;                                                           
//#20173                                                                           
//#20174            case ID_NOTWLK:                                                               
//#20175                                                                           
//#20176                notwlk();                                                           
//#20177                break;                                                           
//#20178
//#20179            case ID_NOTUND:                                                               
//#20180                                                                           
//#20181                notund();                                                           
//#20182                break;                                                           
//#20183                                                                           
//#20184            case ID_SELUND:                                                               
//#20185                                                                           
//#20186                selfil(UNDMSK);                                                           
//#20187                break;                                                           
//#20188                                                                           
//#20189            case ID_SELWLK:                                                               
//#20190                                                                           
//#20191                selfil(WLKMSK);                                                           
//#20192                break;                                                           
//#20193                                                                           
//#20194            case ID_ALFRM:                                                               
//#20195                                                                           
//#20196                selalfrm();                                                           
//#20197                break;                                                           
//#20198
//#20199            case ID_USPAC:                                                               
//#20200                                                                           
//#20201                setuspac();                                                           
//#20202                break;                                                           
//#20203                                                                           
//#20204            case ID_UANG:                                                               
//#20205                                                                           
//#20206                setuang();                                                           
//#20207                break;                                                           
//#20208                                                                           
//#20209            case ID_USTCH:                                                               
//#20210                                                                           
//#20211                setulen();                                                           
//#20212                break;                                                           
//#20213                                                                           
//#20214            case ID_WIND:                                                               
//#20215                                                                           
//#20216                setwlkind();                                                           
//#20217                break;                                                           
//#20218
//#20219            case ID_FILSTRT:                                                               
//#20220                                                                           
//#20221                setfilstrt();                                                           
//#20222                break;                                                           
//#20223                                                                           
//#20224            case ID_FILEND:                                                               
//#20225                                                                           
//#20226                setfilend();                                                           
//#20227                break;                                                           
//#20228                                                                           
//#20229            case ID_PES2CRD:                                                               
//#20230                                                                           
//#20231                pes2crd();                                                           
//#20232                break;                                                           
//#20233                                                                           
//#20234            case ID_2FTHR:                                                               
//#20235                                                                           
//#20236                setMap(CNV2FTH);                                                           
//#20237                ribon();                                                           
//#20238                break;
//#20239                                                                           
//#20240            case ID_FETHR:                                                               
//#20241                                                                           
//#20242                fethr();                                                           
//#20243                break;                                                           
//#20244                                                                           
//#20245            case ID_FTHDEF:                                                               
//#20246                                                                           
//#20247                dufdef();                                                           
//#20248                break;                                                           
//#20249                                                                           
//#20250            case ID_SRTF:                                                               
//#20251                                                                           
//#20252                srtfrm();                                                           
//#20253                break;                                                           
//#20254                                                                           
//#20255            case ID_FILCLPX:                                                               
//#20256                                                                           
//#20257                filclpx();                                                           
//#20258                break;
//#20259                                                                           
//#20260            case ID_FRMX:                                                               
//#20261                                                                           
//#20262                frmcursel(1);                                                           
//#20263                break;                                                           
//#20264                                                                           
//#20265            case ID_FRMBOX:                                                               
//#20266                                                                           
//#20267                frmcursel(0);                                                           
//#20268                break;                                                           
//#20269                                                                           
//#20270            case ID_KNOTAT:                                                               
//#20271                                                                           
//#20272                set1knot();                                                           
//#20273                break;                                                           
//#20274                                                                           
//#20275            case ID_STCHPIX:                                                               
//#20276                                                                           
//#20277                getstpix();;                                                           
//#20278                break;
//#20279
//#20280            case ID_FRMPIX:
//#20281
//#20282                getfrmpix();
//#20283                break;
//#20284
//#20285            case ID_FRMPBOX:
//#20286
//#20287                getfrmbox();
//#20288                break;
//#20289
//#20290            case ID_CROP:
//#20291
//#20292                crop();
//#20293                break;
//#20294
//#20295            case ID_BAKMRK:                                                               
//#20296                                                                           
//#20297                bakmrk();                                                           
//#20298                break;                                                           
//#20299                                                                           
//#20300            case ID_MARKESC:                                                               
//#20301                                                                           
//#20302                setu(MARQ);                                                           
//#20303                qchk();                                                           
//#20304                break;                                                           
//#20305                                                                           
//#20306            case ID_MARKQ:                                                               
//#20307                                                                           
//#20308                rstu(MARQ);                                                           
//#20309                qchk();                                                           
//#20310                break;                                                           
//#20311                                                                           
//#20312            case ID_NUDGPIX:                                                               
//#20313                                                                           
//#20314                getnpix();
//#20315                break;                                                           
//#20316                                                                           
//#20317            case ID_LINCHN:                                                               
//#20318                                                                           
//#20319                setMap(LINCHN);                                                           
//#20320                chain();                                                           
//#20321                break;                                                           
//#20322                                                                           
//#20323            case ID_OPNCHN:                                                               
//#20324                                                                           
//#20325                rstMap(LINCHN);                                                           
//#20326                chain();                                                           
//#20327                break;                                                           
//#20328                                                                           
//#20329            case ID_CLOSE:                                                               
//#20330                                                                           
//#20331                filclos();                                                           
//#20332                break;                                                           
//#20333                                                                           
//#20334            case ID_DELMAP:
//#20335                                                                           
//#20336                delmap();                                                           
//#20337                break;                                                           
//#20338                                                                           
//#20339            case ID_BLAK:                                                               
//#20340                                                                           
//#20341                blak();                                                           
//#20342                break;                                                           
//#20343                                                                           
//#20344            case ID_SAVMAP:                                                               
//#20345                                                                           
//#20346                savmap();                                                           
//#20347                break;                                                           
//#20348                                                                           
//#20349            case ID_TRDIF:                                                               
//#20350                                                                           
//#20351                trdif();                                                           
//#20352                break;                                                           
//#20353                                                                           
//#20354            case ID_TRACEDG:
//#20355                                                                           
//#20356                tracedg();                                                           
//#20357                break;                                                           
//#20358                                                                           
//#20359            case ID_TRCSEL:                                                               
//#20360                                                                           
//#20361                trcsel();                                                           
//#20362                break;                                                           
//#20363                                                                           
//#20364            case ID_TRACE:                                                               
//#20365                                                                           
//#20366                trinit();                                                           
//#20367                break;                                                           
//#20368                                                                           
//#20369            case ID_FLOK:                                                               
//#20370                                                                           
//#20371                lock();                                                           
//#20372                break;                                                           
//#20373                                                                           
//#20374            case ID_ROTAUXON:
//#20375                                                                           
//#20376                rotauxsel(1);                                                           
//#20377                break;                                                           
//#20378                                                                           
//#20379            case ID_ROTAUXOFF:                                                               
//#20380                                                                           
//#20381                rotauxsel(0);                                                           
//#20382                break;                                                           
//#20383                                                                           
//#20384            case ID_FRM2COL:                                                               
//#20385                                                                           
//#20386                col2frm();                                                           
//#20387                break;                                                           
//#20388                                                                           
//#20389            case ID_SNAP2GRD:                                                               
//#20390                                                                           
//#20391                gsnap();                                                           
//#20392                break;                                                           
//#20393                                                                           
//#20394            case ID_FIL2SEL_ON:
//#20395                                                                           
//#20396                fil2sel(1);                                                           
//#20397                break;                                                           
//#20398                                                                           
//#20399            case ID_FIL2SEL_OFF:                                                               
//#20400                                                                           
//#20401                fil2sel(0);                                                           
//#20402                break;                                                           
//#20403                                                                           
//#20404            case ID_OVRLAY:                                                               
//#20405                                                                           
//#20406                ovrlay();                                                           
//#20407                break;                                                           
//#20408                                                                           
//#20409            case ID_GRDHI:                                                               
//#20410                                                                           
//#20411                setgrd(HIGRD);                                                           
//#20412                break;                                                           
//#20413                                                                           
//#20414            case ID_GRDMED:
//#20415                                                                           
//#20416                setgrd(MEDGRD);                                                           
//#20417                break;                                                           
//#20418                                                                           
//#20419            case ID_GRDEF:                                                               
//#20420                                                                           
//#20421                setgrd(DEFGRD);                                                           
//#20422                break;                                                           
//#20423                                                                           
//#20424            case ID_GRDRED:                                                               
//#20425                                                                           
//#20426                setgrd(REDGRD);                                                           
//#20427                break;                                                           
//#20428                                                                           
//#20429            case ID_GRDBLU:                                                               
//#20430                                                                           
//#20431                setgrd(BLUGRD);                                                           
//#20432                break;                                                           
//#20433                                                                           
//#20434            case ID_GRDGRN:
//#20435                                                                           
//#20436                setgrd(GRNGRD);                                                           
//#20437                break;                                                           
//#20438                                                                           
//#20439            case ID_RETRACE:                                                               
//#20440                                                                           
//#20441                retrac();                                                           
//#20442                break;                                                           
//#20443                                                                           
//#20444            case ID_DUBFIL:                                                               
//#20445                                                                           
//#20446                dubfil();                                                           
//#20447                break;                                                           
//#20448                                                                           
//#20449            case ID_HORCLP:                                                               
//#20450                                                                           
//#20451                if(chkMap(FORMSEL)||fselpnt)                                                           
//#20452                    savdo();                                                       
//#20453                horclp();                                                           
//#20454                break;
//#20455                                                                           
//#20456            case ID_ANGCLP:                                                               
//#20457                                                                           
//#20458                if(chkMap(FORMSEL)||fselpnt)                                                           
//#20459                    savdo();                                                       
//#20460                angclp();                                                           
//#20461                break;                                                           
//#20462                                                                           
//#20463            case ID_VRTCLP:                                                               
//#20464                                                                           
//#20465                if(chkMap(FORMSEL)||fselpnt)                                                           
//#20466                    savdo();                                                       
//#20467                vrtclp();                                                           
//#20468                break;                                                           
//#20469                                                                           
//#20470            case ID_LINBEXACT:                                                               
//#20471                                                                           
//#20472                rstu(LINSPAC);                                                           
//#20473                linbmen();                                                           
//#20474                break;
//#20475                                                                           
//#20476            case ID_LINBEVEN:                                                               
//#20477                                                                           
//#20478                setu(LINSPAC);                                                           
//#20479                linbmen();                                                           
//#20480                break;                                                           
//#20481                                                                           
//#20482            case ID_BSAVON:                                                               
//#20483                                                                           
//#20484                pcsbsavon();                                                           
//#20485                break;                                                           
//#20486                                                                           
//#20487            case ID_BSAVOF:                                                               
//#20488                                                                           
//#20489                pcsbsavof();                                                           
//#20490                break;                                                           
//#20491                                                                           
//#20492            case ID_KNOTON:                                                               
//#20493                                                                           
//#20494                shoknot();
//#20495                break;                                                           
//#20496                                                                           
//#20497            case ID_KNOTOF:                                                               
//#20498                                                                           
//#20499                hidknot();                                                           
//#20500                break;                                                           
//#20501                                                                           
//#20502            case ID_DELKNOT:                                                               
//#20503                                                                           
//#20504                delknot();                                                           
//#20505                break;                                                           
//#20506                                                                           
//#20507            case ID_RSTNEDL:                                                               
//#20508                                                                           
//#20509                nedof();                                                           
//#20510                break;                                                           
//#20511                                                                           
//#20512            case ID_SETNEDL:                                                               
//#20513                                                                           
//#20514                nedon();
//#20515                break;                                                           
//#20516                                                                           
//#20517            case ID_STCHS2FRM:                                                               
//#20518                                                                           
//#20519                stchs2frm();                                                           
//#20520                break;                                                           
//#20521                                                                           
//#20522            case ID_SPLTFRM:                                                               
//#20523                                                                           
//#20524                spltfrm();                                                           
//#20525                break;                                                           
//#20526                                                                           
//#20527            case ID_UNBEAN:                                                               
//#20528                                                                           
//#20529                debean();                                                           
//#20530                break;                                                           
//#20531                                                                           
//#20532            case ID_DUBEAN:                                                               
//#20533                                                                           
//#20534                dubean();
//#20535                break;                                                           
//#20536                                                                           
//#20537            case ID_SRTBF:                                                               
//#20538                                                                           
//#20539                srtbyfrm();                                                           
//#20540                break;                                                           
//#20541                                                                           
//#20542            case ID_CENTIRE:                                                               
//#20543                                                                           
//#20544                centir();                                                           
//#20545                break;                                                           
//#20546                                                                           
//#20547            case ID_CNTRX:                                                               
//#20548                                                                           
//#20549                rstMap(CNTRH);                                                           
//#20550                rstMap(CNTRV);                                                           
//#20551                cntrx();                                                           
//#20552                break;                                                           
//#20553                                                                           
//#20554            case ID_CNTRH:
//#20555                                                                           
//#20556                rstMap(CNTRH);                                                           
//#20557                setMap(CNTRV);                                                           
//#20558                cntrx();                                                           
//#20559                break;                                                           
//#20560                                                                           
//#20561            case ID_CNTRV:                                                               
//#20562                                                                           
//#20563                setMap(CNTRH);                                                           
//#20564                rstMap(CNTRV);                                                           
//#20565                cntrx();                                                           
//#20566                break;                                                           
//#20567                                                                           
//#20568            case ID_FRMNUM:                                                               
//#20569                                                                           
//#20570                frmnum();                                                           
//#20571                break;                                                           
//#20572                                                                           
//#20573            case ID_REFILF:                                                               
//#20574
//#20575                filfrms();
//#20576                break;
//#20577
//#20578            case ID_MRKPNT:
//#20579
//#20580                pntmrk();
//#20581                break;
//#20582
//#20583            case ID_ROTSEG:
//#20584
//#20585                rotseg();
//#20586                break;
//#20587
//#20588            case ID_ROTMRK:
//#20589
//#20590                rotmrk();
//#20591                break;
//#20592
//#20593            case ID_MRKCNTR:
//#20594
//#20595                dumrk(zum0.x/2,zum0.y/2);
//#20596                setMap(RESTCH);
//#20597                break;
//#20598
//#20599            case ID_SETROT:
//#20600
//#20601                setrang();
//#20602                break;
//#20603
//#20604            case ID_SETPREF:
//#20605
//#20606                defpref();
//#20607                break;
//#20608
//#20609            case ID_SHRINK:
//#20610
//#20611                shrnk();
//#20612                break;
//#20613
//#20614            case ID_DUPAGAIN:
//#20615
//#20616                redup();
//#20617                break;
//#20618
//#20619            case ID_CLPADJ:
//#20620
//#20621                clpadj();
//#20622                break;
//#20623
//#20624            case ID_DELTOT:
//#20625
//#20626                deltot();
//#20627                break;
//#20628
//#20629            case ID_AUXPCS:
//#20630
//#20631                setpcs();
//#20632                break;
//#20633
//#20634            case ID_AUXDST:
//#20635
//#20636                setdst();
//#20637                break;
//#20638
//#20639            case ID_ABOUT:
//#20640
//#20641                tabmsg(IDS_CPYRIT);
//#20642                break;
//#20643
//#20644            case ID_RIBON:
//#20645
//#20646                rstMap(CNV2FTH);
//#20647                ribon();
//#20648                break;
//#20649
//#20650            case ID_DESIZ:
//#20651
//#20652                desiz();
//#20653                break;
//#20654
//#20655            case ID_HLP:
//#20656
//#20657                help();
//#20658                break;
//#20659
//#20660            case ID_CNTR:
//#20661
//#20662                fcntr();
//#20663                break;
//#20664
//#20665            case ID_INSFIL:
//#20666
//#20667                rstMap(IGNORINS);
//#20668                insfil();
//#20669                break;
//#20670
//#20671            case ID_SELALSTCH:
//#20672
//#20673                selalstch();
//#20674                break;
//#20675
//#20676            case ID_UNGRPLO:
//#20677
//#20678                ungrplo();
//#20679                break;
//#20680
//#20681            case ID_UNGRPHI:
//#20682
//#20683                ungrphi();
//#20684                break;
//#20685
//#20686            case ID_CONTF:
//#20687
//#20688                contfil();
//#20689                break;
//#20690
//#20691            case ID_THUM:
//#20692
//#20693                thumnail();
//#20694                break;
//#20695
//#20696            case ID_PICOT:
//#20697
//#20698                picot();
//#20699                break;
//#20700
//#20701            case ID_FILBUT:
//#20702
//#20703                bhol();
//#20704                break;
//#20705
//#20706            case ID_REMBIG:
//#20707
//#20708                rembig();
//#20709                break;
//#20710
//#20711            case ID_VUSELTHRDS:
//#20712
//#20713                vuselthr();
//#20714                break;
//#20715
//#20716            case ID_VUTHRDS:
//#20717
//#20718                vuthrds();
//#20719                break;
//#20720
//#20721            case ID_MOVMRK:
//#20722
//#20723                movmrk();
//#20724                break;
//#20725
//#20726            case ID_SELFIL:
//#20727
//#20728                selfil(FRMFIL);
//#20729                break;
//#20730
//#20731            case ID_SELBRD:
//#20732
//#20733                selfil(FRMBFIL);
//#20734                break;
//#20735
//#20736            case ID_SELAP:
//#20737
//#20738                selfil(FRMAPFIL);
//#20739                break;
//#20740
//#20741            case ID_SELFSTCHS:
//#20742
//#20743                selalfil();
//#20744                break;
//#20745
//#20746            case ID_SETMRK:
//#20747
//#20748                setmov();
//#20749                break;
//#20750
//#20751            case ID_DELFRE:
//#20752
//#20753                delfre();
//#20754                break;
//#20755
//#20756            case ID_SELAL:
//#20757
//#20758                selal();
//#20759                break;
//#20760
//#20761            case ID_REFILAL:
//#20762
//#20763                refilal();
//#20764                break;
//#20765
//#20766            case ID_CHK:
//#20767
//#20768                chkrng(&rngsiz);
//#20769                setMap(RESTCH);
//#20770                break;
//#20771
//#20772            case ID_RTRVCLP:
//#20773
//#20774                rtrclp();
//#20775                break;
//#20776
//#20777            case ID_SORT:
//#20778
//#20779                fsort();
//#20780                break;
//#20781
//#20782            case ID_LAYMOV0:
//#20783
//#20784                movlayr(0);
//#20785                break;
//#20786
//#20787            case ID_LAYMOV1:
//#20788
//#20789                movlayr(2);
//#20790                break;
//#20791
//#20792            case ID_LAYMOV2:
//#20793
//#20794                movlayr(4);
//#20795                break;
//#20796
//#20797            case ID_LAYMOV3:
//#20798
//#20799                movlayr(6);
//#20800                break;
//#20801
//#20802            case ID_LAYMOV4:
//#20803
//#20804                movlayr(8);
//#20805                break;
//#20806
//#20807            case ID_LAYCPY0:
//#20808
//#20809                cpylayr(0);
//#20810                break;
//#20811
//#20812            case ID_LAYCPY1:
//#20813
//#20814                cpylayr(2);
//#20815                break;
//#20816
//#20817            case ID_LAYCPY2:
//#20818
//#20819                cpylayr(4);
//#20820                break;
//#20821
//#20822            case ID_LAYCPY3:
//#20823
//#20824                cpylayr(6);
//#20825                break;
//#20826
//#20827            case ID_LAYCPY4:
//#20828
//#20829                cpylayr(8);
//#20830                break;
//#20831
//#20832            case ID_LA:
//#20833
//#20834                nulayr(0);
//#20835                break;
//#20836
//#20837            case ID_L1:
//#20838
//#20839                nulayr(1);
//#20840                break;
//#20841
//#20842            case ID_L2:                                                               
//#20843                                                                           
//#20844                nulayr(2);                                                           
//#20845                break;                                                           
//#20846                                                                           
//#20847            case ID_L3:                                                               
//#20848                                                                           
//#20849                nulayr(3);                                                           
//#20850                break;                                                           
//#20851                                                                           
//#20852            case ID_L4:                                                               
//#20853                                                                           
//#20854                nulayr(4);                                                           
//#20855                break;                                                           
//#20856                                                                           
//#20857            case ID_ROTDUP:                                                               
//#20858                                                                           
//#20859                rotdup();                                                           
//#20860                break;                                                           
//#20861
//#20862            case ID_ROTAGAIN:                                                               
//#20863                                                                           
//#20864                rotagain();                                                           
//#20865                break;                                                           
//#20866                                                                           
//#20867            case ID_ROTCMD:                                                               
//#20868                                                                           
//#20869                rotcmd();                                                           
//#20870                break;                                                           
//#20871                                                                           
//#20872            case ID_DELFRMS:                                                               
//#20873                                                                           
//#20874                delfrms();                                                           
//#20875                rstAll();                                                           
//#20876                setMap(RESTCH);                                                           
//#20877                break;                                                           
//#20878                                                                           
//#20879            case ID_SNAP2:                                                               
//#20880                                                                           
//#20881                snap();
//#20882                break;                                                           
//#20883                                                                           
//#20884            case ID_CLPFIL:                                                               
//#20885                                                                           
//#20886                clpfil();                                                           
//#20887                break;                                                           
//#20888                                                                           
//#20889            case ID_FLPORD:                                                               
//#20890                                                                           
//#20891                flpord();                                                           
//#20892                break;                                                           
//#20893                                                                           
//#20894            case ID_FRMOF:                                                               
//#20895                                                                           
//#20896                if(GetKeyState(VK_SHIFT)&0X8000)                                                           
//#20897                    tglhid();                                                       
//#20898                else                                                           
//#20899                    tglfrm();                                                       
//#20900                break;                                                           
//#20901
//#20902            case ID_MV2BAK:                                                               
//#20903                                                                           
//#20904                mv2b();                                                           
//#20905                break;                                                           
//#20906                                                                           
//#20907            case ID_MV2FRNT:                                                               
//#20908                                                                           
//#20909                mv2f();                                                           
//#20910                break;                                                           
//#20911                                                                           
//#20912            case ID_PERP:                                                               
//#20913                                                                           
//#20914                if(chkMap(FORMSEL)||fselpnt)                                                           
//#20915                    savdo();                                                       
//#20916                prpbrd(stspace);                                                           
//#20917                break;                                                           
//#20918                                                                           
//#20919            case ID_PURGDIR:                                                               
//#20920                                                                           
//#20921                purgdir();
//#20922                break;                                                           
//#20923                                                                           
//#20924            case ID_PURG:                                                               
//#20925                                                                           
//#20926                purg();                                                           
//#20927                break;                                                           
//#20928                                                                           
//#20929            case ID_VUBAK:                                                               
//#20930                                                                           
//#20931                vubak();                                                           
//#20932                break;                                                           
//#20933                                                                           
//#20934            case ID_DELETE:                                                               
//#20935                                                                           
//#20936                delet();                                                           
//#20937                break;                                                           
//#20938                                                                           
//#20939            case ID_FLIPH:                                                               
//#20940                                                                           
//#20941                fliph();
//#20942                break;                                                           
//#20943                                                                           
//#20944            case ID_FLIPV:                                                               
//#20945                                                                           
//#20946                flipv();                                                           
//#20947                break;                                                           
//#20948                                                                           
//#20949            case ID_FILANG:                                                               
//#20950                                                                           
//#20951                if(chkMap(FORMSEL))                                                           
//#20952                    savdo();                                                       
//#20953                filangl();                                                           
//#20954                break;                                                           
//#20955                                                                           
//#20956            case ID_PREF:                                                               
//#20957                                                                           
//#20958                prfmsg();                                                           
//#20959                break;                                                           
//#20960                                                                           
//#20961            case ID_BOLD:
//#20962                                                                           
//#20963                if(chkMap(FORMSEL)||fselpnt)                                                           
//#20964                    savdo();                                                       
//#20965                dubold();                                                           
//#20966                break;                                                           
//#20967                                                                           
//#20968            case ID_ADEND:                                                               
//#20969                                                                           
//#20970                stch2px1(hed.stchs-1);                                                           
//#20971                endpnt();                                                           
//#20972                setMap(BAKEND);                                                           
//#20973                setMap(RESTCH);                                                           
//#20974                break;                                                           
//#20975                                                                           
//#20976            case ID_SETAP:                                                               
//#20977                                                                           
//#20978                setap();                                                           
//#20979                break;                                                           
//#20980                                                                           
//#20981            case ID_APLIQ:
//#20982                                                                           
//#20983                if(chkMap(FORMSEL))                                                           
//#20984                    savdo();                                                       
//#20985                apliq();                                                           
//#20986                break;                                                           
//#20987                                                                           
//#20988            case ID_SATBRD:                                                               
//#20989                                                                           
//#20990                if(chkMap(FORMSEL))                                                           
//#20991                    savdo();                                                       
//#20992                satbrd();                                                           
//#20993                break;                                                           
//#20994                                                                           
//#20995            case ID_FILCLP:                                                               
//#20996                                                                           
//#20997                fclp();                                                           
//#20998                break;                                                           
//#20999                                                                           
//#21000            case ID_FILIN:                                                               
//#21001
//#21002                if(chkMap(FORMSEL))
//#21003                    savdo();
//#21004                bord();
//#21005                break;
//#21006
//#21007            case ID_FRM0:
//#21008
//#21009                frm0();
//#21010                break;
//#21011
//#21012            case ID_REDO:
//#21013
//#21014                redo();
//#21015                break;
//#21016
//#21017            case ID_UNFIL:
//#21018
//#21019                savdo();
//#21020                unfil();
//#21021                coltab();
//#21022                setMap(RESTCH);
//#21023                break;
//#21024
procedure TfrmMain.mnu_FORMClick(Sender: TObject);
begin
//#21025            case ID_FORM:
//#21026
//#21027                frmon();
//#21028                if(chkMap(FORMSEL))
//#21029                    refrm();
//#21030                else
//#21031                    form();
//#21032                break;
end;

//#21033
//#21034            case ID_FILSAT:
//#21035
//#21036                rstMap(FTHR);
//#21037                filsat();
//#21038                break;
//#21039
//#21040            case ID_OPNPCD:
//#21041
//#21042                switch(ini.auxfil){
//#21043
//#21044                case AUXDST:
//#21045
//#21046                    ofn.nFilterIndex=3;
//#21047                    break;
//#21048
//#21049                default:
//#21050
//#21051                    ofn.nFilterIndex=2;
//#21052                }
//#21053                nuFil();
//#21054                nulayr(0);
//#21055                break;
//#21056
//#21057            case ID_DELSTCH:
//#21058
//#21059                delstch();
//#21060                break;
//#21061
//#21062            case ID_FILL_VERT:
//#21063
//#21064                if(chkMap(FORMSEL)||fselpnt)
//#21065                    savdo();
//#21066                filvrt();
//#21067                break;
//#21068
//#21069            case ID_FILL_HOR:
//#21070
//#21071                if(chkMap(FORMSEL))
//#21072                    savdo();
//#21073                filhor();
//#21074                break;
//#21075
//#21076            case ID_RUNPAT:
//#21077
//#21078                movi();
//#21079                break;
//#21080
//#21081            case ID_LENDEF:
//#21082
//#21083                ini.maxsiz=MAXSIZ*PFGRAN;
//#21084                usesiz=USESIZ*PFGRAN;
//#21085                minsiz=MINSIZ*PFGRAN;
//#21086                break;
//#21087
//#21088            case ID_TSIZDEF:
//#21089
//#21090                tsiz30=TSIZ30;
//#21091                tsiz40=TSIZ40;
//#21092                tsiz60=TSIZ60;
//#21093                break;
//#21094
//#21095            case ID_SIZ30:
//#21096
//#21097                tsizmsg("30",tsiz30);
//#21098                setMap(ENTR30);
//#21099                break;
//#21100
//#21101            case ID_SIZ40:
//#21102
//#21103                tsizmsg("40",tsiz40);
//#21104                setMap(ENTR40);
//#21105                break;
//#21106
//#21107            case ID_SIZ60:
//#21108
//#21109                tsizmsg("60",tsiz60);
//#21110                setMap(ENTR60);
//#21111                break;
//#21112
//#21113            case ID_HIDBITF:
//#21114            case ID_HIDBIT:
//#21115
//#21116                hidbit();
//#21117                break;
//#21118
//#21119            case ID_LODBIT:
//#21120
//#21121                lodbmp();
//#21122                break;
//#21123
//#21124            case ID_KNOTS:
//#21125
//#21126                setknots();
//#21127                break;
//#21128
//#21129            case ID_REMZERO:
//#21130
//#21131                duzero();
//#21132                break;
//#21133
//#21134            case ID_ROT:
//#21135
//#21136                rot();
//#21137                break;
//#21138
//#21139            case ZUMIN:
//#21140
//#21141                if(chkMap(GMRK)||chkMap(SELBOX)||chkMap(INSRT)||chkMap(GRPSEL)||chkMap(FORMSEL))
//#21142                    zumin();
//#21143                else{
//#21144
//#21145                    rstMap(BZUM);
//#21146                    setMap(BOXZUM);
//#21147                    rstMap(BZUMIN);
//#21148                    setMap(VCAPT);
//#21149                    SetCapture(hWnd);
//#21150                }
//#21151                break;
//#21152
//#21153            case ID_ZUMOUT:
//#21154
//#21155                zumout();
//#21156                break;
//#21157


//#21162                                                                           
//#21163            case ID_VIEW_STCHBAK:                                                               
//#21164                                                                           
//#21165                if(nuBak()){                                                           
//#21166                                                                           
//#21167                    stchBak=bCol.rgbResult;                                                       
//#21168                    bakPen=nuPen(bakPen,1,stchBak);                                                       
//#21169                    bakwid=1;                                                       
//#21170                    DeleteObject(hStchBak);                                                       
//#21171                    hStchBak=CreateSolidBrush(stchBak);                                                       
//#21172                    if(*bnam)                                                       
//#21173                        bfil();                                                   
//#21174                    zumhom();                                                       
//#21175                }                                                           
//#21176                break;                                                           
//#21177                                                                           
//#21178            case ID_BITCOL:                                                               
//#21179                                                                           
//#21180                if(nuBit()){                                                           
//#21181                                                                           
//#21182                    bitCol=fswap(btCol.rgbResult);                                                       
//#21183                    if(*bnam)                                                       
//#21184                        bfil();                                                   
//#21185                    bitPen=nuPen(bitPen,1,bitCol);                                                       
//#21186                    zumhom();                                                       
//#21187                }                                                           
//#21188                break;                                                           
//#21189                                                                           
//#21190            case ID_FILE_SAVE3:
//#21191
//#21192                colchk();
//#21193                savAs();
//#21194                break;                                                           
//#21195                                                                           
//#21196            case ID_EDIT_RESET_COL:                                                               
//#21197                                                                           
//#21198                for(ind=0;ind<16;ind++){                                                           
//#21199                                                                           
//#21200                    useCol[ind]=defCol[ind];                                                       
//#21201                    hbrUseCol[ind]=nuBrush(hbrUseCol[ind],useCol[ind]);                                                       
//#21202                    uPen[ind]=nuPen(uPen[ind],1,useCol[ind]);                                                       
//#21203                    redraw(hCol[ind]);                                                       
//#21204                }                                                           
//#21205                setMap(RESTCH);                                                           
//#21206                break;                                                           
//#21207                                                                           
//#21208            case ID_FILE_SAVE2:
//#21209                                                                           
//#21210                colchk();                                                           
//#21211                save();                                                           
//#21212                break;                                                           
//#21213                                                                           
//#21214            case VU_ZUMFUL:                                                               
//#21215                                                                           
//#21216                zumhom();                                                           
//#21217                break;                                                           
//#21218                                                                           
//#21219            case ID_EDIT_SELECTCOLOR:                                                               
//#21220                                                                           
//#21221                selCol();                                                           
//#21222                break;                                                           
//#21223                                                                           


//#21239
//#21240            case ID_BACK:
//#21241
//#21242                bak();
//#21243                break;
//#21244
//#21245            case ID_DESNAM:                                                               
//#21246                                                                           
//#21247                getdes();                                                           
//#21248                break;                                                           
//#21249            }                                                               
//#21250            break;                                                               
//#21251        }                                                                   
//#21252        return 0;                                                                   
//#21253    }                                                                       
//#21254                                                                           
//#21255    //return the width of a text item                                                                       
//#21256    int txtWid(TCHAR* str){                                                                       
//#21257                                                                           
//#21258        GetTextExtentPoint32(mdc,str,strlen(str),&txSiz);                                                                   
//#21259        return txSiz.cx;                                                                   
//#21260    }                                                                       
//#21261                                                                           
//#21262    void makCol(){                                                                       
//#21263                                                                           
//#21264        unsigned    ind;                                                               
//#21265        TCHAR        buf[3];                                                           
//#21266                                                                           
//#21267        buf[1]='0';                                                                   
//#21268        buf[2]=0;                                                                   
//#21269        for(ind=0;ind<16;ind++){                                                                   
//#21270                                                                           
//#21271            hDef[ind]=CreateWindow(                                                               
//#21272                STATIC,                                                           
//#21273                0                                                           
//#21274                SS_OWNERDRAW|WS_CHILD|WS_VISIBLE|WS_BORDER,                                                           
//#21275                0                                                           
//#21276                buttonHi*ind,                                                           
//#21277                buttonWid,                                                           
//#21278                buttonHi,                                                           
//#21279                hWnd,                                                           
//#21280                NULL,                                                           
//#21281                hInst,                                                           
//#21282                NULL);                                                           
//#21283                                                                           
//#21284            hCol[ind]=CreateWindow(                                                               
//#21285                STATIC,                                                           
//#21286                0                                                           
//#21287                SS_OWNERDRAW|WS_CHILD|WS_VISIBLE|WS_BORDER,                                                           
//#21288                buttonWid,                                                           
//#21289                buttonHi*ind,                                                           
//#21290                buttonWid,                                                           
//#21291                buttonHi,                                                           
//#21292                hWnd,                                                           
//#21293                NULL,                                                           
//#21294                hInst,                                                           
//#21295                NULL);                                                           
//#21296                                                                           
//#21297            buf[0]=thrdSiz[ind][0];                                                               
//#21298            hSiz[ind]=CreateWindow(                                                               
//#21299                STATIC,                                                           
//#21300                buf,                                                           
//#21301                SS_CENTER|WS_CHILD|WS_VISIBLE|WS_BORDER,                                                           
//#21302                buttonWid<<1,                                                           
//#21303                buttonHi*ind,                                                           
//#21304                buttonWid,                                                           
//#21305                buttonHi,                                                           
//#21306                hWnd,                                                           
//#21307                NULL,                                                           
//#21308                hInst,                                                           
//#21309                NULL);                                                           
//#21310        }                                                                   
//#21311    }                                                                       
//#21312                                                                           
//#21313    void int2tim(ULARGE_INTEGER num,FILETIME* tim){                                                                       
//#21314                                                                           
//#21315        tim->dwHighDateTime=num.HighPart;                                                                   
//#21316        tim->dwLowDateTime=num.LowPart;                                                                   
//#21317    }                                                                       
//#21318                                                                           
//#21319    void ritloc(){                                                                       
//#21320                                                                           
//#21321        TCHAR*            penv;                                                       
//#21322        TCHAR            locnam[MAX_PATH];                                                       
//#21323        HANDLE            hloc;                                                       
//#21324        unsigned long    rot;                                                               
//#21325                                                                           
//#21326        penv=getenv("COMSPEC");                                                                   
//#21327        if(penv)                                                                   
//#21328            strcpy(locnam,penv);                                                               
//#21329        else                                                                   
//#21330            return;                                                               
//#21331        penv=strrchr(locnam,'\\')+1;
//#21332        strcpy(penv,"thredloc.txt");                                                                   
//#21333        hloc=CreateFile(locnam,GENERIC_WRITE,0,NULL,CREATE_ALWAYS,0,NULL);                                                                   
//#21334        *phom=0;                                                                   
//#21335        WriteFile(hloc,(TCHAR*)homdir,strlen(homdir)+1,&rot,0);                                                                   
//#21336        CloseHandle(hloc);                                                                   
//#21337    }                                                                       
//#21338                                                                           
//#21339    void renam(){                                                                       
//#21340                                                                           
//#21341        unsigned    ind;                                                               
//#21342        TCHAR        chr;                                                           
//#21343                                                                           
//#21344        for(ind=0;ind<50;ind++){                                                                   
//#21345                                                                           
//#21346            chr=rencod[(unsigned char)cryptkey[namloc[ind]]-120];                                                               
//#21347            if(chr)                                                               
//#21348                ini.desnam[ind]=chr;                                                           
//#21349            else                                                               
//#21350                break;                                                           
//#21351        }                                                                   
//#21352        ini.desnam[ind]=0;                                                                   
//#21353    }                                                                       
//#21354                                                                           
//#21355    void ducurs(unsigned char* pnt){                                                                       
//#21356                                                                           
//#21357        _asm{                                                                   
//#21358                                                                           
//#21359                jmp        short delups                                                   
//#21360
//#21361
//#21362    delsubl:    bswap    eax
//#21363                mov        [edi],eax
//#21364                add        edi,4
//#21365                bswap    eax
//#21366                shl        eax,1
//#21367                loop    delsubl
//#21368                ret
//#21369
//#21370    delsubr:    bswap    eax
//#21371                mov        [edi],eax
//#21372                add        edi,4
//#21373                bswap    eax
//#21374                shr        eax,1
//#21375                loop    delsubr
//#21376                ret
//#21377
//#21378    delsubt:    mov        eax,[esi]
//#21379                add        esi,4
//#21380                bswap    eax
//#21381                mov        [edi],eax
//#21382                add        edi,4
//#21383                loop    delsubt
//#21384                ret
//#21385
//#21386    //form cursor
//#21387    delups:        mov        ebx,pnt
//#21388                mov        edi,ebx
//#21389                xor        ecx,ecx
//#21390                mov        cl,32
//#21391                mov        eax,0x00000100
//#21392                rep        stosd
//#21393                xor        eax,eax
//#21394                dec        eax
//#21395                mov        edi,ebx
//#21396                add        edi,64
//#21397                mov        [edi],eax
//#21398                mov        eax,0x00ffff00
//#21399                add        edi,32
//#21400                mov        [edi],eax
//#21401                sub        edi,64
//#21402                mov        [edi],eax
//#21403                mov        eax,0x00018000
//#21404                mov        cl,16
//#21405    dulup0:        or        [edi],eax
//#21406                add        edi,4
//#21407                loop    dulup0
//#21408
//#21409    //dlin cursor
//#21410
//#21411                add        ebx,128
//#21412                mov        edi,ebx
//#21413                mov        ecx,32
//#21414                xor        edx,edx
//#21415                inc        edx
//#21416                mov        esi,edx
//#21417                ror        esi,1
//#21418    dulup:        mov        eax,edx
//#21419                or        eax,esi
//#21420                or        eax,0x80000001
//#21421                bswap    eax
//#21422                mov        [edi],eax
//#21423                add        edi,4
//#21424                shl        edx,1
//#21425                shr        esi,1
//#21426                loop    dulup
//#21427                xor        eax,eax
//#21428                dec        eax
//#21429                sub        edi,4
//#21430                mov        [edi],eax
//#21431                mov        [ebx],eax
//#21432
//#21433    //straight up needle cursor
//#21434                add        ebx,128
//#21435                mov        edi,ebx
//#21436                mov        eax,0x0003c000
//#21437                bswap    eax
//#21438                mov        cl,24
//#21439                rep        stosd
//#21440                mov        eax,0x00024000
//#21441                bswap    eax
//#21442                mov        cl,5
//#21443                rep        stosd
//#21444                mov        eax,0x00018000
//#21445                bswap    eax
//#21446                mov        cl,2
//#21447                rep        stosd
//#21448
//#21449    //left up
//#21450                add        ebx,128
//#21451                mov        edi,ebx
//#21452                mov        cl,5
//#21453                mov        esi,offset lucurstrt
//#21454                call    delsubt
//#21455                mov        cl,4
//#21456                mov        eax,0x88
//#21457                call    delsubl
//#21458                mov        cl,19
//#21459                mov        eax,0x1f00
//#21460                call    delsubl
//#21461                mov        esi,offset lucurfin
//#21462                mov        cl,3
//#21463                call    delsubt
//#21464
//#21465    //left down
//#21466
//#21467                add        ebx,128
//#21468                mov        edi,ebx
//#21469                mov        esi,offset ldcurstrt
//#21470                mov        cl,4
//#21471                call    delsubt
//#21472                mov        cl,19
//#21473                mov        eax,0x7c000000
//#21474                call    delsubr
//#21475                mov        cl,4
//#21476                mov        eax,0x440
//#21477                call    delsubr
//#21478                mov        cl,5
//#21479                mov        esi,offset ldcurfin
//#21480                call    delsubt
//#21481
//#21482    //right up
//#21483
//#21484                add        ebx,128
//#21485                mov        edi,ebx
//#21486                mov        cl,5
//#21487                mov        esi,offset rucurstrt
//#21488                call    delsubt
//#21489                mov        eax,0x9000000
//#21490                mov        cl,4
//#21491                call    delsubr
//#21492                mov        cl,19
//#21493                mov        eax,0x1f00000
//#21494                call    delsubr
//#21495                mov        esi,offset rucurfin
//#21496                mov        cl,3
//#21497                call    delsubt
//#21498
//#21499    //right down
//#21500                add        ebx,128
//#21501                mov        edi,ebx
//#21502                mov        esi,offset rdcurstrt
//#21503                mov        cl,4
//#21504                call    delsubt
//#21505                mov        eax,0xf8                                                   
//#21506                mov        cl,19                                                   
//#21507                call    delsubl                                                       
//#21508                mov        eax,0x8400000                                                   
//#21509                mov        cl,4                                                   
//#21510                call    delsubl                                                       
//#21511                mov        esi,offset rdcurfin                                                   
//#21512                mov        cl,5                                                   
//#21513                call    delsubt                                                       
//#21514                                                                           
//#21515        }                                                                   
//#21516    }                                                                       
//#21517                                                                           
//#21518    void duamsk(){                                                                       
//#21519                                                                           
//#21520        _asm{                                                                   
//#21521                                                                           
//#21522                xor        eax,eax                                                   
//#21523                dec        eax                                                   
//#21524                xor        ecx,ecx                                                   
//#21525                mov        cl,32                                                   
//#21526                mov        edi,offset amsk                                                   
//#21527                rep        stosd                                                   
//#21528        }                                                                   
//#21529    }                                                                       
//#21530                                                                           
//#21531    void crtcurs(){                                                                       
//#21532                                                                           
//#21533        duamsk();                                                                   
//#21534        ducurs(curs.frm);                                                                   
//#21535        hfrm=CreateCursor(hInst,16,16,32,32,(void*)&amsk,(void*)&curs.frm);                                                                   
//#21536        hdlin=CreateCursor(hInst,16,16,32,32,(void*)&amsk,(void*)&curs.dlin);                                                                   
//#21537        hnedu=CreateCursor(hInst,16,32,32,32,(void*)&amsk,(void*)&curs.uned);                                                                   
//#21538        hnedrd=CreateCursor(hInst,1,31,32,32,(void*)&amsk,(void*)&curs.rdned);                                                                   
//#21539        hnedru=CreateCursor(hInst,1,1,32,32,(void*)&amsk,(void*)&curs.runed);                                                                   
//#21540        hnedld=CreateCursor(hInst,30,30,32,32,(void*)&amsk,(void*)&curs.ldned);                                                                   
//#21541        hnedlu=CreateCursor(hInst,32,1,32,32,(void*)&amsk,(void*)&curs.luned);                                                                   
//#21542    }                                                                       
//#21543                                                                           
//#21544    void dstcurs(){                                                                       
//#21545                                                                           
//#21546        DestroyCursor(hfrm);                                                                   
//#21547        DestroyCursor(hdlin);                                                                   
//#21548        DestroyCursor(hnedu);                                                                   
//#21549        DestroyCursor(hnedrd);                                                                   
//#21550        DestroyCursor(hnedru);                                                                   
//#21551        DestroyCursor(hnedld);                                                                   
//#21552        DestroyCursor(hnedlu);                                                                   
//#21553    }                                                                       
//#21554                                                                           
//#21555    void duhom(){                                                                       
//#21556                                                                           
//#21557        unsigned ind;                                                                   
//#21558                                                                           
//#21559        strcpy(homdir,__argv[0]);                                                                   
//#21560        phom=strrchr(homdir,'\\');                                                                   
//#21561        if(phom)                                                                   
//#21562            phom++;                                                               
//#21563        else{                                                                   
//#21564                                                                           
//#21565            ind=GetCurrentDirectory(MAX_PATH,homdir);                                                               
//#21566            homdir[ind++]='\\';                                                               
//#21567            phom=&homdir[ind];                                                               
//#21568        }                                                                   
//#21569        *phom=0;                                                                   
//#21570    }                                                                       
//#21571                                                                           
//#21572    void bcpy(TCHAR* dst,TCHAR* src){                                                                       
//#21573                                                                           
//#21574        _asm{                                                                   
//#21575                                                                           
//#21576                mov        ebx,src                                                   
//#21577                mov        edx,dst                                                   
//#21578                xor        eax,eax                                                   
//#21579    blup:        mov        al,[ebx]                                                       
//#21580                mov        [edx],al                                                   
//#21581                or        eax,eax                                                   
//#21582                je        short blupx                                                   
//#21583                inc        ebx                                                   
//#21584                inc        edx                                                   
//#21585                jmp        blup                                                   
//#21586    blupx:                                                                       
//#21587        }                                                                   
//#21588    }                                                                       
//#21589                                                                           
//#21590    void ducmd(){                                                                       
//#21591                                                                           
//#21592        unsigned long    red;                                                               
//#21593        int                ind;                                                   
//#21594                                                                           
//#21595        if(__argc>1){                                                                   
//#21596                                                                           
//#21597            bcpy(filnam,__argv[1]);                                                               
//#21598            if(!strncmp(filnam,"/F1:",4)){                                                               
//#21599                                                                            
//#21600                balpnt=&filnam[4];                                                           
//#21601                balfil=CreateFile(balpnt,GENERIC_READ,0,0,OPEN_EXISTING,0,0);                                                           
//#21602                CloseHandle(balfil);                                                           
//#21603                if(balfil!=INVALID_HANDLE_VALUE){                                                           
//#21604                                                                           
//#21605                    bcpy(balnam0,balpnt);                                                       
//#21606                    if(__argc>2){                                                       
//#21607                                                                           
//#21608                        bcpy(filnam,__argv[2]);                                                   
//#21609                        if(!strncmp(filnam,"/F2:",4)){                                                   
//#21610                                                                           
//#21611                            balpnt=&filnam[4];                                               
//#21612                            balfil=CreateFile(balpnt,GENERIC_READ,0,0,OPEN_EXISTING,0,0);                                               
//#21613                            if(balfil!=INVALID_HANDLE_VALUE){                                               
//#21614                                                                           
//#21615                                bcpy(balnam1,balpnt);                                           
//#21616                                balpnt=(TCHAR*)&bseq;                                           
//#21617                                ReadFile(balfil,(void*)&balnam2,10000,&red,0);                                           
//#21618                                strcat(balnam2,"");                                           
//#21619                                if(red)                                           
//#21620                                    redbal();                                       
//#21621                            }                                               
//#21622                        }                                                   
//#21623                    }                                                       
//#21624                    SetWindowText(hWnd,stab[STR_EMB]);                                                       
//#21625                }                                                           
//#21626                *filnam=0;                                                           
//#21627                CloseHandle(balfil);                                                           
//#21628                DeleteFile(balnam1);                                                           
//#21629            }                                                               
//#21630            else{                                                               
//#21631                                                                           
//#21632                for(ind=2;ind<__argc;ind++){                                                           
//#21633                                                                           
//#21634                    strcat(filnam," ");                                                       
//#21635                    strcat(filnam,__argv[ind]);                                                       
//#21636                }                                                           
//#21637                setMap(REDOLD);                                                           
//#21638                nuFil();
//#21639            }                                                               
//#21640        }                                                                   
//#21641    }                                                                       
//#21642
procedure TfrmMain.redini();
var 
  LFileHandle: Integer;
  LFileName  : string;
  LReadBytes : Cardinal;

begin                                                                           
//#21643    void redini(){
//#21644
//#21645        unsigned        ind;
//#21646        unsigned long    wrot;
//#21647        HDC                tdc;
//#21648
//#21649        for(ind=0;ind<16;ind++)
//#21650            bakdat[ind]=0;
//#21651        for(ind=0;ind<OLDNUM;ind++)
//#21652            ini.oldnams[ind][0]=0;
//#21653        duhom();
//#21654        strcpy(iniNam,homdir);
//#21655        strcat(iniNam,"thred.ini");
  LFileName := ChangeFileExt(Application.ExeName,'.ini');
  LFileHandle := CreateFile(PAnsiChar(LFileName), GENERIC_READ, 0, nil, OPEN_EXISTING,
                            0, 0);
  try

  finally
    FileClose(LFileHandle);
  end;

//#21656        hIni=CreateFile(iniNam,GENERIC_READ,0,NULL,
//#21657                    OPEN_EXISTING,0,NULL);
//#21658        if(hIni==INVALID_HANDLE_VALUE)
  if not FileExists(LFileName) then
//#21659            defpref();
    defpref()
  else
  begin
//#21660        else{
//#21661
//#21662            ReadFile(hIni,&ini,sizeof(ini),&wrot,0);
    ReadFile(LFileHandle, Fini, SizeOf(ini), LReadBytes, nil);
//#21663            if(wrot<2061)
//    if LReadBytes < 2061 then
//      Fini.FormBoxPixels := DEFBPIX;
//#21664                ini.frmbpix=DEFBPIX;

//#21665            strcpy(defDir,ini.defDir);
//#21666            strcpy(defbmp,ini.defDir);
//#21667            for(ind=0;ind<16;ind++){
//#21668
//#21669                useCol[ind]=    ini.stchCols[ind];
//#21670                custCol[ind]=    ini.selStch[ind];
//#21671                bakCust[ind]=    ini.bakCol[ind];
//#21672                bakBit[ind]=    ini.bakBit[ind];
//#21673            }
//#21674            stchBak=ini.stchBak;
//#21675            bitCol=ini.bitCol;
//#21676            minsiz=ini.minsiz;
//#21677            shopnts=ini.shopnts;
//#21678            if(ini.tsiz30)
//#21679                tsiz30=ini.tsiz30;
//#21680            if(ini.tsiz40)
//#21681                tsiz40=ini.tsiz40;
//#21682            if(ini.tsiz60)
//#21683                tsiz60=ini.tsiz60;
//#21684            if(ini.usesiz)
//#21685                usesiz=ini.usesiz;
//#21686            if(!ini.maxsiz)
//#21687                ini.maxsiz=MAXSIZ*PFGRAN;
//#21688            if(ini.smalsiz)
//#21689                smalsiz=ini.smalsiz;
//#21690            stchboxs=ini.stchboxs;
//#21691            if(ini.stspace)
//#21692                stspace=ini.stspace;
//#21693            umap=ini.umap;
//#21694            if(ini.brdwid)
//#21695                brdwid=ini.brdwid;
//#21696            if(ini.apcol)
//#21697                apcol=ini.apcol&0xf;
//#21698            if(ini.snplen)
//#21699                snplen=ini.snplen;
//#21700            if(ini.starat)
//#21701                starat=ini.starat;
//#21702            if(ini.spirwrap)
//#21703                spirwrap=ini.spirwrap;
//#21704            if(ini.bfclen)
//#21705                bfclen=ini.bfclen;
//#21706            if(!ini.grdsiz)
//#21707                ini.grdsiz=12;
//#21708            if(!ini.wavpnts)
//#21709                ini.wavpnts=IWAVPNTS;
//#21710            if(!ini.wavstrt)
//#21711                ini.wavstrt=IWAVSTRT;
//#21712            if(!ini.wavend)
//#21713                ini.wavend=IWAVEND;
//#21714            if(!ini.wavs)
//#21715                ini.wavs=IWAVS;
//#21716            if(!ini.fthtyp)
//#21717                ini.fthtyp=FDEFTYP;
//#21718            if(!ini.fthup)
//#21719                ini.fthup=FDEFUP;
//#21720            if(!ini.fthdwn)
//#21721                ini.fthdwn=FDEFDWN;
//#21722            if(!ini.fthrat)
//#21723                ini.fthrat=(float)FDEFRAT;
//#21724            if(!ini.fthflr)
//#21725                ini.fthflr=FDEFFLR;
//#21726            if(!ini.fthnum)
//#21727                ini.fthnum=FDEFNUM;
//#21728            if(!ini.dazhlen)
//#21729                ini.dazhlen=DAZHLEN;
//#21730            if(!ini.dazcnt)
//#21731                ini.dazcnt=DAZCNT;
//#21732            if(!ini.dazicnt)
//#21733                ini.dazicnt=DAZICNT;
//#21734            if(!ini.dazlen)
//#21735                ini.dazlen=DAZLEN;
//#21736            if(!ini.dazpet)
//#21737                ini.dazpet=DAZPETS;
//#21738            if(!ini.dazplen)
//#21739                ini.dazplen=DAZPLEN;
//#21740
//#21741            switch(ini.hup){
//#21742
//#21743                case SMALHUP:
//#21744
//#21745                    ini.hupx=SHUPX;
//#21746                    ini.hupy=SHUPY;
//#21747                    break;
//#21748
//#21749                case LARGHUP:
//#21750
//#21751                    ini.hupx=LHUPX;
//#21752                    ini.hupy=LHUPY;
//#21753                    break;
//#21754
//#21755                case CUSTHUP:
//#21756
//#21757                    if(!ini.hupx)
//#21758                        ini.hupx=LHUPX;
//#21759                    if(!ini.hupy)
//#21760                        ini.hupy=LHUPY;
//#21761                    break;
//#21762
//#21763                case HUP100:
//#21764
//#21765                    if(!ini.hupx)
//#21766                        ini.hupx=HUP100XY;
//#21767                    if(!ini.hupy)
//#21768                        ini.hupy=HUP100XY;
//#21769                    break;
//#21770
//#21771                default:
//#21772
//#21773                    ini.hup=LARGHUP;
//#21774                    ini.hupx=LHUPX;
//#21775                    ini.hupy=LHUPY;
//#21776            }
//#21777            zum0.x=ini.hupx;
//#21778            zum0.y=ini.hupy;
//#21779            picspac=ini.picspac;
//#21780        }
  end;
//#21781        if(!ini.grdbak)
//#21782            ini.grdbak=DEFGRD;
//#21783        CloseHandle(hIni);
//#21784        if(!ini.angl)
//#21785            ini.angl=PI/6;
//#21786        tdc=GetDC(0);
//#21787        scrPix.cx=GetDeviceCaps(tdc,HORZRES);
//#21788        scrPix.cy=GetDeviceCaps(tdc,VERTRES);
//#21789        if(ini.irct.left<0)
//#21790            ini.irct.left=0;
//#21791        if(ini.irct.top<0)
//#21792            ini.irct.top=0;
//#21793        ind=scrPix.cx-30;
//#21794        if(ini.irct.right>(int)ind)
//#21795            ini.irct.right=ind;
//#21796        if(ini.irct.bottom>scrPix.cy)
//#21797            ini.irct.bottom=scrPix.cy;
//#21798    }
//#21799
end;


//#21800    void trcsub(HWND* hwnd,unsigned xloc,unsigned yloc,unsigned hi){
//#21801
//#21802        *hwnd=CreateWindow(
//#21803            STATIC,
//#21804            ,
//#21805            SS_OWNERDRAW|WS_CHILD|WS_BORDER,
//#21806            xloc,
//#21807            yloc,
//#21808            buttonWid,
//#21809            hi,
//#21810            hWnd,
//#21811            NULL,
//#21812            hInst,                                                               
//#21813            NULL);                                                               
//#21814    }                                                                       
//#21815                                                                           
//#21816    void chkirct(){                                                                       
//#21817                                                                           
//#21818        POINT lim;                                                                   
//#21819                                                                           
//#21820        lim.x=scrPix.cx-1;                                                                   
//#21821        lim.y=scrPix.cy-1;                                                                   
//#21822        if(ini.irct.left>lim.x)                                                                   
//#21823            ini.irct.left=lim.x;                                                               
//#21824        if(ini.irct.right>lim.x)                                                                   
//#21825            ini.irct.right=lim.x;                                                               
//#21826        if(ini.irct.left<0)                                                                   
//#21827            ini.irct.left=0;                                                               
//#21828        if(ini.irct.right<0)                                                                   
//#21829            ini.irct.right=0;                                                               
//#21830        if(ini.irct.top>lim.y)                                                                   
//#21831            ini.irct.top=lim.y;                                                               
//#21832        if(ini.irct.bottom>lim.y)                                                                   
//#21833            ini.irct.bottom=lim.y;                                                               
//#21834        if(ini.irct.top<0)                                                                   
//#21835            ini.irct.top=0;                                                               
//#21836        if(ini.irct.bottom<0)                                                                   
//#21837            ini.irct.bottom=0;                                                               
//#21838        if(ini.irct.right-ini.irct.left<300){                                                                   
//#21839                                                                           
//#21840            ini.irct.left=0;                                                               
//#21841            ini.irct.right=lim.x>>1;                                                               
//#21842        }                                                                   
//#21843        if(ini.irct.bottom-ini.irct.top<300){                                                                   
//#21844                                                                           
//#21845            ini.irct.top=0;                                                               
//#21846            ini.irct.bottom=lim.y>>1;                                                               
//#21847        }                                                                   
//#21848    }                                                                       
//#21849                                                                           
//#21850    void init(){                                                                       
//#21851                                                                           
//#21852        unsigned        ind,flg;                                                           
//#21853        unsigned long    thwid,mwid;                                                               
//#21854        RECT            tRct;                                                       
//#21855        RECT            wrct;                                                       
//#21856        HDC                totdc;                                                   
//#21857        TCHAR*            pchr;                                                       
//#21858                                                                           
//#21859        txad=0;                                                                   
//#21860        fsizeof=sizeof(FRMHED)>>2;                                                                   
//#21861        LoadMenu(hInst,MAKEINTRESOURCE(IDR_MENU1));                                                                   
//#21862        hMen=GetMenu(hWnd);                                                                   
//#21863        totdc=GetDC(NULL);                                                                   
//#21864        mwid=GetDeviceCaps(totdc,HORZRES);                                                                   
//#21865        ReleaseDC(NULL,totdc);                                                                   
//#21866        GetWindowRect(hWnd,&wrct);                                                                   
//#21867        GetMenuItemRect(hWnd,hMen,0,&tRct);                                                                   
//#21868        menhi=tRct.bottom-tRct.top;                                                                   
//#21869        wrct.left=tRct.left;                                                                   
//#21870        wrct.right=tRct.right;                                                                   
//#21871        for(ind=0;ind<=M_HELP;ind++){                                                                   
//#21872                                                                           
//#21873            GetMenuItemRect(hWnd,hMen,ind,&tRct);                                                               
//#21874            wrct.right+=(tRct.right-tRct.left);                                                               
//#21875        }                                                                   
//#21876        wrct.right+=20;                                                                   
//#21877        thwid=wrct.right-wrct.left;                                                                   
//#21878        mwid>>=1;                                                                   
//#21879        if(thwid<mwid)                                                                   
//#21880            wrct.right=wrct.left+=mwid;                                                               
//#21881        hfilMen=GetSubMenu(hMen,M_FIL);                                                                   
//#21882        hfileMen=GetSubMenu(hMen,M_FILE);                                                                   
//#21883        hedmen=GetSubMenu(hMen,M_EDIT);                                                                   
//#21884        hfilBrdMen=GetSubMenu(hfilMen,MFIL_BORD);                                                                   
//#21885        hvumen=GetSubMenu(hMen,M_VIEW);                                                                   
//#21886        hvsmen=GetSubMenu(hvumen,M_VIEW);                                                                   
//#21887        qchk();                                                                   
//#21888        hAr=LoadCursor(0,IDC_ARROW);                                                                   
//#21889        hCros=LoadCursor(0,IDC_CROSS);                                                                   
//#21890        crtcurs();                                                                   
//#21891        redfils();                                                                   
//#21892        clrMap(MAPLEN);                        //clear the bitmap                                           
//#21893        //set up the size variables                                                                   
//#21894        mdc=GetDC(hWnd);                                                                   
//#21895        SetStretchBltMode(mdc,COLORONCOLOR);                                                                   
//#21896        rsdc=GetDCEx(hStch,0,DCX_PARENTCLIP|DCX_CLIPSIBLINGS);                                                                   
//#21897        sdc=CreateCompatibleDC(rsdc);                                                                   
//#21898        scrSiz.cx=GetDeviceCaps(mdc,HORZSIZE);                                                                   
//#21899        scrSiz.cy=GetDeviceCaps(mdc,VERTSIZE);                                                                   
//#21900        chkirct();                                                                   
//#21901        if(!chku(SAVMAX))                                                                   
//#21902            MoveWindow(hWnd,ini.irct.left,ini.irct.top,ini.irct.right-ini.irct.left,ini.irct.bottom-ini.irct.top,0);                                                               
//#21903        buttonWid=txtWid("MM")+TXTSIDS;                                                                   
//#21904        buttonWid3=buttonWid*3;                                                                   
//#21905        buttonHi=txSiz.cy+4;                                                                   
//#21906        numwid=txtWid("0");                                                                   
//#21907        selbox=txtWid("0");                                                                   
//#21908        for(ind=0;ind<NERCNT;ind++)                                                                   
//#21909            boxOff[ind]=selbox+selbox*ind;                                                               
//#21910    #pragma warning(disable:4244;once:)                                                                       
//#21911        GetClientRect(hWnd,&mRct);                                                                   
//#21912        stchWnd();                                                                   
//#21913        lodstr();                                                                   
//#21914        maxwid(STR_PRF0,STR_PRF27);                                                                   
//#21915        if(!hIni){                                                                   
//#21916                                                                           
//#21917            //initialize the user color and thread size arrays                                                               
//#21918            for(ind=0;ind<16;ind++)                                                               
//#21919                useCol[ind]=defCol[ind];                                                           
//#21920        }                                                                   
//#21921        for(ind=0;ind<16;ind++){                                                                   
//#21922                                                                           
//#21923            thrdSiz[ind][0]='4';                                                               
//#21924            thrdSiz[ind][1]='0';                                                               
//#21925        }                                                                   
//#21926        if(!ini.trlen)                                                                   
//#21927            ini.trlen=TRACLEN;                                                               
//#21928        if(!ini.trcrat)                                                                   
//#21929            ini.trcrat=TRACRAT;                                                               
//#21930        if(!ini.chspac)                                                                   
//#21931            ini.chspac=CHSDEF;                                                               
//#21932        if(!ini.chrat)                                                                   
//#21933            ini.chrat=CHRDEF;                                                               
//#21934        if(!ini.nudg)                                                                   
//#21935            ini.nudg=NUGINI;                                                               
//#21936        if(!ini.nudgpix)                                                                   
//#21937            ini.nudgpix=DEFPIX;                                                               
//#21938        if(!ini.egrat)                                                                   
//#21939            ini.egrat=DEFEGRAT;                                                               
//#21940        if(!ini.stchpix)                                                                   
//#21941            ini.stchpix=DEFPNTPIX;                                                               
//#21942        if(!ini.frmpix)                                                                   
//#21943            ini.frmpix=DEFPNTPIX;                                                               
//#21944        if(!ini.nsids)                                                                   
//#21945            ini.nsids=24;                                                               
//#21946        if(!ini.tearat)                                                                   
//#21947            ini.tearat=(float)1.4;                                                               
//#21948        if(!ini.ulen)                                                                   
//#21949            ini.ulen=DEFULEN;                                                               
//#21950        if(!ini.uspac)                                                                   
//#21951            ini.uspac=DEFUSPAC;                                                               
//#21952        setgrd(ini.grdbak);                                                                   
//#21953        makCol();        //make the color change windows                                                           
//#21954        for(ind=0;ind<9;ind++){                                                                   
//#21955                                                                           
//#21956            switch(ind){                                                               
//#21957                                                                           
//#21958            case HBOXSEL:                                                               
//#21959                                                                           
//#21960                flg=SS_NOTIFY|SS_CENTER|WS_CHILD|WS_VISIBLE|WS_BORDER;                                                           
//#21961                pchr=stab[STR_BOXSEL];                                                           
//#21962                break;                                                           
//#21963                                                                           
//#21964            case HUPTO:                                                               
//#21965                                                                           
//#21966                flg=SS_NOTIFY|SS_CENTER|WS_CHILD|WS_VISIBLE|WS_BORDER;                                                           
//#21967                pchr=stab[STR_UPOF];                                                           
//#21968                break;                                                           
//#21969                                                                           
//#21970            case HHID:                                                               
//#21971                                                                           
//#21972                flg=SS_OWNERDRAW|SS_NOTIFY|WS_CHILD|WS_VISIBLE|WS_BORDER;                                                           
//#21973                pchr=stab[STR_PIKOL];                                                           
//#21974                break;                                                           
//#21975                                                                           
//#21976            default:                                                               
//#21977                                                                           
//#21978                pchr="";                                                           
//#21979                flg=SS_NOTIFY|SS_CENTER|WS_CHILD|WS_VISIBLE|WS_BORDER;                                                           
//#21980            }                                                               
//#21981            hbuts[ind]=CreateWindow(                                                               
//#21982                STATIC,                                                           
//#21983                pchr,                                                           
//#21984                flg,                                                           
//#21985                0                                                           
//#21986                buttonHi*(16+ind),                                                           
//#21987                buttonWid3,                                                           
//#21988                buttonHi,                                                           
//#21989                hWnd,                                                           
//#21990                NULL,                                                           
//#21991                hInst,                                                           
//#21992                NULL);                                                           
//#21993        }                                                                   
//#21994        hstep=CreateWindow(                                                                   
//#21995                                                                           
//#21996            STATIC,                                                               
//#21997            ,                                                               
//#21998            SS_NOTIFY|SS_CENTER|WS_CHILD|WS_BORDER,                                                               
//#21999            0                                                               
//#22000            buttonHi*18,                                                               
//#22001            buttonWid3,                                                               
//#22002            buttonHi,                                                               
//#22003            hWnd,                                                               
//#22004            NULL,                                                               
//#22005            hInst,                                                               
//#22006            NULL);                                                               
//#22007                                                                           
//#22008        hBar=CreateWindow(                                                                   
//#22009            STATIC,                                                               
//#22010            ,                                                               
//#22011            SS_OWNERDRAW|WS_CHILD|WS_VISIBLE|WS_BORDER,                                                               
//#22012            mRct.right-COLSIZ,                                                               
//#22013            0                                                               
//#22014            COLSIZ,                                                               
//#22015            mRct.bottom,                                                               
//#22016            hWnd,                                                               
//#22017            NULL,                                                               
//#22018            hInst,                                                               
//#22019            NULL);                                                               
//#22020                                                                           
//#22021        for(ind=0;ind<3;ind++){                                                                   
//#22022                                                                           
//#22023            trcsub(&hctrc[ind],buttonWid*ind,0,buttonHi*15);                                                               
//#22024            trcsub(&hstrc[ind],buttonWid*ind,buttonHi*15,buttonHi);                                                               
//#22025            trcsub(&htrup[ind],buttonWid*ind,buttonHi*16,buttonHi);                                                               
//#22026            trcsub(&htrdwn[ind],buttonWid*ind,buttonHi*17,buttonHi);                                                               
//#22027            trbrsh[ind]=CreateSolidBrush(trgb[ind]);                                                               
//#22028        }                                                                   
//#22029                                                                           
//#22030        nuRct();                                                                   
//#22031        //create pens                                                                   
//#22032        for(ind=0;ind<4;ind++)                                                                   
//#22033            bPen[ind]=CreatePen(PS_SOLID,1,boxRef[ind]);                                                               
//#22034        lPen=CreatePen(PS_SOLID,1,0x404040);                                                                   
//#22035        xPen=CreatePen(PS_SOLID,5,0x804080);                                                                   
//#22036        gPen=CreatePen(PS_SOLID,1,0x804080);                                                                   
//#22037        grdPen=CreatePen(PS_SOLID,1,ini.grdbak);                                                                   
//#22038        bakPen=CreatePen(PS_SOLID,3,stchBak);                                                                   
//#22039        bitPen=CreatePen(PS_SOLID,1,bitCol);                                                                   
//#22040        fPen=CreatePen(PS_SOLID,1,0xc0c0c0);                                                                   
//#22041        fmpen=CreatePen(PS_SOLID,1,0xc0c080);                                                                   
//#22042        fPen3=CreatePen(PS_SOLID,3,0xc0c0c0);                                                                   
//#22043        fsPen=CreatePen(PS_SOLID,1,0x80c080);                                                                   
//#22044        mrkPen=CreatePen(PS_SOLID,3,0x40c040);                                                                   
//#22045        alpen=CreatePen(PS_SOLID,1,0xc08080);                                                                   
//#22046        kpen=CreatePen(PS_SOLID,1,0xffffff);                                                                   
//#22047        ypen[0]=CreatePen(PS_SOLID,1,0xc0c0c0);                                                                   
//#22048        ypen[1]=CreatePen(PS_SOLID,1,0x80c0c0);                                                                   
//#22049        ypen[2]=CreatePen(PS_SOLID,1,0xc080c0);                                                                   
//#22050        ypen[3]=CreatePen(PS_SOLID,1,0xc0c080);                                                                   
//#22051        ypen[4]=CreatePen(PS_SOLID,1,0x40c0c0);                                                                   
//#22052        ypen[5]=CreatePen(PS_SOLID,1,0xc0c040);                                                                   
//#22053        bakwid=1;                                                                   
//#22054        for(ind=0;ind<16;ind++){                                                                   
//#22055                                                                           
//#22056            pixSiz[ind]=1;                                                               
//#22057            sizInd[ind]=1;                                                               
//#22058            uPen[ind]=CreatePen(PS_SOLID,1,useCol[ind]);                                                               
//#22059        }                                                                   
//#22060        hStchBak=CreateSolidBrush(stchBak);                                                                   
//#22061        //create brushes                                                                   
//#22062        for(ind=0;ind<16;ind++){                                                                   
//#22063                                                                           
//#22064            hbrDefCol[ind]=CreateSolidBrush(defCol[ind]);                                                               
//#22065            hbrUseCol[ind]=CreateSolidBrush(useCol[ind]);                                                               
//#22066        }                                                                   
//#22067        hblk=CreateSolidBrush(0);                                                                   
//#22068        zumFct=1;                                                                   
//#22069        hed.ledIn=0x32;                                                                   
//#22070        hed.fColCnt=16;                                                                   
//#22071        hed.stchs=0;                                                                   
//#22072        GetDCOrgEx(rsdc,&stOrg);                                                                   
//#22073        ladj();                                                                   
//#22074        GetTextExtentPoint(sdc,stab[STR_PIKOL],strlen(stab[STR_PIKOL]),&pcolsiz);                                                                   
//#22075        auxmen();                                                                   
//#22076        fnamtabs();                                                                   
//#22077        ritfnam(ini.desnam);                                                                   
//#22078        strcpy(hedx.modnam,ini.desnam);                                                                   
//#22079        hedx.stgran=0;                                                                   
//#22080        for(ind=0;ind<31;ind++)                                                                   
//#22081            hedx.res[ind]=0;                                                               
//#22082        chkhup();                                                                   
//#22083        nedmen();                                                                   
//#22084        fil2men();                                                                   
//#22085        knotmen();                                                                   
//#22086        bsavmen();                                                                   
//#22087        rotauxmen();                                                                   
//#22088        linbmen();                                                                   
//#22089        wrnmen();                                                                   
//#22090        ritloc();                                                                   
//#22091        frmcurmen();                                                                   
//#22092        redtx();                                                                   
//#22093        setMap(HIDMAP);                                                                   
//#22094        hidbit();                                                                   
//#22095        chkmen();                                                                   
//#22096        //check command line-should be last item in init                                                                   
//#22097        ducmd();                                                                   
//#22098        sprintf(msgbuf,stab[STR_THRED],ini.desnam);                                                                   
//#22099        SetWindowText(hWnd,msgbuf);                                                                   
//#22100    }                                                                       
//#22101                                                                           
//#22102    COLORREF defTxt(unsigned colInd){                                                                       
//#22103                                                                           
//#22104        _asm{                                                                   
//#22105                                                                           
//#22106                xor        eax,eax                                                   
//#22107                mov        ecx,defMap                                                   
//#22108                mov        edx,colInd                                                   
//#22109                bt        ecx,edx                                                   
//#22110                jnc        short defx                                                   
//#22111                mov        eax,0xffffff                                                   
//#22112    defx:                                                                       
//#22113        }                                                                   
//#22114    #pragma warning(disable:4035;once:)                                                                       
//#22115    }                                                                       
//#22116                                                                           
//#22117    void setCol(unsigned ind){                                                                       
//#22118                                                                           
//#22119        _asm{                                                                   
//#22120                                                                           
//#22121                mov        ebx,ind                                                   
//#22122                mov        eax,cbit                                                   
//#22123                bts        eax,ebx                                                   
//#22124                mov        cbit,eax                                                   
//#22125        }                                                                   
//#22126    }                                                                       
//#22127                                                                           
//#22128    void relin(){                                                                       
//#22129                                                                           
//#22130        stch2px1(cloInd-1);                                                                   
//#22131        mlin0[0].x=pPnt.x;                                                                   
//#22132        mlin0[0].y=pPnt.y;                                                                   
//#22133        stch2px1(cloInd+1);                                                                   
//#22134        mlin1[1].x=pPnt.x;                                                                   
//#22135        mlin1[1].y=pPnt.y;                                                                   
//#22136        rstMap(WASLIN);                                                                   
//#22137        dulin();                                                                   
//#22138    }                                                                       
//#22139                                                                           
//#22140    unsigned setRmp(unsigned pbit){                                                                       
//#22141                                                                           
//#22142        _asm{                                                                   
//#22143                xor        eax,eax                                                   
//#22144                mov        ebx,offset rmap                                                   
//#22145                mov        ecx,pbit                                                   
//#22146                bts        [ebx],ecx                                                   
//#22147                jc        short setrm                                                   
//#22148                dec        eax                                                   
//#22149    setrm:                                                                       
//#22150        }                                                                   
//#22151    #pragma warning(disable:4035;once:)                                                                       
//#22152    }                                                                       
//#22153                                                                           
//#22154    void drwLin(unsigned ind,unsigned len,HPEN hPen){                                                                       
//#22155                                                                           
//#22156        unsigned    ine,layr;                                                               
//#22157        SHRTPNT*    pstch=&stchs[ind];                                                               
//#22158                                                                           
//#22159        if(actl)                                                                   
//#22160            drwpnt=0;                                                               
//#22161        for(ine=0;ine<len;ine++){                                                                   
//#22162                                                                           
//#22163            layr=(pstch[ine].at&LAYMSK)>>LAYSHFT;                                                               
//#22164            if(!actl||!layr||(layr==actl)){                                                               
//#22165                                                                           
//#22166                plin[drwpnt].x=(pstch[ine].x-zRct.left)*zrat.x;                                                           
//#22167                plin[drwpnt++].y=scRct.bottom-(pstch[ine].y-zRct.bottom)*zrat.y;                                                           
//#22168            }                                                               
//#22169        }                                                                   
//#22170        SelectObject(sdc,hPen);                                                                   
//#22171        if(drwpnt<16000)                                                                   
//#22172            Polyline(sdc,plin,drwpnt);                                                               
//#22173        else{                                                                   
//#22174                                                                           
//#22175            ine=0;                                                               
//#22176            while(drwpnt){                                                               
//#22177                                                                           
//#22178                if(drwpnt>16000){                                                           
//#22179                                                                           
//#22180                    Polyline(sdc,&plin[ine],16000);                                                       
//#22181                    ine+=15999;                                                       
//#22182                    drwpnt-=15999;                                                       
//#22183                }                                                           
//#22184                else{                                                           
//#22185                                                                           
//#22186                    Polyline(sdc,&plin[ine],drwpnt);                                                       
//#22187                    break;                                                       
//#22188                }                                                           
//#22189            }                                                               
//#22190        }                                                                   
//#22191        drwpnt=1;                                                                   
//#22192        layr=(pstch[ine].at&LAYMSK)>>LAYSHFT;                                                                   
//#22193        if(!actl||!layr||layr==actl){                                                                   
//#22194                                                                           
//#22195            plin[0].x=(pstch[ine-1].x-zRct.left)*zrat.x;                                                               
//#22196            plin[0].y=scRct.bottom-(pstch[ine-1].y-zRct.bottom)*zrat.y;                                                               
//#22197        }                                                                   
//#22198    }                                                                       
//#22199                                                                           
//#22200    void dumov(){                                                                       
//#22201                                                                           
//#22202        SHRTPNT*    tstch;                                                               
//#22203        POINT        arlin[8];                                                           
//#22204        POINT        trot;                                                           
//#22205                                                                           
//#22206        pixang=atan2(stchs[movpnt+1].y-stchs[movpnt].y,stchs[movpnt+1].x-stchs[movpnt].x);                                                                   
//#22207        tstch=&stchs[movpnt];                                                                   
//#22208        if(tstch->x>=zRct.left&&tstch->x<=zRct.right                                                                   
//#22209            &&tstch->y>=zRct.bottom&&tstch->y<=zRct.top){                                                               
//#22210                                                                           
//#22211            sdCor2px(stchs[movpnt],&pixcntr);                                                               
//#22212            arlin[0].x=arlin[6].x=pixcntr.x;                                                               
//#22213            arlin[0].y=arlin[6].y=pixcntr.y;                                                               
//#22214            trot.x=pixcntr.x+12;                                                               
//#22215            trot.y=pixcntr.y+2;                                                               
//#22216            rotpix(trot,&arlin[1]);                                                               
//#22217            trot.y=pixcntr.y-2;                                                               
//#22218            rotpix(trot,&arlin[5]);                                                               
//#22219            trot.y=pixcntr.y+6;                                                               
//#22220            rotpix(trot,&arlin[2]);                                                               
//#22221            trot.y=pixcntr.y-6;                                                               
//#22222            rotpix(trot,&arlin[4]);                                                               
//#22223            trot.x=pixcntr.x+20;                                                               
//#22224            trot.y=pixcntr.y;                                                               
//#22225            rotpix(trot,&arlin[3]);                                                               
//#22226            SelectObject(sdc,fPen);                                                               
//#22227            SetROP2(sdc,R2_XORPEN);                                                               
//#22228            Polyline(sdc,arlin,7);                                                               
//#22229            SetROP2(sdc,R2_COPYPEN);                                                               
//#22230        }                                                                   
//#22231    }                                                                       
//#22232                                                                           
//#22233    unsigned chkup(unsigned cnt,unsigned ind){                                                                       
//#22234                                                                           
//#22235        if(chkMap(UPTO)&&cloInd){                                                                   
//#22236                                                                           
//#22237            if(colch[ind].stind<cloInd){                                                               
//#22238                                                                           
//#22239                if(colch[ind+1].stind<cloInd)                                                           
//#22240                    return cnt;                                                       
//#22241                else                                                           
//#22242                    return cloInd-colch[ind].stind+1;                                                       
//#22243            }                                                               
//#22244            else                                                               
//#22245                return 0;                                                           
//#22246        }                                                                   
//#22247        else                                                                   
//#22248            return cnt;                                                               
//#22249    }                                                                       
//#22250                                                                           
//#22251    BOOL bitar(){                                                                       
//#22252                                                                           
//#22253        DUBRCT    bakrct;                                                               
//#22254        DUBRCT    difrct;                                                               
//#22255        DUBPNT    bsdrat;                                                               
//#22256        DUBRCT    zirct;                                                               
//#22257                                                                           
//#22258        zirct.bottom=zum0.y-zRct.bottom;                                                                   
//#22259        zirct.top=zum0.y-zRct.top;                                                                   
//#22260        zirct.left=zRct.left;                                                                   
//#22261        zirct.right=zRct.right;                                                                   
//#22262        if(zirct.top>zumend.y||zirct.left>zumend.x)                                                                   
//#22263            return 0;                                                               
//#22264        else{                                                                   
//#22265                                                                           
//#22266            bsrct.top=ceil(zirct.top*bsrat.y);                                                               
//#22267            bsrct.left=ceil(zRct.left*bsrat.x);                                                               
//#22268            bsrct.right=floor(zRct.right*bsrat.x);                                                               
//#22269            bsrct.bottom=floor(zirct.bottom*bsrat.y);                                                               
//#22270            if(bsrct.right>(long)bwid){                                                               
//#22271                                                                           
//#22272                bsrct.right=bwid;                                                           
//#22273                rstMap(LANDSCAP);                                                           
//#22274            }                                                               
//#22275            if(bsrct.bottom>(long)bhi){                                                               
//#22276                                                                           
//#22277                bsrct.bottom=bhi;                                                           
//#22278                setMap(LANDSCAP);                                                           
//#22279            }                                                               
//#22280            bakrct.top=bsrct.top*birat.y;                                                               
//#22281            bakrct.left=bsrct.left*birat.x;                                                               
//#22282            bakrct.right=bsrct.right*birat.x;                                                               
//#22283            bakrct.bottom=bsrct.bottom*birat.y;                                                               
//#22284            difrct.top=bakrct.top-zirct.top;                                                               
//#22285            difrct.left=bakrct.left-zirct.left;                                                               
//#22286            difrct.right=zirct.right-bakrct.right;                                                               
//#22287            difrct.bottom=zirct.bottom-bakrct.bottom;                                                               
//#22288            bsdrat.x=(double)scRct.right/(zRct.right-zRct.left);                                                               
//#22289            bsdrat.y=(double)scRct.bottom/(zRct.top-zRct.bottom);                                                               
//#22290            bdrct.top=difrct.top*bsdrat.y;                                                               
//#22291            bdrct.left=difrct.left*bsdrat.x;                                                               
//#22292            bdrct.right=scRct.right-difrct.right*bsdrat.x;                                                               
//#22293            bdrct.bottom=scRct.bottom-difrct.bottom*bsdrat.y;                                                               
//#22294            return 1;                                                               
//#22295        }                                                                   
//#22296    }                                                                       
//#22297                                                                           
//#22298    void drwknot(){                                                                       
//#22299                                                                           
//#22300    #define            KSIZ 5                                                           
//#22301    #define            KLSIZ 10                                                           
//#22302                                                                           
//#22303        unsigned    ind;                                                               
//#22304        POINT        pnt;                                                           
//#22305        POINT        tlin[5];                                                           
//#22306                                                                           
//#22307        if(!chku(KNOTOF)&&knotcnt&&hed.stchs){                                                                   
//#22308                                                                           
//#22309            for(ind=0;ind<knotcnt;ind++){                                                               
//#22310                                                                           
//#22311                stCor2px(stchs[knotab[ind]],&pnt);                                                           
//#22312                SelectObject(sdc,kpen);                                                           
//#22313                SetROP2(sdc,R2_XORPEN);                                                           
//#22314                tlin[0].x=tlin[3].x=tlin[4].x=pnt.x-KSIZ;                                                           
//#22315                tlin[1].x=tlin[2].x=pnt.x+KSIZ;                                                           
//#22316                tlin[0].y=tlin[1].y=tlin[4].y=pnt.y+KSIZ;                                                           
//#22317                tlin[2].y=tlin[3].y=pnt.y-KSIZ;                                                           
//#22318                Polyline(sdc,tlin,5);                                                           
//#22319                tlin[0].x=pnt.x-KLSIZ;                                                           
//#22320                tlin[1].x=pnt.x+KLSIZ;                                                           
//#22321                tlin[0].y=tlin[1].y=pnt.y;                                                           
//#22322                Polyline(sdc,tlin,2);                                                           
//#22323                SetROP2(sdc,R2_COPYPEN);                                                           
//#22324            }                                                               
//#22325        }                                                                   
//#22326    }                                                                       
//#22327                                                                           
//#22328    void dugrid(){                                                                       
//#22329                                                                           
//#22330        POINT        tlin[2];                                                           
//#22331        RECT        grdrct;                                                           
//#22332        unsigned    ind;                                                               
//#22333                                                                           
//#22334        if(zumFct<shopnts||!shopnts){                                                                   
//#22335                                                                           
//#22336            SetROP2(sdc,R2_XORPEN);                                                               
//#22337            SelectObject(sdc,grdPen);                                                               
//#22338            grdrct.left=ceil(zRct.left/ini.grdsiz);                                                               
//#22339            grdrct.right=floor(zRct.right/ini.grdsiz);                                                               
//#22340            grdrct.bottom=ceil(zRct.bottom/ini.grdsiz);                                                               
//#22341            grdrct.top=floor(zRct.top/ini.grdsiz);                                                               
//#22342            tlin[0].x=0;                                                               
//#22343            tlin[1].x=scRct.right;                                                               
//#22344            for(ind=grdrct.bottom;ind<=(unsigned)grdrct.top;ind++){                                                               
//#22345                                                                           
//#22346                tlin[0].y=tlin[1].y=scRct.bottom-(ind*ini.grdsiz-zRct.bottom)*zrat.y+0.5;                                                           
//#22347                Polyline(sdc,tlin,2);                                                           
//#22348            }                                                               
//#22349            tlin[0].y=0;                                                               
//#22350            tlin[1].y=scRct.bottom;                                                               
//#22351            for(ind=grdrct.left;ind<=(unsigned)grdrct.right;ind++){                                                               
//#22352                                                                           
//#22353                tlin[0].x=tlin[1].x=(ind*ini.grdsiz-zRct.left)*zrat.x+0.5;                                                           
//#22354                Polyline(sdc,tlin,2);                                                           
//#22355            }                                                               
//#22356            SetROP2(sdc,R2_COPYPEN);                                                               
//#22357        }                                                                   
//#22358    }                                                                       
//#22359                                                                           
//#22360    void rint(){                                                                       
//#22361                                                                           
//#22362        unsigned siz;                                                                   
//#22363                                                                           
//#22364        rcel.x=(zRct.right-zRct.left)/scRct.right;                                                                   
//#22365        rcel.y=(zRct.top-zRct.bottom)/scRct.bottom;                                                                   
//#22366        siz=scRct.right*scRct.bottom;                                                                   
//#22367        if(siz>RMAPBITS){                                                                   
//#22368                                                                           
//#22369            rcel.x*=siz/RMAPBITS;                                                               
//#22370            rcel.y*=siz/RMAPBITS;                                                               
//#22371        }                                                                   
//#22372    }                                                                       
//#22373                                                                           
//#22374    unsigned setRmap(SHRTPNT sPnt){                                                                       
//#22375                                                                           
//#22376        unsigned bpnt;                                                                   
//#22377                                                                           
//#22378        bpnt=floor((sPnt.x-zRct.left)/rcel.x)*floor((sPnt.y-zRct.bottom)/rcel.y);                                                                   
//#22379        if(bpnt<RMAPBITS)                                                                   
//#22380            return setRmp(bpnt);                                                               
//#22381        return 0;                                                                   
//#22382    }                                                                       
//#22383                                                                           
//#22384    void drwStch(){                                                                       
//#22385                                                                           
//#22386        unsigned    ind,ine,scnt,pwid,wascol;                                                               
//#22387        unsigned    layr;                                                               
//#22388        double        slop,off;                                                           
//#22389        double        dub6;                                                           
//#22390        SHRTPNT*    pstch;                                                               
//#22391        POINT        tlin[2];                                                           
//#22392        long        hi=ds->rcItem.bottom;                                                           
//#22393        long        xba,yab,tlng;                                                           
//#22394        HDC            tdc;                                                       
//#22395                                                                           
//#22396        setMap(RELAYR);                                                                   
//#22397        rstMap(SELSHO);                                                                   
//#22398        rstMap(ILIN1);                                                                   
//#22399        rstMap(BZUM);                                                                   
//#22400        unboxs();                                                                   
//#22401        unrotu();                                                                   
//#22402        unrot();                                                                   
//#22403        rstMap(ILIN);                                                                   
//#22404        uncros();                                                                   
//#22405        rstMap(SHOFRM);                                                                   
//#22406        scnt=0;                                                                   
//#22407        for(ind=0;ind<colCnt;ind++){                                                                   
//#22408                                                                           
//#22409            drwpnt=colch[ind+1].stind-colch[ind].stind;                                                               
//#22410            if(drwpnt>scnt)                                                               
//#22411                scnt=drwpnt;                                                           
//#22412        }                                                                   
//#22413        plin=new POINT[scnt+2];                                                                   
//#22414        FillRect(sdc,&scRct,hStchBak);                                                                   
//#22415        duzrat();                                                                   
//#22416        if(*bnam&&!chkMap(HIDMAP)&&!chkMap(UPTO)){                                                                   
//#22417                                                                           
//#22418            if(chkMap(WASTRAC))                                                               
//#22419                tdc=tracedc;                                                           
//#22420            else                                                               
//#22421                tdc=bitdc;                                                           
//#22422            if(bitar())                                                               
//#22423                StretchBlt(sdc,  bdrct.left,bdrct.top,bdrct.right-bdrct.left,bdrct.bottom-bdrct.top,                                                           
//#22424                           tdc,bsrct.left,bsrct.top,bsrct.right-bsrct.left,bsrct.bottom-bsrct.top,SRCCOPY);                                                   
//#22425        }                                                                   
//#22426        dugrid();                                                                   
//#22427        if(chkMap(INIT)){                                                                   
//#22428                                                                           
//#22429            if(chkMap(ZUMED)){                                                               
//#22430                                                                           
//#22431                scrol.cbSize=sizeof(scrol);                                                           
//#22432                scrol.fMask=SIF_ALL;                                                           
//#22433                scrol.nMax=zum0.y;                                                           
//#22434                scrol.nMin=0;                                                           
//#22435                scrol.nPage=zRct.top-zRct.bottom;                                                           
//#22436                scrol.nPos=zum0.y-zRct.top;                                                           
//#22437                SetScrollInfo(hVrt,SB_CTL,&scrol,TRUE);                                                           
//#22438                scrol.nMax=zum0.x;                                                           
//#22439                scrol.nPage=zRct.right-zRct.left;                                                           
//#22440                scrol.nPos=zRct.left;                                                           
//#22441                SetScrollInfo(hHor,SB_CTL,&scrol,TRUE);                                                           
//#22442                ShowWindow(hHor,TRUE);                                                           
//#22443                ShowWindow(hVrt,TRUE);                                                           
//#22444            }                                                               
//#22445            else{                                                               
//#22446                                                                           
//#22447                ShowWindow(hVrt,FALSE);                                                           
//#22448                ShowWindow(hHor,FALSE);                                                           
//#22449            }                                                               
//#22450            duzrat();                                                               
//#22451            dub6=zrat.x*6;                                                               
//#22452            tPix[0]=dub6*TSIZ30;                                                               
//#22453            tPix[1]=dub6*TSIZ40;                                                               
//#22454            tPix[2]=dub6*TSIZ60;                                                               
//#22455            for(ind=0;ind<16;ind++){                                                               
//#22456                                                                           
//#22457                if(chkMap(THRDS))                                                           
//#22458                    nuStchSiz(ind,tPix[sizInd[ind]]);                                                       
//#22459                else{                                                           
//#22460                    if(chkMap(COL)){                                                       
//#22461                                                                           
//#22462                        if(ind==actcol)                                                   
//#22463                            nuStchSiz(ind,tPix[sizInd[ind]]);                                               
//#22464                        else                                                   
//#22465                            nuStchSiz(ind,1);                                               
//#22466                    }                                                       
//#22467                    else                                                       
//#22468                        nuStchSiz(ind,1);                                                   
//#22469                }                                                           
//#22470            }                                                               
//#22471            drwpnt=0;cbit=0;                                                               
//#22472            if(chkMap(ZUMED)){                                                               
//#22473                                                                           
//#22474                drwpnt=0;                                                           
//#22475                rstMap(LINED);                                                           
//#22476                rstMap(LININ);                                                           
//#22477                for(ind=0;ind<colCnt;ind++){                                                           
//#22478                                                                           
//#22479                    if(chkMap(HID)){                                                       
//#22480                                                                           
//#22481                        if(colch[ind].colind!=actcol){                                                   
//#22482                                                                           
//#22483                            scnt=colch[ind+1].stind-colch[ind].stind;                                               
//#22484                            pstch=&stchs[colch[ind].stind];                                               
//#22485                            for(ine=0;ine<scnt;ine++){                                               
//#22486                                                                           
//#22487                                if(pstch[ine].x>=zRct.left                                           
//#22488                                    &&pstch[ine].x<=zRct.right                                       
//#22489                                    &&pstch[ine].y>=zRct.bottom                                       
//#22490                                    &&pstch[ine].y<=zRct.top){                                       
//#22491                                                                           
//#22492                                    setCol(colch[ind].colind);                                       
//#22493                                    goto skip;                                       
//#22494                                }                                           
//#22495                            }                                               
//#22496                            goto skip;                                               
//#22497                        }                                                   
//#22498                        else                                                   
//#22499                            goto skip1;                                               
//#22500                    }                                                       
//#22501                    else{                                                       
//#22502    skip1:;                                                                       
//#22503                                                                           
//#22504                        wascol=0;                                                   
//#22505                    }                                                       
//#22506                    SelectObject(sdc,uPen[colch[ind].colind]);                                                       
//#22507                    scnt=colch[ind+1].stind-colch[ind].stind;                                                       
//#22508                    pstch=&stchs[colch[ind].stind];                                                       
//#22509                    scnt=chkup(scnt,ind);                                                       
//#22510                    for(ine=0;ine<scnt;ine++){                                                       
//#22511                                                                           
//#22512                        layr=(pstch[ine].at&LAYMSK)>>LAYSHFT;                                                   
//#22513                        if(!actl||!layr||(layr==actl)){                                                   
//#22514                                                                           
//#22515                            if(pstch[ine].x>=zRct.left                                               
//#22516                                &&pstch[ine].x<=zRct.right                                           
//#22517                                &&pstch[ine].y>=zRct.bottom                                           
//#22518                                &&pstch[ine].y<=zRct.top){                                           
//#22519                                                                           
//#22520                                wascol=1;                                           
//#22521                                if(setMap(LINED)){                                           
//#22522                                                                           
//#22523                                    if(setMap(LININ)){                                       
//#22524                                                                           
//#22525                                        plin[drwpnt].x=(pstch[ine].x-zRct.left)*zrat.x+0.5;                                   
//#22526                                        plin[drwpnt++].y=hi-(pstch[ine].y-zRct.bottom)*zrat.y+0.5;                                   
//#22527                                                                           
//#22528                                    }                                       
//#22529                                    else{                                       
//#22530                                                                           
//#22531                                        plin[drwpnt].x=(pstch[ine-1].x-zRct.left)*zrat.x+0.5;                                   
//#22532                                        plin[drwpnt++].y=hi-(pstch[ine-1].y-zRct.bottom)*zrat.y+0.5;                                   
//#22533                                        plin[drwpnt].x=(pstch[ine].x-zRct.left)*zrat.x+0.5;                                   
//#22534                                        plin[drwpnt++].y=hi-(pstch[ine].y-zRct.bottom)*zrat.y+0.5;                                   
//#22535                                    }                                       
//#22536                                }                                           
//#22537                                else{                                           
//#22538                                                                           
//#22539                                    if(ine==0&&ind==0){                                       
//#22540                                                                           
//#22541                                        plin[0].x=(pstch[ine].x-zRct.left)*zrat.x+0.5;                                   
//#22542                                        plin[0].y=hi-(pstch[ine].y-zRct.bottom)*zrat.y+0.5;                                   
//#22543                                        drwpnt=1;                                   
//#22544                                    }                                       
//#22545                                    else{                                       
//#22546                                                                           
//#22547                                        plin[0].x=(pstch[ine-1].x-zRct.left)*zrat.x+0.5;                                   
//#22548                                        plin[0].y=hi-(pstch[ine-1].y-zRct.bottom)*zrat.y+0.5;                                   
//#22549                                        plin[1].x=(pstch[ine].x-zRct.left)*zrat.x+0.5;                                   
//#22550                                        plin[1].y=hi-(pstch[ine].y-zRct.bottom)*zrat.y+0.5;                                   
//#22551                                        drwpnt=2;                                   
//#22552                                    }                                       
//#22553                                    setMap(LININ);                                       
//#22554                                }                                           
//#22555                            }                                               
//#22556                            else{                                               
//#22557                                                                           
//#22558                                if(rstMap(LININ)){                                           
//#22559                                                                           
//#22560                                    plin[drwpnt].x=(pstch[ine].x-zRct.left)*zrat.x+0.5;                                       
//#22561                                    plin[drwpnt++].y=hi-(pstch[ine].y-zRct.bottom)*zrat.y+0.5;                                       
//#22562                                    Polyline(sdc,plin,drwpnt);                                       
//#22563                                    drwpnt=0;                                       
//#22564                                }                                           
//#22565                                else{                                           
//#22566                                                                           
//#22567                                    if(ine){                                       
//#22568                                                                           
//#22569                                        //write an equation for this line                                   
//#22570                                        xba=pstch[ine].x-pstch[ine-1].x;                                   
//#22571                                        yab=pstch[ine-1].y-pstch[ine].y;                                   
//#22572                                        slop=(double)xba/yab;                                   
//#22573                                        off=pstch[ine].x+slop*pstch[ine].y;                                   
//#22574                                        //does the line intersect with the top of the screen?                                   
//#22575                                        tlng=off-slop*zRct.top;                                   
//#22576                                        if(tlng>=zRct.left&&tlng<=zRct.right){                                   
//#22577                                                                           
//#22578                                            tlin[0].x=(pstch[ine-1].x-zRct.left)*zrat.x+0.5;                               
//#22579                                            tlin[0].y=hi-(pstch[ine-1].y-zRct.bottom)*zrat.x+0.5;                               
//#22580                                            tlin[1].x=(pstch[ine].x-zRct.left)*zrat.x+0.5;                               
//#22581                                            tlin[1].y=hi-(pstch[ine].y-zRct.bottom)*zrat.x+0.5;                               
//#22582                                            Polyline(sdc,tlin,2);                               
//#22583                                            goto rotlin;                               
//#22584                                        }                                   
//#22585                                        //does the line intersect the bottom of the screen?                                   
//#22586                                        tlng=off-slop*zRct.bottom;                                   
//#22587                                        if(tlng>=zRct.left&&tlng<=zRct.right){                                   
//#22588                                                                           
//#22589                                            tlin[0].x=(pstch[ine-1].x-zRct.left)*zrat.x+0.5;                               
//#22590                                            tlin[0].y=hi-(pstch[ine-1].y-zRct.bottom)*zrat.y+0.5;                               
//#22591                                            tlin[1].x=(pstch[ine].x-zRct.left)*zrat.x+0.5;                               
//#22592                                            tlin[1].y=hi-(pstch[ine].y-zRct.bottom)*zrat.y+0.5;                               
//#22593                                            Polyline(sdc,tlin,2);                               
//#22594                                            goto rotlin;                               
//#22595                                        }                                   
//#22596                                        //does the line intersect the left side of the screen?                                   
//#22597                                        if(slop){                                   
//#22598                                                                           
//#22599                                            tlng=(off-zRct.left)/slop;                               
//#22600                                            if(tlng>=zRct.bottom&&tlng<=zRct.top){                               
//#22601                                                                           
//#22602                                                tlin[0].x=(pstch[ine-1].x-zRct.left)*zrat.x+0.5;                           
//#22603                                                tlin[0].y=hi-(pstch[ine-1].y-zRct.bottom)*zrat.y+0.5;                           
//#22604                                                tlin[1].x=(pstch[ine].x-zRct.left)*zrat.x+0.5;                           
//#22605                                                tlin[1].y=hi-(pstch[ine].y-zRct.bottom)*zrat.y+0.5;                           
//#22606                                                Polyline(sdc,tlin,2);                           
//#22607                                            }                               
//#22608                                        }                                   
//#22609                                    }                                       
//#22610    rotlin:;                                                                       
//#22611                                                                           
//#22612                                }                                           
//#22613                            }                                               
//#22614                        }                                                   
//#22615                    }                                                       
//#22616                    if(drwpnt){                                                       
//#22617                                                                           
//#22618                        Polyline(sdc,plin,drwpnt);                                                   
//#22619                        plin[0].x=plin[drwpnt-1].x;                                                   
//#22620                        plin[0].y=plin[drwpnt-1].y;                                                   
//#22621                        drwpnt=1;                                                   
//#22622                    }                                                       
//#22623                    if(wascol)                                                       
//#22624                        setCol(colch[ind].colind);                                                   
//#22625    skip:;                                                                       
//#22626                }                                                           
//#22627            }                                                               
//#22628            else{                                                               
//#22629                                                                           
//#22630                pwid=chkMap(HID);                                                           
//#22631                for(ind=0;ind<colCnt;ind++){                                                           
//#22632                                                                           
//#22633                    setCol(colch[ind].colind);                                                       
//#22634                    scnt=colch[ind+1].stind-colch[ind].stind;                                                       
//#22635                    scnt=chkup(scnt,ind);                                                       
//#22636                    if(!pwid||(pwid&&colch[ind].colind==actcol))                                                       
//#22637                        drwLin(colch[ind].stind,scnt,uPen[colch[ind].colind]);                                                   
//#22638                }                                                           
//#22639            }                                                               
//#22640            if(chkMap(SELBOX)){                                                               
//#22641                                                                           
//#22642                ritcor(&stchs[cloInd]);                                                           
//#22643                if(stch2px(cloInd))                                                           
//#22644                    dubox();                                                       
//#22645            }                                                               
//#22646            if(chkMap(FRMPSEL))                                                               
//#22647                ritfcor(&formlst[clofind].flt[clofine]);                                                           
//#22648            if(!chkMap(SELBOX)&&!chkMap(FRMPSEL))                                                               
//#22649                butxt(HCOR,"");                                                           
//#22650            if(chkMap(WASLIN))                                                               
//#22651                relin();                                                           
//#22652            if(chkMap(GRPSEL)){                                                               
//#22653                                                                           
//#22654                if(cmpstch(cloInd,grpInd))                                                           
//#22655                    cros(cloInd);                                                       
//#22656                else{                                                           
//#22657                                                                           
//#22658                    slpnt=0;                                                       
//#22659                    ducros(sdc);                                                       
//#22660                }                                                           
//#22661                selRct(&rngrct);                                                           
//#22662                nuselrct();                                                           
//#22663                setMap(SELSHO);                                                           
//#22664                dusel(sdc);                                                           
//#22665            }                                                               
//#22666            if(zumFct<stchboxs){                                                               
//#22667                                                                           
//#22668                clRmap(RMAPSIZ);                                                           
//#22669                SelectObject(sdc,lPen);                                                           
//#22670                SetROP2(sdc,R2_NOTXORPEN);                                                           
//#22671                rint();                                                           
//#22672                if(chkMap(HID)){                                                           
//#22673                                                                           
//#22674                    for(ind=0;ind<colCnt;ind++){                                                       
//#22675                                                                           
//#22676                        if(colch[ind].colind==actcol){                                                   
//#22677                                                                           
//#22678                            for(ine=colch[ind].stind;ine<colch[ind+1].stind;ine++){                                               
//#22679                                                                           
//#22680                                if(stchs[ine].x>=zRct.left&&stchs[ine].x<=zRct.right                                           
//#22681                                    &&stchs[ine].y>=zRct.bottom&&stchs[ine].y<=zRct.top                                       
//#22682                                    &&setRmap(stchs[ine]))                                       
//#22683                                                                           
//#22684                                    stchbox(ine,sdc);                                       
//#22685                            }                                               
//#22686                        }                                                   
//#22687                    }                                                       
//#22688                }                                                           
//#22689                else{                                                           
//#22690                                                                           
//#22691                    for(ind=0;ind<hed.stchs;ind++){                                                       
//#22692                                                                           
//#22693                        if(stchs[ind].x>=zRct.left&&stchs[ind].x<=zRct.right                                                   
//#22694                            &&stchs[ind].y>=zRct.bottom&&stchs[ind].y<=zRct.top                                               
//#22695                            &&setRmap(stchs[ind]))                                               
//#22696                                                                           
//#22697                            stchbox(ind,sdc);                                               
//#22698                    }                                                       
//#22699                }                                                           
//#22700                SetROP2(sdc,R2_COPYPEN);                                                           
//#22701            }                                                               
//#22702            if(chkMap(CLPSHO))                                                               
//#22703                duclp();                                                           
//#22704            if(chkMap(ROTAT)||chkMap(ROTCAPT)||chkMap(MOVCNTR))                                                               
//#22705                ritrot();                                                           
//#22706            delete plin;                                                               
//#22707        }                                                                   
//#22708        if(formpnt&&!chkMap(FRMOF))                                                                   
//#22709            drwfrm();                                                               
//#22710        if(chkMap(INSFRM))                                                                   
//#22711            rinfrm();                                                               
//#22712        if(chkMap(BIGBOX))                                                                   
//#22713            dubig();                                                               
//#22714        if(chkMap(MOVFRM)){                                                                   
//#22715                                                                           
//#22716            setMap(SHOFRM);                                                               
//#22717            dufrm();                                                               
//#22718        }                                                                   
//#22719        if(chkMap(SATPNT))                                                                   
//#22720            satzum();                                                               
//#22721        if(hfdat)                                                                   
//#22722            refrm();                                                               
//#22723        if(chkMap(GMRK))                                                                   
//#22724            drwmrk(sdc);                                                               
//#22725        if(chkMap(PRFACT))                                                                   
//#22726            redraw(hPrf);                                                               
//#22727        if(chkMap(SELBOX))                                                                   
//#22728            ritnum(STR_NUMSEL,cloInd);                                                               
//#22729        ritot(hed.stchs);                                                                   
//#22730        if(chkMap(INIT))                                                                   
//#22731            lenCalc();                                                               
//#22732        if(chkMap(MOVSET))                                                                   
//#22733            dumov();                                                               
//#22734        drwknot();                                                                   
//#22735    }                                                                       
//#22736                                                                           
//#22737    unsigned chkCol(unsigned ind){                                                                       
//#22738                                                                           
//#22739        _asm{                                                                   
//#22740                                                                           
//#22741                mov        ebx,ind                                                   
//#22742                mov        edx,cbit                                                   
//#22743                xor        eax,eax                                                   
//#22744                bt        edx,ebx                                                   
//#22745                jnc        chk1                                                   
//#22746                dec        eax                                                   
//#22747    chk1:                                                                       
//#22748        }                                                                   
//#22749    #pragma warning(disable:4035;once:)                                                                       
//#22750    }                                                                       
//#22751                                                                           
//#22752    void dubar(){                                                                       
//#22753                                                                           
//#22754        unsigned    ind;                                                               
//#22755        RECT        tRct;                                                           
//#22756        double        tdub;                                                           
//#22757        POINT        lin[2];                                                           
//#22758                                                                           
//#22759        tRct.left=ds->rcItem.left;                                                                   
//#22760        tRct.right=ds->rcItem.right;                                                                   
//#22761        tRct.top=0;                                                                   
//#22762        tRct.bottom=ds->rcItem.bottom;                                                                   
//#22763        for(ind=0;ind<colCnt;ind++){                                                                   
//#22764                                                                           
//#22765            tdub=(double)colch[ind+1].stind/hed.stchs;                                                               
//#22766            tRct.bottom=tdub*ds->rcItem.bottom;                                                               
//#22767            FillRect(ds->hDC,&tRct,hbrUseCol[colch[ind].colind]);                                                               
//#22768            tRct.top=tRct.bottom;                                                               
//#22769        }                                                                   
//#22770        if(chkMap(SELBOX)||chkMap(GRPSEL)){                                                                   
//#22771                                                                           
//#22772            tdub=(double)cloInd/hed.stchs;                                                               
//#22773            lin[0].y=lin[1].y=tRct.bottom*tdub+0.5;                                                               
//#22774            lin[0].x=tRct.left;                                                               
//#22775            lin[1].x=tRct.right;                                                               
//#22776            SelectObject(ds->hDC,xPen);                                                               
//#22777            SetROP2(sdc, R2_NOTXORPEN);                                                               
//#22778            Polyline(ds->hDC,lin,2);                                                               
//#22779            if(chkMap(GRPSEL)){                                                               
//#22780                                                                           
//#22781                tdub=(double)grpInd/hed.stchs;                                                           
//#22782                lin[0].y=lin[1].y=tRct.bottom*tdub+0.5;                                                           
//#22783                lin[0].x=tRct.left;                                                           
//#22784                lin[1].x=tRct.right;                                                           
//#22785                Polyline(ds->hDC,lin,2);                                                           
//#22786            }                                                               
//#22787            SetROP2(sdc,R2_COPYPEN);                                                               
//#22788        }                                                                   
//#22789    }                                                                       
//#22790                                                                           
//#22791    void ritbak(TCHAR* nam,DRAWITEMSTRUCT* ds){                                                                       
//#22792                                                                           
//#22793        unsigned    ind,ine,inf,col,lind,redsiz;                                                               
//#22794        HANDLE        thfil;                                                           
//#22795        POINT        siz;                                                           
//#22796        SHRTPNT*    tstch;                                                               
//#22797        POINT*        plin;                                                           
//#22798        STRHED        sthed;                                                           
//#22799        FLPNT        rsiz;                                                           
//#22800        double        rat;                                                           
//#22801        double        ratx,raty;                                                           
//#22802        COLORREF    tbak;                                                               
//#22803        COLORREF    tcol[16];                                                               
//#22804        HBRUSH        tbr;                                                           
//#22805        HPEN        pen;                                                           
//#22806        FRMHED*        flst;                                                           
//#22807        FLPNT*        tflt;                                                           
//#22808        STREX        thedx;                                                           
//#22809        unsigned    vervar;                                                               
//#22810        FRMHEDO*    frmlstx;                                                               
//#22811                                                                           
//#22812        thfil=CreateFile(nam,GENERIC_READ,0,0,                                                                   
//#22813            OPEN_EXISTING,0,0);                                                               
//#22814        siz.x=ds->rcItem.right-ds->rcItem.left;                                                                   
//#22815        siz.y=ds->rcItem.bottom-ds->rcItem.top;                                                                   
//#22816        if(thfil!=INVALID_HANDLE_VALUE){                                                                   
//#22817                                                                           
//#22818            ReadFile(thfil,(STRHED*)&sthed,sizeof(STRHED),&red,NULL);                                                               
//#22819            if(red==sizeof(STRHED)){                                                               
//#22820                                                                           
//#22821                if((sthed.led&0xffffff)==0x746872){                                                           
//#22822                                                                           
//#22823                    vervar=(sthed.led&0xff000000)>>24;                                                       
//#22824                    switch(vervar){                                                       
//#22825                                                                           
//#22826                    case 0:                                                       
//#22827                                                                           
//#22828                        if(hed.hup==SMALHUP){                                                   
//#22829                                                                           
//#22830                            rsiz.x=ini.hupx=SHUPX;                                               
//#22831                            rsiz.y=ini.hupy=SHUPY;                                               
//#22832                        }                                                   
//#22833                        else{                                                   
//#22834                                                                           
//#22835                            rsiz.x=ini.hupx=LHUPX;                                               
//#22836                            rsiz.y=ini.hupy=LHUPY;                                               
//#22837                        }                                                   
//#22838                        break;                                                   
//#22839                                                                           
//#22840                    case 1:                                                       
//#22841                    case 2:                                                       
//#22842                                                                           
//#22843                        ReadFile(thfil,(STREX*)&thedx,sizeof(STREX),&red,NULL);                                                   
//#22844                        if(red!=sizeof(STREX))                                                   
//#22845                            return;                                               
//#22846                        rsiz.x=thedx.xhup;                                                   
//#22847                        rsiz.y=thedx.yhup;                                                   
//#22848                                                                           
//#22849                        break;                                                   
//#22850                                                                           
//#22851                    default:                                                       
//#22852                                                                           
//#22853                        return;                                                   
//#22854                    }                                                       
//#22855                }                                                           
//#22856                ratx=(double)siz.x/rsiz.x;                                                           
//#22857                raty=(double)siz.y/rsiz.y;                                                           
//#22858                if(ratx<raty)                                                           
//#22859                    rat=ratx;                                                       
//#22860                else                                                           
//#22861                    rat=raty;                                                       
//#22862                if(sthed.stchs){                                                           
//#22863                                                                           
//#22864                    tstch=new SHRTPNT[sthed.stchs];                                                       
//#22865                    plin=new POINT[sthed.stchs];                                                       
//#22866                    redsiz=sthed.stchs*sizeof(SHRTPNT);                                                       
//#22867                    ReadFile(thfil,(SHRTPNT*)tstch,redsiz,&red,0);                                                       
//#22868                    if(redsiz==red){                                                       
//#22869                                                                           
//#22870                        SetFilePointer(thfil,16,0,FILE_CURRENT);                                                   
//#22871                        ReadFile(thfil,(COLORREF*)&tbak,4,&red,0);                                                   
//#22872                        ReadFile(thfil,(COLORREF*)tcol,64,&red,0);                                                   
//#22873                        tbr=CreateSolidBrush(tbak);                                                   
//#22874                        SelectObject(ds->hDC,tbr);                                                   
//#22875                        FillRect(ds->hDC,&ds->rcItem,tbr);                                                   
//#22876                        col=tstch[0].at&0xf;                                                   
//#22877                        pen=CreatePen(PS_SOLID,1,tcol[col]);                                                   
//#22878                        lind=0;                                                   
//#22879                        for(ine=0;ine<sthed.stchs;ine++){                                                   
//#22880                                                                           
//#22881                            if((tstch[ine].at&0xf)==col){                                               
//#22882                                                                           
//#22883                                plin[lind].x=tstch[ine].x*rat;                                           
//#22884                                plin[lind++].y=siz.y-tstch[ine].y*rat;                                           
//#22885                            }                                               
//#22886                            else{                                               
//#22887                                                                           
//#22888                                pen=nuPen(pen,1,tcol[col]);                                           
//#22889                                SelectObject(ds->hDC,pen);                                           
//#22890                                Polyline(ds->hDC,plin,lind);                                           
//#22891                                lind=0;                                           
//#22892                                col=tstch[ine].at&0xf;                                           
//#22893                            }                                               
//#22894                        }                                                   
//#22895                        if(lind){                                                   
//#22896                                                                           
//#22897                            pen=nuPen(pen,1,tcol[col]);                                               
//#22898                            SelectObject(ds->hDC,pen);                                               
//#22899                            Polyline(ds->hDC,plin,lind);                                               
//#22900                        }                                                   
//#22901                        DeleteObject(tbr);                                                   
//#22902                        DeleteObject(pen);                                                   
//#22903                        delete tstch;                                                   
//#22904                        delete plin;                                                   
//#22905                    }                                                       
//#22906                    else{                                                       
//#22907                                                                           
//#22908                        delete tstch;                                                   
//#22909                        delete plin;                                                   
//#22910                        CloseHandle(thfil);                                                   
//#22911                        return;                                                   
//#22912                    }                                                       
//#22913                }                                                           
//#22914                else                                                           
//#22915                    SetFilePointer(thfil,84,0,FILE_CURRENT);                                                       
//#22916                if(sthed.fpnt){                                                           
//#22917                                                                           
//#22918                    plin=new POINT[MAXFRMLINS];                                                       
//#22919                    SetFilePointer(thfil,80,0,FILE_CURRENT);                                                       
//#22920                    flst=new FRMHED[sthed.fpnt];                                                       
//#22921                    tflt=new FLPNT[sthed.fcnt];                                                       
//#22922                    if(vervar<2){                                                       
//#22923                                                                           
//#22924                        frmlstx=(FRMHEDO*)&bseq;                                                   
//#22925                        ReadFile(thfil,(FRMHEDO*)frmlstx,sthed.fpnt*sizeof(FRMHEDO),&red,0);                                                   
//#22926                        if(red!=sthed.fcnt*sizeof(FRMHEDO))                                                   
//#22927                            goto bakskp;                                               
//#22928                        FillMemory(&bseq,0,sizeof(FRMHED)*formpnt);                                                   
//#22929                        for(ind=0;ind<sthed.fpnt;ind++){                                                   
//#22930                                                                           
//#22931                            frmpnt=&flst[ind];                                               
//#22932                            MoveMemory(frmpnt,&frmlstx[ind],sizeof(FRMHEDO));                                               
//#22933                        }                                                   
//#22934                    }                                                       
//#22935                    else{                                                       
//#22936                                                                           
//#22937                        redsiz=sthed.fpnt*sizeof(FRMHED);                                                   
//#22938                        ReadFile(thfil,(FRMHED*)flst,redsiz,&red,0);                                                   
//#22939                        if(red!=redsiz)                                                   
//#22940                            goto bakskp;                                               
//#22941                    }                                                       
//#22942                    redsiz=sthed.fcnt*sizeof(FLPNT);                                                       
//#22943                    ReadFile(thfil,(FLPNT*)tflt,redsiz,&red,0);                                                       
//#22944                    if(red!=redsiz)                                                       
//#22945                        goto bakskp;                                                   
//#22946                    inf=0;                                                       
//#22947                    for(ind=0;ind<sthed.fpnt;ind++){                                                       
//#22948                                                                           
//#22949                        lind=inf;                                                   
//#22950                        for(ine=0;ine<flst[ind].sids;ine++){                                                   
//#22951                                                                           
//#22952                            plin[ine].x=tflt[inf].x*rat;                                               
//#22953                            plin[ine].y=siz.y-tflt[inf++].y*rat;                                               
//#22954                        }                                                   
//#22955                        plin[ine].x=tflt[lind].x*rat;                                                   
//#22956                        plin[ine].y=siz.y-tflt[lind].y*rat;                                                   
//#22957                        SelectObject(ds->hDC,fPen);                                                   
//#22958                        SetROP2(ds->hDC,R2_XORPEN);                                                   
//#22959                        if(formlst[ind].typ==LIN)                                                   
//#22960                            Polyline(ds->hDC,plin,flst[ind].sids);                                               
//#22961                        else                                                   
//#22962                            Polyline(ds->hDC,plin,flst[ind].sids+1);                                               
//#22963                        SetROP2(sdc,R2_COPYPEN);                                                   
//#22964                    }                                                       
//#22965    bakskp:;                                                                       
//#22966                    delete flst;                                                       
//#22967                    delete tflt;                                                       
//#22968                    delete plin;                                                       
//#22969                }                                                           
//#22970            }                                                               
//#22971            CloseHandle(thfil);                                                               
//#22972        }                                                                   
//#22973    }                                                                       
//#22974                                                                           
//#22975    void durct(unsigned shft,RECT irct){                                                                       
//#22976                                                                           
//#22977        unsigned    lo,hi,len;                                                               
//#22978        double        rat;                                                           
//#22979                                                                           
//#22980        lo=(uref>>shft)&0xff;                                                                   
//#22981        hi=(dref>>shft)&0xff;                                                                   
//#22982        hirct.left=lorct.left=midrct.left=irct.left;                                                                   
//#22983        hirct.right=lorct.right=midrct.right=irct.right;                                                                   
//#22984        len=irct.bottom-irct.top;                                                                   
//#22985        rat=(double)lo/255;                                                                   
//#22986        midrct.top=len*rat+irct.top;                                                                   
//#22987        rat=(double)hi/255;                                                                   
//#22988        midrct.bottom=len*rat+irct.top;                                                                   
//#22989        rstMap(DUHI);                                                                   
//#22990        rstMap(DULO);                                                                   
//#22991        if(lo){                                                                   
//#22992                                                                           
//#22993            setMap(DULO);                                                               
//#22994            lorct.bottom=midrct.top;                                                               
//#22995            lorct.top=0;                                                               
//#22996        }                                                                   
//#22997        if(hi!=255){                                                                   
//#22998                                                                           
//#22999            setMap(DUHI);                                                               
//#23000            hirct.top=midrct.bottom;                                                               
//#23001            hirct.bottom=irct.bottom;                                                               
//#23002        }                                                                   
//#23003    }                                                                       
//#23004                                                                           
//#23005    void dublk(HDC dc){                                                                       
//#23006                                                                           
//#23007        if(chkMap(DUHI))                                                                   
//#23008            FillRect(dc,&hirct,hblk);                                                               
//#23009        if(chkMap(DULO))                                                                   
//#23010            FillRect(dc,&lorct,hblk);                                                               
//#23011    }                                                                       
//#23012                                                                           
//#23013    BOOL chkchksum(){                                                                       
//#23014                                                                           
//#23015        unsigned        ind;                                                           
//#23016        __int64            chkacc;                                                       
//#23017        __int64            chksum;                                                       
//#23018        __int64*        pchk;                                                           
//#23019        unsigned char*    pkchr;                                                               
//#23020        unsigned char*    ptchr;                                                               
//#23021        unsigned char*    pchr;                                                               
//#23022                                                                           
//#23023        pkchr=(unsigned char*)&cryptkey;                                                                   
//#23024        pchr=(unsigned char*)&chksum;                                                                   
//#23025        for(ind=0;ind<8;ind++)                                                                   
//#23026        {                                                                   
//#23027            ptchr=&pkchr[chk1loc[ind]];                                                               
//#23028            pchr[ind]=*ptchr;                                                               
//#23029            *ptchr=0;                                                               
//#23030        }                                                                   
//#23031        pchk=(__int64*)&cryptkey;                                                                   
//#23032        chkacc=0;                                                                   
//#23033        for(ind=0;ind<512;ind++)                                                                   
//#23034            chkacc+=pchk[ind];                                                               
//#23035        if(chkacc==chksum)                                                                   
//#23036            return 0;                                                               
//#23037        else                                                                   
//#23038            return 1;                                                               
//#23039    }                                                                       
//#23040                                                                           
//#23041    LRESULT CALLBACK WndProc(HWND hWnd,UINT message,WPARAM wParam,LPARAM lParam){                                                                       
//#23042                                                                           
//#23043        unsigned            ind,ine;                                                       
//#23044        TCHAR                buf[10];        //for integer to string conversion                                           
//#23045        unsigned            len;            //string length                                           
//#23046        SIZE                txSiz;            //for measuring text items                                       
//#23047        POINT                scPnt;            //for scroll bar functions                                       
//#23048        POINT                lin[2];                                                   
//#23049        long                twid;                                                   
//#23050        double                tdub;                                                   
//#23051        TCHAR                nam[MAX_PATH];                                                   
//#23052                                                                           
//#23053        switch(message){                                                                   
//#23054                                                                           
//#23055        case WM_INITMENU:                                                                   
//#23056                                                                           
//#23057            if(rstMap(PRFACT)){                                                               
//#23058                                                                           
//#23059                DestroyWindow(hPrf);                                                           
//#23060                rstMap(WASRT);                                                           
//#23061            }                                                               
//#23062            unmsg();                                                               
//#23063            undat();                                                               
//#23064            rstMap(FORMIN);                                                               
//#23065            setMap(RESTCH);                                                               
//#23066            break;                                                               
//#23067                                                                           
//#23068        case WM_HSCROLL:                                                                   
//#23069                                                                           
//#23070            switch((long)(LOWORD(wParam))){                                                               
//#23071                                                                            
//#23072            case SB_LINELEFT:                                                               
//#23073                                                                           
//#23074                if(chkMap(RUNPAT)||chkMap(WASPAT)){                                                           
//#23075                                                                           
//#23076                    delay+=SPEDLIN;                                                       
//#23077                    if(delay>MAXDELAY)                                                       
//#23078                        delay=MAXDELAY;                                                   
//#23079                    setsped();                                                       
//#23080                    SetScrollPos(hSped,SB_CTL,MAXDELAY-delay,TRUE);                                                       
//#23081                }                                                           
//#23082                else{                                                           
//#23083                                                                           
//#23084                    scPnt.x=(zRct.right-zRct.left)*LINSCROL;                                                       
//#23085                    if(!scPnt.x)                                                       
//#23086                        scPnt.x=1;                                                   
//#23087                    scPnt.y=0;                                                       
//#23088                    rshft(scPnt);                                                       
//#23089                }                                                           
//#23090                return 1;                                                           
//#23091                                                                           
//#23092            case SB_LINERIGHT:                                                               
//#23093                                                                           
//#23094                if(chkMap(RUNPAT)||chkMap(WASPAT)){                                                           
//#23095                                                                           
//#23096                    delay-=SPEDLIN;                                                       
//#23097                    if(delay<MINDELAY)                                                       
//#23098                        delay=MINDELAY;                                                   
//#23099                    setsped();                                                       
//#23100                    SetScrollPos(hSped,SB_CTL,MAXDELAY-delay,TRUE);                                                       
//#23101                }                                                           
//#23102                else{                                                           
//#23103                                                                           
//#23104                    scPnt.x=-(zRct.right-zRct.left)*LINSCROL;                                                       
//#23105                    if(!scPnt.x)                                                       
//#23106                        scPnt.x=-1;                                                   
//#23107                    scPnt.y=0;                                                       
//#23108                    rshft(scPnt);                                                       
//#23109                }                                                           
//#23110                return 1;                                                           
//#23111                                                                           
//#23112            case SB_PAGELEFT:                                                               
//#23113                                                                           
//#23114                if(chkMap(RUNPAT)||chkMap(WASPAT)){                                                           
//#23115                                                                           
//#23116                    delay+=SPEDPAG;                                                       
//#23117                    if(delay<MINDELAY)                                                       
//#23118                        delay=MINDELAY;                                                   
//#23119                    setsped();                                                       
//#23120                    SetScrollPos(hSped,SB_CTL,MAXDELAY-delay,TRUE);                                                       
//#23121                }                                                           
//#23122                else                                                           
//#23123                    pglft();                                                       
//#23124                return 1;                                                           
//#23125                                                                           
//#23126            case SB_PAGERIGHT:                                                               
//#23127                                                                           
//#23128                if(chkMap(RUNPAT)||chkMap(WASPAT)){                                                           
//#23129                                                                           
//#23130                    delay-=SPEDPAG;                                                       
//#23131                    if(delay<MINDELAY)                                                       
//#23132                        delay=MINDELAY;                                                   
//#23133                    setsped();                                                       
//#23134                    SetScrollPos(hSped,SB_CTL,MAXDELAY-delay,TRUE);                                                       
//#23135                }                                                           
//#23136                else                                                           
//#23137                    pgrit();                                                       
//#23138                return 1;                                                           
//#23139                                                                           
//#23140            case SB_THUMBPOSITION:                                                               
//#23141                                                                           
//#23142                if(chkMap(RUNPAT)||chkMap(WASPAT)){                                                           
//#23143                                                                           
//#23144                    if((HWND)lParam==hSped){                                                       
//#23145                                                                           
//#23146                        ind=(unsigned)HIWORD(wParam);                                                   
//#23147                        delay=MAXDELAY-ind;                                                   
//#23148                        setsped();                                                   
//#23149                        SetScrollPos(hSped,SB_CTL,ind,TRUE);                                                   
//#23150                    }                                                       
//#23151                }                                                           
//#23152                else{                                                           
//#23153                                                                           
//#23154                    if((HWND)lParam==hHor){                                                       
//#23155                                                                           
//#23156                        scPnt.x=zRct.right-zRct.left;                                                   
//#23157                        zRct.left=(long)HIWORD(wParam);                                                   
//#23158                        zRct.right=zRct.left+scPnt.x;                                                   
//#23159                        if(zRct.right>zum0.x){                                                   
//#23160                                                                           
//#23161                            zRct.right=zum0.x;                                               
//#23162                            zRct.left=zum0.x-scPnt.x;                                               
//#23163                        }                                                   
//#23164                        setMap(RESTCH);                                                   
//#23165                    }                                                       
//#23166                }                                                           
//#23167                return 1;                                                           
//#23168            }                                                               
//#23169            break;                                                               
//#23170                                                                           
//#23171        case WM_VSCROLL:                                                                   
//#23172                                                                           
//#23173            switch((int)LOWORD(wParam)){                                                               
//#23174                                                                           
//#23175            unpat();                                                               
//#23176            case SB_LINEDOWN:                                                               
//#23177                                                                           
//#23178                scPnt.y=(zRct.top-zRct.bottom)*LINSCROL;                                                           
//#23179                if(!scPnt.y)                                                           
//#23180                    scPnt.y=1;                                                       
//#23181                scPnt.x=0;                                                           
//#23182                rshft(scPnt);                                                           
//#23183                return 1;                                                           
//#23184                                                                           
//#23185            case SB_LINEUP:                                                               
//#23186                                                                           
//#23187                scPnt.y=-(zRct.top-zRct.bottom)*LINSCROL;                                                           
//#23188                if(!scPnt.y)                                                           
//#23189                    scPnt.y=-1;                                                       
//#23190                scPnt.x=0;                                                           
//#23191                rshft(scPnt);                                                           
//#23192                return 1;                                                           
//#23193                                                                           
//#23194            case SB_PAGEDOWN:                                                               
//#23195                                                                           
//#23196                pgdwn();                                                           
//#23197                return 1;                                                           
//#23198                                                                           
//#23199            case SB_PAGEUP:                                                               
//#23200                                                                           
//#23201                pgup();                                                           
//#23202                return 1;                                                           
//#23203                                                                           
//#23204            case SB_THUMBPOSITION:                                                               
//#23205                                                                           
//#23206                scPnt.y=zRct.top-zRct.bottom;                                                           
//#23207                zRct.top=zum0.y-(long)HIWORD(wParam);                                                           
//#23208                zRct.bottom=zRct.top-scPnt.y;                                                           
//#23209                if(zRct.bottom<0){                                                           
//#23210                                                                           
//#23211                    zRct.bottom=0;                                                       
//#23212                    zRct.top=scPnt.y;                                                       
//#23213                }                                                           
//#23214                setMap(RESTCH);                                                           
//#23215                return 1;                                                           
//#23216            }                                                               
//#23217            break;                                                               
//#23218                                                                           
//#23219        case WM_DRAWITEM:                                                                   
//#23220                                                                           
//#23221            //owner draw windows                                                               
//#23222            ds=(LPDRAWITEMSTRUCT)lParam;                                                               
//#23223            if(ds->hwndItem==hStch&&ds->itemAction==ODA_DRAWENTIRE){                                                               
//#23224                                                                           
//#23225                if(chkMap(TXTRED))                                                           
//#23226                {                                                           
//#23227                    drwtxtr();                                                       
//#23228                    return 1;                                                       
//#23229                }                                                           
//#23230                if(!chkMap(RUNPAT)){                                                           
//#23231                                                                           
//#23232                    if(!chkMap(HIDSTCH)&&(hFil||chkMap(INIT)||formpnt||chkMap(SATPNT))&&!chkMap(BAKSHO))                                                       
//#23233                        drwStch();                                                   
//#23234                    else{                                                       
//#23235                                                                           
//#23236                        FillRect(sdc,&scRct,hStchBak);                                                   
//#23237                        duzrat();                                                   
//#23238                        dugrid();                                                   
//#23239                        if(chkMap(HIDSTCH)){                                                   
//#23240                                                                           
//#23241                            drwfrm();                                               
//#23242                            if(chkMap(SATPNT))                                               
//#23243                                satzum();                                           
//#23244                        }                                                   
//#23245                        if(chkMap(PRFACT))                                                   
//#23246                            redraw(hPrf);                                               
//#23247                        else{                                                   
//#23248                                                                           
//#23249                            if(chkMap(MOVFRM)){                                               
//#23250                                                                           
//#23251                                unfrm();                                           
//#23252                                setMap(SHOFRM);                                           
//#23253                                dufrm();                                           
//#23254                            }                                               
//#23255                            if(chkMap(POLIMOV)){                                               
//#23256                                                                           
//#23257                                setMap(SHOFRM);                                           
//#23258                                mdufrm();                                           
//#23259                            }                                               
//#23260                        }                                                   
//#23261                    }                                                       
//#23262                    BitBlt(                                                       
//#23263                      rsdc,            // handle to destination DC                                           
//#23264                    0            // x-coord of destination upper-left corner                                           
//#23265                    0            // y-coord of destination upper-left corner                                           
//#23266                      scRct.right,    // width of destination rectangle                                                   
//#23267                      scRct.bottom,    // height of destination rectangle                                                   
//#23268                      sdc,            // handle to source DC                                           
//#23269                    0            // x-coordinate of source upper-left corner                                           
//#23270                    0            // y-coordinate of source upper-left corner                                           
//#23271                      SRCCOPY        // raster operation code                                               
//#23272                    );                                                       
//#23273                    if(chkMap(ROTSHO))                                                       
//#23274                        durot();                                                   
//#23275                    if(chkMap(SHOSAT))                                                       
//#23276                        dusat();                                                   
//#23277                    if(chkMap(SHOINSF))                                                       
//#23278                        duinsf();                                                   
//#23279                }                                                           
//#23280                return 1;                                                           
//#23281            }                                                               
//#23282            if(ds->hwndItem==hBar&&ds->itemAction==ODA_DRAWENTIRE){                                                               
//#23283                                                                           
//#23284                if(hed.stchs)                                                           
//#23285                    dubar();                                                       
//#23286                else                                                           
//#23287                    FillRect(ds->hDC,&ds->rcItem,(HBRUSH)(COLOR_WINDOW+1));                                                       
//#23288                return 1;                                                           
//#23289            }                                                               
//#23290            if(ds->hwndItem==hbuts[HHID]&&ds->itemAction==ODA_DRAWENTIRE){                                                               
//#23291                                                                           
//#23292                ind=(buttonWid3-pcolsiz.cx)>>1;                                                           
//#23293                if(chkMap(HID)){                                                           
//#23294                                                                           
//#23295                    FillRect(ds->hDC,&ds->rcItem,hbrUseCol[actcol]);                                                       
//#23296                    SetBkColor(ds->hDC,useCol[actcol]);                                                       
//#23297                }                                                           
//#23298                else                                                           
//#23299                    FillRect(ds->hDC,&ds->rcItem,(HBRUSH)(COLOR_BTNFACE+1));                                                       
//#23300                if(chkMap(TXTRED))                                                           
//#23301                {                                                           
//#23302                    LoadString(hInst,IDS_TXWID,nam,MAX_PATH);                                                       
//#23303                    sprintf(hlpbuf,nam,tscr.wid/PFGRAN);                                                       
//#23304                    TextOut(ds->hDC,ind,1,hlpbuf,strlen(hlpbuf));;                                                       
//#23305                }                                                           
//#23306                else                                                           
//#23307                    TextOut(ds->hDC,ind,1,stab[STR_PIKOL],strlen(stab[STR_PIKOL]));;                                                       
//#23308                return 1;                                                           
//#23309            }                                                               
//#23310            if(chkMap(WASTRAC)){                                                               
//#23311                                                                           
//#23312                for(ind=0;ind<3;ind++){                                                           
//#23313                                                                           
//#23314                    if(ds->hwndItem==htrup[ind]){                                                       
//#23315                                                                           
//#23316                        FillRect(ds->hDC,&ds->rcItem,trbrsh[ind]);                                                   
//#23317                        upnum(ind);                                                   
//#23318                        return 1;                                                   
//#23319                    }                                                       
//#23320                    if(ds->hwndItem==htrdwn[ind]){                                                       
//#23321                                                                           
//#23322                        FillRect(ds->hDC,&ds->rcItem,trbrsh[ind]);                                                   
//#23323                        dwnum(ind);                                                   
//#23324                    }                                                       
//#23325                    if(ds->hwndItem==hctrc[ind]){                                                       
//#23326                                                                           
//#23327                        durct(trshft[ind],ds->rcItem);                                                   
//#23328                        FillRect(ds->hDC,&midrct,trbrsh[ind]);                                                   
//#23329                        dublk(ds->hDC);                                                   
//#23330                        return 1;                                                   
//#23331                    }                                                       
//#23332                    if(ds->hwndItem==hstrc[ind]){                                                       
//#23333                                                                           
//#23334                        tbrsh=hblk;                                                   
//#23335                        strcpy(buf,stab[STR_OFF]);                                                   
//#23336                        SetBkColor(ds->hDC,0);                                                   
//#23337                        SetTextColor(ds->hDC,trgb[ind]);                                                   
//#23338                        if(chkMap(trbits[ind])){                                                   
//#23339                                                                           
//#23340                            tbrsh=trbrsh[ind];                                               
//#23341                            strcpy(buf,stab[STR_ON]);                                               
//#23342                            SetTextColor(ds->hDC,0);                                               
//#23343                            SetBkColor(ds->hDC,trgb[ind]);                                               
//#23344                        }                                                   
//#23345                        FillRect(ds->hDC,&ds->rcItem,tbrsh);                                                   
//#23346                        TextOut(ds->hDC,1,1,buf,strlen(buf));                                                   
//#23347                        return 1;                                                   
//#23348                    }                                                       
//#23349                    if(ds->hwndItem==htrnum){                                                       
//#23350                                                                           
//#23351                        FillRect(ds->hDC,&ds->rcItem,trbrsh[colm]);                                                   
//#23352                        SetBkColor(ds->hDC,trgb[colm]);                                                   
//#23353                        TextOut(ds->hDC,1,1,trinbuf,strlen(trinbuf));                                                   
//#23354                        return 1;                                                   
//#23355                    }                                                       
//#23356                }                                                           
//#23357            }                                                               
//#23358            else{                                                               
//#23359                                                                           
//#23360                for(ind=0;ind<16;ind++){                                                           
//#23361                                                                           
//#23362                    if(ds->hwndItem==hDef[ind]){                                                       
//#23363                                                                           
//#23364                        FillRect(ds->hDC,&ds->rcItem,hbrDefCol[ind]);                                                   
//#23365                        if(chkCol(ind)){                                                   
//#23366                                                                           
//#23367                            SetBkColor(ds->hDC,defCol[ind]);                                               
//#23368                            SetTextColor(ds->hDC,defTxt(ind));                                               
//#23369                            sprintf(buf,"%d",ind+1);                                               
//#23370                            len=strlen(buf);                                               
//#23371                            GetTextExtentPoint32(ds->hDC,buf,len,&txSiz);                                               
//#23372                            TextOut(ds->hDC,(buttonWid-txSiz.cx)>>1,0,buf,len);                                               
//#23373                        }                                                   
//#23374                        return 1;                                                   
//#23375                    }                                                       
//#23376                    if(ds->hwndItem==hCol[ind]){                                                       
//#23377                                                                           
//#23378                        FillRect(ds->hDC,&ds->rcItem,hbrUseCol[ind]);                                                   
//#23379                        if(ind==actcol){                                                   
//#23380                                                                           
//#23381                            SelectObject(ds->hDC,xPen);                                               
//#23382                            SetROP2(sdc, R2_NOTXORPEN);                                               
//#23383                            lin[0].x=lin[1].x=ds->rcItem.right>>1;                                               
//#23384                            lin[0].y=0;                                               
//#23385                            lin[1].y=ds->rcItem.bottom;                                               
//#23386                            Polyline(ds->hDC,lin,2);                                               
//#23387                            lin[0].y=lin[1].y=ds->rcItem.bottom>>1;                                               
//#23388                            lin[0].x=0;                                               
//#23389                            lin[1].x=ds->rcItem.right;                                               
//#23390                            Polyline(ds->hDC,lin,2);                                               
//#23391                            SetROP2(sdc,R2_COPYPEN);                                               
//#23392                        }                                                   
//#23393                        return 1;                                                   
//#23394                    }                                                       
//#23395                }                                                           
//#23396            }                                                               
//#23397            if(chkMap(BAKSHO)&&ds->itemAction==ODA_DRAWENTIRE){                                                               
//#23398                                                                           
//#23399                if(chkMap(THUMSHO)){                                                           
//#23400                                                                           
//#23401                    for(ind=0;ind<4;ind++){                                                       
//#23402                                                                           
//#23403                        if(ds->hwndItem==hvu[ind]&&ind<thumdcnt){                                                   
//#23404                                                                           
//#23405                            ritbak(thumsel[ind],ds);                                               
//#23406                            rthumnam(ind);                                               
//#23407                            return 1;                                               
//#23408                        }                                                   
//#23409                    }                                                       
//#23410                }                                                           
//#23411                else{                                                           
//#23412                                                                           
//#23413                    for(ind=0;ind<OLDVER;ind++){                                                       
//#23414                                                                           
//#23415                        if(ds->hwndItem==hvu[ind]){                                                   
//#23416                                                                           
//#23417                            strcpy(nam,thrnam);                                               
//#23418                            ine=duth(nam);                                               
//#23419                            nam[ine]=(TCHAR)ind+'s';                                               
//#23420                            ritbak(nam,ds);                                               
//#23421                            return 1;                                               
//#23422                        }                                                   
//#23423                    }                                                       
//#23424                }                                                           
//#23425            }                                                               
//#23426            break;                                                               
//#23427                                                                           
//#23428        case WM_SIZE:                                                                   
//#23429                                                                           
//#23430            GetClientRect(hWnd,&mRct);                                                               
//#23431            switch(wParam){                                                               
//#23432                                                                           
//#23433            case SIZE_MAXIMIZED:                                                               
//#23434                                                                           
//#23435                setu(SAVMAX);                                                           
//#23436                break;                                                           
//#23437                                                                           
//#23438            case SIZE_MINIMIZED:                                                               
//#23439                                                                           
//#23440                rstu(SAVMAX);                                                           
//#23441                break;                                                           
//#23442                                                                           
//#23443            case SIZE_RESTORED:                                                               
//#23444                                                                           
//#23445                rstu(SAVMAX);                                                           
//#23446                chkirct();                                                           
//#23447                if(setMap(SIZED)){                                                           
//#23448                                                                           
//#23449                    ine=0;                                                       
//#23450                    ind=(double)scrPix.cx-30;                                                       
//#23451                    if((unsigned)(mRct.right-mRct.left)>ind){                                                       
//#23452                                                                           
//#23453                        ine=(scrPix.cx-ind)>>1;                                                   
//#23454                        mRct.left=ine;                                                   
//#23455                        mRct.right=scrPix.cx-ine;                                                   
//#23456                    }                                                       
//#23457                    ind=(double)scrPix.cy-30;                                                       
//#23458                    if((unsigned)(mRct.bottom-mRct.top)>ind){                                                       
//#23459                                                                           
//#23460                        ine=(scrPix.cy-ind)>>1;                                                   
//#23461                        mRct.top=ine;                                                   
//#23462                        mRct.bottom=scrPix.cy-ine;                                                   
//#23463                    }                                                       
//#23464                    if(ine)                                                       
//#23465                        MoveWindow(hWnd,mRct.left,mRct.top,mRct.right-mRct.left,mRct.bottom-mRct.top,TRUE);                                                   
//#23466                }                                                           
//#23467                else{                                                           
//#23468                                                                           
//#23469                    MoveWindow(hWnd,ini.irct.left,ini.irct.top,ini.irct.right-ini.irct.left,ini.irct.bottom-ini.irct.top,TRUE);                                                       
//#23470                }                                                           
//#23471                ShowWindow(hWnd,SW_SHOW);                                                           
//#23472                break;                                                           
//#23473            }                                                               
//#23474            GetClientRect(hWnd,&mRct);                                                               
//#23475            movStch();                                                               
//#23476            if(chkMap(ZUMED)){                                                               
//#23477                                                                           
//#23478                tdub=(double)scRct.bottom/(zRct.top-zRct.bottom);                                                           
//#23479                twid=scRct.right/tdub;                                                           
//#23480                if(twid+zRct.left>zum0.x){                                                           
//#23481                                                                           
//#23482                    zRct.right=zum0.x;                                                       
//#23483                    zRct.left=zum0.x-twid;                                                       
//#23484                }                                                           
//#23485                else                                                           
//#23486                    zRct.right=twid+zRct.left;                                                       
//#23487            }                                                               
//#23488            else{                                                               
//#23489                                                                           
//#23490                zRct.left=zRct.bottom=0;                                                           
//#23491                zRct.right=zum0.x;                                                           
//#23492                zRct.top=zum0.y;                                                           
//#23493            }                                                               
//#23494            selCnt=0;                                                               
//#23495            setMap(RESTCH);                                                               
//#23496            if(chkMap(SELBOX))                                                               
//#23497                shft2box();                                                           
//#23498            if(chkMap(RUNPAT)){                                                               
//#23499                                                                           
//#23500                FillRect(sdc,&scRct,hStchBak);                                                           
//#23501                if(chkMap(ZUMED))                                                           
//#23502                    runpnt=gpnt0;                                                       
//#23503                else                                                           
//#23504                    runpnt=0;                                                       
//#23505            }                                                               
//#23506            return 1;                                                               
//#23507                                                                           
//#23508        case WM_MOVE:                                                                   
//#23509                                                                           
//#23510            GetClientRect(hWnd,&mRct);                                                               
//#23511            if((mRct.right-mRct.left)<20){                                                               
//#23512                                                                           
//#23513                mRct.left=0;                                                           
//#23514                mRct.right=300;                                                           
//#23515            }                                                               
//#23516            if((mRct.bottom-mRct.top)<20){                                                               
//#23517                                                                           
//#23518                mRct.top=0;                                                           
//#23519                mRct.bottom=300;                                                           
//#23520            }                                                               
//#23521            movStch();                                                               
//#23522            if(chkMap(RUNPAT)){                                                               
//#23523                                                                           
//#23524                duzrat();                                                           
//#23525                runpnt=0;                                                           
//#23526                FillRect(rsdc,&scRct,hStchBak);                                                           
//#23527            }                                                               
//#23528            return 1;                                                               
//#23529                                                                           
//#23530        case WM_CLOSE:                                                                   
//#23531                                                                           
//#23532            dun();                                                               
//#23533            if(chkMap(SAVEX))                                                               
//#23534                return 1;                                                           
//#23535            break;                                                               
//#23536        }                                                                   
//#23537        return DefWindowProc(hWnd, message, wParam, lParam);                                                                   
//#23538    }                                                                       
//#23539                                                                           
//#23540    void sachk(){                                                                       
//#23541                                                                           
//#23542        unsigned    ind,ine,bakclo;                                                               
//#23543        SATCON*        ts;                                                           
//#23544        TCHAR*        pchr;                                                           
//#23545        FRMHED*        tfrm;                                                           
//#23546                                                                           
//#23547        pchr=msgbuf;                                                                   
//#23548        for(ind=0;ind<formpnt;ind++){                                                                   
//#23549                                                                           
//#23550            tfrm=&formlst[ind];                                                               
//#23551            if(tfrm->typ==SAT&&tfrm->stpt){                                                               
//#23552                                                                           
//#23553                ts=tfrm->sacang.sac;                                                           
//#23554                for(ine=0;ine<tfrm->stpt;ine++){                                                           
//#23555                                                                           
//#23556                    if(ts[ine].strt>tfrm->sids||ts[ine].fin>tfrm->sids){                                                       
//#23557                                                                           
//#23558                        bakclo=clofind;                                                   
//#23559                        clofind=ind;                                                   
//#23560                        delsac(ind);                                                   
//#23561                        clofind=bakclo;                                                   
//#23562                    }                                                       
//#23563                }                                                           
//#23564            }                                                               
//#23565        }                                                                   
//#23566        if(pchr!=msgbuf)                                                                   
//#23567            shoMsg(msgbuf);                                                               
//#23568    }                                                                       
//#23569                                                                           
//#23570    int    fltex(int cod){                                                                   
//#23571                                                                           
//#23572        short    cw;                                                               
//#23573                                                                           
//#23574        _asm{                                                                   
//#23575                                                                           
//#23576                xor        eax,eax                                                   
//#23577                cmp        cod,0x10                                                   
//#23578                jne        short fltex1                                                   
//#23579                mov        cw,0x27f                                                   
//#23580                fldcw    cw                                                       
//#23581                dec        eax                                                   
//#23582    fltex1:                                                                       
//#23583        }                                                                   
//#23584    }                                                                       
//#23585

procedure TfrmMain.FormCreate(Sender: TObject);
var i : integer;
  LColors : TArrayOfTColor;
begin
//  showmessage(inttostr( sizeof(TFormStyle)));


  FStitchs := TStitchCollection.Create(Self) ;
  pb.Align := alClient;



//#23586    int APIENTRY WinMain(HINSTANCE hInstance,                                                                       
//#23587                         HINSTANCE hPrevInstance,                                                                       
//#23588                         LPSTR     lpCmdLine,                                                                       
//#23589                         int       nCmdShow){                                                                       
//#23590                                                                           
//#23591        WNDCLASSEX        wc;
//#23592        LOGBRUSH        br;
//#23593
//#23594        br.lbColor=COLOR_BACKGROUND+1;
//#23595        br.lbHatch=0;
//#23596        br.lbStyle=BS_SOLID;
//#23597
//#23598        hInst=hInstance;
//#23599        wc.cbSize=            sizeof(WNDCLASSEX);
//#23600        wc.style=            CS_DBLCLKS|CS_HREDRAW|CS_VREDRAW|CS_OWNDC;
//#23601        wc.lpfnWndProc=        (WNDPROC)WndProc;
//#23602        wc.cbClsExtra=        0;
//#23603        wc.cbWndExtra=        0;
//#23604        wc.hInstance=        hInst;
//#23605        wc.hIcon=            (HICON)LoadImage(hInst,MAKEINTRESOURCE(IDI_ICON1),IMAGE_ICON,
//#23606                                32,32,LR_SHARED);
//#23607        wc.hCursor=            LoadCursor(NULL, IDC_ARROW);
//#23608        wc.hbrBackground=    (HBRUSH)(COLOR_WINDOW+1);
//#23609        wc.lpszMenuName=    MAKEINTRESOURCE(IDR_MENU1);
//#23610        wc.lpszClassName=    thred;
//#23611        wc.hIconSm=            NULL;
//#23612
//#23613        //to keep the compiler from complaining
//#23614        hPrevInstance;
//#23615        lpCmdLine;
//#23616
//#23617        if(RegisterClassEx(&wc)){
//#23618
//#23619            redini();
  redini;
  //FStitchs.Colors := ini.StitchColors;
  SetLength(Lcolors,16);
   for i := 0 to 15 do
    begin
      LColors[i] := ini.StitchColors[i];
      swlCustom.Add;
      swlCustom[i].Color := LColors[i];

      swlDefault.Add;
      swlDefault[i].Color := defCol[i];
    end;
  FStitchs.Colors := LColors;// ini.StitchColors;
    swa2.Changed;
    swaDefault.Changed;
//#23620            if(ini.irct.right){
//#23621
//#23622                hWnd=CreateWindow(
//#23623                    thred,
//#23624                    ,
//#23625                    WS_OVERLAPPEDWINDOW,
//#23626                    ini.irct.left,
//#23627                    ini.irct.right,
//#23628                    ini.irct.right-ini.irct.left,
//#23629                    ini.irct.bottom-ini.irct.top,
//#23630                    0
//#23631                    0
//#23632                    hInstance,
//#23633                    0);
//#23634            }
//#23635            else{
//#23636
//#23637                hWnd=CreateWindow(
//#23638                    thred,
//#23639                    ,
//#23640                    WS_OVERLAPPEDWINDOW,
//#23641                    CW_USEDEFAULT,
//#23642                    CW_USEDEFAULT,
//#23643                    CW_USEDEFAULT,
//#23644                    CW_USEDEFAULT,
//#23645                    0
//#23646                    0                                                       
//#23647                    hInstance,                                                       
//#23648                    0);                                                       
//#23649                GetClientRect(hWnd,&mRct);                                                           
//#23650                ini.irct.left=mRct.left;                                                           
//#23651                ini.irct.right=mRct.right;                                                           
//#23652                ini.irct.top=mRct.top;                                                           
//#23653                ini.irct.bottom=mRct.bottom;                                                           
//#23654            }                                                               
//#23655            init();                                                               
//#23656            if(chku(SAVMAX))                                                               
//#23657                ShowWindow(hWnd,SW_SHOWMAXIMIZED);                                                           
//#23658            else                                                               
//#23659                ShowWindow(hWnd,SW_SHOW);                                                           
//#23660            if(!*ini.desnam)                                                               
//#23661            {                                                               
//#23662                LoadString(hInst,IDS_UNAM,ini.desnam,50);                                                           
//#23663                getdes();                                                           
//#23664            }                                                               
//#23665            while(GetMessage(&msg,NULL,0,0)){                                                               
//#23666                                                                           
//#23667                setMap(SAVACT);                                                           
//#23668                if(!chkMsg())                                                           
//#23669                    DispatchMessage(&msg);                                                       
//#23670                if(rstMap(FCHK))                                                           
//#23671                    frmchkx();                                                       
//#23672                if(rstMap(RESTCH))                                                           
//#23673                    redraw(hStch);                                                       
//#23674                if(rstMap(RELAYR))                                                           
//#23675                    ritlayr();                                                       
//#23676                if(!chkMap(TXTRED))                                                           
//#23677                    sachk();                                                       
//#23678                if(rstMap(DUMEN))                                                           
//#23679                    DrawMenuBar(hWnd);                                                       
//#23680            }                                                               
//#23681            return 0;                                                               
//#23682        }                                                                   
//#23683        return -1;                                                                   
//#23684    }

end;







procedure TfrmMain.mnu_FILE_NEW1Click(Sender: TObject);
begin
//#21224            case ID_FILE_NEW1:
//#21225
//#21226                if(!savcmp()){
//#21227
//#21228                    savdisc();
//#21229                    setMap(NEWBAK);
//#21230                    rstMap(PRFACT);
//#21231                    undat();
//#21232                }
//#21233                else{
//#21234
//#21235                    newFil();
//#21236                    nulayr(0);
//#21237                }
//#21238                break;
end;


procedure TfrmMain.lstCustomColorDrawItem(Control: TWinControl; Index: Integer;
  Rect: TRect; State: TOwnerDrawState);
begin
  if lstCustomColor.Items[Index] <> ColorToString(FStitchs.Colors[Index]) then
    lstCustomColor.Items[Index] := ColorToString(FStitchs.Colors[Index]);
  lstCustomColor.Canvas.Brush.Color :=  FStitchs.Colors[Index];
  lstCustomColor.Canvas.FillRect(Rect);
  lstCustomColor.Canvas.TextOut(Rect.Left, Rect.Top, lstCustomColor.Items[index]);

end;

procedure TfrmMain.lst2DrawItem(Control: TWinControl; Index: Integer;
  Rect: TRect; State: TOwnerDrawState);
begin
  if lst2.Items[Index] <> ColorToString(bakBit[Index]) then
    lst2.Items[Index] := ColorToString(bakBit[Index]);
  lst2.Canvas.Brush.Color :=  bakBit[Index];
  lst2.Canvas.FillRect(Rect);
  lst2.Canvas.TextOut(Rect.Left, Rect.Top, lst2.Items[index]);
end;

procedure TfrmMain.lst3DrawItem(Control: TWinControl; Index: Integer;
  Rect: TRect; State: TOwnerDrawState);
begin
  if lst3.Items[Index] <> ColorToString(custCol[Index]) then
    lst3.Items[Index] := ColorToString(custCol[Index]);
  lst3.Canvas.Brush.Color :=  custCol[Index];
  lst3.Canvas.FillRect(Rect);
  lst3.Canvas.TextOut(Rect.Left, Rect.Top, lst3.Items[index]);

end;

procedure TfrmMain.lst4DrawItem(Control: TWinControl; Index: Integer;
  Rect: TRect; State: TOwnerDrawState);
begin
  if lst4.Items[Index] <> ColorToString(bakCust[Index]) then
    lst4.Items[Index] := ColorToString(bakCust[Index]);
  lst4.Canvas.Brush.Color :=  bakCust[Index];
  lst4.Canvas.FillRect(Rect);
  lst4.Canvas.TextOut(Rect.Left, Rect.Top, lst4.Items[index]);
end;

procedure TfrmMain.lst5DrawItem(Control: TWinControl; Index: Integer;
  Rect: TRect; State: TOwnerDrawState);
begin
  with TListBox(Control) do
  begin
    if Items[Index] <> ColorToString(defCol[Index]) then
      Items[Index] := ColorToString(defCol[Index]);
    Canvas.Brush.Color :=  defCol[Index];
    Canvas.FillRect(Rect);
    Canvas.TextOut(Rect.Left, Rect.Top, Items[index]);

  end;
end;

procedure TfrmMain.LoadColorfromfile1Click(Sender: TObject);
begin
  if dlgOpenSwa.Execute then

    swlCustom.LoadFromFile(dlgOpenSwa.FileName);
end;

procedure TfrmMain.EditColor1Click(Sender: TObject);
var i : Integer;
begin
  dlgColor1.CustomColors.Clear;
  for i := 0 to swlCustom.Count - 1 do
    dlgColor1.CustomColors.Add(Format('Color%s=%s',[chr(64+i),IntToHex(swlCustom[i].Color, 8) ]));
  dlgColor1.Execute;
end;

procedure TfrmMain.mnu_HLPClick(Sender: TObject);
begin
//  with TgmColorDialog.create(self) do
end;


procedure TfrmMain.pbPaintBuffer(Sender: TObject);
var i,j : Integer;
  zRat : TFloatPoint;
  ColorAt :Cardinal;
  LastColor,CurrentColor : TColor32;
  R : TFloatRect;
  DrawLine : TStitch_LineProc;
  first : boolean;
begin
  DrawLine := Draw3DLine;//DrawLineStippled;//DrawLineFS;

  if Length(FStitchs.Stitchs) > 0 then
  begin
    zRat.X := (pb.Width / FStitchs.HeaderEx.xhup );
    zRat.Y := (pb.Height / FStitchs.HeaderEx.yhup );

    //zRat.x := 0.6; //debug
    if zRat.X < zRat.Y then
      zRat.Y := zRat.X
    else
      zRat.X := zRat.Y;

    pb.Buffer.Clear(clWhite32);
    pb.Buffer.FillRectTS(MakeRect(FloatRect(0,0, FStitchs.HeaderEx.xhup * zRat.X, FStitchs.HeaderEx.yhup * zRat.Y)), Color32(FStitchs.BgColor));
    for i := 0 to High(FStitchs.stitchs) do
    begin
      pb.Buffer.PenColor:= clBlack32;
      with FStitchs.stitchs[i] do
      begin
        ColorAt := at and $FF;
        if ColorAt > High(FStitchs.colors) then
          ColorAt := at and $0F;
        //pb.Buffer.PenColor := Color32( FStitchs.Colors[ ColorAt ] );
        CurrentColor := Color32( FStitchs.Colors[ ColorAt ] );

        if i = 0 then
        begin
          R.TopLeft := floatPoint(x * zRat.X, y * zRat.Y);
        end
        else
        begin
          R.BottomRight := floatPoint(x * zRat.X, y * zRat.Y);

          //JUMP STITCH + COLOR CHANGED.
          if CurrentColor = LastColor then
          DrawLine(pb.Buffer, R, CurrentColor);

          R.TopLeft := R.BottomRight;

        end;
        LastColor := CurrentColor;
        {if i = 0 then
          pb.Buffer.MoveToF(x * zRat.X, y * zRat.Y)
        else
          pb.Buffer.LineToFS(x * zRat.X, y * zRat.Y);}
      end;
    end;
    
    //FORMS
    pb.Buffer.PenColor:= clred32;
    for i := 0 to FStitchs.Header.fpnt -1 do
    begin
      if length(FStitchs.Forms[i].flt) = 0 then continue;
      
      first := true;
      for j := 0 to high(FStitchs.Forms[i].flt)  do
      begin
        with FStitchs.Forms[i].flt[j] do
        if first then
          pb.Buffer.MoveToF(x * zRat.X, y * zRat.Y)
        else
          pb.Buffer.LineToFS(x * zRat.X, y * zRat.Y);

        first := false;
      end;
      //back to first point
        with FStitchs.Forms[i].flt[0] do
          pb.Buffer.LineToFS(x * zRat.X, y * zRat.Y)
    end;




  end;  
end;




procedure TfrmMain.Line1Click(Sender: TObject);
begin
//
end;

end.
